<html dir="ltr">
  <head>
    <title>modeling-users</title>
    <link rel="stylesheet" href="http://railstutorial.jp/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://railstutorial.jp/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">
    <div id="book">

<h1 class="title">Ruby on Rails 3.2 チュートリアル</h1>


<h1 class="subtitle">実例を使ってRailsを学ぼう</h1>


<h2 class="author">Michael Hartl (マイケル・ハートル)</h2>




<h2 class="contents">目次</h2>


<div id="table_of_contents"><ol><li class="chapter"><a href="http://railstutorial.jp/beginning.html#top"><span class="number">第1章</span> ゼロから本番展開まで</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-introduction"><span class="number">1.1</span>はじめに</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-comments_for_various_readers"><span class="number">1.1.1</span>読者の皆さまへ</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-1_1_2"><span class="number">1.1.2</span> Railsとスケールについて</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-conventions"><span class="number">1.1.3</span>この本における取り決め</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-up_and_running"><span class="number">1.2</span> さっそく動作させる</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-development_tools"><span class="number">1.2.1</span>開発環境</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_2_1_1">IDE</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_2_1_2">テキストエディタとコマンドライン</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_2_1_3">ブラウザ</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_2_1_4">使用するツールについて</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-rubygems"><span class="number">1.2.2</span>Ruby、RubyGems、Rails、Git</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-rails_installer_windows">Railsインストーラ (Windows)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-install_git">Gitのインストール</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-install_ruby">Rubyのインストール</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-install_rubygems">RubyGemsのインストール</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-install_rails">Railsのインストール</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-the_first_application"><span class="number">1.2.3</span>最初のアプリケーション</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-bundler"><span class="number">1.2.4</span> Bundler</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-rails_server"><span class="number">1.2.5</span> <tt>rails server</tt></a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-mvc"><span class="number">1.2.6</span>Model-view-controller (MVC)</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-version_control"><span class="number">1.3</span>Gitによるバージョン管理</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-git_setup"><span class="number">1.3.1</span>インストールとセットアップ</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_3_1_1">初めてのシステム・セットアップ</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_3_1_2">初めてのリポジトリ・セットアップ</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-adding_and_committing"><span class="number">1.3.2</span>追加とコミット</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-1_3_3"><span class="number">1.3.3</span>Gitのメリット</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-github"><span class="number">1.3.4</span> GitHub</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-git_commands"><span class="number">1.3.5</span>ブランチ (branch)、変更 (edit)、 コミット (commit)、マージ (merge)</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_branch">ブランチ (branch)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_edit">変更 (edit)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_commit">コミット (commit)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_merge">マージ (merge)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_push">プッシュ (push)</a></li></ol></li></ol></li><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-deploying"><span class="number">1.4</span>展開する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-heroku_setup"><span class="number">1.4.1</span> Herokuのセットアップ</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-heroku_step_one"><span class="number">1.4.2</span> Herokuに展開する (1)</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-1_4_3"><span class="number">1.4.3</span> Herokuに展開する (2)</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-heroku_commands"><span class="number">1.4.4</span> Heroku コマンド</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-beginning_conclusion"><span class="number">1.5</span> 最後に</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/a-demo-app.html#top"><span class="number">第2章</span>デモアプリケーション</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/a-demo-app.html#sec-planning_the_application"><span class="number">2.1</span> アプリの計画</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-modeling_demo_users"><span class="number">2.1.1</span>ユーザーのモデル設計</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-modeling_demo_microposts"><span class="number">2.1.2</span>マイクロポストのモデル設計</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/a-demo-app.html#sec-demo_users_resource"><span class="number">2.2</span>Users リソース </a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-a_user_tour"><span class="number">2.2.1</span>ユーザページを探検する</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-mvc_in_action"><span class="number">2.2.2</span> MVCの挙動</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-weaknesses_of_this_users_resource"><span class="number">2.2.3</span>Users リソースの欠点</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/a-demo-app.html#sec-microposts_resource"><span class="number">2.3</span>Mircroposts リソース</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-a_micropost_microtour"><span class="number">2.3.1</span>マイクロポストのページを探検する</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-putting_the_micro_in_microposts"><span class="number">2.3.2</span>マイクロポストを<em>マイクロ</em>にする</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-demo_user_has_many_microposts"><span class="number">2.3.3</span>ユーザーとマイクロポストを<tt>has_many</tt>で関連づける</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-inheritance_hierarchies"><span class="number">2.3.4</span>継承の階層</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-deploying_the_demo_app"><span class="number">2.3.5</span>デモアプリケーションの展開</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/a-demo-app.html#sec-2_4"><span class="number">2.4</span>最後に</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/static-pages.html#top"><span class="number">第3章</span>ほぼ静的なページの作成</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-static_pages"><span class="number">3.1</span>静的ページ</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-truly_static_pages"><span class="number">3.1.1</span>「本当に」静的なページ</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-static_pages_with_rails"><span class="number">3.1.2</span>Railsによる静的なページ</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-first_tests"><span class="number">3.2</span>最初のテスト</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-TDD"><span class="number">3.2.1</span>テスト駆動開発</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-adding_a_page"><span class="number">3.2.2</span>ページの追加</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-red">赤 (Red)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-green">緑 (Green)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-refactor">リファクタリング</a></li></ol></li></ol></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-slightly_dynamic_pages"><span class="number">3.3</span>ちょっとだけ動的ページ</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-testing_a_title_change"><span class="number">3.3.1</span>タイトル変更をテストする</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-passing_title_tests"><span class="number">3.3.2</span>タイトルのテストをパスさせる</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-embedded_ruby"><span class="number">3.3.3</span>組込みRuby</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-layouts"><span class="number">3.3.4</span>レイアウトを使って重複を解消する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-static_pages_conclusion"><span class="number">3.4</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-static_pages_exercises"><span class="number">3.5</span>演習</a></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-advanced_setup"><span class="number">3.6</span>高度なセットアップ</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-eliminating_bundle_exec"><span class="number">3.6.1</span><tt>bundle exec</tt>を追放する</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-rvm_bundler_integration">RVM Bundler の統合</a></li><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-binstubs">binstubオプション</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-guard"><span class="number">3.6.2</span>Guardによるテストの自動化</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-spork"><span class="number">3.6.3</span>Spork を使ったテストの高速化</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-spork_and_guard">GuardにSporkを導入する</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-tests_inside_sublime_text"><span class="number">3.6.4</span>Sublime Text上でテストする</a></li></ol></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/rails-flavored-ruby.html#top"><span class="number">第4章</span> Rails風味のRuby</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-motivation"><span class="number">4.1</span>動機</a></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-strings_and_methods"><span class="number">4.2</span>文字列(string)とメソッド</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-comments"><span class="number">4.2.1</span>コメント</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-strings"><span class="number">4.2.2</span>文字列</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-printing">出力</a></li><li class="subsubsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-single_quoted_strings">シングルクォート内の文字列</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-objects_and_message_passing"><span class="number">4.2.3</span>オブジェクトとメッセージ受け渡し</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-method_definitions"><span class="number">4.2.4</span>メソッドの定義</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-back_to_the_title_helper"><span class="number">4.2.5</span> title ヘルパー、再び</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-other_data_structures"><span class="number">4.3</span>他のデータ構造</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-arrays_and_ranges"><span class="number">4.3.1</span>配列と範囲演算子</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-blocks"><span class="number">4.3.2</span>ブロック</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-hashes_and_symbols"><span class="number">4.3.3</span>ハッシュとシンボル</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-css_revisited"><span class="number">4.3.4</span> CSS、再び</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-ruby_classes"><span class="number">4.4</span> Ruby におけるクラス</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-constructors"><span class="number">4.4.1</span>コンストラクタ</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_class_of_our_own"><span class="number">4.4.2</span>クラス継承</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-modifying_built_in_classes"><span class="number">4.4.3</span>組込みクラスの変更</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_controller_class"><span class="number">4.4.4</span>コントローラクラス</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_user_class"><span class="number">4.4.5</span>ユーザークラス</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-conclusion"><span class="number">4.5</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-exercises"><span class="number">4.6</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/filling-in-the-layout.html#top"><span class="number">第5章</span>レイアウトを作成する</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-structure"><span class="number">5.1</span>構造を追加する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-adding_to_the_layout"><span class="number">5.1.1</span>ナビゲーション</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-custom_css"><span class="number">5.1.2</span>BootstrapとカスタムCSS</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-partials"><span class="number">5.1.3</span>パーシャル (partial)</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-sass_and_the_asset_pipeline"><span class="number">5.2</span>Sass と asset pipleline</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-the_asset_pipeline"><span class="number">5.2.1</span> asset pipeline</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_1_1">asset ディレクトリ</a></li><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_1_2">マニフェストファイル</a></li><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_1_3">プリプロセッサエンジン</a></li><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_1_4">プロダクション環境での効率性</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-sass"><span class="number">5.2.2</span>素晴らしい構文を備えたスタイルシート</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_2_1">ネスト</a></li><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_2_2">変数</a></li></ol></li></ol></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-layout_links"><span class="number">5.3</span>レイアウトのリンク</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-route_tests"><span class="number">5.3.1</span> ルートのテスト</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-rails_routes"><span class="number">5.3.2</span> Railsのルート</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-named_routes"><span class="number">5.3.3</span>名前付きルート</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-pretty_rspec"><span class="number">5.3.4</span>Pretty RSpec</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-user_signup"><span class="number">5.4</span>ユーザーのサインアップ：最初のステップ</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-users_controller"><span class="number">5.4.1</span>ユーザーコントローラ</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-signup_url"><span class="number">5.4.2</span>サインアップURI</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-layout_conclusion"><span class="number">5.5</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-layout_exercises"><span class="number">5.6</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/modeling-users.html#top"><span class="number">第6章</span>ユーザーのモデルを作成する</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-user_model"><span class="number">6.1</span> Userモデル</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-database_migrations"><span class="number">6.1.1</span>データベースの移行</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-the_model_file"><span class="number">6.1.2</span>modelファイル</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/modeling-users.html#sec-model_annotation">モデル注釈</a></li><li class="subsubsection"><a href="http://railstutorial.jp/modeling-users.html#sec-accessible_attributes">アクセス可能な属性</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-creating_user_objects"><span class="number">6.1.3</span>ユーザーオブジェクトを作成する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-finding_user_objects"><span class="number">6.1.4</span>ユーザーオブジェクトを検索する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-updating_user_objects"><span class="number">6.1.5</span>ユーザーオブジェクトを更新する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-user_validations"><span class="number">6.2</span>ユーザーを検証する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-initial_user_tests"><span class="number">6.2.1</span>最初のユーザーテスト</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-presence_validation"><span class="number">6.2.2</span>プレゼンスを検証する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-length_validation"><span class="number">6.2.3</span>長さを検証する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-format_validation"><span class="number">6.2.4</span>フォーマットを検証する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-uniqueness_validation"><span class="number">6.2.5</span>一意性を検証する</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/modeling-users.html#sec-the_caveat">一意性の警告</a></li></ol></li></ol></li><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-adding_a_secure_password"><span class="number">6.3</span>セキュアなパスワードを追加する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-an_encrypted_password"><span class="number">6.3.1</span>暗号化されたパスワード</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-password_and_confirmation"><span class="number">6.3.2</span>パスワードと確認</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-user_authentication"><span class="number">6.3.3</span>ユーザー認証</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-has_secure_password"><span class="number">6.3.4</span>ユーザーがセキュアなパスワードを持っている</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-creating_a_user"><span class="number">6.3.5</span>ユーザーを作成する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-6_4"><span class="number">6.4</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-6_5"><span class="number">6.5</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/sign-up.html#top"><span class="number">第7章</span>ユーザー登録</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-showing_users"><span class="number">7.1</span>ユーザーを表示する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-rails_environments"><span class="number">7.1.1</span>デバッグとRails環境</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-a_users_resource"><span class="number">7.1.2</span>ユーザーリソース</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-tests_with_factories"><span class="number">7.1.3</span>ファクトリーを使用してユーザー表示ページをテストする</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-a_gravatar_image"><span class="number">7.1.4</span>gravatar画像とサイドバー</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-signup_form"><span class="number">7.2</span>ユーザー登録フォーム</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-tests_for_user_signup"><span class="number">7.2.1</span>ユーザー登録のためのテスト</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-using_form_for"><span class="number">7.2.2</span><tt>form_for</tt>を使用する</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-the_form_html"><span class="number">7.2.3</span>フォームHTML</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-signup_failure"><span class="number">7.3</span>ユーザー登録失敗</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-a_working_form"><span class="number">7.3.1</span>正しいフォーム</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-signup_error_messages"><span class="number">7.3.2</span>ユーザー登録のエラーメッセージ</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-signup_success"><span class="number">7.4</span>ユーザー登録成功</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-the_finished_signup_form"><span class="number">7.4.1</span>登録フォームの完成</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-the_flash"><span class="number">7.4.2</span>flash</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-the_first_signup"><span class="number">7.4.3</span>実際のユーザー登録</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-deploying_to_production_with_ssl"><span class="number">7.4.4</span> SSLを導入してプロダクション環境を展開する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-7_5"><span class="number">7.5</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-signup_exercises"><span class="number">7.6</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/sign-in-sign-out.html#top"><span class="number">第8章</span>サインイン、サインアウト</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_failure"><span class="number">8.1</span>セッション、サインインの失敗</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-sessions_controller"><span class="number">8.1.1</span>Sessionコントローラ</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_tests"><span class="number">8.1.2</span>サインインをテストする</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_form"><span class="number">8.1.3</span>サインインのフォーム</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-reviewing_form_submission"><span class="number">8.1.4</span>確認フォームを送信する</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-rendering_with_a_flash_message"><span class="number">8.1.5</span>フラッシュメッセージをレンダリングする</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_success"><span class="number">8.2、</span>サインイン成功</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-remember_me"><span class="number">8.2.1</span>[このアカウント設定を保存する]</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-a_working_sign_in_method"><span class="number">8.2.2</span>正しい<tt>sign_in</tt>メソッド</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-current_user"><span class="number">8.2.3</span>現在のユーザー</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-changing_the_layout_links"><span class="number">8.2.4</span>レイアウトリンクを変更する</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_upon_signup"><span class="number">8.2.5</span>ユーザー登録と同時にサインインする</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signing_out"><span class="number">8.2.6</span>サインアウトする</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-cucumber"><span class="number">8.3</span>Cucumberの紹介(オプション)</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-installation_and_setup"><span class="number">8.3.1</span>インストールと設定</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-features_and_steps"><span class="number">8.3.2</span>機能と手順</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-rspec_custom_matchers"><span class="number">8.3.3</span>対比: RSpecのカスタムマッチャー</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-8_4"><span class="number">8.4</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-sign_in_out_exercises"><span class="number">8.5</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#top"><span class="number">第9章</span> ユーザーの更新・表示・削除</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-updating_users"><span class="number">9.1</span>ユーザーを更新する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-edit_form"><span class="number">9.1.1</span>編集フォーム</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-unsuccessful_edits"><span class="number">9.1.2</span>編集の失敗</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-successful_edits"><span class="number">9.1.3</span>編集の成功</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-authorization"><span class="number">9.2</span>認証</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-requiring_signed_in_users"><span class="number">9.2.1</span>ユーザーのサインインを要求する</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-requiring_the_right_user"><span class="number">9.2.2</span>正しいユーザーを要求する</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-friendly_forwarding"><span class="number">9.2.3</span>フレンドリーフォワーディング</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-showing_all_users"><span class="number">9.3</span>すべてのユーザーを表示する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-user_index"><span class="number">9.3.1</span>ユーザーインデックス</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-sample_users"><span class="number">9.3.2</span>サンプルのユーザー</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-pagination"><span class="number">9.3.3</span>ページネーション</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-partial_refactoring"><span class="number">9.3.4</span>部分的リファクタリング</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-destroying_users"><span class="number">9.4</span>ユーザを削除する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-administrative_users"><span class="number">9.4.1</span>管理ユーザー</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-revisiting_attr_accessible"><tt>attr_accessible</tt>属性再び</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-the_destroy_action"><span class="number">9.4.2</span> <tt>destroy</tt>アクション</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-updating_and_deleting_users_conclusion"><span class="number">9.5</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-updating_deleting_exercises"><span class="number">9.6</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/user-microposts.html#top"><span class="number">第10章</span>ユーザーのマイクロポスト</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-a_micropost_model"><span class="number">10.1</span>マイクロポストのモデル</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-the_basic_model"><span class="number">10.1.1</span>基本的なモデル</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-accessible_attribute"><span class="number">10.1.2</span>Accessible属性と最初の検証</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-user_micropost_associations"><span class="number">10.1.3</span>User/Micropostの関連付け</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-ordering_and_dependency"><span class="number">10.1.4</span>マイクロポストを改良する</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/user-microposts.html#sec-default_scope">デフォルトのスコープ</a></li><li class="subsubsection"><a href="http://railstutorial.jp/user-microposts.html#sec-dependent_destroy">Dependent: destroy</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-micropost_validations"><span class="number">10.1.5</span>コンテンツの検証</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-showing_microposts"><span class="number">10.2</span>マイクロポストを表示する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-augmenting_the_user_show_page"><span class="number">10.2.1</span>ユーザー表示ページの拡張</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-sample_microposts"><span class="number">10.2.2</span>マイクロポストのサンプル</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-manipulating_microposts"><span class="number">10.3</span>マイクロポストを操作する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-access_control"><span class="number">10.3.1</span>アクセス制御</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-creating_microposts"><span class="number">10.3.2</span>マイクロポストを作成する</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-a_proto_feed"><span class="number">10.3.3</span>フィードの原型</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-destroying_microposts"><span class="number">10.3.4</span>マイクロポストを削除する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-10_4"><span class="number">10.4</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-micropost_exercises"><span class="number">10.5</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/following-users.html#top"><span class="number">第11章</span>ユーザーをフォローする</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-the_relationship_model"><span class="number">11.1</span>Relationshipのモデル</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-a_problem_with_the_data_model"><span class="number">11.1.1</span>データモデルの問題 (および解決策)</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-relationship_user_associations"><span class="number">11.1.2</span>User/relationshipの関連付け</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-relationship_validations"><span class="number">11.1.3</span>検証</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-following"><span class="number">11.1.4</span>フォローしているユーザー</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-followers"><span class="number">11.1.5</span>フォローされているユーザー</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-a_web_interface_for_following_and_followers"><span class="number">11.2</span>フォローしているユーザー用のWebインターフェイス</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-sample_following_data"><span class="number">11.2.1</span>フォローしているユーザーのサンプルデータ</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-stats_and_a_follow_form"><span class="number">11.2.2</span>統計とフォロー用フォーム</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-following_and_followers_pages"><span class="number">11.2.3</span>「フォローしている」と「フォローされている」のページ</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-a_working_follow_button_the_standard_way"><span class="number">11.2.4</span>[フォローする] ボタン (標準的な方法)</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-a_working_follow_button_with_ajax"><span class="number">11.2.5</span>[フォローする] ボタン (Ajax)</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-the_status_feed"><span class="number">11.3</span>ステータスフィード</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-motivation_and_strategy"><span class="number">11.3.1</span>動機と計画</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-a_first_feed_implementation"><span class="number">11.3.2</span>フィードを初めて実装する</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-scopes_subselects_and_a_lambda"><span class="number">11.3.3</span>サブセレクト</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-the_new_status_feed"><span class="number">11.3.4</span>新しいステータスフィード</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-following_conclusion"><span class="number">11.4</span>最後に</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-extensions_to_the_sample_application"><span class="number">11.4.1</span>サンプルアプリケーションの機能を拡張する</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-replies">返信機能</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-messaging">メッセージ機能</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-follower_notifications">フォロワーの通知</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-password_reminders">パスワードリマインダー</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-signup_confirmation">ユーザー登録の確認</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-rss_feed">RSSフィード</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-rest_api">REST API</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-search">検索機能</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-guide_to_further_resources"><span class="number">11.4.2</span>読み物ガイド</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-following_exercises"><span class="number">11.5</span>演習</a></li></ol></li></ol></div>


<div id="main_content"></div>


<p> <span class="preamble">
</span><span class="preamble"> <span id="foreword">
</span></span><span class="preamble"><span id="foreword"><strong>前書き</strong> </span></span><br /><span class="preamble"><span id="foreword">
</span></span><span class="preamble"><span id="foreword"> </span>
</span><span class="preamble"> </span></p>

<p>私が前にいた会社 (CD Baby) は、かなり早い段階でRuby on Railsに乗り換えたのですが、またPHPに戻ってしまいました (詳細は私の名前をGoogleで検索してみて下さい)。Michael Hartl氏が書いたこの本を強く勧められ、これはやってみなければ、と試した結果、私が再びRailsに乗り換えるに至ったのがこの<em>Ruby on Railsチュートリアル</em>です。</p>

<p>私は多数のRails本を参考にしてきましたが、真の決定版と呼べるものは本書をおいて他にありません。本書ではあらゆる手順が文字通りRails流 (“Rails way”は railway にかけている) で行われており、最初はなかなか慣れませんでしたが、この本を終えた今、ついにこれこそが自然な方式だと感じられるまでになりました。また、本書はRails本の中で唯一、多くのプロが推奨するテスト駆動開発 (TDD: Test Driven Development) 方式を全編を通して実践していて、非常に分かりやすく解説されています。極めつけは、Git、GitHub、そしてHerokuまでも実例に含めた事で、チュートリアルのコード例など実際のプロジェクトの開発プロセスまでも体験できるようになっていることです。チュートリアルのコード例は、どれもチュートリアルと見事に一体化しています。</p>

<p>本書は全体が筋道だったストーリーに貫かれており、非常に素晴らしいものです。私自身、3日間かけて章の終わりにある練習問題もやりながら<em>Railsチュートリアル</em>を一気に読破しました。最初から最後まで、途中を飛ばさずにやるのが一番効果的で有益な読み方です。ぜひやってみて下さい。</p>

<p>是非お試しください。</p>

<p>デレック・シバーズ (<a href="http://sivers.org/">Derek Sivers</a>) (<a href="http://sivers.org/">sivers.org</a>)<br />
<em>元: <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> (創始者)</em> <br />
<em>現在: <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> (創始者) </em> <br /></p>

<p> <span class="preamble">
</span><span class="preamble"><strong>謝辞</strong> </span><br /><span class="preamble">
</span><span class="preamble"> </span></p>

<p><em>Ruby on Rails チュートリアル</em>は、私の以前の著書<em>RailsSpace</em>と、その時の共著者の<a href="http://aure.com/">Aurelius Prochazka</a>に多くを負っています。Aureには、RailsSpaceでの協力と本書への支援も含め、感謝したいと思います。また、<em>RailsSpace</em>と<em>Rails チュートリアル</em>両方の編集を担当して頂いたDebra Williams Cauley氏にも謝意を表したく思います。</p>

<p>私にインスピレーションと知識を与えてくれたRubyistの方々にも感謝したいと思います:David Heinemeier Hansson、 Yehuda Katz、 Carl Lerche、 Jeremy Kemper、 Xavier Noria、 Ryan Bates、 Geoffrey Grosenbach、 Peter Cooper、 Matt Aimonetti、 Gregg Pollack、 Wayne E. Seguin、 Amy Hoy、 Dave Chelimsky、 Pat Maddox、 Tom Preston-Werner、 Chris Wanstrath、 Chad Fowler、 Josh Susser、 Obie Fernandez、 Ian McFarland、 Steven Bristol、 Pratik Naik、 Sarah Mei、 Sarah Allen、 Wolfram Arnold、 Alex Chaffee、 Giles Bowkett、 Evan Dorn、 Long Nguyen、 James Lindenbaum、 Adam Wiggins、 Tikhon Bernstam、 Ron Evans、 Wyatt Greene、 Miles Forrest、 Pivotal Labsの方々、 Herokuの方々、 thoughtbotの方々、 そしてGitHubチーム。最後に、ここに書ききれないほど多くの読者の方々から執筆中にバグ報告や提案を頂き、本書をできる限り良いものにするのに大変役立ちました。<br /></p>

<p> <span class="preamble">
</span><span class="preamble"> <span id="author">
</span></span><span class="preamble"><span id="author"><strong>著者</strong> </span></span><br /><span class="preamble"><span id="author">
</span></span><span class="preamble"><span id="author"> </span>
</span><span class="preamble"> </span></p>

<p><a href="http://michaelhartl.com/">マイケル・ハートル (Michael Hartl)</a> は、<a href="http://ruby.railstutorial.org/"><em>Ruby on Rails</em></a>を使用したweb開発を手ほどきする教材として有名な<a href="http://rubyonrails.org/">Ruby on Rails チュートリアル</a>の著者です。(今ではすっかり古くなってしまいましたが) Railsのチュートリアル本である<em>RailsSpace</em>の著述と開発に携わったことがあり、 一時人気を博したRuby on RailsベースのソーシャルネットワーキングプラットフォームInsoshiも開発していました。2011年、マイケルはRailsコミュニティへの貢献が認められて<a href="http://rubyheroes.com/heroes">Ruby Hero Award</a>を受賞しました。<a href="http://college.harvard.edu/">ハーバード大学</a>卒業後 、<a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">カリフォルニア工科大学</a>で<a href="http://www.caltech.edu/">物理学博士号</a>を取得し、起業プログラム<a href="http://ycombinator.com/">Y Combinator</a>の卒業生でもあります。<br /></p>

<p> <span id="license" class="preamble">
</span><span id="license" class="preamble"><strong>著作権とライセンス</strong> </span><br /><span id="license" class="preamble">
</span><span id="license" class="preamble"> </span></p>

<p><em>Ruby on Rails チュートリアル: 実例を使ってRailsを学ぼう</em>Copyright © 2010 by Michael Hartl.<em>Ruby on Rails チュートリアル</em>内のすべてのソースコードは<a href="http://www.opensource.org/licenses/mit-license.php">MITライセンス</a>および<a href="http://people.freebsd.org/~phk/">Beerwareライセンス</a> の元で提供されています。</p>

<div class="code"><div class="highlight"><pre>(The MIT License)
Copyright (c) 2012 Michael Hartl
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</br>FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHERLIABILITY, </br>WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISINGOUT OF OR </br>IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS INTHE SOFTWARE.</pre></div>
</div>


<div class="code"><div class="highlight"><pre>/*
 * ----------------------------------------------------------------------------
 * &quot;THE BEER-WARE LICENSE&quot; (Revision 42):
 * Michael Hartl wrote this code.As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return.
 * ----------------------------------------------------------------------------
 */
</pre></div>
</div>


<div id="top"></div>


<h1 class="chapter"><a id="sec-6" href="http://railstutorial.jp/modeling-users.html#top" class="heading"><span class="number">第6章</span>ユーザーのモデルを作成する</a></h1>


<p><a class="ref" href="http://railstutorial.jp/filling-in-the-layout.html#top">第5章</a>では、新しいユーザーを作成するためのスタブページを作って終わりました (<a class="ref" href="http://railstutorial.jp/filling-in-the-layout.html#sec-user_signup">5.4</a>)。これから4つの章を通して、ユーザー登録ページを作っていきます。最初の一番重要なステップは、サイトのユーザーのために、<em>データモデル</em>をデータを保存する手段と共に作成することです。<a class="ref" href="http://railstutorial.jp/sign-up.html#top">第7章</a>では、ユーザーがサイトにユーザー登録できるようにし、ユーザープロフィールのためのページを作成します。ユーザー登録ができるようになると、次にサインイン、サインアウトもできるようにします (<a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#top">第8章</a>)。そして<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#top">第9章</a> (<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-requiring_signed_in_users">9.2.1</a>) では、不正なアクセスから守る方法を学びます。まとめると、<a class="ref" href="http://railstutorial.jp/modeling-users.html#top">第6章</a>から<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#top">第9章</a>を通して、Railsのログインと認証のシステムを一通り開発します。ご存知の方もいるとは思いますが、Railsには既に利用可能な様々な認証の仕組みが存在します。<a class="ref" href="http://railstutorial.jp/modeling-users.html#sidebar-roll_your_own">囲み6.1</a>では、最初に少なくとも一度は自分で作ってみることをお勧めする理由について説明しています。</p>

<p>今回は、長く、学ぶことがたくさんあります。特に、これまでデータモデリングをしたことがない人にとっては、もしかすると、これまでとは違った難しさを感じるかもしれません。しかし、終わりを迎えるまでには、ユーザー情報の検証、保存、取得ができる極めて強力なシステムを作成します。</p>

<div class="label" id="sidebar-roll_your_own"></div>


<div class="sidebar"><span class="title"><span class="header">囲み6.1.</span></span><span class="title"><span class="description">自分で認証システムを作ってみる</span></span>
<p>事実上、すべてのアプリはログインと認証やそれに類するシステムを必要とします。その結果、ほとんどのウェブフレームワークがそれらのシステムを実装するための多くの選択肢を提供しています。Railsもまた例外ではありません。認証と認可のシステムの例だと、<a href="http://github.com/thoughtbot/clearance">Clearance</a>、<a href="http://github.com/binarylogic/authlogic">Authlogic</a>、<a href="http://github.com/plataformatec/devise">Devise</a>、<a href="http://railscasts.com/episodes/192-authorization-with-cancan">CanCan</a>などがあります (その他、Railsに限らず言えば<a href="http://en.wikipedia.org/wiki/OpenID">OpenID</a>や<a href="http://en.wikipedia.org/wiki/Oauth">OAuth</a>の上に構築する方法もあります)。 なぜ車輪の再発明をするのか、を聞くのはすごく当然のことだと思います。自分で作ってみるのではなく、いつでも使える方法をただ利用するだけではいけないのでしょうか。</p>

<p>ある実践的な実験によると、ほとんどのサイトの認証の仕組みは広範なカスタマイズを必要とするため、サードパーティの製品を変更する場合にはゼロからシステムを書くよりも多くの仕事を要すると言っています。加えて、いつでも使えるシステムというのは、内部がわかりづらいことが多くブラックボックスになっています。あなたが自分でシステムを書くときには、それをとてもよく理解しているはずです。さらに言うと、最近のRails (<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-adding_a_secure_password">6.3</a>) への変更により、カスタム認証システムを書くことが容易になりました。最後に、もしあなたが最終的にサードパーティのシステムを使うことに<em>なった</em>場合には、あなた自身で作った経験があると、それを理解して変更するのが容易になるはずです。</p>
</div>


<p>もしGitを使ってバージョン管理をしているなら、今こそユーザーをモデリングするためのトピックブランチを作成する時です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b modeling-users
</pre></div>
</div>


<p>(最初の行はmasterブランチから作業を始めることを確認するためです。そして、<code>modeling-users</code>トピックブランチは<code>master</code>ブランチを基に作成します。もしすでにmasterブランチにいれば、このコマンドは無視してください)。</p>

<div class="label" id="sec-user_model"></div>


<h2><a id="sec-6_1" href="http://railstutorial.jp/modeling-users.html#sec-user_model" class="heading"><span class="number">6.1</span> Userモデル</a></h2>


<p>これからユーザー登録ページを作りますが (<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-signup_mockup_preview">図6.1</a>のモックアップ)、新しいユーザーの情報を受け取るためには、まだそれらを保持する場所を持っていないので時期尚早です。ユーザー登録でまず初めにやることは、それらの情報を保持するためのデータ構造を作ることです。</p>

<div class="label" id="fig-signup_mockup_preview"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/signup_mockup_bootstrap.png" alt="signup_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図6.1</span><span class="description">ユーザー登録ページのモックアップ <a href="http://railstutorial.org/images/figures/signup_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>Railsでは、データモデルのためのデフォルトのデータ構造のことを<em>モデル</em>と呼びます (<a class="ref" href="http://railstutorial.jp/beginning.html#sec-mvc">1.2.6</a>にあるMVCのMのことです)。永続化のためのRailsデフォルトの解決策として、長期のデータストレージに<em>データベース</em>を使います。それと、データベースとやりとりするデフォルトのライブラリを<em>Active Record</em>と呼びます。<sup class="footnote" id="fnref-6_1"><a href="http://railstutorial.jp/modeling-users.html#fn-6_1">1</a></sup> Active Recordは、データオブジェクトを作成し、保存し、検索するためのメソッドを持っています。これらを使うのに、<a href="http://en.wikipedia.org/wiki/Relational_database">リレーショナルデータベース</a>で使うSQL (Structured Query Language)<sup class="footnote" id="fnref-6_2"><a href="http://railstutorial.jp/modeling-users.html#fn-6_2">2</a></sup>を意識する必要はありません。さらに言うと、Railsは<em>マイグレーション</em>という機能を持っています。データの定義をRubyで書くことができ、SQLのDDL (Data Definition Language)を学ぶ必要がありません。Railsはデータストアの詳細からほぼ完全に私たちを切り離してくれます。この本では、SQLiteを開発 (development) 環境で使い、またPostgreSQLを (Herokuでの) 開発環境で使います (<a class="ref" href="http://railstutorial.jp/beginning.html#sec-deploying">1.4</a>)。Railsがどのようにデータを保持するのかは、それが本番 (production) アプリでも、ほとんど考える必要がないくらいよくできています。</p>

<div class="label" id="sec-database_migrations"></div>


<h3><a id="sec-6_1_1" href="http://railstutorial.jp/modeling-users.html#sec-database_migrations" class="heading"><span class="number">6.1.1</span>データベースの移行</a></h3>


<p><a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_user_class">4.4.5</a>で扱ったカスタムビルドクラスの<code>User</code>を覚えていますか。<code>name</code>と<code>email</code>を属性に持つユーザーオブジェクトでした。このクラスは役に立つ例として提供されました。しかし、とても重要な部分である<em>永続性</em>についてが欠けていたのです。RailsコンソールでUserクラスのオブジェクトを作った際は、exitするとすぐに消えてしまいました。ここでの私たちの目的は、簡単に消えたりはしないユーザーのモデルを作ることにあります。</p>

<p><a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_user_class">4.4.5</a>のユーザークラスと同様に、<code>name</code>と<code>email</code>の2つの属性からなるユーザーをモデリングするところから始めましょう。後者のemailをユニークなユーザー名として使用します<sup class="footnote" id="fnref-6_3"><a href="http://railstutorial.jp/modeling-users.html#fn-6_3">3</a></sup> (パスワードのための属性は<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-adding_a_secure_password">6.3</a>で扱います) 。<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#code-example_user">リスト4.9</a>では、これをRubyの<code>attr_accessor</code>メソッドで行いました。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>それとは対照的に、Railsでユーザーをモデリングするときは、属性を明示的に示す必要がありません。上で簡潔に述べたように、Railsはデータを保存する際にデフォルトでリレーショナルデータベースを使用します。これは、データ<em>行</em>で構成される<em>テーブル</em>からなり、各行はデータ属性の<em>カラム</em>を持ちます。例えば、nameとemailを持つユーザーを保存するとき、私たちは<code>name</code>と<code>email</code>のカラムを持つ<code>users</code>テーブルを作成します (各行はひとりのユーザーを表します)。このようにカラムを名付けることによって、私たちはActive RecordにUserオブジェクトの属性を探させることができます。</p>

<p>それでは実際どのように動作するのか見てみましょう。(もしここまでのやりとりがとても抽象的に感じられた場合は、少しだけ耐えてください。<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-creating_user_objects">6.1.3</a>で始まるコンソールの例と、<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-sqlite_database_browser">図6.3</a>と<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-sqlite_user_row">図6.6</a>にあるデータベースブラウザのスクリーンショットが理解を助けてくれるでしょう。<a class="ref" href="http://railstutorial.jp/filling-in-the-layout.html#code-generate_users_controller">リスト5.28</a>で、ユーザーコントローラ (と<code>new</code>アクション) を作ったときのコマンドを覚えていますか？</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new --no-test-framework
</pre></div>
</div>


<p>同様にモデルを作成するコマンドとして、<code>generate model</code>があります。<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-generate_user_model">リスト6.1</a>では、<code>name</code>と<code>email</code>の2つの属性を持つUserモデルを作成するコマンドを示します。</p>

<div class="label" id="code-generate_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.1.</span> <span class="description">Userモデルの作成</span> </div>
<div class="code"><div class="highlight"><pre>$ rails generate model User name:string email:string
      invoke  active_record
      create    db/migrate/[timestamp]_create_users.rb
      create    app/models/user.rb
      invoke    rspec
      create      spec/models/user_spec.rb
</pre></div>
</div></div>


<p>(コントローラ名には複数形を使うという慣習とは対照的に、モデル名には単数形を用いることを覚えておいてください。UsersコントローラとUserモデルです)。<code>name:string</code>や<code>email:string</code>といったオプションのパラメータを渡すことによって、Railsに私たちが欲しい2つの属性を伝えます。また、これらの属性がどの型になるかも渡します (この場合は<code>string</code>)。<a class="ref" href="http://railstutorial.jp/static-pages.html#code-generating_pages">リスト3.4</a>や<a class="ref" href="http://railstutorial.jp/filling-in-the-layout.html#code-generate_users_controller">リスト5.28</a>のアクション名を含む例と比較してみてください。</p>

<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-generate_user_model">リスト6.1</a>にある<code>generate</code>コマンドの結果のひとつが、<em>マイグレーション</em>と呼ばれるファイルです。マイグレーションはデータベースの構造をインクリメンタルに変更する手段を提供します。それにより、要求の変更にデータモデルを適合させることができます。このUserモデルの例の場合、マイグレーションはモデル生成スクリプトによって自動的に作られました。<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-users_migration">リスト6.2</a>にあるように<code>name</code>と<code>email</code>の2つのカラムを持つ<code>users</code>テーブルを作成します (<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-uniqueness_validation">6.2.5</a>と、そして<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-adding_a_secure_password">6.3</a>でもう一度、ゼロからマイグレーションをどのように作るか確認します)。</p>

<div class="label" id="code-users_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.2.</span> <span class="description">(<code>users</code>テーブルを作るための) Userモデルのマイグレーション</span><br /><span class="description"> <code>db/migrate/[timestamp]_create_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>マイグレーションファイルの名前の先頭には、それが生成された時間の<em>タイムスタンプ</em>が付いてます。以前はインクリメンタルな整数が付いていました。しかし、複数人で開発しているチームだと、複数のプログラマが同じ整数のマイグレーションを作ってしまい、コンフリクトを引き起こしていました。まったく同じ時間にマイグレーションが作られるという通常ではありえないことが起きなければ、タイムスタンプを使うことでそのようなコンフリクトを避けることができます。</p>

<p>マイグレーション自体は、データベースに与える変更を定義した<code>change</code>メソッドからなります。<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-users_migration">リスト6.2</a>の場合、<code>change</code>は<code>create_table</code>というRailsのメソッドを呼び、ユーザーを保存するための<em>テーブル</em>をデータベースに作ります。<code>create_table</code>メソッドはブロック変数を1つ持つブロック (<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-blocks">4.3.2</a>) を受け取ります。今回のケースでは (“table”の頭文字を取って) <code>t</code>です。そのブロックの中で<code>create_table</code>メソッドは<code>t</code>オブジェクトを使って、<code>name</code>と<code>email</code>カラムをデータベースに作ります。型はどちらも<code>string</code>です。<sup class="footnote" id="fnref-6_4"><a href="http://railstutorial.jp/modeling-users.html#fn-6_4">4</a></sup> モデル名は単数形 (User) ですが、テーブル名は複数形 (<code>users</code>) です。これはRailsで用いる言葉の慣習を反映しています。モデルはひとりのユーザーを表すのに対し、データベースのテーブルは複数のユーザーから構成されます。ブロックの最後の行<code>t.timestamps</code>は特別なコマンドで、<code>created_at</code>と<code>updated_at</code>という2つの<em>魔法のカラム</em>を作ります。これらは、あるユーザーが作られたり更新されたときに、その時間を自動的に記録するタイムスタンプです (この魔法のカラムを使った例を<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-creating_user_objects">6.1.3</a>から具体的に見ていきます)。 このマイグレーションで作られる完全なデータモデルは<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-user_model_initial">図6.2</a>のとおりです。</p>

<div class="label" id="fig-user_model_initial"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/user_model_initial.png" alt="user_model_initial" /></span></div><div class="caption"><span class="header">図6.2</span><span class="description"><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-users_migration">リスト6.2</a>によるユーザーデータモデル</span></div></div>


<p>私たちはマイグレーションを、以下のとおり<code>rake</code>コマンド (<a class="ref" href="http://railstutorial.jp/a-demo-app.html#sidebar-rake">囲み2.1</a>) を使って実行することができます。これを“migrating up”と呼びます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>


<p>(<a class="ref" href="http://railstutorial.jp/a-demo-app.html#sec-demo_users_resource">2.2</a>で、一度このコマンドを実行したのを覚えていますか？) 初めて<code>db:migrate</code>が実行されると、<code>db/development.sqlite3</code>という名前のファイルが生成されます。これは<a href="http://sqlite.org/">SQLite</a><sup class="footnote" id="fnref-6_5"><a href="http://railstutorial.jp/modeling-users.html#fn-6_5">5</a></sup>データベースです。<code>db/development.sqlite3</code>ファイルを開くための<a href="http://sourceforge.net/projects/sqlitebrowser/">SQLite Database Browser</a>という素晴らしいツールを使って、データベースの構造を見ることができます (<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-sqlite_database_browser">図6.3</a>)。<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-user_model_initial">図6.2</a>の表と比べてみてください。<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-sqlite_database_browser">図6.3</a>の中に<code>id</code>というマイグレーションのときに説明されなかったカラムの存在に気づいたかもしれません。<a class="ref" href="http://railstutorial.jp/a-demo-app.html#sec-demo_users_resource">2.2</a>で簡潔に説明したとおり、このカラムは自動的に作られ、Railsが各行をユニークに識別するために使用します。</p>

<div class="label" id="fig-sqlite_database_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/sqlite_database_browser.png" alt="sqlite_database_browser" /></span></div><div class="caption"><span class="header">図6.3</span><span class="description"><a href="http://sqlitebrowser.sourceforge.net/">SQLite Database Browser</a>と作成した<code>users</code>テーブル <a href="http://railstutorial.org/images/figures/sqlite_database_browser-full.png">(拡大)</a></span></div></div>


<p><em>Rails Tutorial</em>にあるものすべてを含め、ほとんどのマイグレーションが<em>可逆</em>です。これは、<code>db:rollback</code>というRakeタスクで変更を取り消せることを意味します。これを“migrate down”と呼びます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:rollback
</pre></div>
</div>


<p>(<a class="ref" href="http://railstutorial.jp/static-pages.html#sidebar-undoing_things">囲み3.1</a>にはマイグレーションを元に戻すための別の便利なテクニックもあります)。このコマンドの中では、データベースからusersテーブルを削除するために<code>drop_table</code>コマンドを実行します。なぜこれがうまくいくかというと、<code>change</code>メソッドは<code>drop_table</code>が<code>create_table</code>の逆であることを知っているからです。つまり、ロールバックのマイグレーションを簡単に導くことができるのです。あるカラムを削除するような不可逆なマイグレーションの場合は、<code>change</code>メソッドの代わりに、<code>up</code>と<code>down</code>のメソッドを別々に定義する必要があります。より詳しくは<a href="http://guides.rubyonrails.org/migrations.html">Rails Guidesのマイグレーション</a>を読むと良いでしょう。</p>

<p>もしデータベースをロールバックしていたら、先に進む前にもう一度migrate upしてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>




<div class="label" id="sec-the_model_file"></div>


<h3><a id="sec-6_1_2" href="http://railstutorial.jp/modeling-users.html#sec-the_model_file" class="heading"><span class="number">6.1.2</span>modelファイル</a></h3>


<p>ここまでで<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-generate_user_model">リスト6.1</a>のUserモデルの作成によってどのように (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-users_migration">リスト6.2</a>) のマイグレーションファイルが作成されるかを見てきました。そして<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-sqlite_database_browser">図6.3</a>でこのマイグレーションを走らせた結果を見ました。<code>development.sqlite3</code>という名のファイルを<code>users</code>テーブルを作成することで更新し、<code>id</code>、<code>name</code>、<code>email</code>、<code>created_at</code>、<code>updated_at</code>を作成しました。<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-generate_user_model">リスト6.1</a>はモデル自体も作成しました。残りの部分で、それを理解していきましょう。</p>

<p>まず始めに、<code>app/models/</code>ディレクトリにある<code>user.rb</code>ファイルに書かれたUserモデルのコードを見るところから始めましょう。これは控えめに言ってもとてもよくまとまっています (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-raw_user_model">リスト6.3</a>) (<em>注</em>: もしRails 3.2.2か、それ以前のバージョンを使っている場合は<code>attr_accessible</code>の行は存在しません。その場合は<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-accessible_attributes">6.1.2.2</a>であなた自身が追加します)。</p>

<div class="label" id="code-raw_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.3.</span> <span class="description">新しいUserモデル</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_class_of_our_own">4.4.2</a>を思い出してください。シンタックス<code>class User &lt; ActiveRecord::Base</code>で、<code>User</code>クラスは<code>ActiveRecord::Base</code>を<em>継承するので</em>、Userモデルは自動的に<code>ActiveRecord::Base</code>クラスのすべての機能を持ちます。もちろん、この継承の知識は<code>ActiveRecord::Base</code>が何を含んでいるかを知らない限り何の特にもなりません。しかし、私たちがそれを知るのも時間の問題でしょう。話を続ける前に、終えなければならないことが2つあります。</p>

<div class="label" id="sec-model_annotation"></div>


<h4><a id="sec-6_1_2_1" href="http://railstutorial.jp/modeling-users.html#sec-model_annotation" class="heading">モデル注釈</a></h4>


<p>必ずしも必要ではありませんが、<code>annotate</code> gem (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-gemfile_annotate">リスト6.4</a>) を使ってRailsのモデルに<em>注釈をつける</em>ことができます。あなたにとって便利かもしれません。</p>

<div class="label" id="code-gemfile_annotate"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.4.</span> <span class="description"><code>Gemfile</code>への<code>annotate</code> gemの追加</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.11.0&#39;</span>
<span class="k">end</span>


<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;annotate&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5.0&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(本番アプリでは必要ないので、<code>annotate</code> gemは<code>group :development</code>ブロックの中に書きます (<code>group :test</code>と似ているので注意してください))。次に<code>bundle install</code>を実行してインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>これにより<code>annotate</code>コマンドが使えるようになります。単純にモデルファイルにデータモデルを含んだコメントが追加されます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>annotate
<span class="go">Annotated (1): User</span>
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-annotated_user_model">リスト6.5</a>はその結果です。</p>

<div class="label" id="code-annotated_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.5.</span> <span class="description">注釈が付いたUserモデル</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="c1"># == Schema Information</span>
<span class="c1">#</span>
<span class="c1"># Table name: users</span>
<span class="c1">#</span>
<span class="c1">#  id         :integer         not null, primary key</span>
<span class="c1">#  name       :string(255)</span>
<span class="c1">#  email      :string(255)</span>
<span class="c1">#  created_at :datetime</span>
<span class="c1">#  updated_at :datetime</span>
<span class="c1">#</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>データモデルをモデルファイルに可視化することで、モデルがどの属性を持っているか思い出すのを楽にしてくれます。しかし、将来のコードでは簡潔さのために注釈を省きます。(もし注釈を最新の状態に保ちたいならば、データモデルが変わったときは毎回<code>annotate</code>を実行しなければならないことを忘れないでください)。</p>

<div class="label" id="sec-accessible_attributes"></div>


<h4><a id="sec-6_1_2_2" href="http://railstutorial.jp/modeling-users.html#sec-accessible_attributes" class="heading">アクセス可能な属性</a></h4>


<p>それではもう一度Userモデルに戻りましょう。<code>attr_accessible</code>の行に注目してください (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-attr_accessible">リスト6.6</a>)。この行はRailsにモデルのどの属性が<em>アクセス可能</em>かを伝えます。例えば、どの属性が外部のユーザー (ウェブブラウザを使ってリクエストを送信するようなユーザー) によって変更されるかを示します。</p>

<div class="label" id="code-attr_accessible"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.6.</span> <span class="description"><code>name</code>と<code>email</code>属性をアクセス可能にする</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-attr_accessible">リスト6.6</a>のコードは、あなたが考えるようなことはしません。デフォルトでは、<em>すべての</em>モデルの属性がアクセス可能です。<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-attr_accessible">リスト6.6</a>は、<code>name</code>と<code>email</code>属性 (そして<em>唯一</em>、<code>name</code>と<code>email</code>属性) が外部のユーザーからアクセス可能であることを保証しています。<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#top">第9章</a>では、なぜそれが重要なのかを見ます。<code>attr_accessible</code>を使うことは<em>mass assignment</em>の脆弱性から守るために重要です。これは多くのRailsアプリでは悲惨なほどありふれていて、よく重大なセキュリティホールを招いています。</p>

<div class="label" id="sec-creating_user_objects"></div>


<h3><a id="sec-6_1_3" href="http://railstutorial.jp/modeling-users.html#sec-creating_user_objects" class="heading"><span class="number">6.1.3</span>ユーザーオブジェクトを作成する</a></h3>


<p>ここまでで私たちはいくらかの準備を行ってきました。そして今からActive Recordについて学んでいきます。先ほど作成したUserモデルを使いましょう。<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#top">第4章</a>と同じく、Railsコンソールを使います。(まだ) データベースには何も変更を加えたくないので、<em>サンドボックス</em>のコンソールから始めます。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="go">Loading development environment in sandbox</span>
<span class="go">Any modifications you make will be rolled back on exit</span>
<span class="gp">&gt;&gt; </span>
</pre></div>
</div>


<p>便利なメッセージ “あなたが行ったすべての変更は終了時にロールバックされます (Any modifications you make will be rolled back on exit)” に示されるように、サンドボックスで始めたときは、コンソールがそのセッションで行ったデータベースへの変更をすべて “ロールバック” (すなわち、やり直し) してくれます。</p>

<p><a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_user_class">4.4.5</a>のコンソールセッションの中では、<code>User.new</code>で新しいユーザーオブジェクトを生成しましたが、<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#code-example_user">リスト4.9</a>のユーザーファイルをrequireした後でのみアクセス可能になりました。モデルを使うと状況は異なります。<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_controller_class">4.4.4</a>で見たように、RailsコンソールはRailsの環境を自動的に読み込みます。そして、その環境はモデルも含んでいます。これは、他に余計なことをすることなく新しいユーザーオブジェクトを作れることを意味します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User id: nil, name: nil, email: nil, created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>ユーザーオブジェクトのデフォルトのコンソール表現として、<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-user_model_initial">図6.2</a>と<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-annotated_user_model">リスト6.5</a>に見られるのと同じ属性がプリントされているのを見ることができます。</p>

<p><code>User.new</code>を引数なしで呼んだ場合は、すべての属性が<code>nil</code>のオブジェクトを返します。<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_user_class">4.4.5</a>では、例としてUserクラスを設計し、オブジェクトの属性を設定するために<em>初期化のためのハッシュ (hash) </em>を必要としました。その設計の際に選択した方法はActive Recordでやっていることと同じです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: nil, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>このように、nameとemail属性が期待どおり設定されているのがわかります。</p>

<p>もし開発ログをtailし続けていたなら、まだ何も新しい行が表示されないことに気づいたかもしれません。これは、<code>User.new</code>を呼ぶだけではデータベースを触らないからです。単純に新しいRubyのオブジェクトをメモリ上に作るだけです。このユーザーオブジェクトをデータベースに保存するためには、<code>user</code>変数に対して<code>save</code>メソッドを呼びます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p><code>save</code>メソッドは、成功すれば<code>true</code>を、失敗すれば<code>false</code>を返します (現状では、すべての保存が成功するはずです。<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-user_validations">6.2</a>で失敗するケースを見ます)。 保存するとすぐに、SQLコマンドの<code>INSERT INTO &quot;users&quot;</code>という行が開発ログの中で確認できるでしょう。Active Recordによってたくさんのメソッドが提供されているので、この本では生のSQLを書く必要がありません。そして、これ以降はSQLコマンドについて議論することを省略します。それでも、ログを見ることによってたくさんのSQLを学ぶことができるでしょう。</p>

<p>新しいユーザーオブジェクトは、<code>id</code>と魔法のカラムである<code>created_at</code>と<code>updated_at</code>属性に<code>nil</code>の値を持っているのに気づいたでしょうか。<code>save</code>が何か変更を与えるか見てみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p><code>id</code>には<code>1</code>という値が代入され、一方で魔法のカラムには現在の日時が代入されているのがわかります。<sup class="footnote" id="fnref-6_6"><a href="http://railstutorial.jp/modeling-users.html#fn-6_6">6</a></sup> 現在、作成と更新のタイムスタンプは同一ですが、<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-updating_user_objects">6.1.5</a>でそれらが異なるのを見るでしょう。</p>

<p><a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_user_class">4.4.5</a>のUserクラスと同様に、Userモデルのインスタンスはドット記法を用いてその属性にアクセスすることができます。<sup class="footnote" id="fnref-6_7"><a href="http://railstutorial.jp/modeling-users.html#fn-6_7">7</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">Michael Hartl (マイケル・ハートル)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; Tue, 05 Dec 2011 00:57:46 UTC +00:00</span>
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/sign-up.html#top">第7章</a>で詳しく見ますが、上で見たようにモデルの生成と保存を2つのステップに分けておくと便利なことが多いです。しかし、Active Recordでは<code>User.create</code>で1つのステップにまとめる方法も提供しています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;A Nother&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;another@example.org&quot;</span><span class="p">)</span>
<span class="go">#&lt;User id: 2, name: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2011-12-05 01:05:24&quot;, updated_at: &quot;2011-12-05 01:05:24&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@bar.com&quot;</span><span class="p">)</span>
<span class="go">#&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2011-12-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2011-12-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p><code>User.create</code>は、<code>true</code>か<code>false</code>を返す代わりに、ユーザーオブジェクト自身を返すことを覚えておいてください。それにより (上の2つ目のコマンドにある<code>foo</code>のように) 変数に代入することも可能です。</p>

<p><code>create</code>の逆は<code>destroy</code>です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">destroy</span>
<span class="go">=&gt; #&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2011-12-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2011-12-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>奇妙なことに、<code>destroy</code>は<code>create</code>と同じようにそのオブジェクトを返します。しかしその返り値を使用しても、もう一度<code>destroy</code>を呼ぶことはできません。そして、おそらくさらに奇妙なことに、<code>destroy</code>されたオブジェクトはまだメモリ上に残っています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span>
<span class="go">=&gt; #&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2011-12-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2011-12-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>どうやってオブジェクトが本当に削除されたか知るのでしょうか。そして、保存して削除されていないオブジェクトの場合、どうやってデータベースからユーザーを取得するのでしょうか。Active Recordでユーザーオブジェクトを検索する方法を学ぶときが来たようです。</p>

<div class="label" id="sec-finding_user_objects"></div>


<h3><a id="sec-6_1_4" href="http://railstutorial.jp/modeling-users.html#sec-finding_user_objects" class="heading"><span class="number">6.1.4</span>ユーザーオブジェクトを検索する</a></h3>


<p>Active Recordはオブジェクトを検索するための方法をいくつか持っています。それらを使って過去に作った最初のユーザーを探してみましょう。また、3番目のユーザー (<code>foo</code>)が削除されていることを確認しましょう。まずは存在するユーザーから始めます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>ここでは、<code>User.find</code>にユーザーのidを渡します。するとActive Recordがそのidのユーザーを返してくれます。</p>

<p>それでは、<code>id</code>が<code>3</code>のユーザーがまだデータベースに存在するか確認してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordNotFound: Couldn&#39;t find User with ID=3</span>
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-creating_user_objects">6.1.3</a>で3番目のユーザーを削除したので、Active Recordはそれをデータベースの中から見つけることができませんでした。代わりに、<code>find</code>は<em>例外</em>を投げます。例外はプログラムの実行時に例外的なイベントが起きたことを示すために使われます。この場合、存在しないActive Recordのidが、<code>find</code>に<code>ActiveRecord::RecordNotFound</code>例外<sup class="footnote" id="fnref-6_8"><a href="http://railstutorial.jp/modeling-users.html#fn-6_8">8</a></sup>を引き起こさせました。</p>

<p>一般的な<code>find</code>に加えて、Active Recordは特定の属性でユーザーを検索する方法も持っています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p><code>find_by_email</code>メソッドは、<code>users</code>テーブルの<code>email</code>属性に基づいてActive Recordが自動的に作ります (あなたの想像どおり、Active Recordは<code>find_by_name</code>メソッドも作ります)。 私たちはemailアドレスをユーザー名として使用してきたので、このような<code>find</code>は、ユーザーをサイトにログインさせる方法を学ぶときに役に立ちます (<a class="ref" href="http://railstutorial.jp/sign-up.html#top">第7章</a>)。もしユーザーがたくさんいる場合に<code>find_by_email</code>は有用ではないと心配するならば、あなたは少し先走っています。この問題とデータベースのインデックスを使った解決策については<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-uniqueness_validation">6.2.5</a>で扱います。</p>

<p>もう少しユーザーを検索する一般的な方法を見てから終わりにしましょう。まず初めに<code>first</code>です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>読んで字のごとく<code>first</code>はただデータベースの最初のユーザーを返します。次は<code>all</code>です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span>
<span class="go">=&gt; [#&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;,</span>
<span class="go">#&lt;User id: 2, name: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2011-12-05 01:05:24&quot;, updated_at: &quot;2011-12-05 01:05:24&quot;&gt;]</span>
</pre></div>
</div>


<p><code>all</code>がデータベースのすべてのユーザーの配列 (<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-arrays_and_ranges">4.3.1</a>) を返すと推測できても特に驚きはありません。</p>

<div class="label" id="sec-updating_user_objects"></div>


<h3><a id="sec-6_1_5" href="http://railstutorial.jp/modeling-users.html#sec-updating_user_objects" class="heading"><span class="number">6.1.5</span>ユーザーオブジェクトを更新する</a></h3>


<p>オブジェクトを作ったら今度は更新したくなります。基本的な更新の方法は2つです。ひとつは、<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_user_class">4.4.5</a>でやったように属性を個別に代入する方法です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>           <span class="c1"># Just a reminder about our user&#39;s attributes</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;mhartl@example.net&quot;</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>変更をデータベースに書き込むには最後のステップが必要なことを忘れないでください。<code>reload</code>を使うと、データベースの情報を元にオブジェクトを読み直すので、保存しない場合に何が起きるかを見ることができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;foo@bar.com&quot;</span>
<span class="go">=&gt; &quot;foo@bar.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
</pre></div>
</div>


<p>私たちは今ユーザーを更新しました。<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-creating_user_objects">6.1.3</a>で約束したように、魔法のカラムは異なっています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
<span class="go">=&gt; &quot;2011-12-05 00:57:46&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; &quot;2011-12-05 01:37:32&quot;</span>
</pre></div>
</div>


<p>属性を更新する2つ目の方法は、<code>update_attributes</code>を使うものです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;The Dude&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;dude@abides.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; &quot;The Dude&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;dude@abides.org&quot;</span>
</pre></div>
</div>


<p><code>update_attributes</code>メソッドは属性のハッシュを受け取り、成功時には更新と保存の両方を1つのステップで行います (保存がうまくいった場合は<code>true</code>を返します)。<code>attr_accessible</code> (<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-accessible_attributes">6.1.2.2</a>) を使っていくつかの属性をアクセス可能にしている場合、これの価値はありません。<code>update_attributes</code>を使うと、指定したアクセス可能な属性<em>だけ</em>が更新されます。もしあなたのモデルがあるカラムの更新を謎に拒み始めたら、それらのカラムが<code>attr_accessible</code>に含まれているか確認してください。</p>

<div class="label" id="sec-user_validations"></div>


<h2><a id="sec-6_2" href="http://railstutorial.jp/modeling-users.html#sec-user_validations" class="heading"><span class="number">6.2</span>ユーザーを検証する</a></h2>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-user_model">6.1</a>で作成したUserモデルは今、利用可能な<code>name</code>と<code>email</code>属性を持っています。しかし、これらが取れる値はあまりにも一般的で、現在は (空文字を含む) どんな文字列でも有効です。しかし、名前とメールアドレスはこれより明確なはずです。例えば、<code>name</code>は空っぽであるべきではないし、<code>email</code>はメールアドレスのフォーマットに従うべきです。さらに言えば、メールアドレスをユーザーがログインするときのユニークなユーザー名として使おうとしているので、データベースにemailが重複するのを許すべきではありません。</p>

<p>短く言うと、<code>name</code>と<code>email</code>に単純にどんな文字列でも許すのは避けるべきです。これらの値にはある制約を課すべきです。Active Recordでは<em>バリデーション</em>を使ってそのような制約を課すことができます。ここでは、よく使われるケースのうちのいくつかを説明します。それらは<em>存在性 (presence)</em>、<em>長さ (length)</em>、<em>フォーマット (format)</em>、<em>一意性 (uniqueness)</em>の検証です。<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-has_secure_password">6.3.4</a>では、よく使われるバリデーションの締めくくりに<em>確認 (confirmation)</em>を追加します。<a class="ref" href="http://railstutorial.jp/sign-up.html#sec-signup_failure">7.3</a>では、ユーザーが制約を犯したときに、バリデーションがどのように便利なエラーメッセージを与えてくれるかを見ます。</p>

<div class="label" id="sec-initial_user_tests"></div>


<h3><a id="sec-6_2_1" href="http://railstutorial.jp/modeling-users.html#sec-initial_user_tests" class="heading"><span class="number">6.2.1</span>最初のユーザーテスト</a></h3>


<p>サンプルアプリの他の機能と同じように、テスト駆動開発でUserモデルにバリデーションを追加していきます。なぜなら次のフラグ</p>

<pre class="verbatim">--no-test-framework</pre>


<p>を (<a class="ref" href="http://railstutorial.jp/filling-in-the-layout.html#code-generate_users_controller">リスト5.28</a>の例とは異なり) Userモデルを作成したときには渡さなかったからです。<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-generate_user_model">リスト6.1</a>のコマンドは、ユーザーをテストするための初期のスペックを作成します。しかし、この場合、実質的には空です (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-default_user_spec">リスト6.7</a>)。</p>

<div class="label" id="code-default_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.7.</span> <span class="description">実質的に空なデフォルトのUserスペック</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">pending</span> <span class="s2">&quot;add some examples to (or delete) </span><span class="si">#{</span><span class="bp">__FILE__</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これは単純に<code>pending</code>メソッドを使っているだけで、何か意味のあるものでスペックを埋めるように意図されています。その効果は、Userモデルのスペックを走らせることで確認することができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb 
<span class="go">*</span>


<span class="go">Finished in 0.01999 seconds</span>
<span class="go">1 example, 0 failures, 1 pending</span>

<span class="go">Pending:</span>
<span class="go">  User add some examples to (or delete)</span>
<span class="go">  /Users/mhartl/rails_projects/sample_app/spec/models/user_spec.rb</span>
<span class="go">  (Not Yet Implemented)</span>
</pre></div>
</div>


<p>多くのシステムでは、pendingのスペックは黄色で表示されます。それは、成功 (緑) と失敗 (赤) の間であることを意味します。</p>

<p>デフォルトのスペックのアドバイスに従い、<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-user_spec">リスト6.8</a>に示したいくつかのRSpecの例で埋めましょう。</p>

<div class="label" id="code-user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.8.</span> <span class="description"><code>:name</code>と<code>:email</code>属性のテスト</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/filling-in-the-layout.html#code-pretty_page_tests">リスト5.27</a>で見た<code>before</code>ブロックは、各サンプルの前にブロックの中のコードを実行します。この場合、<code>User.new</code>と初期化用の有効なハッシュを使って、新しい<code>@user</code>インスタンス変数を作ります。そして</p>

<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
</pre></div>
</div>


<p>は、<a class="ref" href="http://railstutorial.jp/filling-in-the-layout.html#sec-pretty_rspec">5.3.4</a>で<code>page</code>変数を扱ったときに見たように、<code>@user</code>をテストサンプルのデフォルトのsubjectにします。</p>

<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-user_spec">リスト6.8</a>の2つのサンプルは、<code>name</code>と<code>email</code>属性の存在をテストします。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>これらのサンプルではRubyメソッドの<code>respond_to?</code>を暗黙的に使っています。これは、シンボルを1つ受け取り、オブジェクトが引数として与えられたシンボルのメソッドか属性に応答する場合は<code>true</code>を返し、さもなければ<code>false</code>を返します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:foobar</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>(<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-objects_and_message_passing">4.2.3</a>のとおり、このようにRubyはtrue/falseの真偽値を返すメソッドに?マークを使うことを思い出してください)。これらのテストはRSpecで使われる<em>真偽値の慣習</em>に依存しています。次のコード</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>


<p>は、次のRSpecのコードでテストされます。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>


<p>しかし、<code>subject { @user }</code>があるので、テストの中で<code>@user</code>を使わずに次のように書くことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>このようなテストのおかげで、TDDを使って新しい属性やメソッドをUserモデルに追加することができます。そして、その副産物として、メソッドの素晴らしい仕様書を得るでしょう。すべての<code>User</code>オブジェクトがそのメソッドに応答します。</p>

<p>この時点でテストが失敗することを検証すべきです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-database_migrations">6.1.1</a>で、<code>rake db:migrate</code>を使って開発データベースを作成しましたが、テストは失敗します。それは、<em>テストデータベース</em>はまだデータモデルのことを知らないからです (実際、それはまだ存在しません)。<code>db:test:prepare</code>というRakeタスクを使って、正しい構造のテストデータベースを作ることができます。そして、それによってテストを通します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>これはただ開発データベースのデータモデルを保証するものです。<code>db/development.sqlite3</code>がテストデータベース<code>db/test.sqlite3</code>に反映されます。マイグレーションの後でこのRakeタスクを走らせて失敗することは、よくある混乱の元です。加えて、テストデータベースはときどき壊れることがあるので、その場合はリセットが必要です。もしあなたのテストスイートが謎に壊れるようなことがあれば、<code>rake db:test:prepare</code>を走らせて、その問題が解決するか確認してみてください。</p>

<div class="label" id="sec-presence_validation"></div>


<h3><a id="sec-6_2_2" href="http://railstutorial.jp/modeling-users.html#sec-presence_validation" class="heading"><span class="number">6.2.2</span>プレゼンスを検証する</a></h3>


<p>おそらく最も基本のバリデーションは<em>presence</em>です。これは与えられた属性の存在を単純に検証します。例えば、ここではユーザーがデータベースに保存される前にnameとemailフィールドの両方が存在することを保証します。<a class="ref" href="http://railstutorial.jp/sign-up.html#sec-signup_error_messages">7.3.2</a>では、どのようにこの要求を新しいユーザーを作るためのユーザー登録フォームまで伝搬させるかを確認します。</p>

<p>まずは<code>name</code>属性の存在を確認するテストから始めましょう。TDDの最初のステップは<em>失敗する</em>テスト (<a class="ref" href="http://railstutorial.jp/static-pages.html#sec-TDD">3.2.1</a>) を書くことですが、今回は適切なテストを書くためのバリデーションについてまだ十分に理解していないので、まず最初にバリデーションを書きます。コンソールを使ってそれを理解しましょう。次に、バリデーションをコメントアウトし、失敗するテストを書いて、コメントアウトを外したバリデーションでテストが通るか確認します。この手続きは、このような単純なテストでは野暮に感じるかもしれませんが、私はこれまでに多くの“単純な”テストを見てきました。それらは実際に間違いをテストするのです。TDDに慎重になることは単純に、正しいことをテストしていると自信を得る<em>唯一の</em>方法です (このコメントアウトの技術は、アプリのコードがすでに書かれているけれど、<a href="http://en.wiktionary.org/wiki/quelle_horreur"><em>ひどいことに</em></a>テストがない場合に、アプリを救出する手段としても役に立ちます)。</p>

<p>name属性の存在を検査する方法は、<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_presence_of_name">リスト6.9</a>のとおり、<code>validates</code>メソッドを<code>presence: true</code>という引数と共に使うことです。<code>presence: true</code>という引数は、ひとつの要素からなる<em>オプションハッシュ</em>です。<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-css_revisited">4.3.4</a>のとおりメソッドの最後の引数としてハッシュを渡す場合、波括弧を付けなくても問題ありません (<a class="ref" href="http://railstutorial.jp/filling-in-the-layout.html#sec-adding_to_the_layout">5.1.1</a>で見たように、Railsではオプションハッシュの利用がよく繰り返されるテーマです)。</p>

<div class="label" id="code-validates_presence_of_name"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.9.</span> <span class="description"><code>name</code>属性の存在を検証する</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_presence_of_name">リスト6.9</a>は魔法のように見えるかもしれません。しかし、<code>validates</code>はただのメソッドで、実際には<code>attr_accessible</code>です。<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_presence_of_name">リスト6.9</a>に等しい公式は、括弧を使って以下のように書きます。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>

  <span class="n">validates</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>コンソールを立ち上げて、ユーザーモデルへのバリデーションの追加の効果を見てみましょう。<sup class="footnote" id="fnref-6_9"><a href="http://railstutorial.jp/modeling-users.html#fn-6_9">9</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p><code>user.save</code>は<code>false</code>を返しました。これは保存に失敗したことを意味します。最後のコマンドは、<code>valid?</code> メソッドで、オブジェクトがひとつ以上のバリデーションに失敗したときに<code>false</code>を返します。 また、すべてのバリデーションに通ったときに<code>true</code>を返します。この場合、バリデーションがひとつしかないので、どれが失敗したかわかります。しかし、失敗したときに作られる<code>errors</code>オブジェクトを使って確認すれば、もっと便利です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Name can&#39;t be blank&quot;]</span>
</pre></div>
</div>


<p>(Railsが属性の存在性を検査するときに、エラーメッセージはヒントになります。これには<code>blank?</code> メソッドを用います。<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-modifying_built_in_classes">4.4.3</a>の終わりに見ました)。</p>

<p>次は失敗するテストです。まず最初にテストが失敗することを確認するために、この時点 (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-commented_out_validation">リスト6.10</a>) でバリデーションをコメントアウトしましょう。</p>

<div class="label" id="code-commented_out_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.10.</span> <span class="description">失敗するテストを確認するためのバリデーションのコメントアウト</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="c1"># validates :name, presence: true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>最初のバリデーションテストは<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-failing_validates_name_spec">リスト6.11</a>にあります。</p>

<div class="label" id="code-failing_validates_name_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.11.</span> <span class="description"><code>name</code>属性のバリデーションの失敗するテスト</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;when name is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>最初の新しいサンプルはただの基本となるテストです。それにより、<code>@user</code>オブジェクトが有効かどうかをまず最初に確認します。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</pre></div>
</div>


<p>これは<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-initial_user_tests">6.2.1</a>で見た別のRSpecの真偽値の慣習のサンプルです。オブジェクトが真偽値を返すメソッド<code>foo?</code>に応答するときは、<code>be_foo</code>という一致するテストメソッドが存在します。この場合、次の呼び出しの結果をテストすることができます。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</pre></div>
</div>


<p>以下のテストを使って。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
</pre></div>
</div>


<p>前と同じように、<code>subject { @user }</code>があるので<code>@user</code>を使わずに書くことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</pre></div>
</div>


<p>2つ目のテストはまず初めに、ユーザーのnameに有効でない値 (blank) を設定し、<code>@user</code>オブジェクトの結果が有効でないことをテストして確認します。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when name is not present&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>ユーザーのnameに有効でない値 (blank) を設定するために<code>before</code>ブロックを使います。そして、ユーザーオブジェクトの結果が有効でないことを確認します。</p>

<p>この時点でテストが失敗することを確認してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">...</span><span class="go">F</span>
<span class="go">4 examples, 1 failure</span>
</pre></div>
</div>


<p>それではテストを通すためにバリデーションのコメントアウトを外しましょう (すなわち<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-commented_out_validation">リスト6.10</a>を<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_presence_of_name">リスト6.9</a>に戻します)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">....</span>
<span class="go">4 examples, 0 failures</span>
</pre></div>
</div>


<p>もちろん、メールアドレスの存在性も検査します。テスト (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_email_spec">リスト6.12</a>) は、<code>name</code>属性のものに似ています。</p>

<div class="label" id="code-validates_email_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.12.</span> <span class="description"><code>email</code>属性の存在性のテスト</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_presence_of_email">リスト6.13</a>で見たように、実装もまた実際には同じです。</p>

<div class="label" id="code-validates_presence_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.13.</span> <span class="description"><code>name</code>と<code>email</code>属性の存在性の検査</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>すべてのテストが通るようになりました。これで、存在性のバリデーションは終わりです。</p>

<div class="label" id="sec-length_validation"></div>


<h3><a id="sec-6_2_3" href="http://railstutorial.jp/modeling-users.html#sec-length_validation" class="heading"><span class="number">6.2.3</span>長さを検証する</a></h3>


<p>各ユーザーは、Userモデルにnameを持つよう強制されます。しかし、これでは十分ではありません。ユーザーの名前はサンプルサイトに表示されるでしょう。なので、長さにも制限を持たせるべきです。<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-presence_validation">6.2.2</a>で行った作業があるので、このステップは簡単です。</p>

<p>まずはテストから始めます。最長のユーザー名の長さを取り出す科学はありません。なので、単純に<code>50</code>という上限として手頃な値を使います。すなわち、<code>51</code>文字の名前は長すぎることを検証します (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-length_validation_test">リスト6.14</a>)。</p>

<div class="label" id="code-length_validation_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.14.</span> <span class="description"><code>name</code>の長さ検証のテスト</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when name is too long&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>利便性のため、<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-length_validation_test">リスト6.14</a>では51文字の文字列を作るために“文字列のかけ算”を使いました。コンソールを使って、それを確認することができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span>
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 51</span>
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-length_validation_test">リスト6.14</a>のテストは失敗します。これをパスさせるためには、長さを強制するためのバリデーション引数について知る必要があります。<code>:maximum</code>パラメータと共に用いられる<code>:length</code>は、長さの上限を強制します (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-length_validation">リスト6.15</a>)。</p>

<div class="label" id="code-length_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.15.</span> <span class="description"><code>name</code>属性のための長さのバリデーションの追加</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これでテストは通るはずです。テストに通るこのテストスイートを使って、emailフォーマットというよりやりがいのあるバリデーションに移りましょう。</p>

<div class="label" id="sec-format_validation"></div>


<h3><a id="sec-6_2_4" href="http://railstutorial.jp/modeling-users.html#sec-format_validation" class="heading"><span class="number">6.2.4</span>フォーマットを検証する</a></h3>


<p><code>name</code>属性のバリデーションには最小限の制約しか課しませんでした。それは、空文字でない、51文字未満の名前です。もちろん、<code>email</code>属性はもっと厳重な要求を満たさなければなりません。これまでは空のメールアドレスのみを拒否してきました。ここでは、メールアドレスにおなじみのパターン<code>user@example.com</code>を確認することを要求します。</p>

<p>テストもバリデーションも、ほとんどの有効なメールアドレスを受け入れ、ほとんどの無効なものを拒否するのに十分なだけで、徹底してはいません。有効なメールアドレスと無効なメールアドレスのコレクションを持ったテストから始めましょう。このコレクションを作るために、次のコンソールセッションに見られるような、文字列の配列を作る<code>%w[]</code>という便利なテクニックを知っておくと良いです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[foo bar baz]</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.</span><span class="sx">COM THE_US-ER@foo.bar.org first.last@foo.jp]</span>
<span class="go">=&gt; [&quot;user@foo.</span><span class="go">COM&quot;, &quot;THE_US-ER@foo.bar.org&quot;, &quot;first.last@foo.jp&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="n">address</span>
end
<span class="go">user@foo.</span><span class="go">COM</span>
<span class="go">THE_US-ER@foo.bar.org</span>
<span class="go">first.last@foo.jp</span>
</pre></div>
</div>


<p><code>メールアドレス</code>の配列の各要素を、<code>each</code>メソッドを使って繰り返し取り出しました (<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-blocks">4.3.2</a>)。このテクニックを手にしたら、基礎のメールフォーマットバリデーションのテストを書く準備は整いました (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-email_format_validation_tests">リスト6.16</a>)。</p>

<div class="label" id="code-email_format_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.16.</span> <span class="description">メールフォーマットバリデーションのテスト</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email format is invalid&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be invalid&quot;</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo,com user_at_foo.org example.user@foo.</span>
<span class="sx">                     foo@bar_baz.com foo@bar+baz.com]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invalid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">invalid_address</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
      <span class="k">end</span>      
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when email format is valid&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be valid&quot;</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.</span><span class="sx">COM A_US-ER@f.b.org frst.lst@foo.jp a+b@baz.cn]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">valid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">valid_address</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
      <span class="k">end</span>      
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上で示したものは網羅的とは言いがたいですが、一般的に有効なメールの形式である<code>user@foo.COM</code>、<code>THE_US-ER@foo.bar.org </code> (大文字、アンダースコア、compound domains) 、<code>first.last@foo.jp</code> (一般的な企業のユーザー名<code>名.姓</code>と、2文字のトップレベルドメイン<code>jp</code>) を、いくつかの無効な形式と共に確認しました。</p>

<p>メールフォーマットバリデーションのアプリのコードは、<code>validates</code>メソッドの<code>:format</code>引数と共に、フォーマットを定義するために<em>正規表現 (regular expression)</em> (または<em>regex</em>) を使います (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_format_of_email">リスト6.17</a>)。</p>

<div class="label" id="code-validates_format_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.17.</span> <span class="description">正規表現を使ったメールフォーマットの検査</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]</span><span class="sr">+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>正規表現<code>VALID_EMAIL_REGEX</code>は<em>定数</em>です。大文字で始まる名前はRubyでは定数を意味します。次のコード</p>

<div class="code"><div class="highlight"><pre>  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]</span><span class="sr">+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
</pre></div>
</div>


<p>は、パターンに一致するメールアドレスだけが有効であることを保証します (大文字で始まるので<code>VALID_EMAIL_REGEX</code>はRubyの<em>定数</em>で、その値は変更できません)。</p>

<p>では、このパターンはどこから来たのでしょうか。正規表現は簡潔な (ある人は<a href="http://catb.org/jargon/html/L/line-noise.html">読めない</a>という) テキストパターンマッチング言語から成ります。正規表現を組み立てることを学ぶのは芸術であり、それを始めるには<code>VALID_EMAIL_REGEX</code>をビットサイズの破片に分解します (<a class="ref" href="http://railstutorial.jp/modeling-users.html#table-valid_email_regex">表6.1</a>)。<sup class="footnote" id="fnref-6_10"><a href="http://railstutorial.jp/modeling-users.html#fn-6_10">10</a></sup> 本当に正規表現を学びたいなら、素晴らしい正規表現エディタである<a href="http://www.rubular.com/">Rubular</a> (<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-rubular">図6.4</a>) が必要不可欠です。<sup class="footnote" id="fnref-6_11"><a href="http://railstutorial.jp/modeling-users.html#fn-6_11">11</a></sup> Rubularのウェブサイトは、正規表現を作るための美しく対話的なインターフェイスを持っています。また、手軽な正規表現のクイックリファレンスもあります。Rubularのサイトをブラウザで開いて<a class="ref" href="http://railstutorial.jp/modeling-users.html#table-valid_email_regex">表6.1</a>を学ぶことをお勧めします。正規表現について学んだことがなくても、Rubularを使えば数時間で慣れることができます (注: <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_format_of_email">リスト6.17</a>の正規表現をRubularで使う場合、<tt class="verb">\A</tt>と<tt class="verb">\z</tt>の文字は外してください)。</p>

<div class="label" id="table-valid_email_regex"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>表現</strong></th><th class="align_left"><strong>意味</strong></th></tr><tr class="top_bar"><td class="align_left"><tt class="verb">/\A[\w+\-.]+@[a-z\d\-.]</tt><tt class="verb">+\.[a-z]+\z/i</tt></td><td class="align_left">完全な正規表現</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">正規表現の始まり</td></tr><tr><td class="align_left"><tt class="verb">\A</tt></td><td class="align_left">文字列の先頭</td></tr><tr><td class="align_left"><tt class="verb">[\w+\-.]</tt><tt class="verb">+</tt></td><td class="align_left">英数字、プラス、ハイフン、ドットから成る少なくとも1文字</td></tr><tr><td class="align_left"><tt class="verb">@</tt></td><td class="align_left">アットマーク</td></tr><tr><td class="align_left"><tt class="verb">[a-z\d\-.]</tt><tt class="verb">+</tt></td><td class="align_left">英小文字、数字、ハイフン、ドットから成る少なくとも1文字</td></tr><tr><td class="align_left"><tt class="verb">\.</tt></td><td class="align_left">ドット</td></tr><tr><td class="align_left"><tt class="verb">[a-z]+</tt></td><td class="align_left">英小文字の少なくとも1文字</td></tr><tr><td class="align_left"><tt class="verb">\z</tt></td><td class="align_left">文字列の末尾</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">正規表現の終わり</td></tr><tr><td class="align_left"><tt class="verb">i</tt></td><td class="align_left">大文字小文字を無視する</td></tr></table></div><div class="caption"><span class="header">表6.1</span><span class="description"><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_format_of_email">リスト6.17</a>のメールの正規表現の分解</span></div></div>


<p>ところで、公式標準によるとメールアドレスに完全に一致する正規表現は存在します。しかし、骨折り甲斐はありません。<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_format_of_email">リスト6.17</a>の例は問題ありません。おそらく、公式のものより良いでしょう。<sup class="footnote" id="fnref-6_12"><a href="http://railstutorial.jp/modeling-users.html#fn-6_12">12</a></sup></p>

<div class="label" id="fig-rubular"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/rubular.png" alt="rubular" /></span></div><div class="caption"><span class="header">図6.4</span><span class="description">素晴らしい<a href="http://www.rubular.com/">Rubular</a>という正規表現エディタ<a href="http://railstutorial.org/images/figures/rubular-full.png">(拡大)</a></span></div></div>


<p>テストはすべて通っていると思います (実際、有効なメールアドレスのテストはずっと通ってきたし、正規表現は悪名高いほど誤りがちなので、有効なメールのテストは<code>VALID_EMAIL_REGEX</code>の上での簡単な確認でしかありません)。残り1つの制約は、メールアドレスが一意であることを強制するものです。</p>

<div class="label" id="sec-uniqueness_validation"></div>


<h3><a id="sec-6_2_5" href="http://railstutorial.jp/modeling-users.html#sec-uniqueness_validation" class="heading"><span class="number">6.2.5</span>一意性を検証する</a></h3>


<p>メールアドレスの一意性を強制するために (ユーザー名として使うために)、<code>validates</code>メソッドの<code>:unique</code>オプションを使います。ただし<em>重大な</em>警告があります。流し読みはせず、注意深く読んでください。</p>

<p>いつも通りテストから始めます。モデルのテストではこれまで、主に<code>User.new</code>を使ってきました。これは単にメモリ上にRubyのオブジェクトを作るだけです。しかし、一意性のテストのために実際にレコードをデータベースに登録する必要があります。<sup class="footnote" id="fnref-6_13"><a href="http://railstutorial.jp/modeling-users.html#fn-6_13">13</a></sup> (最初の)重複メールアドレスのテストは<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_uniqueness_of_email_test">リスト6.18</a>を見てください。</p>

<div class="label" id="code-validates_uniqueness_of_email_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.18.</span> <span class="description">重複するメールアドレスの拒否のテスト</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email address is already taken&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">user_with_same_email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここのメソッドでは<code>@user</code>と同じメールアドレスでユーザーを作ります。そのために、同じ属性の重複ユーザーを作るための<code>@user.dup</code>を使います。その後そのユーザーを保存しようとすると、元の<code>@user</code>のメールアドレスが既にデータベースに存在するため、検査が有効にはなりません。</p>

<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_uniqueness_of_email">リスト6.19</a>のコードで通る新しいテストが<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_uniqueness_of_email_test">リスト6.18</a>にあります。</p>

<div class="label" id="code-validates_uniqueness_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.19.</span> <span class="description">メールアドレスの一意性の検査</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ほとんど何もしていないけれど、メールアドレスは典型的に大文字小文字を区別しないように扱われます。すなわち、<code>foo@bar.com</code>は<code>FOO@BAR.COM</code>や<code>FoO@BAr.coM</code>と同じように扱われます。従って、バリデーションはこのようなケースも考慮すべきです。<sup class="footnote" id="fnref-6_14"><a href="http://railstutorial.jp/modeling-users.html#fn-6_14">14</a></sup> <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_uniqueness_of_email_case_insensitive_test">リスト6.20</a>のコードで大文字小文字を区別しないものをテストしています。</p>

<div class="label" id="code-validates_uniqueness_of_email_case_insensitive_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.20.</span> <span class="description">大文字小文字を区別しない場合に重複するメールアドレスの拒否のテスト</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email address is already taken&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">user_with_same_email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we are using the <code>upcase</code> method on strings (seen briefly in <a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-blocks">Section 4.3.2</a>). This test does the same thing as the first duplicate email test, but with an upper-case email address instead. If this test feels a little abstract, go ahead and fire up the console:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="go">=&gt; &quot;USER@EXAMPLE.COM&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">dup</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Of course, <code>user_with_same_email.valid?</code> is <code>true</code>, because the uniqueness validation is currently case-sensitive, but we want it to be <code>false</code>. Fortunately, <code>:uniqueness</code> accepts an option, <code>:case_sensitive</code>, for just this purpose (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_uniqueness_of_email_case_insensitive">Listing 6.21</a>).</p>

<div class="label" id="code-validates_uniqueness_of_email_case_insensitive"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.21.</span> <span class="description">Validating the uniqueness of email addresses, ignoring case. </span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness:</span> <span class="p">{</span> <span class="ss">case_sensitive:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we have simply replaced <code>true</code> with <code>case_sensitive: false</code>; Rails infers in this case that <code>:uniqueness</code> should be <code>true</code>. At this point, our application—with an important caveat—enforces email uniqueness, and our test suite should pass.</p>

<div class="label" id="sec-the_caveat"></div>


<h4><a id="sec-6_2_5_1" href="http://railstutorial.jp/modeling-users.html#sec-the_caveat" class="heading">一意性の警告</a></h4>


<p>There’s just one small problem, the caveat alluded to above:</p>

<p><strong>Using <code>validates :uniqueness</code> does not guarantee uniqueness.</strong></p>

<p>D’oh! But what can go wrong? Here’s what:</p>

<ol>
<li>Alice signs up for the sample app, with address alice@wonderland.com.</li>
<li>Alice accidentally clicks on “Submit” <em>twice</em>, sending two requests in quick succession.</li>
<li>The following sequence occurs: request 1 creates a user in memory that passes validation, request 2 does the same, request 1’s user gets saved, request 2’s user gets saved.</li>
<li>Result: two user records with the exact same email address, despite the uniqueness validation.</li>
</ol>


<p>If the above sequence seems implausible, believe me, it isn’t: it can happen on any Rails website with significant traffic. Luckily, the solution is straightforward to implement; we just need to enforce uniqueness at the database level as well. Our method is to create a database <em>index</em> on the email column, and then require that the index be unique.</p>

<p>The email index represents an update to our data modeling requirements, which (as discussed in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-database_migrations">Section 6.1.1</a>) is handled in Rails using migrations. We saw in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-database_migrations">Section 6.1.1</a> that generating the User model automatically created a new migration (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-users_migration">Listing 6.2</a>); in the present case, we are adding structure to an existing model, so we need to create a migration directly using the <code>migration</code> generator:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_index_to_users_email
</pre></div>
</div>


<p>Unlike the migration for users, the email uniqueness migration is not pre-defined, so we need to fill in its contents with <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-email_uniqueness_index">Listing 6.22</a>.<sup class="footnote" id="fnref-6_15"><a href="http://railstutorial.jp/modeling-users.html#fn-6_15">15</a></sup></p>

<div class="label" id="code-email_uniqueness_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.22.</span> <span class="description">The migration for enforcing email uniqueness. </span><br /><span class="description"> <code>db/migrate/[timestamp]_add_index_to_users_email.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddIndexToUsersEmail</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This uses a Rails method called <code>add_index</code> to add an index on the <code>email</code> column of the <code>users</code> table. The index by itself doesn’t enforce uniqueness, but the option <code>unique: true</code> does.</p>

<p>The final step is to migrate the database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>


<p>(If this fails, try exiting any running sandbox console sessions, which can lock the database and prevent migrations.) If you’re interested in seeing the practical effect of this, take a look at the file <code>db/schema.rb</code>, which should now include a line like this:</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;index_users_on_email&quot;</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div>
</div>


<p>Unfortunately, there’s one more change we need to make to be assured of email uniqueness, which is to make sure that the email address is all lower-case before it gets saved to the database. The reason is that not all database adapters use case-sensitive indices.<sup class="footnote" id="fnref-6_16"><a href="http://railstutorial.jp/modeling-users.html#fn-6_16">16</a></sup> The way to do this is with a <a href="http://en.wikipedia.org/wiki/Callback_(computer_science)"><em>callback</em></a>, which is a method that gets invoked at a particular point in the lifetime of an Active Record object (see the <a href="http://api.rubyonrails.org/v3.2.0/classes/ActiveRecord/Callbacks.html">Rails API entry on callbacks</a>). In the present case, we’ll use a <code>before_save</code> callback to force Rails to downcase the email attribute before saving the user to the database, as shown in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-email_downcase">Listing 6.23</a>.</p>

<div class="label" id="code-email_downcase"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.23.</span> <span class="description">Ensuring email uniqueness by downcasing the email attribute. </span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The code in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-email_downcase">Listing 6.23</a> passes a block to the <code>before_save</code> callback and sets the user’s email address to a lower-case version of its current value using the <code>downcase</code> string method. This code is a little advanced, and at this point I suggest you simply trust that it works; if you’re skeptical, comment out the uniqueness validation from <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_uniqueness_of_email">Listing 6.19</a> and try to create users with identical email addresses to see the error that results. (We’ll see this technique again in <a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#sec-remember_me">Section 8.2.1</a>.)</p>

<p>Now the Alice scenario above will work fine: the database will save a user record based on the first request, and will reject the second save for violating the uniqueness constraint. (An error will appear in the Rails log, but that doesn’t do any harm. You can actually catch the <code>ActiveRecord::StatementInvalid</code> exception that gets raised—see <a href="http://github.com/insoshi/insoshi/blob/master/app/controllers/people_controller.rb">Insoshi</a> for an example—but in this tutorial we won’t bother with this step.) Adding this index on the email attribute accomplishes a second goal, alluded to briefly in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-finding_user_objects">Section 6.1.4</a>: it fixes an efficiency problem in <code>find_by_email</code> (<a class="ref" href="http://railstutorial.jp/modeling-users.html#sidebar-database_indices">Box 6.2</a>).</p>

<div class="label" id="sidebar-database_indices"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.2.</span></span><span class="title"><span class="description">Database indices</span></span>
<p>When creating a column in a database, it is important to consider whether we will need to <em>find</em> records by that column. Consider, for example, the <tt>email</tt> attribute created by the migration in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-users_migration">Listing 6.2</a>. When we allow users to sign in to the sample app starting in <a class="ref" href="http://railstutorial.jp/sign-up.html#top">Chapter 7</a>, we will need to find the user record corresponding to the submitted email address; unfortunately, based on the naïve data model, the only way to find a user by email address is to look through <em>each</em> user row in the database and compare its email attribute to the given email. This is known in the database business as a <em>full-table scan</em>, and for a real site with thousands of users it is a <a href="http://catb.org/jargon/html/B/Bad-Thing.html">Bad Thing</a>.</p>

<p>Putting an index on the email column fixes the problem. To understand a database index, it’s helpful to consider the analogy of a book index. In a book, to find all the occurrences of a given string, say “foobar”, you would have to scan each page for “foobar”. With a book index, on the other hand, you can just look up “foobar” in the index to see all the pages containing “foobar”. A database index works essentially the same way.</p>
</div>




<div class="label" id="sec-adding_a_secure_password"></div>


<h2><a id="sec-6_3" href="http://railstutorial.jp/modeling-users.html#sec-adding_a_secure_password" class="heading"><span class="number">6.3</span>セキュアなパスワードを追加する</a></h2>


<p>In this section, we’ll add the last of the basic User attributes: a secure password used to authenticate users of the sample application. The method is to require each user to have a password (with a password confirmation), and then store an encrypted version of the password in the database. We’ll also add a way to <em>authenticate</em> a user based on a given password, a method we’ll use in <a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#top">Chapter 8</a> to allow users to sign in to the site.</p>

<p>The method for authenticating users will be to take a submitted password, encrypt it, and compare the result to the encrypted value stored in the database. If the two match, then the submitted password is correct and the user is authenticated. By comparing encrypted values instead of raw passwords, we will be able to authenticate users without storing the passwords themselves. This means that, even if our database is compromised, our users’ passwords will still be secure.</p>

<p>Much of the secure password machinery will be implemented using a single Rails method called <code>has_secure_password</code> (first introduced in Rails 3.1). Because so much of what follows depends on this one method, it is difficult to develop secure passwords incrementally. As a result, starting in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-password_and_confirmation">Section 6.3.2</a>, we’ll write a large number of tests before getting any of them to pass. If you start getting bogged down, I recommend staying patient and pushing through, because there is a great payoff in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-has_secure_password">Section 6.3.4</a>. (Since screencasts allow for a more incremental development approach, interested readers should consider the <a href="http://railstutorial.org/screencasts">Ruby on Rails Tutorial screencasts</a> for a fuller understanding of this material.)</p>

<div class="label" id="sec-an_encrypted_password"></div>


<h3><a id="sec-6_3_1" href="http://railstutorial.jp/modeling-users.html#sec-an_encrypted_password" class="heading"><span class="number">6.3.1</span>暗号化されたパスワード</a></h3>


<p>We’ll start with the necessary change to the data model for users, which involves adding a <code>password_digest</code> column to the <code>users</code> table (<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-user_model_password_digest">Figure 6.5</a>). The name <em>digest</em> comes from the terminology of <a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function">cryptographic hash functions</a>, and the exact name <code>password_digest</code> is necessary for the implementation in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-has_secure_password">Section 6.3.4</a> to work. By encrypting the password properly, we’ll ensure that an attacker won’t be able to sign in to the site even if he manages to obtain a copy of the database.</p>

<div class="label" id="fig-user_model_password_digest"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/user_model_password_digest.png" alt="user_model_password_digest" /></span></div><div class="caption"><span class="header">Figure 6.5: </span><span class="description">The User model with an added <code>password_digest</code> attribute.</span></div></div>


<p>We’ll use the state-of-the-art hash function called <a href="http://en.wikipedia.org/wiki/Bcrypt">bcrypt</a> to irreversibly encrypt the password to form the password hash. To use bcrypt in the sample application, we need to add the <code>bcrypt-ruby</code> gem to our <code>Gemfile</code> (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-bcrypt_ruby">Listing 6.24</a>).</p>

<div class="label" id="code-bcrypt_ruby"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.24.</span> <span class="description">Adding <code>bcrypt-ruby</code> to the <code>Gemfile</code>.</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Then run <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>On some systems, you may get the warning</p>

<div class="code"><div class="highlight"><pre><span class="go">make: /usr/bin/gcc-4.2: No such file or directory</span>
</pre></div>
</div>


<p>To fix this, reinstall RVM using the <code>clang</code> flag:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm reinstall 1.9.3 --with-gcc<span class="o">=</span>clang
</pre></div>
</div>


<p>Since we want users to have a password digest column, a user object should respond to <code>password_digest</code>, which suggests the test shown in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-respond_to_password_digest">Listing 6.25</a>.</p>

<div class="label" id="code-respond_to_password_digest"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.25.</span> <span class="description">Ensuring that a User object has a <code>password_digest</code> column. </span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>To get the test to pass, we first generate an appropriate migration for the <code>password_digest</code> column:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_password_digest_to_users password_digest:string
</pre></div>
</div>


<p>Here the first argument is the migration name, and we’ve also supplied a second argument with the name and type of attribute we want to create. (Compare this to the original generation of the <code>users</code> table in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-generate_user_model">Listing 6.1</a>.) We can choose any migration name we want, but it’s convenient to end the name with <code>_to_users</code>, since in this case Rails automatically constructs a migration to add columns to the <code>users</code> table. Moreover, by including the second argument, we’ve given Rails enough information to construct the entire migration for us, as seen in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-password_migration">Listing 6.26</a>.</p>

<div class="label" id="code-password_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.26.</span> <span class="description">The migration to add a <code>password_digest</code> column to the <code>users</code> table. </span><br /><span class="description"> <code>db/migrate/[ts]_add_password_digest_to_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddPasswordDigestToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code uses the <code>add_column</code> method to add a <code>password_digest</code> column to the <code>users</code> table.</p>

<p>We can get the failing test from <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-respond_to_password_digest">Listing 6.25</a> to pass by migrating the development database and preparing the test database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
<span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-password_and_confirmation"></div>


<h3><a id="sec-6_3_2" href="http://railstutorial.jp/modeling-users.html#sec-password_and_confirmation" class="heading"><span class="number">6.3.2</span>パスワードと確認</a></h3>


<p>As seen in the mockup in <a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-signup_mockup_preview">Figure 6.1</a>, we expect to have users confirm their passwords, a common practice on the web meant to minimize typos. We could enforce this at the controller layer, but it’s conventional to put it in the model and use Active Record to enforce the constraint. The method is to add <code>password</code> and <code>password_confirmation</code> attributes to the User model, and then require that the two attributes match before the record is saved to the database. Unlike the other attributes we’ve seen so far, the password attributes will be <em>virtual</em>—they will only exist temporarily in memory, and will not be persisted to the database. As we’ll see in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-has_secure_password">Section 6.3.4</a>, these virtual attributes are implemented automatically by <code>has_secure_password</code>.</p>

<p>We’ll start with <code>respond_to</code> tests for a password and its confirmation, as seen in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-user_respond_to_password">Listing 6.27</a>.</p>

<div class="label" id="code-user_respond_to_password"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.27.</span> <span class="description">Testing for the <code>password</code> and <code>password_confirmation</code> attributes. </span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we’ve added <code>:password</code> and <code>:password_confirmation</code> to the initialization hash for <code>User.new</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                   <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>We definitely don’t want users to enter a blank password, so we’ll add another test to validate password presence:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when password is not present&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Since we’ll be testing password mismatch in a moment, here we make sure to test the <em>presence</em> validation by setting both the password and its confirmation to a blank string. This uses Ruby’s ability to make more than one assignment in a line. For example, in the console we can set both <code>a</code> and <code>b</code> to <code>3</code> as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span>
<span class="go">=&gt; 3</span>
</pre></div>
</div>


<p>In the present case, we use it to set both password attributes to <code>&quot; &quot;</code>:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
</pre></div>
</div>


<p>We also want to ensure that the password and confirmation match. The case where they <em>do</em> match is already covered by <code>it { should be_valid }</code>, so we only need to test the case of a mismatch:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when password doesn&#39;t match confirmation&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;mismatch&quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>In principle, we are now done, but there is one case that doesn’t quite work. What if the password confirmation is blank? If it is empty or consists of whitespace but the password is valid, then the two don’t match and the confirmation validation will catch it. If both the password and its confirmation are empty or consist of whitespace, then the password presence validation will catch it. Unfortunately, there’s one more possibility, which is that the password confirmation is <em>nil</em>. This can never happen through the web, but it can at the console:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>            <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="kp">nil</span><span class="p">)</span>
</pre></div>
</div>


<p>When the confirmation is <code>nil</code>, Rails doesn’t run the confirmation validation, which means that we can create users at the console without password confirmations. (Of course, right <em>now</em> we haven’t added the validations yet, so the code above will work in any case.) To prevent this, we’ll add a test to catch this case:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when password confirmation is nil&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>(This behavior strikes me as a minor bug in Rails, and perhaps it will be fixed in a future version, and in any case adding the validation does no harm.)</p>

<p>Putting everything together gives the (failing) tests in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-password_tests">Listing 6.28</a>. As noted in the introduction to this section, it is difficult to develop secure passwords incrementally due to the large number of features encapsulated in <code>has_secure_password</code>, so at this point all of these new tests fail. We’ll get them to pass in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-has_secure_password">Section 6.3.4</a>.</p>

<div class="label" id="code-password_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.28.</span> <span class="description">Test for the password and password confirmation. </span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when password is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when password doesn&#39;t match confirmation&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;mismatch&quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when password confirmation is nil&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-user_authentication"></div>


<h3><a id="sec-6_3_3" href="http://railstutorial.jp/modeling-users.html#sec-user_authentication" class="heading"><span class="number">6.3.3</span>ユーザー認証</a></h3>


<p>The final piece of our password machinery is a method to retrieve users based on their email and passwords. This divides naturally into two parts: first, find a user by email address; second, authenticate the user with a given password.</p>

<p>The first step is simple; as we saw in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-finding_user_objects">Section 6.1.4</a>, we can find a user with a given email address using the <code>find_by_email</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</pre></div>
</div>


<p>The second step is then to use an <code>authenticate</code> method to verify that the user has the given password. In <a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#top">Chapter 8</a>, we’ll retrieve the current (signed-in) user using code something like this:</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>


<p>If the given password matches the user’s password, it should return the user; otherwise, it should return <code>false</code>.</p>

<p>As usual, we can express the requirement for <code>authenticate</code> using RSpec. The resulting tests are more advanced than the others we’ve seen, so let’s break them down into pieces; if you’re new to RSpec, you might want to read this section a couple of times. We start by requiring a User object to respond to <code>authenticate</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>We then cover the two cases of password match and mismatch:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;return value of authenticate method&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;with valid password&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with invalid password&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="o">==</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="n">user_for_invalid_password</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The <code>before</code> block saves the user to the database so that it can be retrieved using <code>find_by_email</code>, which we accomplish using the <code>let</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>We’ve used <code>let</code> in a couple of exercises, but this is the first time we’ve seen it in the body of the tutorial. <a class="ref" href="http://railstutorial.jp/modeling-users.html#sidebar-let">Box 6.3</a> covers <code>let</code> in more detail.</p>

<p>The two <code>describe</code> blocks cover the case where <code>@user</code> and <code>found_user</code> should be the same (password match) and different (password mismatch); they use the “double equals” <code>==</code> test for object equivalence (<a class="ref" href="http://railstutorial.jp/rails-flavored-ruby.html#sec-arrays_and_ranges">Section 4.3.1</a>). Note that the tests in</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with invalid password&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="o">==</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
  <span class="n">specify</span> <span class="p">{</span> <span class="n">user_for_invalid_password</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>use <code>let</code> a second time, and also use the <code>specify</code> method. This is just a synonym for <code>it</code>, and can be used when writing <code>it</code> would sound unnatural. In this case, it sounds good to say “it [i.e., the user] should not equal wrong user”, but it sounds strange to say “user: user with invalid password should be false”; saying “specify: user with invalid password should be false” sounds better.</p>

<div class="label" id="sidebar-let"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.3.</span></span><span class="title"><span class="description">Using <tt>let</tt></span></span>
<p>RSpec’s <tt>let</tt> method provides a convenient way to create local variables inside tests. The syntax might look a little strange, but its effect is similar to variable assignment. The argument of <tt>let</tt> is a symbol, and it takes a block whose return value is assigned to a local variable with the symbol’s name. In other words,</p>

<pre class="verbatim">let(:found_user) { User.find_by_email(@user.email) }</pre>


<p>creates a <tt>found_user</tt> variable whose value is equal to the result of <tt>find_by_email</tt>. We can then use this variable in any of the <tt>before</tt> or <tt>it</tt> blocks throughout the rest of the test. One advantage of <tt>let</tt> is that it <em>memoizes</em> its value, which means that it remembers the value from one invocation to the next. (Note that <a href="http://en.wikipedia.org/wiki/Memoization"><em>memoize</em></a> is a technical term; in particular, it’s <em>not</em> a misspelling of “memorize”.) In the present case, because <tt>let</tt> memoizes the <tt>found_user</tt> variable, the <tt>find_by_email</tt> method will only be called once whenever the User model specs are run.</p>
</div>


<p>Finally, as a security precaution, we’ll test for a length validation on passwords, requiring that they be at least six characters long:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with a password that&#39;s too short&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">5</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_invalid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Putting together all the tests above gives <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-authenticate_spec">Listing 6.29</a>.</p>

<div class="label" id="code-authenticate_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.29.</span> <span class="description">Test for the <code>authenticate</code> method. </span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;with a password that&#39;s too short&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">5</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_invalid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;return value of authenticate method&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid password&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid password&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="o">==</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">user_for_invalid_password</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As noted in <a class="ref" href="http://railstutorial.jp/modeling-users.html#sidebar-let">Box 6.3</a>, <code>let</code> memoizes its value, so that the first nested <code>describe</code> block in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-authenticate_spec">Listing 6.29</a> invokes <code>let</code> to retrieve the user from the database using <code>find_by_email</code>, but the second <code>describe</code> block doesn’t hit the database a second time.</p>

<div class="label" id="sec-has_secure_password"></div>


<h3><a id="sec-6_3_4" href="http://railstutorial.jp/modeling-users.html#sec-has_secure_password" class="heading"><span class="number">6.3.4</span>ユーザーがセキュアなパスワードを持っている</a></h3>


<p>In previous versions of Rails, adding a secure password was difficult and time-consuming, as seen in the <a href="http://railstutorial.org/book?version=3.0">Rails 3.0 version of the <em>Rails Tutorial</em></a>,<sup class="footnote" id="fnref-6_17"><a href="http://railstutorial.jp/modeling-users.html#fn-6_17">17</a></sup> which covers the creation of an authentication system from scratch. But web developers’ understanding of how best to authenticate users has matured enough that it now comes bundled with the latest version of Rails. As a result, we’ll complete the implementation of secure passwords (and get to a green test suite) using only a few lines of code.</p>

<p>First, we need to make the <code>password</code> and <code>password_confirmation</code> columns accessible (<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-accessible_attributes">Section 6.1.2.2</a>) so that we can instantiate new users with an initialization hash:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                 <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Following the model in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-attr_accessible">Listing 6.6</a>, we do this by adding the appropriate symbols to the list of accessible attributes:</p>

<div class="code"><div class="highlight"><pre><span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
</pre></div>
</div>


<p>Second, we need presence and length validations for the password, the latter of which uses the <code>:minimum</code> key in analogy with the <code>:maximum</code> key from <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-length_validation">Listing 6.15</a>:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">minimum:</span> <span class="mi">6</span> <span class="p">}</span>
</pre></div>
</div>


<p>Next, we need to add <code>password</code> and <code>password_confirmation</code> attributes, require the presence of the password, require that they match, and add an <code>authenticate</code> method to compare an encrypted password to the <code>password_digest</code> to authenticate users. This is the only nontrivial step, and in the latest version of Rails all these features come for free with one method, <code>has_secure_password</code>:</p>

<div class="code"><div class="highlight"><pre><span class="n">has_secure_password</span>
</pre></div>
</div>


<p>As long as there is a <code>password_digest</code> column in the database, adding this one method to our model gives us a secure way to create and authenticate new users.</p>

<p>(If you’d like to see how <code>has_secure_password</code> is implemented, I suggest taking a look at <a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb">the source code for <tt>secure_password.rb</tt></a>, which is well-documented and quite readable. That code includes the line</p>

<div class="code"><div class="highlight"><pre><span class="n">validates_confirmation_of</span> <span class="ss">:password</span>
</pre></div>
</div>


<p>which (as described in the <a href="http://api.rubyonrails.org/v3.2.0/classes/ActiveModel/Validations/HelperMethods.html#method-i-validates_confirmation_of">Rails API</a>) automagically creates an attribute called <code>password_confirmation</code>. It also includes a validation for the <code>password_digest</code> attribute; in <a class="ref" href="http://railstutorial.jp/sign-up.html#top">Chapter 7</a>, we’ll see that this is a mixed blessing.)</p>

<p>Finally, we need a presence validation for the password confirmation:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
</pre></div>
</div>


<p>Putting these three elements together yields the User model shown in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-password_implementation">Listing 6.30</a>, which completes the implementation of secure passwords.</p>

<div class="label" id="code-password_implementation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.30.</span> <span class="description">The complete implementation for secure passwords. </span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]</span><span class="sr">+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span>   <span class="kp">true</span><span class="p">,</span>
                    <span class="nb">format</span><span class="p">:</span>     <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness:</span> <span class="p">{</span> <span class="ss">case_sensitive:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">minimum:</span> <span class="mi">6</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>You should confirm at this point that the test suite passes:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-creating_a_user"></div>


<h3><a id="sec-6_3_5" href="http://railstutorial.jp/modeling-users.html#sec-creating_a_user" class="heading"><span class="number">6.3.5</span>ユーザーを作成する</a></h3>


<p>Now that the basic User model is complete, we’ll create a user in the database as preparation for making a page to show the user’s information in <a class="ref" href="http://railstutorial.jp/sign-up.html#sec-showing_users">Section 7.1</a>. This also gives us a chance to make the work from the previous sections feel more concrete; merely getting the test suite to pass may seem anti-climactic, and it will be gratifying to see an actual user record in the development database.</p>

<p>Since we can’t yet sign up through the web—that’s the goal of <a class="ref" href="http://railstutorial.jp/sign-up.html#top">Chapter 7</a>—we’ll use the Rails console to create a new user by hand. In contrast to <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-creating_user_objects">Section 6.1.3</a>, in this section we’ll take care <em>not</em> to start in a sandbox, since this time the whole point is to save a record to the database:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>            <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-07 03:38:14&quot;, updated_at: &quot;2011-12-07 03:38:14&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$P9OnzpdCON80yuMVk3jGr.LMA16VwOExJgjlw0G4f21y...&quot;</span><span class="go">&gt; </span>
</pre></div>
</div>


<p>To check that this worked, let’s look at the row in the development database (<code>db/development.sqlite3</code>) using the SQLite Database Browser (<a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-sqlite_user_row">Figure 6.6</a>). Note that the columns correspond to the attributes of the data model defined in <a class="ref" href="http://railstutorial.jp/modeling-users.html#fig-user_model_password_digest">Figure 6.5</a>.</p>

<div class="label" id="fig-sqlite_user_row"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/sqlite_user_row_with_password.png" alt="sqlite_user_row_with_password" /></span></div><div class="caption"><span class="header">Figure 6.6: </span><span class="description">A user row in the SQLite database <code>db/development.sqlite3</code>. <a href="http://railstutorial.org/images/figures/sqlite_user_row_with_password-full.png">(full size)</a></span></div></div>


<p>Returning to the console, we can see the effect of <code>has_secure_password</code> from <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-password_implementation">Listing 6.30</a> by looking at the <code>password_digest</code> attribute:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password_digest</span>
<span class="go">=&gt; &quot;$2a$10$P9OnzpdCON80yuMVk3jGr.LMA16VwOExJgjlw0G4f21yZIMSH/xoy&quot;</span>
</pre></div>
</div>


<p>This is the encrypted version of the password (<code>&quot;foobar&quot;</code>) used to initialize the user object. We can also verify that the <code>authenticate</code> command is working by first using an invalid password and then a valid one:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-07 03:38:14&quot;, updated_at: &quot;2011-12-07 03:38:14&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$P9OnzpdCON80yuMVk3jGr.LMA16VwOExJgjlw0G4f21y...&quot;</span><span class="go">&gt; </span>
</pre></div>
</div>


<p>As required, <code>authenticate</code> returns <code>false</code> if the password is invalid and the user itself if the password is valid.</p>

<h2><a id="sec-6_4" href="http://railstutorial.jp/modeling-users.html#sec-6_4" class="heading"><span class="number">6.4</span>最後に</a></h2>


<p>Starting from scratch, in this chapter we created a working User model with <code>name</code>, <code>email</code>, and various password attributes, together with validations enforcing several important constraints on their values. In addition, we can securely authenticate users using a given password. In previous versions of Rails, such a feat would have taken more than twice as much code, but because of the compact <code>validates</code> method and <code>has_secure_password</code>, we were able to build a complete User model in only ten source lines of code.</p>

<p>In the next chapter, <a class="ref" href="http://railstutorial.jp/sign-up.html#top">Chapter 7</a>, we’ll make a working signup form to create new users, together with a page to display each user’s information. In <a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#top">Chapter 8</a>, we’ll use the authentication machinery from <a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-adding_a_secure_password">Section 6.3</a> to let users sign into the site.</p>

<p>If you’re using Git, now would be a good time to commit if you haven’t done so in a while:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Make a basic User model (including secure passwords)&quot;</span>
</pre></div>
</div>


<p>Then merge back into the master branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge modeling-users
</pre></div>
</div>


<h2><a id="sec-6_5" href="http://railstutorial.jp/modeling-users.html#sec-6_5" class="heading"><span class="number">6.5</span>演習</a></h2>




<ol>

<li>Add a test for the email downcasing from <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-email_downcase">Listing 6.23</a>, as shown in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-email_downcase_test">Listing 6.31</a>. By commenting out the <code>before_save</code> line, verify that <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-email_downcase_test">Listing 6.31</a> tests the right thing.</li>

<li>By running the test suite, verify that the <code>before_save</code> callback can be written as shown in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-downcase_bang">Listing 6.32</a>.</li>

<li>Read through the Rails API entry for <code>ActiveRecord::Base</code> to get a sense of its capabilities.</li>
<li>Study the entry in the Rails API for the <code>validates</code> method to learn more about its capabilities and options.</li>
<li>Spend a couple of hours playing with <a href="http://www.rubular.com/">Rubular</a>.</li>

</ol>




<div class="label" id="code-email_downcase_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.31.</span> <span class="description">A test for the email downcasing from <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-email_downcase">Listing 6.23</a>. </span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;email address with mixed case&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:mixed_case_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Foo@ExAMPle.</span><span class="s2">CoM&quot;</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">&quot;should be saved as all lower-case&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">mixed_case_email</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">mixed_case_email</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-downcase_bang"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 6.32.</span> <span class="description">An alternate implementation of the <code>before_save</code> callback. </span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase!</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<div class="navigation">  <a class="prev_page" href="http://railstutorial.jp/filling-in-the-layout.html#top">
</a><a class="prev_page" href="http://railstutorial.jp/filling-in-the-layout.html#top"><span class="number">第5章</span>レイアウトを作成する</a><a class="prev_page" href="http://railstutorial.jp/filling-in-the-layout.html#top">  </a>
  <a class="next_page" href="http://railstutorial.jp/sign-up.html#top">
</a><a class="next_page" href="http://railstutorial.jp/sign-up.html#top">    <span class="number">第7章</span>ユーザー登録</a><a class="next_page" href="http://railstutorial.jp/sign-up.html#top">  </a>
</div><div class="footnotes">
<ol>
<li id="fn-6_1">The name comes from the “<a href="http://en.wikipedia.org/wiki/Active_record_pattern">active record pattern</a>”, identified and named in <em>Patterns of Enterprise Application Architecture</em> by Martin Fowler. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_1">↑</a></li>
<li id="fn-6_2">Pronounced “ess-cue-ell”, though the alternate pronunciation “sequel” is also common. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_2">↑</a></li>
<li id="fn-6_3">By using an email address as the username, we open the theoretical possibility of communicating with our users at a future date. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_3">↑</a></li>
<li id="fn-6_4">Don’t worry about exactly how the <code>t</code> object manages to do this; the beauty of <em>abstraction layers</em> is that we don’t have to know. We can just trust the <code>t</code> object to do its job. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_4">↑</a></li>
<li id="fn-6_5">Officially pronounced “ess-cue-ell-ite”, although the (mis)pronunciation “sequel-ite” is also common. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_5">↑</a></li>
<li id="fn-6_6">In case you’re curious about <code>&quot;2011-12-05 00:57:46&quot;</code>, I’m not writing this after midnight; the timestamps are recorded in <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">Coordinated Universal Time</a> (UTC), which for most practical purposes is the same as <a href="http://en.wikipedia.org/wiki/Greenwich_Mean_Time">Greenwich Mean Time</a>. From the <a href="http://tf.nist.gov/general/misc.htm">NIST Time and Frequency FAQ</a>:   <strong>Q:</strong> Why is UTC used as the acronym for Coordinated Universal Time instead of CUT? <strong>A:</strong> In 1970 the Coordinated Universal Time system was devised by an international advisory group of technical experts within the International Telecommunication Union (ITU). The ITU felt it was best to designate a single abbreviation for use in all languages in order to minimize confusion. Since unanimous agreement could not be achieved on using either the English word order, CUT, or the French word order, TUC, the acronym UTC was chosen as a compromise. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_6">↑</a></li>
<li id="fn-6_7">Note the value of <code>user.updated_at</code>. Told you the timestamp was in UTC. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_7">↑</a></li>
<li id="fn-6_8">Exceptions and exception handling are somewhat advanced Ruby subjects, and we won’t need them much in this book. They are important, though, and I suggest learning about them using one of the Ruby books recommended in <a class="ref" href="http://railstutorial.jp/beginning.html#sec-comments_for_various_readers">Section 1.1.1</a>. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_8">↑</a></li>
<li id="fn-6_9">I’ll omit the output of console commands when they are not particularly instructive—for example, the results of <code>User.new</code>. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_9">↑</a></li>
<li id="fn-6_10">Note that, in <a class="ref" href="http://railstutorial.jp/modeling-users.html#table-valid_email_regex">Table 6.1</a>, “letter” really means “lower-case letter”, but the <code>i</code> at the end of the regex enforces case-insensitive matching. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_10">↑</a></li>
<li id="fn-6_11">If you find it as useful as I do, I encourage you to <a href="http://bit.ly/donate-to-rubular">donate to Rubular</a> to reward developer <a href="http://lovitt.net/">Michael Lovitt</a> for his wonderful work. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_11">↑</a></li>
<li id="fn-6_12">Did you know that <code>&quot;Michael Hartl&quot;@example.com</code>, with quotation marks and a space in the middle, is a valid email address according to the standard? Incredibly, it is—but it’s absurd. If you don’t have an email address that contains only letters, numbers, underscores, and dots, then I recommend getting one. N.B. The regex in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-validates_format_of_email">Listing 6.17</a> allows plus signs, too, because Gmail (and possibly other email services) does something useful with them: to filter email from example.com, you can use <tt>username+example@gmail.com</tt>, which will go to the Gmail address <tt>username@gmail.com</tt>, allowing you to filter on the string <tt>example</tt>. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_12">↑</a></li>
<li id="fn-6_13">As noted briefly in the introduction to this section, there is a dedicated test database, <code>db/test.sqlite3</code>, for this purpose. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_13">↑</a></li>
<li id="fn-6_14">Technically, only the domain part of the email address is case-insensitive: foo@bar.com is actually different from Foo@bar.com. In practice, though, it is a bad idea to rely on this fact; as noted at <a href="http://email.about.com/od/emailbehindthescenes/f/email_case_sens.htm">about.com</a>, “Since the case sensitivity of email addresses can create a lot of confusion, interoperability problems and widespread headaches, it would be foolish to require email addresses to be typed with the correct case. Hardly any email service or ISP does enforce case sensitive email addresses, returning messages whose recipient’s email address was not typed correctly (in all upper case, for example). ” Thanks to reader Riley Moses for pointing this out. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_14">↑</a></li>
<li id="fn-6_15">Of course, we could just edit the migration file for the <code>users</code> table in <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-users_migration">Listing 6.2</a> but that would require rolling back and then migrating back up. The Rails Way is to use migrations every time we discover that our data model needs to change. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_15">↑</a></li>
<li id="fn-6_16">Direct experimentation with SQLite on my system and PostgreSQL on Heroku show that this step is, in fact, necessary. <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_16">↑</a></li>
<li id="fn-6_17">http://railstutorial.org/book?version=3.0 <a class="arrow" href="http://railstutorial.jp/modeling-users.html#fnref-6_17">↑</a></li>
</ol>
</div>




</div>
  </body>
</html>
