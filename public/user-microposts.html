<html dir="ltr">
  <head>
    <title>user-microposts</title>
    <link rel="stylesheet" href="http://railstutorial.jp/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://railstutorial.jp/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">
    <div id="book">

<h1 class="title">Ruby on Rails 3.2 チュートリアル</h1>


<h1 class="subtitle">実例を使ってRailsを学ぼう</h1>


<h2 class="author">Michael Hartl (マイケル・ハートル)</h2>




<h2 class="contents">目次</h2>


<div id="table_of_contents"><ol><li class="chapter"><a href="http://railstutorial.jp/beginning.html#top"><span class="number">第1章</span> ゼロから本番展開まで</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-introduction"><span class="number">1.1</span>はじめに</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-comments_for_various_readers"><span class="number">1.1.1</span>読者の皆さまへ</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-1_1_2"><span class="number">1.1.2</span> Railsとスケールについて</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-conventions"><span class="number">1.1.3</span>この本における取り決め</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-up_and_running"><span class="number">1.2</span> さっそく動作させる</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-development_tools"><span class="number">1.2.1</span>開発環境</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_2_1_1">IDE</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_2_1_2">テキストエディタとコマンドライン</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_2_1_3">ブラウザ</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_2_1_4">使用するツールについて</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-rubygems"><span class="number">1.2.2</span>Ruby、RubyGems、Rails、Git</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-rails_installer_windows">Railsインストーラ (Windows)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-install_git">Gitのインストール</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-install_ruby">Rubyのインストール</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-install_rubygems">RubyGemsのインストール</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-install_rails">Railsのインストール</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-the_first_application"><span class="number">1.2.3</span>最初のアプリケーション</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-bundler"><span class="number">1.2.4</span> Bundler</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-rails_server"><span class="number">1.2.5</span> <tt>rails server</tt></a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-mvc"><span class="number">1.2.6</span>Model-view-controller (MVC)</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-version_control"><span class="number">1.3</span>Gitによるバージョン管理</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-git_setup"><span class="number">1.3.1</span>インストールとセットアップ</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_3_1_1">初めてのシステム・セットアップ</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-1_3_1_2">初めてのリポジトリ・セットアップ</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-adding_and_committing"><span class="number">1.3.2</span>追加とコミット</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-1_3_3"><span class="number">1.3.3</span>Gitのメリット</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-github"><span class="number">1.3.4</span> GitHub</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-git_commands"><span class="number">1.3.5</span>ブランチ (branch)、変更 (edit)、 コミット (commit)、マージ (merge)</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_branch">ブランチ (branch)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_edit">変更 (edit)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_commit">コミット (commit)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_merge">マージ (merge)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/beginning.html#sec-git_push">プッシュ (push)</a></li></ol></li></ol></li><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-deploying"><span class="number">1.4</span>展開する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-heroku_setup"><span class="number">1.4.1</span> Herokuのセットアップ</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-heroku_step_one"><span class="number">1.4.2</span> Herokuに展開する (1)</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-1_4_3"><span class="number">1.4.3</span> Herokuに展開する (2)</a></li><li class="subsection"><a href="http://railstutorial.jp/beginning.html#sec-heroku_commands"><span class="number">1.4.4</span> Heroku コマンド</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/beginning.html#sec-beginning_conclusion"><span class="number">1.5</span> 最後に</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/a-demo-app.html#top"><span class="number">第2章</span>デモアプリケーション</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/a-demo-app.html#sec-planning_the_application"><span class="number">2.1</span> アプリの計画</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-modeling_demo_users"><span class="number">2.1.1</span>ユーザーのモデル設計</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-modeling_demo_microposts"><span class="number">2.1.2</span>マイクロポストのモデル設計</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/a-demo-app.html#sec-demo_users_resource"><span class="number">2.2</span>Users リソース </a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-a_user_tour"><span class="number">2.2.1</span>ユーザページを探検する</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-mvc_in_action"><span class="number">2.2.2</span> MVCの挙動</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-weaknesses_of_this_users_resource"><span class="number">2.2.3</span>Users リソースの欠点</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/a-demo-app.html#sec-microposts_resource"><span class="number">2.3</span>Mircroposts リソース</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-a_micropost_microtour"><span class="number">2.3.1</span>マイクロポストのページを探検する</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-putting_the_micro_in_microposts"><span class="number">2.3.2</span>マイクロポストを<em>マイクロ</em>にする</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-demo_user_has_many_microposts"><span class="number">2.3.3</span>ユーザーとマイクロポストを<tt>has_many</tt>で関連づける</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-inheritance_hierarchies"><span class="number">2.3.4</span>継承の階層</a></li><li class="subsection"><a href="http://railstutorial.jp/a-demo-app.html#sec-deploying_the_demo_app"><span class="number">2.3.5</span>デモアプリケーションの展開</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/a-demo-app.html#sec-2_4"><span class="number">2.4</span>最後に</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/static-pages.html#top"><span class="number">第3章</span>ほぼ静的なページの作成</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-static_pages"><span class="number">3.1</span>静的ページ</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-truly_static_pages"><span class="number">3.1.1</span>「本当に」静的なページ</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-static_pages_with_rails"><span class="number">3.1.2</span>Railsによる静的なページ</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-first_tests"><span class="number">3.2</span>最初のテスト</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-TDD"><span class="number">3.2.1</span>テスト駆動開発</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-adding_a_page"><span class="number">3.2.2</span>ページの追加</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-red">赤 (Red)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-green">緑 (Green)</a></li><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-refactor">リファクタリング</a></li></ol></li></ol></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-slightly_dynamic_pages"><span class="number">3.3</span>ちょっとだけ動的ページ</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-testing_a_title_change"><span class="number">3.3.1</span>タイトル変更をテストする</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-passing_title_tests"><span class="number">3.3.2</span>タイトルのテストをパスさせる</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-embedded_ruby"><span class="number">3.3.3</span>組込みRuby</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-layouts"><span class="number">3.3.4</span>レイアウトを使って重複を解消する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-static_pages_conclusion"><span class="number">3.4</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-static_pages_exercises"><span class="number">3.5</span>演習</a></li><li class="section"><a href="http://railstutorial.jp/static-pages.html#sec-advanced_setup"><span class="number">3.6</span>高度なセットアップ</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-eliminating_bundle_exec"><span class="number">3.6.1</span><tt>bundle exec</tt>を追放する</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-rvm_bundler_integration">RVM Bundler の統合</a></li><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-binstubs">binstubオプション</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-guard"><span class="number">3.6.2</span>Guardによるテストの自動化</a></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-spork"><span class="number">3.6.3</span>Spork を使ったテストの高速化</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/static-pages.html#sec-spork_and_guard">GuardにSporkを導入する</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/static-pages.html#sec-tests_inside_sublime_text"><span class="number">3.6.4</span>Sublime Text上でテストする</a></li></ol></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/rails-flavored-ruby.html#top"><span class="number">第4章</span> Rails風味のRuby</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-motivation"><span class="number">4.1</span>動機</a></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-strings_and_methods"><span class="number">4.2</span>文字列(string)とメソッド</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-comments"><span class="number">4.2.1</span>コメント</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-strings"><span class="number">4.2.2</span>文字列</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-printing">出力</a></li><li class="subsubsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-single_quoted_strings">シングルクォート内の文字列</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-objects_and_message_passing"><span class="number">4.2.3</span>オブジェクトとメッセージ受け渡し</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-method_definitions"><span class="number">4.2.4</span>メソッドの定義</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-back_to_the_title_helper"><span class="number">4.2.5</span> title ヘルパー、再び</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-other_data_structures"><span class="number">4.3</span>他のデータ構造</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-arrays_and_ranges"><span class="number">4.3.1</span>配列と範囲演算子</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-blocks"><span class="number">4.3.2</span>ブロック</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-hashes_and_symbols"><span class="number">4.3.3</span>ハッシュとシンボル</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-css_revisited"><span class="number">4.3.4</span> CSS、再び</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-ruby_classes"><span class="number">4.4</span> Ruby におけるクラス</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-constructors"><span class="number">4.4.1</span>コンストラクタ</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_class_of_our_own"><span class="number">4.4.2</span>クラス継承</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-modifying_built_in_classes"><span class="number">4.4.3</span>組込みクラスの変更</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_controller_class"><span class="number">4.4.4</span>コントローラクラス</a></li><li class="subsection"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-a_user_class"><span class="number">4.4.5</span>ユーザークラス</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-conclusion"><span class="number">4.5</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/rails-flavored-ruby.html#sec-exercises"><span class="number">4.6</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/filling-in-the-layout.html#top"><span class="number">第5章</span>レイアウトを作成する</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-structure"><span class="number">5.1</span>構造を追加する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-adding_to_the_layout"><span class="number">5.1.1</span>ナビゲーション</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-custom_css"><span class="number">5.1.2</span>BootstrapとカスタムCSS</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-partials"><span class="number">5.1.3</span>パーシャル (partial)</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-sass_and_the_asset_pipeline"><span class="number">5.2</span>Sass と asset pipleline</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-the_asset_pipeline"><span class="number">5.2.1</span> asset pipeline</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_1_1">asset ディレクトリ</a></li><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_1_2">マニフェストファイル</a></li><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_1_3">プリプロセッサエンジン</a></li><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_1_4">プロダクション環境での効率性</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-sass"><span class="number">5.2.2</span>素晴らしい構文を備えたスタイルシート</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_2_1">ネスト</a></li><li class="subsubsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-5_2_2_2">変数</a></li></ol></li></ol></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-layout_links"><span class="number">5.3</span>レイアウトのリンク</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-route_tests"><span class="number">5.3.1</span> ルートのテスト</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-rails_routes"><span class="number">5.3.2</span> Railsのルート</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-named_routes"><span class="number">5.3.3</span>名前付きルート</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-pretty_rspec"><span class="number">5.3.4</span>Pretty RSpec</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-user_signup"><span class="number">5.4</span>ユーザーのサインアップ：最初のステップ</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-users_controller"><span class="number">5.4.1</span>ユーザーコントローラ</a></li><li class="subsection"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-signup_url"><span class="number">5.4.2</span>サインアップURI</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-layout_conclusion"><span class="number">5.5</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/filling-in-the-layout.html#sec-layout_exercises"><span class="number">5.6</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/modeling-users.html#top"><span class="number">第6章</span>ユーザーのモデルを作成する</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-user_model"><span class="number">6.1</span> Userモデル</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-database_migrations"><span class="number">6.1.1</span>データベースの移行</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-the_model_file"><span class="number">6.1.2</span>modelファイル</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/modeling-users.html#sec-model_annotation">モデル注釈</a></li><li class="subsubsection"><a href="http://railstutorial.jp/modeling-users.html#sec-accessible_attributes">アクセス可能な属性</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-creating_user_objects"><span class="number">6.1.3</span>ユーザーオブジェクトを作成する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-finding_user_objects"><span class="number">6.1.4</span>ユーザーオブジェクトを検索する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-updating_user_objects"><span class="number">6.1.5</span>ユーザーオブジェクトを更新する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-user_validations"><span class="number">6.2</span>ユーザーを検証する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-initial_user_tests"><span class="number">6.2.1</span>最初のユーザーテスト</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-presence_validation"><span class="number">6.2.2</span>プレゼンスを検証する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-length_validation"><span class="number">6.2.3</span>長さを検証する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-format_validation"><span class="number">6.2.4</span>フォーマットを検証する</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-uniqueness_validation"><span class="number">6.2.5</span>一意性を検証する</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/modeling-users.html#sec-the_caveat">一意性の警告</a></li></ol></li></ol></li><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-adding_a_secure_password"><span class="number">6.3</span>セキュアなパスワードを追加する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-an_encrypted_password"><span class="number">6.3.1</span>暗号化されたパスワード</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-password_and_confirmation"><span class="number">6.3.2</span>パスワードと確認</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-user_authentication"><span class="number">6.3.3</span>ユーザー認証</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-has_secure_password"><span class="number">6.3.4</span>ユーザーがセキュアなパスワードを持っている</a></li><li class="subsection"><a href="http://railstutorial.jp/modeling-users.html#sec-creating_a_user"><span class="number">6.3.5</span>ユーザーを作成する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-6_4"><span class="number">6.4</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/modeling-users.html#sec-6_5"><span class="number">6.5</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/sign-up.html#top"><span class="number">第7章</span>ユーザー登録</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-showing_users"><span class="number">7.1</span>ユーザーを表示する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-rails_environments"><span class="number">7.1.1</span>デバッグとRails環境</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-a_users_resource"><span class="number">7.1.2</span>ユーザーリソース</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-tests_with_factories"><span class="number">7.1.3</span>ファクトリーを使用してユーザー表示ページをテストする</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-a_gravatar_image"><span class="number">7.1.4</span>gravatar画像とサイドバー</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-signup_form"><span class="number">7.2</span>ユーザー登録フォーム</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-tests_for_user_signup"><span class="number">7.2.1</span>ユーザー登録のためのテスト</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-using_form_for"><span class="number">7.2.2</span><tt>form_for</tt>を使用する</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-the_form_html"><span class="number">7.2.3</span>フォームHTML</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-signup_failure"><span class="number">7.3</span>ユーザー登録失敗</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-a_working_form"><span class="number">7.3.1</span>正しいフォーム</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-signup_error_messages"><span class="number">7.3.2</span>ユーザー登録のエラーメッセージ</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-signup_success"><span class="number">7.4</span>ユーザー登録成功</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-the_finished_signup_form"><span class="number">7.4.1</span>登録フォームの完成</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-the_flash"><span class="number">7.4.2</span>flash</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-the_first_signup"><span class="number">7.4.3</span>実際のユーザー登録</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-up.html#sec-deploying_to_production_with_ssl"><span class="number">7.4.4</span> SSLを導入してプロダクション環境を展開する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-7_5"><span class="number">7.5</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/sign-up.html#sec-signup_exercises"><span class="number">7.6</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/sign-in-sign-out.html#top"><span class="number">第8章</span>サインイン、サインアウト</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_failure"><span class="number">8.1</span>セッション、サインインの失敗</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-sessions_controller"><span class="number">8.1.1</span>Sessionコントローラ</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_tests"><span class="number">8.1.2</span>サインインをテストする</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_form"><span class="number">8.1.3</span>サインインのフォーム</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-reviewing_form_submission"><span class="number">8.1.4</span>確認フォームを送信する</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-rendering_with_a_flash_message"><span class="number">8.1.5</span>フラッシュメッセージをレンダリングする</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_success"><span class="number">8.2、</span>サインイン成功</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-remember_me"><span class="number">8.2.1</span>[このアカウント設定を保存する]</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-a_working_sign_in_method"><span class="number">8.2.2</span>正しい<tt>sign_in</tt>メソッド</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-current_user"><span class="number">8.2.3</span>現在のユーザー</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-changing_the_layout_links"><span class="number">8.2.4</span>レイアウトリンクを変更する</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_upon_signup"><span class="number">8.2.5</span>ユーザー登録と同時にサインインする</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-signing_out"><span class="number">8.2.6</span>サインアウトする</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-cucumber"><span class="number">8.3</span>Cucumberの紹介(オプション)</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-installation_and_setup"><span class="number">8.3.1</span>インストールと設定</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-features_and_steps"><span class="number">8.3.2</span>機能と手順</a></li><li class="subsection"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-rspec_custom_matchers"><span class="number">8.3.3</span>対比: RSpecのカスタムマッチャー</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-8_4"><span class="number">8.4</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/sign-in-sign-out.html#sec-sign_in_out_exercises"><span class="number">8.5</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#top"><span class="number">第9章</span> ユーザーの更新・表示・削除</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-updating_users"><span class="number">9.1</span>ユーザーを更新する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-edit_form"><span class="number">9.1.1</span>編集フォーム</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-unsuccessful_edits"><span class="number">9.1.2</span>編集の失敗</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-successful_edits"><span class="number">9.1.3</span>編集の成功</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-authorization"><span class="number">9.2</span>認証</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-requiring_signed_in_users"><span class="number">9.2.1</span>ユーザーのサインインを要求する</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-requiring_the_right_user"><span class="number">9.2.2</span>正しいユーザーを要求する</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-friendly_forwarding"><span class="number">9.2.3</span>フレンドリーフォワーディング</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-showing_all_users"><span class="number">9.3</span>すべてのユーザーを表示する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-user_index"><span class="number">9.3.1</span>ユーザーインデックス</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-sample_users"><span class="number">9.3.2</span>サンプルのユーザー</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-pagination"><span class="number">9.3.3</span>ページネーション</a></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-partial_refactoring"><span class="number">9.3.4</span>部分的リファクタリング</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-destroying_users"><span class="number">9.4</span>ユーザを削除する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-administrative_users"><span class="number">9.4.1</span>管理ユーザー</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-revisiting_attr_accessible"><tt>attr_accessible</tt>属性再び</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-the_destroy_action"><span class="number">9.4.2</span> <tt>destroy</tt>アクション</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-updating_and_deleting_users_conclusion"><span class="number">9.5</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-updating_deleting_exercises"><span class="number">9.6</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/user-microposts.html#top"><span class="number">第10章</span>ユーザーのマイクロポスト</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-a_micropost_model"><span class="number">10.1</span>Micropostモデル</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-the_basic_model"><span class="number">10.1.1</span>基本的なモデル</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-accessible_attribute"><span class="number">10.1.2</span>Accessible属性と最初の検証</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-user_micropost_associations"><span class="number">10.1.3</span>User/Micropostの関連付け</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-ordering_and_dependency"><span class="number">10.1.4</span>マイクロポストを改良する</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/user-microposts.html#sec-default_scope">デフォルトのスコープ</a></li><li class="subsubsection"><a href="http://railstutorial.jp/user-microposts.html#sec-dependent_destroy">Dependent: destroy</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-micropost_validations"><span class="number">10.1.5</span>コンテンツの検証</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-showing_microposts"><span class="number">10.2</span>マイクロポストを表示する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-augmenting_the_user_show_page"><span class="number">10.2.1</span>ユーザー表示ページの拡張</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-sample_microposts"><span class="number">10.2.2</span>マイクロポストのサンプル</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-manipulating_microposts"><span class="number">10.3</span>マイクロポストを操作する</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-access_control"><span class="number">10.3.1</span>アクセス制御</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-creating_microposts"><span class="number">10.3.2</span>マイクロポストを作成する</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-a_proto_feed"><span class="number">10.3.3</span>フィードの原型</a></li><li class="subsection"><a href="http://railstutorial.jp/user-microposts.html#sec-destroying_microposts"><span class="number">10.3.4</span>マイクロポストを削除する</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-10_4"><span class="number">10.4</span>最後に</a></li><li class="section"><a href="http://railstutorial.jp/user-microposts.html#sec-micropost_exercises"><span class="number">10.5</span>演習</a></li></ol></li><li class="chapter"><a href="http://railstutorial.jp/following-users.html#top"><span class="number">第11章</span>ユーザーをフォローする</a></li><li><ol><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-the_relationship_model"><span class="number">11.1</span>Relationshipのモデル</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-a_problem_with_the_data_model"><span class="number">11.1.1</span>データモデルの問題 (および解決策)</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-relationship_user_associations"><span class="number">11.1.2</span>User/relationshipの関連付け</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-relationship_validations"><span class="number">11.1.3</span>検証</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-following"><span class="number">11.1.4</span>フォローしているユーザー</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-followers"><span class="number">11.1.5</span>フォローされているユーザー</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-a_web_interface_for_following_and_followers"><span class="number">11.2</span>フォローしているユーザー用のWebインターフェイス</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-sample_following_data"><span class="number">11.2.1</span>フォローしているユーザーのサンプルデータ</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-stats_and_a_follow_form"><span class="number">11.2.2</span>統計とフォロー用フォーム</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-following_and_followers_pages"><span class="number">11.2.3</span>「フォローしている」と「フォローされている」のページ</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-a_working_follow_button_the_standard_way"><span class="number">11.2.4</span>[フォローする] ボタン (標準的な方法)</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-a_working_follow_button_with_ajax"><span class="number">11.2.5</span>[フォローする] ボタン (Ajax)</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-the_status_feed"><span class="number">11.3</span>ステータスフィード</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-motivation_and_strategy"><span class="number">11.3.1</span>動機と計画</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-a_first_feed_implementation"><span class="number">11.3.2</span>フィードを初めて実装する</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-scopes_subselects_and_a_lambda"><span class="number">11.3.3</span>サブセレクト</a></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-the_new_status_feed"><span class="number">11.3.4</span>新しいステータスフィード</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-following_conclusion"><span class="number">11.4</span>最後に</a></li><li><ol><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-extensions_to_the_sample_application"><span class="number">11.4.1</span>サンプルアプリケーションの機能を拡張する</a></li><li><ol><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-replies">返信機能</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-messaging">メッセージ機能</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-follower_notifications">フォロワーの通知</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-password_reminders">パスワードリマインダー</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-signup_confirmation">ユーザー登録の確認</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-rss_feed">RSSフィード</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-rest_api">REST API</a></li><li class="subsubsection"><a href="http://railstutorial.jp/following-users.html#sec-search">検索機能</a></li></ol></li><li class="subsection"><a href="http://railstutorial.jp/following-users.html#sec-guide_to_further_resources"><span class="number">11.4.2</span>読み物ガイド</a></li></ol></li><li class="section"><a href="http://railstutorial.jp/following-users.html#sec-following_exercises"><span class="number">11.5</span>演習</a></li></ol></li></ol></div>


<div id="main_content"></div>


<p> <span class="preamble">
</span><span class="preamble"> <span id="foreword">
</span></span><span class="preamble"><span id="foreword"><strong>前書き</strong> </span></span><br /><span class="preamble"><span id="foreword">
</span></span><span class="preamble"><span id="foreword"> </span>
</span><span class="preamble"> </span></p>

<p>私が前にいた会社 (CD Baby) は、かなり早い段階でRuby on Railsに乗り換えたのですが、またPHPに戻ってしまいました (詳細は私の名前をGoogleで検索してみて下さい)。Michael Hartl氏が書いたこの本を強く勧められ、これはやってみなければ、と試した結果、私が再びRailsに乗り換えるに至ったのがこの<em>Ruby on Railsチュートリアル</em>です。</p>

<p>私は多数のRails本を参考にしてきましたが、真の決定版と呼べるものは本書をおいて他にありません。本書ではあらゆる手順が文字通りRails流 (“Rails way”は railway にかけている) で行われており、最初はなかなか慣れませんでしたが、この本を終えた今、ついにこれこそが自然な方式だと感じられるまでになりました。また、本書はRails本の中で唯一、多くのプロが推奨するテスト駆動開発 (TDD: Test Driven Development) 方式を全編を通して実践していて、非常に分かりやすく解説されています。極めつけは、Git、GitHub、そしてHerokuまでも実例に含めた事で、チュートリアルのコード例など実際のプロジェクトの開発プロセスまでも体験できるようになっていることです。チュートリアルのコード例は、どれもチュートリアルと見事に一体化しています。</p>

<p>本書は全体が筋道だったストーリーに貫かれており、非常に素晴らしいものです。私自身、3日間かけて章の終わりにある練習問題もやりながら<em>Railsチュートリアル</em>を一気に読破しました。最初から最後まで、途中を飛ばさずにやるのが一番効果的で有益な読み方です。ぜひやってみて下さい。</p>

<p>是非お試しください。</p>

<p>デレック・シバーズ (<a href="http://sivers.org/">Derek Sivers</a>) (<a href="http://sivers.org/">sivers.org</a>)<br />
<em>元: <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> (創始者)</em> <br />
<em>現在: <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> (創始者) </em> <br /></p>

<p> <span class="preamble">
</span><span class="preamble"><strong>謝辞</strong> </span><br /><span class="preamble">
</span><span class="preamble"> </span></p>

<p><em>Ruby on Rails チュートリアル</em>は、私の以前の著書<em>RailsSpace</em>と、その時の共著者の<a href="http://aure.com/">Aurelius Prochazka</a>に多くを負っています。Aureには、RailsSpaceでの協力と本書への支援も含め、感謝したいと思います。また、<em>RailsSpace</em>と<em>Rails チュートリアル</em>両方の編集を担当して頂いたDebra Williams Cauley氏にも謝意を表したく思います。</p>

<p>私にインスピレーションと知識を与えてくれたRubyistの方々にも感謝したいと思います:David Heinemeier Hansson、 Yehuda Katz、 Carl Lerche、 Jeremy Kemper、 Xavier Noria、 Ryan Bates、 Geoffrey Grosenbach、 Peter Cooper、 Matt Aimonetti、 Gregg Pollack、 Wayne E. Seguin、 Amy Hoy、 Dave Chelimsky、 Pat Maddox、 Tom Preston-Werner、 Chris Wanstrath、 Chad Fowler、 Josh Susser、 Obie Fernandez、 Ian McFarland、 Steven Bristol、 Pratik Naik、 Sarah Mei、 Sarah Allen、 Wolfram Arnold、 Alex Chaffee、 Giles Bowkett、 Evan Dorn、 Long Nguyen、 James Lindenbaum、 Adam Wiggins、 Tikhon Bernstam、 Ron Evans、 Wyatt Greene、 Miles Forrest、 Pivotal Labsの方々、 Herokuの方々、 thoughtbotの方々、 そしてGitHubチーム。最後に、ここに書ききれないほど多くの読者の方々から執筆中にバグ報告や提案を頂き、本書をできる限り良いものにするのに大変役立ちました。<br /></p>

<p> <span class="preamble">
</span><span class="preamble"> <span id="author">
</span></span><span class="preamble"><span id="author"><strong>著者</strong> </span></span><br /><span class="preamble"><span id="author">
</span></span><span class="preamble"><span id="author"> </span>
</span><span class="preamble"> </span></p>

<p><a href="http://michaelhartl.com/">マイケル・ハートル (Michael Hartl)</a> は、<a href="http://ruby.railstutorial.org/"><em>Ruby on Rails</em></a>を使用したweb開発を手ほどきする教材として有名な<a href="http://rubyonrails.org/">Ruby on Rails チュートリアル</a>の著者です。(今ではすっかり古くなってしまいましたが) Railsのチュートリアル本である<em>RailsSpace</em>の著述と開発に携わったことがあり、 一時人気を博したRuby on RailsベースのソーシャルネットワーキングプラットフォームInsoshiも開発していました。2011年、マイケルはRailsコミュニティへの貢献が認められて<a href="http://rubyheroes.com/heroes">Ruby Hero Award</a>を受賞しました。<a href="http://college.harvard.edu/">ハーバード大学</a>卒業後 、<a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">カリフォルニア工科大学</a>で<a href="http://www.caltech.edu/">物理学博士号</a>を取得し、起業プログラム<a href="http://ycombinator.com/">Y Combinator</a>の卒業生でもあります。<br /></p>

<p> <span id="license" class="preamble">
</span><span id="license" class="preamble"><strong>著作権とライセンス</strong> </span><br /><span id="license" class="preamble">
</span><span id="license" class="preamble"> </span></p>

<p><em>Ruby on Rails チュートリアル: 実例を使ってRailsを学ぼう</em>Copyright © 2010 by Michael Hartl.<em>Ruby on Rails チュートリアル</em>内のすべてのソースコードは<a href="http://www.opensource.org/licenses/mit-license.php">MITライセンス</a>および<a href="http://people.freebsd.org/~phk/">Beerwareライセンス</a> の元で提供されています。</p>

<div class="code"><div class="highlight"><pre>(The MIT License)
Copyright (c) 2012 Michael Hartl
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</br>FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHERLIABILITY, </br>WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISINGOUT OF OR </br>IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS INTHE SOFTWARE.</pre></div>
</div>


<div class="code"><div class="highlight"><pre>/*
 * ----------------------------------------------------------------------------
 * &quot;THE BEER-WARE LICENSE&quot; (Revision 42):
 * Michael Hartl wrote this code.As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return.
 * ----------------------------------------------------------------------------
 */
</pre></div>
</div>


<div id="top"></div>


<h1 class="chapter"><a id="sec-10" href="http://railstutorial.jp/user-microposts.html#top" class="heading"><span class="number">第10章</span>ユーザーのマイクロポスト</a></h1>


<p><a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#top">第9章</a>ではユーザーリソース用のRESTアクションを完成させました。次は<a class="ref" href="http://railstutorial.jp/a-demo-app.html#top">第2章</a>で見た、特定のユーザに関連付けられたショートメッセージを表現する、ユーザーの<em>マイクロポスト</em><sup class="footnote" id="fnref-10_1"><a href="http://railstutorial.jp/user-microposts.html#fn-10_1">1</a></sup> リソースを追加します。この章では、<a class="ref" href="http://railstutorial.jp/a-demo-app.html#sec-microposts_resource">2.3</a>で記述したマイクロポストデータモデルを作成し、ユーザー モデルと<code>has_many</code>および<code>belongs_to</code>メソッドを使って関連づけ、さらに、結果を処理し表示するために必要なフォームとその部品を作成します。 <a class="ref" href="http://railstutorial.jp/following-users.html#top">第11章</a>では、マイクロポストの<em>フィード</em>を受け取るために、ユーザーを<em>フォロー</em>するという概念を導入し、Twitterのミニクローンを完成させます。</p>

<p>Git をバージョン管理に使っている場合は、いつものようにトピックブランチを作成しておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b user-microposts
</pre></div>
</div>




<div class="label" id="sec-a_micropost_model"></div>


<h2><a id="sec-10_1" href="http://railstutorial.jp/user-microposts.html#sec-a_micropost_model" class="heading"><span class="number">10.1</span>Micropostモデル</a></h2>


<p>まずはMicropostリソースの最も本質的な部分を表現するMicropostモデルを作成するところから始めましょう。<a class="ref" href="http://railstutorial.jp/a-demo-app.html#sec-microposts_resource">2.3</a>で作成したモデルと同様に、この新しいMicropostモデルもデータ検証とUserモデルの関連付けを含んでいます。以前のモデルとは違って、今回のマイクロポストモデルは完全にテストされ、デフォルトの<em>順序</em>を持ち、また親であるユーザーが破棄された場合には自動的に<em>破棄</em>されるようにします。</p>

<div class="label" id="sec-the_basic_model"></div>


<h3><a id="sec-10_1_1" href="http://railstutorial.jp/user-microposts.html#sec-the_basic_model" class="heading"><span class="number">10.1.1</span>基本的なモデル</a></h3>


<p>Micropostモデルはマイクロポストの内容を保存する<code>content</code><sup class="footnote" id="fnref-10_2"><a href="http://railstutorial.jp/user-microposts.html#fn-10_2">2</a></sup>属性と特定のユーザとマイクロポストを関連付ける<code>user_id</code>属性の2つの属性だけを持ちます。ユーザーモデルの場合と同様に(リスト <a class="ref" href="http://railstutorial.jp/modeling-users.html#code-generate_user_model">6.1</a>)、<code>generate model</code>コマンドを使って生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Micropost content:string user_id:integer
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#code-users_migration">リスト6.2</a>でデータベースに<code>users</code>テーブルを作るマイグレーションファイルを生成した時と同様に、このコマンドは <code>microposts</code>テーブルを作成するためのマイグレーションファイルを生成します (<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_migration">リスト10.1</a>)。</p>

<div class="label" id="code-micropost_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.1</span> <span class="description">Micropostマイグレーション</span><span class="description">(<code>user_id</code>と<code>created_at</code>にインデックスが与えられていることに注意) </span><br /><span class="description"> <code>db/migrate/[timestamp]_create_microposts.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここで、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_migration">リスト10.1</a>では<code>user_id</code>と<code>created_at</code>カラムにインデックスが付与されていることにご注目ください (<a class="ref" href="http://railstutorial.jp/modeling-users.html#sidebar-database_indices">囲み 6.2</a>)。user idに関連付けられたすべてのマイクロポストを作成時刻の逆順で取り出すためです。</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</pre></div>
</div>


<p><code>user_id</code>と<code>created_at</code>両方のカラムを1つの配列に含めることで、Active Recordで<em>両方</em>のキーを同時に使用する<em>複合キーインデックス</em>を作成できます。また<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-database_migrations">6.1.1</a>でも述べたように、<code>t.timestamps</code>の行によって<code>created_at</code>カラムと<code>updated_at</code>カラムが作成されていることにもご注目ください。この後、<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-ordering_and_dependency">10.1.4</a>および<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-augmenting_the_user_show_page">10.2.1</a>で<code>created_at</code>カラムをさらに追加します。</p>

<p>それではユーザーモデルの場合 (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-user_spec">リスト6.8</a>) と同様に、マイクロポストデルに対する最小限のテストを書くところから始めましょう。具体的には <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-initial_micropost_spec">リスト10.2</a> に示すように、micropostオブジェクトが <code>content</code>属性と<code>user_id</code>属性を持っていることを確認するテストを作成します。</p>

<div class="label" id="code-initial_micropost_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.2</span> <span class="description">最初のMicropost spec。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># 以下のコードは誤り</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Micropost マイグレーションを実行し、テストデータベースを準備することで、これらのテストをパスさせることができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>実行した結果のMicropostモデルの構造は<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-micropost_model">図10.1</a>のようになります。</p>

<div class="label" id="fig-micropost_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/micropost_model.png" alt="micropost_model" /></span></div><div class="caption"><span class="header">図10.1</span><span class="description">Micropostデータモデル</span></div></div>


<p>テストにパスすることを確認してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/micropost_spec.rb
</pre></div>
</div>


<p>テストにパスしたとしても、コードの中にある以下のコメントに気付いた方もいると思います。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># 以下のコードは誤り</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このコメントは <code>before</code> ブロックのコードが間違っていることを指摘しています。その理由を考えてみてください。<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-user_micropost_associations">10.1.3</a>で解答を確認できます。</p>

<div class="label" id="sec-accessible_attribute"></div>


<h3><a id="sec-10_1_2" href="http://railstutorial.jp/user-microposts.html#sec-accessible_attribute" class="heading"><span class="number">10.1.2</span>Accessible属性と最初の検証</a></h3>


<p>上の解答を見る前に、<code>before</code>ブロックのコードが誤っている理由を確認するために、まずMicropostモデルに対する検証 (validation) テストを作成してみましょう (<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_validity_test">リスト10.3</a>) (<a class="ref" href="http://railstutorial.jp/modeling-users.html#code-failing_validates_name_spec">リスト 6.11</a>でのUserモデルのテストと比較してみてください)。</p>

<div class="label" id="code-micropost_validity_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.3</span> <span class="description">新しいマイクロポストに対する検証のテスト</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is wrong!</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このコードはマイクロポストが有効であり、かつ<code>user_id</code>属性が存在していることをテストしています。<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_user_id_validation">リスト10.4</a> に示すような簡単な存在検証によって、このテストはパスします。</p>

<div class="label" id="code-micropost_user_id_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.4</span> <span class="description">マイクロポストの<code>user_id</code>に対する検証。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:user_id</span>  
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これで、以下のコードが誤っている理由を見つけるための準備が整いました。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>


<p>問題となっているのは、デフォルト (Rails 3.2.3の場合) でMicropostモデルの<em>すべて</em>の属性がアクセス可能になっていることです。<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-accessible_attributes">6.1.2.2</a>と<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-revisiting_attr_accessible">9.4.1.1</a>で述べたように、これは、コマンドラインのクライアントを使って悪意のあるリクエストを発行することで、誰でもマイクロポストオブジェクトのあらゆる属性を改変できることを意味します。たとえば、悪意のあるユーザがマイクロポストの<code>user_id</code>属性を改変し、別のユーザにマイクロポストを関連づける事も可能です。つまり、<code>user_id</code>は<code>attr_accessible</code>リストから削除されるべきであり、またそうすることにより上記のコードはテストに失敗します。この問題は<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-user_micropost_associations">10.1.3</a>で修正します。</p>

<div class="label" id="sec-user_micropost_associations"></div>


<h3><a id="sec-10_1_3" href="http://railstutorial.jp/user-microposts.html#sec-user_micropost_associations" class="heading"><span class="number">10.1.3</span>User/Micropostの関連付け</a></h3>


<p>Webアプリケーション用のデータモデルを構築するにあたって、個々のモデル間での<em>関連づけ</em>を十分考えておくことが重要です。今回の場合は、 <a class="ref" href="http://railstutorial.jp/a-demo-app.html#sec-demo_user_has_many_microposts">2.3.3</a>でも示したように、それぞれのマイクロポストは１人のユーザと関連付けられ、それぞれのユーザは (潜在的に) 複数のマイクロポストと関連付けられます。この関連付けを<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-micropost_belongs_to_user">図10.2</a>と<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-user_has_many_microposts">図 0.3</a>に示します。それらの関連を実装するにあたって、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-initial_micropost_spec">リスト10.2</a>のようにではなく、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_accessible_attribute">リスト10.7</a>のように<code>attr_accessible</code>を利用してMicropostモデルのテストを作成します。</p>

<div class="label" id="fig-micropost_belongs_to_user"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/micropost_belongs_to_user.png" alt="micropost_belongs_to_user" /></span></div><div class="caption"><span class="header">図10.2</span><span class="description">micropost と user</span>間の<code>belongs_to</code>リレーションシップ</div></div>




<div class="label" id="fig-user_has_many_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/user_has_many_microposts.png" alt="user_has_many_microposts" /></span></div><div class="caption"><span class="header">図10.3</span><span class="description">userとmicropost</span>間の<code>has_many</code>リレーションシップ</div></div>


<p>このセクションで定義した<code>belongs_to</code>/<code>has_many</code>関連付けを使用することで、<a class="ref" href="http://railstutorial.jp/user-microposts.html#table-association_methods">表10.1</a>に示すようなメソッドをRailsで使えるようになります。</p>

<div class="label" id="table-association_methods"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>メソッド</strong></th><th class="align_left"><strong>目的</strong></th></tr><tr class="top_bar"><td class="align_left"><code>micropost.user</code></td><td class="align_left">マイクロポストに関連付けられたユーザーオブジェクトを返す。</td></tr><tr><td class="align_left"><code>user.microposts</code></td><td class="align_left">ユーザのマイクロポストの配列を返す。</td></tr><tr><td class="align_left"><code>user.microposts.create(arg)</code></td><td class="align_left">マイクロポストを作成する (<code>user_id = user.id</code>)。</td></tr><tr><td class="align_left"><code>user.microposts.create!(arg)</code></td><td class="align_left">マイクロポストを作成する (失敗した場合は例外を発生する)。</td></tr><tr><td class="align_left"><code>user.microposts.build(arg)</code></td><td class="align_left">新しいMicropostオブジェクトを返す (<code>user_id = user.id</code>)。</td></tr></table></div><div class="caption"><span class="header">表10.1</span><span class="description">user/micropost関連メソッドのまとめ</span></div></div>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#table-association_methods">表10.1</a>では、以下のメソッドではなく</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">create</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>


<p>以下のメソッドになっていることにご注意ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>このパターンは、user オブジェクトの関連付けを<em>経由して</em>マイクロポストを作成する標準的な方法です。新規のマイクロポストがこの方法で作成される場合、<code>user_id</code>は<em>自動的</em>に正しい値に設定され、 <a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-accessible_attribute">10.1.2</a>で述べたような問題を解決してくれます。特に、以下のような</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># 以下のコードは誤り</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_validity_test">リスト10.3</a>のコードを、以下のコードと置き換えることができるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>一度正しい関連付けを定義してしまえば、<code>@micropost</code>変数の<code>user_id</code>には、関連するユーザのidが自動的に設定されます。</p>

<p>マイクロポストをユーザと関連付けて構築できても、<code>user_id</code>にアクセスできてしまうというセキュリティ上の問題は解決されません。これはセキュリティ上の重要な懸念事項であるため、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-attr_accessible_user_id_test">リスト10.5</a>に示すように失敗するテストを記述します。</p>

<div class="label" id="code-attr_accessible_user_id_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.5</span> <span class="description"><code>user_id</code>がアクセス不能であることを確認するテスト。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;accessible attributes&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should not allow access to user_id&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストは、空ではない<code>user_id</code>を使用して<code>Micropost.new</code>を呼ぶと、mass assignment security error例外が発生することを確認しています。この挙動はRails 3.2.3ではデフォルトですが、以前のバージョンではオフにされているため、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-application_whitelist">リスト10.6</a>で示すように自分のアプリケーションが正しく設定されているかどうかを確認してください。</p>

<div class="label" id="code-application_whitelist"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.6</span> <span class="description">Railsがinvalid mass assignmentエラーを発生するようにする設定。</span><br /><span class="description"> <code>config/application.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails::Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">whitelist_attributes</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Micropostモデルの場合は、 Web経由で編集されてもよい属性は<code>content</code>属性<em>のみ</em>であるため、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_accessible_attribute">リスト10.7</a>で示すように<code>:user_id</code>をアクセス可能リストから取り除く必要があります。</p>

<div class="label" id="code-micropost_accessible_attribute"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.7</span> <span class="description"><code>content</code>属性を (そして<code>content</code>属性<em>のみ</em>を) アクセス可能にする。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#table-association_methods">表10.1</a>に示したように、ユーザーとマイクロポストの関連付けの結果には、単にマイクロポストのユーザを返す<code>micropost.user</code>メソッドもあり、これもテストが必要です。このメソッドは、<code>it</code>と<code>its</code>メソッドを以下のように使うことでテストできます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">user</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のコードを反映したMicropostモデルのテストを<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_belongs_to_user_spec">リスト10.8</a>に示します。</p>

<div class="label" id="code-micropost_belongs_to_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.8</span> <span class="description">マイクロポストのユーザとの関連付けのテスト。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;accessible attributes&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should not allow access to user_id&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Userモデル側の関連付けに対する詳細なテストは<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-ordering_and_dependency">10.1.4</a>まで保留することにし、今は単に<code>microposts</code>属性の存在をテストするだけにしておきます (<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_has_many_microposts_spec">リスト10.9</a>)。</p>

<div class="label" id="code-user_has_many_microposts_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.9</span> <span class="description">ユーザの<code>microposts</code>属性に対するテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>関連付けを実装する最終的なコードは、テストコードの長さと比べるとあっけないほど短いものになります。<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_belongs_to_user_spec">リスト10.8</a>と<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_has_many_microposts_spec">リスト10.9</a>の両方のテストにパスするためには、<code>belongs_to :user</code> (<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_belongs_to_user">リスト10.10</a>) と <code>has_many :microposts</code> (<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_has_many_microposts">リスト10.11</a>) の2行を加えるだけで済みます。</p>

<div class="label" id="code-micropost_belongs_to_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.10</span> <span class="description">マイクロポストがユーザに所属する (<code>belongs_to</code>) 関連付け。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>  
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-user_has_many_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.11</span> <span class="description">ユーザがマイクロポストを複数所有する (<code>has_many</code>) 関連付け。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で、関連付けの基本的原則を理解するために、<a class="ref" href="http://railstutorial.jp/user-microposts.html#table-association_methods">表10.1</a>の項目と、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_belongs_to_user_spec">リスト10.8</a>および<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_has_many_microposts_spec">リスト10.9</a>のコードを見比べてみてください。テストにパスすることも確認しておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models
</pre></div>
</div>




<div class="label" id="sec-ordering_and_dependency"></div>


<h3><a id="sec-10_1_4" href="http://railstutorial.jp/user-microposts.html#sec-ordering_and_dependency" class="heading"><span class="number">10.1.4</span>マイクロポストを改良する</a></h3>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_has_many_microposts_spec">リスト10.9</a>の<code>has_many</code>関連付けのテストでは、<code>microposts</code>属性の<em>存在</em>をほとんど検証していないので、あまり意味がありませんでした。この章では、<em>順序</em>と<em>依存関係</em>をマイクロポストに追加し、<code>user.microposts</code>メソッドが実際にマイクロポストの配列を返すことをテストします。</p>

<p>Userモデルのテストのためにいくつかのマイクロポストを作成しておく必要がありますので、この時点でマイクロポストを生成するファクトリーを作成しておきましょう。そのためには、Factory Girlに関連付けを作成する方法を知っておく必要があります。幸い、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_factory">リスト10.12</a>に示したとおり、これは非常に簡単です。</p>

<div class="label" id="code-micropost_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.12</span> <span class="description">マイクロポスト作成用の新しいファクトリーを含む、完全なFactoryファイル。</span><br /><span class="description"> <code>spec/factories.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>   
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
    <span class="n">content</span> <span class="s2">&quot;Lorem ipsum&quot;</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここでは、以下のようにマイクロポスト用のファクトリーの定義にユーザを含めるだけで、マイクロポストに関連付けられるユーザーのことがFactory Girlに伝わります。</p>

<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
  <span class="n">content</span> <span class="s2">&quot;Lorem ipsum&quot;</span>
  <span class="n">user</span>
<span class="k">end</span>
</pre></div>
</div>


<p>次の節でもお見せしますが、これによって、以下のようにマイクロポスト用のファクトリーを定義できるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<div class="label" id="sec-default_scope"></div>


<h4><a id="sec-10_1_4_1" href="http://railstutorial.jp/user-microposts.html#sec-default_scope" class="heading">デフォルトのスコープ</a></h4>


<p>データベースからユーザのマイクロポストを読み出す<code>user.microposts</code>メソッドは、デフォルトでは読み出しの順序に対して何も保証しませんが、 ブログやTwitterの慣習に従って、作成時間の逆順、つまり最も新しいマイクロポストを最初に表示するようにしてみましょう。この順序をテストするために、次のようにマイクロポストをいくつか作成しておきます。</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
<span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<p>(<a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#sidebar-time_helpers">囲み8.1</a>で説明した時間指定用ヘルパーメソッドを使うことで) 2番目のポストの作成時刻がより新しく (<code>1時間前</code>)、最初のポストの作成日時が<code>1日前</code>になります。Factory Girlを使用すると、<code>attr_accessible</code>をバイパスすることによってマスアサインメントを使ってユーザーを設定することもできますし、Active Recordがアクセスを許可しないような<code>created_at</code>属性も手動で設定できるので大変便利です (<code>created_at</code>や<code>updated_at</code>などは通常のカラムと異なる “マジック”カラムであり、これらの作成タイムスタンプや更新タイムスタンプは自動的に設定されてしまうため、明示的に値を設定しても上書きされてしまうことを思い出してください)。</p>

<p>(SQLiteを含む) ほとんどのデータベースアダプターは、マイクロポストを id順で返すため、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_ordering_test">リスト 10.13</a>のようなテストはほぼ確実に失敗することになります。このコードでは<code>let</code>メソッドの代わりに<code>let!</code> (“let バン”と読みます) メソッドを使っています。これは、<code>let</code> 変数は「<em>lazy</em>」、つまり実際に参照されるまで初期化されない性質 (遅延) を持っており、そのことで不都合が生じるためです。ここでは、マイクロポストを遅延することなく即座に作成する必要があります。そのことにより、マイクロポストのタイムスタンプが常に正しい順序で作成されるように、かつ<code>@user.microposts</code>が空の状態が生じることのないようにしたいからです。<code>let!</code>を使用すれば、対応する変数を強制的に即座に作成できます。</p>

<div class="label" id="code-micropost_ordering_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.13</span> <span class="description">ユーザのマイクロポストの順序をテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right microposts in the right order&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上記のコードで重要なのは、以下の行です。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
</pre></div>
</div>


<p>これは新しいポストが最初に来ることをテストしています。デフォルトでは id順に並ぶため<code>[older_micropost, newer_micropost]</code>の順序になりテストは失敗するはずです。また、このテストは<a class="ref" href="http://railstutorial.jp/user-microposts.html#table-association_methods">表 10.1</a>で示すように、 <code>user.microposts</code>がマイクロポストの配列を返すことをチェックすることにより、基本的な<code>has_many</code>関連付け自体の正しさも確認しています。</p>

<p>順序テストがパスするために、 <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_ordering">リスト10.14</a>に示すようにRailsの <code>default_scope</code>に<code>:order</code>パラメータを渡して使用します (このコードは<em>スコープ</em>に関する最初の例でもあります。より一般的なスコープについては<a class="ref" href="http://railstutorial.jp/following-users.html#top">第11章</a>で説明します)。</p>

<div class="label" id="code-micropost_ordering"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.14</span> <span class="description"><code>default_scope</code>でマイクロポストを順序付ける。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでの順序は<code>’microposts.created_at DESC’</code>としています。<code>DESC</code>は SQLでいうところの “descending” であり、新しいものから古い順への降順ということになります。</p>

<div class="label" id="sec-dependent_destroy"></div>


<h4><a id="sec-10_1_4_2" href="http://railstutorial.jp/user-microposts.html#sec-dependent_destroy" class="heading">Dependent: destroy</a></h4>


<p>順序についてはここで区切ることにし、今度はマイクロポストに第二の要素を追加してみましょう。<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-destroying_users">9.4</a>で書いたように、サイト管理者はユーザを<em>破棄する</em>権限を持ちます。ユーザが破棄された場合、ユーザのマイクロポストも同様に破棄されるべきです。最初のマイクロポストのユーザーを破棄した後、関連するマイクロポストもデータベースからなくなったことを確認することで、ユーザーの破棄をテストすることができます。</p>

<p>適切にマイクロポストの破棄をテストするために、最初にローカル変数で指定されたユーザーのポストを取得し、それからユーザーを破棄します。シンプルな実装は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># マイクロポストがデータベースからなくなったことを確認</span>
<span class="k">end</span>
</pre></div>
</div>


<p>残念ですが、上のコードはRubyの配列の妙により動きません。Rubyにおける配列の代入は「<em>参照</em>のコピー」であり、配列全体そのもののコピーではないため、オリジナルの配列に対して何らかの変更を行うと、そのコピーにも同じ変更が行われてしまいます。たとえば以下のように、配列を作成し、2番目の変数をその配列に代入してから、<code>reverse!</code>メソッドを使用して最初の配列を逆順にするとします。 </p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse!</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span>
<span class="go">=&gt; [3, 2, 1]</span>
</pre></div>
</div>


<p>驚くかもしれませんが、上のコードでは、<code>a</code>が逆転しただけではなく、<code>b</code>まで逆転されてしまっています。これは、<code>a</code>と<code>b</code>が同じ配列を指しているためです (同じことは、文字列とハッシュなど、他のRubyのデータ構造でも発生します)。</p>

<p>ユーザのマイクロポストの場合には、こうなります。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span>
<span class="gp">&gt;&gt; </span><span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="gp">&gt;&gt; </span><span class="n">microposts</span>
<span class="go">=&gt; []</span>
</pre></div>
</div>


<p>（この時点では、関連付けられたマイクロポストの破棄を実装していないので、上のコードは動作しません。原理を説明するためだけに書いています。）ここでは、ユーザオブジェクトを破棄しても、<code>microposts</code>変数は空の配列<code>[]</code>として残されていることがわかります。</p>

<p>この「参照がコピーされる」動作は、Rubyのオブジェクトの複製を行うときに多大な注意を払わないといけないことを意味します。配列などの比較的単純なオブジェクトを複製するには、<code>dup</code>メソッドを使用することができます。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">dup</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse!</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span>
<span class="go">=&gt; [1, 2, 3]</span>
</pre></div>
</div>


<p>(このような比較的単純なオブジェクトの複製作業は “shallow copy” として知られています。より複雑なオブジェクトを複製する &quot;deep copy&quot; を実装することははるかに難しい問題であり、実際に一般的な解決策はありませんが、検索エンジンで &quot;ruby deep copy&quot; を検索すると、ネストした配列のような、より複雑な構造をコピーする必要がある場合の解決策が見つかると思います。)ユーザーのマイクロポストに<code>dup</code>メソッドを適用すると、次のようなコードになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">dup</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_empty</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># マイクロポストがデータベースからなくなったことを確認</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードには、以下の行を追加しました。</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_empty</span>
</pre></div>
</div>


<p>上の行は、<code>dup</code>が誤って消されてしまった場合にエラーを検出できるように、セーフティチェックとして追加しました<sup class="footnote" id="fnref-10_3"><a href="http://railstutorial.jp/user-microposts.html#fn-10_3">3</a></sup>。完全な実装を<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_dependency_test">リスト10.15</a>に示します。</p>

<div class="label" id="code-micropost_dependency_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.15</span> <span class="description">ユーザーを破棄するとマイクロポストも破棄されることをテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;should destroy associated microposts&quot;</span> <span class="k">do</span>
      <span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">dup</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
      <span class="n">microposts</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_empty</span>
      <span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、レコードが見つからない場合は<code>nil</code>を返す<code> Micropost.find_by_id</code>を使用しました。一方、<code> Micropost.find</code>は例外が発生するため、テストするのが多少難しくなってしまいます。(気になっているかもしれないので書いておくと、findを使用する場合は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span> 
  <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveRecord::RecordNotFound</span><span class="p">)</span>
</pre></div>
</div>


<p>これでfindの場合のテストを実施できます。)</p>

<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_dependency_test">リスト 10.15</a>をパスするためのアプリケーションコードは1行に満たないほどの量しかなく、事実それは<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_dependency">リスト10.16</a>に示す<code> has_many</code>関連付けメソッドのオプションにすぎません。
</p>

<div class="label" id="code-micropost_dependency"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.16</span> <span class="description">ユーザのマイクロポストがユーザと一緒に破棄されることを保証するコード。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードの中にある以下の<code>dependent: :destroy</code>オプションは、</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
</pre></div>
</div>


<p>ユーザー自体が破棄されたときに、そのユーザーに依存するマイクロポスト (つまり特定のユーザーのもの) も破棄されることを指定しています。これは、管理者がシステムからユーザーを削除したときに、依存するユーザーが存在しないマイクロポストがデータベースに取り残されてしまうことを防ぎます。</p>

<p>これで、ユーザー/マイクロポスト関連付けの最終形が完成しました。すべてのテストがパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-micropost_validations"></div>


<h3><a id="sec-10_1_5" href="http://railstutorial.jp/user-microposts.html#sec-micropost_validations" class="heading"><span class="number">10.1.5</span>コンテンツの検証</a></h3>


<p>Micropostモデルを離れる前に、(<a class="ref" href="http://railstutorial.jp/a-demo-app.html#sec-putting_the_micro_in_microposts">2.3.2</a>の例に従い) マイクロポストの<code>content</code>の検証を追加しましょう。<code>user_id</code>属性と同様、<code>content</code>属性も存在する必要があり、さらに<em>マイクロ</em>ポストが140文字より長くならないよう制限を加えます。このテストは<a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-user_validations">6.2</a>でのユーザーモデルの検証テストの例に従って、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_validations_tests">リスト10.17</a>のように書きます。</p>

<div class="label" id="code-micropost_validations_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.17</span> <span class="description">Micropostモデルの検証のテスト。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with blank content&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with content that is too long&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">141</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/modeling-users.html#sec-user_validations">6.2</a>と同様、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_validations_tests">リスト10.17</a>ではマイクロポストの長さの検証コードをテストするために、文字列の乗算を使用しています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 10
<span class="go">=&gt; &quot;aaaaaaaaaa&quot;</span>
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 141
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
</pre></div>
</div>


<p>実際のアプリケーションコードはわずか1行です。</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のコードを反映したMicropostモデルを<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_validations">リスト10.18</a>に示します。</p>

<div class="label" id="code-micropost_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.18</span> <span class="description">Micropostモデルの検証。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-showing_microposts"></div>


<h2><a id="sec-10_2" href="http://railstutorial.jp/user-microposts.html#sec-showing_microposts" class="heading"><span class="number">10.2</span>マイクロポストを表示する</a></h2>


<p>Web経由でマイクロポストを作成する方法はまだありませんが (<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-creating_microposts">10.3.2</a>から作り始めます)、マイクロポストを表示することと、テストすることならできます。ここでは、Twitterのような独立したマイクロポスト<code>index</code>ページでユーザーのマイクロポストを表示するよりも、<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-user_microposts_mockup">図10.4</a>のモックアップに示したように、直接ユーザーの<code>show</code>ページで表示させることにしましょう。ユーザープロファイルにマイクロポストの表示を追加するための非常にERbテンプレートを作成するところから始め、次に<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-sample_users">9.3.2</a>のサンプルデータ生成にマイクロポストを追加して、画面にサンプルデータが表示されるようにします。</p>

<div class="label" id="fig-user_microposts_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/user_microposts_mockup_bootstrap.png" alt="user_microposts_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図10.4: </span><span class="description">マイクロポストが表示されたプロファイルページのモックアップ。<a href="http://railstutorial.org/images/figures/user_microposts_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#sec-remember_me">8.2.1</a>でサインイン機能について説明したときと同様に、<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-augmenting_the_user_show_page">10.2.1</a>でも最初に実装をお見せし、次にそれらの要素を順に解説してきます (<a href="http://en.wikipedia.org/wiki/Stack_(data_structure)">スタック</a>に複数の要素を一括でプッシュした後、順にポップするような要領です)。しばらくの間盛り上がりに欠けるかもしれませんが、<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-sample_microposts">10.2.2</a>で一気に取り返しますので、ご辛抱願います。</p>

<div class="label" id="sec-augmenting_the_user_show_page"></div>


<h3><a id="sec-10_2_1" href="http://railstutorial.jp/user-microposts.html#sec-augmenting_the_user_show_page" class="heading"><span class="number">10.2.1</span>ユーザー表示ページの拡張</a></h3>


<p>ユーザーのマイクロポスト表示に対するテスト、すなわちユーザーに対するrequest specを作成するところから始めましょう。ユーザーに関連付けられているマイクロポストのファクトリーを作成し、それから表示ページが各ポストの内容を含んでいるか検証する戦略で進めます。また、<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-user_microposts_mockup">図 10.4</a>で示されているように, マイクロポストの総数が表示されているかどうかも検証します。</p>

<p>ポストは<code>let</code>メソッドで作成できますが、ユーザ表示ページでポストがすぐに表示されるように、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_ordering_test">リスト10.13</a>と同様に即座に関連付けを作成できるようにしたいと思います。そこで、今回も<code>let!</code>を使います。 </p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">)</span> <span class="p">}</span>

<span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のようにマイクロポストを定義したことで、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_show_microposts_test">リスト10.19</a>のコードを使って、プロファイルページの外観をテストできるようになります。</p>

<div class="label" id="code-user_show_microposts_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.19</span> <span class="description">ユーザの<code>show</code>ページでマイクロポストが表示されていることをテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;microposts&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>count</code>メソッドは、関連付けを<em>経由して</em>使用していることにご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p><code>count</code>関連付けメソッドは賢くできていて、直接データベースでカウントを行います。特に、データベース上のマイクロポストを全部読みだしてから結果の配列に対して<code>length</code>を呼ぶような無駄なことは<em>していません</em>。そんなことをしたら、マイクロポストの数が増加するにつれて効率が低下してしまいます。代わりに、特定<code>user_id</code>に対するマイクロポストの数をデータベースに問い合わせます。それでもcountメソッドがアプリケーションのボトルネックになるようなことがあれば、さらに高速な<a href="http://railscasts.com/episodes/23-counter-cache-column"><em>counter cache</em></a>を使うこともできます。</p>

<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_show_microposts_test">リスト10.19</a>のテストは<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_partial">リスト10.21</a>まではパスしませんが、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_show_microposts">リスト10.20</a>に示されているように、まずはユーザープロファイルページにマイクロポストの一覧を挿入するところからアプリケーションコードの実装を始めることにしましょう。</p>

<div class="label" id="code-user_show_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.20</span> <span class="description">ユーザーの<code>show</code>画面にマイクロポストを追加する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  .
  .
  .
  <span class="nt">&lt;aside&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>すぐにもマイクロポスト一覧の実装に取りかかりますが、その前に注意すべき点がいくつかあります。<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_show_microposts">リスト10.20</a>では、<code>if @user.microposts.any?</code>を使用することによって (以前<a class="ref" href="http://railstutorial.jp/sign-up.html#code-errors_partial">リスト7.23</a>でも使用しました)  ユーザのマイクロポストが1つもない場合に空のリストが表示されないようにしています。</p>

<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_show_microposts">リスト10.20</a>では、以下のようにマイクロポストに対するページネーションのコードを加えていたことにご注意ください。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#code-will_paginate_index_view">リスト9.34</a>のユーザーインデックスページのコードと比較すると、以前は以下のように単純なコードでした。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>上のコードは引数なしで動作していました。これは<code>will_paginate</code>が、ユーザーコントローラのコンテキストにおいて、<code>@users</code>インスタンス変数が存在していることを<em>前提としている</em>ためです。このインスタンス変数は、<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-pagination">9.3.3</a>でも述べたように<code>ActiveRecord::Relation</code>クラスのインスタンスです。今回の場合は、ユーザーコントローラのコンテキストにおいて、<em>マイクロポスト</em>をページネーションしたいため、明示的に<code>@micropost</code>変数を<code> will_paginate</code>に渡す必要があります。もちろん、そのような変数をユーザー<code>show</code>アクションで定義しなければなりません(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_show_microposts_instance">リスト10.22</a>)。</p>

<p>最後に、以下のようにマイクロポストの現在の数のカウントを追加します。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
</pre></div>
</div>


<p>前述のように、<code>@user.microposts.count</code>は、ユーザ/マイクロポスト関連付けを経由して、あるユーザーに属するマイクロポストをカウントすることを除けば、<code>User.count</code>に似ています。</p>

<p>やっとマイクロポスト一覧のコードそのものにたどり着きました。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</pre></div>
</div>


<p>この<em>順序リスト</em>タグ<code>ol</code>を含むコードがマイクロポストの一覧を生成します。ただしご覧のとおり、実装の厄介な部分をマイクロポストパーシャルに任せています。<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-partial_refactoring">9.3.4</a>で見た以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><code>_user.html.erb</code>パーシャルを使って自動的に<code>@users</code>変数内のそれぞれのユーザを出力します。同様に以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>まったく同じことをマイクロポストで行います。つまり、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_partial">リスト 10.21</a>に示すように、<code>_micropost.html.erb</code>パーシャルを (<code>micropost</code>用のビューのディレクトリの中に) 定義しなければならないことを意味します。</p>

<div class="label" id="code-micropost_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.21</span> <span class="description">1つのマイクロポストを表示するパーシャル。</span><br /><span class="description"> <code>app/views/microposts/_micropost.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>詳細は<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-sample_microposts">10.2.2</a>で述べますが、上のコードでは素晴らしい<code>time_ago_in_words</code>ヘルパーメソッドを使用しています。</p>

<p>これまでのところ、関連するERbテンプレートをすべて定義したにもかかわらず、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_show_microposts_test">リスト10.19</a>のテストは、たった１つ、<code>@microposts</code>変数がないために失敗していたはずです。<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_show_microposts_instance">リスト10.22</a>のように変更することで、テストにパスさせることができます。</p>

<div class="label" id="code-user_show_microposts_instance"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.22</span> <span class="description"><code>@microposts</code>インスタンス変数をユーザー<code>show</code>アクションに追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>paginate</code>メソッドの素晴らしさにご注目ください。マイクロポストの関連付けを経由して<tt>micropost</tt>テーブルに到達し、必要なマイクロポストのページを引き出してくれます。</p>

<p>ここで、今作成した新しいユーザープロファイルページ (<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-user_profile_no_microposts">図10.5</a>) をブラウザで見てみましょう。...何というさみしいページ、がっかりですね。もちろん、これはマイクロポストが1つもないのが原因です。いよいよマイクロポストを追加しましょう。</p>

<div class="label" id="fig-user_profile_no_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/user_profile_no_microposts_bootstrap.png" alt="user_profile_no_microposts_bootstrap" /></span></div><div class="caption"><span class="header">図10.5</span><span class="description">マイクロポスト用のコードのあるユーザープロファイルページ (ただしマイクロポストがない)。<a href="http://railstutorial.org/images/figures/user_profile_no_microposts_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-sample_microposts"></div>


<h3><a id="sec-10_2_2" href="http://railstutorial.jp/user-microposts.html#sec-sample_microposts" class="heading"><span class="number">10.2.2</span>マイクロポストのサンプル</a></h3>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-augmenting_the_user_show_page">10.2.1</a>のユーザーマイクロポストのテンプレート作成作業の成果は、何とも拍子抜けでした。<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-sample_users">9.3.2</a>のサンプル生成にマイクロポストを追加し、この情けない状況を修正しましょう。<em>すべて</em>のユーザーにサンプルマイクロポストを追加しようとすると時間がかかりすぎるので、最初の6人のユーザー<sup class="footnote" id="fnref-10_4"><a href="http://railstutorial.jp/user-microposts.html#fn-10_4">4</a></sup>だけを選択しましょう。そのためには、<code>User.all</code>メソッドに<code>limit</code>オプションを渡します<sup class="footnote" id="fnref-10_5"><a href="http://railstutorial.jp/user-microposts.html#fn-10_5">5</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>


<p>その後、各ユーザーに50のマイクロポスト (ページネーションが切り替わる30を超える数) を作成し、Faker gem の便利な <tt>Lorem.sentence</tt><a href="http://faker.rubyforge.org/rdoc/classes/Faker/Lorem.html"></a>メソッドを使って各マイクロポストのサンプルコンテンツを生成します (<code>Faker::Lorem.sentence</code>は、いわゆる<em>lorem ipsum</em>ダミーテキストを返します。<a class="ref" href="http://railstutorial.jp/modeling-users.html#top">第6章</a>で述べたように、<em>lorem ipsum</em>には面白い<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">裏話</a>があります)。 変更の結果は、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-sample_microposts">リスト 10.23</a>のようなサンプルデータ生成になります。</p>

<div class="label" id="code-sample_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.23</span> <span class="description">サンプルデータにマイクロポスト用のコードを追加する。</span><br /><span class="description"> <code>lib/tasks/sample_data.rake</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
    <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">content</span> <span class="o">=</span> <span class="ss">Faker::Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>もちろん、新しいサンプルデータを生成するためにはRakeタスクの<code>db:populate</code>を実行する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>やっと<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-augmenting_the_user_show_page">10.2.1</a>での地道な作業が、それぞれのマイクロポストの情報を表示することによって報われはじめました<sup class="footnote" id="fnref-10_6"><a href="http://railstutorial.jp/user-microposts.html#fn-10_6">6</a></sup>。実行結果を<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-user_profile_microposts_no_styling">図10.6</a>に示します。</p>

<div class="label" id="fig-user_profile_microposts_no_styling"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/user_profile_microposts_no_styling_bootstrap.png" alt="user_profile_microposts_no_styling_bootstrap" /></span></div><div class="caption"><span class="header">図10.6</span><span class="description">ユーザプロファイル (<a href="http://localhost:3000/users/1">/users/1</a>) とスタイルのないマイクロポスト <a href="http://railstutorial.org/images/figures/user_profile_microposts_no_styling_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-user_profile_microposts_no_styling">図10.6</a>のページではマイクロポスト固有のスタイルを持っていなかったので、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_css">リスト10.24</a>を追加して、結果のページを見てみましょう<sup class="footnote" id="fnref-10_7"><a href="http://railstutorial.jp/user-microposts.html#fn-10_7">7</a></sup>。<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-user_profile_with_microposts">図 10.7</a>が一番目の(ログインした)ユーザのプロファイルページで、、<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-other_profile_with_microposts">図 10.8</a>が二番目のユーザのプロファイルページです。最後に<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-user_profile_microposts_page_2_rails_3">図10.9</a>は、一番目のユーザーのためのマイクロポストの<em>二番目</em>のページと、下部に改ページのリンクを表示しています。3つ全ての場合において、各マイクロポストの表示は、それが作成されてからの時間（例えば、&quot;1分​​前に投稿&quot;）を表示していることを見てください。これは<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_partial">リスト10.21</a>での<code>time_ago_in_words</code>メソッドによるものです。数分待ってからページをリロードした場合、テキストが自動的に新しい時間に基づいて更新されます。</p>

<div class="label" id="code-micropost_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.24.</span> <span class="description">マイクロポストのためのCSS（この章のためのすべてのCSSを含む）</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">microposts</span> <span class="o">*/</span>

<span class="nc">.microposts</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">;</span>

  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#e8e8e8</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
目次
  <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.timestamp</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">textarea</span> <span class="p">{</span>
    <span class="na">height</span><span class="o">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-user_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/user_profile_with_microposts_bootstrap.png" alt="user_profile_with_microposts_bootstrap" /></span></div><div class="caption"><span class="header">図 10.7: </span><span class="description">ユーザプロファイル (<a href="http://localhost:3000/users/1">/users/1</a>) とマイクロポスト <a href="http://railstutorial.org/images/figures/user_profile_with_microposts_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-other_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/other_profile_with_microposts_bootstrap.png" alt="other_profile_with_microposts_bootstrap" /></span></div><div class="caption"><span class="header">図 10.8: </span><span class="description">別ユーザのプロファイルとマイクロポスト(<a href="http://localhost:3000/users/5">/users/5</a>) <a href="http://railstutorial.org/images/figures/other_profile_with_microposts_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-user_profile_microposts_page_2_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/user_profile_microposts_page_2_rails_3_bootstrap.png" alt="user_profile_microposts_page_2_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">図 10.9: </span><span class="description"> マイクロポスト改ページリンク (<a href="http://localhost:3000/users/1?page=2">/users/1?</a></span><span class="description"><a href="http://localhost:3000/users/1?page=2">page=2</a>). <a href="http://railstutorial.org/images/figures/user_profile_microposts_page_2_rails_3_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-manipulating_microposts"></div>


<h2><a id="sec-10_3" href="http://railstutorial.jp/user-microposts.html#sec-manipulating_microposts" class="heading"><span class="number">10.3</span>マイクロポストを操作する</a></h2>


<p>データモデリングとマイクロポスト表示テンプレートの両方を終えたので、次はウェブを介してそれらを作成するためのインターフェイスに取りかかりましょう。リソース（今回の場合はマイクロポストリソース)を作るためにHTMLフォームを使う３番目の例になります<sup class="footnote" id="fnref-10_8"><a href="http://railstutorial.jp/user-microposts.html#fn-10_8">8</a></sup>。この章では、<em>ステータスフィード</em>(<a class="ref" href="http://railstutorial.jp/following-users.html#top">第11章</a>で完成させます)の最初のヒントをお見せします。最後に、ユーザーがマイクロポストをウェブ経由で破棄できるようにします。</p>

<p>過去の慣習を無にするものが１つあります。マイクロポストリソースへのインターフェースは、ユーザーと静的ページのコントローラを介して主に実行されます。そのため、マイクロポストコントローラで、<code>new</code>または<code>edit</code>のようなアクションは必要ありません。<code>create</code>と<code>destroy</code>があれば十分です。よって<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_resource">リスト 10.25</a>に示すように、マイクロポストリソースへのルーティングは一層シンプルになります。<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_resource">リスト 10.25</a>のコードは結果として、フルセットのルーティング(<a class="ref" href="http://railstutorial.jp/a-demo-app.html#table-demo_RESTful_microposts">表 2.3</a>)に対して、その小さなサブセットであるRESTfulルート(<a class="ref" href="http://railstutorial.jp/user-microposts.html#table-RESTful_microposts">表 10.2</a>)になります。もちろん、このシンプルさは<em>より</em>高度になるためのサインです。<a class="ref" href="http://railstutorial.jp/a-demo-app.html#top">第2章</a>でのスキャフォールディングに頼るという長い道を歩んできましたが、もはやそれらの複雑な部分はほとんど必要ありません。</p>

<div class="label" id="code-microposts_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.25.</span> <span class="description">マイクロポストリソースに対するルーティング</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="table-RESTful_microposts"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>目的</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>POST</tt></td><td class="align_left">/microposts</td><td class="align_left"><code>create</code></td><td class="align_left">新しいマイクロポストを作る</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>destroy</code></td><td class="align_left">id <code>1</code> のマイクロポストを削除する</td></tr></table></div><div class="caption"><span class="header">表 10.2: </span><span class="description"><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_resource">リスト 10.25</a>のマイクロポストリソースで表現されるRESTfulルート</span></div></div>




<div class="label" id="sec-access_control"></div>


<h3><a id="sec-10_3_1" href="http://railstutorial.jp/user-microposts.html#sec-access_control" class="heading"><span class="number">10.3.1</span>アクセス制御</a></h3>


<p>マイクロポストリソースの開発は、マイクロポストコントローラ内のアクセス制御から始めましょう。発想は単純です：両方の<code>create</code>と<code>destory</code>アクションはユーザがサインインしていなければ実行できないものとします。これをテストするためのRSpecコードを<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_access_control">リスト10.26</a>に示します。(マイクロポストのユーザーだけが削除できるような３番目のプロテクトは <a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-destroying_microposts">10.3.4</a>で追加します。)</p>

<div class="label" id="code-micropost_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.26.</span> <span class="description">マイクロポストに対するアクセスコントロールのテスト</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Microposts controller&quot;</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the create action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">microposts_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the destroy action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">))</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(まだ出来上がっていない)マイクロポストのウェブインターフェースと違い、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_access_control">リスト 10.26</a>のコードは、<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#code-edit_update_wrong_user_tests">リスト 9.14</a>と同様に、それぞれのマイクロポストアクションのレベルで動作します。サインインしていないユーザが <tt>POST</tt> リクエストを /microposts (<code>post microposts_path</code>, <code>create</code> アクションが呼び出される)に投げた場合、または <tt>DELETE</tt> リクエストを /microposts/1 (<code>delete micropost_path(micropost)</code>,  <code>destroy</code>アクションが呼び出される)に投げた場合、リダイレクトされます。</p>

<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_access_control">リスト 10.26</a>のテストをパスするためのアプリケーションコードを書く前に少しリファクタリングを行いましょう。 <a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-requiring_signed_in_users">9.2.1</a>にて<code>signed_in_user</code>メソッドと呼ばれる before filter を使用して、サインインを必須にしたことを思い出してください(<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#code-authorize_before_filter">リスト9.12</a>）。そのときは、ユーザーのコントローラだけでそのメソッドを必要としていましたが、今は同様にマイクロポストコントローラでも必要であることがわかったので、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-sessions_helper_authenticate">リスト10.27</a>に示すように、セッションヘルパーに移動します<sup class="footnote" id="fnref-10_9"><a href="http://railstutorial.jp/user-microposts.html#fn-10_9">9</a></sup>。</p>

<div class="label" id="code-sessions_helper_authenticate"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.27.</span> <span class="description"><code>signed_in_user</code>メソッドをセッッションヘルパーに移動</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in_user</span>
    <span class="k">unless</span> <span class="n">signed_in?</span>
      <span class="n">store_location</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>重複しないよう<code>signed_in_user</code>をユーザーコントローラーから同時に削除しておきましょう。</p>

<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-sessions_helper_authenticate">リスト 10.27</a>のコードにより、<code>signed_in_user</code>メソッドがマイクロポストコントローラーにおいて利用可能になりました。そのため<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_controller_access_control">リスト 10.28</a> で示すように <code>create</code> および<code>destroy</code> アクションにし対して before filter を使う事でアクセス制限をかけることが可能になりました。（コマンドラインで生成しなかったので、手動でマイクロポストのコントローラファイルを作成する必要があります。）</p>

<div class="label" id="code-microposts_controller_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.28.</span> <span class="description">マクロポストコントローラーのアクションに認証を追加</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>before filter はデフォルトで両方のアクションに適用されるため、適用するアクションを明示しなかったことに注意していください。もし例えば<code>index</code>アクションを追加し、サインインしていないユーザでアクセス可能にしたい場合は、index アクションを除いて明示的にアクションを指定する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>この時点で、テストがパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb
</pre></div>
</div>




<div class="label" id="sec-creating_microposts"></div>


<h3><a id="sec-10_3_2" href="http://railstutorial.jp/user-microposts.html#sec-creating_microposts" class="heading"><span class="number">10.3.2</span>マイクロポストを作成する</a></h3>


<p><a class="ref" href="http://railstutorial.jp/sign-up.html#top">第7章</a>で、HTTP <tt>POST</tt> リクエストをユーザーコントローラーの<code>create</code> アクションに発行する HTML フォームを作って、ユーザーのサインアップを実装しました。マイクロポスト作成の実装も似ています。主な違いは、別の micropost/new ページを使うよりもむしろ、(Twitterに習って）ホームページ自体（つまり、ルートパス）にフォームを置くところです(<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-home_page_with_micropost_form_mockup">図10.10 </a>のモックアップ参照)。</p>

<div class="label" id="fig-home_page_with_micropost_form_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/home_page_with_micropost_form_mockup_bootstrap.png" alt="home_page_with_micropost_form_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図 10.10: </span><span class="description">マイクロポストを投稿するフォームを持ったホームページのモックアップ <a href="http://railstutorial.org/images/figures/home_page_with_micropost_form_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>最後のホームページを実装したときは(<a class="ref" href="http://railstutorial.jp/filling-in-the-layout.html#fig-sample_app_logo">図 5.6</a>)、“Sign up now!” ボタンが真ん中にありました。マイクロポスト作成フォームは、特定のサインインしているユーザーのコンテキストのみで機能するので、このセクションの一つの目標は、ユーザーのサインインの状態に応じて、異なるホームページのバージョンを提供することになります。下の<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_home_page">リスト 10.31</a>で実装しますが、いまはテストを先に書きましょう。ユーザーリソースの場合のように、インテグレーションテストを使いましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test micropost_pages
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/sign-up.html#code-basic_signup_tests">リスト 7.16</a>でのユーザー作成に対するテストと同様にマイクロポスト作成のテストを実施します。結果は<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_create_tests">リスト 10.29</a>に示します。</p>

<div class="label" id="code-microposts_create_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.29.</span> <span class="description">マイクロポスト作成に対するテスト</span><br /><span class="description"> <code>spec/requests/micropost_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Micropost pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;micropost creation&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not create a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;error messages&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span> 
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">fill_in</span> <span class="s1">&#39;micropost_content&#39;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;Lorem ipsum&quot;</span> <span class="p">}</span>
      <span class="n">it</span> <span class="s2">&quot;should create a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/sign-up.html#code-user_create_action">リスト 7.25</a>でのユーザーに対するテストと同様に、マイクロポストの <code>create</code> アクションに対するテストから始めます。違いは、新しいマイクロポストを <code>build</code> するために user/micropost 関連を使っている点です(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_create_action">リスト 10.30</a>)。</p>

<div class="label" id="code-microposts_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.30.</span> <span class="description">マイクロポストコントローラーの <code>create</code> アクション</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;static_pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>マイクロポストを作成するためのフォームを構築するために、サイト訪問者がサインインしているかどうかにより、異なるHTMLを提供するコードを使います(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_home_page">リスト10.31</a>)。</p>

<div class="label" id="code-microposts_home_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.31.</span> <span class="description">ホームページ (<a href="http://localhost:3000/">/</a>) にマイクポスト作成を追加</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/user_info&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/micropost_form&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;/div&gt;</span>  
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;center hero-unit&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;h2&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/h2&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> 
                                <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;rails.png&quot;</span><span class="p">,</span> <span class="ss">alt:</span> <span class="s2">&quot;Rails&quot;</span><span class="p">),</span> <span class="s1">&#39;http://rubyonrails.org/&#39;</span> <span class="cp">%&gt;</span>
end 
</pre></div>
</div></div>


<p> <code>if</code>-<code>else</code> 分岐してそれぞれにコードを書いているのが少し汚いですが、クリーンアップは演習として後に残します(<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-micropost_exercises">10.5</a>)。<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_home_page">リスト 10.31</a>で必須なパーシャルの実装は演習ではないので、新しいホームページのサイドバーは<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_info">リスト 10.32</a>で、
マイクロポストフォームのパーシャルは <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_form">リスト 10.33</a>で実装します。</p>

<div class="label" id="code-user_info"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.32.</span> <span class="description">ユーザー情報サイドバーのパーシャル</span><br /><span class="description"> <code>app/views/shared/_user_info.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;view my profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;micropost&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#code-user_index_view">リスト 9.25</a>のように、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_info">リスト 10.32</a>のコードは <a class="ref" href="http://railstutorial.jp/sign-up.html#code-gravatar_option">リスト 7.29</a>で定義した<code>gravatar_for</code>ヘルパーを使用します。</p>

<p>プロファイルサイドバーのように (<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_show_microposts">リスト 10.20</a>)、 <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-user_info">リスト 10.32</a>のユーザー情報もそのユーザーが投稿したマイクロポストの総数を表示していることに注意してください。ただし少し表示に違いがあります。プロファイルサイドバーにおいて“Microposts”がラベルで、“Microposts (1)”を表示することは理にかなっていました。しかし今回の場合は、“1 microposts” と表記するのは英語として文法が間違っているので、<code>pluralize</code> をt使って “1 micropost” (ただし “2 microposts”) と表記するように調整します。</p>

<p>次はマイクロポストの作成フォームを定義します(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_form">リスト 10.33</a>)。これはサインアップフォームに似ています(<a class="ref" href="http://railstutorial.jp/sign-up.html#code-signup_form">リスト 7.17</a>)。</p>

<div class="label" id="code-micropost_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.33.</span> <span class="description">マイクロポスト作成フォームのパーシャル</span><br /><span class="description"> <code>app/views/shared/_micropost_form.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder:</span> <span class="s2">&quot;Compose new micropost...&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Post&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
end
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_form">リスト 10.33</a>のフォームが動くようにするために２つの変更を加えなければいけません。１つは、(以前のように)関連を使って <code>@micropost</code> を定義することです。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>結果は <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_instance_variable">リスト 10.34</a>のようになります。</p>

<div class="label" id="code-micropost_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.34.</span> <span class="description"><code>home</code> アクションへマイクロポストインスタンス変数を追加</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">signed_in?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_instance_variable">リスト 10.34</a>のコードは、ユーザーがサインインしていなければいけないという要求を実装しわすれた場合に、テストが落ちてくれるのでうれしいですね。</p>

<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_form">リスト 10.33</a> を動かすための第二の変更は、次のコードが動くようにエラーメッセージパーシャルを再定義することです。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="http://railstutorial.jp/sign-up.html#code-f_error_messages">リスト 7.22</a>ではエラーメッセージパーシャルが<code>@user</code> 変数を直接参照していたことを思い出してください。今回は代わりに <code>@micropost</code> 変数を使う必要があります。どんな種類のオブジェクトが渡されてもエラーメッセージパーシャルが動くようにすべきです。幸運なことにフォーム変数 <code>f</code> は <code>f.object</code> とすることによって関連するオブジェクトにアクセスすることができます。なので、</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p>の場合は <code>f.object</code>は <code>@user</code>となり、</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p>の場合は <code>f.object</code> は <code>@micropost</code>となります。</p>

<p>パーシャルにオブジェクトを渡すために、値がオブジェクトで、キーがパーシャルでの変数名と同じハッシュを利用します。それにより以下のコードが実現します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>言い換えると, <code>object: f.object</code> は<code>error_messages</code>パーシャルにおいて <code>object</code> と呼ぶ変数名を作成します。<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-updated_error_messages_partial">リスト 10.35</a>に示すように、この object をカスタマイズエラーメッセージを作るために使う事ができます。</p>

<div class="label" id="code-updated_error_messages_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.35.</span> <span class="description">他のオブジェクトでも動作するように <a class="ref" href="http://railstutorial.jp/sign-up.html#code-errors_partial">リスト 7.23</a> のエラーメッセージパーシャルを更新</span><br /><span class="description"> <code>app/views/shared/_error_messages.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    end
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
end
</pre></div>
</div></div>


<p>この自転で、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_create_tests">リスト 10.29</a>のテストがパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/micropost_pages_spec.rb
</pre></div>
</div>


<p>不運にも、サインアップと編集フォームが古いバージョンのメッセージパーシャルを利用しているため、ユーザーリクエスト spec が壊れてしまいました。これを修正するために、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-signup_errors_updated">リスト 10.36</a> および <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-edit_errors_updated">リスト 10.37</a>で示すように、それらのフォームをより汎用的na
バージョンに更新しましょう。(<em>Note</em>: もし <a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-updating_deleting_exercises">9.6</a> での演習をやったなら<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#code-new_edit_partial">リスト 9.50</a>および <a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#code-new_user_with_partial">リスト 9.51</a> のコードと異なっていることでしょう。<a href="http://en.wikipedia.org/wiki/Mutatis_mutandis"><em>Mutatis mutandis</em>.</a>)</p>

<div class="label" id="code-signup_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.36.</span> <span class="description">ユーザーサインアップエラーのレンダリングを更新</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    end
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-edit_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.37</span> <span class="description">ユーザー編集のエラーを更新</span><br /><span class="description"> <code>app/views/users/edit.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span> 
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    end

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://gravatar.com/emails&quot;</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>この時点で、すべてのテストがパスしたはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>さらには、この章でのすべてのHTMLが適切にレンダリングされるようになったはずです。フォームを<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-home_with_form">図 10.11</a>に、投稿エラーのあるフォームを<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-home_form_errors">図 10.12</a>に示します。新しい投稿を自分自身で作成したすべてが正しく動いていることを確認してみてください—あぁやっぱり<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-a_proto_feed">10.3.3</a>が終わるまで待っても良いです。</p>

<div class="label" id="fig-home_with_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/home_with_form_bootstrap.png" alt="home_with_form_bootstrap" /></span></div><div class="caption"><span class="header">図 10.11: </span><span class="description">新しいマイクロポストフォームのあるホームページ (<a href="http://localhost:3000/">/</a>) <a href="http://railstutorial.org/images/figures/home_with_form_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-home_form_errors"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/home_form_errors_bootstrap.png" alt="home_form_errors_bootstrap" /></span></div><div class="caption"><span class="header">図 10.12: </span><span class="description">エラーのあるホームページ <a href="http://railstutorial.org/images/figures/home_form_errors_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-a_proto_feed"></div>


<h3><a id="sec-10_3_3" href="http://railstutorial.jp/user-microposts.html#sec-a_proto_feed" class="heading"><span class="number">10.3.3</span>フィードの原型</a></h3>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-creating_microposts">10.3.2</a>の最後のコメントでほのめかした問題は、現在のホームページはマイクロポストを１つも表示していないということです。<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-home_with_form">図 10.11</a>のフォームが正しく動いているか確認したい場合、正しいエントリーを投稿し、ポストを見るために<a href="http://localhost:3000/users/1">profile page</a>に移動すれば見れますが、かなり煩わしいです。 <a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-proto_feed_mockup">図 10.13</a>のモックアップで示すように、ユーザー自身のポストを含むマイクロポスト<em>feed</em>を持つべきです。(<a class="ref" href="http://railstutorial.jp/following-users.html#top">第11章</a>では、現在のユーザによって、<em>フォローされている</em>ユーザのマイクロポストを表示する feed に汎用化する予定です。)</p>

<div class="label" id="fig-proto_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/proto_feed_mockup_bootstrap.png" alt="proto_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図 10.13: </span><span class="description"> (プロト)フィードのあるホームページのモックアップ<a href="http://railstutorial.org/images/figures/proto_feed_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>全てのユーザがフィードを持つので、ユーザーモデルに <code>feed</code> メソッドを作るのが自然だと思います。最終的には、その feed メソッドがフォーローしているユーザのマイクロポストを返すようにテストしますが、今は自分のマイクロポストは<em>含むが</em>他ユーザのマイクポストは<em>含まない</em> <code>feed</code> メソッドをテストします。その要件は <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-feed_specs">リスト 10.38</a>のコードで表現できます。</p>

<div class="label" id="code-feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.38.</span> <span class="description">(プロト)ステータスフィードのテスト</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;status&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストは、array に与えられた要素を含んでいるかどうかをチェックする<code>include?</code> メソッドを使用しています <sup class="footnote" id="fnref-10_10"><a href="http://railstutorial.jp/user-microposts.html#fn-10_10">10</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">foo&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:bar</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">baz&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>この例は RSpec boolean convention が如何に柔軟かを示す物です。<code>include</code> がモジュールを include するために使用する Ruby キーワードであるにもかかわらず(e.g., <a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#code-sessions_helper_include">リスト 8.14</a>)、この RSpec のコンテキストでは正しく array が要素を含んでいるかどうかをテストしたいのだということを推測してくれています。</p>

<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-proto_status_feed">リスト10.39</a>で示すように、<code>user_id</code> が現在のユーザー idと等しいマイクロポストを見つける事によって、適切なマイクポスト <code>feed</code> メソッドを実装することができます。これは<code>Micropost</code>モデルに対して <code>where</code> メソッドを使いことで実現できます<sup class="footnote" id="fnref-10_11"><a href="http://railstutorial.jp/user-microposts.html#fn-10_11">11</a></sup>。</p>

<div class="label" id="code-proto_status_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.39.</span> <span class="description">マイクロポストステータスフィードの準備実装</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="c1"># This is preliminary. </span><span class="c1">See &quot;Following users&quot; for the full implementation.</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>以下のコードのはてなマークは</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p><code>id</code>が基礎となるSQLクエリに挿入される前に適切に<em>エスケープ</em>されることを保証してくれるため、<a href="http://en.wikipedia.org/wiki/SQL_injection"><em>SQLインジェクション</em></a>と呼ばれる深刻なセキュリティーホールを避けることができます。ここでの<code>id</code>属性は単なる整数ですので、この場合には危険はありませんが、<em>常に</em>SQL文に注入される変数をエスケープする習慣を身につけるのは良い事です。 </p>

<p>注意深い読者は<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-proto_status_feed">リスト 10.39</a>のコードは本質的には以下のコードと等しい事に気付くかもしれません。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div>
</div>


<p>それとは代わりに<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-proto_status_feed">リスト 10.39</a>のコードを利用したのは、<a class="ref" href="http://railstutorial.jp/following-users.html#top">第11章</a>で必要となるフルステータスフィードに対してより一般的な利用が可能だからです。</p>

<p>ステータスフィードの表示をテストするために、まずいくつかのマイクロポストを作成し、それぞれのページに表示されるリスト要素 (<code>li</code>)を検証します(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-home_page_feed_test">リスト10.40</a>)。</p>

<div class="label" id="code-home_page_feed_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.40.</span> <span class="description">ホームページのフィードのレンダリングに対するテスト</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Dolor sit amet&quot;</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the user&#39;s feed&quot;</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-home_page_feed_test">リスト 10.40</a> は、以下のコードが個々のアイテムに対してマッチするように、個々のフィードアイテムが固有のCSS id を持つと仮定しています。</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>


<p>(<code>li##{item.id}</code> の最初の <code>#</code> は CSS id を示す Capybara のシンタックスで、２番目の <code>#</code> は Ruby の文字列解釈 <code>#{}</code> の先頭です)</p>

<p>サンプルアプリケーションでフィードを使うために、カレントユーザーの(ページネーション)フィードに <code>@feed_items</code> インスタンス変数を追加し(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-feed_instance_variable">リスト 10.41</a>)、それからフィードパーシャル(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-feed_partial">リスト 10.42</a>)をホームページに追加します(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-home_with_feed">リスト 10.44</a>)。(ページネーションのテストは演習に残します。<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-micropost_exercises">10.5</a>参照)</p>

<div class="label" id="code-feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.41.</span> <span class="description"><code>home</code>アクションにフィードインスタンス変数を追加</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-feed_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.42.</span> <span class="description">ステータスフィードのパーシャル</span><br /><span class="description"> <code>app/views/shared/_feed.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ol&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
end
</pre></div>
</div></div>


<p>ステータスフィードのパーシャルは以下のコードを使う点で、フィードアイテムのパーシャルにレンダリングされるフィードアイテムと異なります</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>ここでフィードアイテムと共に <code>:collection</code> パラメーターを渡してるので、 <code>render</code> はコレクションのそれぞれのアイテムをレンダリングするのに与えられたパーシャル(この場合は <code>’feed_item’</code>)を使用してくれます。(以前のレンダリングでは <code>render ’shared/micropost’</code>のように<code>:partial</code> パラメーターを省略しましたが、<code>:collection</code> パラメーターがある場合はそのシンタックスは正しく動きません。) フィードアイテムのパーシャルは<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-feed_item_partial">リスト 10.43</a>に表示されます。</p>

<div class="label" id="code-feed_item_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.43.</span> <span class="description">シングルフィードアイテムに対するパーシャル</span><br /><span class="description"> <code>app/views/shared/_feed_item.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/user-microposts.html#code-feed_item_partial">リスト 10.43</a> は以下のコードによりそれぞれのフィードに、CSS id も追加します。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>これは <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-home_page_feed_test">リスト 10.40</a>のテストで要求されていたものです。</p>

<p>私たちは、その後いつものようにフィードパーシャルをレンダリングすることでホームページにフィードを追加することができます(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-home_with_feed">リスト10.44</a>）。結果はホームページのフィードとして表示されます(<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-home_with_proto_feed">図 10.14</a>).</p>

<div class="label" id="code-home_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.44.</span> <span class="description">ホームページにステータスフィードを追加</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
    .
    .
    .
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/feed&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
end
</pre></div>
</div></div>




<div class="label" id="fig-home_with_proto_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/home_with_proto_feed_bootstrap.png" alt="home_with_proto_feed_bootstrap" /></span></div><div class="caption"><span class="header">図 10.14: </span><span class="description"> (プロト)フィードのあるホームページ(<a href="http://localhost:3000/">/</a>) <a href="http://railstutorial.org/images/figures/home_with_proto_feed-full.png">(拡大)</a></span></div></div>


<p>現時点において、新しいマイクロポストの作成は<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-micropost_created">図 10.15</a>で見るように期待通りに動きます。ささいなことではありますが、マイクロポストの投稿が<em>失敗した</em>場合において、 ホームページが<code>@feed_items</code>インスタンス変数を期待するため、現状では壊れてしまいます (テストスイートを走らせて確認できます) 最も簡単な解決方法は、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_create_action_with_feed">リスト 10.45</a>のように空の配列を渡すことです<sup class="footnote" id="fnref-10_12"><a href="http://railstutorial.jp/user-microposts.html#fn-10_12">12</a></sup></p>

<div class="label" id="fig-micropost_created"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/micropost_created_bootstrap.png" alt="micropost_created_bootstrap" /></span></div><div class="caption"><span class="header">図 10.15: </span><span class="description">新しいマイクロポストを作ったあとのホームページ<a href="http://railstutorial.org/images/figures/micropost_created_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="code-microposts_create_action_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.45.</span> <span class="description"><code>create</code> アクションに (空の) <code>@feed_items</code> インスタンス変数を追加</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">render</span> <span class="s1">&#39;static_pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で、(プロト)フィードとそのテストはすべて動くはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-destroying_microposts"></div>


<h3><a id="sec-10_3_4" href="http://railstutorial.jp/user-microposts.html#sec-destroying_microposts" class="heading"><span class="number">10.3.4</span>マイクロポストを削除する</a></h3>


<p>マイクロポストリソースに最後の機能として、ポストを削除する機能を追加します。ユーザ削除と同様に(<a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#sec-the_destroy_action">9.4.2</a>)、&quot;delete&quot;リンクで実現します(<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-micropost_delete_links_mockup">図 10.16</a>)。管理者ユーザのみがユーザを削除できるように制限されていたのと違って、今回の場合は可憐とユーザーによって作られたマイクロポストに対してのみ削除リンクが動作するようにします。</p>

<div class="label" id="fig-micropost_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/micropost_delete_links_mockup_bootstrap.png" alt="micropost_delete_links_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図 10.16: </span><span class="description"> マイクロポストの削除リンクと(プロト)フィードのモックアップ<a href="http://railstutorial.org/images/figures/micropost_delete_links_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>最初のステップとして<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-feed_item_partial">リスト 10.43</a>のマイクロポストパーシャルに削除リンクを追加します。同様に、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-feed_item_partial">リスト 10.43</a>のフィードアイテムパーシャルにリンクを追加します。結果を<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_partial_with_delete">リスト 10.46</a> および <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-feed_item_partial_with_delete">リスト 10.47</a>に載せます。(２つはほとんど同一です。重複の削除は演習として残します(<a class="ref" href="http://railstutorial.jp/user-microposts.html#sec-micropost_exercises">10.5</a>).)</p>

<div class="label" id="code-micropost_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.46.</span> <span class="description">マイクロポストパーシャルに削除リンクを追加</span><br /><span class="description"> <code>app/views/microposts/_micropost.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  end
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-feed_item_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.47.</span> <span class="description">フィードアイテムパーシャルに削除リンクを追加</span><br /><span class="description"> <code>app/views/shared/_feed_item.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  end
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>マイクロポスト削除のテストには、Capybara を使って &quot;delete&quot; リンクをクリックし、マイクロポストのカウントが１減っていることをテストします(<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_destroy_specs">リスト 10.48</a>)。</p>

<div class="label" id="code-micropost_destroy_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.48.</span> <span class="description">マイクロポストコントローラーの <code>destroy</code> アクションのテスト </span><br /><span class="description"> <code>spec/requests/micropost_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Micropost pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost destruction&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;as correct user&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">&quot;should delete a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;delete&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#code-admin_destroy_before_filter">リスト 9.48</a>でのユーザーの場合のアプリケーションコードと似ていますが、 １番の違いは、<code>admin_user</code> before filter を使うのではなく、マイクロポストの場合は <code>correct_user</code> before filter を使ってカレントユーザーが実際に指定の id のマイクロポストを持っているのかチェックしている所です。<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_destroy_action">リスト 10.49</a>にコードを示します。<a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-home_post_delete">図 10.17</a>に２番目に最新のポストを削除した場合の結果を示します。</p>

<div class="label" id="code-microposts_destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.49.</span> <span class="description">マイクロポストコントローラーの <code>destroy</code> アクション</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>correct_user</code> before filter において、マイクロポストを以下のように関連を<em>通して</em>見つけていることに注目してください。

</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>これによって自動的にカレントユーザーに所属するマイクロポストだけが見つかることが保証されます。この場合、  <code>find</code> の代わりに <code>find_by_id</code> を使用します。なぜなら前者の場合マイクロポストがない場合、例外が投げられますが、後者の場合は <code>nil</code> が返されるためです。ところで、もしあなたが Ruby の例外が得意なら、<code>correct_user</code> フィールターを以下のように書く事もできます。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">correct_user</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">rescue</span>
  <span class="n">redirect_to</span> <span class="n">root_url</span>
<span class="k">end</span>
</pre></div>
</div>


<p><code>correct_user</code> フィルターを <code>Micropost</code> モデルを以下のように直接使って実装することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>これは<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-microposts_destroy_action">リスト 10.49</a>のコードと同じだと思うかもしれませんが、<a href="http://www.rubyfocus.biz/">Wolfram Arnold</a> がブログ記事 <a href="http://www.rubyfocus.biz/blog/2011/06/15/access_control_101_in_rails_and_the_citibank-hack.html">Access Control 101 in Rails and the Citibank Hack</a> で解説しているように、常に関連を通して見つけるのがセキュリティのために良い実践であります。</p>

<div class="label" id="fig-home_post_delete"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/home_post_delete_bootstrap.png" alt="home_post_delete_bootstrap" /></span></div><div class="caption"><span class="header">図 10.17: </span><span class="description">２番目に最新のマイクロポストを削除したあとのユーザーホームページ <a href="http://railstutorial.org/images/figures/home_post_delete_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この章のコードを持って、マイクロポストモデルとインターフェースが完成しました。全てのテストが通るはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<h2><a id="sec-10_4" href="http://railstutorial.jp/user-microposts.html#sec-10_4" class="heading"><span class="number">10.4</span>最後に</a></h2>


<p>マイクロポストリソースの追加によって、サンプルアプリケーションはもうほとんど終了です。残すところは、ユーザーをお互いにフォローさせるソーシャルレイヤーのみとなりました。<a class="ref" href="http://railstutorial.jp/following-users.html#top">第11章</a>で、そのようなユーザーの関係をどのようにモデリングするのか学び、ステータスフィードへの影響をみます。</p>

<p>次に進む前に、変更をマージしてコミットすることを忘れないでください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add user microposts&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge user-microposts
<span class="gp">$</span> git push
</pre></div>
</div>


<p>この時点で Heroku にアプリを push するのも良いでしょう。<code>microposts</code> テーブルを加えるにあたってデータモデルが変更になったので、プロダクションデータベースをマイグレートさせる必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<div class="label" id="sec-micropost_exercises"></div>


<h2><a id="sec-10_5" href="http://railstutorial.jp/user-microposts.html#sec-micropost_exercises" class="heading"><span class="number">10.5</span>演習</a></h2>


<p>十分な題材をカバーした今、アプリに対して余りある拡張機能が存在します。以下はそのうちのほんのいくつかのものたちです。</p>

<ol>
<li>サイドバーのマイクロポストカウントに対するテストを追加せよ(正しい複数形を用いて)</li>
<li>マイクロポストのページネーションのためのテストを追加せよ。</li>
<li><code>if</code>-<code>else</code> ステートメントの２つのブランチに対してそれぞれ別のパーシャルを使用するようにホームページをリファクタリングせよ。</li>
<li>削除リンクが、現在のユーザーによって作成されていないマイクロポストには表示されないことを確認するためのテストを書け。</li>
<li>パーシャルを使って、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_partial_with_delete">リスト 10.46</a> および <a class="ref" href="http://railstutorial.jp/user-microposts.html#code-feed_item_partial_with_delete">リスト 10.47</a>から削除リンクの重複を削除せよ。</li>
<li><a class="ref" href="http://railstutorial.jp/user-microposts.html#fig-long_word_micropost">図 10.18</a>に示すように、現在とても長い単語を入力するとレイアウトが壊れてしまう。<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-wrap">リスト 10.50</a>で定義した <code>wrap</code> ヘルパーを使ってこの問題を修正せよ。Railsが結果のHTMLをエスケープしてしまうのを防ぐために <code>raw</code> メソッドが使える事、クロスサイトスクリプティング(XSS)を防ぐために <code>sanitize</code> メソッドを使用できる。このコードには、奇妙に見えるかもしれないがとても便利な <em>3項演算子</em> (<a class="ref" href="http://railstutorial.jp/user-microposts.html#sidebar-ternary_operator">囲み 10.1</a>)を使う事も可能。</li>
<li><strong>(チャレンジ)</strong> 140 文字からカウントダウンするための Javascript をホームページに追加せよ。</li>
</ol>




<div class="label" id="sidebar-ternary_operator"></div>


<div class="sidebar"><span class="title"><span class="header">囲み 10.1.</span><span class="description">10種類の人々</span></span>
<p>この世には10種類の人々がいます: 3項演算子を好きな人と、嫌いな人と、それが何かを知らない人です。(もしあなたが３番目のカテゴリに属す人でも心配しないでください。もうすぐそのカテゴリの人ではなくなります。)</p>

<p>あなたがプログラミングの多くを行う時は、すぐに制御フローの最も一般的なものの１つは、次のように書く事だとすぐに学びます。</p>

<pre class="verbatim">  if boolean? 
    do_one_thing 
  else 
    do_something_else 
end</pre>


<p>Ruby や他の言語 (C/C++, Perl, PHP, and Javaを含む) では、これをよりコンパクトな<em>3項演算子</em>と呼ばれる表現で置き換えることができます (3つのパートで構成されるためそのように呼ばれます)。</p>

<pre class="verbatim">  boolean? ? do_one_thing : do_something_else </pre>


<p>また、代入を置き換えるために参考演算子を使用することもできます。</p>

<pre class="verbatim">  if boolean?
    var = foo
  else 
    var = bar
end</pre>


<p>は以下のように書けます。</p>

<pre class="verbatim">  var = boolean? ? foo : bar</pre>


<p>別の一般的な用途は、関数の戻り値として使用することです。</p>

<pre class="verbatim">  def foo
    do_stuff
    boolean? ? &quot;bar&quot; : &quot;baz&quot;
end</pre>


<p>Ruby は暗黙的に関数の最後の式の値を返すので、ここでは <tt>foo</tt> メソッドは <tt>boolean?</tt> の値によって <tt>&quot;bar&quot;</tt> または <tt>&quot;baz&quot;</tt> を返します。これは<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-wrap">リスト 10.50</a>に現れた最終的な構成です。</p>
</div>




<div class="label" id="fig-long_word_micropost"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="http://railstutorial.jp/images/figures/long_word_micropost_bootstrap.png" alt="long_word_micropost_bootstrap" /></span></div><div class="caption"><span class="header">図 10.18: </span><span class="description">非常に長い単語によって崩れたレイアウト <a href="http://railstutorial.org/images/figures/long_word_micropost_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="code-wrap"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 10.50.</span> <span class="description">長い単語をラップさせるヘルパー</span><br /><span class="description"> <code>app/helpers/microposts_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MicropostsHelper</span>

  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sanitize</span><span class="p">(</span><span class="n">raw</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">wrap_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">wrap_long_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
      <span class="n">zero_width_space</span> <span class="o">=</span> <span class="s2">&quot;&amp;#8203;&quot;</span>
      <span class="n">regex</span> <span class="o">=</span> <span class="sr">/.{1,</span><span class="si">#{</span><span class="n">max_width</span><span class="si">}</span><span class="sr">}/</span>
      <span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">)</span> <span class="p">?</span> <span class="n">text</span> <span class="p">:</span> 
                                  <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zero_width_space</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#top">
</a><a class="prev_page" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#top"><span class="number">第9章</span> ユーザーの更新・表示・削除</a><a class="prev_page" href="http://railstutorial.jp/updating-showing-and-deleting-users.html#top">  </a>
  <a class="next_page" href="http://railstutorial.jp/following-users.html#top">
</a><a class="next_page" href="http://railstutorial.jp/following-users.html#top">    <span class="number">第11章</span>ユーザーをフォローする</a><a class="next_page" href="http://railstutorial.jp/following-users.html#top">  </a>
</div><div class="footnotes">
<ol>
<li id="fn-10_1">技術的には、<a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#top">第8章</a>でセッションをリソースとして扱かったが、セッションはユーザーやマイクロポストのようにデータベースには保存されていない。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_1">↑</a></li>
<li id="fn-10_2"><code>content</code> 属性は <code>string</code> になるが、 <a class="ref" href="http://railstutorial.jp/a-demo-app.html#sec-modeling_demo_microposts">2.1.2</a>で簡単に述べたように、より長いテキストフィールドには <code>text</code> データタイプを使用すべきです。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_2">↑</a></li>
<li id="fn-10_3">当初、マイクロポストを適切に複製することを忘れており、事実以前のバージョンのチュートリアルにはバグがあった。セーフティチェックを入れていればエラーが明らかになっていたかもしれない。バグを見つけてくれて、注意を喚起してくれた読者 Jacob Turino に感謝します。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_3">↑</a></li>
<li id="fn-10_4">(すなわち、カスタムGravatarを持った５人のユーザーと、デフォルトGravatarを持った１人のユーザー) <a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_4">↑</a></li>
<li id="fn-10_5">もしこのメソッドが生成するSQLに興味があるなら <code>log/development.log</code> を tail してみてください。 <a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_5">↑</a></li>
<li id="fn-10_6">意図的に、Faker gemの <em>lorem ipsum</em> テキストはランダムになっているので、あなたのサンプルマイクロポストの内容は違っているはずです。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_6">↑</a></li>
<li id="fn-10_7">便宜上、<a class="ref" href="http://railstutorial.jp/user-microposts.html#code-micropost_css">リスト 10.24</a> はこの章で必要な<em>すべての</em>CSSを含んでいます。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_7">↑</a></li>
<li id="fn-10_8">他の２つのリソースとは、<a class="ref" href="http://railstutorial.jp/sign-up.html#sec-signup_form">リスト 7.2</a>のユーザーと<a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#sec-signin_failure">8.1</a>のセッションです。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_8">↑</a></li>
<li id="fn-10_9"><a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#sec-remember_me">8.2.1</a>でデフォルトではヘルパーメソッドは<em>views</em>でのみ利用可能であると注釈しましたが、<code>include SessionsHelper</code>をアプリケーションコントローラーに加えることでコントローラーでも利用可能にしました(<a class="ref" href="http://railstutorial.jp/sign-in-sign-out.html#code-sessions_helper_include">リスト 8.14</a>)。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_9">↑</a></li>
<li id="fn-10_10"><code>include?</code>のようなメソッドを学ぶことが、 <a class="ref" href="http://railstutorial.jp/beginning.html#sec-comments_for_various_readers">1.1.1</a>で述べたように、これを読み終わったら次に純粋なRubyの本を読む事を薦めた理由です。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_10">↑</a></li>
<li id="fn-10_11"><code>where</code> や like についてより詳しくは、Rails Guide の<a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a> を読んでください。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_11">↑</a></li>
<li id="fn-10_12">不運にも、この場合はページ分割されたフィードを返してもうまく動きません。なぜダメなのか確認するには、実装してページネーションリンクをクリックしてみてください。<a class="arrow" href="http://railstutorial.jp/user-microposts.html#fnref-10_12">↑</a></li>
</ol>
</div>




</div>
  </body>
</html>
