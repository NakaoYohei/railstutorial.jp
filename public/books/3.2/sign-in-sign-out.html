<html dir="ltr">
  <head>
    <title>sign-in-sign-out</title>
    <link rel="stylesheet" href="/chapters/pygments.css" type="text/css" />
    <link rel="stylesheet" href="/chapters/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr">
    <div id="book">

<h1 class="title">Ruby on Rails 3.2 チュートリアル</h1>


<h1 class="subtitle">実例を使ってRailsを学ぼう</h1>


<h2 class="author">Michael Hartl (マイケル・ハートル)</h2>




<h2 class="contents">目次</h2>


<div id="table_of_contents"><ol><li class="chapter"><a href="/chapters/beginning.html#top"><span class="number">第1章</span> ゼロから本番展開まで</a></li><li><ol><li class="section"><a href="/chapters/beginning.html#sec-introduction"><span class="number">1.1</span>はじめに</a></li><li><ol><li class="subsection"><a href="/chapters/beginning.html#sec-comments_for_various_readers"><span class="number">1.1.1</span>読者の皆さまへ</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-1_1_2"><span class="number">1.1.2</span> Railsとスケールについて</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-conventions"><span class="number">1.1.3</span>この本における取り決め</a></li></ol></li><li class="section"><a href="/chapters/beginning.html#sec-up_and_running"><span class="number">1.2</span> さっそく動作させる</a></li><li><ol><li class="subsection"><a href="/chapters/beginning.html#sec-development_tools"><span class="number">1.2.1</span>開発環境</a></li><li><ol><li class="subsubsection"><a href="/chapters/beginning.html#sec-1_2_1_1">IDE</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-1_2_1_2">テキストエディタとコマンドライン</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-1_2_1_3">ブラウザ</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-1_2_1_4">使用するツールについて</a></li></ol></li><li class="subsection"><a href="/chapters/beginning.html#sec-rubygems"><span class="number">1.2.2</span>Ruby、RubyGems、Rails、Git</a></li><li><ol><li class="subsubsection"><a href="/chapters/beginning.html#sec-rails_installer_windows">Railsインストーラ (Windows)</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-install_git">Gitのインストール</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-install_ruby">Rubyのインストール</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-install_rubygems">RubyGemsのインストール</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-install_rails">Railsのインストール</a></li></ol></li><li class="subsection"><a href="/chapters/beginning.html#sec-the_first_application"><span class="number">1.2.3</span>最初のアプリケーション</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-bundler"><span class="number">1.2.4</span> Bundler</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-rails_server"><span class="number">1.2.5</span> <tt>rails server</tt></a></li><li class="subsection"><a href="/chapters/beginning.html#sec-mvc"><span class="number">1.2.6</span>Model-view-controller (MVC)</a></li></ol></li><li class="section"><a href="/chapters/beginning.html#sec-version_control"><span class="number">1.3</span>Gitによるバージョン管理</a></li><li><ol><li class="subsection"><a href="/chapters/beginning.html#sec-git_setup"><span class="number">1.3.1</span>インストールとセットアップ</a></li><li><ol><li class="subsubsection"><a href="/chapters/beginning.html#sec-1_3_1_1">初めてのシステム・セットアップ</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-1_3_1_2">初めてのリポジトリ・セットアップ</a></li></ol></li><li class="subsection"><a href="/chapters/beginning.html#sec-adding_and_committing"><span class="number">1.3.2</span>追加とコミット</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-1_3_3"><span class="number">1.3.3</span>Gitのメリット</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-github"><span class="number">1.3.4</span> GitHub</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-git_commands"><span class="number">1.3.5</span>ブランチ (branch)、変更 (edit)、 コミット (commit)、マージ (merge)</a></li><li><ol><li class="subsubsection"><a href="/chapters/beginning.html#sec-git_branch">ブランチ (branch)</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-git_edit">変更 (edit)</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-git_commit">コミット (commit)</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-git_merge">マージ (merge)</a></li><li class="subsubsection"><a href="/chapters/beginning.html#sec-git_push">プッシュ (push)</a></li></ol></li></ol></li><li class="section"><a href="/chapters/beginning.html#sec-deploying"><span class="number">1.4</span>展開する</a></li><li><ol><li class="subsection"><a href="/chapters/beginning.html#sec-heroku_setup"><span class="number">1.4.1</span> Herokuのセットアップ</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-heroku_step_one"><span class="number">1.4.2</span> Herokuに展開する (1)</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-1_4_3"><span class="number">1.4.3</span> Herokuに展開する (2)</a></li><li class="subsection"><a href="/chapters/beginning.html#sec-heroku_commands"><span class="number">1.4.4</span> Heroku コマンド</a></li></ol></li><li class="section"><a href="/chapters/beginning.html#sec-beginning_conclusion"><span class="number">1.5</span> 最後に</a></li></ol></li><li class="chapter"><a href="/chapters/a-demo-app.html#top"><span class="number">第2章</span>デモアプリケーション</a></li><li><ol><li class="section"><a href="/chapters/a-demo-app.html#sec-planning_the_application"><span class="number">2.1</span> アプリの計画</a></li><li><ol><li class="subsection"><a href="/chapters/a-demo-app.html#sec-modeling_demo_users"><span class="number">2.1.1</span>ユーザーのモデル設計</a></li><li class="subsection"><a href="/chapters/a-demo-app.html#sec-modeling_demo_microposts"><span class="number">2.1.2</span>マイクロポストのモデル設計</a></li></ol></li><li class="section"><a href="/chapters/a-demo-app.html#sec-demo_users_resource"><span class="number">2.2</span>Users リソース </a></li><li><ol><li class="subsection"><a href="/chapters/a-demo-app.html#sec-a_user_tour"><span class="number">2.2.1</span>ユーザページを探検する</a></li><li class="subsection"><a href="/chapters/a-demo-app.html#sec-mvc_in_action"><span class="number">2.2.2</span> MVCの挙動</a></li><li class="subsection"><a href="/chapters/a-demo-app.html#sec-weaknesses_of_this_users_resource"><span class="number">2.2.3</span>Users リソースの欠点</a></li></ol></li><li class="section"><a href="/chapters/a-demo-app.html#sec-microposts_resource"><span class="number">2.3</span>Mircroposts リソース</a></li><li><ol><li class="subsection"><a href="/chapters/a-demo-app.html#sec-a_micropost_microtour"><span class="number">2.3.1</span>マイクロポストのページを探検する</a></li><li class="subsection"><a href="/chapters/a-demo-app.html#sec-putting_the_micro_in_microposts"><span class="number">2.3.2</span>マイクロポストを<em>マイクロ</em>にする</a></li><li class="subsection"><a href="/chapters/a-demo-app.html#sec-demo_user_has_many_microposts"><span class="number">2.3.3</span>ユーザーとマイクロポストを<tt>has_many</tt>で関連づける</a></li><li class="subsection"><a href="/chapters/a-demo-app.html#sec-inheritance_hierarchies"><span class="number">2.3.4</span>継承の階層</a></li><li class="subsection"><a href="/chapters/a-demo-app.html#sec-deploying_the_demo_app"><span class="number">2.3.5</span>デモアプリケーションの展開</a></li></ol></li><li class="section"><a href="/chapters/a-demo-app.html#sec-2_4"><span class="number">2.4</span>最後に</a></li></ol></li><li class="chapter"><a href="/chapters/static-pages.html#top"><span class="number">第3章</span>ほぼ静的なページの作成</a></li><li><ol><li class="section"><a href="/chapters/static-pages.html#sec-static_pages"><span class="number">3.1</span>静的ページ</a></li><li><ol><li class="subsection"><a href="/chapters/static-pages.html#sec-truly_static_pages"><span class="number">3.1.1</span>「本当に」静的なページ</a></li><li class="subsection"><a href="/chapters/static-pages.html#sec-static_pages_with_rails"><span class="number">3.1.2</span>Railsによる静的なページ</a></li></ol></li><li class="section"><a href="/chapters/static-pages.html#sec-first_tests"><span class="number">3.2</span>最初のテスト</a></li><li><ol><li class="subsection"><a href="/chapters/static-pages.html#sec-TDD"><span class="number">3.2.1</span>テスト駆動開発</a></li><li class="subsection"><a href="/chapters/static-pages.html#sec-adding_a_page"><span class="number">3.2.2</span>ページの追加</a></li><li><ol><li class="subsubsection"><a href="/chapters/static-pages.html#sec-red">赤 (Red)</a></li><li class="subsubsection"><a href="/chapters/static-pages.html#sec-green">緑 (Green)</a></li><li class="subsubsection"><a href="/chapters/static-pages.html#sec-refactor">リファクタリング</a></li></ol></li></ol></li><li class="section"><a href="/chapters/static-pages.html#sec-slightly_dynamic_pages"><span class="number">3.3</span>ちょっとだけ動的ページ</a></li><li><ol><li class="subsection"><a href="/chapters/static-pages.html#sec-testing_a_title_change"><span class="number">3.3.1</span>タイトル変更をテストする</a></li><li class="subsection"><a href="/chapters/static-pages.html#sec-passing_title_tests"><span class="number">3.3.2</span>タイトルのテストをパスさせる</a></li><li class="subsection"><a href="/chapters/static-pages.html#sec-embedded_ruby"><span class="number">3.3.3</span>組込みRuby</a></li><li class="subsection"><a href="/chapters/static-pages.html#sec-layouts"><span class="number">3.3.4</span>レイアウトを使って重複を解消する</a></li></ol></li><li class="section"><a href="/chapters/static-pages.html#sec-static_pages_conclusion"><span class="number">3.4</span>最後に</a></li><li class="section"><a href="/chapters/static-pages.html#sec-static_pages_exercises"><span class="number">3.5</span>演習</a></li><li class="section"><a href="/chapters/static-pages.html#sec-advanced_setup"><span class="number">3.6</span>高度なセットアップ</a></li><li><ol><li class="subsection"><a href="/chapters/static-pages.html#sec-eliminating_bundle_exec"><span class="number">3.6.1</span><tt>bundle exec</tt>を追放する</a></li><li><ol><li class="subsubsection"><a href="/chapters/static-pages.html#sec-rvm_bundler_integration">RVM Bundler の統合</a></li><li class="subsubsection"><a href="/chapters/static-pages.html#sec-binstubs">binstubオプション</a></li></ol></li><li class="subsection"><a href="/chapters/static-pages.html#sec-guard"><span class="number">3.6.2</span>Guardによるテストの自動化</a></li><li class="subsection"><a href="/chapters/static-pages.html#sec-spork"><span class="number">3.6.3</span>Spork を使ったテストの高速化</a></li><li><ol><li class="subsubsection"><a href="/chapters/static-pages.html#sec-spork_and_guard">GuardにSporkを導入する</a></li></ol></li><li class="subsection"><a href="/chapters/static-pages.html#sec-tests_inside_sublime_text"><span class="number">3.6.4</span>Sublime Text上でテストする</a></li></ol></li></ol></li><li class="chapter"><a href="/chapters/rails-flavored-ruby.html#top"><span class="number">第4章</span> Rails風味のRuby</a></li><li><ol><li class="section"><a href="/chapters/rails-flavored-ruby.html#sec-motivation"><span class="number">4.1</span>動機</a></li><li class="section"><a href="/chapters/rails-flavored-ruby.html#sec-strings_and_methods"><span class="number">4.2</span>文字列(string)とメソッド</a></li><li><ol><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-comments"><span class="number">4.2.1</span>コメント</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-strings"><span class="number">4.2.2</span>文字列</a></li><li><ol><li class="subsubsection"><a href="/chapters/rails-flavored-ruby.html#sec-printing">出力</a></li><li class="subsubsection"><a href="/chapters/rails-flavored-ruby.html#sec-single_quoted_strings">シングルクォート内の文字列</a></li></ol></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-objects_and_message_passing"><span class="number">4.2.3</span>オブジェクトとメッセージ受け渡し</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-method_definitions"><span class="number">4.2.4</span>メソッドの定義</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-back_to_the_title_helper"><span class="number">4.2.5</span> title ヘルパー、再び</a></li></ol></li><li class="section"><a href="/chapters/rails-flavored-ruby.html#sec-other_data_structures"><span class="number">4.3</span>他のデータ構造</a></li><li><ol><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-arrays_and_ranges"><span class="number">4.3.1</span>配列と範囲演算子</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-blocks"><span class="number">4.3.2</span>ブロック</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-hashes_and_symbols"><span class="number">4.3.3</span>ハッシュとシンボル</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-css_revisited"><span class="number">4.3.4</span> CSS、再び</a></li></ol></li><li class="section"><a href="/chapters/rails-flavored-ruby.html#sec-ruby_classes"><span class="number">4.4</span> Ruby におけるクラス</a></li><li><ol><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-constructors"><span class="number">4.4.1</span>コンストラクタ</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-a_class_of_our_own"><span class="number">4.4.2</span>クラス継承</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-modifying_built_in_classes"><span class="number">4.4.3</span>組込みクラスの変更</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-a_controller_class"><span class="number">4.4.4</span>コントローラクラス</a></li><li class="subsection"><a href="/chapters/rails-flavored-ruby.html#sec-a_user_class"><span class="number">4.4.5</span>ユーザークラス</a></li></ol></li><li class="section"><a href="/chapters/rails-flavored-ruby.html#sec-conclusion"><span class="number">4.5</span>最後に</a></li><li class="section"><a href="/chapters/rails-flavored-ruby.html#sec-exercises"><span class="number">4.6</span>演習</a></li></ol></li><li class="chapter"><a href="/chapters/filling-in-the-layout.html#top"><span class="number">第5章</span>レイアウトを作成する</a></li><li><ol><li class="section"><a href="/chapters/filling-in-the-layout.html#sec-structure"><span class="number">5.1</span>構造を追加する</a></li><li><ol><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-adding_to_the_layout"><span class="number">5.1.1</span>ナビゲーション</a></li><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-custom_css"><span class="number">5.1.2</span>BootstrapとカスタムCSS</a></li><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-partials"><span class="number">5.1.3</span>パーシャル (partial)</a></li></ol></li><li class="section"><a href="/chapters/filling-in-the-layout.html#sec-sass_and_the_asset_pipeline"><span class="number">5.2</span>Sass と asset pipleline</a></li><li><ol><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-the_asset_pipeline"><span class="number">5.2.1</span> asset pipeline</a></li><li><ol><li class="subsubsection"><a href="/chapters/filling-in-the-layout.html#sec-5_2_1_1">asset ディレクトリ</a></li><li class="subsubsection"><a href="/chapters/filling-in-the-layout.html#sec-5_2_1_2">マニフェストファイル</a></li><li class="subsubsection"><a href="/chapters/filling-in-the-layout.html#sec-5_2_1_3">プリプロセッサエンジン</a></li><li class="subsubsection"><a href="/chapters/filling-in-the-layout.html#sec-5_2_1_4">プロダクション環境での効率性</a></li></ol></li><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-sass"><span class="number">5.2.2</span>素晴らしい構文を備えたスタイルシート</a></li><li><ol><li class="subsubsection"><a href="/chapters/filling-in-the-layout.html#sec-5_2_2_1">ネスト</a></li><li class="subsubsection"><a href="/chapters/filling-in-the-layout.html#sec-5_2_2_2">変数</a></li></ol></li></ol></li><li class="section"><a href="/chapters/filling-in-the-layout.html#sec-layout_links"><span class="number">5.3</span>レイアウトのリンク</a></li><li><ol><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-route_tests"><span class="number">5.3.1</span> ルートのテスト</a></li><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-rails_routes"><span class="number">5.3.2</span> Railsのルート</a></li><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-named_routes"><span class="number">5.3.3</span>名前付きルート</a></li><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-pretty_rspec"><span class="number">5.3.4</span>Pretty RSpec</a></li></ol></li><li class="section"><a href="/chapters/filling-in-the-layout.html#sec-user_signup"><span class="number">5.4</span>ユーザーのサインアップ：最初のステップ</a></li><li><ol><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-users_controller"><span class="number">5.4.1</span>ユーザーコントローラ</a></li><li class="subsection"><a href="/chapters/filling-in-the-layout.html#sec-signup_url"><span class="number">5.4.2</span>サインアップURI</a></li></ol></li><li class="section"><a href="/chapters/filling-in-the-layout.html#sec-layout_conclusion"><span class="number">5.5</span>最後に</a></li><li class="section"><a href="/chapters/filling-in-the-layout.html#sec-layout_exercises"><span class="number">5.6</span>演習</a></li></ol></li><li class="chapter"><a href="/chapters/modeling-users.html#top"><span class="number">第6章</span>ユーザーのモデルを作成する</a></li><li><ol><li class="section"><a href="/chapters/modeling-users.html#sec-user_model"><span class="number">6.1</span> Userモデル</a></li><li><ol><li class="subsection"><a href="/chapters/modeling-users.html#sec-database_migrations"><span class="number">6.1.1</span>データベースの移行</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-the_model_file"><span class="number">6.1.2</span>modelファイル</a></li><li><ol><li class="subsubsection"><a href="/chapters/modeling-users.html#sec-model_annotation">モデル注釈</a></li><li class="subsubsection"><a href="/chapters/modeling-users.html#sec-accessible_attributes">アクセス可能な属性</a></li></ol></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-creating_user_objects"><span class="number">6.1.3</span>ユーザーオブジェクトを作成する</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-finding_user_objects"><span class="number">6.1.4</span>ユーザーオブジェクトを検索する</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-updating_user_objects"><span class="number">6.1.5</span>ユーザーオブジェクトを更新する</a></li></ol></li><li class="section"><a href="/chapters/modeling-users.html#sec-user_validations"><span class="number">6.2</span>ユーザーを検証する</a></li><li><ol><li class="subsection"><a href="/chapters/modeling-users.html#sec-initial_user_tests"><span class="number">6.2.1</span>最初のユーザーテスト</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-presence_validation"><span class="number">6.2.2</span>プレゼンスを検証する</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-length_validation"><span class="number">6.2.3</span>長さを検証する</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-format_validation"><span class="number">6.2.4</span>フォーマットを検証する</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-uniqueness_validation"><span class="number">6.2.5</span>一意性を検証する</a></li><li><ol><li class="subsubsection"><a href="/chapters/modeling-users.html#sec-the_caveat">一意性の警告</a></li></ol></li></ol></li><li class="section"><a href="/chapters/modeling-users.html#sec-adding_a_secure_password"><span class="number">6.3</span>セキュアなパスワードを追加する</a></li><li><ol><li class="subsection"><a href="/chapters/modeling-users.html#sec-an_encrypted_password"><span class="number">6.3.1</span>暗号化されたパスワード</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-password_and_confirmation"><span class="number">6.3.2</span>パスワードと確認</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-user_authentication"><span class="number">6.3.3</span>ユーザー認証</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-has_secure_password"><span class="number">6.3.4</span>ユーザーがセキュアなパスワードを持っている</a></li><li class="subsection"><a href="/chapters/modeling-users.html#sec-creating_a_user"><span class="number">6.3.5</span>ユーザーを作成する</a></li></ol></li><li class="section"><a href="/chapters/modeling-users.html#sec-6_4"><span class="number">6.4</span>最後に</a></li><li class="section"><a href="/chapters/modeling-users.html#sec-6_5"><span class="number">6.5</span>演習</a></li></ol></li><li class="chapter"><a href="/chapters/sign-up.html#top"><span class="number">第7章</span>ユーザー登録</a></li><li><ol><li class="section"><a href="/chapters/sign-up.html#sec-showing_users"><span class="number">7.1</span>ユーザーを表示する</a></li><li><ol><li class="subsection"><a href="/chapters/sign-up.html#sec-rails_environments"><span class="number">7.1.1</span>デバッグとRails環境</a></li><li class="subsection"><a href="/chapters/sign-up.html#sec-a_users_resource"><span class="number">7.1.2</span>ユーザーリソース</a></li><li class="subsection"><a href="/chapters/sign-up.html#sec-tests_with_factories"><span class="number">7.1.3</span>ファクトリーを使用してユーザー表示ページをテストする</a></li><li class="subsection"><a href="/chapters/sign-up.html#sec-a_gravatar_image"><span class="number">7.1.4</span>gravatar画像とサイドバー</a></li></ol></li><li class="section"><a href="/chapters/sign-up.html#sec-signup_form"><span class="number">7.2</span>ユーザー登録フォーム</a></li><li><ol><li class="subsection"><a href="/chapters/sign-up.html#sec-tests_for_user_signup"><span class="number">7.2.1</span>ユーザー登録のためのテスト</a></li><li class="subsection"><a href="/chapters/sign-up.html#sec-using_form_for"><span class="number">7.2.2</span><tt>form_for</tt>を使用する</a></li><li class="subsection"><a href="/chapters/sign-up.html#sec-the_form_html"><span class="number">7.2.3</span>フォームHTML</a></li></ol></li><li class="section"><a href="/chapters/sign-up.html#sec-signup_failure"><span class="number">7.3</span>ユーザー登録失敗</a></li><li><ol><li class="subsection"><a href="/chapters/sign-up.html#sec-a_working_form"><span class="number">7.3.1</span>正しいフォーム</a></li><li class="subsection"><a href="/chapters/sign-up.html#sec-signup_error_messages"><span class="number">7.3.2</span>ユーザー登録のエラーメッセージ</a></li></ol></li><li class="section"><a href="/chapters/sign-up.html#sec-signup_success"><span class="number">7.4</span>ユーザー登録成功</a></li><li><ol><li class="subsection"><a href="/chapters/sign-up.html#sec-the_finished_signup_form"><span class="number">7.4.1</span>登録フォームの完成</a></li><li class="subsection"><a href="/chapters/sign-up.html#sec-the_flash"><span class="number">7.4.2</span>flash</a></li><li class="subsection"><a href="/chapters/sign-up.html#sec-the_first_signup"><span class="number">7.4.3</span>実際のユーザー登録</a></li><li class="subsection"><a href="/chapters/sign-up.html#sec-deploying_to_production_with_ssl"><span class="number">7.4.4</span> SSLを導入してプロダクション環境を展開する</a></li></ol></li><li class="section"><a href="/chapters/sign-up.html#sec-7_5"><span class="number">7.5</span>最後に</a></li><li class="section"><a href="/chapters/sign-up.html#sec-signup_exercises"><span class="number">7.6</span>演習</a></li></ol></li><li class="chapter"><a href="/chapters/sign-in-sign-out.html#top"><span class="number">第8章</span>サインイン、サインアウト</a></li><li><ol><li class="section"><a href="/chapters/sign-in-sign-out.html#sec-signin_failure"><span class="number">8.1</span>セッション、サインインの失敗</a></li><li><ol><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-sessions_controller"><span class="number">8.1.1</span>Sessionコントローラ</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-signin_tests"><span class="number">8.1.2</span>サインインをテストする</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-signin_form"><span class="number">8.1.3</span>サインインのフォーム</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-reviewing_form_submission"><span class="number">8.1.4</span>確認フォームを送信する</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-rendering_with_a_flash_message"><span class="number">8.1.5</span>フラッシュメッセージをレンダリングする</a></li></ol></li><li class="section"><a href="/chapters/sign-in-sign-out.html#sec-signin_success"><span class="number">8.2、</span>サインイン成功</a></li><li><ol><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-remember_me"><span class="number">8.2.1</span>[このアカウント設定を保存する]</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-a_working_sign_in_method"><span class="number">8.2.2</span>正しい<tt>sign_in</tt>メソッド</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-current_user"><span class="number">8.2.3</span>現在のユーザー</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-changing_the_layout_links"><span class="number">8.2.4</span>レイアウトリンクを変更する</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-signin_upon_signup"><span class="number">8.2.5</span>ユーザー登録と同時にサインインする</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-signing_out"><span class="number">8.2.6</span>サインアウトする</a></li></ol></li><li class="section"><a href="/chapters/sign-in-sign-out.html#sec-cucumber"><span class="number">8.3</span>Cucumberの紹介(オプション)</a></li><li><ol><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-installation_and_setup"><span class="number">8.3.1</span>インストールと設定</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-features_and_steps"><span class="number">8.3.2</span>機能と手順</a></li><li class="subsection"><a href="/chapters/sign-in-sign-out.html#sec-rspec_custom_matchers"><span class="number">8.3.3</span>対比: RSpecのカスタムマッチャー</a></li></ol></li><li class="section"><a href="/chapters/sign-in-sign-out.html#sec-8_4"><span class="number">8.4</span>最後に</a></li><li class="section"><a href="/chapters/sign-in-sign-out.html#sec-sign_in_out_exercises"><span class="number">8.5</span>演習</a></li></ol></li><li class="chapter"><a href="/chapters/updating-showing-and-deleting-users.html#top"><span class="number">第9章</span> ユーザーの更新・表示・削除</a></li><li><ol><li class="section"><a href="/chapters/updating-showing-and-deleting-users.html#sec-updating_users"><span class="number">9.1</span>ユーザーを更新する</a></li><li><ol><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-edit_form"><span class="number">9.1.1</span>編集フォーム</a></li><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-unsuccessful_edits"><span class="number">9.1.2</span>編集の失敗</a></li><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-successful_edits"><span class="number">9.1.3</span>編集の成功</a></li></ol></li><li class="section"><a href="/chapters/updating-showing-and-deleting-users.html#sec-authorization"><span class="number">9.2</span>認証</a></li><li><ol><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-requiring_signed_in_users"><span class="number">9.2.1</span>ユーザーのサインインを要求する</a></li><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-requiring_the_right_user"><span class="number">9.2.2</span>正しいユーザーを要求する</a></li><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-friendly_forwarding"><span class="number">9.2.3</span>フレンドリーフォワーディング</a></li></ol></li><li class="section"><a href="/chapters/updating-showing-and-deleting-users.html#sec-showing_all_users"><span class="number">9.3</span>すべてのユーザーを表示する</a></li><li><ol><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-user_index"><span class="number">9.3.1</span>ユーザーインデックス</a></li><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-sample_users"><span class="number">9.3.2</span>サンプルのユーザー</a></li><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-pagination"><span class="number">9.3.3</span>ページネーション</a></li><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-partial_refactoring"><span class="number">9.3.4</span>部分的リファクタリング</a></li></ol></li><li class="section"><a href="/chapters/updating-showing-and-deleting-users.html#sec-destroying_users"><span class="number">9.4</span>ユーザを削除する</a></li><li><ol><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-administrative_users"><span class="number">9.4.1</span>管理ユーザー</a></li><li><ol><li class="subsubsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-revisiting_attr_accessible"><tt>attr_accessible</tt>属性再び</a></li></ol></li><li class="subsection"><a href="/chapters/updating-showing-and-deleting-users.html#sec-the_destroy_action"><span class="number">9.4.2</span> <tt>destroy</tt>アクション</a></li></ol></li><li class="section"><a href="/chapters/updating-showing-and-deleting-users.html#sec-updating_and_deleting_users_conclusion"><span class="number">9.5</span>最後に</a></li><li class="section"><a href="/chapters/updating-showing-and-deleting-users.html#sec-updating_deleting_exercises"><span class="number">9.6</span>演習</a></li></ol></li><li class="chapter"><a href="/chapters/user-microposts.html#top"><span class="number">第10章</span>ユーザーのマイクロポスト</a></li><li><ol><li class="section"><a href="/chapters/user-microposts.html#sec-a_micropost_model"><span class="number">10.1</span>マイクロポストのモデル</a></li><li><ol><li class="subsection"><a href="/chapters/user-microposts.html#sec-the_basic_model"><span class="number">10.1.1</span>基本的なモデル</a></li><li class="subsection"><a href="/chapters/user-microposts.html#sec-accessible_attribute"><span class="number">10.1.2</span>Accessible属性と最初の検証</a></li><li class="subsection"><a href="/chapters/user-microposts.html#sec-user_micropost_associations"><span class="number">10.1.3</span>User/Micropostの関連付け</a></li><li class="subsection"><a href="/chapters/user-microposts.html#sec-ordering_and_dependency"><span class="number">10.1.4</span>マイクロポストを改良する</a></li><li><ol><li class="subsubsection"><a href="/chapters/user-microposts.html#sec-default_scope">デフォルトのスコープ</a></li><li class="subsubsection"><a href="/chapters/user-microposts.html#sec-dependent_destroy">Dependent: destroy</a></li></ol></li><li class="subsection"><a href="/chapters/user-microposts.html#sec-micropost_validations"><span class="number">10.1.5</span>コンテンツの検証</a></li></ol></li><li class="section"><a href="/chapters/user-microposts.html#sec-showing_microposts"><span class="number">10.2</span>マイクロポストを表示する</a></li><li><ol><li class="subsection"><a href="/chapters/user-microposts.html#sec-augmenting_the_user_show_page"><span class="number">10.2.1</span>ユーザー表示ページの拡張</a></li><li class="subsection"><a href="/chapters/user-microposts.html#sec-sample_microposts"><span class="number">10.2.2</span>マイクロポストのサンプル</a></li></ol></li><li class="section"><a href="/chapters/user-microposts.html#sec-manipulating_microposts"><span class="number">10.3</span>マイクロポストを操作する</a></li><li><ol><li class="subsection"><a href="/chapters/user-microposts.html#sec-access_control"><span class="number">10.3.1</span>アクセス制御</a></li><li class="subsection"><a href="/chapters/user-microposts.html#sec-creating_microposts"><span class="number">10.3.2</span>マイクロポストを作成する</a></li><li class="subsection"><a href="/chapters/user-microposts.html#sec-a_proto_feed"><span class="number">10.3.3</span>フィードの原型</a></li><li class="subsection"><a href="/chapters/user-microposts.html#sec-destroying_microposts"><span class="number">10.3.4</span>マイクロポストを削除する</a></li></ol></li><li class="section"><a href="/chapters/user-microposts.html#sec-10_4"><span class="number">10.4</span>最後に</a></li><li class="section"><a href="/chapters/user-microposts.html#sec-micropost_exercises"><span class="number">10.5</span>演習</a></li></ol></li><li class="chapter"><a href="/chapters/following-users.html#top"><span class="number">第11章</span>ユーザーをフォローする</a></li><li><ol><li class="section"><a href="/chapters/following-users.html#sec-the_relationship_model"><span class="number">11.1</span>Relationshipのモデル</a></li><li><ol><li class="subsection"><a href="/chapters/following-users.html#sec-a_problem_with_the_data_model"><span class="number">11.1.1</span>データモデルの問題 (および解決策)</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-relationship_user_associations"><span class="number">11.1.2</span>User/relationshipの関連付け</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-relationship_validations"><span class="number">11.1.3</span>検証</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-following"><span class="number">11.1.4</span>フォローしているユーザー</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-followers"><span class="number">11.1.5</span>フォローされているユーザー</a></li></ol></li><li class="section"><a href="/chapters/following-users.html#sec-a_web_interface_for_following_and_followers"><span class="number">11.2</span>フォローしているユーザー用のWebインターフェイス</a></li><li><ol><li class="subsection"><a href="/chapters/following-users.html#sec-sample_following_data"><span class="number">11.2.1</span>フォローしているユーザーのサンプルデータ</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-stats_and_a_follow_form"><span class="number">11.2.2</span>統計とフォロー用フォーム</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-following_and_followers_pages"><span class="number">11.2.3</span>「フォローしている」と「フォローされている」のページ</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-a_working_follow_button_the_standard_way"><span class="number">11.2.4</span>[フォローする] ボタン (標準的な方法)</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-a_working_follow_button_with_ajax"><span class="number">11.2.5</span>[フォローする] ボタン (Ajax)</a></li></ol></li><li class="section"><a href="/chapters/following-users.html#sec-the_status_feed"><span class="number">11.3</span>ステータスフィード</a></li><li><ol><li class="subsection"><a href="/chapters/following-users.html#sec-motivation_and_strategy"><span class="number">11.3.1</span>動機と計画</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-a_first_feed_implementation"><span class="number">11.3.2</span>フィードを初めて実装する</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-scopes_subselects_and_a_lambda"><span class="number">11.3.3</span>サブセレクト</a></li><li class="subsection"><a href="/chapters/following-users.html#sec-the_new_status_feed"><span class="number">11.3.4</span>新しいステータスフィード</a></li></ol></li><li class="section"><a href="/chapters/following-users.html#sec-following_conclusion"><span class="number">11.4</span>最後に</a></li><li><ol><li class="subsection"><a href="/chapters/following-users.html#sec-extensions_to_the_sample_application"><span class="number">11.4.1</span>サンプルアプリケーションの機能を拡張する</a></li><li><ol><li class="subsubsection"><a href="/chapters/following-users.html#sec-replies">返信機能</a></li><li class="subsubsection"><a href="/chapters/following-users.html#sec-messaging">メッセージ機能</a></li><li class="subsubsection"><a href="/chapters/following-users.html#sec-follower_notifications">フォロワーの通知</a></li><li class="subsubsection"><a href="/chapters/following-users.html#sec-password_reminders">パスワードリマインダー</a></li><li class="subsubsection"><a href="/chapters/following-users.html#sec-signup_confirmation">ユーザー登録の確認</a></li><li class="subsubsection"><a href="/chapters/following-users.html#sec-rss_feed">RSSフィード</a></li><li class="subsubsection"><a href="/chapters/following-users.html#sec-rest_api">REST API</a></li><li class="subsubsection"><a href="/chapters/following-users.html#sec-search">検索機能</a></li></ol></li><li class="subsection"><a href="/chapters/following-users.html#sec-guide_to_further_resources"><span class="number">11.4.2</span>読み物ガイド</a></li></ol></li><li class="section"><a href="/chapters/following-users.html#sec-following_exercises"><span class="number">11.5</span>演習</a></li></ol></li></ol></div>


<div id="main_content"></div>


<p> <span class="preamble">
</span><span class="preamble"> <span id="foreword">
</span></span><span class="preamble"><span id="foreword"><strong>前書き</strong> </span></span><br /><span class="preamble"><span id="foreword">
</span></span><span class="preamble"><span id="foreword"> </span>
</span><span class="preamble"> </span></p>

<p>私が前にいた会社 (CD Baby) は、かなり早い段階でRuby on Railsに乗り換えたのですが、またPHPに戻ってしまいました (詳細は私の名前をGoogleで検索してみて下さい)。Michael Hartl氏が書いたこの本を強く勧められ、これはやってみなければ、と試した結果、私が再びRailsに乗り換えるに至ったのがこの<em>Ruby on Railsチュートリアル</em>です。</p>

<p>私は多数のRails本を参考にしてきましたが、真の決定版と呼べるものは本書をおいて他にありません。本書ではあらゆる手順が文字通りRails流 (“Rails way”は railway にかけている) で行われており、最初はなかなか慣れませんでしたが、この本を終えた今、ついにこれこそが自然な方式だと感じられるまでになりました。また、本書はRails本の中で唯一、多くのプロが推奨するテスト駆動開発 (TDD: Test Driven Development) 方式を全編を通して実践していて、非常に分かりやすく解説されています。極めつけは、Git、GitHub、そしてHerokuまでも実例に含めた事で、チュートリアルのコード例など実際のプロジェクトの開発プロセスまでも体験できるようになっていることです。チュートリアルのコード例は、どれもチュートリアルと見事に一体化しています。</p>

<p>本書は全体が筋道だったストーリーに貫かれており、非常に素晴らしいものです。私自身、3日間かけて章の終わりにある練習問題もやりながら<em>Railsチュートリアル</em>を一気に読破しました。最初から最後まで、途中を飛ばさずにやるのが一番効果的で有益な読み方です。ぜひやってみて下さい。</p>

<p>是非お試しください。</p>

<p>デレック・シバーズ (<a href="http://sivers.org/">Derek Sivers</a>) (<a href="http://sivers.org/">sivers.org</a>)<br />
<em>元: <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> (創始者)</em> <br />
<em>現在: <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> (創始者) </em> <br /></p>

<p> <span class="preamble">
</span><span class="preamble"><strong>謝辞</strong> </span><br /><span class="preamble">
</span><span class="preamble"> </span></p>

<p><em>Ruby on Rails チュートリアル</em>は、私の以前の著書<em>RailsSpace</em>と、その時の共著者の<a href="http://aure.com/">Aurelius Prochazka</a>に多くを負っています。Aureには、RailsSpaceでの協力と本書への支援も含め、感謝したいと思います。また、<em>RailsSpace</em>と<em>Rails チュートリアル</em>両方の編集を担当して頂いたDebra Williams Cauley氏にも謝意を表したく思います。</p>

<p>私にインスピレーションと知識を与えてくれたRubyistの方々にも感謝したいと思います:David Heinemeier Hansson、 Yehuda Katz、 Carl Lerche、 Jeremy Kemper、 Xavier Noria、 Ryan Bates、 Geoffrey Grosenbach、 Peter Cooper、 Matt Aimonetti、 Gregg Pollack、 Wayne E. Seguin、 Amy Hoy、 Dave Chelimsky、 Pat Maddox、 Tom Preston-Werner、 Chris Wanstrath、 Chad Fowler、 Josh Susser、 Obie Fernandez、 Ian McFarland、 Steven Bristol、 Pratik Naik、 Sarah Mei、 Sarah Allen、 Wolfram Arnold、 Alex Chaffee、 Giles Bowkett、 Evan Dorn、 Long Nguyen、 James Lindenbaum、 Adam Wiggins、 Tikhon Bernstam、 Ron Evans、 Wyatt Greene、 Miles Forrest、 Pivotal Labsの方々、 Herokuの方々、 thoughtbotの方々、 そしてGitHubチーム。最後に、ここに書ききれないほど多くの読者の方々から執筆中にバグ報告や提案を頂き、本書をできる限り良いものにするのに大変役立ちました。<br /></p>

<p> <span class="preamble">
</span><span class="preamble"> <span id="author">
</span></span><span class="preamble"><span id="author"><strong>著者</strong> </span></span><br /><span class="preamble"><span id="author">
</span></span><span class="preamble"><span id="author"> </span>
</span><span class="preamble"> </span></p>

<p><a href="http://michaelhartl.com/">マイケル・ハートル (Michael Hartl)</a> は、<a href="http://ruby.railstutorial.org/"><em>Ruby on Rails</em></a>を使用したweb開発を手ほどきする教材として有名な<a href="http://rubyonrails.org/">Ruby on Rails チュートリアル</a>の著者です。(今ではすっかり古くなってしまいましたが) Railsのチュートリアル本である<em>RailsSpace</em>の著述と開発に携わったことがあり、 一時人気を博したRuby on RailsベースのソーシャルネットワーキングプラットフォームInsoshiも開発していました。2011年、マイケルはRailsコミュニティへの貢献が認められて<a href="http://rubyheroes.com/heroes">Ruby Hero Award</a>を受賞しました。<a href="http://college.harvard.edu/">ハーバード大学</a>卒業後 、<a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">カリフォルニア工科大学</a>で<a href="http://www.caltech.edu/">物理学博士号</a>を取得し、起業プログラム<a href="http://ycombinator.com/">Y Combinator</a>の卒業生でもあります。<br /></p>

<p> <span id="license" class="preamble">
</span><span id="license" class="preamble"><strong>著作権とライセンス</strong> </span><br /><span id="license" class="preamble">
</span><span id="license" class="preamble"> </span></p>

<p><em>Ruby on Rails チュートリアル: 実例を使ってRailsを学ぼう</em>Copyright © 2010 by Michael Hartl.<em>Ruby on Rails チュートリアル</em>内のすべてのソースコードは<a href="http://www.opensource.org/licenses/mit-license.php">MITライセンス</a>および<a href="http://people.freebsd.org/~phk/">Beerwareライセンス</a> の元で提供されています。</p>

<div class="code"><div class="highlight"><pre>(The MIT License)
Copyright (c) 2012 Michael Hartl
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</br>FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHERLIABILITY, </br>WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISINGOUT OF OR </br>IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS INTHE SOFTWARE.</pre></div>
</div>


<div class="code"><div class="highlight"><pre>/*
 * ----------------------------------------------------------------------------
 * &quot;THE BEER-WARE LICENSE&quot; (Revision 42):
 * Michael Hartl wrote this code.As long as you retain this notice you
 * can do whatever you want with this stuff. If we meet some day, and you think
 * this stuff is worth it, you can buy me a beer in return.
 * ----------------------------------------------------------------------------
 */
</pre></div>
</div>


<div id="top"></div>


<h1 class="chapter"><a id="sec-8" href="/chapters/sign-in-sign-out.html#top" class="heading"><span class="number">第8章</span>サインイン、サインアウト</a></h1>


<p><a href="/chapters/sign-up.html#top" class="ref">Chapter 7</a>で、我々のサイトは新規ユーザーが登録できるようになっています。次はユーザーがサインインとサインアウトが出来るようにしましょう。現在のユーザーの認証やサインインステータスによる、変化をアプリに加えることができます。例として、この章では、サイトのヘッダー部分に、サインイン／サインアウトのリンクとプロフィールへのリンクを表示するようにします。<a href="/chapters/user-microposts.html#top" class="ref">Chapter 10</a>では、私達はサインインしたユーザーの認証を用いて、そのユーザーに関連したマイクロポストを作成します。また<a href="/chapters/following-users.html#top" class="ref">Chapter 11</a>では現在のユーザーが他のユーザーをフォローして、マイクロポストのフィードを受け取ることが出来るようにします。</p>

<p>ユーザーがサインインすることでセキュリティモデルを実装し、サインインしているユーザーの認証に基づいて、特定のページへのアクセスを制限することができます。たとえば、<a href="/chapters/updating-showing-and-deleting-users.html#top" class="ref">Chapter 9</a>でも出てきますが、サインインしたユーザーのみがユーザー情報編集ページにアクセスすることが出来るようにします。サインインの仕組みは、また、特別な権限を管理者ユーザーに与えることもできます。例えば  (<a href="/chapters/updating-showing-and-deleting-users.html#top" class="ref">Chapter 9</a>で導入する) データベースからユーザーを削除する機能が挙げられます。</p>

<p>コアとなる認証機能を実装した後は、ちょっと遠回りして、ビヘヴィア駆動開発 (<a class="ref" href="/chapters/sign-in-sign-out.html#sec-cucumber">8.3</a>) で有名なツールの<em>Cucumber</em>を試してみましょう。特に、2つの手法の比較を確認するために、RSpecによる統合テストの組み合わせをCucumberで再実装します。</p>

<p>前章同様に、トピックブランチで作業してから、最後に更新をマージします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b sign-in-out
</pre></div>
</div>


<div class="label" id="sec-signin_failure"></div>


<h2><a id="sec-8_1" href="/chapters/sign-in-sign-out.html#sec-signin_failure" class="heading"><span class="number">8.1</span>セッション、サインインの失敗</a></h2>


<p><a href="http://en.wikipedia.org/wiki/Session_(computer_science)"><em>セッション</em></a>は、２つのコンピュータの間、たとえばクライアント側のブラウザとサーバーで稼働しているRailsとの間の、半永続的な接続です。ここでは”サインイン”の共通パターンを実装するためにセッションを用います。さて、Webの世界ではセッションの振る舞いを表現するためのいくつかの異なったモデルがあります。“forgetting” the session on browser close, using an optional “remember me” checkbox for persistent sessions, and automatically remembering sessions until the user explicitly signs out.<sup id="fnref-8_1" class="footnote"><a href="/chapters/sign-in-sign-out.html#fn-8_1">1</a></sup> または、次のようにすることもできます。ユーザーがサインインしたとき、ユーザーのステータスを”永久に”記憶しておいて、ユーザーが明示的にサインアウトしたときのみ、セッションを消去するようにします。(<a href="/chapters/sign-in-sign-out.html#sec-remember_me" class="ref">Section 8.2.1</a> では “永久に” が実際どれくらいなのかをお見せします。)</p>

<p>セッションはRESTfulなリソースとして作成することで使いやすくなります。それは、<em>新しい</em>セッションを生成するためのサインインページや、セッションを生成するサインイン・アクション、セッションを破棄するサインアウト・アクションなどです。Usersのようなデータベースを用いるリソースとは異なり、セッションはクッキーを使います。クッキーとはユーザーのブラウザに保管される小さなテキストデータです。サインインに関連する作業の大半は、このクッキー・ベースの認証の仕組みを構築することになります。このパートと次のパートでは、セッション機能を作成する準備として、セッション・コントローラ、サインインのためのフォーム、および関連したコントローラのアクションを作成します。次に<a href="/chapters/sign-in-sign-out.html#sec-signin_success" class="ref">Section 8.2</a>では、クッキー管理のために必要なコードを追加して、ユーザーがサインインするための仕組みを完成させます。 </p>

<div class="label" id="sec-sessions_controller"></div>


<h3><a id="sec-8_1_1" href="/chapters/sign-in-sign-out.html#sec-sessions_controller" class="heading"><span class="number">8.1.1</span> Session コントローラ</a></h3>


<p>サインインとサインアウトの要素はSession コントローラのRESTアクションに対応します。サインインのフォームは、このセクションにある<code>new</code>アクションで処理されます。実際のサインイン処理は、<code>create</code> アクションに<tt>POST</tt>リクエストが送られた時に処理されます (<a href="/chapters/sign-in-sign-out.html#sec-signin_failure" class="ref">Section 8.1</a> and <a href="/chapters/sign-in-sign-out.html#sec-signin_success" class="ref">Section 8.2</a>) 。サインアウトは、<code>destroy</code> アクションに<tt>DELETE</tt> リクエストを送ることで処理されます(<a href="/chapters/sign-in-sign-out.html#sec-signing_out" class="ref">Section 8.2.6</a>)。(<a href="/chapters/sign-up.html#table-RESTful_users" class="ref">Table 7.1</a>のHTTPメソッドとRESTアクションの関係を思い出してください。) 最初に、Session コントローラと認証の仕組みをテストする結合テストを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions --no-test-framework
<span class="gp">$</span> rails generate integration_test authentication_pages
</pre></div>
</div>


<p><a href="/chapters/sign-up.html#sec-signup_form" class="ref">Section 7.2</a>で作ったサインアップページのモデルを元に、新しいセッションを確立するためのフォームを仮作成で作ります (<a href="/chapters/sign-in-sign-out.html#fig-signin_mockup" class="ref">Figure 8.1</a>) 。</p>

<div class="label" id="fig-signin_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/signin_mockup_bootstrap.png" alt="signin_mockup_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.1: </span><span class="description">仮作成のサインイン・フォーム. <a href="http://railstutorial.org/images/figures/signin_mockup_bootstrap-full.png">(full size)</a></span></div></div>


<p>このサインインページを<code>signin_path</code>という仮のURLに置いておいてから、<a href="/chapters/sign-in-sign-out.html#code-new_session_tests" class="ref">Listing 8.1</a>にある最小限のテストをいつもどおり始めてください。(<a href="/chapters/sign-up.html#code-initial_signup_test" class="ref">Listing 7.6</a>にあるサインアップ・ページのコードがよく似ているので比較してみてください。)</p>

<div class="label" id="code-new_session_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.1.</span> <span class="description">session の <code>new</code> アクションとビューのテスト </span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signin page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次を実行してください（最初はテストに失敗します（。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p><a href="/chapters/sign-in-sign-out.html#code-new_session_tests" class="ref">Listing 8.1</a>のテストを通すために、Sessionリソースのルーティングを定義することが必要です。サインインページは独自の名前でルーティングされていて、Session コントローラの<code>new</code>アクションと対応しています。Usersリソースと同様に、通常のRestfulなルーティングを設定するために、<code>resources</code>メソッドを使うことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</pre></div>
</div>


<p>セッションを編集したり、ユーザーに見せたりする必要がないので、<code>resources</code>メソッドに<code>:only</code>オプションをつけることで、<code>new</code>、<code>create</code>、<code>destroy</code> の３つのアクションのみ有効にします。サインインとサインアウトのためのルーティングを含むコード全体は<a href="/chapters/sign-in-sign-out.html#code-sessions_resource" class="ref">Listing 8.2</a>で見ることができます。</p>

<div class="label" id="code-sessions_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.2.</span> <span class="description">標準のRESTfulアクションを設定するために resource を追加</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;users#new&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signin&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;sessions#new&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signout&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;sessions#destroy&#39;</span><span class="p">,</span> <span class="ss">via:</span> <span class="ss">:delete</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>注：サインアウトのルーティングにある <code>via: :delete</code> はこのアクションが HTTPのDELETEリクエストによって呼び出されることを示しています。</p>

<p><a href="/chapters/sign-in-sign-out.html#code-sessions_resource" class="ref">Listing 8.2</a>で定義されたresourceは、<a href="/chapters/sign-in-sign-out.html#table-RESTful_sessions" class="ref">Table 8.1</a>にあるURIとアクションを提供します ( <a href="/chapters/sign-up.html#table-RESTful_users" class="ref">Table 7.1</a> によく似ています) 。 注：サインインとサインアウトのアクションのルーティングはカスタムで設定しますが、セッションの生成アクションへのルーティングはデフォルトを使います (<code>[resource name]_path</code>).</p>

<div class="label" id="table-RESTful_sessions"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>Named route</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>目的</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/signin</td><td class="align_left"><code>signin_path</code></td><td class="align_left"><code>new</code></td><td class="align_left">page for  a new session (signin)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/sessions</td><td class="align_left"><code>sessions_path</code></td><td class="align_left"><code>create</code></td><td class="align_left">create a new session</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/signout</td><td class="align_left"><code>signout_path</code></td><td class="align_left"><code>destroy</code></td><td class="align_left">delete a session (sign out)</td></tr></table></div><div class="caption"><span class="header">Table 8.1: </span><span class="description">RESTful routes provided by the sessions rules in <a class="ref" href="/chapters/sign-in-sign-out.html#code-sessions_resource">Listing 8.2</a>.</span></div></div>


<p>次は<a href="/chapters/sign-in-sign-out.html#code-new_session_tests" class="ref">Listing 8.1</a>のテストをパスするように<code>new</code>アクションをSessions コントローラに加えます。<a href="/chapters/sign-in-sign-out.html#code-new_session_title" class="ref">Listing 8.3</a>を参照してください (あとで使えるよう<code>create</code>アクションと<code>destroy</code>アクションも定義します) 。</p>

<div class="label" id="code-new_session_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.3.</span> <span class="description">最初の Sessions コントローラ. </span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>最後は、サインインページの最初のバージョンを定義することです。 新規セッションページであるサインインページを、<code>app/views/sessions/new.html.erb</code>に作ります。<a href="/chapters/sign-in-sign-out.html#code-initial_signin_page" class="ref">リスト 8.4</a>にあるように、今のところは、タイトルと一番上のヘッダ部分のみを定義します。</p>

<div class="label" id="code-initial_signin_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 8.4.</span> <span class="description">最初のサインインビュー</span><br /><span class="description"> <code>app/views/sessions/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>これにより、<a href="/chapters/sign-in-sign-out.html#code-new_session_tests" class="ref">リスト 8.1</a>のテストが青信号になります。これで実際のサインインフォームを作成する準備ができたことになります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-signin_tests"></div>


<h3><a id="sec-8_1_2" href="/chapters/sign-in-sign-out.html#sec-signin_tests" class="heading"><span class="number">8.1.2</span>サインインをテストする</a></h3>


<p><a href="/chapters/sign-in-sign-out.html#fig-signin_mockup" class="ref">図 8.1</a>と<a href="/chapters/sign-up.html#fig-signup_mockup" class="ref">図 7.11</a>を比べてみると、サインインフォーム（新規セッションフォーム）の見かけは、4つあったフィールドの代わりにemail欄とpassword欄の2つがあること以外は、サインアップフォームによく似ていることに気づくでしょう。 サインアップフォームと同様にカピバラを使って、フォーム値を埋め、ボタンをクリックするテストをサインインフォームでも実施できます。</p>

<p>テストを書く中で、私たちはアプリケーションのさまざまな角度から設計することを強いられます。これはテスト駆動開発のとてもよい副作用です。<a href="/chapters/sign-in-sign-out.html#fig-signin_failure_mockup" class="ref">Figure 8.2</a>のモックのように、最初はサインインの入力に誤りがあった場合から作ります。</p>

<div class="label" id="fig-signin_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/signin_failure_mockup_bootstrap.png" alt="signin_failure_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図 8.2: </span><span class="description">サインイン失敗時のモックアップ. <a href="http://railstutorial.org/images/figures/signin_failure_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a href="/chapters/sign-in-sign-out.html#fig-signin_failure_mockup" class="ref">図 8.2</a>にあるように、サインインで入力した情報に誤りがあったときは、サインインページをもう一度表示して、エラーメッセージを出します。エラーをフラッシュ・メッセージとして表示するときには、次のようなテストができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>(<a href="/chapters/sign-up.html#top" class="ref">7</a>章の<a href="/chapters/sign-up.html#code-after_save_tests" class="ref">リスト 7.32</a>のコードによく似ていることがわかると思います。) セレクター要素（タグのこと）は以下を指定します。</p>

<div class="code"><div class="highlight"><pre><span class="n">div</span><span class="o">.</span><span class="n">alert</span><span class="o">.</span><span class="n">alert</span><span class="o">-</span><span class="n">error</span>
</pre></div>
</div>


<p>上にあるドットはCSSのクラスを意味することを思い出してください (<a href="/chapters/filling-in-the-layout.html#sec-custom_css" class="ref">Section 5.1.2</a>) 。ということは、このテストは<code>&quot;alert&quot;</code>と<code>&quot;alert-error&quot;</code>というクラスである<code>div</code>タグを対象にしていることが分かります。<code>&quot;Invalid&quot;</code>という単語が含まれるエラーメッセージは、何度もテストされます。それらをまとめてテストするため、次のフォームのようなエレメントが入っていることをテストします。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>Invalid...<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p><a href="/chapters/sign-in-sign-out.html#code-initial_failing_signin_test" class="ref">リスト 8.5</a>のコードで、タイトルとフラッシュ・メッセージはまとめてテストします。次にあるテストは、実はある重要な点を欠いています。それについては<a href="/chapters/sign-in-sign-out.html#sec-rendering_with_a_flash_message" class="ref">8.1.5 節</a>で扱います.</p>

<div class="label" id="code-initial_failing_signin_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.5.</span> <span class="description">サインイン失敗時のテスト</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>サインインに失敗した時のテストを書いたので、次はサインインに成功した場合を作りましょう。ユーザー・プロファイル・ページが表示されること（ページタイトルがユーザー名になっている）、サイトのナビゲーションに次の3つの変更が加わっていることを確認するようテストを変更します。</p>

<ol>
<li>プロファイル・ページヘのリンクの表示</li>
<li>「Sign out」リンクの表示</li>
<li>「Sign in」リンクの表示</li>
</ol>


<p>(「Settings」リンクと「Users」リンクのテストは <a href="/chapters/updating-showing-and-deleting-users.html#sec-showing_all_users" class="ref">Section 9.3</a> で行います) これらの変更を加えたモックアップは<a href="/chapters/sign-in-sign-out.html#fig-signin_success_mockup" class="ref">図 8.3</a>を参照してください。<sup id="fnref-8_2" class="footnote"><a href="/chapters/sign-in-sign-out.html#fn-8_2">2</a></sup> サインアウトとプロファイル・ページヘのリンクは、「アカウント」メニューにドロップダウンで表示されます。<a href="/chapters/sign-in-sign-out.html#sec-changing_the_layout_links" class="ref">8.2.4 節</a>ではドロップダウン・メニューをBootstrapを使ってどのようにつくるかを紹介します。</p>

<div class="label" id="fig-signin_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/signin_success_mockup_bootstrap.png" alt="signin_success_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図 8.3: </span><span class="description">サインインに成功後表示されるユーザー・プロファイルのモックアップ。 <a href="http://railstutorial.org/images/figures/signin_success_mockup_bootstrap-full.png">(拡大表示)</a></span></div></div>


<p>サインインに成功したときのテストコードは<a href="/chapters/sign-in-sign-out.html#code-signin_success_tests" class="ref">リスト 8.6</a>を参照してください。</p>

<div class="label" id="code-signin_success_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 8.6.</span> <span class="description">サインインに成功したときのテスト</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここで<code>have_link</code>メソッドをつかいます. このメソッドは、リンクテキストを引数にとります。また、オプションとして、次のように<code>:href</code>パラメータを加えることで、</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>アンカータグ <code>a</code> に <code>href</code> (URI) 属性をつけることもできます（この例では、ユーザー・プロファイルへのリンク）。Note also that we take care to <code>upcase</code> the user’s email address to make sure our ability to find the user in the database is case-insensitive.</p>

<div class="label" id="sec-signin_form"></div>


<h3><a id="sec-8_1_3" href="/chapters/sign-in-sign-out.html#sec-signin_form" class="heading"><span class="number">8.1.3</span>サインインのフォーム</a></h3>


<p>テストを用意したので、いよいよサインイン・フォームの開発をはじめることにしましょう。<a href="/chapters/sign-up.html#code-signup_form" class="ref">リスト 7.17</a>では、サインアップフォームで <code>form_for</code> ヘルパーをつかい、Userのインスタンス変数 <code>@user</code> を引数にとっていました。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
end
</pre></div>
</div>


<p>このサインアップ・フォームとサインイン・フォームの主な違いは、セッション・モデルがないために、 <code>@user</code> 変数のような存在がないことです。 このことが意味するのは、新しいセッション・フォームをつくるとき、 <code>form_for</code> ヘルパーに、少しばかり追加の情報を渡す必要があるということです。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>Rails では上記のフォームのアクションは URI /users への  <tt>POST</tt> だと判別されますが、Sessionの場合は、リソースの<em>名前と</em>対応するURIを指定する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span>
</pre></div>
</div>


<p>(他のやり方としては <code>form_for</code> の代わりに <code>form_tag</code> を使うこともでき、こちらのほうがRailsでは慣用的なやり方です。しかし、サインアップ・フォームにおいては  <code>form_for</code> の方が一般的ですし、並列構造を強調したかったので <code>form_for</code> を用いました。(\<code>form_tag</code>を使ったフォームについては(<a href="/chapters/sign-in-sign-out.html#sec-sign_in_out_exercises" class="ref">8.5</a>)の演習として残してあります。)</p>

<p><code>form_for</code> 適切に用いることで、 <a href="/chapters/sign-in-sign-out.html#fig-signin_mockup" class="ref">図 8.1</a>に示されたモックアップに対応するサインインフォームを作ることは簡単になります。(<a href="/chapters/sign-up.html#code-signup_form" class="ref">リスト 7.17</a>) のサインアップフォームをモデルに作っています。コードは<a href="/chapters/sign-in-sign-out.html#code-signin_form" class="ref">リスト 8.7</a> を参照してください。</p>

<div class="label" id="code-signin_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 8.7.</span> <span class="description">サインイン・フォームのコード</span><br /><span class="description"> <code>app/views/sessions/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    end

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>利便性のためにサインアップページのリンクを追加してあることに注意してください。<a href="/chapters/sign-in-sign-out.html#code-signin_form" class="ref">リスト 8.7</a> のコードで生成されるサインイン・フォームは <a href="/chapters/sign-in-sign-out.html#fig-signin_form" class="ref">図 8.4</a> になります.</p>

<div class="label" id="fig-signin_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/signin_form_bootstrap.png" alt="signin_form_bootstrap" /></span></div><div class="caption"><span class="header">図 8.4: </span><span class="description">サインイン・フォーム  (<a href="http://localhost:3000/signin">/signin</a>). <a href="http://railstutorial.org/images/figures/signin_form_bootstrap-full.png">(拡大画像)</a></span></div></div>


<p>しかし、あなたはすぐにRailsの生成したHTMLを確認する習慣を捨てて、ヘルパーがきちんと動作することを信頼することになるでしょう。さあ、 (<a href="/chapters/sign-in-sign-out.html#code-signin_form_html" class="ref">リスト 8.8</a>)をご覧ください.</p>

<div class="label" id="code-signin_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 8.8.</span> <span class="description"><a href="/chapters/sign-in-sign-out.html#code-signin_form" class="ref">リスト 8.7</a> で生成されたサインイン・フォームのHTML.</span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">&quot;UTF-8&quot;</span> <span class="na">action=</span><span class="s">&quot;/sessions&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_email&quot;</span> <span class="na">name=</span><span class="s">&quot;session[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_password&quot;</span> <span class="na">name=</span><span class="s">&quot;session[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> 
           <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> 
       <span class="na">value=</span><span class="s">&quot;Sign in&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p><a href="/chapters/sign-in-sign-out.html#code-signin_form_html" class="ref">リスト 8.8</a> と <a href="/chapters/sign-up.html#code-signup_form_html" class="ref">リスト 7.20</a> を比較することで、フォーム送信後に <code>params</code> のハッシュに入る値が、email と password のフィールドに対応した、<code>params[:session][:email]</code> と <code>params[:session][:password]</code> になると、想像がつくでしょう。</p>

<div class="label" id="sec-reviewing_form_submission"></div>


<h3><a id="sec-8_1_4" href="/chapters/sign-in-sign-out.html#sec-reviewing_form_submission" class="heading"><span class="number">8.1.4</span>確認フォームを送信する</a></h3>


<p>As in the case of creating users (signup), the first step in creating sessions (signin) is to handle <em>invalid</em> input. We already have tests for the signup failure (<a class="ref" href="/chapters/sign-in-sign-out.html#code-initial_failing_signin_test">Listing 8.5</a>), and the application code is simple apart from a couple of subtleties. We’ll start by reviewing what happens when a form gets submitted, and then arrange for helpful error messages to appear in the case of signin failure (as mocked up in <a class="ref" href="/chapters/sign-in-sign-out.html#fig-signin_failure_mockup">Figure 8.2</a>.) Then we’ll lay the foundation for successful signin (<a class="ref" href="/chapters/sign-in-sign-out.html#sec-signin_success">Section 8.2</a>) by evaluating each signin submission based on the validity of its email/password combination.</p>

<p>Let’s start by defining a minimalist <code>create</code> action for the Sessions controller (<a class="ref" href="/chapters/sign-in-sign-out.html#code-initial_create_session">Listing 8.9</a>), which does nothing but render the <code>new</code> view. Submitting the <a href="http://localhost:3000/sessions/new">/sessions/new</a> form with blank fields then yields the result shown in <a class="ref" href="/chapters/sign-in-sign-out.html#fig-initial_failed_signin_rails_3">Figure 8.5</a>.</p>

<div class="label" id="code-initial_create_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.9.</span> <span class="description">A preliminary version of the Sessions <code>create</code> action. </span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig-initial_failed_signin_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/initial_failed_signin_rails_3_bootstrap.png" alt="initial_failed_signin_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.5: </span><span class="description">The initial failed signin, with <code>create</code> as in <a class="ref" href="/chapters/sign-in-sign-out.html#code-initial_create_session">Listing 8.9</a>. <a href="http://railstutorial.org/images/figures/initial_failed_signin_rails_3_bootstrap-full.png">(full size)</a></span></div></div>


<p>Carefully inspecting the debug information in <a class="ref" href="/chapters/sign-in-sign-out.html#fig-initial_failed_signin_rails_3">Figure 8.5</a> shows that, as hinted at the end of <a class="ref" href="/chapters/sign-in-sign-out.html#sec-signin_form">Section 8.1.3</a>, the submission results in a <code>params</code> hash containing the email and password under the key <code>:session</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sign in</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div>
</div>


<p>As with the case of user signup (<a class="ref" href="/chapters/sign-up.html#fig-signup_failure_rails_3">Figure 7.15</a>) these parameters form a <em>nested</em> hash like the one we saw in <a class="ref" href="/chapters/rails-flavored-ruby.html#code-nested_hashes">Listing 4.6</a>. In particular, <code>params</code> contains a nested hash of the form</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">session:</span> <span class="p">{</span> <span class="ss">password:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>


<p>
This means that</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div>
</div>


<p>is itself a hash:</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">password:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
</pre></div>
</div>


<p>As a result,</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div>
</div>


<p>is the submitted email address and</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div>
</div>


<p>is the submitted password.</p>

<p>In other words, inside the <code>create</code> action the <code>params</code> hash has all the information needed to authenticate users by email and password. Not coincidentally, we already have exactly the methods we need: the <code>User.find_by_email</code> method provided by Active Record (<a class="ref" href="/chapters/modeling-users.html#sec-finding_user_objects">Section 6.1.4</a>) and the  <code>authenticate</code> method provided by <code>has_secure_password</code> (<a class="ref" href="/chapters/modeling-users.html#sec-user_authentication">Section 6.3.3</a>). Recalling that <code>authenticate</code> returns <code>false</code> for an invalid authentication, our strategy for user signin can be summarized as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="c1"># Sign the user in and redirect to the user&#39;s show page.</span>
  <span class="k">else</span>
    <span class="c1"># Create an error message and re-render the signin form.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The first line here pulls the user out of the database using the submitted email address. (Recall from <a class="ref" href="/chapters/modeling-users.html#sec-uniqueness_validation">Section 6.2.5</a> that email addresses are saved as all lower-case, so here we use the <code>downcase</code> method to ensure a match when the submitted address is valid.) The next line can be a bit confusing but is fairly common in idiomatic Rails programming:</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>This uses <code>&amp;&amp;</code> (logical <em>and</em>) to determine if the resulting user is valid. Taking into account that any object other than <code>nil</code> and <code>false</code> itself is <code>true</code> in a boolean context (<a class="ref" href="/chapters/rails-flavored-ruby.html#sec-objects_and_message_passing">Section 4.2.3</a>), the possibilities appear as in <a class="ref" href="/chapters/sign-in-sign-out.html#table-user_and_and">Table 8.2</a>. We see from <a class="ref" href="/chapters/sign-in-sign-out.html#table-user_and_and">Table 8.2</a> that the <code>if</code> statement is <code>true</code> only if a user with the given email both exists in the database and has the given password, exactly as required.</p>

<div class="label" id="table-user_and_and"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>User</strong></th><th class="align_left"><strong>Password</strong></th><th class="align_left"><strong>a &amp;&amp; b</strong></th></tr><tr class="top_bar"><td class="align_left">nonexistent</td><td class="align_left"><em>anything</em></td><td class="align_left"><code>nil &amp;&amp; [anything] == false</code></td></tr><tr><td class="align_left">valid user</td><td class="align_left">wrong password</td><td class="align_left"><code>true &amp;&amp; false == false</code></td></tr><tr><td class="align_left">valid user</td><td class="align_left">right password</td><td class="align_left"><code>true &amp;&amp; true == true</code></td></tr></table></div><div class="caption"><span class="header">Table 8.2: </span><span class="description">Possible results of <code>user &amp;&amp; user.authenticate(…)</code>.</span></div></div>




<div class="label" id="sec-rendering_with_a_flash_message"></div>


<h3><a id="sec-8_1_5" href="/chapters/sign-in-sign-out.html#sec-rendering_with_a_flash_message" class="heading"><span class="number">8.1.5</span>フラッシュメッセージをレンダリングする</a></h3>


<p>Recall from <a class="ref" href="/chapters/sign-up.html#sec-signup_error_messages">Section 7.3.2</a> that we displayed signup errors using the User model error messages. These errors are associated with a particular Active Record object, but this strategy won’t work here because the session isn’t an Active Record model. Instead, we’ll put a message in the flash to be displayed upon failed signin. A first, slightly incorrect, attempt appears in <a class="ref" href="/chapters/sign-in-sign-out.html#code-failed_signin_attempt">Listing 8.10</a>.</p>

<div class="label" id="code-failed_signin_attempt"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.10.</span> <span class="description">An (unsuccessful) attempt at handling failed signin. </span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Sign the user in and redirect to the user&#39;s show page.</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span> <span class="c1"># Not quite right!</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Because of the flash message display in the site layout (<a class="ref" href="/chapters/sign-up.html#code-layout_flash">Listing 7.26</a>), the <code>flash[:error]</code> message automatically gets displayed; because of the Bootstrap CSS, it automatically gets nice styling (<a class="ref" href="/chapters/sign-in-sign-out.html#fig-failed_signin_flash">Figure 8.6</a>).</p>

<div class="label" id="fig-failed_signin_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/failed_signin_flash_bootstrap.png" alt="failed_signin_flash_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.6: </span><span class="description">The flash message for a failed signin. <a href="http://railstutorial.org/images/figures/failed_signin_flash_bootstrap-full.png">(full size)</a></span></div></div>


<p>Unfortunately, as noted in the text and in the comment in <a class="ref" href="/chapters/sign-in-sign-out.html#code-failed_signin_attempt">Listing 8.10</a>, this code isn’t quite right. The page looks fine, though, so what’s the problem? The issue is that the contents of the flash persist for one <em>request</em>, but—unlike a redirect, which we used in <a class="ref" href="/chapters/sign-up.html#code-signup_flash">Listing 7.27</a>—re-rendering a template with <code>render</code> doesn’t count as a request. The result is that the flash message persists one request longer than we want. For example, if we submit invalid information, the flash is set and gets displayed on the signin page (<a class="ref" href="/chapters/sign-in-sign-out.html#fig-failed_signin_flash">Figure 8.6</a>); if we then click on another page, such as the Home page, that’s the first request since the form submission, and the flash gets displayed again (<a class="ref" href="/chapters/sign-in-sign-out.html#fig-flash_persistence">Figure 8.7</a>).</p>

<div class="label" id="fig-flash_persistence"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/flash_persistence_bootstrap.png" alt="flash_persistence_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.7: </span><span class="description">An example of the flash persisting. <a href="http://railstutorial.org/images/figures/flash_persistence_bootstrap-full.png">(full size)</a></span></div></div>


<p>This flash persistence is a bug in our application, and before proceeding with a fix it is a good idea to write a test catching the error. In particular, the signin failure tests are currently passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signin with invalid information&quot;</span>
</pre></div>
</div>


<p>But the tests should never pass when there is a known bug, so we should add a failing test to catch it. Fortunately, dealing with a problem like flash persistence is one of many areas where integration tests really shine; they let us say exactly what we mean:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;after visiting another page&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>After submitting invalid signin data, this test follows the Home link in the site layout and then requires that the flash error message not appear. The updated code, with the modified flash test, is shown in <a class="ref" href="/chapters/sign-in-sign-out.html#code-correct_signin_failure_test">Listing 8.11</a>.</p>

<div class="label" id="code-correct_signin_failure_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.11.</span> <span class="description">Correct tests for signin failure. </span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;after visiting another page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The new test fails, as required:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signin with invalid information&quot;</span>
</pre></div>
</div>


<p>To get the failing test to pass, instead of <code>flash</code> we use <code>flash.now</code>, which is specifically designed for displaying flash messages on rendered pages; unlike the contents of <code>flash</code>, its contents disappear as soon as there is an additional request. The corrected application code appears in <a class="ref" href="/chapters/sign-in-sign-out.html#code-correct_signin_failure">Listing 8.12</a>.</p>

<div class="label" id="code-correct_signin_failure"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.12.</span> <span class="description">Correct code for failed signin. </span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># Sign the user in and redirect to the user&#39;s show page.</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now the test suite for users with invalid information should be green:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;with invalid information&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-signin_success"></div>


<h2><a id="sec-8_2" href="/chapters/sign-in-sign-out.html#sec-signin_success" class="heading"><span class="number">8.2、</span>サインイン成功</a></h2>


<p> サインイン失敗を扱ったので、次は実際にユーザをサインインさせましょう。これからこのチュートリアル中、これまでで最も難関のRubyプログラミングに向かいますので、終わりまで頑張ってちょっとリフティングの準備をしましょう。幸運なことに、第一歩は簡単です。—セッションコントローラを完成させる <code>create</code> アクションは嵌め込みです。 不幸なことに、これはズルでもあります。</p>

<p>今回のサインインコメントで満たされた記述 (<a class="ref" href="/chapters/sign-in-sign-out.html#code-correct_signin_failure">Listing 8.12</a>) はシンプルです: サインインに成功すると、 ユーザを <code>sign_in</code> で記録して、 プロフィールページに飛ばします (<a class="ref" href="/chapters/sign-in-sign-out.html#code-sign_in_success_not_yet_working">Listing 8.13</a>). なぜこれがズルなのかというと、なんと <code>sign_in</code> はこの時点で存在していないのです。このセクションの残りの部分で書いていきます。</p>

<div class="label" id="code-sign_in_success_not_yet_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.13.</span> <span class="description">完成したセッションコントローラの <code>create</code> アクション (まだ動きません). </span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-remember_me"></div>


<h3><a id="sec-8_2_1" href="/chapters/sign-in-sign-out.html#sec-remember_me" class="heading"><span class="number">8.2.1</span>[このアカウント設定を保存する]</a></h3>


<p>我々のサインインモデルの実装を始めましょう、つまり、サインイン状態を「永遠に」保存しておき、ユーザが明示的にサインアウトしたときにのみセッションを削除させます。サインイン関数そのものは伝統的なMVC(モデル-ビュー-コントローラ)に行き着きます。特に、いくつかのサインイン関数はコントローラとビューの両方から使える必要があるでしょう。あなたは <a class="ref" href="/chapters/rails-flavored-ruby.html#sec-back_to_the_title_helper">4.2.5</a> を思い出すかも知れません。Rubyは <em>モジュール</em> によって関数を一纏めにし、複数の場所でインクルードさせる機能を提供します。そしてこれが認証機能のための方法となるのです。認証のために全く新しいモジュールを作ることも可能ですが、セッションコントローラは既にモジュールとしてその機能を持っています、つまり、 <code>SessionsHelper</code> です。さらに、ヘルパーはRailsのビューに自動的に取り込まれているので、我々がしなくてはならないことはSession helper 機能をコントローラ内で使用して Application controller にモジュールをインクルードさせることだけなのです (<a class="ref" href="/chapters/sign-in-sign-out.html#code-sessions_helper_include">Listing 8.14</a>). (<a class="ref" href="/chapters/sign-in-sign-out.html#code-sessions_helper_include">Listing 8.14</a> also takes the opportunity to add an additional cross-site request forgery safeguard. それは <a class="ref" href="/chapters/sign-in-sign-out.html#sec-signing_out">8.2.6</a> の <code>sign_out</code> メソッドを一度だけ定義すれば動きます.)</p>

<div class="label" id="code-sessions_helper_include"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.14.</span> <span class="description">Sessions helper モジュールを Application controller にインクルードする</span><br /><span class="description"> <code>app/controllers/application_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="ss">ActionController::Base</span>
  <span class="n">protect_from_forgery</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>

  <span class="c1"># Force signout to prevent CSRF attacks</span>
  <span class="k">def</span> <span class="nf">handle_unverified_request</span>
    <span class="n">sign_out</span>
    <span class="k">super</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>デフォルトでは、全てのヘルパーはビューで使用可能となっており、コントローラでは使えません。Sessions helper は両方の場所でメソッドが必要なので、明示的にインクルードしなくてはならないのです。</p>

<p>HTTPは <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state"><em>ステートを持たないプロトコル</em></a> であるため、ウェブアプリケーションではユーザのサインインはページ遷移を追うという方法で実装する必要があります。ユーザのサインイン状態を保持するひとつの方法は伝統的な Rails のセッション (特別な <code>session</code> 機能によるもの) を使ってユーザIDと同じ <em>remember token</em> を保持することです。</p>

<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>


<p>この <code>session</code> オブジェクトはユーザIDをクッキーに保持することでページ間での使用を可能にしています。クッキーはブラウザが閉じられると無効になります。それぞれのページで、アプリケーションはシンプルにコールして</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>ユーザを検索することができます。Railsがセッションを扱う方法によってこのプロセスは安全です。もしも悪意あるユーザがユーザIDをなりすまそうとしたら、Railsは各セッションに生成された特別の <em>session id</em> によって不一致を検出するでしょう。</p>

<p>我々のアプリケーションのデザインが選択したのは <em>永続的な</em> セッションを含んでいて—そのため、サインイン状態はブラウザを閉じた後にも保持せなばならず—我々は <em>恒久的な</em> 識別子をサインインしたユーザに使用しなくてはならないのです。これを実現するために、各ユーザへユニークで安全なremember tokenを生成して、ブラウザを閉じると切れてしまうのでない <em>恒久的な</em> クッキーとして登録します。</p>

<p>remember tokenはユーザに関連付けられまた先々使われるために保持される必要があり、<a class="ref" href="/chapters/sign-in-sign-out.html#fig-user_model_remember_token">Figure 8.8</a> に示すユーザモデル属性に加えることになります。</p>

<div class="label" id="fig-user_model_remember_token"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/user_model_remember_token_31.png" alt="user_model_remember_token_31" /></span></div><div class="caption"><span class="header">Figure 8.8: </span><span class="description">The User model with an added <code>remember_token</code> attribute.</span></div></div>


<p>User model スペックに少し追加することから始めましょう (<a class="ref" href="/chapters/sign-in-sign-out.html#code-user_responds_to_remember_token">Listing 8.15</a>).</p>

<div class="label" id="code-user_responds_to_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.15.</span> <span class="description">remember token のための最初のテスト</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>  
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストは以下のコマンドラインで remember token を生成することで実施することができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_remember_token_to_users
</pre></div>
</div>


<p>次に <a class="ref" href="/chapters/sign-in-sign-out.html#code-add_remember_token_to_users">Listing 8.16</a> のコードのように結果のmigration を埋めていきます。remember token でユーザ検索をするために、 index (<a class="ref" href="/chapters/modeling-users.html#sidebar-database_indices">Box 6.2</a>) を <code>remember_token</code> カラムに追加することに注意してください。</p>

<div class="label" id="code-add_remember_token_to_users"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.16.</span> <span class="description">A migration to add a <code>remember_token</code> to the <code>users</code> table. </span><br /><span class="description"> <code>db/migrate/[timestamp]_add_remember_token_to_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddRememberTokenToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次に、いつものように開発とテストのデータベースを更新します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>At this point the User model specs should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<p>さて、 remember token として何を使うか決めなければななりません。同等に有力な候補がたくさんあります。—基本的には、長くてランダムな文字列ならどんなものでも良いでしょう。原則として、ユーザパスワードは安全に暗号化されており、ユーザの <code>password_hash</code> 属性は使用可能ですが、不必要にユーザパスワードを晒すのは攻撃を受ける可能性を考えると望ましいことではありません。We’ll err on the side of caution and make a custom remember token using the <code>urlsafe_base64</code> method from the <code>SecureRandom</code> module in the Ruby standard library, which creates a <a href="http://en.wikipedia.org/wiki/Base64">Base64</a> string safe for use in URIs (and hence safe for use in cookies as well).<sup class="footnote" id="fnref-8_3"><a href="/chapters/sign-in-sign-out.html#fn-8_3">3</a></sup> As of this writing, <code>SecureRandom.urlsafe_base64</code> returns a random string of length 16 composed of the characters A–Z, a–z, 0–9, “-”, and “_” (for a total of 64 possibilities). This means that the probability of two remember tokens being the same is $1/64^{16} = 2^{-96} \approx 10^{-29}$, which is negligible.</p>

<p>We’ll create a remember token using a <em>callback</em>, a technique introduced in <a class="ref" href="/chapters/modeling-users.html#sec-uniqueness_validation">Section 6.2.5</a> in the context of email uniqueness. As in that section, we’ll use a <code>before_save</code> callback, this time to create the attribute <code>remember_token</code> just before the user is saved. A second option would be to use a <code>before_create</code> callback<sup class="footnote" id="fnref-8_4"><a href="/chapters/sign-in-sign-out.html#fn-8_4">4</a></sup> to set the remember token <em>once</em>, when the user is first created. This would work fine, but it has the downside that any <a href="http://en.wikipedia.org/wiki/Session_hijacking">hijacked sessions</a> (which involves copying the remember token and using it to sign in as the corresponding user) would never expire. The <code>before_save</code> callback, in contrast, ensures that the token changes every time the user updates his information (<a class="ref" href="/chapters/updating-showing-and-deleting-users.html#sec-successful_edits">Section 9.1.3</a>), so it’s slightly more secure. (Session hijacking was widely publicized by the <a href="http://codebutler.com/firesheep">Firesheep</a> application, which showed that remember tokens at many high-profile sites were visible when connected to public Wi-Fi networks. The solution is to use site-wide SSL, as described in <a class="ref" href="/chapters/sign-up.html#sec-deploying_to_production_with_ssl">Section 7.4.4</a>. Occasionally changing the remember token is still a security feature, though, since your remember token could still be obtained if the attacker has physical access to a computer where you are signed in.)</p>

<p>To test the remember token, we first save the test user and then check that the user’s <code>remember_token</code> attribute isn’t blank. This gives us sufficient flexibility to change the random string if we ever need to. The result appears in <a class="ref" href="/chapters/sign-in-sign-out.html#code-remember_token_should_not_be_blank">Listing 8.17</a>.</p>

<div class="label" id="code-remember_token_should_not_be_blank"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.17.</span> <span class="description">A test for a valid (nonblank) remember token. </span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;remember token&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="/chapters/sign-in-sign-out.html#code-remember_token_should_not_be_blank">Listing 8.17</a> introduces the <code>its</code> method, which is like <code>it</code> but applies the subsequent test to the given attribute rather than the subject of the test. In other words,</p>

<div class="code"><div class="highlight"><pre><span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>これは以下と同じです。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">remember_token</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>The application code introduces several new elements. First, we add a callback method to create the remember token:</p>

<div class="code"><div class="highlight"><pre><span class="n">before_save</span> <span class="ss">:create_remember_token</span>
</pre></div>
</div>


<p>This arranges for Rails to look for a method called <code>create_remember_token</code> and run it before saving the user. Second, the method itself is only used internally by the User model, so there’s no need to expose it to outside users. The Ruby way to accomplish this is to use the <code>private</code> keyword:</p>

<div class="code"><div class="highlight"><pre><span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_remember_token</span>
    <span class="c1"># Create the token.</span>
  <span class="k">end</span>
</pre></div>
</div>


<p><code>private</code> の後ろに定義されたメソッドは全て自動的に隠蔽されますので、</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">create_remember_token</span>
</pre></div>
</div>


<p>は <code>NoMethodError</code> 例外を発生させます。</p>

<p>Finally, the <code>create_remember_token</code> method needs to <em>assign</em> to one of the user attributes, and in this context it is necessary to use the <code>self</code> keyword in front of <code>remember_token</code>:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create_remember_token</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
<span class="k">end</span>
</pre></div>
</div>


<p>(<em>Note</em>: If you are using Ruby 1.8.7, you should use <code>SecureRandom.hex</code> here instead.) Because of the way Active Record synthesizes attributes based on database columns, without <code>self</code> the assignment would create a <em>local</em> variable called <code>remember_token</code>, which isn’t what we want at all. Using <code>self</code> ensures that assignment sets the user’s <code>remember_token</code> so that it will be written to the database along with the other attributes when the user is saved.</p>

<p>Putting this all together yields the User model shown in <a class="ref" href="/chapters/sign-in-sign-out.html#code-before_save_create_remember_token">Listing 8.18</a>.</p>

<div class="label" id="code-before_save_create_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.18.</span> <span class="description">A <code>before_save</code> callback to create <code>remember_token</code>. </span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">before_save</span> <span class="ss">:create_remember_token</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">create_remember_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>By the way, the extra level of indentation on <code>create_remember_token</code> is there to make it visually apparent which methods are defined after <code>private</code>.</p>

<p>Since the <code>SecureRandom.urlsafe_base64</code> string is definitely <em>not</em> blank, the tests for the User model should now be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<div class="label" id="sec-a_working_sign_in_method"></div>


<h3><a id="sec-8_2_2" href="/chapters/sign-in-sign-out.html#sec-a_working_sign_in_method" class="heading"><span class="number">8.2.2</span>正しい<tt>sign_in</tt>メソッド</a></h3>


<p>Now we’re ready to write the first signin element, the <code>sign_in</code> function itself. As noted above, our desired authentication method is to place a remember token as a cookie on the user’s browser, and then use the token to find the user record in the database as the user moves from page to page (implemented in <a class="ref" href="/chapters/sign-in-sign-out.html#sec-current_user">Section 8.2.3</a>). The result, <a class="ref" href="/chapters/sign-in-sign-out.html#code-sign_in_function">Listing 8.19</a>, introduces two new ideas: the <code>cookies</code> hash and <code>current_user</code>.</p>

<div class="label" id="code-sign_in_function"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.19.</span> <span class="description">The complete (but not-yet-working) <code>sign_in</code> function. </span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="/chapters/sign-in-sign-out.html#code-sign_in_function">Listing 8.19</a> introduces the <code>cookies</code> utility supplied by Rails. We can use <code>cookies</code> as if it were a hash; each element in the cookie is itself a hash of two elements, a <code>value</code> and an optional <code>expires</code> date. For example, we could implement user signin by placing a cookie with value equal to the user’s remember token that expires 20 years from now:</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value:</span>   <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span><span class="p">,</span>
                             <span class="ss">expires:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div>
</div>


<p>(This uses one of the convenient Rails time helpers, as discussed in <a class="ref" href="/chapters/sign-in-sign-out.html#sidebar-time_helpers">Box 8.1</a>.)</p>

<div class="label" id="sidebar-time_helpers"></div>


<div class="sidebar"><span class="title"><span class="header">Box 8.1.</span></span><span class="title"><span class="description">Cookies expire <tt>20.years.from_now</tt></span></span>
<p>You may recall from <a class="ref" href="/chapters/rails-flavored-ruby.html#sec-a_class_of_our_own">Section 4.4.2</a> that Ruby lets you add methods to <em>any</em> class, even built-in ones. In that section, we added a <tt>palindrome?</tt> method to the <tt>String</tt> class (and discovered as a result that <tt>&quot;deified&quot;</tt> is a palindrome), and we also saw how Rails adds a <tt>blank?</tt> method to class <tt>Object</tt> (so that <tt>&quot;&quot;.blank?</tt>, <tt>&quot; &quot;.blank?</tt>, and <tt>nil.blank?</tt> are all <tt>true</tt>). The cookie code in <a class="ref" href="/chapters/sign-in-sign-out.html#code-sign_in_function">Listing 8.19</a> (which internally sets a cookie that expires <tt>20.years.from_now</tt>) gives yet another example of this practice through one of Rails’ <em>time helpers</em>, which are methods added to <tt>Fixnum</tt> (the base class for numbers):</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Sun, 13 Mar 2011 03:38:55 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Sat, 02 Jan 2010 03:39:14 UTC +00:00</pre>


<p>Rails adds other helpers, too:</p>

<pre class="verbatim">  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>


<p>These are useful for upload validations, making it easy to restrict, say, image uploads to <tt>5.megabytes</tt>.</p>

<p>Though it must be used with caution, the flexibility to add methods to built-in classes allows for extraordinarily natural additions to plain Ruby. Indeed, much of the elegance of Rails ultimately derives from the malleability of the underlying Ruby language.</p>
</div>


<p>This pattern of setting a cookie that expires 20 years in the future became so common that Rails added a special <code>permanent</code> method to implement it, so that we can simply write</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</pre></div>
</div>


<p>Under the hood, using <code>permanent</code> causes Rails to set the expiration to <code>20.years.from_now</code> automatically.</p>

<p>After the cookie is set, on subsequent page views we can retrieve the user with code like</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>Of course, <code>cookies</code> isn’t <em>really</em> a hash, since assigning to <code>cookies</code> actually <em>saves</em> a piece of text on the browser, but part of the beauty of Rails is that it lets you forget about that detail and concentrate on writing the application.</p>

<div class="label" id="sec-current_user"></div>


<h3><a id="sec-8_2_3" href="/chapters/sign-in-sign-out.html#sec-current_user" class="heading"><span class="number">8.2.3</span>現在のユーザー</a></h3>


<p>Having discussed how to store the user’s remember token in a cookie for later use, we now need to learn how to retrieve the user on subsequent page views. Let’s look again at the <code>sign_in</code> function to see where we are:</p>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Our focus now is the second line:</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>The purpose of this line is to create <code>current_user</code>, accessible in both controllers and views, which will allow constructions such as</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div>
</div>


<p>The use of <code>self</code> is necessary in this context for the same essential reason noted in the discussion leading up to <a class="ref" href="/chapters/sign-in-sign-out.html#code-before_save_create_remember_token">Listing 8.18</a>: without <code>self</code>, Ruby would simply create a local variable called <code>current_user</code>.</p>

<p>To start writing the code for <code>current_user</code>, note that the line</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>is an <em>assignment</em>, which we must define. Ruby has a special syntax for defining such an assignment function, shown in <a class="ref" href="/chapters/sign-in-sign-out.html#code-current_user_equals">Listing 8.20</a>.</p>

<div class="label" id="code-current_user_equals"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.20.</span> <span class="description">Defining assignment to <code>current_user</code>. </span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This might look confusing—most languages don’t let you use the equals sign in a method definition—but it simply defines a method <code>current_user=</code> expressly designed to handle assignment to <code>current_user</code>. In other words, the code</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div>
</div>


<p>is automatically converted to</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>thereby invoking the <code>current_user=</code> method. Its one argument is the right-hand side of the assignment, in this case the user to be signed in. The one-line method body just sets an instance variable <code>@current_user</code>, effectively storing the user for later use.</p>

<p>In ordinary Ruby, we could define a second method, <code>current_user</code>, designed to return the value of <code>@current_user</code>, as shown in  <a class="ref" href="/chapters/sign-in-sign-out.html#code-current_user_wrong">Listing 8.21</a>.</p>

<div class="label" id="code-current_user_wrong"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.21.</span> <span class="description">A tempting but useless definition for <code>current_user</code>.</span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span>     <span class="c1"># Useless! </span><span class="c1">Don&#39;t use this line.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>If we did this, we would effectively replicate the functionality of <code>attr_accessor</code>, which we saw in <a class="ref" href="/chapters/rails-flavored-ruby.html#sec-a_user_class">Section 4.4.5</a>.<sup class="footnote" id="fnref-8_5"><a href="/chapters/sign-in-sign-out.html#fn-8_5">5</a></sup> The problem is that it utterly fails to solve our problem: with the code in <a class="ref" href="/chapters/sign-in-sign-out.html#code-current_user_wrong">Listing 8.21</a>, the user’s signin status would be forgotten: as soon as the user went to another page—<em>poof!</em>—the session would end and the user would be automatically signed out.
To avoid this problem, we can find the user corresponding to the remember token created by the code in <a class="ref" href="/chapters/sign-in-sign-out.html#code-sign_in_function">Listing 8.19</a>, as shown in <a class="ref" href="/chapters/sign-in-sign-out.html#code-current_user_working">Listing 8.22</a>.</p>

<div class="label" id="code-current_user_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.22.</span> <span class="description">Finding the current user using the <code>remember_token</code>. </span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="/chapters/sign-in-sign-out.html#code-current_user_working">Listing 8.22</a> uses the common but initially obscure <code>||=</code> (“or equals”) assignment operator (<a class="ref" href="/chapters/sign-in-sign-out.html#sidebar-or_equals">Box 8.2</a>). Its effect is to set the <code>@current_user</code> instance variable to the user corresponding to the remember token, but only if <code>@current_user</code> is undefined.<sup class="footnote" id="fnref-8_6"><a href="/chapters/sign-in-sign-out.html#fn-8_6">6</a></sup> In other words, the construction</p>

<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>calls the <code>find_by_remember_token</code> method the first time <code>current_user</code> is called, but on subsequent invocations returns <code>@current_user</code> without hitting the database.<sup class="footnote" id="fnref-8_7"><a href="/chapters/sign-in-sign-out.html#fn-8_7">7</a></sup> This is only useful if <code>current_user</code> is used more than once for a single user request; in any case, <code>find_by_remember_token</code> will be called at least once every time a user visits a page on the site.</p>

<div class="label" id="sidebar-or_equals"></div>


<div class="sidebar"><span class="title"><span class="header">Box 8.2.</span></span><span class="title"><span class="description">What the *$@! </span></span><span class="title"><span class="description">is <tt>||=</tt> ? </span></span>
<p>The <tt>||=</tt> construction is very Rubyish—that is, it is highly characteristic of the Ruby language—and hence important to learn if you plan on doing much Ruby programming. Though at first it may seem mysterious, <em>or equals</em> is easy to understand by analogy.</p>

<p>We start by noting a common idiom for changing a currently defined variable. Many computer programs involve incrementing a variable, as in</p>

<pre class="verbatim">  x = x + 1</pre>


<p>Most languages provide a syntactic shortcut for this operation; in Ruby (and in C, C++, Perl, Python, Java, etc.), it appears as follows:</p>

<pre class="verbatim">  x += 1</pre>


<p>Analogous constructs exist for other operators as well:</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 7
  =&gt; -1</pre>


<p>In each case, the pattern is that <tt>x = x O y</tt> and <tt>x O= y</tt> are equivalent for any operator <tt>O</tt>.</p>

<p>Another common Ruby pattern is assigning to a variable if it’s <tt>nil</tt> but otherwise leaving it alone. Recalling the <em>or</em> operator <tt>||</tt> seen in <a class="ref" href="/chapters/rails-flavored-ruby.html#sec-objects_and_message_passing">Section 4.2.3</a>, we can write this as follows:</p>

<pre class="verbatim">  &gt;&gt; @user
  =&gt; nil
  &gt;&gt; @user = @user || &quot;the user&quot;
  =&gt; &quot;the user&quot;
  &gt;&gt; @user = @user || &quot;another user&quot;
  =&gt; &quot;the user&quot;</pre>


<p>Since <tt>nil</tt> is false in a boolean context, the first assignment is <tt>nil || &quot;the user&quot;</tt>, which evaluates to <tt>&quot;the user&quot;</tt>; similarly, the second assignment is <tt>&quot;the user&quot; || &quot;another user&quot;</tt>, which also evaluates to <tt>&quot;the user&quot;</tt>—since strings are <tt>true</tt> in a boolean context, the series of <tt>||</tt> expressions terminates after the first expression is evaluated. (This practice of evaluating <tt>||</tt> expressions from left to right and stopping on the first true value is known as <em>short-circuit evaluation</em>.)</p>

<p>Comparing the console sessions for the various operators, we see that <tt>@user = @user || value</tt> follows the <tt>x = x O y</tt> pattern with <tt>||</tt> in the place of <tt>O</tt>, which suggests the following equivalent construction:</p>

<pre class="verbatim">  &gt;&gt; @user ||= &quot;the user&quot;
  =&gt; &quot;the user&quot;</pre>


<p>Voilà !</p>
</div>




<div class="label" id="sec-changing_the_layout_links"></div>


<h3><a id="sec-8_2_4" href="/chapters/sign-in-sign-out.html#sec-changing_the_layout_links" class="heading"><span class="number">8.2.4</span>レイアウトリンクを変更する</a></h3>


<p>We come finally to a practical application of all our signin/out work: we’ll change the layout links based on signin status. In particular, as seen in the <a class="ref" href="/chapters/sign-in-sign-out.html#fig-signin_success_mockup">Figure 8.3</a> mockup, we’ll arrange for the links to change when users sign in or sign out, and we’ll also add links for listing all users and user settings (to be completed in <a class="ref" href="/chapters/updating-showing-and-deleting-users.html#top">Chapter 9</a>) and one for the current user’s profile page. In doing so, we’ll get the tests in <a class="ref" href="/chapters/sign-in-sign-out.html#code-signin_success_tests">Listing 8.6</a> to pass, which means our test suite will be green for the first time since the beginning of the chapter.</p>

<p>The way to change the links in the site layout involves using an
if-else branching structure inside of Embedded Ruby:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  # Links for signed-in users
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  # Links for non-signed-in-users
end
</pre></div>
</div>


<p>This kind of code requires the existence of a <code>signed_in?</code> boolean, which we’ll now define.</p>

<p>A user is signed in if there is a current user in the session, i.e., if <code>current_user</code> is non-<code>nil</code>. This requires the use of the “not” operator, written using an exclamation point <code>!</code> and usually read as “bang”. In the present context, a user is signed in if <code>current_user</code> is <em>not</em> <code>nil</code>, as shown in <a class="ref" href="/chapters/sign-in-sign-out.html#code-signed_in_p">Listing 8.23</a>.</p>

<div class="label" id="code-signed_in_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.23.</span> <span class="description">The <code>signed_in?</code> </span><span class="description">helper method. </span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the <code>signed_in?</code> method in hand, we’re ready to finish the layout links. There are four new links, two of which are stubbed out (to be completed in <a class="ref" href="/chapters/updating-showing-and-deleting-users.html#top">Chapter 9</a>):</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>The signout link, meanwhile, uses the signout path defined in <a class="ref" href="/chapters/sign-in-sign-out.html#code-sessions_resource">Listing 8.2</a>:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>(Notice that the signout link passes a hash argument indicating that it should submit with an HTTP <tt>DELETE</tt> request.<sup class="footnote" id="fnref-8_8"><a href="/chapters/sign-in-sign-out.html#fn-8_8">8</a></sup>) Finally, we’ll add a profile link as follows:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Here we could write</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>but Rails allows us to link directly to the user, in this context automatically converting <code>current_user</code> into <code>user_path(current_user)</code>.</p>

<p>In the process of putting the new links into the layout, we’ll take advantage of Bootstrap’s ability to make dropdown menus, which you can read more about on the <a href="http://twitter.github.com/bootstrap/components.html">Bootstrap components page</a>. The full result appears in <a class="ref" href="/chapters/sign-in-sign-out.html#code-layout_signin_signout_links">Listing 8.24</a>. Note in particular the CSS ids and classes related to the Bootstrap dropdown menu.</p>

<div class="label" id="code-layout_signin_signout_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.24.</span> <span class="description">Changing the layout links for signed-in users. </span><br /><span class="description"> <code>app/views/layouts/_header.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          end
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>The dropdown menu requires the use of Bootstrap’s JavaScript library, which we can include using the Rails asset pipeline by editing the application JavaScript file, as shown in <a class="ref" href="/chapters/sign-in-sign-out.html#code-bootstrap_js">Listing 8.25</a>.</p>

<div class="label" id="code-bootstrap_js"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.25.</span> <span class="description">Adding the Bootstrap JavaScript library to <code>application.js</code>. </span><br /><span class="description"> <code>app/assets/javascripts/application.js</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="c1">//= require bootstrap</span>
<span class="c1">//= require_tree .</span>
</pre></div>
</div></div>


<p>This uses the Sprockets library to include the Bootstrap JavaScript, which in turn is available thanks to the <tt>bootstrap-sass</tt> gem from <a class="ref" href="/chapters/filling-in-the-layout.html#sec-custom_css">Section 5.1.2</a>.</p>

<p>With the code in <a class="ref" href="/chapters/sign-in-sign-out.html#code-layout_signin_signout_links">Listing 8.24</a>, all the tests should be passing:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Unfortunately, if you actually examine the application in the browser, you’ll see that it doesn’t yet work. This is because the “remember me” functionality requires the user to have a remember token, but the current user doesn’t have one: we created the first user back in <a class="ref" href="/chapters/sign-up.html#sec-the_first_signup">Section 7.4.3</a>, long before implementing the callback that sets the remember token. To fix this, we need to save each user to invoke the <code>before_save</code> callback defined in <a class="ref" href="/chapters/sign-in-sign-out.html#code-before_save_create_remember_token">Listing 8.18</a>, which creates a remember token as a side-effect:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">remember_token</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="ss">validate:</span> <span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">remember_token</span>
<span class="go">=&gt; &quot;Im9P0kWtZvD0RdyiK9UHtg&quot;</span>
</pre></div>
</div>


<p>Here we’ve iterated over all the users in case you added more than one while playing with the signup form. Note that we’ve passed an option to the <code>save</code> method; as currently written, <code>save</code> by itself wouldn’t work because we haven’t included the password or its confirmation. Indeed, for a real site we wouldn’t even know any of the passwords, but we would still want to be able to save the users. The solution is to pass <code>validate: false</code> to tell Active Record skip the validations (<a href="http://api.rubyonrails.org/v3.2.0/classes/ActiveRecord/Persistence.html#method-i-save">Rails API <tt>save</tt></a>).</p>

<p>With that change, a signed-in user now sees the new links and dropdown menu defined by <a class="ref" href="/chapters/sign-in-sign-out.html#code-layout_signin_signout_links">Listing 8.24</a>, as shown in <a class="ref" href="/chapters/sign-in-sign-out.html#fig-profile_with_signout_link">Figure 8.9</a>.</p>

<div class="label" id="fig-profile_with_signout_link"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/profile_with_signout_link_bootstrap.png" alt="profile_with_signout_link_bootstrap" /></span></div><div class="caption"><span class="header">Figure 8.9: </span><span class="description">A signed-in user with new links and a dropdown menu. <a href="http://railstutorial.org/images/figures/profile_with_signout_link_bootstrap-full.png">(full size)</a></span></div></div>


<p>At this point, you should verify that you can sign in, close the browser, and then still be signed in when you visit the sample application. If you want, you can even inspect the browser cookies to see the result directly (<a class="ref" href="/chapters/sign-in-sign-out.html#fig-cookie_in_browser">Figure 8.10</a>).</p>

<div class="label" id="fig-cookie_in_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/chapters/images/figures/cookie_in_browser.png" alt="cookie_in_browser" /></span></div><div class="caption"><span class="header">Figure 8.10: </span><span class="description">The remember token cookie in the local browser. <a href="http://railstutorial.org/images/figures/cookie_in_browser-full.png">(full size)</a></span></div></div>




<div class="label" id="sec-signin_upon_signup"></div>


<h3><a id="sec-8_2_5" href="/chapters/sign-in-sign-out.html#sec-signin_upon_signup" class="heading"><span class="number">8.2.5</span>ユーザー登録と同時にサインインする</a></h3>


<p>In principle, although we are now done with authentication, newly registered users might be confused, as they are not signed in by default. Implementing this is the last bit of polish before letting users sign out. We’ll start by adding a line to the authentication tests (<a class="ref" href="/chapters/sign-in-sign-out.html#code-sign_up_sign_in">Listing 8.26</a>). This includes the “after saving the user” <code>describe</code> block from <a class="ref" href="/chapters/sign-up.html#code-after_save_tests">Listing 7.32</a> (<a class="ref" href="/chapters/sign-up.html#sec-signup_exercises">Section 7.6</a>), which you should add to the test now if you didn’t already do the corresponding exercise.</p>

<div class="label" id="code-sign_up_sign_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.26.</span> <span class="description">Testing that newly signed-up users are also signed in. </span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after saving the user&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we’ve tested the appearance of the signout link to verify that the user was successfully signed in after signing up.</p>

<p>With the <code>sign_in</code> method from <a class="ref" href="/chapters/sign-in-sign-out.html#sec-signin_success">Section 8.2</a>, getting this test to pass by actually signing in the user is easy: just add <code>sign_in @user</code> right after saving the user to the database (<a class="ref" href="/chapters/sign-in-sign-out.html#code-signin_upon_signup">Listing 8.27</a>).</p>

<div class="label" id="code-signin_upon_signup"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.27.</span> <span class="description">Signing in the user upon signup. </span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-signing_out"></div>


<h3><a id="sec-8_2_6" href="/chapters/sign-in-sign-out.html#sec-signing_out" class="heading"><span class="number">8.2.6</span>サインアウトする</a></h3>


<p>As discussed in <a class="ref" href="/chapters/sign-in-sign-out.html#sec-signin_failure">Section 8.1</a>, our authentication model is to keep users signed in until they sign out explicitly. In this section, we’ll add this necessary signout capability.</p>

<p>So far, the Sessions controller actions have followed the RESTful convention of using <code>new</code> for a signin page and <code>create</code> to complete the signin. We’ll continue this theme by using a <code>destroy</code> action to delete sessions, i.e., to sign out. To test this, we’ll click on the “Sign out” link and then look for the reappearance of the signin link (<a class="ref" href="/chapters/sign-in-sign-out.html#code-signout_test">Listing 8.28</a>).</p>

<div class="label" id="code-signout_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.28.</span> <span class="description">A test for signing out a user. </span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;followed by signout&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Sign out&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As with user signin, which relied on the <code>sign_in</code> function, user signout just defers to a <code>sign_out</code> function (<a class="ref" href="/chapters/sign-in-sign-out.html#code-destroy_session">Listing 8.29</a>).</p>

<div class="label" id="code-destroy_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.29.</span> <span class="description">Destroying a session (user signout). </span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">sign_out</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As with the other authentication elements, we’ll put <code>sign_out</code> in the Sessions helper module. The implementation is simple: we set the current user to <code>nil</code> and use the <code>delete</code> method on cookies to remove the remember token from the session (<a class="ref" href="/chapters/sign-in-sign-out.html#code-sign_out_method">Listing 8.30</a>). (Setting the current user to <code>nil</code> isn’t currently necessary because of the immediate redirect in the <code>destroy</code> action, but it’s a good idea in case we ever want to use <code>sign_out</code> without a redirect.)</p>

<div class="label" id="code-sign_out_method"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.30.</span> <span class="description">The <code>sign_out</code> method in the Sessions helper module. </span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">sign_out</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This completes the signup/signin/signout triumvirate, and the test suite should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/ 
</pre></div>
</div>


<p>It’s worth noting that our test suite covers most of the authentication machinery, but not all of it. For instance, we don’t test how long the “remember me” cookie lasts or whether it gets set at all. It is possible to do so, but experience shows that direct tests of cookie values are brittle and have a tendency to rely on implementation details that sometimes change from one Rails release to the next. The result is breaking tests for application code that still works fine. By focusing on high-level functionality—verifying that users can sign in, stay signed in from page to page, and can sign out—we test the core application code without focusing on less important details.</p>

<div class="label" id="sec-cucumber"></div>


<h2><a id="sec-8_3" href="/chapters/sign-in-sign-out.html#sec-cucumber" class="heading"><span class="number">8.3</span>Cucumberの紹介(オプション)</a></h2>


<p>Having finished the foundation of the sample application’s authentication system, we’re going to take this opportunity to show how to write signin tests using <a href="http://cukes.info">Cucumber</a>, a popular tool for behavior-driven development that enjoys significant popularity in the Ruby community. This section is optional and can be skipped without loss of continuity.</p>

<p>Cucumber allows the definition of plain-text <em>stories</em> describing application behavior. Many Rails programmers find Cucumber especially convenient when doing client work; since they can be read even by non-technical users, Cucumber tests can be shared with (and can sometimes even be written by) the client. Of course, using a testing framework that isn’t pure Ruby has a downside, and I find that the plain-text stories can be a bit verbose. Nevertheless, Cucumber does have a place in the Ruby testing toolkit, and I especially like its emphasis on high-level behavior over low-level implementation.</p>

<p>Since the emphasis in this book is on RSpec and Capybara, the presentation that follows is necessarily superficial and incomplete, and will be a bit light on explanation. Its purpose is just to give you a taste of Cucumber (crisp and juicy, no doubt)—if it strikes your fancy, there are entire books on the subject waiting to satisfy your appetite. (I particularly recommend <a href="http://www.amazon.com/gp/product/1934356379"><em>The RSpec Book</em></a> by David Chelimsky, <a href="http://www.amazon.com/gp/product/1935182277"><em>Rails 3 in Action</em></a> by Ryan Bigg and Yehuda Katz, and <a href="http://www.amazon.com/gp/product/1934356808"><em>The Cucumber Book</em></a> by Matt Wynne and Aslak Hellesøy.)</p>

<div class="label" id="sec-installation_and_setup"></div>


<h3><a id="sec-8_3_1" href="/chapters/sign-in-sign-out.html#sec-installation_and_setup" class="heading"><span class="number">8.3.1</span>インストールと設定</a></h3>


<p>To install Cucumber, first add the <tt>cucumber-rails</tt> gem and a utility gem called <tt>database_cleaner</tt> to the <code>:test</code> group in the <code>Gemfile</code> (<a class="ref" href="/chapters/sign-in-sign-out.html#code-cucumber_rails">Listing 8.31</a>).</p>

<div class="label" id="code-cucumber_rails"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.31.</span> <span class="description">Adding the <tt>cucumber-rails</tt> gem to the <code>Gemfile.</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;cucumber-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.1&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">&#39;database_cleaner&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7.0&#39;</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Then install as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>To set up the application to use Cucumber, we next generate some necessary support files and directories:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate cucumber:install
</pre></div>
</div>


<p>This creates a <code>features/</code> directory where the files associated with Cucumber will live.</p>

<div class="label" id="sec-features_and_steps"></div>


<h3><a id="sec-8_3_2" href="/chapters/sign-in-sign-out.html#sec-features_and_steps" class="heading"><span class="number">8.3.2</span>機能と手順</a></h3>


<p>Cucumber features are descriptions of expected behavior using a plain-text  language called <a href="https://github.com/cucumber/gherkin">Gherkin</a>. Gherkin tests read much like well-written RSpec examples, but because they are plain-text they are more accessible to those more comfortable reading English than Ruby code.</p>

<p>Our Cucumber features will implement a subset of the signin examples in <a class="ref" href="/chapters/sign-in-sign-out.html#code-initial_failing_signin_test">Listing 8.5</a> and <a class="ref" href="/chapters/sign-in-sign-out.html#code-signin_success_tests">Listing 8.6</a>. To get started, we’ll create a file in the <code>features/</code> directory called <code>signing_in.feature</code>.</p>

<p>Cucumber features start with a short description of the feature, as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
</pre></div>
</div>


<p>Then they add individual <em>scenarios</em>. For example, to test unsuccessful signin, we could write the following scenario:</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>Similarly, to test successful signin, we could add this:</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div>


<p>Collecting these together yields the Cucumber feature file shown in  <a class="ref" href="/chapters/sign-in-sign-out.html#code-signin_features">Listing 8.32</a>.</p>

<div class="label" id="code-signin_features"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.32.</span> <span class="description">Cucumber features to test user signin. </span><br /><span class="description"> <code>features/signing_in.feature</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
<span class="nf">  </span>
<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>
<span class="nf">  </span>
<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div></div>


<p>To run the features, we use the <code>cucumber</code> executable:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>Compare this to</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>In this context, it’s worth noting that, like RSpec, Cucumber can be invoked using a Rake task:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake cucumber
</pre></div>
</div>


<p>(For reasons that escape me, this is sometimes written as <code>rake cucumber:ok</code>.)</p>

<p>All we’ve done so far is write some plain text, so it shouldn’t be surprising that the Cucumber scenarios aren’t yet passing. To get the test suite to green, we need to add a <em>step</em> file that maps the plain-text lines to Ruby code. The step file goes in the <code>features/step_definitions</code> directory; we’ll call it <code>authentication_steps.rb</code>.</p>

<p>The <code>Feature</code> and <code>Scenario</code> lines are mainly for documentation, but each of the other lines needs some corresponding Ruby. For example, the line</p>

<div class="code"><div class="highlight"><pre><span class="k">Given </span><span class="nf">a user visits the signin page</span>
</pre></div>
</div>


<p>in the feature file gets handled by the step definition</p>

<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>
</pre></div>
</div>


<p>In the feature, <code>Given</code> is just a string, but in the step file <code>Given</code> is a <em>method</em> that takes a regular expression and a block. The regex matches the text of the line in the scenario, and the contents of the block are the Ruby code needed to implement the step. In this case, “a user visits the signin page” is implemented by</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signin_path</span>
</pre></div>
</div>


<p>If this looks familiar, it should: it’s just Capybara, which is included by default in Cucumber step files. The next two lines should also look familiar; the scenario steps</p>

<div class="code"><div class="highlight"><pre><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>in the feature file are handled by these steps:</p>

<div class="code"><div class="highlight"><pre><span class="no">When</span> <span class="sr">/^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The first step also uses Capybara, while the second uses Capybara’s <code>page</code> object with RSpec. Evidently, all the testing work we’ve done so far with RSpec and Capybara is also useful with Cucumber.</p>

<p>The rest of the steps proceed similarly. The final step definition file appears in <a class="ref" href="/chapters/sign-in-sign-out.html#code-authentication_steps">Listing 8.33</a>. Try adding one step at a time, running</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>each time until the tests pass.</p>

<div class="label" id="code-authentication_steps"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.33.</span> <span class="description">The complete steps needed to get the signin features to pass. </span><br /><span class="description"> <code>features/step_definitions/authentication_steps.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Given</span> <span class="sr">/^the user has an account$/</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
                      <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^the user submits valid signin information$/</span> <span class="k">do</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> 
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see his profile page$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see a signout link$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the code in <a class="ref" href="/chapters/sign-in-sign-out.html#code-authentication_steps">Listing 8.33</a>, the Cucumber tests should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>




<div class="label" id="sec-rspec_custom_matchers"></div>


<h3><a id="sec-8_3_3" href="/chapters/sign-in-sign-out.html#sec-rspec_custom_matchers" class="heading"><span class="number">8.3.3</span>対比: RSpecのカスタムマッチャー</a></h3>


<p>Having written some simple Cucumber scenarios, it’s worth comparing the result to the equivalent RSpec examples. First, take a look at the Cucumber feature in <a class="ref" href="/chapters/sign-in-sign-out.html#code-signin_features">Listing 8.32</a> and the corresponding step definitions in <a class="ref" href="/chapters/sign-in-sign-out.html#code-authentication_steps">Listing 8.33</a>. Then take a look at the RSpec request specs (integration tests):</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="k">end</span> 

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>You can see how a case could be made for either Cucumber or integration tests. Cucumber features are easily readable, but they are entirely separate from the code that implements them—a property that cuts both ways. I find that Cucumber is easy to read and awkward to write, while integration tests are (for a programmer) a little harder to read and <em>much</em> easier to write.</p>

<p>One nice effect of Cucumber’s separation of concerns is that it operates at a higher level of abstraction. For example, we write</p>

<div class="code"><div class="highlight"><pre><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>to express the expectation of seeing an error message, and</p>

<div class="code"><div class="highlight"><pre><span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>to implement the test. What’s especially convenient about this is that only the second element (the step) is dependent on the implementation, so that if we change, e.g., the CSS class used for error messages, the feature file would stay the same.</p>

<p>In this vein, it might make you unhappy to write</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>in a bunch of places, when what you really want is to indicate that the page should have an error message. This practice couples the test tightly to the implementation, and we would have to change it everywhere if the implementation changed. In the context of pure RSpec, there is a solution, which is to use a <em>custom matcher</em>, allowing us to write the following instead:</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>We can define such a matcher in the same utilities file where we put the <code>full_title</code> test helper in <a class="ref" href="/chapters/filling-in-the-layout.html#sec-pretty_rspec">Section 5.3.4</a>. The code itself looks like this:</p>

<div class="code"><div class="highlight"><pre><span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>We can also define helper functions for common operations:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>The resulting support code is shown in <a class="ref" href="/chapters/sign-in-sign-out.html#code-have_error_message">Listing 8.34</a> (which incorporates the results of <a class="ref" href="/chapters/filling-in-the-layout.html#code-full_title_helper_tests">Listing 5.37</a> and <a class="ref" href="/chapters/filling-in-the-layout.html#code-rspec_utilities_simplified">Listing 5.38</a> from <a class="ref" href="/chapters/filling-in-the-layout.html#sec-layout_exercises">Section 5.6</a>). I find this approach to be more flexible than Cucumber step definitions, particularly when the matchers or should helpers naturally take an argument, such as <code>valid_signin(user)</code>. Step definitions can replicate this functionality with regex matchers, but I generally find this approach to be more (cu)cumbersome.</p>

<div class="label" id="code-have_error_message"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 8.34.</span> <span class="description">Adding a helper method and a custom RSpec matcher. </span><br /><span class="description"> <code>spec/support/utilities.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="kp">include</span> <span class="no">ApplicationHelper</span>

<span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the code in <a class="ref" href="/chapters/sign-in-sign-out.html#code-have_error_message">Listing 8.34</a>, we can write</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>There are many other examples of coupling between our tests and the site’s implementation. Sweeping through the current test suite and decoupling the tests from the implementation details by making custom matchers and methods is left as an exercise (<a class="ref" href="/chapters/sign-in-sign-out.html#sec-sign_in_out_exercises">Section 8.5</a>).</p>

<h2><a id="sec-8_4" href="/chapters/sign-in-sign-out.html#sec-8_4" class="heading"><span class="number">8.4</span>最後に</a></h2>


<p>We’ve covered a lot of ground in this chapter, transforming our promising but unformed application into a site capable of the full suite of registration and login behaviors. All that is needed to complete the authentication functionality is to restrict access to pages based on signin status and user identity. We’ll accomplish this task en route to giving users the ability to edit their information and giving administrators the ability to remove users from the system, which are the main goals of <a class="ref" href="/chapters/updating-showing-and-deleting-users.html#top">Chapter 9</a>.</p>

<p>Before moving on, merge your changes back into the master branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish sign in&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-in-out
</pre></div>
</div>


<p>Then push up the remote GitHub repository and the Heroku production server:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>If you’ve created any users on the production server, I recommend following the steps in <a class="ref" href="/chapters/sign-in-sign-out.html#sec-changing_the_layout_links">Section 8.2.4</a> to give each user a valid remember token. The only difference is using the Heroku console instead of the local one:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run console
<span class="gp">&gt;</span>&gt; User.all.each <span class="o">{</span> |user| user.save<span class="o">(</span>validate: <span class="nb">false</span><span class="o">)</span> <span class="o">}</span>
</pre></div>
</div>


<div class="label" id="sec-sign_in_out_exercises"></div>


<h2><a id="sec-8_5" href="/chapters/sign-in-sign-out.html#sec-sign_in_out_exercises" class="heading"><span class="number">8.5</span>演習</a></h2>




<ol>

<li>Refactor the signin form to use <code>form_tag</code> in place of <code>form_for</code>. Make sure the test suite still passes. <em>Hint</em>: See the <a href="http://railscasts.com/episodes/270-authentication-in-rails-3-1">RailsCast on authentication in Rails 3.1</a>, and note in particular the change in the structure of the <code>params</code> hash.</li>

<li>Following the example in <a class="ref" href="/chapters/sign-in-sign-out.html#sec-rspec_custom_matchers">Section 8.3.3</a>, go through the user and authentication request specs (i.e., the files currently in the <code>spec/requests</code> directory) and define utility functions in <code>spec/support/utilities.rb</code> to decouple the tests from the implementation. <em>Extra credit:</em> Organize the support code into separate files and modules, and get everything to work by including the modules properly in the spec helper file.</li>

</ol>




<div class="navigation">  <a class="prev_page" href="/chapters/sign-up.html#top">
</a><a class="prev_page" href="/chapters/sign-up.html#top"><span class="number">第7章</span>ユーザー登録</a><a class="prev_page" href="/chapters/sign-up.html#top">  </a>
  <a class="next_page" href="/chapters/updating-showing-and-deleting-users.html#top">
</a><a class="next_page" href="/chapters/updating-showing-and-deleting-users.html#top">    <span class="number">第9章</span> ユーザーの更新・表示・削除</a><a class="next_page" href="/chapters/updating-showing-and-deleting-users.html#top">  </a>
</div><div class="footnotes">
<ol>
<li id="fn-8_1">Another common model is to expire the session after a certain amount of time. This is especially appropriate on sites containing sensitive information, such as banking and financial trading accounts. <a class="arrow" href="/chapters/sign-in-sign-out.html#fnref-8_1">↑</a></li>
<li id="fn-8_2">Image from <a href="http://www.flickr.com/photos/hermanusbackpackers/3343254977/">http://www.flickr.com/photos/hermanusbackpackers/3343254977/</a>. <a class="arrow" href="/chapters/sign-in-sign-out.html#fnref-8_2">↑</a></li>
<li id="fn-8_3">This choice is based on the <a href="http://railscasts.com/episodes/274-remember-me-reset-password">RailsCast on remember me</a>. <a class="arrow" href="/chapters/sign-in-sign-out.html#fnref-8_3">↑</a></li>
<li id="fn-8_4">For more details on the kind of callbacks supported by Active Record, see the <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#callbacks-overview">discussion of callbacks at the Rails Guides</a>. <a class="arrow" href="/chapters/sign-in-sign-out.html#fnref-8_4">↑</a></li>
<li id="fn-8_5">In fact, the two are exactly equivalent; <code>attr_accessor</code> is merely a convenient way to create just such getter/setter methods automatically. <a class="arrow" href="/chapters/sign-in-sign-out.html#fnref-8_5">↑</a></li>
<li id="fn-8_6">Typically, this means assigning to variables that are initially <code>nil</code>, but note that <code>false</code> values will also be overwritten by the <code>||=</code> operator. <a class="arrow" href="/chapters/sign-in-sign-out.html#fnref-8_6">↑</a></li>
<li id="fn-8_7">This is an example of <em>memoization</em>, which we discussed before in <a class="ref" href="/chapters/modeling-users.html#sidebar-let">Box 6.3</a>. <a class="arrow" href="/chapters/sign-in-sign-out.html#fnref-8_7">↑</a></li>
<li id="fn-8_8">Web browsers can’t actually issue <tt>DELETE</tt> requests; Rails fakes it with JavaScript. <a class="arrow" href="/chapters/sign-in-sign-out.html#fnref-8_8">↑</a></li>
</ol>
</div>




</div>
  </body>
</html>
