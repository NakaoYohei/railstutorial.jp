<div class="label" id="cha-beginning"></div>


<h1 class="chapter"><a id="sec-1" href="#cha-beginning" class="heading"><span class="number">第1章</span> ゼロからデプロイまで</a></h1>


<p><a href="http://ruby.railstutorial.org/ruby-on-rails-tutorial-book"><em>Ruby on Railsチュートリアル</em></a>へようこそ。この本の目的は、「<a href="http://rubyonrails.org/">Ruby on Rails</a>を使ったウェブ開発を学びたいんだけど、どこから始めればいいの？」という質問に答えることです。<em>本書</em>を読み終わる頃には、あなたは自作のカスタムWebアプリケーションを開発し、デプロイ (deploy: 本番環境でアプリを動かし、一般公開すること) するための知識をすべて得られるはずです。また、Railsの「教育エコシステム」なるものに含まれる、さらに高度な本、ブログ、スクリーンキャストなどの恩恵を受けるのにふさわしい実力を身につけられます。<em>Ruby on Railsチュートリアル</em>はRails 3を使用しているため、ここで学んだ内容はRailsの最新バージョンに完全に対応しています。(最新の<em>Ruby on Railsチュートリアル</em>については、この本が掲載されている<a href="http://railstutorial.org/">http://railstutorial.org/</a>を参照してください。本書をオフラインで読んでいる方は、<a href="http://railstutorial.org/book">http://railstutorial.org/book</a>で<a href="http://railstutorial.org/book">オンライン版Rails Tutorial book</a>で最新版を確認してください。)</p>

<p>本書の目的は、単にRailsを教えることでは<em>ありません</em>。そうではなく、<em>Railsを使用したWeb開発</em>を教える、すなわちWorld Wide Web用ソフトウェアを開発できるスキルを獲得(または強化)できるようにすることが目的です。Ruby on Railsのみならず、HTML、CSS、データベース、バージョン管理、テスティング、デプロイのためのスキルセットも本書の対象となります。この目的達成のため、<em>Ruby on Railsチュートリアル</em>では統合的なアプローチを採用しています。つまり、実際に動作するサンプルアプリケーションを一から作成するという例題をこなすことによってRailsを習得します。<a href="http://sivers.org"></a>Siversが前書きで述べたとおり、本書は一貫した直線的なストーリーを持つように構成されており、最初から最後まで飛ばさずに読むことを前提としています。技術書を飛ばし読み/つまみ食いするのが習慣になっている方にとっては、本書のような直線的なアプローチを行うために多少頭の切り替えが必要になるかもしれませんが、その価値は十分にあります。ぜひトライしてみてください。<em>Ruby on Railsチュートリアル</em>をTVゲームにたとえれば、あなたは主人公であり、1章ごとにRails開発者としてレベルアップして行くとお考えください (演習は<a href="http://en.wikipedia.org/wiki/Boss_(video_gaming)#Miniboss">中ボス</a>です)。</p>

<p>この第1章では、必要なソフトウェアをインストールし、開発環境 (<a class="ref" href="#sec-up_and_running">1.2</a>) を整えてRuby on Railsの準備をします。続いて、<code>first_app</code> という最初のRailsアプリの作成に着手します。<em>Railsチュートリアル</em>ではソフトウェア開発のベストプラクティスを重要視しているので、新しいRailsプロジェクトを作成後、ただちにGit (<a class="ref" href="#sec-version_control">1.3</a>) を使用してバージョン管理下に置きます。そして何と、この章では本番 (production) 環境 (<a class="ref" href="#sec-deploying">1.4</a>) に<em>デプロイ</em>して一般公開するところまで行います。</p>

<p><a class="ref" href="#cha-a-demo-app">第2章</a>では、Railsアプリケーションの基本的な仕組みのデモを兼ねて、新たなプロジェクトを作成します。手っ取り早く動かしたいので、この<em>デモアプリ</em>(<code>demo_app</code>)はscaffold(<a class="ref" href="#sidebar-scaffolding">コラム 1.1</a>)を使用してコードを自動生成します。scaffoldで生成されたコードは複雑で美しくないので、<a class="ref" href="#cha-a-demo-app">第2章</a>では<em>URI</em> (Webブラウザで使用する<em>URL</em><sup class="footnote" id="fnref-1_1"><a href="#fn-1_1">1</a></sup>と呼ばれることもあります)を通してデモアプリを使ってみます。</p>

<p>第3章以降では、<em>サンプルアプリケーション</em> (<code>sample_app</code>と呼びます) を作成します。このアプリはTDD(<em>テスト駆動開発</em> で開発し、<a class="ref" href="#cha-static-pages">第3章</a>で静的ページ(と少しの動的コンテンツ)を追加する事から始めます。<a class="ref" href="#cha-rails-flavored-ruby">第4章</a> では少し回り道をし、Railsを動かしているRuby言語について簡単に学びます。<a class="ref" href="#cha-filling-in-the-layout">第5章</a>から<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>ではレイアウト、ユーザーのデータモデル、そしてユーザー登録・認証システムを作りサンプルアプリの基礎を完成させます。最後に<a class="ref" href="#cha-user-microposts">第10章</a>と<a class="ref" href="#cha-following-users">第11章</a>ではマイクロブログ機能とソーシャル機能を実装し、実際に動作するサイトに仕上げます。</p>

<p>最終的なサンプルアプリは、元々は同じRailsで書かれていたある<a href="http://twitter.com/">ソーシャルマイクロブログサイト</a>にとてもよく似た仕上がりになります。もちろん、私たちはこのサンプルアプリを中心に開発を進めて行きますが、<em>Rails チュートリアル</em>では今後Webアプリケーションを作成する時に、どのようなアプリケーションにも通用する基礎を築きます。</p>

<div class="label" id="sidebar-scaffolding"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 1.1</span></span><span class="title"><span class="description">早くて簡単なScaffoldの甘い誘惑</span></span>
<p>Railsの作者David Heinemer Hansson氏による有名な「<a href="http://www.youtube.com/watch?v=Gzj723LkRJY">15分で作るブログ</a>」ビデオ (現在はRyan Bates氏による「Rails 2による15分で作るブログ」に更新されています) などを見ていただければわかるように、Railsは誕生したときから刺激的なフレームワークです。これらのビデオはRailsのパワーを目の当たりにするには最適であり、ぜひ視聴する事をお勧めします。しかし、これらのビデオでは15分でブログを作るという離れ業を、<em>scaffold</em>という機能を利用して成し遂げています。このscaffoldという機能は、Railsの<code>generate</code>コマンドによる<em>自動生成コード</em>に強く依存します。</p>

<p>Ruby on Railsのチュートリアルを書いていて、<a href="http://en.wikipedia.org/wiki/Dark_side_(Star_Wars)">あまりにも素早く簡単にコードが生成できる</a>scaffoldの機能を私もついあてにしてしまいそうになります。しかし、初心者は生成されたコードの複雑さとその量の多さに圧倒されてしまうことでしょう。どうにか動いても、ソースコードを見ても何が行われているのか理解できないことでしょう。scaffoldのコード自動生成に頼っていると、スクリプト作成の達人にはなるかもしれませんが、Rails自体の知識はほとんど身に付きません。</p>

<p><em>Ruby on Rails</em> チュートリアルでは、ほぼ逆のアプローチで開発を行います。scaffoldは<a class="ref" href="#cha-a-demo-app">第2章</a>での簡単なデモアプリ作成に使用しますが、<em>このチュートリアル</em>の中核は<a class="ref" href="#cha-static-pages">第3章</a>から作成するサンプルアプリケーションです。開発の段階ごとに、手頃な<em>一口サイズ</em>のコードを書いてもらいます。この一口サイズコードは、無理なく理解できる程度にシンプルで、かつある程度の歯ごたえとやりがいを得られるように配慮してあります。最終的には、どんなWebアプリを作成する時にも役立つ、より深く柔軟なRailsの知識を身につけられるようになっています。</p>
</div>




<div class="label" id="sec-introduction"></div>


<h2><a id="sec-1_1" href="#sec-introduction" class="heading"><span class="number">1.1</span>はじめに</a></h2>


<p>2004年にデビューしてからというもの、Ruby on Railsは動的Webアプリケーションを開発するための最も有力な、そして人気のあるフレームワーク (土台) の１つに成長しました。ほんの小さな会社から巨大企業までがRailsを使っています: <a href="http://37signals.com/">37signals</a>、<a href="http://github.com/">GitHub</a>、<a href="http://shopify.com/">Shopify</a>、<a href="http://scribd.com/">Scribd</a>、<a href="http://twitter.com/">Twitter</a>、<a href="http://livingsocial.com/">LivingSocial</a>、<a href="http://groupon.com/">Groupon</a>、<a href="http://hulu.com/">Hulu</a>、<a href="http://yellowpages.com/">Yellow Pages</a>など、<a href="http://rubyonrails.org/applications">Ruby on Railsを使っているサイトのリスト</a>は増える一方です。<a href="http://entp.com/">ENTP</a>、<a href="http://thoughtbot.com/">thoughtbot</a>、<a href="http://pivotallabs.com/">Pivotal Labs</a>、<a href="http://hashrocket.com/">Hashrocket</a>、そして無数のコンサルタント、インストラクターなど、Railsを専門に扱う開発者も多く存在します。</p>

<p>Railsのどこがそんなに凄いのでしょうか。第一に、Railsは100%オープンソースで、制限の緩い<a href="http://www.opensource.org/licenses/mit-license.php">MITライセンス</a>で公開されているので、ダウンロードも使用も無料であるという点です。Railsがこれほどまでに成功をおさめ、優美でコンパクトなコードを記述できるのは、背後でフレームワークを動かしている<a href="http://ruby-lang.org/">Ruby</a>という言語の柔軟性を利用してWebアプリケーション作成に特化した<a href="http://en.wikipedia.org/wiki/Domain_Specific_Language">DSL (ドメイン固有言語)</a> を実装しているからです。このため、HTMLの生成、データモデルの作成、そしてURLの転送など、Webプログラミングで必要な多くの作業が簡単になり、アプリケーションコードが読みやすく、短く収まります。</p>

<p>第二に、Railsは、Webテクノロジーやフレームワークデザインの進歩に素早く適応します。たとえば、RailsはWebアプリケーション構築の際に使用されるRESTアーキテクチャをいち早く完全に実装したフレームワークの１つです (RESTについてはこのチュートリアルで後々解説していきます)。また、Railsの作成者である<a href="http://loudthinking.com/">David Heinemeier Hansson</a>をはじめとする<a href="http://rubyonrails.org/core">Railsのコアチーム</a>は、ためらうことなく他のフレームワークの有用な機能をどしどし取り入れます。RailsとMerbの合流はその一例です。結果としてRailsは、Merbのモジュール化されたデザインと安定した <a href="http://en.wikipedia.org/wiki/Application_programming_interface">API</a>の恩恵を受ける事ができました。</p>

<p>最後に、Railsコミュニティは非常に熱心で様々な経歴の開発者の集まりです。結果、何百人ものオープンソース<a href="http://contributors.rubyonrails.org/">コントリビュータ</a>たち、多くの参加者で賑わう各種<a href="http://railsconf.com/">カンファレンス</a>、多様多種な<a href="http://agilewebdevelopment.com/plugins">プラグイン</a>、ページネーションや画像アップロードなど特定の作業を行うためのおびただしい<a href="https://rubygems.org/">gem</a> 、情報豊かな多数のブログ、そしてフォーラムや掲示板、チャットルームなどが存在します。数多くのRailsプログラマのおかげで、ほとんどのアプリケーションエラーはGoogle検索をするだけで、関連するブログポストや掲示板のスレッドを見つけることができます。</p>

<div class="label" id="sec-comments_for_various_readers"></div>


<h3><a id="sec-1_1_1" href="#sec-comments_for_various_readers" class="heading"><span class="number">1.1.1</span> 読者の皆さまへのコメント</a></h3>


<p><em>Rails チュートリアル</em>にはRailsだけではなく、Ruby言語、<a href="http://en.wikipedia.org/wiki/HTML">HTML</a>、<a href="http://en.wikipedia.org/wiki/CSS">CSS</a>、若干の<a href="http://en.wikipedia.org/wiki/JavaScript">JavaScript</a>、そしてさらにわずかの<a href="http://en.wikipedia.org/wiki/SQL">SQL</a>のためのチュートリアルを含んでいます。あなたの現時点のWeb開発の知識量にかかわらず、このチュートリアルを読み終える頃には、高度な情報源を難なく読みこなし、各トピックをさらにシステマチックに取り扱えるほどの実力が付く内容になっています。これは、本書で扱われているマテリアルが<em>極めて膨大である</em>ということでもあります。コンピュータのプログラミング経験があまりない人にとっては、その情報量に圧倒されることがあるかもしれません。読者の経験や知識に応じて<em>Railsチュートリアル</em>を習得するためのアドバイスを以下に用意しました。ぜひ参考にしてください。<br /></p>

<p><strong>すべての読者へ:</strong> 私が良く聞かれる質問の１つが、「Railsを覚える前にRubyを勉強しておいた方がいいでしょうか」です。答えは「あなた自身の学習スタイルとプログラミング経験によります」です。最初からすべてを体系的に学びたい、またはプログラミングの経験がまったくない場合には、おそらくRubyを最初に学んでおくのがよいでしょう。Rubyを学ぶのであれば、Peter Cooper「<a href="http://www.amazon.com/gp/product/1430223634"><em>Beginning Ruby</em></a>」(邦訳は現時点ではなし) がお勧めです。一方、Rails開発初心者の多くは<em>Webアプリケーション</em>の作成にたちまち夢中になり、たった1つのWebページを作成するために500ページものRuby本を読み通す気にはなれないでしょう。このような方には、対話的に Rubyを学習できるWebサービス<a href="http://tryruby.org/">Try Ruby</a><sup class="footnote" id="fnref-1_2"><a href="#fn-1_2">2</a></sup>でRubyを大まかに理解し、必要に応じて<a href="http://railsforzombies.org/">Rails for Zombies</a><sup class="footnote" id="fnref-1_3"><a href="#fn-1_3">3</a></sup>でRailsでどんなことができるかを学んでおくことをお勧めします (いずれも日本語版はなし)。</p>

<p>もう１つよく聞かれる質問で「最初からテストしていいのか？」というのがあります。「はじめに」で述べたように、<em>Rails チュートリアル</em>では最初からテスト駆動開発 (TDD) を採用しています。これは私からみてRailsアプリケーションを開発するのに最適な方法ですが、その分かなり複雑になり、習得に時間もかかります。テストが面倒になったり、難しくて前に進めなくなった場合、思い切ってその箇所をスキップするか、テストはコード検証のためのツールと割りきって単に動かすだけにとどめ、理解は後回しにしてしまっても構いません。後者でいうテストとは、<em>spec</em>と呼ばれるテストファイルを作成し、そこにテストコードを本書で指示された<em>とおり</em>にコピペするということです。その後テストスイートを実行します。<a class="ref" href="#cha-filling-in-the-layout">第5章</a>で実践しますが、最初はテストに失敗し、次にチュートリアルに従ってコードを書くと次のテストにはパスするようにシナリオが作られています。<br /></p>

<p><strong>経験の浅いプログラマ:</strong> ご注意いただきたいのですが、<em>Railsチュートリアル</em>は、まったくのプログラミング初心者、Webアプリケーションの初心者を主な読者層としては想定していません。プログラミング言語やWebアプリケーションは、たとえどれほどシンプルなものであっても必ずある程度には複雑なものだからです。Webプログラミングについてまったくの初心者の方が、本書<em>Railsチュートリアル</em>が難しすぎると感じた場合は、まずHTMLとCSSの基礎を勉強してください。それから<em>Railsチュートリアル</em>に再度挑戦してください。(現時点でお勧めの学習教材を思いつかず恐縮ですが、HTMLの学習用として<a href="http://headfirstlabs.com/books/hfhtml/"><em>Head First HTML</em></a>はなかなかよさそうです。David Sawyer McFarlandの<a href="http://www.amazon.com/gp/product/0596526873"><em>CSS: The Missing Manual</em></a>を推薦してくれた読者もいます。)Peter Cooperの<a href="http://www.amazon.com/gp/product/1430223634"><em>Beginning Ruby</em></a>の最初の数章をやってみるのもよいでしょう。同書のサンプルアプリケーションは本格的なWebアプリケーションに比べて非常に小さいので、比較的やりやすいと思います。実のところ、驚くほど多くのプログラミング初心者の皆様が本書でWeb開発を学ぼうとしているのです。もちろん、それを止めるようなことはしません。ぜひ挑戦してみてください。そうした方には、<a href="http://railstutorial.org/screencasts"><em>Rails Tutorial</em> screencast series</a><sup class="footnote" id="fnref-1_4"><a href="#fn-1_4">4</a></sup> (いずれも日本語版はなし) を特にお勧めします。このビデオチュートリアルは、Railsソフトウェア開発のベテランの作業を文字通り「肩越しに」学ぶことができます。<br /></p>

<p><strong>ソフトウェア開発経験があり、Web開発を始めたい方:</strong> プログラミングの経験がある方でクラス、メソッド、データ構造などに馴染みがあるなら、その知識は有利に働くはずです。JavaやC/C++とRubyではかなり記述スタイルが違うので少し違和感を感じるかもしれませんが、すぐに慣れるはずです。(Rubyではセミコロン&#39;;&#39;も使えます) <em>Railsチュートリアル</em>はWeb特有の概念をほぼカバーしているので、<tt>PUT</tt>と<tt>POST</tt>の違いが分からなくても心配はいりません。<br /></p>

<p><strong>Web開発の経験があり、Railsを始めたい方:</strong> PHPやPythonなど動的言語を使用した事があるなら、かなり楽に読めるかと思います。特にPythonの経験は有利です。基本的なコンセプトは聞いた事あるものばかりかもしれませんが、テスト駆動開発 (TDD) やRESTスタイルなどは多くの方にとって初耳かもしれません。Ruby特有のクセも、最初はとまどうかもしれませんが、チュートリアルを進めて行くうちに明らかになっていくと思います。<br /></p>

<p><strong>Railsを使った事がないRubyプログラマの方:</strong> 最近では多くのRubyプログラマがRailsを使用しているので、純粋にRubyのみを使っている方は少ないかと思いますが、経験豊富なRubyプログラマの方にはObie Fernandezの<a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails 3 Way</em></a>をお勧めします。<br /></p>

<p><strong>Rails開発者で経験の少ない方:</strong> もしかしたら既に他のチュートリアルを読んだり小規模なRailsアプリを組んだことがあるかもしれません。Rails開発者からも、本書から多くのことを学べたという声をたくさんいただいています。本書は、あなたがRailsを始めて使い始めた頃のチュートリアルよりも新しい情報がふんだんに盛り込まれており、きっと役に立つはずです。<br /></p>

<p><strong>Rails開発者で経験豊富な方:</strong> 本書はあなたには必要ないかもしれませんが、Rails開発者の方からも本書が「意外と役に立った」との声をいただいているので、Railsを違う視点から見てみるのも楽しいかもしれません。<br /></p>

<p><em>Ruby on Rails チュートリアル</em>を読み終えたら、(Ruby以外での) 開発経験のある方には、Rubyを一から覚えることができ、詳細な解説も載っているDavid A. Blackの<a href="http://www.amazon.com/gp/product/1933988657"><em>The Well-Grounded Rubyist</em></a>か、似たような内容で項目ごとに分かれているHal Fultonの<a href="http://www.amazon.com/gp/product/0672328844"><em>The Ruby Way</em></a>をお勧めします。その後は<a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails 3 Way</em></a>でRailsの知識を深めると良いでしょう。<br /></p>

<p>全部終わった頃には、より高レベルのRailsガイドや情報源を読めるようになっているはずです。私が特にお勧めしたいのは以下です:</p>

<ul>

<li><a href="http://railscasts.com/">RailsCasts</a> (Ryan Bates) : 質の高い、ほぼ無料のスクリーンキャスト集</li>
<li><a href="http://peepcode.com/">PeepCode</a>: 質の高い商用スクリーンキャスト</li>
<li><a href="http://www.codeschool.com/">Code School</a>: 対話的にプログラミングを学習できるコース</li>
<li><a href="http://guides.rubyonrails.org/">Rails Guides</a>: テーマごとに分類された最新のRailsリファレンスです。</li>
<li><a href="http://railscasts.com/">RailsCasts</a> (Ryan Bates): おや、さっきも <a href="http://railscasts.com/">RailsCasts</a>のことを書いたような気が。そのぐらい<a href="http://railscasts.com/"><em>RailsCasts</em></a>はお勧めです。</li>


</ul>




<h3><a id="sec-1_1_2" href="#sec-1_1_2" class="heading"><span class="number">1.1.2</span> Railsと「スケール」について</a></h3>


<p>この節を続ける前に、Railsフレームワークにとって当初から「ネック」とされてきた事の１つが、多くのデータとユーザーによって発生する通信量に対応するための「スケーリングの難しさ」です。ここで１つ言っておきます。ここで必要なのは<a href="http://idleprocess.wordpress.com/2009/11/24/presentation-summary-high-performance-at-massive-scale-lessons-learned-at-facebook/">フレームワークをスケールさせるのではなくて、<em>Webサイト自体</em>をスケールさせる</a>ことです。Railsは言うまでもなく素晴らしいものですが、結局はただのフレームワークです。すなわち、問題はRailsがスケールできるかどうかではなく、「スケールするアプリケーションをRailsで組む事ができるか」なのです。どっちにしろ世界で最もトラフィックの多いサイトがRailsを使用している今、答えはYESです。スケーリング<em>自体</em>はRailsだけの問題ではありませんが、もしあなたのアプリケーションがHuluやYellow Pages並のデータ量を扱わなければならなくなってもRailsは<em>あなたの</em>世界征服を止める事はないでしょう。</p>

<div class="label" id="sec-conventions"></div>


<h3><a id="sec-1_1_3" href="#sec-conventions" class="heading"><span class="number">1.1.3</span> この本における取り決め</a></h3>


<p>本書における取り決め (コマンドやコードの記述法などの統一) はできるだけ分かりやすく選んだつもりです。ここでは分かりにくいかもしれない部分を解説しておきます。</p>

<p><a href="http://railstutorial.org/book">HTML版</a>、<a href="http://railstutorial.org/">PDF版</a>ともに、文中には内部リンク (<a class="ref" href="#sec-up_and_running">1.2</a>など) と外部リンク (<a href="http://rubyonrails.org/download">Ruby on Railsダウンロードページ</a>など) が多数含まれています<sup class="footnote" id="fnref-1_5"><a href="#fn-1_5">5</a></sup>。</p>

<p>本書の出てくる例の多くはコマンドライン (ターミナル) のコマンドを使っています。簡素化のため、すべてのコマンドライン例は次のようにUnixスタイルの $ プロンプトを使っています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">echo</span> <span class="s2">&quot;hello, world&quot;</span>
<span class="go">&quot;hello world&quot;</span>
</pre></div>
</div>


<p>Windowsユーザーの方は、Windowsコマンドラインでは次のように <code>&gt;</code> プロンプトが使用されていることをご理解ください。</p>

<div class="code"><div class="highlight"><pre><span class="go">C:\Sites&gt; echo &quot;hello, world&quot;</span>
<span class="go">&quot;hello world&quot;</span>
</pre></div>
</div>


<p>Unix上では、コマンドを入力する際<code>sudo</code> (他のユーザーの特権レベルでプログラムを実行するためのコマンド) を使わなければならない場合があります<sup class="footnote" id="fnref-1_6"><a href="#fn-1_6">6</a></sup>デフォルトで<code>sudo</code>コマンドで実行されたプログラムは、<a class="ref" href="#sec-rubygems">1.2.2</a>の例のように通常のユーザーはアクセスできないファイルやディレクトリへのアクセス権を持つ「管理者権限」で実行されます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> sudo ruby setup.rb</pre></div>
</div>


<p><a class="ref" href="#sec-install_ruby">1.2.2.3</a>で推奨されているRuby Version Manager (rvm)を導入していない場合、ほとんどのUnix/Linux/OS Xシステムでは<code>sudo</code>の実行が必要です。rvmを導入している場合は以下のように実行できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> ruby setup.rb</pre></div>
</div>


<p>Railsにはコマンドラインで実行できる多数のコマンドが付属しています。たとえば、<a class="ref" href="#sec-rails_server">1.2.5</a>にあるように以下のコマンドを使用して開発用WebサーバーをローカルPC上で実行することができます。</p>

<div class="code"><div class="highlight"><pre><span class="nv">$ </span>rails server</pre></div>
</div>


<p>コマンドラインのプロンプトと同じく、<em>Railsチュートリアル</em>ではディレクトリの区切りをUnix式にスラッシュ(<code>/</code>)で表記しています。たとえばサンプルアプリケーションの場所は以下になります。</p>

<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app</pre></div>
</div>


<p>Windowsでの同等のパスは以下になります。</p>

<div class="code"><div class="highlight"><pre>C:\Sites\sample_app</pre></div>
</div>


<p>Railsで作成するアプリケーションのルートディレクトリを<em>Railsルート</em>と呼びます。この用語はやや間違えられやすいようで、多くの人がRailsルートを「Railsそのもののルート」だと勘違いします。この点を明確にするため、<em>Railsチュートリアル</em>ではRailsルートといえば<em>Railsで作成したアプリケーションのルート</em>を指すものとし、すべてのディレクトリはここを起点とした相対パスで示します。たとえば、サンプルアプリケーションの<code>config</code>ディレクトリは以下です。</p>

<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app/config</pre></div>
</div>


<p>この場合、このRailsアプリケーションのルートディレクトリは<code>config</code>の1つ上の階層であり、以下になります。</p>

<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app</pre></div>
</div>


<p>以下のようなディレクトリパスを簡潔に記述する場合、</p>

<div class="code"><div class="highlight"><pre>/Users/mhartl/rails_projects/sample_app/config/routes.rb</pre></div>
</div>


<p>本書ではアプリケーションのルートを省略して単に<code>config/routes.rb</code>と記載します。</p>

<p><em>Railsチュートリアル</em>には、シェルコマンドやバージョン管理ソフトウェア、Rubyプログラムなどが出力するさまざまな結果が多数掲載されています。出力結果はコンピュータシステムによって微妙に異なるのが普通ですから、本書に掲載されている出力結果が実際の出力と正確に同じであるとは限りませんが、この点は問題ありません。</p>

<p>システムの状態によっては、一部のコマンドを実行した時にエラーが発生することもあります。本書では、あらゆる場合を想定してエラー対策を事細かに記載するような<a href="http://en.wikipedia.org/wiki/Sisyphus">面倒なこと</a>はしていません。代わりに、エラーメッセージを素直にGoogleで検索してください。これは実際のソフトウェア開発にも効果的なテクニックです。本書のチュートリアル実行中に何か問題が生じたら、<a href="http://railstutorial.org/help">RailsチュートリアルのHelpページ</a>に記載されているリソースに当たってみてください<sup class="footnote" id="fnref-1_7"><a href="#fn-1_7">7</a></sup>。</p>

<div class="label" id="sec-up_and_running"></div>


<h2><a id="sec-1_2" href="#sec-up_and_running" class="heading"><span class="number">1.2</span> さっそく動作させる</a></h2>




<blockquote><p>本書の第1章は、さしずめロースクールで言うところの「草むしり期間」(=選別期間) のようなものです。ここで開発環境の構築に成功できた人ならば、最後までやり通すのは難しくありません。<br /> —Bob Cavezza (<em>Railsチュートリアル</em>読者)</p>
</blockquote>


<p>いよいよ、Ruby on Railsの開発環境の構築と最初のアプリの作成をする時が来ました。特にプログラミング経験が無い方は少し苦労するかもしれませんが、どうか諦めずに頑張ってください。苦労するのはあなただけではありません。これは開発者として誰もが何度となく通る道であり、苦労は必ず大いに報われることを私が保証いたします。</p>

<div class="label" id="sec-development_tools"></div>


<h3><a id="sec-1_2_1" href="#sec-development_tools" class="heading"><span class="number">1.2.1</span>開発環境</a></h3>


<p>開発環境はRailsプログラマの数だけあります。開発者たちは自分の環境を、最早自分でもわからなくなるぐらいにとことんカスタマイズするものだからです。開発環境は、大きく分けてテキストエディタとコマンドラインを使用する環境とIDE (統合開発環境) を使った環境に分けられます。まずは後者から見てみましょう。</p>

<h4><a id="sec-1_2_1_1" href="#sec-1_2_1_1" class="heading">IDE</a></h4>


<p>Rails用のIDEの数は多く、<a href="http://www.aptana.com/rails/">RadRails</a>、<a href="http://www.jetbrains.com/ruby/index.html">RubyMine</a>、<a href="http://www.codegear.com/products/3rdrail">3rd Rail</a>などさまざまなものがあります。特にRubyMineの評判がよいようです。さらに、David Loefflerという読者が<a href="https://github.com/perfectionist/sample_project/wiki">RailsチュートリアルでRubyMineを使用する方法</a><sup class="footnote" id="fnref-1_8"><a href="#fn-1_8">8</a></sup>というドキュメントまでまとめてくれました。IDEでの開発が好みという方は、自分のスタイルに合うかどうか上のリンクをチェックしてみるとよいでしょう。</p>

<h4><a id="sec-1_2_1_2" href="#sec-1_2_1_2" class="heading">テキストエディタとコマンドライン</a></h4>


<p>私自身は、すべてが整った強力なIDEの代わりに、<em>テキストエディタ</em>でテキストを編集し、<em>コマンドライン</em>でコマンドを実行するというシンプルな手段を好んでいます (<a class="ref" href="#fig-editor_shell">図 1.1</a>)。どの組み合わせを使うかは自身の好みとプラットフォームによりますが。</p>

<ul>
<li><strong>テキストエディタ:</strong> 私は断然<a href="http://www.sublimetext.com/2">Sublime Text 2</a>をお勧めします。これは非常によくできたクロスプラットフォームのテキストエディタであり、現段階ではまだベータ版ですが、とてもそうは思えないほどパワフルです。Sublime Textは<a href="http://macromates.com">TextMate</a>の影響を強く受けています。そして実際、スニペットやカラースキームなどについてはTextMateのカスタマイズ設定と互換性があります。（あなたがMacユーザーであれば、TextMateは今でも良い選択であると言えます。OS X版しかありませんが。)2番目の選択肢にふさわしい<a href="http://www.vim.org/">Vim</a><sup class="footnote" id="fnref-1_9"><a href="#fn-1_9">9</a></sup>は多くのプラットフォームで動作します。Vimは無償で手に入りますが、Sublime Textは商用版しかありません。どちらもプロの使用に耐えうるものですが、私の経験ではSublime Textは初心者にとって<em>はるかに</em>扱いやすいものであると言えます。</li>

<li><strong>ターミナル:</strong> OS Xの場合、<a href="http://iterm.sourceforge.net/">iTerm</a>かシステム備え付けのTerminal appをお勧めします。Linuxの場合、デフォルトのターミナルで構いません。Windowsの場合、Rails環境をそのままインストールするよりも、Linuxが動作する仮想マシン上にインストールすることを好む人が多いようです。この場合、コマンドラインオプションは従来通りです。開発環境をWindows自身にインストールするのであれば、コマンドラインは<a href="http://railsinstaller.org/">Railsインストーラ</a>付属の物がおすすめです (<a class="ref" href="#sec-rails_installer_windows">1.2.2.1</a>)。</li>
</ul>


<p>Sublime Textを選んだ方のために、オプション設定方法を解説した<a href="https://github.com/mhartl/rails_tutorial_sublime_text">Railsチュートリアル: Sublime Text</a><sup class="footnote" id="fnref-1_10"><a href="#fn-1_10">10</a></sup>を用意してあります。(この種の設定はいろいろと面倒でエラーも起きやすいので、あくまで上級者向けです。Sublime Textはデフォルト設定のままでも依然としてRailsアプリケーションを編集するための良い選択肢です。)</p>

<div class="label" id="fig-editor_shell"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/editor_shell.png" alt="editor_shell" /></span></div><div class="caption"><span class="header">図1.1：</span> <span class="description">テキストエディタ/コマンドライン開発環境(TextMate/ ITERMを使用) <a href="http://railstutorial.org/images/figures/editor_shell-full.png">(拡大)</a></span></div></div>




<h4><a id="sec-1_2_1_3" href="#sec-1_2_1_3" class="heading">ブラウザ</a></h4>


<p>ブラウザの種類は豊富ですが、大半のRails開発者はFirefox、Safari、もしくはChromeを選ぶ傾向にあるようです。Rails チュートリアル内のスクリーンショットも原則としてFirefoxの物を使用しています。Firefoxを使う場合、HTMLの構造とCSSのルールをダイナミックに調査/編集できる<a href="http://getfirebug.com/">Firebug</a>アドオンがおすすめです。Firefoxを使用しない場合、SafariとChromeにはページの調査したい部分を右クリックする事で情報を調べられる機能があります。</p>

<h4><a id="sec-1_2_1_4" href="#sec-1_2_1_4" class="heading">使用するツールについて</a></h4>


<p>開発環境を整える過程で、すべてを思い通りに設定するには<em>かなり</em>長い時間がかかる事を実感するかもしれません。Sublime TextやVimなどのエディタやIDEは特に、何週間かかっても極めるのは難しいものです。初めての方に申し上げておきますが、心配はいりません。<em>開発ツールを覚えるのに時間をかけるのはいたって普通の事なのです</em>。これもまた、開発者なら誰もが通る道です。「良いアイディアが浮かんで<em>今すぐにでもRailsでWebアプリを作りたいだけ</em>なのに、Unixエディタの使い方を覚えるのに1週間もかかって前に進めない！」とイライラする事もあるでしょう。しかしながら、道具の使い方は職人にとって当然の心得です。払った努力に見合う見返りは必ずあります。</p>

<div class="label" id="sec-rubygems"></div>


<h3><a id="sec-1_2_2" href="#sec-rubygems" class="heading"><span class="number">1.2.2</span>Ruby、RubyGems、Rails、Git</a></h3>




<blockquote><p>実質的に世界中のあらゆるソフトウェアは、壊れているか使いにくいかのどちらかだ。人々がソフトウェアに恐怖心を抱くのは、結局これが原因なのだ。人々は何かインストールしようとしたりオンラインフォームに記入したりするたびに、それらがさっぱり動かないという事態にすっかり慣らされてしまっている。正直、<em>私は</em>何かをインストールすることが怖い。これでも私はコンピュータサイエンスの博士号を持っているのだが。<br /> —Paul Graham (<em>Founders at Work</em>)</p>
</blockquote>


<p>さあ、RubyとRailsをインストールしましょう。本書では可能な限り多くの環境をカバーするようにしていますが、システムが変われば手順がうまくいかないこともあります。問題が生じた場合は、エラーメッセージをGoogleで検索するか、<a href="http://railstutorial.org/help">RailsチュートリアルのHelpページ</a>を参照してください。</p>

<p><strong>警告: 特に断りのない限り、Railsを含むすべてのソフトウェアはチュートリアルで使用されているものと正確に同じバージョンを使用してください。そうでないと同じ結果を得られないことがあります。</strong> バージョンが少々異なっていても同じ結果を得られることもありますが、特にRailsのバージョンに関しては必ず指定を守ってください。これには例外もあり、たとえばRubyそれ自身が該当します。1.9.2と1.9.3は実質的に同じであり、チュートリアルには影響しません。お好きな方をご使用ください。</p>

<div class="label" id="sec-rails_installer_windows"></div>


<h4><a id="sec-1_2_2_1" href="#sec-rails_installer_windows" class="heading">Railsインストーラ (Windows)</a></h4>


<p>最近までWindows上でのRailsのインストールは困難だったのですが、<a href="http://engineyard.com/">Engine Yard</a>の方々(特にDr. Nic WilliamsとWayne E. Seguin)のおかげで非常に簡単になりました。Windowsユーザーの方は<a href="http://railsinstaller.org/">Railsインストーラ</a>からインストーラをダウンロードして下さい。exeファイルをダブルクリックし、指示に従ってGit、Ruby、RubyGems、そしてRails自身をインストールします (<a class="ref" href="#sec-install_git">1.2.2.2</a>、<a class="ref" href="#sec-install_ruby">1.2.2.3</a>、<a class="ref" href="#sec-install_rubygems">1.2.2.4</a>、<a class="ref" href="#sec-install_rails">1.2.2.5</a>はスキップしてください)。インストール完了後、<a class="ref" href="#sec-the_first_application">1.2.3</a>までスキップして最初のアプリケーション作成に取りかかってください。</p>

<p>注意: このRailsインストーラによってインストールされるRailsのバージョンは<a class="ref" href="#sec-install_rails">1.2.2.5</a>に記載のものと異なることがあります。その場合、互換性の問題が生じることもありえます。この問題を解決するために、Railsのバージョン番号順に並んだRubyインストーラのリストを作成してもらうようNicとWayneに働きかけています。</p>

<div class="label" id="sec-install_git"></div>


<h4><a id="sec-1_2_2_2" href="#sec-install_git" class="heading">Gitのインストール</a></h4>


<p>Rails環境の多くの部分は、<a href="http://git-scm.com/">Git</a>という<a href="http://en.wikipedia.org/wiki/Revision_control">バージョン管理システム</a>の機能に依存します (Gitの詳細については<a class="ref" href="#sec-version_control">1.3</a>で解説しています)。Gitは本書で多用されているので、早い内にインストールを済ませておきます。<a href="http://www.git-scm.com/book/en/Getting-Started-Installing-Git"><em>Pro Git</em>の「Gitのインストール」</a>でプラットフォーム毎の解説を行っているので参考にして下さい。</p>

<div class="label" id="sec-install_ruby"></div>


<h4><a id="sec-1_2_2_3" href="#sec-install_ruby" class="heading">Rubyのインストール</a></h4>


<p>次にRubyをインストールします。もしかすると既にあなたのシステムに入っているかもしれないので、その場合は以下を実行して</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span>Ruby-V<span class="go">    ruby &quot;1.9.3&quot;</span>
</pre></div>
</div>


<p>バージョン情報を確認してください。Rails 3はRuby 1.8.7以上で動作しますが、1.9.2が最適です。このチュートリアルはバージョン1.9.2または1.9.3を使用していることを前提で進めていきますが、1.8.7でも問題はないはずです (ただし1つだけ文法の違いがあり、<a class="ref" href="#cha-rails-flavored-ruby">第4章</a>で補足しています。また、出力に若干の違いが生じます)。</p>

<p>OS X、またはLinuxを使う場合、<a href="http://rvm.io/">Ruby Version Manager (RVM)</a>を使用してRubyをインストールすることを強くお勧めします。RVMを使うと、複数のRubyバージョンを共存させられるのでとても便利です。(Windows上で動作する同様のソフトに<a href="http://github.com/vertiginous/pik">Pik</a>があります。)同じマシン上で異なるバージョンのRubyやRailsを実行したい場合、これは特に重要です。RVMで問題が生じたときは、作者のWayne E. SeguinとRVMのIRCチャットのチャンネル (<a href="http://webchat.freenode.net/?channels=rvm">#rvm on freenode.net</a>)で連絡を取れることがあります<sup class="footnote" id="fnref-1_11"><a href="#fn-1_11">11</a></sup>。Linuxを使用している方には、Sudobitsブログの「<a href="http://blog.sudobits.com/2012/05/02/how-to-install-ruby-on-rails-in-ubuntu-12-04-lts/">UbuntuにRuby on Railsをインストールする方法</a>」が特にお勧めです。</p>

<p><a href="http://rvm.io/rvm/install/">RVMをインストール</a>後、以下を実行してRubyをインストールします<sup class="footnote" id="fnref-1_12"><a href="#fn-1_12">12</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm get head <span class="o">&amp;&amp;</span> rvm reload
<span class="gp">$</span> rvm install 1.9.3
<span class="go">&lt;しばらく待つ&gt;</span>
</pre></div>
</div>


<p>最初のコマンドはRVMの更新とリロードを行います。RVMは頻繁に更新されているので、RVM操作の際にはこれを行うようにしてください。次のコマンドはRuby 1.9.3をインストールします。システムによってはダウンロードとコンパイルに多少時間がかかることがありますので、なかなか終わらなくても心配せずに待ってください。</p>

<p>OS Xユーザーの場合、<code>autoconf</code>の実行ファイルがないと問題が生じることがあります。この場合は<a href="http://mxcl.github.com/homebrew/">Homebrew</a><sup class="footnote" id="fnref-1_13"><a href="#fn-1_13">13</a></sup>というOS X用のパッケージ管理システムをインストールしてから以下を実行してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> brew install automake
<span class="gp">$</span> rvm install 1.9.3
</pre></div>
</div>


<p>Linuxユーザーの場合、OpenSSLというライブラリへのパスを追加する必要が生じることがあるとの報告を受けました。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm install 1.9.3 --with-openssl-dir<span class="o">=</span><span class="nv">$HOME</span>/.rvm/
</pre></div>
</div>


<p>一部の古いOS Xシステムでは、readlineライブラリへのパスを追加する必要が生じる場合があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm install 1.9.3 --with-readline-dir<span class="o">=</span>/opt/local
</pre></div>
</div>


<p>(何度も書きましたが、環境構築にトラブルはつきものです。地道にネットを検索し、問題を特定することが唯一の解決策です。)</p>

<p>Rubyをインストールしたら、Railsのアプリケーションを実行するために必要な他のソフトウェア向けにシステムを構成する必要があります。通常、これは<em>gem</em>のインストールに関連します。gemとは自己完結型のRubyコードのパッケージです。バージョン番号の異なるgem同士がコンフリクトすることがあるため、一連のgemを自己完結的にまとめた<em>gemset</em>というものを作成してバージョンを使い分けるのが便利です。本書のチュートリアル用に、以下の要領で<code>rails3tutorial2ndEd</code>というgemsetをぜひ作成しておいてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm use 1.9.3@rails3tutorial2ndEd --create --default
<span class="go">Using /Users/mhartl/.rvm/gems/ruby-1.9.3 with gemset rails3tutorial2ndEd</span>
</pre></div>
</div>


<p>このコマンドを実行すると、Ruby 1.9.3に関連付けて<code>rails3tutorial2ndEd</code>というgemsetを作成し (<tt class="verb">--create</tt>オプション)、このgemsetをただちに使用可能にします (<tt class="verb">use</tt>)とデフォルト指定用の(<tt class="verb">--default</tt>)。以後、<code>1.9.3@rails3tutorial2ndEd</code>というRubyとgemsetの組み合わせがすべてのターミナルウィンドウで使用可能になります。RVMにはgemset管理のためのコマンドが多数用意されています。詳細については<a href="http://rvm.io/gemsets/">http://rvm.beginrescueend.com/gemsets/</a>を参照してください。RVMがうまく動かない場合は以下を実行してヘルプを表示してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm --help
<span class="gp">$</span> rvm gemset --help
</pre></div>
</div>


<div class="label" id="sec-install_rubygems"></div>


<h4><a id="sec-1_2_2_4" href="#sec-install_rubygems" class="heading">RubyGemsのインストール</a></h4>


<p>RubyGemsはRubyのプロジェクトのためのパッケージマネージャであり、Rubyのパッケージ (<em>gem</em>) として利用できる多くの有用なライブラリがあります。Railsもgemとしてインストールします。Rubyがインストールされていれば、RubyGemsは簡単にインストールできます。<a href="http://rvm.io/rvm/install/">RVMをインストール</a>してあれば、既にRubyGemsも同時にインストールされているはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> which gem
<span class="go">/Users/mhartl/.rvm/rubies/ruby-1.9.3-p0/bin/gem</span>
</pre></div>
</div>


<p>RubyGemsがインストールされていない場合は、<a href="http://rubyforge.org/frs/?group_id=126">RubyGemsをダウンロード</a>して解凍し、作成された<code>rubygems</code>ディレクトリでセットアッププログラムを実行して下さい。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> ruby setup.rb
</pre></div>
</div>


<p>(アクセス権の問題が生じたら、<a class="ref" href="#sec-conventions">1.1.3</a>を参照してください。おそらく<code>sudo</code>コマンドを併用する必要があります。)</p>

<p>既にRubyGemsがインストールされている場合は、システムをチュートリアルで使われているバージョンに更新して下さい。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> gem update --system 1.8.24
</pre></div>
</div>


<p>システムを特定のバージョンに固定しておけば、今後RubyGemsが変更されたときのコンフリクトを防止できます。</p>

<p>gemをインストールすると、RubyGemsによってriとrdocという2種類のドキュメントがデフォルトで作成されます。多くのRubyやRailsの開発者はこれらのドキュメントが自動生成される時間すら惜しいと考えます。(多くのプログラマーはネイティブのriやrdocなど参照せず、さっさとオンラインドキュメントを見に行ってしまいます。) riやrdocの自動生成を抑制するには、<code>.gemrc</code>というファイルを<a class="ref" href="#code-create_gemrc">リスト1.1</a>のようにホームディレクトリに作成し、そこに<a class="ref" href="#code-gemrc">リスト1.2</a>の内容を追加しておきます。(チルダ“<tt class="verb">~</tt>”は「ホームディレクトリ」を表します。 <code>.gemrc</code>ファイルのようにファイル名冒頭にドット「<tt class="verb">.</tt>」を付けると隠しファイルとして扱われます。Unixの設定ファイルにはこのような名前を付けるのが習わしとなっています。)</p>

<div class="label" id="code-create_gemrc"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.1</span> <span class="description">gem設定ファイルを作成する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> subl ~/.gemrc
</pre></div>
</div></div>


<p>冒頭の<code>subl</code>はOS Xで Sublime Textを起動するコマンドです。 設定方法については<a href="http://www.sublimetext.com/docs/2/osx_command_line.html">OS X コマンドライン用Sublime Text 2ドキュメント</a> (英語) を参照してください。使用しているプラットフォームやエディタが異なる場合、sublを他のエディタコマンドに読み替えてください (エディタのアイコンをダブルクリックするか、<code>mate</code>、<code>vim</code>、<code>gvim</code>、<code>mvim</code>などのコマンドに差し替えます)。記述を簡素化するため、本書で以後<code>subl</code>と書かれていたら各自好みのエディタに読み替えてください。</p>

<div class="label" id="code-gemrc"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.2</span> <span class="description"><code>.gemrc</code>にriとrdoc生成を抑制するコマンドを追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">install:</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">rdoc</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">ri</span>
<span class="ss">update:</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">rdoc</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">ri</span>
</pre></div>
</div></div>




<div class="label" id="sec-install_rails"></div>


<h4><a id="sec-1_2_2_5" href="#sec-install_rails" class="heading">Railsのインストール</a></h4>


<p>RubyGemsをインストールしてしまえば、Railsのインストールは簡単です。本書ではRails 3.2で統一します。以下を実行して3.2をインストールしてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> gem install rails -v 3.2.13
</pre></div>
</div>


<p>正しくインストールされたかどうかを確認するには、以下のコマンドを実行してバージョンを確認してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails -v
<span class="go">Rails 3.2.13</span>
</pre></div>
</div>


<p><em>メモ: </em> <a class="ref" href="#sec-rails_installer_windows">1.2.2.1</a>でRailsインストーラを使用してRailsをインストールした場合、Railsのバージョンが異なっている可能性があります。この記事の執筆時点では、このバージョンの違いは影響していません。ただし、今後Railsのバージョンが本書指定のものから離れていくにつれ、バージョンの違いによる影響が顕著になる可能性があります。特定のバージョンのRailsインストーラへのリンクを作成してもらえるよう、現在Engine Yardに働きかけています。</p>

<p>Linuxを実行している場合は、この時点で、他にもいくつかのパッケージをインストールする必要が生じる場合があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> sudo apt-get install libxslt-dev libxml2-dev libsqlite3-dev <span class="c"># Linuxのみ</span>
</pre></div>
</div>




<div class="label" id="sec-the_first_application"></div>


<h3><a id="sec-1_2_3" href="#sec-the_first_application" class="heading"><span class="number">1.2.3</span>最初のアプリケーション</a></h3>


<p>どんなRailsアプリケーションも最初の作成手順は同じです。<code>rails new</code>コマンドを実行して作成します。このコマンドを実行するだけで、指定のディレクトリにRailsアプリケーションのスケルトンを簡単に作成できます。これを行うには、まず複数のRailsプロジェクトを保存するためのディレクトリを作成し、<code>rails new</code>を実行して最初のアプリケーションを作成します (<a class="ref" href="#code-rails_command">リスト1.3</a>)。</p>

<div class="label" id="code-rails_command"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.3</span> <span class="description"><code>rails new</code>を実行してアプリケーションを新規作成する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> mkdir rails_projects
<span class="gp">$</span> <span class="nb">cd </span>rails_projects
<span class="gp">$</span> rails new first_app
<span class="go">      create  </span>
<span class="go">      create  README.rdoc</span>
<span class="go">      create  Rakefile</span>
<span class="go">      create  config.ru</span>
<span class="go">      create  .gitignore</span>
<span class="go">      create  Gemfile</span>
<span class="go">      create  app</span>
<span class="go">      create  app/assets/images/rails.png</span>
<span class="go">      create  app/assets/javascripts/application.js</span>
<span class="go">      create  app/assets/stylesheets/application.css</span>
<span class="go">      create  app/controllers/application_controller.rb</span>
<span class="go">      create  app/helpers/application_helper.rb</span>
<span class="go">      create  app/mailers</span>
<span class="go">      create  app/models</span>
<span class="go">      create  app/views/layouts/application.html.erb</span>
<span class="go">      create  app/mailers/.gitkeep</span>
<span class="go">      create  app/models/.gitkeep</span>
<span class="go">      create  config</span>
<span class="go">      create  config/routes.rb</span>
<span class="go">      create  config/application.rb</span>
<span class="go">      create  config/environment.rb</span>
<span class="go">      .</span>
<span class="go">      .</span>
<span class="go">      .</span>
<span class="go">      create  vendor/plugins</span>
<span class="go">      create  vendor/plugins/.gitkeep</span>
<span class="go">         run  bundle install</span>
<span class="go">Fetching source index for https://rubygems.org/</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">Your bundle is complete!</span><span class="go">Use `bundle show [gemname]` to see where a bundled</span>
<span class="go">gem is installed.</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-rails_command">Listing 1.3</a>の下の方に注目してください。<code>rails new</code>を実行すると、ファイルの作成後に<code>bundle install</code>コマンドが自動的に実行されています。もしbundle installが実行されていなくても心配はいりません。落ち着いて<a class="ref" href="#sec-bundler">1.2.4</a>の手順に従えば実行できます。</p>

<p><code>rails</code>コマンドによって非常に多くのファイルとディレクトリが作成されていることにご注目ください。ディレクトリとファイルの構造 ( <a class="ref" href="#fig-directory_structure_rails_3_2">図1.2</a>) がこのように標準化されていることは数あるRailsの利点の１つであり、実際に動作するアプリケーションを何も無い状態からただちに作成することができるのです。さらに、この構造はすべてのRailsアプリに共通しているので、他の開発者の書いたコードの挙動を容易に推察できます。Railsがデフォルトで作成するファイルについては<a class="ref" href="#table-rails_directory_structure">表1.1</a>を参照してください。本書を通してこれらのファイルやディレクトリの目的を学んでいきます。特に、<a class="ref" href="#sec-the_asset_pipeline">5.2.1</a>以降ではRails 3.1の新機能である<em>アセットパイプライン</em>の一部となる<code>app/assets</code>ディレクトリについて詳しく説明します。アセットパイプラインによって、CSS (Cascading Style Sheet) やJavaScriptファイルなどのアセットを簡単に編成したりデプロイすることができます。</p>

<div class="label" id="fig-directory_structure_rails_3_2"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/directory_structure_rails_31.png" alt="directory_structure_rails_31" /></span></div><div class="caption"><span class="header">図1.2: </span><span class="description">新規作成されたRailsアプリケーションのディレクトリ構造。<a href="http://railstutorial.org/images/figures/directory_structure_rails_31-full.png">(拡大)</a></span></div></div>




<div class="label" id="table-rails_directory_structure"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>ファイル/ディレクトリ</strong></th><th class="align_left"><strong>目的</strong></th></tr><tr class="top_bar"><td class="align_left"><code>app/</code></td><td class="align_left">モデル、ビュー、コントローラ、ヘルパーなどを含む主要なアプリケーションコード</td></tr><tr><td class="align_left"><code>app/assets</code></td><td class="align_left">アプリケーションで使用するCSS (Cascading Style Sheet)、JavaScriptファイル、画像などのアセット</td></tr><tr><td class="align_left"><code>config/</code></td><td class="align_left">アプリケーションの設定</td></tr><tr><td class="align_left"><code>db/</code></td><td class="align_left">データベース関連のファイル</td></tr><tr><td class="align_left"><code>doc/</code></td><td class="align_left">マニュアルなど、アプリケーションのドキュメント</td></tr><tr><td class="align_left"><code>lib/</code></td><td class="align_left">ライブラリモジュール</td></tr><tr><td class="align_left"><code>lib/assets</code></td><td class="align_left">ライブラリで使用するCSS (Cascading Style Sheet)、JavaScriptファイル、画像などのアセット</td></tr><tr><td class="align_left"><code>log/</code></td><td class="align_left">アプリケーションのログファイル</td></tr><tr><td class="align_left"><code>public/</code></td><td class="align_left">エラーページなど、一般(Webブラウザなど)に直接公開するデータ</td></tr><tr><td class="align_left"><code>script/rails</code></td><td class="align_left">コード生成、コンソールの起動、ローカルのWebサーバの立ち上げなどに使用するRailsスクリプト</td></tr><tr><td class="align_left"><code>test/</code></td><td class="align_left">アプリケーションのテスト(<a class="ref" href="#sec-static_pages_with_rails">3.1.2</a>で作成する<code>spec/</code>ディレクトリがあるため、現在は使用されていません)</td></tr><tr><td class="align_left"><code>tmp/</code></td><td class="align_left">一時ファイル</td></tr><tr><td class="align_left"><code>vendor/</code></td><td class="align_left">サードパーティのプラグインやgemなど</td></tr><tr><td class="align_left"><code>vendor/assets</code></td><td class="align_left">サードパーティのプラグインやgemで使用するCSS (Cascading Style Sheet)、JavaScriptファイル、画像などのアセット</td></tr><tr><td class="align_left"><code>README.rdoc</code></td><td class="align_left">アプリケーションの簡単な説明</td></tr><tr><td class="align_left"><code>Rakefile</code></td><td class="align_left"><code>rake</code>コマンドで使用可能なタスク</td></tr><tr><td class="align_left"><code>Gemfile</code></td><td class="align_left">このアプリケーションに必要なGemの定義ファイル</td></tr><tr><td class="align_left"><code>Gemfile.lock</code></td><td class="align_left">アプリケーションのすべてのコピーが同じgemのバージョンを使用していることを確認するために使用されるgemのリスト</td></tr><tr><td class="align_left"><code>config.ru</code></td><td class="align_left"><a href="http://rack.rubyforge.org/doc/">Rackミドルウェア</a>用の設定ファイル</td></tr><tr><td class="align_left"><code>.gitignore</code></td><td class="align_left">Gitに無視させたいファイルを指定するためのパターン</td></tr></table></div><div class="caption"><span class="header">表1.1: </span> <span class="description">デフォルトのRailsフォルダ構造まとめ。</span></div></div>




<div class="label" id="sec-bundler"></div>


<h3><a id="sec-1_2_4" href="#sec-bundler" class="heading"><span class="number">1.2.4</span> Bundler</a></h3>


<p>Railsアプリケーションを新規作成したら、次は<em>Bundler</em>を実行して、アプリケーションに必要なgemをインストールおよびインクルードします。<a class="ref" href="#sec-the_first_application">1.2.3</a>でも簡単に説明したように、Bundlerは<code>rails</code>によって自動的に実行 (この場合は<code>bundle install</code>) されます。ここではデフォルトのアプリケーションgemを変更してBundlerを再度実行してみます。そのためにまず、好みのエディタで<code>Gemfile</code>を開きます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd </span>first_app/
<span class="gp">$</span> SUBL Gemfile</pre></div>
</div>


<p>ファイルの内容は<a class="ref" href="#code-default_gemfile">リスト1.4</a>のようになっているはずです。Gemfileの内容はRubyのコードですが、ここでは文法を気にする必要はありません。Rubyについては<a class="ref" href="#cha-rails-flavored-ruby">第4章</a>でもっとくわしく説明します。</p>

<div class="label" id="code-default_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.4</span> <span class="description"><code>first_app</code>ディレクトリ直下にあるデフォルトの<code>Gemfile</code>。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>

<span class="c1"># Bundle edge Rails instead:</span>
<span class="c1"># gem &#39;rails&#39;, :git =&gt; &#39;git://github.com/rails/rails.git&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span>


<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;~&gt; 3.2.3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.2&#39;</span>

  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span>

<span class="c1"># To use ActiveModel has_secure_password</span>
<span class="c1"># gem &#39;bcrypt-ruby&#39;, &#39;~&gt; 3.0.0&#39;</span>

<span class="c1"># To use Jbuilder templates for JSON</span>
<span class="c1"># gem &#39;jbuilder&#39;</span>

<span class="c1"># Use unicorn as the web server</span>
<span class="c1"># gem &#39;unicorn&#39;</span>

<span class="c1"># Deploy with Capistrano</span>
<span class="c1"># gem &#39;capistrano&#39;</span>

<span class="c1"># To use debugger</span>
<span class="c1"># gem &#39;ruby-debug19&#39;, :require =&gt; &#39;ruby-debug&#39;</span>
</pre></div>
</div></div>


<p>ほとんどの行はハッシュシンボル <code>#</code>でコメントされています。これらの行では、よく使われているgemとBundlerの文法の例をコメント形式で紹介しています。この時点では、デフォルト以外のgemは使用しません。 デフォルトは、Rails自体のgem、アセットパイプライン関連のいくつかのgem (<a class="ref" href="#sec-the_asset_pipeline">5.2.1</a>)、JQuery JavaScriptライブラリ関連のgem、<a href="http://www.sqlite.org/">SQLiteデータベース</a>へのRubyインターフェイス用gemです。</p>

<p><code>gem</code> コマンドで特定のバージョン番号を指定しない限り、Bundlerは自動的に最新バージョンのgemを取得してインストールしてくれます。残念ながらgemを更新すると小さな問題を起こすことがよくあるので、<a class="ref" href="#code-default_gemfile">リスト1.4</a>からコメントアウト行を除いた<a class="ref" href="#code-gemfile_sqlite_version">リスト1.5</a>に示したように、このチュートリアルではたいていの場合動作確認済みのバージョン番号を指定しています。</p>

<div class="label" id="code-gemfile_sqlite_version"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.5</span> <span class="description">gemのバージョンを指定した<code>Gemfile</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
<span class="k">end</span>


<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>

  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-gemfile_sqlite_version">リスト1.5</a>ではJQueryの行を変更しています。JQueryはRailsでデフォルトで使用されるJavaScriptのライブラリです。</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span>
</pre></div>
</div>


<p>上を以下のように変更します。</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>
</pre></div>
</div>


<p>他にも変更を行います。</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span>
</pre></div>
</div>


<p>上を以下のように変更します。</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>この変更を行うと、Bundlerは<code>sqlite3</code> gemの<code>1.3.5</code>を強制的にインストールします。ここではさらに、SQLiteをdevelopment環境 (<a class="ref" href="#sec-rails_environments">7.1.1</a>) でのみ使用するための指定も行なっていることに注意してください。こうすることで、Heroku (<a class="ref" href="#sec-deploying">1.4</a>) で使用するデータベースソフトウェアと衝突する可能性を避けられます。</p>

<p><a class="ref" href="#code-gemfile_sqlite_version">リスト1.5</a>では他にもいくつかの変更を行なっています。</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;~&gt; 3.2.3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.2.3&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上を以下のように変更します。</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>以下の構文を実行すると</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.2.3&#39;</span>
</pre></div>
</div>


<p><code>uglifier</code>のバージョンが<code>1.2.3</code>以上であれば最新バージョンのgemがインストールされます。 極端に言えばバージョンが<code>7.2</code>であってもそれが最新ならインストールされます。なお、uglifierはアセットパイプラインでファイル圧縮を行うためのものです。一方、以下のコードを実行すると</p>

<div class="code"><div class="highlight"><pre><span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.2&#39;</span>
</pre></div>
</div>


<p><code>coffee-rails</code> (これもアセットパイプラインで使用するgemです) のバージョンが<code>3.3</code> より小さい場合にインストールします。つまり、<tt class="verb">&gt;=</tt>と書くと必ずアップグレードが行われますが、<tt class="verb">~&gt; 3.2.2</tt>と書くとマイナーなアップグレードしか行われないことになります。この場合<code>3.2.1</code> から<code>3.2.2</code>へのアップグレードは行われますが、<code>3.2</code>から <code>3.3</code>へのアップグレードは行われません。経験上、残念ながらマイナーアップグレードですら問題を引き起こすことがあります。このため、<em>Railsチュートリアル</em>では基本的にすべてのgemでバージョンをピンポイントで指定してます。(例外として、執筆時点でベータ版やRC (Release Candidate) 版のgemについては<tt class="verb">~&gt;</tt>を使用し、最終版がリリースされたときに読み込まれるようにしてあります。) 主にベテラン開発者の方へ: <code>Gemfile</code>で<tt class="verb">~&gt;</tt>が指定されているgemも含め、基本的にはなるべく最新のgemを使用してください。ただし、それによって本書に記載されているのと異なる挙動を示す可能性がある点にご注意ください。</p>

<p><code>Gemfile</code>を正しく設定した後、<code>bundle update</code><sup class="footnote" id="fnref-1_14"><a href="#fn-1_14">14</a></sup>と<code>bundle install</code>を使用してgemをインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle update
<span class="gp">$</span> bundle install
<span class="go">Fetching source index for https://rubygems.org/</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
</pre></div>
</div>


<p>OS Xユーザーの場合、このときに<code>ruby.h</code>などのRubyヘッダファイルがないというエラーが表示されることがあります。その場合はXcodeをインストールしてください。この開発ツールはOS Xのインストーラディスクに含まれていますが、フルインストールするのは大げさなので、サイズの小さい<a href="https://developer.apple.com/downloads/">Command Line Tools for Xcode</a><sup class="footnote" id="fnref-1_15"><a href="#fn-1_15">15</a></sup>だけをインストールすることをお勧めします。Nokogiri gemのインストール中にlibxsltエラーが発生した場合は、以下のようにRubyを再インストールしてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm reinstall 1.9.3
<span class="gp">$</span> bundle install
</pre></div>
</div>


<p><code>bundle install</code>コマンドの実行にはしばらく時間がかかるかもしれません。完了後、アプリケーションが実行可能になります。<em>注: </em>このセットアップ方法は最初のアプリケーションにはよいのですが、理想的な方法ではありません。<a class="ref" href="#cha-static-pages">第3章</a>ではBundlerを使用してRuby gemをインストールするためのさらに強力で複雑な方法をご紹介します。</p>

<div class="label" id="sec-rails_server"></div>


<h3><a id="sec-1_2_5" href="#sec-rails_server" class="heading"><span class="number">1.2.5</span> <tt>rails server</tt></a></h3>


<p><a class="ref" href="#sec-the_first_application">1.2.3</a>の<code>rails new</code>コマンドと<a class="ref" href="#sec-bundler">1.2.4</a>の<code>bundle install</code>コマンドを実行したおかげで、実際に動かすことのできるアプリケーションが作成されました。うれしいことに、Railsには開発マシンからのみブラウズできる<em>ローカル</em>Webサーバを起動させるためのコマンドラインプログラム (<em>スクリプト</em>) が付属しているので、以下のコマンドを実行するだけで簡単に起動することができます<sup class="footnote" id="fnref-1_16"><a href="#fn-1_16">16</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails server
<span class="go">=&gt; Booting WEBrick</span>
<span class="go">=&gt; Rails application starting on http://0.0.0.0:3000</span>
<span class="go">=&gt; Call with -d to detach</span>
<span class="go">=&gt; Ctrl-C to shutdown server</span>
</pre></div>
</div>


<p>(JavaScriptランタイムがインストールされていないというエラーが表示された場合は、<a href="https://github.com/sstephenson/execjs">GitHubのexecjsページ</a>にあるインストール可能なランタイムを確認してください。<a href="http://nodejs.org/">Node.js</a>が特にお勧めです。) 表示されたメッセージは、RailsアプリケーションがIPaddress<code>0.0.0.0</code>、<a href="http://en.wikipedia.org/wiki/TCP_and_UDP_port">ポート番号</a> 3000<sup class="footnote" id="fnref-1_17"><a href="#fn-1_17">17</a></sup>で動作していることを示しています。このIPアドレスは、このマシンに設定されているすべてのIPアドレスで受信待ち (listen) するように指定しています。これにより、<code>127.0.0.1</code>(<code>localhost</code>)という特別なアドレスでアプリケーションをブラウズできます。<a class="ref" href="#fig-riding_rails_31">図1.3</a>は、<a href="http://localhost:3000/">http://localhost:3000/</a>をブラウザで表示した時の結果です。</p>

<div class="label" id="fig-riding_rails_31"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/riding_rails_31.png" alt="riding_rails_31" /></span></div><div class="caption"><span class="header">図1.3:</span> <span class="description">デフォルトのRailsページ。 <a href="http://railstutorial.org/images/figures/riding_rails_31-full.png">（拡大）</a></span></div></div>


<p>この最初のアプリケーションの情報を見るには、「About your application’s environment」のリンクをクリックして下さい。<a class="ref" href="#fig-riding_rails_32_environment">図1.4</a>のような画面が表示されます (<a class="ref" href="#fig-riding_rails_32_environment">図1.4</a>は私の環境でキャプチャしたものなので、これとは若干異なる可能性があります)。</p>

<div class="label" id="fig-riding_rails_32_environment"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/riding_rails_32_environment.png" alt="riding_rails_32_environment" /></span></div><div class="caption"><span class="header">図1.4:</span> <span class="description">アプリケーション環境が表示されているデフォルトページ<a href="http://railstutorial.org/images/figures/riding_rails_32_environment-full.png">（拡大）</a></span></div></div>


<p>もちろん、いずれデフォルトのRailsページは不要になりますが、アプリケーションが動いているのを見るのは気分のいいものです。<a class="ref" href="#sec-rails_routes">5.3.2</a>ではこのデフォルトページを削除し、カスタマイズしたホームページに置き換えます。</p>

<div class="label" id="sec-mvc"></div>


<h3><a id="sec-1_2_6" href="#sec-mvc" class="heading"><span class="number">1.2.6</span> Model-View-Controller (MVC)</a></h3>


<p>まだ始まったばかりですが、今のうちにRailsアプリケーションの全体的な仕組みを知っておくことは後々役立ちます (<a class="ref" href="#fig-MVC">図1.5</a>)。デフォルトのRailsアプリ構造 (<a class="ref" href="#fig-directory_structure_rails_3_2">図1.2</a>) を眺めてみると、<code>app/</code>というディレクトリがあり、その中に「<code>models</code>」「<code>views</code>」「<code>controllers</code>」という3つのサブディレクトリがあることに気付いた方もいると思います。ここにはRailsが<a href="http://en.wikipedia.org/wiki/Model-view-controller">MVC (model-view-controller)</a> というアーキテクチャパターンを採用していることが暗に示されています。MVCでは、ドメインロジック (ビジネスロジックともいいます) と、グラフィカルユーザーインターフェース (GUI) と密に関連する入力/表示ロジックを分離します。Webアプリケーションの場合、「ドメインロジック」はユーザーや記事、商品などのデータモデルに相当し、ユーザーインターフェースはWebページを指します。</p>

<p>Railsアプリと通信する際、ブラウザは一般的にWebサーバに<em>request</em> (リクエスト) を送信し、これはリクエストを処理する役割を担っているRailsの<em>controller</em> (コントローラ) に渡されます。 コントローラは、場合によってはすぐに<em>view</em> (ビュー) を生成してHTMLをブラウザに送り返します。動的なサイトでは、一般にコントローラは (ユーザーなどの) サイトの要素を表しており、データベースとの通信を担当しているRubyのオブジェクトである<em>model</em> (モデル) と対話します。モデルを呼び出した後、コントローラは、ビューをレンダリングし、完成したWebページをHTMLとしてブラウザに返します。</p>

<div class="label" id="fig-MVC"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/mvc_schematic.png" alt="mvc_schematic" /></span></div><div class="caption"><span class="header">図1.5: </span> <span class="description">model-view-controller (MVC) アーキテクチャの概念図。</span></div></div>


<p>今はまだこの解説が少し抽象的に思えるかもしれませんが、この章は後に何度も参照する事になるのでご安心ください。さらに、 <a class="ref" href="#sec-mvc_in_action">2.2.2</a>のデモアプリケーションの説明の中で、MVCについてもっと詳しく解説します。サンプリアプリケーションでは、MVCの3つの要素をすべて使用します。<a class="ref" href="#sec-static_pages_with_rails">3.1.2</a>ではまずコントローラとビューを使用し、モデルは<a class="ref" href="#sec-user_model">6.1</a>から使い始めます。 <a class="ref" href="#sec-a_users_resource">7.1.2</a>では3つの要素が協調して動作します。</p>

<div class="label" id="sec-version_control"></div>


<h2><a id="sec-1_3" href="#sec-version_control" class="heading"><span class="number">1.3</span> Gitによるバージョン管理</a></h2>


<p>新しく動作するRailsアプリが完成したところで、さっそくアプリケーションのソースコードを<em>バージョン管理</em>下に置きましょう。これを行わないとアプリケーションが動かないということではありませんが、ほとんどのRails開発者はバージョン管理は開発現場において必要不可欠であると考えています。バージョン管理システムを導入しておけば、プロジェクトのコードの履歴を追ったり、うっかり削除してしまったファイルを復旧 (ロールバック) したりという作業が行えるようになります。バージョン管理システムを熟知することは、今やあらゆるソフトウェア開発者にとって必須のスキルであると言ってよいでしょう。</p>

<p>バージョン管理システムにもさまざまなものがありますが、RailsコミュニティではLinuxカーネル用にLinus Torvaldsにより開発された分散バージョン管理システムである<a href="http://git-scm.com/">Git</a>が主流になっています。Git (というよりバージョン管理) はそれだけで大きなテーマなので、すべてを説明しようとすると軽く一冊の本を超えてしまいます。本書では簡単に言及するにとどめますが、幸いネット上には無償で利用できるリソースがあふれています。その中でも特に「<a href="http://progit.org"><em>Pro Git</em></a>」Scott Chacon (Apress, 2009) をお勧めいたします (訳注: Pro Gitには素晴らしい日本語版があります: http://git-scm.com/book/ja/ )。ソースコードのバージョン管理は<em>何としても</em>導入してください。バージョン管理はRailsを使用するどんな場面でも必要になりますし、バージョン管理システムを応用して、自分の作成したコードを他の開発者と簡単に共有したり <a class="ref" href="#sec-github">1.3.4</a>)、最初の章で作成したアプリケーションを本番サーバーへデプロイしたりすることもできる (<a class="ref" href="#sec-deploying">1.4</a>) からです。</p>

<div class="label" id="sec-git_setup"></div>


<h3><a id="sec-1_3_1" href="#sec-git_setup" class="heading"><span class="number">1.3.1</span>インストールとセットアップ</a></h3>


<p>Gitがインストールされていない場合は、まず<a class="ref" href="#sec-install_git">1.2.2.2</a>に従ってGitをインストールしてください (リンク先の節でも述べているように、<a href="http://progit.org/book/ch1-4.html"><em>Pro Git</em>の「Gitのインストール</a>」の記載に従うことになります)。</p>

<h4><a id="sec-1_3_1_1" href="#sec-1_3_1_1" class="heading">最初のシステムセットアップ</a></h4>


<p>Gitのインストール後、最初に1回だけ行う必要のある設定があります。これは<em>system</em>セットアップと呼ばれ、使用するコンピュータ1台につき1回だけ行います。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git config --global user.name <span class="s2">&quot;あなたの名前&quot;</span>
<span class="gp">$</span> git config --global user.email your.email@example.com
</pre></div>
</div>


<p>私の場合、<code>checkout</code> という長ったらしいコマンドの代わりに<code>co</code>という短いコマンド (エイリアス) も使えるようにしています。これを行うには以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git config --global alias.co checkout
</pre></div>
</div>


<p>本書では、<code>co</code>エイリアスを設定していないシステムでも動作するようにフルスペルの<code>checkout</code>を使用していますが、私自身は実際の開発ではほとんどいつも<code>git co</code>を使ってプロジェクトをチェックアウトしています。</p>

<p>手順の最後として、Gitのコミットメッセージを入力するときに使用するエディタを設定できます。Sublime Text、TextMate、gVim、MacVimなどのGUIエディタを使用する場合、シェルから離れずシェル内で起動するようフラグを付けてください<sup class="footnote" id="fnref-1_18"><a href="#fn-1_18">18</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git config --global core.editor <span class="s2">&quot;subl -w&quot;</span>
</pre></div>
</div>


<p><code>&quot;subl -w&quot;</code> の部分は、TextMateの場合は <code>&quot;mate -w&quot;</code>、gVimの場合は<code>&quot;gvim -f&quot;</code>、MacVimの場合は<code>&quot;mvim -f&quot;</code> にそれぞれ置き換えます。</p>

<h4><a id="sec-1_3_1_2" href="#sec-1_3_1_2" class="heading">最初のリポジトリセットアップ</a></h4>


<p>今度は、<em>レポジトリ</em>を作成するたびに必要な作業を行います。まず、Railsアプリケーションのルートディレクトリに移動し、新しいリポジトリの初期化を行います。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="go">Initialized empty Git repository in /Users/mhartl/rails_projects/first_app/.git/</span>
</pre></div>
</div>


<p>次に、プロジェクトのファイルをリポジトリに追加します。ここで１つ問題点があります。Gitは<em>すべての</em>ファイルの変更履歴を管理するようになっていますが、管理対象に含めたくないファイルもあります。たとえば、Railsによって作成されるログファイルは頻繁に内容が変わるので、いちいちバージョン管理に更新させたくありません。Gitにはこういったファイルを管理対象から除外する機能があります。<code>.gitignore</code>というファイルをアプリケーションのルートディレクトリに置き、除外したいファイルを指定するためのルールをそこに記載します。<sup class="footnote" id="fnref-1_19"><a href="#fn-1_19">19</a></sup></p>

<p><a class="ref" href="#table-rails_directory_structure">表1.1</a>をもう一度見てみると、<code>rails</code>コマンドを実行した時にRailsアプリケーションのルートディレクトリに<code>.gitignore</code>ファイルが作成されています (<a class="ref" href="#code-default_gitignore">リスト1.6</a>)。</p>

<div class="label" id="code-default_gitignore"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.6</span> <span class="description"><code>rails</code>コマンドで作成されるデフォルトの<code>.gitignore</code>ファイルの内容。</span> </div>
<div class="code"><div class="highlight"><pre># See http://help.github.com/ignore-files/ for more about ignoring files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile ~/.gitignore_global

# Ignore bundler config
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp
</pre></div>
</div></div>


<p><a class="ref" href="#code-default_gitignore">リスト1.6</a>の設定では、ログファイル、Railsの一時ファイル (<code>tmp</code>)、SQLiteデータベースなどが除外されます。(<code>log/</code>ディレクトリ以下のログファイルを除外したい場合は、<code>log/*.log</code>と指定することで、ファイル名が<code>.log</code>で終わるファイルが除外されます。これらのファイルは頻繁に更新されるため、バージョン管理に含めるのは何かと不便です。さらに、他の開発者と共同作業を行う場合にこのようなファイルをバージョン管理に含めると無用な衝突 (conflict) が発生し、関係者一同が無駄にいらいらすることになりかねません。</p>

<p>本書のチュートリアルでは、<a class="ref" href="#code-default_gitignore">リスト1.6</a>の<code>.gitignore</code>設定で十分です。システム環境によっては、<a class="ref" href="#code-gitignore">リスト1.7</a>のように設定するとさらに便利になることがあります。この<code>.gitignore</code>では、Railsドキュメントファイル、VimやEmacsのスワップファイル、そしてOS Xユーザーにはお馴染みの、あのいまいましい<code>.DS_Store</code>ディレクトリ (MacのFinder操作で作成される隠しディレクトリ) も管理対象から除外されます。この拡張版除外設定を使用したい場合は、<code>.gitignore</code>を好みのテキストエディタで開き、<a class="ref" href="#code-gitignore">リスト1.7</a>の内容で置き換えます。</p>

<div class="label" id="code-gitignore"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.7</span> <span class="description">より多くのパターンを除外する<code>.gitignore</code>ファイル。</span> </div>
<div class="code"><div class="highlight"><pre># Ignore bundler config
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

# Ignore other unneeded files.
doc/
*.swp
*~
.project
.DS_Store
.idea
</pre></div>
</div></div>




<div class="label" id="sec-adding_and_committing"></div>


<h3><a id="sec-1_3_2" href="#sec-adding_and_committing" class="heading"><span class="number">1.3.2</span>追加とコミット</a></h3>


<p>最後に、新しく作成したRailsプロジェクトのファイルをGitに追加し、次にそれをコミットします。ファイルを追加する (<code>.gitignore</code>で指定されているものを除く) には、以下のコマンドを実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
</pre></div>
</div>


<p>ここで「<code>.</code>」は現在のディレクトリ (カレントディレクトリ) を指します。Gitは<em>再帰的に</em>ファイルを追加できるので、自動的にすべてのサブディレクトリも追加されます。このコマンドによりプロジェクトのファイルは、コミット待ちの変更が格納されている「<em>ステージングエリア</em>」という一種の待機場所に追加されます。ステージングエリアにあるファイルのリストを表示するには、<code>status</code>コマンドを実行します<sup class="footnote" id="fnref-1_20"><a href="#fn-1_20">20</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">#</span> On branch master
<span class="gp">#</span>
<span class="gp">#</span> Initial commit
<span class="gp">#</span>
<span class="gp">#</span> Changes to be committed:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git rm --cached &lt;file&gt;...&quot;</span> to unstage<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       new file:   README.rdoc
<span class="gp">#</span>       new file:   Rakefile
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
</pre></div>
</div>


<p>（出力結果が長いので、省略された部分を示すために縦点を使っています。）</p>

<p>変更を保存するには、<code>commit</code>コマンドを使います。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -m <span class="s2">&quot;Initial commit&quot;</span>
<span class="go">[master (root-commit) df0a62f] Initial commit</span>
<span class="go">42 files changed, 8461 insertions(+), 0 deletions(-)</span>
<span class="go">create mode 100644 README.rdoc</span>
<span class="go">create mode 100644 Rakefile</span>
<span class="go">.</span>
<span class="go">.</span>
<span class="go">.</span>
</pre></div>
</div>


<p><code>-m</code>フラグは、コミットメッセージ (コミット内容の覚書) をその場で追加する場合に使用します。<code>-m</code>を省略した場合、<a class="ref" href="#sec-git_setup">1.3.1</a>で設定されたエディタが起動され、コミットメッセージの入力を求められます。</p>

<p>ここでコミットについて少し解説しておきます。Gitにおけるコミットは、あくまで<em>ローカル</em>マシン上での操作であることに注意してください。この点について、もう一つの有名なオープンソースバージョン管理システムであるSubversionとははっきり異なります。Gitの場合、コミットを実行してもリモート上にあるリポジトリを直接変更することはありません。Gitでは、ローカルでの変更保存 (<code>git commit</code>) と、リモート上のリポジトリへの変更反映 (<code>git push</code>) の2段階に分かれています。<a class="ref" href="#sec-git_commands">1.3.5</a>にはこのpushの例が記載されています。</p>

<p>ちなみに、<code>log</code>コマンドでコミットメッセージの履歴を参照できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git log
<span class="go">commit df0a62f3f091e53ffa799309b3e32c27b0b38eb4</span>
<span class="go">Author: Michael Hartl &lt;michael@michaelhartl.com&gt;</span>
<span class="go">Date:   Thu Oct 15 11:36:21 2009 -0700</span>

<span class="go">  Initial commit</span>
</pre></div>
</div>


<p><code>git log</code>を終了するには<code>q</code>キーを押してください。</p>

<h3><a id="sec-1_3_3" href="#sec-1_3_3" class="heading"><span class="number">1.3.3</span>Gitのメリット</a></h3>


<p>今の時点では、ソースコードをバージョン管理下に置かなければならない理由が今ひとつよくわからないという方がいるかもしれませんので、例を１つ紹介します (この後の章でも多くの実例を紹介します)。仮に、あなたが重要な<code>app/controllers/</code>ディレクトリを削除してしまったとしましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> ls app/controllers/
<span class="go">application_controller.rb</span>
<span class="gp">$</span> rm -rf app/controllers/
<span class="gp">$</span> ls app/controllers/
<span class="go">ls: app/controllers/: No such file or directory</span>
</pre></div>
</div>


<p>ここでは、Unixコマンドの<code>ls</code>で<code>app/controllers/</code>ディレクトリの中身を表示した後、<code>rm</code>コマンドをうっかり実行してこのディレクトリを削除してしまいました。<code>-rf</code>フラグは、「recursive」(サブディレクトリやその中のファイルもすべて削除する)、「 force」(削除して良いかどうかをユーザーに確認しない) を指定するオプションです。</p>

<p>現在の状態を確認してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">#</span> On branch master
<span class="gp">#</span> Changed but not updated:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git add/rm &lt;file&gt;...&quot;</span> to update what will be committed<span class="o">)</span>
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git checkout -- &lt;file&gt;...&quot;</span> to discard changes in working directory<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       deleted:    app/controllers/application_controller.rb
<span class="gp">#</span>
<span class="go">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</span>
</pre></div>
</div>


<p>ファイルがいくつか削除されましたが、この変更が行われたのは現在の「作業ツリー」内のみなので、まだコミット (保存) されていません。つまり、以前のコミットを<code>checkout</code>コマンド (と、現在までの変更を強制的に上書きして元に戻すための<code>-f</code>フラグ) でチェックアウトすれば、簡単に削除前の状態に戻すことができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -f
<span class="gp">$</span> git status
<span class="gp">#</span> On branch master
<span class="go">nothing to commit (working directory clean)</span>
<span class="gp">$</span> ls app/controllers/
<span class="go">application_controller.rb</span>
</pre></div>
</div>


<p>削除されたディレクトリとファイルが無事復旧しました。これでひと安心です。</p>

<div class="label" id="sec-github"></div>


<h3><a id="sec-1_3_4" href="#sec-github" class="heading"><span class="number">1.3.4</span>GitHub</a></h3>


<p>Gitを使用してプロジェクトをバージョン管理下に置くことができたので、今度は<a href="http://github.com">GitHub</a>にソースコードをアップロードしてみましょう。GitHubは、Gitリポジトリの置き場所を提供したり (ホスティング)、リポジトリを開発者同士で共有するサービスを提供するWebサービスとして有名です。GitHubにわざわざリポジトリをプッシュするのには2つの理由があります。１つ目は、ソースコード (とそのすべての変更履歴) の完全なバックアップを作成することです。２つ目は、他の開発者との共同作業をより簡単に行うことです。GitHubへのプッシュは必須ではありませんが、GitHubのメンバーになっておくと、多くのオープンソースプロジェクトに参加できるようになります。</p>

<div class="label" id="fig-create_first_repository"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/create_first_repository_new.png" alt="create_first_repository_new" /></span></div><div class="caption"><span class="header">図1.6: </span><span class="description">アカウント作成直後のGitHubページ。<a href="http://railstutorial.org/images/figures/create_first_repository_new-full.png">(拡大)</a></span></div></div>


<p>GitHubにはさまざまな有料プランがありますが、オープンソースのコードなら無料で利用できるので、初めて利用するのであれば<a href="https://github.com/signup/free">無料のGitHubアカウント</a>を作成しましょう (念のため、<a href="http://help.github.com/key-setup-redirect">GitHubのSSHキー作成方法のチュートリアル</a>を先に読んでおいてください)。 アカウント作成後、[<a href="http://github.com/new">Create repository</a>]をクリックし、<a class="ref" href="#fig-create_first_repository">図1.6</a>に従ってフォームに記入します。(注意: このときに<code>README</code>ファイルを使用してリポジトリを初期化<em>しないでください</em> 。<code>rails new</code>コマンドを実行するときにこれらのファイルが作成されるからです。) リポジトリを作成したら、以下を実行してアプリケーションをプッシュします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@github.com:&lt;username&gt;/first_app.git
<span class="gp">$</span> git push -u origin master
</pre></div>
</div>


<p>最初のコマンドは、現在のメイン (<em>master</em>) ブランチ用の &quot;origin&quot; としてGitHubに追加します。次のコマンドで実際に GitHubにプッシュします （<tt>-u</tt>フラグについては気にする必要はありません。気になるのであれば &quot;git set upstream&quot;で検索してみてください）。もちろん、<tt class="verb">&lt;username&gt;</tt>はあなたの名前に置き換えてください。たとえば、私が<code>railstutorial</code>用に実行したコマンドは以下のとおりです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@github.com:railstutorial/first_app.git
</pre></div>
</div>


<p>このコマンドを実行すると、GitHubにファイル閲覧、コミット履歴の表示など多数の機能を備えたアプリケーションのリポジトリ用のページが作成されました (<a class="ref" href="#fig-github_repository_page">図1.7</a>)。</p>

<div class="label" id="fig-github_repository_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/github_repository_page.png" alt="github_repository_page" /></span></div><div class="caption"><span class="header">図1.7: </span><span class="description">GitHubのリポジトリページ。<a href="http://railstutorial.org/images/figures/github_repository_page-full.png">(拡大)</a></span></div></div>


<p>なお、GitHubにはコマンドラインインターフェイスを拡張したGUIアプリケーションもあります。 GUIアプリケーションの方が好みであれば、<a href="http://windows.github.com/">GitHub for Windows</a>や<a href="http://mac.github.com/">GitHub for Mac</a>をチェックしてみてください  (Linux用のGitHubは今のところGitしかないようです)。</p>

<div class="label" id="sec-git_commands"></div>


<h3><a id="sec-1_3_5" href="#sec-git_commands" class="heading"><span class="number">1.3.5</span>ブランチ (branch)、変更 (edit)、 コミット (commit)、マージ (merge)</a></h3>


<p><a class="ref" href="#sec-github">1.3.4</a>,で紹介した手順を踏んでいれば、GitHubは自動的にリポジトリのメインページに<code>README</code>ファイルの内容を表示している事に気付くかもしれません。このチュートリアルでは、プロジェクトは<code>rails</code>コマンドによって作成されたRailsアプリケーションなので、<code>README</code>ファイルはRailsに既に含まれています (<a class="ref" href="#fig-rails_readme">図1.8</a>)。<code>README</code>ファイルの拡張子は<code>.rdoc</code>になっているので、GitHubでは適切なフォーマットで表示されます。しかしその内容はRailsフレームワークそのものに関するもので、そのままでは役に立ちません。この節ではREADMEの内容を編集し、プロジェクトに関する記述に置き換えます。それと同時に、Gitでbranch、edit、commit、mergeを行う際に私がお勧めしたいワークフローの実例をお見せします。</p>

<div class="label" id="fig-rails_readme"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/rails_readme_3_2.png" alt="rails_readme_3_2" /></span></div><div class="caption"><span class="header">図1.8: </span><span class="description">GitHub上の、役に立たない初期の<code>README</code>ファイル<a href="http://railstutorial.org/images/figures/rails_readme_3_2-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-git_branch"></div>


<h4><a id="sec-1_3_5_1" href="#sec-git_branch" class="heading">ブランチ (branch)</a></h4>


<p>Gitは、ブランチ (<em>branch</em>) をきわめて簡単かつ高速に作成することができます。ブランチは基本的にはリポジトリのコピーで、ブランチ上では元のファイルを触らずに新しいコードを書くなど、自由に変更や実験を試すことができます。通常、親リポジトリは<em>マスター</em>ブランチと呼ばれ、トピックブランチ (短期間だけ使う一時的なブランチ) は<code>checkout</code>と<code>-b</code>フラグを使って作成できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b modify-README
<span class="go">Switched to a new branch &#39;modify-README&#39;</span>
<span class="gp">$</span> git branch
<span class="go">master</span>
<span class="go">* modify-README</span>
</pre></div>
</div>


<p>2つ目のコマンド (<code>git branch</code>) は、単にすべてのローカルブランチを一覧表示しているだけです。「<code>*</code>」はそのブランチが現在使用中であることを表します。1番目の<code>git checkout -b modify-README</code>コマンドで、ブランチの新規作成とそのブランチへの切り替えが同時に行われていることに注目してください。<code>modify-README</code>ブランチに*が付いていることで、このブランチが現在使用中であることが示されています (<a class="ref" href="#sec-version_control">1.3</a>で<code>co</code>エイリアスを設定した場合は、<code>git co -b modify-README</code>と入力することもできます)。</p>

<p>ブランチの真価は他の開発者と共同で作業する時に発揮されますが<sup class="footnote" id="fnref-1_21"><a href="#fn-1_21">21</a></sup>、このチュートリアルのように一人で作業する時にも役立ちます。マスターブランチはトピックブランチで行った変更に影響されないので、たとえブランチ上のコードが<em>めちゃくちゃ</em>になってしまっても、マスターブランチをチェックアウトしてトピックブランチを削除すれば、いつでも変更を破棄する事ができます。具体的な方法についてはこの章の最後で説明します。</p>

<p>ちなみに、通常このような小さな変更のためにわざわざブランチを作成する必要はありませんが、ブランチがよい習慣であることに変わりはないので、少しでも練習しておきましょう。</p>

<div class="label" id="sec-git_edit"></div>


<h4><a id="sec-1_3_5_2" href="#sec-git_edit" class="heading">変更 (Edit)</a></h4>


<p>トピックブランチを作成後、READMEの内容をわかりやすく書き換えてみましょう。私の場合、デフォルトのRDocを編集するときには主に<a href="http://daringfireball.net/projects/markdown/">Markdown</a>というマークアップ言語を使用しています。拡張子を<code>.md</code>にしておけば、GitHubにアップロードしたときに自動的にドキュメントがきれいに整形されます。今回はGitに付属する<code>mv</code>コマンド (注: Unixのmvコマンドではありません!) を使ってREADMEの拡張子を変更し、それからREADMEの内容を<a class="ref" href="#code-new_readme">リスト1.8</a>の内容に書き換えます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git mv README.rdoc README.md
<span class="gp">$</span> subl README.md
</pre></div>
</div>


<div class="label" id="code-new_readme"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.8</span> <span class="description">新しい<code>README</code>ファイル (<code>README.md</code>)。</span> </div>
<div class="code"><div class="highlight"><pre># Ruby on Rails チュートリアル：サンプルアプリケーション

これは以下で使用する最初のアプリケーションです。
[*Ruby on Rails Tutorial: Learn Rails by Example*](http://railstutorial.org/)
by [Michael Hartl](http://michaelhartl.com/).
</pre></div>
</div></div>




<div class="label" id="sec-git_commit"></div>


<h4><a id="sec-1_3_5_3" href="#sec-git_commit" class="heading">コミット (commit)</a></h4>


<p>変更が終わったら、ブランチの状態を確認してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git status
<span class="gp">#</span> On branch modify-README
<span class="gp">#</span> Changes to be committed:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git reset HEAD &lt;file&gt;...&quot;</span> to unstage<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       renamed:    README.rdoc -&gt; README.md
<span class="gp">#</span>
<span class="gp">#</span> Changed but not updated:
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git add &lt;file&gt;...&quot;</span> to update what will be committed<span class="o">)</span>
<span class="gp">#</span>   <span class="o">(</span>use <span class="s2">&quot;git checkout -- &lt;file&gt;...&quot;</span> to discard changes in working directory<span class="o">)</span>
<span class="gp">#</span>
<span class="gp">#</span>       modified:   README.md
<span class="gp">#</span>
</pre></div>
</div>


<p>この時点で、<a class="ref" href="#sec-adding_and_committing">1.3.2</a>のように<code>git add .</code>を実行することもできますが、Gitには現存するすべてのファイル (git mvで作成したファイルも含む) への変更を一括でコミットする<code>-a</code>フラグがあります。このフラグは非常によく使われます。なお、<code>git mv</code>で作成されたファイルは、Gitでは新規ファイルではなく変更として扱われます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -a -m <span class="s2">&quot;Improve the README file&quot;</span>
<span class="go">2 files changed, 5 insertions(+), 243 deletions(-)</span>
<span class="go">delete mode 100644 README.rdoc</span>
<span class="go">create mode 100644 README.md</span>
</pre></div>
</div>


<p><code>-a</code>フラグは慎重に扱ってください。最後のコミット後に新しいファイルを追加した場合は、まず<code>git add</code>を実行してバージョン管理下に置く必要があります。</p>

<p>コミットメッセージは<em>現在形</em>で書くようにしましょう。Gitのモデルは、(単一のパッチではなく) 一連のパッチとしてコミットされます。そのため、コミットメッセージを書くときには、そのコミットが「何をしたのか」と履歴スタイルで書くよりも「何を<em>する</em>」ためのものなのかを書く方が、後から見返したときにわかりやすくなります。さらに、現在形で書いておけば、Gitコマンド自身によって生成されるコミットメッセージとも時制が整合します。詳細についてはGitHubに投稿された「<a href="https://github.com/blog/926-shiny-new-commit-styles">最新のコミット方法</a>」(英語) を参照してください。</p>

<div class="label" id="sec-git_merge"></div>


<h4><a id="sec-1_3_5_4" href="#sec-git_merge" class="heading">マージ (merge)</a></h4>


<p>ファイルの変更が終わったので、マスターブランチにこの変更を<em>マージ (merge)</em> します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="go">Switched to branch &#39;master&#39;</span>
<span class="gp">$</span> git merge modify-README
<span class="go">Updating 34f06b7..2c92bef</span>
<span class="go">Fast forward</span>
<span class="go">README.rdoc     |  243 --------------------------------------------------</span>
<span class="go">README.md       |    5 +</span>
<span class="go">2 files changed, 5 insertions(+), 243 deletions(-)</span>
<span class="go">delete mode 100644 README.rdoc</span>
<span class="go">create mode 100644 README.md</span>
</pre></div>
</div>


<p>Gitの出力には<code>34f06b7</code>のような文字列が含まれていることがあります。Gitはこれらをリポジトリの内部処理に使用しています。この文字列は環境の違いにより上記のものと少し異なるかもしれませんが、他の部分はほぼ同じはずです。</p>

<p>変更をマージした後は、<code>git branch -d</code>を実行してトピックブランチを削除すれば終わりです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git branch -d modify-README
<span class="go">Deleted branch modify-README (was 2c92bef).</span>
</pre></div>
</div>


<p>トピックブランチの削除は必須ではありません。実際、トピックブランチを削除せずにそのままにしておくことはよく行われています。トピックブランチを削除せずに残しておけば、トピックブランチとマスターブランチを交互に行き来して、きりの良い所で変更をマージする事ができます。</p>

<p>上で述べたように、<code>git branch -D</code>でトピックブランチ上の変更を破棄することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="c"># これはあくまで例です。ブランチでミスをした時以外は実行しないで下さい。</span>
<span class="nv">$ </span>git checkout -b topic-branch
<span class="nv">$ </span>&lt;really screw up the branch&gt;
<span class="nv">$ </span>git add .
<span class="nv">$ </span>git commit -a -m <span class="s2">&quot;Major screw up&quot;</span>
<span class="nv">$ </span>git checkout master
<span class="nv">$ </span>git branch -D topic-branch
</pre></div>
</div>


<p><code>-d</code>フラグと異なり、<code>-D</code>フラグは変更をマージしていなくてもブランチを削除してくれます。</p>

<div class="label" id="sec-git_push"></div>


<h4><a id="sec-1_3_5_5" href="#sec-git_push" class="heading">プッシュ (push)</a></h4>


<p><code>README</code>ファイルの更新が終わったので、GitHubに変更をプッシュして結果を見てみましょう。既に<a class="ref" href="#sec-github">1.3.4</a>で一度プッシュを行ったので、大抵のシステムでは<code>git push</code>を実行するときに<code>origin master</code>を省略できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
</pre></div>
</div>


<p>先ほど説明したとおり、Markdownで記述された新しいファイルはGitHubできれいにフォーマットされます (<a class="ref" href="#fig-new_readme">図1.9</a>)。</p>

<div class="label" id="fig-new_readme"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/new_readme.png" alt="new_readme" /></span></div><div class="caption"><span class="header">図1.9:</span> <span class="description">Markdownを使用してフォーマットされた改良版<code>README</code>ファイル。<a href="http://railstutorial.org/images/figures/new_readme-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-deploying"></div>


<h2><a id="sec-1_4" href="#sec-deploying" class="heading"><span class="number">1.4</span>デプロイする</a></h2>


<p>この段階では空っぽのRailsアプリケーションしかありませんが、本番環境にデプロイしてしまいましょう。アプリケーションのデプロイは必須ではありませんが、頻繁にデプロイすることによって、開発サイクルでの問題を早い段階で見つけることができます。開発環境のテストを繰り返すばかりで、いつまでも本番環境にデプロイしないままだと、アプリケーションを公開する時に思わぬ事態に遭遇する可能性が高まります<sup class="footnote" id="fnref-1_22"><a href="#fn-1_22">22</a></sup>。</p>

<p>かつてはRailsアプリのデプロイは大変な作業でしたが、ここ数年急速に簡単になってきており、さまざまな本番環境を選択できるようになりました。<a href="http://www.modrails.com/">Phusion Passenger</a> (ApacheやNginx<sup class="footnote" id="fnref-1_23"><a href="#fn-1_23">23</a></sup>Webサーバ用のモジュール) を実行できるさまざまな共有ホストや仮想プライベートサーバ (VPS) の他に、フルサービスホスティングを提供する<a href="http://engineyard.com/">Engine Yard</a>や<a href="http://railsmachine.com/">Rails Machine</a>、クラウドサービスを提供する<a href="http://cloud.engineyard.com">Engine Yard Cloud</a>や<a href="http://heroku.com/">Heroku</a>などがあります。</p>

<p>私のお気に入りはHerokuで、Railsを含むRuby Webアプリ用のホスティングプラットフォームです<sup class="footnote" id="fnref-1_24"><a href="#fn-1_24">24</a></sup>。Herokuは、ソースコードのバージョン管理にGitを使用していれば、Railsアプリケーションを簡単に本番環境にデプロイできます (Gitを導入したのは、まさにこのHerokuで使うためでもあります。まだGitをインストールしていなければ、<a class="ref" href="#sec-version_control">1.3</a>を参照してください)。この章では、私たちの最初のアプリケーションをHerokuにデプロイします。</p>

<div class="label" id="sec-heroku_setup"></div>


<h3><a id="sec-1_4_1" href="#sec-heroku_setup" class="heading"><span class="number">1.4.1</span> Herokuのセットアップ</a></h3>


<p>Herokuでは<a href="http://www.postgresql.org/">PostgreSQL</a>データベースを使用します (ちなみに発音は “post-gres-cue-ell” で、よく“Postgres”と略されます)。そのためには、production (本番) 環境に<tt>pg</tt> gemをインストールしてRailsがPostgreSQLと通信できるようにします。</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードを<a class="ref" href="#code-gemfile_sqlite_version">リスト1.5</a>の<code>Gemfile</code>に追加すると、<a class="ref" href="#code-gemfile_pg_gem">リスト1.9</a>のようになります。</p>

<div class="label" id="code-gemfile_pg_gem"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.9</span> <span class="description">PostgreSQL用の<tt>pg</tt> gemを追加した <code>Gemfile</code>。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
<span class="k">end</span>


<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>

  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>インストールの際には、<code>bundle install</code>に特殊なフラグを追加します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --without production
</pre></div>
</div>


<p><tt class="verb">--without production</tt>オプションを追加すると、 production用のgem (この場合は<tt>pg</tt>のみ) はローカルの環境にはインストールされません。(今回追加したgemは本番環境でしか使用できないように制限されているので、このコマンドを実行しても、ローカルgemはローカルの環境にインストールされません。ただし<code>Gemfile.lock</code>については、Herokuがこれを使用して本番環境のRailsアプリケーションで必要なgemを推測するため、更新しておく必要があります。)</p>

<p>次にHerokuのアカウントを新規作成して設定します。最初に<a href="http://api.heroku.com/signup">Herokuのユーザー登録</a>を行います。アカウント作成後に完了通知メールが届いたら、<a href="https://toolbelt.heroku.com/">Heroku Toolbelt</a>を使用して必要なHerokuソフトウェアをインストールします<sup class="footnote" id="fnref-1_25"><a href="#fn-1_25">25</a></sup>。次にターミナルで以下の<code>heroku</code>コマンドを実行します (実行前にターミナルの終了と再起動が必要なことがあります)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku login
</pre></div>
</div>


<p>最後に、元のRailsプロジェクトディレクトリに移動し、<code>heroku</code>コマンドを実行して、Herokuサーバー上にサンプルアプリケーション用の場所を作成します (<a class="ref" href="#code-heroku_create">リスト1.10</a>)。</p>

<div class="label" id="code-heroku_create"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト1.10</span> <span class="description">Herokuに新しいアプリケーションを作成する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects/first_app
<span class="gp">$</span> heroku create
<span class="go">Created http://stormy-cloud-5881.herokuapp.com/ |</span>
<span class="go">git@heroku.com:stormy-cloud-5881.herokuapp.com</span>
<span class="go">Git remote heroku added</span>
</pre></div>
</div></div>


<p>この<code>heroku</code>コマンドを実行すると、私たちのRailsアプリケーション専用のサブドメインが作成され、ただちにブラウザで表示可能になります。今はまだ何もありませんが、すぐにデプロイしてWebページを表示させましょう。</p>

<div class="label" id="sec-heroku_step_one"></div>


<h3><a id="sec-1_4_2" href="#sec-heroku_step_one" class="heading"><span class="number">1.4.2</span> Herokuにデプロイする (1)</a></h3>


<p>Railsアプリケーションを実際にHerokuにデプロイするには、まずGitを使用してHerokuにリポジトリをプッシュします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku master
</pre></div>
</div>


<h3><a id="sec-1_4_3" href="#sec-1_4_3" class="heading"><span class="number">1.4.3</span> Herokuにデプロイする (2)</a></h3>


<p>失礼、その2はありません。これで終わりです (<a class="ref" href="#fig-heroku_app_31">図1.10</a>)。デプロイされたアプリケーションの表示は、<code>heroku create</code> (<a class="ref" href="#code-heroku_create">リスト1.10</a>) を実行した際に生成されたアドレスをブラウザで開くだけです (もちろんここに出てくる私のアドレスではなく、あなたのアドレスを使って下さい)。<code>heroku</code>コマンドに以下の引数を与えるだけで、正しいアドレスでブラウザが起動します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div>
</div>


<p>なお、設定の関係で、&quot;About your application’s environment” リンクはHeroku上ではリンク切れになります。これは正常です。<a class="ref" href="#sec-rails_routes">5.3.2</a>ではこのデフォルトのRailsページは削除されるので、完全なサンプルアプリケーションではこのエラーは消え去ります。</p>

<div class="label" id="fig-heroku_app_31"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/heroku_app_31.png" alt="heroku_app_31" /></span></div><div class="caption"><span class="header">図1.10: </span><span class="description">Heroku上で動作しているRailsチュートリアルの最初のアプリケーション。<a href="http://railstutorial.org/images/figures/heroku_app_31-full.png">(拡大)</a></span></div></div>


<p>Herokuへのデプロイが完了した後は、アプリケーションの管理と設定にこんな美しいユーザーインターフェースを使用できます (<a class="ref" href="#fig-heroku_info">図1.11</a>)。</p>

<div class="label" id="fig-heroku_info"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/heroku_info.png" alt="heroku_info" /></span></div><div class="caption"><span class="header">図1.11: </span><span class="description">美しいHerokuのインターフェイス。<a href="http://railstutorial.org/images/figures/heroku_info-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-heroku_commands"></div>


<h3><a id="sec-1_4_4" href="#sec-heroku_commands" class="heading"><span class="number">1.4.4</span>Herokuコマンド</a></h3>


<p><a href="http://devcenter.heroku.com/heroku-command">Herokuのコマンド</a>はたくさんあるので、ここでは簡単に触れる程度にとどめますが、少しだけ使ってみましょう。アプリケーションの名前を変更してみます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku rename railstutorial
</pre></div>
</div>


<p>注意: この名前は、私のサンプルアプリケーションで既に使用していますので、他の名前を使用してください。実際は、Herokuで生成されたデフォルトのアドレスでも十分です。本当にアプリケーションの名前を変えてみたい場合は、次のようなランダムなサブドメイン名を設定し、この章の冒頭で説明したアプリケーションのセキュリティを実装してみる方法もあります。</p>

<pre class="verbatim">hwpcbmze.heroku.com
seyjhflo.heroku.com
jhyicevg.heroku.com</pre>


<p>このようなでたらめのサブドメイン名なら、アドレスを渡さない限りサイトがアクセスされる心配もありません。(ちなみに、Rubyの威力の一端をお見せするために、ランダムなサブドメイン名を生成するためのコンパクトなコードを以下に記します。</p>

<div class="code"><div class="highlight"><pre><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>
</pre></div>
</div>


<p>最高ですね。)</p>

<p>Herokuでは、サブドメインの他に独自ドメインも使用できます。(実は、この<a href="http://railstutorial.org">Ruby on RailsチュートリアルWebサイト</a>もHeroku上にあるのです。あなたが本書をオンラインで読んでいるということは、まさにHerokuにホスティングされたWebサイトを見ているということになります。) カスタムドメインや他のHeroku関連の情報については、<a href="http://devcenter.heroku.com/">Herokuドキュメント</a>を参照してください。</p>

<div class="label" id="sec-beginning_conclusion"></div>


<h2><a id="sec-1_5" href="#sec-beginning_conclusion" class="heading"><span class="number">1.5</span>最後に</a></h2>


<p>この章ではインストール、開発環境の設定、バージョン管理、本番環境へのデプロイなど、多くの課題を達成しました。ここまでの進捗をTwitterに投稿したりFacebookで通知するには以下のリンクからどうぞ。</p>

<div class="center"><a href="http://twitter.com/?status=I&#39;m%20learning%20Ruby%20on%20Rails%20with%20@railstutorial!%20http://railstutorial.org/">@railstutorialでRuby on Railsを学習中!</a><a href="http://twitter.com/?status=I&#39;m%20learning%20Ruby%20on%20Rails%20with%20@railstutorial!%20http://railstutorial.org/">http://railstutorial.org/</a></div>


<p> </p>

<p>後は、Railsを実際に勉強するだけです。一緒に頑張りましょう。</p>

<div class="footnotes">
<ol>
<li id="fn-1_1"><em>URI</em>はUniform Resource Identifierの略です。それよりやや一般性の低い<em>URL</em>はUniform Resource Locatorの略です。URIは、要するに「ブラウザのアドレスバーにあるあれ」と考えればだいたい合っています。<a class="arrow" href="#fnref-1_1">↑</a></li>
<li id="fn-1_2">http://tryruby.org/ <a class="arrow" href="#fnref-1_2">↑</a></li>
<li id="fn-1_3">http://railsforzombies.org/ <a class="arrow" href="#fnref-1_3">↑</a></li>
<li id="fn-1_4">http://railstutorial.org/screencasts <a class="arrow" href="#fnref-1_4">↑</a></li>
<li id="fn-1_5"><em>Railsチュートリアル</em>を読んでいて、チュートリアル内部の別セクション番号へのリンクをクリックして移動したら、なるべくすぐに元の場所に戻ることをお勧めします。Webページで読んでいる場合は、ブラウザの [戻る] ボタンで戻れます。Adobe ReaderやOS XのプレビューでPDF版を読んでいる場合でも、同様に戻る方法があります。Adobe Readerの場合は、ドキュメント画面を右クリックして [Previous View]をクリックします。OS X Previewの場合はメニューの <tt>[移動] &gt; [戻る]</tt> で戻れます。<a class="arrow" href="#fnref-1_5">↑</a></li>
<li id="fn-1_6"><code>sudo</code>コマンドを実行するとデフォルトでroot (スーパーユーザー) に切り替わるためか、多くの人がsudoコマンドを &quot;superuser do&quot; の略だと誤って信じています。正しくは、<code>sudo</code>は<code>su</code>コマンドと英語の “do” をつなげたものです。そして<code>su</code>コマンドは “substitute user” (ユーザーの切替) の略なのです。ターミナルで<code>man su</code>と入力すればこのことを確認できます。 <a class="arrow" href="#fnref-1_6">↑</a></li>
<li id="fn-1_7">http://railstutorial.org/help <a class="arrow" href="#fnref-1_7">↑</a></li>
<li id="fn-1_8">https://github.com/perfectionist/sample_project/wiki <a class="arrow" href="#fnref-1_8">↑</a></li>
<li id="fn-1_9">viは、Unixで古くから使用されているコマンドベースの強力なエディタです。Vimは &quot;vi improved&quot; の略です。<a class="arrow" href="#fnref-1_9">↑</a></li>
<li id="fn-1_10">https://github.com/mhartl/rails_tutorial_sublime_text <a class="arrow" href="#fnref-1_10">↑</a></li>
<li id="fn-1_11">IRCが初めてであれば、まず “irc client &lt;あなたのプラットフォーム&gt;”で検索することをお勧めします。 OS X用のネイティブクライアントとしては<a href="http://colloquy.info/">Colloquy</a>と<a href="http://limechat.net/mac/">LimeChat</a>がお勧めです。もちろんWeb版のインターフェイスもあります。<a href="http://webchat.freenode.net/?channels=rvm">http://webchat.freenode.net/?channels=rvm</a> <a class="arrow" href="#fnref-1_11">↑</a></li>
<li id="fn-1_12">場合によっては、動作させるために<a href="http://subversion.tigris.org/">Subversion</a>というバージョン管理システムをインストールしておく必要があるかもしれません。<a class="arrow" href="#fnref-1_12">↑</a></li>
<li id="fn-1_13">http://mxcl.github.com/homebrew/ <a class="arrow" href="#fnref-1_13">↑</a></li>
<li id="fn-1_14">この手順が必要となるのは、Rails gemのバージョンを変更した場合に限られます。おそらくRailsインストーラを使用している場合にしかこういうことは起こらないでしょう。他の場合にこの手順を実行しても大丈夫です。<a class="arrow" href="#fnref-1_14">↑</a></li>
<li id="fn-1_15">https://developer.apple.com/downloads/ <a class="arrow" href="#fnref-1_15">↑</a></li>
<li id="fn-1_16">Windowsユーザーの場合は代わりに<code>ruby rails server</code>と入力する必要がある場合があると<a class="ref" href="#sec-conventions">1.1.3</a>に書いてあったことを思い出してください。<a class="arrow" href="#fnref-1_16">↑</a></li>
<li id="fn-1_17">通常、Webサイトは80番ポートで受信待ちしますが、このポートを使用するには特別な権限が必要になることが多いので、Railsの開発用サーバーでは制限の少ない、番号の大きいポート (いわゆるハイナンバーポート) を使用します。<a class="arrow" href="#fnref-1_17">↑</a></li>
<li id="fn-1_18">GUIエディタの起動後もターミナルを使用し続けることはできます。ただし、Gitはデタッチ時にコミットメッセージが空のままファイルを閉じたとみなすため、コミットは中断されます。Gitのエディタオプションで<code>subl</code>や<code>gvim</code>にフラグを付けないと、このあたりの動作で頭が混乱するかもしれません (訳注: gitのエディタ設定はGUIエディタとあまり相性がよくないらしく、vimやnanoのようなコマンドベースのエディタを選択するのが無難なようです)。この注釈の意味がよくわからない場合は、無視してくださってよいです。<a class="arrow" href="#fnref-1_18">↑</a></li>
<li id="fn-1_19"><code>.gitignore</code>がディレクトリに見当たらない場合は、ファイルブラウザやエクスプローラで隠しファイルを表示するよう設定を変更する必要があるかもしれません。<a class="arrow" href="#fnref-1_19">↑</a></li>
<li id="fn-1_20"><code>git status</code>を実行したときに表示して欲しくないファイルがあれば、それらのファイルを<a class="ref" href="#code-gitignore">1.7</a>の<code>.gitignore</code>ファイルに追加してください。<a class="arrow" href="#fnref-1_20">↑</a></li>
<li id="fn-1_21">詳細については<a href="http://progit.org/book/ch3-0.html"><em>Pro Git</em>の「Gitのブランチ機能」</a>を参照してください。<a class="arrow" href="#fnref-1_21">↑</a></li>
<li id="fn-1_22"><em>Railsチュートリアル</em>のサンプル・アプリケーションでは気にする必要はありません。作りかけの恥ずかしいWebアプリケーションをネットにうっかり公開してしまわないだろうかと心配する方もいらっしゃるかと思いますが、それを防ぐための方法はいくつもありますのでご安心ください。<a class="ref" href="#sec-heroku_commands">1.4.4</a>はその方法の1つです。<a class="arrow" href="#fnref-1_22">↑</a></li>
<li id="fn-1_23">“Engine X&quot; と発音します。<a class="arrow" href="#fnref-1_23">↑</a></li>
<li id="fn-1_24">Herokuは、Ruby Webプラットフォームに<a href="http://rack.rubyforge.org/">Rackミドルウェア</a>が導入されていれば動作します。このミドルウェアは、WebフレームワークとWebサーバーの標準インターフェイスを提供します。Rackインターフェイスを導入したことで、Rubyコミュニティは大きな力を得ることができました。Rackはさまざまなフレームワークに導入されており、<a href="http://www.sinatrarb.com/">Sinatra</a>、<a href="http://ramaze.net/">Ramaze</a>、<a href="http://camping.rubyforge.org/files/README.html">Camping</a>、そしてRubyがRackを採用しています。つまり、RubyのWebアプリケーションは基本的にHerokuでサポートされているということです。<a class="arrow" href="#fnref-1_24">↑</a></li>
<li id="fn-1_25">https://toolbelt.heroku.com/ <a class="arrow" href="#fnref-1_25">↑</a></li>
</ol>
</div>




<div class="label" id="cha-a-demo-app"></div>


<h1 class="chapter"><a id="sec-2" href="#cha-a-demo-app" class="heading"><span class="number">第2章</span>デモアプリケーション</a></h1>


<p>この章では、Railsの強力な機能をいくつか紹介するためのデモアプリケーションを作成します。<em>scaffold</em>ジェネレータというスクリプトを使ってアプリケーションをすばやく生成する事により、 高度なRailsプログラミングとWebプログラミングの概要を学びます。<a class="ref" href="#sidebar-scaffolding">Box 1.1</a>で述べたように、本書の以後の章では基本的にこの逆のアプローチを取り、少しずつアプリケーションを作りながら各段階と概念を説明して行きますが、scaffoldはRailsアプリケーションの概要を素早くつかむには最適なのでこの章ではあえて使用することにします。生成されたRailsアプリケーションはブラウザのアドレスバーにURLを入力すれば動かすことができるので、これによりRailsアプリの構造、そしてRailsで推奨されている<em>RESTアーキテクチャ</em>を洞察します。</p>

<p>後に作成するサンプルアプリケーションと同様、デモアプリケーションは、<em>ユーザー</em>と、それに関連している<em>マイクロポスト</em>から成り立っています。 このデモアプリケーションはもちろん動きますが完成品ではなく、しかも多くの手順が「魔法」のように思えるかもしれません。<a class="ref" href="#cha-static-pages">第3章</a>以降で作成するサンプルアプリケーションでは同等の機能を1つ1つ手動で作成しますので、ご安心ください。その分時間がかかることになりますが、どうか最後まで本書にお付き合いいただければと思います。本書の目的は、scaffoldを使用した即席のアプローチによる表面的な理解ではなく、そこを<em>突破して</em>Railsを深いレベルまで理解することにあります。</p>

<div class="label" id="sec-planning_the_application"></div>


<h2><a id="sec-2_1" href="#sec-planning_the_application" class="heading"><span class="number">2.1</span> アプリの計画</a></h2>


<p>はじめに、デモアプリケーションをどのようなものにするか、計画を立てましょう。<a class="ref" href="#sec-the_first_application">1.2.3</a>と同じく、<code>rails</code>コマンドでアプリケーションの骨格 (フォルダ構造、デフォルトで作成されるファイル類) を生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd </span>rails_projects
<span class="gp">$</span> rails new demo_app
<span class="gp">$</span> <span class="nb">cd </span>demo_app
</pre></div>
</div>


<p>次に、Bundlerで使用する<code>Gemfile</code> をテキストエディタで編集します。<a class="ref" href="#code-demo_gemfile_sqlite_version_redux">リスト2.1</a>の内容に書き換えてください。</p>

<div class="label" id="code-demo_gemfile_sqlite_version_redux"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.1</span> <span class="description">デモアプリケーション用の<code>Gemfile</code>。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
<span class="k">end</span>


<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>

  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-demo_gemfile_sqlite_version_redux">リスト2.1</a>の内容は<a class="ref" href="#code-gemfile_pg_gem">リスト1.9</a>と同じです。</p>

<p><a class="ref" href="#sec-heroku_setup">1.4.1</a>でも説明したとおり、<tt class="verb">--without production</tt>オプションを追加することで、本番用のgemを除いたローカルgemをインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle update
<span class="gp">$</span> bundle install --without production
</pre></div>
</div>


<p>最後に、このデモアプリケーションをバージョン管理下に置きます。既に説明したとおり、<code>rails</code>コマンドを実行するとデフォルトの<code>.gitignore</code>ファイルが生成されます。システム環境によってはこのファイルを<a class="ref" href="#code-gitignore">リスト1.7</a>のように変更しておくと便利なことがあります。Gitリポジトリを初期化して最初のコミットを実行しておきます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Initial commit&quot;</span>
</pre></div>
</div>


<div class="label" id="fig-create_demo_repo"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/create_demo_repo_new.png" alt="create_demo_repo_new" /></span></div><div class="caption"><span class="header">図2.1: </span><span class="description">GitHubでデモアプリ用リポジトリを作成する。<a href="http://railstutorial.org/images/figures/create_demo_repo_new-full.png">(拡大)</a></span></div></div>


<p>必須ではありませんが、リポジトリを新規作成して (<a class="ref" href="#fig-create_demo_repo">図2.1</a>) GitHubにプッシュすることもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@github.com:&lt;username&gt;/demo_app.git
<span class="gp">$</span> git push -u origin master
</pre></div>
</div>


<p>(最初のアプリケーションのときと同様、GitHubリポジトリを初期化するときに<code>README</code>を使用<em>しない</em>ように注意してください。)</p>

<p>これで、アプリ自体を作成するための下準備が整いました。Webアプリケーションを作る際、アプリケーションで使用される構造を表すための<em>データモデル</em>を最初に作成しておくのが普通です。今回のデモアプリケーションでは、ユーザーと短いマイクロポストのみをサポートするマイクロブログを作成します。そこで、まずアプリケーションの<em>ユーザー</em>で使用するモデルを作成 (<a class="ref" href="#sec-modeling_demo_users">2.1.1</a>) し、次に<em>マイクロポスト</em> で使用するモデルを作成します (<a class="ref" href="#sec-modeling_demo_microposts">2.1.2</a>)。</p>

<div class="label" id="sec-modeling_demo_users"></div>


<h3><a id="sec-2_1_1" href="#sec-modeling_demo_users" class="heading"><span class="number">2.1.1</span>ユーザーのモデル設計</a></h3>


<p>Webでのユーザー登録の方法が多岐にわたることからもわかるように、ユーザーという概念をデータモデルで表す方法はたくさんありますが、ここではあえて最小限の構造に抑えておきます。各ユーザーには、ユニークキーとなる<code>integer</code>型のID番号 (<code>id</code>と呼びます) を割り当て、このIDに加えて一般公開される<code>string</code>型の名前 (<code>name</code>)、そして同じく<code>string</code>型のメールアドレス (<code>email</code>) を持たせます。メールアドレスはユーザー名としても使われます。ユーザーのデータモデルの概要は<a class="ref" href="#fig-demo_user_model">図2.2</a>のとおりです。</p>

<div class="label" id="fig-demo_user_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_user_model.png" alt="demo_user_model" /></span></div><div class="caption"><span class="header">図2.2: </span><span class="description">ユーザー用のデータモデル</span>。</div></div>


<p><a class="ref" href="#sec-database_migrations">6.1.1</a>から詳しく解説しますが、<a class="ref" href="#fig-demo_user_model">図2.2</a>のユーザー (<code>users</code>) はデータベースのテーブル (<em>table</em>) に相当します。また、<code>id</code>、<code>name</code>、<code>email</code>の属性はそれぞれテーブルの列 (<em>column</em>) に相当します。</p>

<div class="label" id="sec-modeling_demo_microposts"></div>


<h3><a id="sec-2_1_2" href="#sec-modeling_demo_microposts" class="heading"><span class="number">2.1.2</span>マイクロポストのモデル設計</a></h3>


<p>マイクロポストのデータモデルはユーザーよりもさらにシンプルです。<code>id</code>とマイクロポストのテキスト内容を格納する<code>string</code>型の<code>content</code>だけで構成されています<sup class="footnote" id="fnref-2_1"><a href="#fn-2_1">1</a></sup>。内容は<a class="ref" href="#fig-demo_micropost_model">図2.3</a>のとおりです。</p>

<div class="label" id="fig-demo_micropost_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_micropost_model.png" alt="demo_micropost_model" /></span></div><div class="caption"><span class="header">図2.3: </span><span class="description">マイクロポストのデータモデル</span></div></div>


<p><a class="ref" href="#sec-demo_user_has_many_microposts">2.3.3</a>では、<code>user_id</code>という属性を使用して、1人のユーザーに複数のマイクロポストが関連付けられるという構造を簡潔に説明します。詳細は<a class="ref" href="#cha-user-microposts">第10章</a>で完全に説明します。</p>

<div class="label" id="sec-demo_users_resource"></div>


<h2><a id="sec-2_2" href="#sec-demo_users_resource" class="heading"><span class="number">2.2</span>Users リソース </a></h2>


<p>ここでは、<a class="ref" href="#sec-modeling_demo_users">2.1.1</a>で説明したユーザー用のデータモデルを、そのモデルを表示するためのWebインターフェイスに従って実装します。
このデータモデルとWebインターフェイスは、組み合わさって<em>Usersリソース</em>となり、ユーザーというものを、<a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP protocol</a>経由で自由に作成/読み出し/更新/削除できるオブジェクトとみなすことができるようになります。「はじめに」で約束したとおり、このUsersリソースはすべてのRailsプロジェクトに標準装備されているscaffoldジェネレータで生成します。scaffoldで生成された膨大なコードを今詳細に読む必要はありません。今の段階ではおそらく混乱するだけでしょう。</p>

<p>Railsのscaffoldは、<code>rails generate</code>スクリプトに<code>scaffold</code>コマンドを渡すことで生成されます。<code>scaffold</code>コマンドの引数には、リソース名を単数形にしたもの (この場合は<code>User</code>) を使用し、必要に応じてデータモデルの属性をオプションとしてパラメータに追加します<sup class="footnote" id="fnref-2_2"><a href="#fn-2_2">2</a></sup>。</p>

<div class="code"><div class="highlight"><pre>$ rails generate scaffold User name:string email:string
      invoke  active_record
      create    db/migrate/20111123225336_create_users.rb
      create    app/models/user.rb
      invoke    test_unit
      create      test/unit/user_test.rb
      create      test/fixtures/users.yml
       route  resources :users
      invoke  scaffold_controller
      create    app/controllers/users_controller.rb
      invoke    erb
      create      app/views/users
      create      app/views/users/index.html.erb
      create      app/views/users/edit.html.erb
      create      app/views/users/show.html.erb
      create      app/views/users/new.html.erb
      create      app/views/users/_form.html.erb
      invoke    test_unit
      create      test/functional/users_controller_test.rb
      invoke    helper
      create      app/helpers/users_helper.rb
      invoke      test_unit
      create        test/unit/helpers/users_helper_test.rb
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/users.js.coffee
      invoke    scss
      create      app/assets/stylesheets/users.css.scss
      invoke  scss
      create    app/assets/stylesheets/scaffolds.css.scss
</pre></div>
</div>


<p><code>name:string</code>と<code>email:string</code>オプションを追加することで、Userモデルの内容が<a class="ref" href="#fig-demo_user_model">図2.2</a>の表のとおりになるようにします (なお、<code>id</code>パラメータはRailsによって自動的に<em>主キー</em>としてデータベースに追加されるため、追加不要です)。</p>

<p>続いてデモアプリケーションの開発を進めるには、以下のように<em>Rake</em>を使用してデータベースをマイグレート (<em>migrate</em>) する必要があります (<a class="ref" href="#sidebar-rake">コラム 2.1</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="go">==  CreateUsers: migrating =================================</span>
<span class="go">-- create_table(:users)</span>
<span class="go">   -&gt; 0.0017s</span>
<span class="go">==  CreateUsers: migrated (0.0018s) ========================</span>
</pre></div>
</div>


<p>このコマンドは、単にデータベースを更新し、<code>users</code>データモデルを作成するためのものです (データベースのマイグレーションの詳細については <a class="ref" href="#sec-database_migrations">6.1.1</a>以降で説明します)。なお、現在の<code>Gemfile</code>に対応するバージョンのRakeが確実に実行されるようにするために、<code>rake</code>を実行するときに<code>bundle exec</code>を使用しています。</p>

<p>ここまで実行すれば、以下のように<code>rails s</code>コマンド (<code>rails server</code>コマンドの短縮版) を実行してローカルWebサーバーを起動できるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails s
</pre></div>
</div>


<p>これで<a href="http://localhost:3000/">http://localhost:3000/</a>でデモアプリケーションをブラウザ表示できるようになっているはずです。</p>

<div class="label" id="sidebar-rake"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 2.1</span></span><span class="title"><span class="description">Rake</span></span>
<p>Unixでは、ソースコードから実行用プログラムをビルドするために主に<a href="http://en.wikipedia.org/wiki/Make_(software)"><em>make</em></a>というツールが使われてきました。多くのプログラマーが、肉体レベルにまで刻み込まれた以下のようなコマンドを実行して</p>

<pre class="verbatim">  $ ./configure &amp;&amp; make &amp;&amp; sudo make install</pre>


<p>LinuxやMac OS Xなどで日夜コードをコンパイルしています。</p>

<p>Rakeはいわば<em>Ruby版のmake</em>であり、Rubyで記述することのできる、makeのような言語です。Railsでは、Rakeを頻繁に使用しています。特に、データベースを背後に持つWebアプリケーション開発時に必要となる管理タスクで顕著です。<code>rake db:migrate</code>が一番よく使われるコマンドですが、rakeに<code>-T db</code>オプションを付けて実行すると他にもさまざまなデータベースタスクが用意されているのがわかります。</p>

<pre class="verbatim">  $ bundle exec rake -T db</pre>


<p>rakeで実行可能なタスクをすべて表示するには以下を実行します。</p>

<pre class="verbatim">  $ bundle exec rake -T</pre>


<p>コマンドの多さに圧倒されがちですが、すべてのコマンドを今覚える必要はまったくありませんので、心配は無用です。<em>Railsチュートリアル</em>を最後まで読み終わる頃には、重要なコマンドは一通り使えるようになっていることでしょう。</p>
</div>




<div class="label" id="sec-a_user_tour"></div>


<h3><a id="sec-2_2_1" href="#sec-a_user_tour" class="heading"><span class="number">2.2.1</span>ユーザページを表示する</a></h3>


<p><a href="http://localhost:3000/">http://localhost:3000/</a>をブラウザで表示すると、デフォルトのRailsページが表示されます (<a class="ref" href="#fig-riding_rails_31">図1.3</a>)。実は、Usersリソースを作成した時に、これ以外のさまざまな「ユーザーを扱うためのページ」が既に作成されています。たとえば、<a href="http://localhost:3000/users">/users</a>を表示すればすべてのユーザーの一覧が表示されますし、<a href="http://localhost:3000/users/new">/users/new</a>を表示すれば新規ユーザー作成ページが表示されます。このセクションでは以後、ユーザーに関連するページについて手短に説明します。その際、<a class="ref" href="#table-user_urls">表2.1</a>に記載されている、ページとURIの関係を参照するとわかりやすいと思います。</p>

<div class="label" id="table-user_urls"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><a href="http://localhost:3000/users">/users</a></td><td class="align_left"><code>index</code></td><td class="align_left">すべてのユーザーを一覧するページ</td></tr><tr><td class="align_left"><a href="http://localhost:3000/users/1">/users/1</a></td><td class="align_left"><code>show</code></td><td class="align_left">id=<code>1</code>のユーザーを表示するページ</td></tr><tr><td class="align_left"><a href="http://localhost:3000/users/new">/users/new</a></td><td class="align_left"><code>new</code></td><td class="align_left">新規ユーザーを作成するページ</td></tr><tr><td class="align_left"><a href="http://localhost:3000/users/1/edit">/users/1/edit</a></td><td class="align_left"><code>edit</code></td><td class="align_left">id=<code>1</code>のユーザーを編集するページ</td></tr></table></div><div class="caption"><span class="header">表2.1: </span><span class="description">Usersリソースにおける、ページとURLの関係</span>。</div></div>


<p>まずはユーザーの一覧を表示する<a href="http://localhost:3000/users"><tt>index</tt></a>ページから見てみましょう。もちろん、この時点ではまだユーザーは登録されていません (<a class="ref" href="#fig-demo_blank_user_index_rails_3">図2.4</a>)。</p>

<div class="label" id="fig-demo_blank_user_index_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_blank_user_index_rails_3.png" alt="demo_blank_user_index_rails_3" /></span></div><div class="caption"><span class="header">図2.4: </span><span class="description">Usersリソース (<a href="http://localhost:3000/users">/users</a>) ページの最初の状態。<a href="http://railstutorial.org/images/figures/demo_blank_user_index_rails_3-full.png">(拡大)</a></span></div></div>


<p>ユーザーを新規作成するには、<a class="ref" href="#fig-demo_new_user_rails_3">図2.5</a>の<a href="http://localhost:3000/users/new"><tt>new</tt></a>ページを表示します (注: ローカルのコンピュータで開発を行なっている場合は、URIのうちhttp://localhost:3000の部分は常に同じであるため、以後この部分は省略します)。 <a class="ref" href="#cha-sign-up">第7章</a>では、このページをユーザー登録ページに転用します。</p>

<div class="label" id="fig-demo_new_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_new_user_rails_3.png" alt="demo_new_user_rails_3" /></span></div><div class="caption"><span class="header">図2.5: </span><span class="description">新規ユーザー作成ページ (<a href="http://localhost:3000/users/new">/users/new</a>)。<a href="http://railstutorial.org/images/figures/demo_new_user_rails_3-full.png">(拡大)</a></span></div></div>


<p>テキストフィールドに名前とメールアドレスを入力して [Create User] ボタンを押してください。ユーザーが作成され、<a class="ref" href="#fig-demo_show_user_rails_3">図2.6</a>のように<a href="http://localhost:3000/users/1"><tt>show</tt></a>ページが表示されます (緑色のウェルカムメッセージは、 <a class="ref" href="#sec-the_flash">7.4.2</a>で解説する<em>flash</em>という機能を使用して表示しています)。ここで、URIが<a href="http://localhost:3000/users/1">/users/1</a>と表示されていることに注目してください。ご想像のとおり、この数字<code>1</code>は<a class="ref" href="#fig-demo_user_model">図2.2</a>の<code>id</code>属性そのものです。<a class="ref" href="#sec-showing_users">7.1</a>では、このページをユーザーのプロファイルに作り変える予定です。</p>

<div class="label" id="fig-demo_show_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_show_user_rails_3.png" alt="demo_show_user_rails_3" /></span></div><div class="caption"><span class="header">図2.6: </span><span class="description">ユーザー表示用のページ (<a href="http://localhost:3000/users/1">/users/1</a>)。<a href="http://railstutorial.org/images/figures/demo_show_user_rails_3-full.png">(拡大)</a></span></div></div>


<p>今度は、ユーザー情報を変更するために<a href="http://localhost:3000/users/1/edit"><tt>edit</tt></a>ページを表示してみましょう (<a class="ref" href="#fig-demo_edit_user_rails_3">図2.7</a>)。この編集ページ上でユーザーに関する情報を変更し、[Update User] ボタンを押せば、デモアプリケーション内のユーザー情報が変更されます (<a class="ref" href="#fig-demo_update_user_rails_3">図2.8</a>)。(詳細は<a class="ref" href="#cha-modeling-users">第6章</a>で説明しますが、このユーザー情報は、Webアプリケーションの背後にあるデータベースに保存されています。) このサンプルアプリケーションでも、ユーザーを編集または更新する機能を<a class="ref" href="#sec-updating_users">9.1</a>で実装します。</p>

<div class="label" id="fig-demo_edit_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_edit_user_rails_3.png" alt="demo_edit_user_rails_3" /></span></div><div class="caption"><span class="header">図2.7: </span><span class="description">ユーザー編集用のページ (<a href="http://localhost:3000/users/1/edit">/users/1/edit</a>)。<a href="http://railstutorial.org/images/figures/demo_edit_user_rails_3-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-demo_update_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_update_user_rails_3.png" alt="demo_update_user_rails_3" /></span></div><div class="caption"><span class="header">図2.8: </span><span class="description">情報が更新されたユーザー。<a href="http://railstutorial.org/images/figures/demo_update_user_rails_3-full.png">(拡大)</a></span></div></div>


<p>ここで<a href="http://localhost:3000/users/new"><tt>new</tt></a>ページに戻り、ユーザーをもう1人作成してみましょう。<a href="http://localhost:3000/users"><tt>index</tt></a>ページを表示してみると、<a class="ref" href="#fig-demo_user_index_two_rails_3">2.9</a>のようにユーザーが追加されています。<a class="ref" href="#sec-showing_users">7.1</a>ではもっと本格的なユーザー一覧ページを作成する予定です。</p>

<div class="label" id="fig-demo_user_index_two_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_user_index_two_rails_3.png" alt="demo_user_index_two_rails_3" /></span></div><div class="caption"><span class="header">図2.9: </span><span class="description">2人目のユーザーが追加された一覧ページ (<a href="http://localhost:3000/users">/users</a>) 。<a href="http://railstutorial.org/images/figures/demo_user_index_two_rails_3-full.png">(拡大)</a></span></div></div>


<p>ユーザーの作成、表示、編集方法を説明しましたので、今度はユーザーを削除してみましょう (<a class="ref" href="#fig-demo_destroy_user_rails_3">図2.10</a>)。
<a class="ref" href="#fig-demo_destroy_user_rails_3">図2.10</a>の [Destroy] リンクをクリックするとユーザーが削除され、indexページのユーザーは1人だけになります (もしこのとおりにならない場合は、ブラウザのJavaScriptが有効になっているかどうかを確認してください。Railsでは、ユーザーを削除するリクエストを発行するときにJavaScriptを使用しています)。 <a class="ref" href="#sec-destroying_users">9.4</a>ではサンプルアプリケーションにユーザーを削除する機能を実装し、管理権限 (admin) を持つユーザー以外は削除を実行できないように制限をかけます。</p>

<div class="label" id="fig-demo_destroy_user_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_destroy_user_rails_3.png" alt="demo_destroy_user_rails_3" /></span></div><div class="caption"><span class="header">図2.10: </span><span class="description">ユーザーを削除する。<a href="http://railstutorial.org/images/figures/demo_destroy_user_rails_3-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-mvc_in_action"></div>


<h3><a id="sec-2_2_2" href="#sec-mvc_in_action" class="heading"><span class="number">2.2.2</span> MVCの挙動</a></h3>


<p>これでUsersリソースの概略についての説明が終わりましたが、ここで<a class="ref" href="#sec-mvc">1.2.6</a>で紹介した MVC (Model-View-Controller = モデル-ビュー-コントローラ) パターンの観点からこのリソースを考察してみましょう。具体的には、<a href="http://localhost:3000/users">/users</a>のindexページをブラウザで開くという典型的な操作を行うときに何が起こっているかを MVC (<a class="ref" href="#fig-mvc_detailed">図2.11</a>) を使って説明します。</p>

<div class="label" id="fig-mvc_detailed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/mvc_detailed.png" alt="mvc_detailed" /></span></div><div class="caption"><span class="header">図2.11: </span><span class="description">RailsにおけるMVC。<a href="http://railstutorial.org/images/figures/mvc_detailed-full.png">(拡大)</a></span></div></div>




<ol>
<li>ブラウザは/users URIへのリクエストを発行する。</li>
<li>Railsは/usersをUsersコントローラ内の<code>index</code>アクションに割り当てる (ルーティング)。</li>
<li><code>index</code>アクションはUserモデルに「すべてのユーザーを取り出せ」と指示する (<code>User.all</code>)。</li>
<li>Userモデルはすべてのユーザーをデータベースから取り出す。</li>
<li>Userモデルはユーザーの一覧をコントローラに返す。</li>
<li>コントローラはユーザーの一覧を<code>@users</code>変数に保存し、<code>index</code>ビューに渡す。</li>
<li>ビューは、その中に埋め込まれているRubyを使用してHTMLを生成する。</li>
<li>コントローラは、生成されたHTMLをブラウザに返す<sup class="footnote" id="fnref-2_3"><a href="#fn-2_3">3</a></sup>。</li>
</ol>


<p>まずはブラウザからのリクエストを見てみましょう。このリクエストは、アドレスバーにURIを入力したりリンクをクリックした時に発生します (<a class="ref" href="#fig-mvc_detailed">図2.11</a>の1)。 リクエストは<em>Railsルーター</em>に到達し (2)、ここでURI (とリクエストの種類--<a class="ref" href="#sidebar-get_etc">コラム 3.2</a>参照) に基づいて適切な<em>コントローラのアクション</em>に割り当てられます (ディスパッチ)。ユーザーのURLをUsersリソースで使用するコントローラアクションに割り当てる (マッピングする) ためのコードは<a class="ref" href="#code-rails_routes">リスト2.2</a>です。このコードは、 URIとアクションの組み合わせ (<a class="ref" href="#table-user_urls">表2.1</a>) を効率的に作成します。(<code>:users</code>という一見奇妙な記法は、 <em>シンボル</em>と呼ばれるものです。詳細は<a class="ref" href="#sec-hashes_and_symbols">4.3.3</a>で説明します。)</p>

<div class="label" id="code-rails_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.2</span> <span class="description">Railsルートで使用するUsersリソース用のルール。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">DemoApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#sec-a_user_tour">2.2.1</a>以降でお見せした各ページは、Users<em>コントローラ</em>の中にある<em>アクション</em>にそれぞれ対応しています。1つのコントローラには関連する多数のアクションがまとめられています。<a class="ref" href="#code-demo_users_controller">リスト2.3</a>は、scaffoldで生成したコントローラの骨格です。<code>class UsersController &lt; ApplicationController</code>という記法は、Rubyの<em>クラス</em>での<em>継承</em>の使用例となっていることにもご注目ください (継承の概略については<a class="ref" href="#sec-inheritance_hierarchies">2.3.4</a>、詳細は<a class="ref" href="#sec-ruby_classes">4.4</a>で説明します)。</p>

<div class="label" id="code-demo_users_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.3</span> <span class="description">Usersコントローラの骨格。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ページの数よりもアクションの数の方が多いことにお気づきでしょうか。<code>index</code>、<code>show</code>、<code>new</code>、<code>edit</code>アクションはいずれも<a class="ref" href="#sec-a_user_tour">2.2.1</a>のページに対応していますが、それ以外にも<code>create</code>、<code>update</code>、<code>destroy</code>アクションがあります。通常、これらのアクションは、ページを出力せずにデータベース上のユーザー情報を操作します (もちろん、ページを出力しても良いのですが)。<a class="ref" href="#table-demo_RESTful_users">表2.2</a>は、RailsにおけるRESTアーキテクチャ (<a class="ref" href="#sidebar-REST">コラム 2.2</a>) を構成するすべてのアクションの一覧です。RESTは、コンピュータ科学者<a href="http://en.wikipedia.org/wiki/Roy_Fielding">Roy Fielding</a><sup class="footnote" id="fnref-2_4"><a href="#fn-2_4">4</a></sup>によって提唱された「<em>REpresentational State Transfer</em>」という概念に基づいています。これらのアクション同士の違いは、それらのアクションに対応する<a href="http://en.wikipedia.org/wiki/HTTP_request#Request_methods">HTTP requestメソッド</a>の違いでもあります。HTTP requestメソッドの詳細については<a class="ref" href="#sec-TDD">3.2.1</a>で説明します。</p>

<div class="label" id="table-demo_RESTful_users"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/users</td><td class="align_left"><code>index</code></td><td class="align_left">全ユーザーの一覧を表示するページ</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>show</code></td><td class="align_left">id=<code>1</code>のユーザーを表示するページ</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/new</td><td class="align_left"><code>new</code></td><td class="align_left">ユーザーを新規作成するページ</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/users</td><td class="align_left"><code>create</code></td><td class="align_left">ユーザーを新規作成するアクション</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/edit</td><td class="align_left"><code>edit</code></td><td class="align_left">id=<code>1</code>のユーザーを編集するページ</td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>update</code></td><td class="align_left">id=<code>1</code>のユーザーを更新するアクション</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>destroy</code></td><td class="align_left">id=<code>1</code>のユーザーを削除するアクション</td></tr></table></div><div class="caption"><span class="header">表2.2: </span><span class="description"><a class="ref" href="#code-rails_routes">リスト2.2</a>のUsersリソースに含まれるRESTfulなルーティング</span>。</div></div>




<div class="label" id="sidebar-REST"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 2.2</span></span><span class="title"><span class="description">REpresentational State Transfer (REST)</span></span>
<p>Rails関連の書籍を読んでいると “REST” という略語をよく見かけます。これはREpresentational State Transferの略です。RESTは、インターネットそのものやWebアプリケーションなどの、分散・ネットワーク化されたシステムやアプリケーションを構築するためのアーキテクチャのスタイルの1つです。REST理論そのものはかなり抽象的ですが、RailsアプリケーションにおけるRESTとは、アプリケーションを構成するコンポーネント (ユーザーやマイクロポストなど) を「<em>リソース</em>」としてモデル化することを指します。これらのリソースは、リレーショナルデータベースの<a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">作成/読み取り/更新/削除 (Create/Read/Update/Delete: CRUD) 操作</a>と、4つの基本的な<a href="http://en.wikipedia.org/wiki/HTTP_request#Request_methods">HTTP requestメソッド</a> (<tt>POST</tt>/<tt>GET</tt>/<tt>PUT</tt>/<tt>DELETE</tt>) の両方に対応しています (HTTP requestメソッドの詳細については、<a class="ref" href="#sec-TDD">3.2.1</a>、特に<a class="ref" href="#sidebar-get_etc">コラム 3.2</a>で説明します)。</p>

<p>Rails開発者にとっては、RESTfulなスタイルを採用することで、作成すべきコントローラやアクションの決定が楽になります。作成(C)・読み取り(R)・更新(U)・削除(D)を行うリソースだけでアプリケーション全体を構成してしまうことすら可能です。ユーザーやマイクロポストなどに関しては自然にリソース化できるので問題ありません。<a class="ref" href="#cha-following-users">第11章</a>では、「ユーザーをフォローする」というやや複雑な課題をREST理論でモデリングします。</p>
</div>


<p>UsersコントローラとUserモデルの関係をさらに考察するために、<code>index</code>アクションを整理してみました (<a class="ref" href="#code-demo_index_action">リスト2.4</a>) (scaffoldで自動生成されるコードは冗長で紛らわしいので除いてあります)。</p>

<div class="label" id="code-demo_index_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.4</span> <span class="description">デモアプリケーションのユーザー<code>index</code>アクションを整理したもの。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>index</code>アクションに<code>@users = User.all</code>という行があります (図2.11 の③に相当)。これによって、Userモデルからすべてのユーザーの一覧を取り出し (④)、<code>@users</code>という変数に保存します (⑤)。なお、@usersは “at-users” と発音します。Userモデルの内容は<a class="ref" href="#code-demo_user_model">リスト2.5</a>にあります。驚くほどシンプルな内容ですが、継承 (<a class="ref" href="#sec-inheritance_hierarchies">2.3.4</a>および<a class="ref" href="#sec-ruby_classes">4.4</a>) によって多くの機能が備わっています。特に、<em>Active Record</em>というRubyライブラリのおかげで、<a class="ref" href="#code-demo_user_model">リスト2.5</a>のUserモデルは<code>User.all</code>というリクエストに対してすべてのユーザーを返すことができます。(<code>attr_accessible</code>という行については<a class="ref" href="#sec-accessible_attributes">6.1.2.2</a>で説明します。<em>注</em>: この行はRails 3.2.2以前の場合にはありません)</p>

<div class="label" id="code-demo_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.5</span> <span class="description">デモアプリケーションのUserモデル。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:name</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>@users</code>変数にユーザー一覧が保存されると、コントローラは<a class="ref" href="#code-demo_index_view">リスト2.6</a>の<em>ビュー</em>を呼び出します (⑥)。<code>@</code>記号で始まる変数はRubyでは<em>インスタンス変数</em>と呼ばれます。ビューでは自動的にこれらのインスタンス変数を使用できます。この場合、<a class="ref" href="#code-demo_index_view">リスト2.6</a>の<code>index.html.erb</code>ビューは、<code>@users</code>の一覧を並べ、1行ごとにHTMLの行として出力します。(今はこのコードの意味がわからなくても問題ありません。これはあくまで説明のためのものです。)</p>

<div class="label" id="code-demo_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.6</span> <span class="description">ユーザーのindexのビュー。 </span><br /><span class="description"> <code>app/views/users/index.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Listing users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;</span>Email<span class="nt">&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
    <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>

<span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Show&#39;</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Edit&#39;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;Destroy&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s1">&#39;Are you sure?&#39;</span> <span class="p">}</span> <span class="cp">%&gt;</span><span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/table&gt;</span>

<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s1">&#39;New User&#39;</span><span class="p">,</span> <span class="n">new_user_path</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>ビューはその内容をHTMLに変換し (⑦)、コントローラがブラウザにHTMLを送信して、ブラウザでHTMLが表示されます (⑧)。</p>

<div class="label" id="sec-weaknesses_of_this_users_resource"></div>


<h3><a id="sec-2_2_3" href="#sec-weaknesses_of_this_users_resource" class="heading"><span class="number">2.2.3</span>Users リソースの欠点</a></h3>


<p>scaffoldで作成したUsersリソースは、Railsの概要を手っ取り早く説明するには良いのですが、以下のようなさまざまな問題点を抱えています。</p>

<ul>
<li><strong>データの検証が行われていない。</strong> このままでは、ユーザー名が空欄であったり、でたらめなメールアドレスを入力したりしても通ってしまいます。</li>
<li><strong>ユーザー認証が行われていない。</strong> サインイン、サインアウトが行われていないので、誰でも無制限に操作できてしまいます。</li>
<li><strong>テストが書かれていない。</strong> 厳密にはこれは正しい表現ではありません。というのも、scaffoldのコードには初歩的なテストが一応含まれているからです。ただ、scaffoldのテストコードは読みづらく、柔軟性もありません。さらにデータの検証、ユーザー認証、その他に必要な独自テストも含まれていません。</li>
<li><strong>レイアウトが整えられていない。</strong> サイトデザインも操作法も一貫していません。</li>
<li><strong>理解が困難。</strong> scaffoldのコードを理解できるぐらいなら、そもそも本書を読む必要はないでしょう。</li>
</ul>




<div class="label" id="sec-microposts_resource"></div>


<h2><a id="sec-2_3" href="#sec-microposts_resource" class="heading"><span class="number">2.3</span>Mircroposts リソース</a></h2>


<p>Usersリソースを生成して内容を理解しましたので、今度はMicropostsリソースで同じことをやってみましょう。なお、この節全体について、Micropostsリソースを理解する際には<a class="ref" href="#sec-demo_users_resource">2.2</a>のuser要素と比較しながら進めることをお勧めします。実際、これらの2つのリソースはさまざまな面で似通っています。RailsのRESTful構造を身体に叩きこむには、繰り返し学ぶのが一番です。UsersリソースとMicropostsリソースの構造の類似点を理解することが、この章の主要な目的です (もちろん、この章のような初歩的なサンプルアプリケーションではない、頑丈なアプリケーションを開発するのは簡単ではありません。Micropostsリソースについては<a class="ref" href="#cha-user-microposts">第10章</a>で再び取り扱いますが、その頃にはMicropostsは作り込みが進んで外観がすっかり変わってしまいます)。</p>

<div class="label" id="sec-a_micropost_microtour"></div>


<h3><a id="sec-2_3_1" href="#sec-a_micropost_microtour" class="heading"><span class="number">2.3.1</span>マイクロポストのページを表示する</a></h3>


<p>Usersリソースの場合と同様に、Micropostsリソースもscaffoldでコードを生成してみましょう。<code>rails generate scaffold</code>コマンドを使用して、<a class="ref" href="#fig-demo_micropost_model">図2.3</a>のデータモデルを実装してみます<sup class="footnote" id="fnref-2_5"><a href="#fn-2_5">5</a></sup>。</p>

<div class="code"><div class="highlight"><pre>$ rails generate scaffold Micropost content:string user_id:integer
      invoke  active_record
      create    db/migrate/20111123225811_create_microposts.rb
      create    app/models/micropost.rb
      invoke    test_unit
      create      test/unit/micropost_test.rb
      create      test/fixtures/microposts.yml
       route  resources :microposts
      invoke  scaffold_controller
      create    app/controllers/microposts_controller.rb
      invoke    erb
      create      app/views/microposts
      create      app/views/microposts/index.html.erb
      create      app/views/microposts/edit.html.erb
      create      app/views/microposts/show.html.erb
      create      app/views/microposts/new.html.erb
      create      app/views/microposts/_form.html.erb
      invoke    test_unit
      create      test/functional/microposts_controller_test.rb
      invoke    helper
      create      app/helpers/microposts_helper.rb
      invoke      test_unit
      create        test/unit/helpers/microposts_helper_test.rb
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/microposts.js.coffee
      invoke    scss
      create      app/assets/stylesheets/microposts.css.scss
      invoke  scss
   identical    app/assets/stylesheets/scaffolds.css.scss
</pre></div>
</div>


<p>新しいデータモデルでデータベースを更新するには、<a class="ref" href="#sec-demo_users_resource">2.2</a>のときと同様にマイグレーションを実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="go">==  CreateMicroposts: migrating =============================</span>
<span class="go">-- create_table(:microposts)</span>
<span class="go">   -&gt; 0.0023s</span>
<span class="go">==  CreateMicroposts: migrated (0.0026s) ====================</span>
</pre></div>
</div>


<p>これでMicropostsを作成する準備ができました。作成方法は<a class="ref" href="#sec-a_user_tour">2.2.1</a>と同じです。Railsのroutesファイルは期待どおりにscaffoldジェネレータによって更新され、<a class="ref" href="#code-demo_microposts_resource">リスト2.7</a>のようにMicropostsリソース用のルールが追加されました<sup class="footnote" id="fnref-2_6"><a href="#fn-2_6">6</a></sup>。ユーザーの場合と同様、<code>resources :microposts</code>というルーティングルールはマイクロポスト用のURIをMicropostsコントローラ内のアクションに割り当てます <a class="ref" href="#table-demo_RESTful_microposts">表2.3</a>。</p>

<div class="label" id="code-demo_microposts_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.7</span> <span class="description">Micropostsリソース用のルールが追加されたRailsのroutesファイル。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">DemoApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:microposts</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="table-demo_RESTful_microposts"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/microposts</td><td class="align_left"><code>index</code></td><td class="align_left">すべてのマイクロポストを表示するページ</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>show</code></td><td class="align_left">id=<code>1</code>のマイクロポストを表示するページ</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/microposts/new</td><td class="align_left"><code>new</code></td><td class="align_left">マイクロポストを新規作成するページ</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/microposts</td><td class="align_left"><code>create</code></td><td class="align_left">マイクロポストを新規作成するアクション</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/microposts/1/edit</td><td class="align_left"><code>edit</code></td><td class="align_left">id=<code>1</code>のマイクロポストを編集するページ</td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>update</code></td><td class="align_left">id=<code>1</code>のマイクロポストを更新するアクション</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>destroy</code></td><td class="align_left">id=<code>1</code>のマイクロポストを削除するアクション</td></tr></table></div><div class="caption"><span class="header">表2.3: </span><span class="description"><a class="ref" href="#code-demo_microposts_resource">リスト2.7</a>のMicropostsリソースに含まれるRESTfulなルーティング</span>。</div></div>


<p>Micropostsコントローラ自体の構造を<a class="ref" href="#code-demo_microposts_controller">リスト2.8</a>に示します。<a class="ref" href="#code-demo_microposts_controller">リスト2.8</a>の内容は、<code>MicropostsController</code>が<code>UsersController</code>に置き換わっている他は<a class="ref" href="#code-demo_users_controller">リスト2.3</a>と<em>完全に同一</em>である点に注目してください。これは、RESTアーキテクチャが2つのリソースに同じように反映されていることを示しています。</p>

<div class="label" id="code-demo_microposts_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.8</span> <span class="description">Micropostsコントローラの骨格。 </span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">index</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a href="http://localhost:3000/microposts/new">/microposts/new</a>ページをブラウザで開き、新しいマイクロポストの情報を入力してマイクロポストをいくつか作成してみましょう (<a class="ref" href="#fig-demo_new_micropost_rails_3">図2.12</a>)。</p>

<div class="label" id="fig-demo_new_micropost_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_new_micropost_rails_3.png" alt="demo_new_micropost_rails_3" /></span></div><div class="caption"><span class="header">図2.12: </span><span class="description">新しいマイクロポストの作成ページ (<a href="http://localhost:3000/microposts/new">/microposts/new</a>)。<a href="http://railstutorial.org/images/figures/demo_new_micropost-full.png">(拡大)</a></span></div></div>


<p>ここではひとまずマイクロポストを1つか2つ作成し、少なくとも片方の<code>user_id</code>が<code>1</code>になるようにして、<a class="ref" href="#sec-a_user_tour">2.2.1</a>で作成した最初のユーザーのidと同じにします。結果は<a class="ref" href="#fig-demo_micropost_index_rails_3">図2.13</a>のようになるはずです。</p>

<div class="label" id="fig-demo_micropost_index_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_micropost_index_rails_3.png" alt="demo_micropost_index_rails_3" /></span></div><div class="caption"><span class="header">図2.13: </span><span class="description">マイクロポストのindexページ (<a href="http://localhost:3000/microposts">/microposts</a>)。<a href="http://railstutorial.org/images/figures/demo_micropost_index_rails_3-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-putting_the_micro_in_microposts"></div>


<h3><a id="sec-2_3_2" href="#sec-putting_the_micro_in_microposts" class="heading"><span class="number">2.3.2</span>マイクロポストを<em>マイクロ</em>にする</a></h3>


<p>マイクロポストの<em>マイクロ</em>という名前にふさわしく、何らかの方法で文字数制限を与えてみましょう。Railsでは、<em>検証 (validates) </em>を使用して簡単にこのような入力制限を追加することができます。Twitterのように140文字の制限を与えるには、<em>length</em>を指定します。テキストエディタかIDEを使用して<code>app/models/micropost.rb</code>を開き、 <a class="ref" href="#code-demo_length_validation">リスト2.9</a>の内容に置き換えます。(注: <a class="ref" href="#code-demo_length_validation">リスト2.9</a>のような<code>validates</code>はRails 3の機能です。Rails 2.3の場合は <code>validates_length_of</code>を使用します。)</p>

<div class="label" id="code-demo_length_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.9</span> <span class="description">マイクロポストの最大文字数を140文字に制限する。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:user_id</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-demo_length_validation">リスト2.9</a>のコードは、これで本当に動作するのかと思えるかもしれませんが、ちゃんと動作します (検証機能については<a class="ref" href="#sec-user_validations">6.2</a>でさらに詳しく説明します)。140文字以上の新規マイクロポストを投稿してみればわかります。<a class="ref" href="#fig-micropost_length_error_rails_3">図2.14</a>に示したとおり、マイクロポストの内容が長すぎるという<em>エラーメッセージ</em>がRailsによって表示されます (エラーメッセージの詳細については<a class="ref" href="#sec-signup_error_messages">7.3.2</a>で説明します)。</p>

<div class="label" id="fig-micropost_length_error_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_length_error_rails_3.png" alt="micropost_length_error_rails_3" /></span></div><div class="caption"><span class="header">図2.14: </span><span class="description">マイクロポストの作成に失敗した場合のエラーメッセージ。<a href="http://railstutorial.org/images/figures/micropost_length_error_rails_3-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-demo_user_has_many_microposts"></div>


<h3><a id="sec-2_3_3" href="#sec-demo_user_has_many_microposts" class="heading"><span class="number">2.3.3</span>ユーザーとマイクロポストを<tt>has_many</tt>で関連づける</a></h3>


<p>異なるデータモデル同士の<em>関連付け</em>は、Railsの強力な機能です。ここでは、1人のユーザーに対し複数のマイクロポストがあるとしましょう。UserモデルとMicropostモデルをそれぞれ<a class="ref" href="#code-demo_user_has_many_microposts">リスト2.10</a>と<a class="ref" href="#code-demo_micropost_belongs_to_user">リスト2.11</a>のように更新することでこの関連付けを表現できます。</p>

<div class="label" id="code-demo_user_has_many_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.10</span> <span class="description">1人のユーザーに複数のマイクロポストがある。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:name</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-demo_micropost_belongs_to_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.11</span> <span class="description">1つのマイクロポストは1人のユーザーにのみ属する。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:user_id</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">140</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この関連付けを図で表したものが<a class="ref" href="#fig-micropost_user_association">図2.15</a>です。<code>microposts</code>テーブルには<code>user_id</code>カラムを作成してあったので、それによってRailsとActive Recordがマイクロポストとユーザーを関連付けることができるようになっています。</p>

<div class="label" id="fig-micropost_user_association"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_user_association.png" alt="micropost_user_association" /></span></div><div class="caption"><span class="header">図2.15: </span><span class="description">マイクロポストとユーザーの関連付け。</span></div></div>


<p><a class="ref" href="#cha-user-microposts">第10章</a>と<a class="ref" href="#cha-following-users">第11章</a>では、関連付けられたユーザーとマイクロポストを同時に表示し、Twitterのようなマイクロポストのフィードを作成する予定です。ここでは、Railsの<em>console</em>を使用して、ユーザーとマイクロポストの関連付けを確認するにとどめます。Railsのconsoleは、Railsアプリケーションを対話的に操作することができる便利なツールです。まず、ターミナルで<code>rails console</code>コマンドを入力します。続いて、<code>User.first</code>を使用してデータベースから1人目のユーザーの情報を取り出し、<code>first_user</code>変数に保存します<sup class="footnote" id="fnref-2_7"><a href="#fn-2_7">7</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">first_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;michael@example.org&quot;,</span>
<span class="go">created_at: &quot;2011-11-03 02:01:31&quot;, updated_at: &quot;2011-11-03 02:01:31&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">first_user</span><span class="o">.</span><span class="n">microposts</span>
<span class="go">=&gt; [#&lt;Micropost id: 1, content: &quot;First micropost!&quot;, user_id: 1, 
created_at: &quot;2011-11-03 02:37:37&quot;, updated_at: &quot;2011-11-03 02:37:37&quot;&gt;, </span>
<span class="go">#&lt;Micropost id: 2, content: &quot;Second micropost&quot;, user_id: 1, </span>
<span class="go">created_at: &quot;2011-11-03 02:38:54&quot;, updated_at: &quot;2011-11-03 02:38:54&quot;&gt;]</span>
<span class="go"></span>
<span class="gp">&gt;&gt; </span><span class="nb">exit</span>
</pre></div>
</div>


<p>(最後の行のようにexitを実行すると Rails consoleを終了できます。多くのシステムでは、Ctrl-dキーを押して終了することもできます。) <code>first_user.microposts</code>というコードを実行すると、そのユーザーに関連付けられているマイクロポストにアクセスできます。このときActive Recordは、<code>user_id</code>が<code>first_user</code>のid (ここでは<code>1</code>) と等しいマイクロポストを自動的に返します。Active Recordの関連付け機能については<a class="ref" href="#cha-user-microposts">第10章</a>と<a class="ref" href="#cha-following-users">第11章</a>でさらに詳しく解説します。</p>

<div class="label" id="sec-inheritance_hierarchies"></div>


<h3><a id="sec-2_3_4" href="#sec-inheritance_hierarchies" class="heading"><span class="number">2.3.4</span>継承の階層</a></h3>


<p>最後に、デモアプリケーションで使用しているRailsのコントローラとモデルのクラス階層について簡単に解説します。この節を理解するには、多少なりともオブジェクト指向プログラミング (OOP) の経験が必要です。オブジェクト指向プログラミングを学んだことのない方はこの節をスキップしても構いません。特に、<em>クラス</em>の概念 (<a class="ref" href="#sec-ruby_classes">4.4</a>で解説します) に慣れていない方は、後でこの節をもう一度読み返してください。</p>

<p>最初に、モデルの継承構造について説明します。<a class="ref" href="#code-demo_user_class">リスト2.12</a>と<a class="ref" href="#code-demo_micropost_class">リスト2.13</a>を比較してみると、UserモデルとMicropostモデルはいずれも<code>ActiveRecord::Base</code>というクラスを継承しています (継承関係は<code>&lt;</code>記号で表現されています)。このクラスは、ActiveRecordが提供するベースクラスであり、クラス間のリレーションは<a class="ref" href="#fig-demo_model_inheritance">図2.16</a>のようになります。<code>ActiveRecord::Base</code>クラスを継承したことによって、作成したモデルオブジェクトはデータベースにアクセスできるようになり、データベースのカラムをあたかもRubyの属性のように扱ったりすることができるようになります。</p>

<div class="label" id="code-demo_user_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.12</span> <span class="description"><code>User</code>クラスにおける継承。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-demo_micropost_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.13</span> <span class="description"><code>Micropost</code>クラスにおける継承。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig-demo_model_inheritance"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_model_inheritance.png" alt="demo_model_inheritance" /></span></div><div class="caption"><span class="header">図2.16: </span><span class="description">UserモデルとMicropostモデルの継承階層。</span></div></div>


<p>コントローラの継承構造はもう少しだけ複雑です。<a class="ref" href="#code-demo_users_controller_class">リスト2.14</a>と<a class="ref" href="#code-demo_microposts_controller_class">リスト2.15</a>を比較してみると、UsersコントローラとMicropostsコントローラはいずれもApplicationControllerを継承しています。<a class="ref" href="#code-demo_application_controller_class">リスト2.16</a>を見ると、<code>ApplicationController</code>自身は<code>ActionController::Base</code>を継承しています。これはRailsのAction Packというライブラリが提供している、コントローラ用のベースクラスです。これらのクラス同士の関係を<a class="ref" href="#fig-demo_controller_inheritance">図2.17</a>に示します。</p>

<div class="label" id="code-demo_users_controller_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.14</span> <span class="description"><code>UsersController</code>クラスにおける継承。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-demo_microposts_controller_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.15</span> <span class="description"><code>MicropostsController</code>クラスにおける継承。</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-demo_application_controller_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト2.16</span> <span class="description"><code>ApplicationController</code>クラスにおける継承。</span><br /><span class="description"> <code>app/controllers/application_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="ss">ActionController::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig-demo_controller_inheritance"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/demo_controller_inheritance.png" alt="demo_controller_inheritance" /></span></div><div class="caption"><span class="header">図2.17: </span><span class="description">UsersコントローラとMicropostsコントローラにおける継承関係。</span></div></div>


<p>モデルの継承関係と同様に、UsersコントローラもMicropostsコントローラも最終的には<code>ActionController::Base</code>を継承しており、モデルオブジェクトの操作、インバウンドHTTP requestのフィルタ、ビューをHTMLとして出力するなどの多彩な機能を実行できるようになっています。Railsのコントローラは必ず<code>ApplicationController</code>を継承しているので、Applicationコントローラで定義されたルールはアプリケーションのすべてのアクションに反映されます。たとえば<a class="ref" href="#sec-remember_me">8.2.1</a>では、サンプルアプリケーションのすべてのコントローラにサインインとサインアウト用のヘルパーを含めています。</p>

<div class="label" id="sec-deploying_the_demo_app"></div>


<h3><a id="sec-2_3_5" href="#sec-deploying_the_demo_app" class="heading"><span class="number">2.3.5</span>デモアプリケーションのデプロイ</a></h3>


<p>Micropostsリソースの説明が終わりましたので、ここでリポジトリをGitHubに登録しましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish demo app&quot;</span>
<span class="gp">$</span> git push
</pre></div>
</div>


<p>通常は、更新をあまりためないように、Gitのコミットをなるべく頻繁に行うことが望ましいのですが、この章の締めくくりとしてサイズの大きなコミットを1度だけ行っても問題ありません。</p>

<p>この時点で、デモアプリケーションを<a class="ref" href="#sec-deploying">1.4</a>のようにHerokuにデプロイしても構いません。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku create --stack cedar
<span class="gp">$</span> git push heroku master
</pre></div>
</div>


<p>Herokuでエラーが生じた場合は、以下のように本番 (production) データベースをマイグレートします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>このコマンドを実行すると、Heroku上のデータベースが、ユーザーとマイクロソフトのデータモデルで更新されます。<code>vendor/plugins</code>にあるアセットに関連するエラーが生じた場合は無視してください。今はこのディレクトリにはプラグインがありません。</p>

<h2><a id="sec-2_4" href="#sec-2_4" class="heading"><span class="number">2.4</span>最後に</a></h2>


<p>ついにRailsアプリケーションを最後まで完成させました。この章で作成したデモアプリケーションには良いところもありますが、さまざまな弱点もあります。<br /></p>

<p><strong>良かった点</strong></p>

<ul>
<li>Rails全体を高度なレベルで概観できた</li>
<li>MVCモデルを紹介できた</li>
<li>RESTアーキテクチャに初めて触れた</li>
<li>データモデルの作成を初めて行った</li>
<li>データベースを背後に持つWebアプリケーションを本番環境で動かした</li>
</ul>


<p><strong>課題</strong></p>

<ul>
<li>レイアウトやスタイルが皆無</li>
<li>“Home” や “About” のような静的なページがない</li>
<li>ユーザーにパスワードを設定できない</li>
<li>ユーザーの画像も置けない</li>
<li>サインインできない</li>
<li>セキュリティがない</li>
<li>ユーザーとマイクロポストを自動的に関連付けていない</li>
<li>“following” 機能も “followed” 機能もない</li>
<li>マイクロポストをフィードできない</li>
<li>テスト駆動開発が行われていない</li>
<li><strong>理解が困難</strong></li>
</ul>


<p>本書では以後、良い点を保ちつつこれらの弱点を克服していきます。</p>

<div class="footnotes">
<ol>
<li id="fn-2_1">もっと普通の、マイクロでないポストを扱いたい場合は、<code>string</code>の代わりに<code>text</code>を指定します。<a class="arrow" href="#fnref-2_1">↑</a></li>
<li id="fn-2_2">scaffoldにおける命名は、<em>モデル</em>名の命名の習慣に従っています。リソースやコントローラは複数形で表し、モデルは単数形で表すのが普通です。<code>User</code>ではなく<code>Users</code>としたのはこのためです。<a class="arrow" href="#fnref-2_2">↑</a></li>
<li id="fn-2_3">ビューは、(ApacheやNginxなどのWebサーバーを経由してはいるが) ブラウザにHTMLを直接返すと説明している文献もあります。私は、Railsの実際の実装とは無関係に、コントローラを情報の流れの中心となるハブとみなすことを好んでいます。<a class="arrow" href="#fnref-2_3">↑</a></li>
<li id="fn-2_4">Fielding, Roy Thomas. <em>Architectural Styles and the Design of Network-based Software Architectures</em>. Doctoral dissertation, University of California, Irvine, 2000. <a class="arrow" href="#fnref-2_4">↑</a></li>
<li id="fn-2_5">ユーザーでscaffoldを実行した場合と同様に、scaffoldジェネレータはマイクロポストでもRailsモデルを単数形とする習慣に従います。実行したコマンドが<code>generate Micropost</code>と単数形になっていたのはこのためです。<a class="arrow" href="#fnref-2_5">↑</a></li>
<li id="fn-2_6">scaffoldで生成したコードには<a class="ref" href="#code-demo_microposts_resource">2.7</a>よりも多くの改行が追加されます。Rubyは単なる改行を無視するので、問題はありません。<a class="arrow" href="#fnref-2_6">↑</a></li>
<li id="fn-2_7">実際のターミナル上では、プロンプトが<code>ruby-1.9.3-head &gt;</code>などと表示される可能性がありますが、Rubyのバージョンが環境によって異なる可能性があるため、例のプロンプトは<tt class="verb">&gt;&gt;</tt>と表記しています。<a class="arrow" href="#fnref-2_7">↑</a></li>
</ol>
</div>




<div class="label" id="cha-static-pages"></div>


<h1 class="chapter"><a id="sec-3" href="#cha-static-pages" class="heading"><span class="number">第3章</span>ほぼ静的なページの作成</a></h1>


<p>本章では、今後のチュートリアルを楽に理解できるように、簡単なサンプルアプリケーションを開発してみます。本書を通して開発するアプリケーションは、最終的にはユーザやマイクロポスト、ログイン／ログアウトなどの認証機能を持ちますが、まずは簡単なトピックである「静的なページの作成」から始めます。非常にシンプルなページではありますが、静的なページを作成することは良い経験になり、また、多くの示唆も得られます。私達がこれから開発するアプリケーションにとって、最高のスタート地点といえるでしょう。</p>

<p>Rails はデータベースと連携して動的なウェブサイトを開発するように設計されていますが、HTMLファイルだけで構成されている静的なページを作ることもできます。実際、静的なページをRailsで作ることのメリットもあります。たとえば、あとで<em>ほんの少し</em>動的なコンテンツを追加することができます。本章では、このような静的なページの作成について学んでいきます。まずは、<em>自動化テスト</em>の雰囲気を掴んでいきます。自動化テストは、私達のコードが正しく動いているという自信を与えてくれます。さらに、良いテストを書くことで、自信をもって<em>リファクタリング</em>を行うことができます。たとえば、フォームの振る舞いを変更せずに、フォーム内で使われている関数を書き換えたいときに便利です。</p>

<p>本章には多くのサンプルコードがあります。特に <a class="ref" href="#sec-first_tests">3.2</a> や <a class="ref" href="#sec-slightly_dynamic_pages">3.3</a> で多くのコードを紹介していますが、Rubyが初めての方は、コードを隅々まで理解しなければならないのだろうかと心配する必要はありません。<a class="ref" href="#sec-comments_for_various_readers">1.1.1</a> で紹介したように、まずはテストをコピー&amp;ペーストしてみて、アプリケーションがうまく動くかどうか検証してみると良いでしょう。この時点では、テストどのようにして動くかは気にしなくても大丈夫です。また、<a class="ref" href="#cha-rails-flavored-ruby">第4章</a>ではRubyについて解説します。そこでは、Rubyの書き方やコンセプトについて学びます。最後に、本書ではRSpecを使ったテストを繰り返し実施していきます。ですから、もし途中でよく分からないテストがあったとしても、読み飛ばして先に進むことをお勧めします。1、2章先を読み進めた後に読み返してみると、あのときはよく分からなかったテストが、実はとてもシンプルであることを理解できるはずです。</p>

<p>では、<a class="ref" href="#cha-a-demo-app">第2章</a>でもやったように、まずはRailsプロジェクトを作りましょう。今回は<code>sample_app</code>というプロジェクトを作ります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd </span>rails_projects
<span class="gp">$</span> rails new sample_app --skip-test-unit
<span class="gp">$</span> <span class="nb">cd </span>sample_app
</pre></div>
</div>


<p>ここで使った<code>rails</code>の<tt class="verb">--skip-test-unit</tt>というオプションは、<code>Test::Unit</code>フレームワークと関連している<code>test</code>ディレクトリを作成しないようにするオプションです。これは「テストを書かないから」という理由ではありません。そうではなく、<a class="ref" href="#sec-first_tests">3.2</a>以降では、もう1つのテストフレームワークである<em>RSpec</em>を使ってテストを書くからです。</p>

<p>次は、<a class="ref" href="#sec-planning_the_application">2.1</a>と同じように、テキストエディタを使って<code>Gemfile</code>に必要なgemを書き足していきます。今回は、2つの新しいgemを使います。RSpecのためのgem と、RSpecのライブラリのためのgemです。これらのgemをGemfileに追加すると、<a class="ref" href="#code-gemfile_rspec">リスト3.1</a>のようになります(<em>注</em>: もしサンプルアプリケーションの開発で必要になるgemを<em>すべて</em>知りたい場合は、<a class="ref" href="#code-final_gemfile">リスト9.49</a>を参照してください。これが最終的なGemfileになります)。</p>

<div class="label" id="code-gemfile_rspec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 3.1</span> <span class="description">サンプルアプリケーションで使う<code>Gemfile</code>。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.11.0&#39;</span>
<span class="k">end</span>

<span class="c1"># assetsでは使うが、</span>
<span class="c1"># 本番環境ではデフォルトで不要なGem</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このGemfileでは、開発環境とテスト環境で<tt>rspec-rails</tt>を使うようにしています。このため、開発環境ではRSpec固有のジェネレーターにアクセスすることができます。同様に、テスト環境ではRSpecを使用してテストを実行できるようになります。Gemfileに記述した<tt>rspec-rails</tt>が依存関係を解決してくれるため、 個々の環境にRSpec自身を手動でインストールする必要がなくなり、自動的にインストールされるようになります。同様の理由で、<a href="https://github.com/jnicklas/capybara">Capybara</a>もGemfileに記述しています。これは、英語に近い文法を使って、ユーザーの対話的操作をシミュレーションできるGemです<sup class="footnote" id="fnref-3_1"><a href="#fn-3_1">1</a></sup>。また、<a class="ref" href="#cha-a-demo-app">第2章</a>でも扱ったように、HerokuにデプロイするときにはPostgreSQLのgemを本番環境に追加します。</p>

<div class="code"><div class="highlight"><pre><span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Herokuは、開発環境とプロダクション環境とで同じデータベースを使うことを推奨していますが、今回開発するサンプルアプリケーションでは、データベースが異なっていても特に問題はありません。また、SQLiteはPostgreSQLに比べて<em>きわめて簡単に</em> セットアップできます。なお、ローカルの開発マシンへのPostgreSQLのインストールと構築については、<a class="ref" href="#sec-static_pages_exercises">3.5</a>の演習課題として取り上げています。</p>

<p>Gemfileに新しく追加したgemを実際にインストールするには、<code>bundle update</code>と<code>bundle install</code>を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle update
<span class="gp">$</span> bundle install --without production
</pre></div>
</div>


<p><a class="ref" href="#sec-heroku_setup">1.4.1</a>や<a class="ref" href="#cha-a-demo-app">第2章</a>でも説明したように、<tt class="verb">--without</tt> <tt class="verb">production</tt>オプションを追加することで、本番環境のgemのみインストールしないようにすることができます。注: このオプションは “remembered option” と呼ばれるもので、このオプションを一度実行するとコマンドに保存され、今後Bundlerを実行するときにオプションを追加する必要がなくなります。このため、今後は単に<code>bundle install</code>を実行するだけで、自動的に本番環境用gemをスキップできるようになります<sup class="footnote" id="fnref-3_2"><a href="#fn-3_2">2</a></sup>。</p>

<p>次に、<code>Test::Unit</code>の代わりにRSpecを使うように、Railsの設定を変更します。これを行うには、<code>rails generate rspec:install</code> を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate rspec:install
</pre></div>
</div>


<p>(JavaScriptランタイムがインストールされていないというエラーが表示された場合は、<a href="https://github.com/sstephenson/execjs">GitHubのexecjsページ</a>にあるインストール可能なランタイムの一覧から入手してください。個人的には<a href="http://nodejs.org/">Node.js</a>をお勧めします。) </p>

<p>ここまで進めたら、後はGitリポジトリを初期化するだけです<sup class="footnote" id="fnref-3_3"><a href="#fn-3_3">3</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Initial commit&quot;</span>
</pre></div>
</div>


<p>まずは、<a class="ref" href="#code-sample_app_readme">リスト 3.2</a>のように、アプリケーションのルートディレクトリに置かれている<code>README</code>ファイルをわかりやすく書き直してみましょう。</p>

<div class="label" id="code-sample_app_readme"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 3.2</span> <span class="description">サンプルアプリケーション向けに改善した<code>README</code>ファイル。</span> </div>
<div class="code"><div class="highlight"><pre># Ruby on Rails チュートリアル：サンプルアプリケーション

これは、以下のためのサンプルアプリケーションです。
[*Ruby on Rails Tutorial: Learn Rails by Example*](http://railstutorial.org/)
by [Michael Hartl](http://michaelhartl.com/).
</pre></div>
</div></div>


<p>次に、拡張子を <code>.md</code> に変更し、Markdownファイルとして認識できるようにします。その後、これらの変更をコミットします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git mv README.rdoc README.md
<span class="gp">$</span> git commit -a -m <span class="s2">&quot;Improve the README file&quot;</span>
</pre></div>
</div>




<div class="label" id="fig-create_repository"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/create_repository_new.png" alt="create_repository_new" /></span></div><div class="caption"><span class="header">図3.1</span><span class="description">サンプルアプリケーションのリポジトリをGitHub上に作成する。<a href="http://railstutorial.org/images/figures/create_repository_new-full.png">(拡大)</a></span></div></div>


<p>本書では今後、このサンプルアプリケーションを使っていくことになるので、GitHub上にリポジトリを作成し (<a class="ref" href="#fig-create_repository">図 3.1</a>)、プッシュしておくと良いでしょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@github.com:&lt;ユーザ名&gt;/sample_app.git
<span class="gp">$</span> git push -u origin master
</pre></div>
</div>


<p>ここまで作業を進めると、<a href="https://github.com/railstutorial/sample_app_2nd_ed">GitHubに上がっているRailsチュートリアルのサンプルアプリケーション</a>のようになります (名前は若干異なりますが)<sup class="footnote" id="fnref-3_4"><a href="#fn-3_4">4</a></sup>。</p>

<p>もちろん、この時点でHerokuにデプロイすることもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku create --stack cedar
<span class="gp">$</span> git push heroku master
</pre></div>
</div>


<p>なお、本書を進める間、アプリケーションを定期的にGitHubにプッシュしたり、Herokuにデプロイすることをお勧めします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>これにより、リモート環境にバックアップを置くことができ、本番環境で発生するエラーをなるべく早期に発見することができます。なお、Herokuにデプロイするときにエラーが発生した場合は、以下のコマンドを実行して本番環境のログを取得してください。このログは、問題を特定するときに役立ちます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div>
</div>


<p>ここまでの準備が完了したら、いよいよサンプルアプリケーションの開発を始めましょう。</p>

<div class="label" id="sec-static_pages"></div>


<h2><a id="sec-3_1" href="#sec-static_pages" class="heading"><span class="number">3.1</span>静的ページ</a></h2>


<p>Railsで静的なページを作成する場合、主に次の2つの方法があります。1つは、生のHTMLファイルを含む<em>本当に</em>静的なページを表示する方法です。もう1つは、生のHTMLを含む<em>ビュー (view) </em>を定義することです。ビューを定義する方法では、Railsがビューを<em>出力 (rendering) </em>し、その後Webサーバーがその結果をブラウザに送信します。</p>

<p>現在どのディレクトリで作業しているかがわからなくなった場合は、<a class="ref" href="#sec-the_first_application">1.2.3</a> (<a class="ref" href="#fig-directory_structure_rails_3_2">図 1.2</a>)を再度参照して、Rails のディレクトリ構造を確認してください。この節では、主に<code>app/controllers</code>ディレクトリや<code>app/views</code>ディレクトリ内で作業を進めます (なお <a class="ref" href="#sec-first_tests">3.2</a> では、新しいディレクトリをさらに１つ追加します)。</p>

<p>この節からは、Railsのすべてのディレクトリを一覧できるテキストエディタまたはIDEが使用できると非常に便利です。残念ながら、テキストエディタや IDEの細かな使用法はそれぞれ異なりますが、どのツールを使ってもRailsアプリケーションのディレクトリを開くことができます。Unix系のシステムでは、ドット<code>.</code>でカレントディレクトリを表現できるので、コマンドライン上で以下を実行してRailsアプリケーションの現在のディレクトリを開き、使用するエディタを呼び出してみてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects/sample_app
<span class="gp">$</span> &lt;エディタ名&gt; .
</pre></div>
</div>


<p>たとえば、Sublime Text でサンプルアプリケーションを開く場合は、以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> subl .
</pre></div>
</div>


<p>Vimの場合は、種類に応じて<code>vim .</code>、<code>gvim .</code>、<code>mvim .</code>などでエディタを開けます。</p>

<div class="label" id="sec-truly_static_pages"></div>


<h3><a id="sec-3_1_1" href="#sec-truly_static_pages" class="heading"><span class="number">3.1.1</span>「本当に」静的なページ</a></h3>


<p>最初に、本当に静的なページを作成してみましょう。<a class="ref" href="#sec-rails_server">1.2.5</a>で、<code>rails</code>スクリプトを使用して作成した最小限の機能が、あらゆるRailsアプリケーションで利用できることを思い出してください。なお、デフォルトのwelcomeページは<a href="http://localhost:3000/">http://localhost:3000/</a> (<a class="ref" href="#fig-riding_rails_31">図 1.3</a>) でアクセスできます。</p>

<div class="label" id="fig-public_index_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/public_index_rails_3.png" alt="public_index_rails_3" /></span></div><div class="caption"><span class="header">図3.2</span><span class="description"><code>public/index.html</code>ファイルの内容。<a href="http://railstutorial.org/images/figures/public_index_rails_3-full.png">(拡大)</a></span></div></div>


<p>このページがどこから来ているかを学ぶために、<code>public/index.html</code> (<a class="ref" href="#fig-public_index_rails_3">図 3.2</a>) ファイルを見てみてください。このファイルは、スタイルシートの情報を含んでいるので少し煩雑ですが、このファイルだけでページを描画することができています。これは、Railsはデフォルトで<code>public</code>ディレクトリ内にあるファイルを直接ブラウザに送信しているからです<sup class="footnote" id="fnref-3_5"><a href="#fn-3_5">5</a></sup>。またデフォルトでは、今回使われている<code>index.html</code>ファイルについてはURLで<code>index.html</code>と指定する必要はありません。たとえば、URLにhttp://localhost:3000/と入力しても、http://localhost:3000/index.htmlと入力しても、表示される内容は同じです。</p>

<p>もうお気付きかもしれませんが、静的なHTMLファイルを作成して<code>public</code>ディレクトリ内に置けば、<code>index.html</code>と同じように表示することができます。まずは、&quot;Hello, world!&quot; と表示するファイル (<a class="ref" href="#code-hello_world">リスト3.3</a>) を作ってみましょう<sup class="footnote" id="fnref-3_6"><a href="#fn-3_6">6</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> subl public/hello.html
</pre></div>
</div>


<div class="label" id="code-hello_world"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 3.3</span> <span class="description">HTMLファイルの典型的な &quot;Hello, World!&quot;。</span><br /><span class="description"> <code>public/hello.html</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Greeting<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>Hello, world!<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-hello_world">リスト3.3</a>は、典型的な HTML ドキュメントの構造です。たとえば、1行目の<em>document type</em> (doctype とも呼ぶ)  は、使用しているHTMLのバージョンをブラウザに宣言するもので、今回の例では<a href="http://en.wikipedia.org/wiki/HTML5">HTML5</a>を使っていることを宣言しています<sup class="footnote" id="fnref-3_7"><a href="#fn-3_7">7</a></sup>。また<code>head</code>セクションでは、<code>title</code>タグで &quot;Greeting&quot; と表示しています。最後に<code>body</code>セクションでは、<code>p</code> (paragraph) タグを使って “Hello, world!” と表示しています (なお、HTMLではスペースやタブは無視されるので、インデントはあってもなくても大丈夫です。ただし、インデントがある方がHTMLのデータ構造を理解しやすくなります)。</p>

<p>では、次のコマンドを入力して、ローカル環境でサーバーを起動してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails server
</pre></div>
</div>


<p>次にブラウザで<a href="http://localhost:3000/hello.html">http://localhost:3000/hello.html</a>にアクセスしてみると、先ほど説明したとおり、先ほどpublicディレクトリ以下に作成した静的なHTMLページがRailsによって表示されます (<a class="ref" href="#fig-hello_world">図 3.3</a>)。なお、<a class="ref" href="#fig-hello_world">図3.3</a>の上部中央にある &quot;Greeting&quot; という文字は、 先ほど <code>title</code> タグで囲った文字列です。</p>

<div class="label" id="fig-hello_world"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/hello_world.png" alt="&quot;hello world&quot;" /></span></div><div class="caption"><span class="header">図3.3</span><span class="description">新しい静的な HTML ファイル。<a href="http://railstutorial.org/images/figures/hello_world-full.png">(拡大)</a></span></div></div>


<p>この静的ファイルはRailsの振る舞いを確かめるためのものなので、サンプルアプリケーションを開発するために必要なファイルではありません。誤って./public/hello.html が参照されてしまうことのないように、以下のように削除しておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm public/hello.html
</pre></div>
</div>


<p>ただし、<code>index.html</code>ファイルは後で使うので、当面残しておいてください。もちろん、サンプルアプリケーションのルートURLにアクセスした際に表示されてしまうと困るので、最終的にはこのファイルも削除することになります (<a class="ref" href="#fig-riding_rails_31">図 1.3</a>)。具体的には、<a class="ref" href="#sec-layout_links">5.3</a>で、<a href="http://localhost:3000/">http://localhost:3000/</a>にアクセスした際に<code>public/index.html</code>以外を参照するようにします。</p>

<div class="label" id="sec-static_pages_with_rails"></div>


<h3><a id="sec-3_1_2" href="#sec-static_pages_with_rails" class="heading"><span class="number">3.1.2</span>Railsによる静的なページ</a></h3>


<p>静的なHTMLファイルを返す機能はもちろん必要ですが、動的なWebアプリケーションを作成するにはこれだけでは不足です。この節では、一連のURIを定義する、<em>アクション</em>というRailsの強力なツールを使用して動的なページを作成します<sup class="footnote" id="fnref-3_8"><a href="#fn-3_8">8</a></sup>。Railsのアクションは、<em>コントローラ</em> (<a class="ref" href="#sec-mvc">1.2.6</a>で紹介した MVCの Cに該当) の中に置かれる機能で、共通の目的を持つ一連のアクションをコントローラ内にまとめることができます。コントローラについては<a class="ref" href="#cha-a-demo-app">第2章</a>でも簡単に触れましたが、<a class="ref" href="#cha-modeling-users">第6章</a>で説明する<a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">REST アーキテクチャ</a>を読むと、より深く理解することができます。一言で言うと、コントローラとは (基本的に動的な) Webページの集合を束ねるコンテナのことです。</p>

<p>さっそく動的なページを作ってみましょう。まずは、<a class="ref" href="#sec-git_commands">1.3.5</a>で紹介したように、Gitを使ってトピックブランチを作ります。今回のように新しい機能やページを作成するときは、masterブランチではなくトピックブランチで作業するのがよいでしょう。Git でバージョン管理をしている場合は、次のコマンドでトピックブランチを作成してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b static-pages
</pre></div>
</div>


<p>Railsには<code>generate</code>というスクリプトがあり、このスクリプトにコントローラ名を入力するだけで、この魔法のようなスクリプトがコントローラを作成してくれます。本章の冒頭でRSpecをインストールしていなかった場合は、この<code>generate</code>を使って以下のようにRSpecをインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate rspec:install
</pre></div>
</div>


<p>これより、複数の静的なページを取り扱うStaticPagesコントローラを作成します。具体的には、HomeページとHelpページ、Aboutページで使用するアクションを作ってみます。<code>generate</code>スクリプトは、任意の数のアクションを引数に取ることができます。まずは、上記の3つのアクションのうち、最初の2つのアクションを作ってみます (<a class="ref" href="#code-generating_pages">リスト 3.4</a>)。</p>

<div class="label" id="code-generating_pages"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 3.4</span> <span class="description">StaticPagesコントローラを生成する。</span> </div>
<div class="code"><div class="highlight"><pre>$ rails generate controller StaticPages home help --no-test-framework
      create  app/controllers/static_pages_controller.rb
       route  get &quot;static_pages/help&quot;
       route  get &quot;static_pages/home&quot;
      invoke  erb
      create    app/views/static_pages
      create    app/views/static_pages/home.html.erb
      create    app/views/static_pages/help.html.erb
      invoke  helper
      create    app/helpers/static_pages_helper.rb
      invoke  assets
      invoke    coffee
      create      app/assets/javascripts/static_pages.js.coffee
      invoke    scss
      create      app/assets/stylesheets/static_pages.css.scss
</pre></div>
</div></div>


<p>今回はRSpecのテストを使わないため、<tt class="verb">--no-test-framework</tt>というオプションを付け加えることで、RSpecのテストを自動的に生成しないようにしています。代わりに、<a class="ref" href="#sec-first_tests">3.2</a>からは手動でテストを作成します。また、<a class="ref" href="#code-generating_pages">リスト 3.4</a>に示したように、今回は意図的に<code>about</code>アクションをコマンドライン引数から取り除きました。 これは、同じく<a class="ref" href="#sec-first_tests">3.2</a> から、テスト駆動開発 (Test-Driven Development, TDD) という開発手法を学ぶためです。</p>

<p><a class="ref" href="#code-generating_pages">リスト 3.4</a>では、コントローラ名を<a href="https://en.wikipedia.org/wiki/CamelCase">キャメルケース</a> (訳注: 単語の頭文字を大文字にしてつなぎ合わせた名前) で渡していることにご注目ください。こうすると、StaticPagesコントローラは、<a href="https://en.wikipedia.org/wiki/Snake_case">スネークケース</a> (訳注: 単語間にアンダースコアを加えて繋ぎ合わせた名前) のファイル <code>static_pages_controller.rb</code> を自動的に生成します。ただし、上のような命名は単なる慣習に過ぎません。実際、コマンドライン上で以下のようなスネークケースのコントローラ名を入力しても、</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller static_pages ...
</pre></div>
</div>


<p>先ほどと同様に<code>static_pages_controller.rb</code>というコントローラが生成されます。これは、Rubyがクラス名にキャメルケースを使う慣習があり (詳細は<a class="ref" href="#sec-ruby_classes">4.4</a>で説明します)、また、キャメルケースの名前を使うことが好まれているためです。これらの慣習に必ず従わなければいけないということではありません。(同様にRubyでは、ファイル名をスネークケースで記述する慣習があります。このため Railsのgenerateスクリプトでは、 <a href="http://api.rubyonrails.org/classes/ActiveSupport/Inflector.html#method-i-underscore"><tt>underscore</tt></a>メソッドを使ってキャメルケースをスネークケースに変換しています。)</p>

<p>ところで、自動生成に失敗するようなことがあれば、元に戻す処理を学ぶ良い機会になります。以下の<a class="ref" href="#sidebar-undoing_things">コラム 3.1</a>で元に戻す方法を紹介しています。</p>

<div class="label" id="sidebar-undoing_things"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 3.1</span></span><span class="title"><span class="description">元に戻す方法</span></span>
<p>どれほど十分に気を付けていたとしても、Railsアプリケーションの開発中に何か失敗してしまうことはありえます。ありがたいことに、Railsにはそのような失敗をカバーする機能がいくつもあります。</p>

<p>一般的なシナリオの1つは、生成したコードを元に戻したい場合です。たとえば、コントローラを生成した後で、もっといいコントローラ名を思い付いた場合などです。<a class="ref" href="#code-generating_pages">リスト 3.4</a>に示したように、コントローラを生成すると、コントローラファイル以外にも多数のファイルが作成されます。自動生成されたコードを元に戻すためには、新規作成されたファイルを削除するだけではなく、既存のファイルに挿入されたコードも削除する必要があります (実際、<tt>routes.rb</tt> ファイルに自動的に追加されたコードも元に戻す必要があります) 。このようなときは、<tt>rails destroy</tt>コマンドを実行するだけで元に戻すことができます。たとえば次の2つのコマンドは、自動生成と、それに対応する取り消し処理の例です。</p>

<pre class="verbatim">  $ rails generate controller FooBars baz quux
  $ rails destroy  controller FooBars baz quux</pre>


<p>なお <a class="ref" href="#cha-modeling-users">第6章</a>でも、以下のように<em>モデル</em>を自動生成する方法を紹介します。</p>

<pre class="verbatim">  $ rails generate model Foo bar:string baz:integer</pre>


<p>モデルの自動生成についても、同様の方法で元に戻すことができます。</p>

<pre class="verbatim">  $ rails destroy model Foo</pre>


<p>(上のコマンドからわかるように、モデル名以外の引数は不要です。その理由については<a class="ref" href="#cha-modeling-users">第6章</a>で説明しています)。</p>

<p>また、<a class="ref" href="#cha-a-demo-app">第2章</a>でも簡単に紹介しましたが、<em>マイグレーション</em>の変更を元に戻す方法もあります。詳細は<a class="ref" href="#cha-modeling-users">第6章</a>で説明します。簡単に言うと、まず以下のコマンドでデータベースのマイグレーションを変更できます。</p>

<pre class="verbatim">  $ rake db:migrate</pre>


<p>以下のコマンドで1つ前の状態に戻すことができます。</p>

<pre class="verbatim">  $ rake db:rollback</pre>


<p>最初の状態に戻したい場合は、以下のコマンドを使います。</p>

<pre class="verbatim">  $ rake db:migrate VERSION=0</pre>


<p>既にお気付きの方もいると思いますが、マイグレーションは逐次的に実行され、それぞれのマイグレーションに対してバージョン番号が付与されます。したがって、上記の <tt>0</tt>を別の数字に置き換えることによって、指定したバージョンの状態に戻すことができます。</p>

<p>これらの方法に慣れることで、開発中に<a href="http://en.wikipedia.org/wiki/SNAFU">袋小路</a>に迷い込んでしまった場合でも、これらの機能を使って元の状態に復帰することができます。</p>
</div>


<p><a class="ref" href="#code-generating_pages">リスト 3.4</a>のように、StaticPagesコントローラを生成すると、<code>config/routes.rb</code>ファイルが自動的に更新されます。Railsは、この <em>routes</em>ファイルに記述されている内容 (ルーティング) に従って、 複数のURIとWebページを対応付けます。ここで、初めて<code>config</code>ディレクトリについて触れます。このディレクトリは<a class="ref" href="#fig-config_directory_rails_3">図 3.4</a>のような構成をしています。<code>config</code>ディレクトリという名前のとおり、このディレクトリ内にあるファイルは、Railsがアプリケーションの設定を読み込む時に必要になります。</p>

<div class="label" id="fig-config_directory_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/config_directory_rails_3.png" alt="config_directory_rails_3" /></span></div><div class="caption"><span class="header">図3.4</span><span class="description">サンプルアプリケーションの<code>config</code>ディレクトリの内容。<a href="http://railstutorial.org/images/figures/config_directory_rails_3-full.png">(拡大)</a></span></div></div>


<p>先ほど<code>home</code>アクションと<code>help</code>アクションを生成したので、<a class="ref" href="#code-pages_routes">リスト 3.5</a>に示したように、routesファイルにはそれぞれのアクションで使用されるルールが定義されています。</p>

<div class="label" id="code-pages_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.5</span> <span class="description">StaticPagesコントローラ内の<code>home</code>アクションと<code>help</code>アクションで使用するルーティング。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/home&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/help&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここで以下のルールに注目してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;static_pages/home&quot;</span>
</pre></div>
</div>


<p>このルールは、/static_pages/homeに対するリクエストを、StaticPagesコントローラの<code>home</code>アクションと結びつけています。具体的には、<code>get</code>と書くことで、<tt>GET</tt>リクエストに対して該当するアクションを結びつけています。なお、ここでいう GETリクエストとは、<em>HTTP (HyperText Transfer Protocol) </em> (<a class="ref" href="#sidebar-get_etc">コラム  3.2</a>) が対応しているメソッドの1つです。今回の場合は、StaticPagesコントローラ内に<code>home</code>アクションを追加したので、/static_pages/homeにアクセスすることでページを取得 (GET) できるようになりました。<a href="http://localhost:3000/static_pages/home">/static_pages/home</a>にアクセスして結果を表示します (<a class="ref" href="#fig-raw_home_view">図3.5</a>)。</p>

<div class="label" id="fig-raw_home_view"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/raw_home_view_31.png" alt="raw_home_view_31" /></span></div><div class="caption"><span class="header">図3.5</span><span class="description"><a href="http://localhost:3000/static_pages/home">/static_pages/home</a>にアクセスした結果。<a href="http://railstutorial.org/images/figures/raw_home_view_31-full.png">(拡大)</a></span></div></div>




<div class="label" id="sidebar-get_etc"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 3.2</span></span><span class="title"><span class="description"><tt>GET</tt>やその他のHTTPメソッドについて</span></span>
<p><a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods">HTTP</a> (HyperText Transfer Protocol) には4つの基本的な操作があり、それぞれ<em>get</em>、<em>post</em>、<em>put</em>、<em>delete</em>という４つの動詞に対応づけられています。<em>クライアント</em> (通常、FirefoxやSafariなどのウェブブラウザ) と<em>サーバー</em> (ApacheやNginxなどのWebサーバー) は、上で述べた4つの基本操作を互いに認識できるようになっています (ローカル環境でRailsアプリケーションを開発しているときは、クライアントとサーバーが同じコンピュータ上で動いていますが、一般的には、それぞれ別のコンピュータで動作している点を理解しておいてください)。Railsを含む多くのWebフレームワークは、HTTPの各操作を発展させた<em>REST アーキテクチャ</em>の影響を受けています。<a class="ref" href="#cha-a-demo-app">第2章</a>でも簡単に触れましたが、<a class="ref" href="#cha-sign-up">第7章</a>では、より深い内容について学びます。</p>

<p><tt>GET</tt> は、最も頻繁に使用されるHTTP操作で、主にWeb上のデータを<em>読み取る</em>際に使われます。“ページを取得する” という意味のとおり、ブラウザはgoogle.comやwikipedia.orgなどのWebサイトを開くたびに<tt>GET</tt>リクエストを送信します。<tt>POST</tt> は、GETの次によく使用される操作で、ページ上のフォームに入力した値を、ブラウザから送信する時に送られるリクエストです。Railsアプリケーションでは、<tt>POST</tt>リクエストは何かを<em>作成する</em>ときによく使われます (なお本来のHTTPでは、<tt>POST</tt>を更新に使ってもよいとしています)。たとえば、ユーザー登録フォームで新しいユーザを作成するときは、<tt>POST</tt>リクエストを送信します。他にも、<tt>PUT</tt>と <tt>DELETE</tt>という2つの操作があり、それぞれサーバー上の何かを<em>更新</em>したり<em>削除</em>したりするときに使われます。これら2つの操作は、<tt>GET</tt>や<tt>POST</tt>ほどは使用されていません。これは、ブラウザがPUTとDELETEをネイティブでは送信しないからです。しかし、Ruby on Railsなどの多くのWebフレームワークは、ブラウザがこれらの操作のリクエストを<em>送信しているかのように見せかける</em>技術 (偽装) を駆使して、PUTとDELETEという操作を実現しています。</p>
</div>


<p>このページがどのようにして表示されるのかを理解するために、まずはテキストエディタでStaticPagesコントローラを開いてみましょう。<a class="ref" href="#code-static_pages_controller">リスト3.6</a>のような内容になっているはずです。ここで、<a class="ref" href="#cha-a-demo-app">第2章</a>のUsersコントローラやMicropostsコントローラとは異なり、StaticPagesコントローラは一般的なRESTアクションに対応していないことにご注意ください。これは、静的なページの集合に対しては、適切なアクションと言えます。言い換えると、RESTアーキテクチャは、あらゆる問題に対して最適な解決方法であるとは限らないということです。</p>

<div class="label" id="code-static_pages_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.6</span> <span class="description"><a class="ref" href="#code-generating_pages">リスト3.4</a>で生成されたStaticPagesコントローラ。</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-static_pages_controller">リスト 3.6</a>の<code>class</code>というキーワードから、<code>static_pages_controller.rb</code>は<code>StaticPagesController</code>という<em>クラス</em>を定義していることがわかります。クラスは、<em>関数</em> (<em>メソッド</em>とも呼ばれます) をまとめるときに便利な手法です。今回の例では、<code>def</code>というキーワードを使って、<code>home</code>アクションや<code>help</code>アクションを定義しています。また、山かっこ<code>&lt;</code>は、<code>StaticPagesController</code>が <code>ApplicationController</code>というRailsのクラスを<em>継承</em>していることを示しています。この後も説明しますが、今回作成したページには、Rails特有の機能が多数使用されています (具体的なクラスや継承については、<a class="ref" href="#sec-ruby_classes">4.4</a>で詳しく説明します)。</p>

<p>今回のStaticPagesコントローラにあるメソッドは、以下のようにどちらも最初は空になっています。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">help</span>
<span class="k">end</span>
</pre></div>
</div>


<p>純粋なRuby言語であれば、これらのメソッドは何も実行しません。しかし、Railsでは動作が異なります。<code>StaticPagesController</code>はRuby のクラスですが、<code>ApplicationController</code>クラスを継承しているため、StaticPagesControllerのメソッドはRails特有の振る舞いをします。具体的には、/static_pages/homeというURIにアクセスすると、RailsはStaticPagesコントローラを参照し、<code>home</code>アクションに記述されているコードを実行します。その後、そのアクションに対応する<em>ビュー</em> (<a class="ref" href="#sec-mvc">1.2.6</a>で説明したMVCのVに相当) を出力します。今回の場合、<code>home</code>アクションが空になっているので、/static_pages/homeにアクセスしても、単に対応するビューが出力されるだけになります。では、ビューはどのように出力されるのでしょうか。また、どのビューが表示されるのでしょうか。</p>

<p> <a class="ref" href="#code-generating_pages">リスト3.4</a>を注意深く読んでみると、アクションとビューの関係性について理解できるでしょう。<code>home</code>アクションは、<code>home.html.erb</code>というビューに対応しています。<code>.erb</code>の詳細については<a class="ref" href="#sec-slightly_dynamic_pages">3.3</a>で説明しますが、ファイル名に<code>.html</code>が含まれていることから推測できるとおり、基本的にはHTMLと同じような構造になっています (<a class="ref" href="#code-raw_home_view">リスト3.7</a>)。</p>

<div class="label" id="code-raw_home_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.7</span> <span class="description">Homeページを出力する、生成されたビュー</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>StaticPages#home<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/static_pages/home.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p><code>help</code>アクションに対応するビューも、上のコードと似ています (<a class="ref" href="#code-raw_help_view">リスト3.8</a>)。 </p>

<div class="label" id="code-raw_help_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.8</span> <span class="description">Helpページを出力する、生成されたビュー</span><br /><span class="description"> <code>app/views/static_pages/help.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>StaticPages#help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/static_pages/help.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>どちらのビューも単なるプレースホルダになっています。トップレベルの見出しが<code>h1</code>タグの中にあり、関連するファイルへの絶対パスが<code>p</code>タグの中に書かれています。<a class="ref" href="#sec-slightly_dynamic_pages">3.3</a>からは、(ほんの少しだけ) 動的なコンテンツを追加しますが、ここで重要なのは「Railsのビューは静的なHTMLで構成されている」という点です。ブラウザから見えるのは常にHTMLなので、ブラウザの側から見れば、<a class="ref" href="#sec-truly_static_pages">3.1.1</a>のような生のHTMLファイルも、コントローラやアクションを使用して生成されたページも、違いはありません。</p>

<p>以後本章では、HomeページとHelpページのコンテンツを少しだけカスタマイズします。また、<a class="ref" href="#sec-static_pages_with_rails">3.1.2</a>で先送りにしたAbout ページにもコンテンツを追加していきます。それが終わったら、ページごとに異なるタイトルを表示する、ほんの少しだけ動的なコンテンツを追加します。</p>

<p>次に進む前に、StaticPagesコントローラファイルをGitリポジトリに追加しておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add a StaticPages controller&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-first_tests"></div>


<h2><a id="sec-3_2" href="#sec-first_tests" class="heading"><span class="number">3.2</span>最初のテスト</a></h2>


<p><em>Railsチュートリアル</em> では、一字一句間違えることなく最初から正確に実装するのではなく、アプリケーションの振る舞いをテストしながら実装する直観的な手法を採用しています。この開発手法は、テスト駆動開発 (Test-Driven Develpment, TDD) から派生した振舞駆動開発 (Behavior-Driven Development, BDD) として知られています。本書でこれから頻繁に使うツールは、<em>結合テスト (integration test) </em>と<em>単体テスト (unit test) </em>の2つです。結合テストについてはこの節から、単体テストについては<a class="ref" href="#cha-modeling-users">第6章</a>から解説していきます。結合テスト (RSpec では <em>リクエストspec</em> と呼んでいます) は、ユーザがアプリケーションを使う際の一連のアクションをシミュレーションします。結合テストは、アプリケーションの各ページが正常に動作するかどうかをテストしてくれる強力なツールです。手動でブラウザを操作してテストする必要がなくなり、Capybaraを併用すれば自然言語 (英語) に近い文法でテストを記述する事もできます (Capybara以外にも、Cucumberという振舞駆動開発用ツールが有名です。詳細については<a class="ref" href="#sec-cucumber">8.3</a>で紹介します)。</p>

<p>テスト駆動開発の定義とは、アプリケーションを開発するときに<em>最初に</em>テストを作成し、次にコードを作成することです。この開発手法に慣れるまでには多少時間がかかるかもしれませんが、しかし一度慣れてしまえば大きなメリットを得られます。<em>失敗する</em>テストを最初に書き、テストにパスするコードを次に実装することで、しかるべき振る舞いがテストによって正しく検証されている、という自信が付きます。さらに、この「失敗-実装-成功」という開発サイクルは、「<a href="http://en.wikipedia.org/wiki/Flow_(psychology)">開発フロー</a>」を生み出します。そしてこの開発フローに乗ることで、コーディングが楽しくなり、開発の生産性も向上します。また、テストはアプリケーションのコードに対して<em>クライアント</em>として振る舞うので、ソフトウェア設計の改良につながることも多くなるでしょう。</p>

<p>ただし、テスト駆動開発がどんな仕事に対しても常に正しい手法であるとは限りません。このことは十分に理解しておいてください。「最初にテストを書くべきである」、「テストはひとつひとつの機能を完全にカバーするべきである」、「すべての箇所をテストすべきである」などのような教条的な主張を正当化できる理由はどこにもありません。たとえば、与えられた課題の解決法に今ひとつ確信が持てないときは、(テストを書かずに) まず試しにアプリケーションコードだけを書いてみて、どんな解決方法があるのか模索してみる方が良い結果を得られることもあります (<a href="http://en.wikipedia.org/wiki/Extreme_Programming">エクストリームプログラミング (Extreme Programming, XP)</a> という開発手法では、この模索段階を<em>スパイク (spike) </em>と呼んでいます)。そして解決策が明確になった段階で、テスト駆動開発でコードを清書するという方法もありえます。</p>

<p>この節では、RSpec gemによって提供される<code>rspec</code>コマンドを使ってテストを実行します。この節は素直なつくりになっていますが、物足りないと思う方もいるかもしれません。上級開発者であれば、先に<a class="ref" href="#sec-advanced_setup">3.6</a>を読んでシステム設定を完了しておくことをお勧めします。</p>

<div class="label" id="sec-TDD"></div>


<h3><a id="sec-3_2_1" href="#sec-TDD" class="heading"><span class="number">3.2.1</span>テスト駆動開発</a></h3>


<p>テスト駆動開発で最初に書く、<em>失敗する</em>テストのことを、一般的なテストツールでは「赤色 (Red)」と表現します (失敗時に表示が赤くなるツールが多いため)。同様に、次に書く、テストにパスするコードのことを「緑色 (Green)」と表現します。最後に、必要に応じてコードをリファクタリング (動作を変えずにコードを改善すること) したりフォームを変更したりします。冗長なコードを削除したりするのもリファクタリングの例です。このサイクルのことを「Red/Green/Refactor」と呼びます。</p>

<p>それでは、テスト駆動開発でいくつかのコンテンツをHomeページに追加してみましょう。トップレベルの見出し (<code>&lt;h1&gt;</code>) に &quot;<code>Sample App</code>&quot; という語を追加する作業もこの中に含まれます。 まず、静的なページに対する結合テスト (request spec) を生成するところから始めましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test static_pages
<span class="go">      invoke  rspec</span>
<span class="go">      create    spec/requests/static_pages_spec.rb</span>
</pre></div>
</div>


<p>これにより、<code>spec/requests</code>ディレクトリに<code>static_pages_spec.rb</code>が生成されます。自動生成される他のコードと同様に、最初のコードは完全ではありません。そこで、テキストエディタで<code>static_pages_spec.rb</code> を開き、<a class="ref" href="#code-home_page_content_spec">リスト 3.9</a>のようにコードを書いてみましょう。</p>

<div class="label" id="code-home_page_content_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.9</span> <span class="description">Homeページの内容をテストするコード。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-home_page_content_spec">リスト 3.9</a>にあるコードはすべてRubyで書かれています。しかし、Rubyを勉強したことがある人にとっては見慣れない書き方に見えるかもしれません。これは、Rubyの柔軟性の高さを応用して、RSpecがテスト用の独自言語 (<em>Domain-Specific Language, DSL</em>) を定義しているからです。ここで重要なのは、<em>RSpecを使うためにRSpec独自の文法を理解する必要はない</em>ということです。最初のうちは魔法のように見えるかもしれませんが、RSpecやCapybaraは英語に近い形で読めるように設計されています。したがって、<code>generate</code>スクリプトで生成されるテスト例や、本チュートリアルで取り上げるテスト例を読み進めるだけで、英語圏の方ならRSpecの文法を楽に扱えるようになります。</p>

<p><a class="ref" href="#code-home_page_content_spec">リスト3.9</a>には<code>describe</code>というブロックがあり、そのブロック内には <code>it &quot;…&quot; do</code>で始まる<em>テスト例</em>があります。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>最初の行では、Homeページに対するテストであることを記述しています。これは単なる文字列であり、好きな文字列を使用できます。RSpecはこの文字列を解釈しないので、人間にとってわかりやすい説明をここに書くようにします。次の行では、「<code>/static_pages/home</code>のHomeページにアクセスしたとき、“Sample App”という語が含まれていなければならない」と記述しています。最初の行と同様で、RSpec はダブルクォート (&quot;) で囲まれた文字列を無視しますので、ここにも人間にとってわかりやすい説明文を書きましょう (訳注: 英語で should have...と書くことで、メソッドのitと整合性が取れます)。その次の行について説明します。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
</pre></div>
</div>


<p>上の行は、Capybaraの<code>visit</code>機能を使って、ブラウザでの<code>/static_pages/home</code>URIへのアクセスをシミュレーションします。</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>その次の行 (上のコード) では、Capybaraの<code>page</code>変数を使って、アクセスした結果のページに正しいコンテンツが表示されていることをテストしています。</p>

<p>テストではさまざまなオプションが使用でき、さらに高度で便利なツールもあります。詳細については<a class="ref" href="#sec-advanced_setup">3.6</a>で説明します。今回は、コマンドラインで<code>rspec</code>コマンドを実行してみてましょう (なお、<code>bundle exec</code>をこのコマンドの前に置くことで、<code>Gemfile</code>内で定義された環境でRSpecが実行されるように、明示的に指示することができます<sup class="footnote" id="fnref-3_9"><a href="#fn-3_9">9</a></sup>)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>上のコマンドを実行すると、「テストが失敗した」という結果が返ってきます。 結果の表示はシステムによって異なりますが、著者のシステムでは、<a class="ref" href="#fig-red_failing_spec">図3.6</a>のように失敗したテストが赤く表示されます<sup class="footnote" id="fnref-3_10"><a href="#fn-3_10">10</a></sup>  (このスクリーンショットを撮った時点ではGitのブランチ戦略を取り入れていなかったので、<tt>static-pages</tt>ではなく<tt>master</tt>と表示されていますが、特に深い意図はありません)。</p>

<div class="label" id="fig-red_failing_spec"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/red_failing_spec.png" alt="red_failing_spec" /></span></div><div class="caption"><span class="header">図3.6</span><span class="description">赤く表示されている (失敗した) テスト。<a href="http://railstutorial.org/images/figures/red_failing_spec-full.png">(拡大)</a></span></div></div>


<p>テストにパスするために、自動生成されたHomeページのHTMLを<a class="ref" href="#code-home_page_passing">リスト3.10</a>のように書き換えてみましょう。</p>

<div class="label" id="code-home_page_passing"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.10</span> <span class="description">テストにパスするHomeページ用コード。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>トップレベルの見出し (<code>&lt;h1&gt;</code>) が<code>Sample App</code>に変更されたため、上のコードはテストにパスします。また、<em>アンカー</em>タグ <code>a</code> を使って、指定したURIにジャンプする以下のリンクを追加しました (ちなみにアンカータグ内の “href” は “hypertext reference” と読みます)。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>


<p>結果を見るために、もう一度テストを実行してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>著者のシステムでは、<a class="ref" href="#fig-green_passing_spec">図3.7</a>のように表示されました。</p>

<div class="label" id="fig-green_passing_spec"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/green_passing_spec.png" alt="green_passing_spec" /></span></div><div class="caption"><span class="header">図3.7</span><span class="description">緑色で表示されている (成功した) テスト。<a href="http://railstutorial.org/images/figures/green_passing_spec-full.png">(拡大)</a></span></div></div>


<p>Helpページについても、Homeページの例を参考にして、同じようなテストとアプリケーションコードを使用できることが推測できます。最初に、文字列を <code>’Help’</code> に書き換えたテストを追加してみましょう (<a class="ref" href="#code-help_content_spec">リスト 3.11</a>)。</p>

<div class="label" id="code-help_content_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.11</span> <span class="description">Helpページの内容をテストするコードを追加する。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでテストを実行してみます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>テストのうち、1つは失敗するはずです。(注: 執筆作業軽減のため、今後はRSpecの出力結果を掲載しません。画面表示の内容はシステムによって大きく異なるうえ、各段階での出力画面数を把握してメンテナンスし続けるのがきわめて困難なためです。ご了承ください。)</p>

<p><a class="ref" href="#code-help_page_passing">リスト3.12</a>に示したように、テストにパスするアプリケーションコード (現時点では生のHTML) は<a class="ref" href="#code-home_page_passing">リスト3.10</a>と同じようなコードになります。</p>

<div class="label" id="code-help_page_passing"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.12</span> <span class="description">テストにパスする、Helpページ用のコード。</span><br /><span class="description"> <code>app/views/static_pages/help.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Get help on the Ruby on Rails Tutorial at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/help&quot;</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
  To get help on this sample app, see the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/book&quot;</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>これでテストにパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<div class="label" id="sec-adding_a_page"></div>


<h3><a id="sec-3_2_2" href="#sec-adding_a_page" class="heading"><span class="number">3.2.2</span>ページの追加</a></h3>


<p>先ほどのテスト駆動開発のシンプルなテスト例を参考に、もう少し複雑なタスクを実行するページを新規追加してみましょう。具体的には、<a class="ref" href="#sec-static_pages_with_rails">3.1.2</a>で意図的に先送りにしたAboutページを新しく追加します。段階ごとにテストを作成してRSpecを実行することで、テスト駆動開発によってアプリケーション開発を進める方法を理解できるようになるでしょう。</p>

<div class="label" id="sec-red"></div>


<h4><a id="sec-3_2_2_1" href="#sec-red" class="heading">赤 (Red)</a></h4>


<p>赤色から緑色にするために、最初にAboutページ用の失敗するテストを書き、赤色にしましょう。 <a class="ref" href="#code-help_content_spec">リスト3.11</a>を参考にすることで、正しいテストを推測できるでしょう(<a class="ref" href="#code-about_page_content_spec">リスト3.13</a>)。</p>

<div class="label" id="code-about_page_content_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.13</span> <span class="description"> Aboutページのテストを追加する。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the content &#39;About Us&#39;&quot;</span> <span class="k">do</span> 
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-green"></div>


<h4><a id="sec-3_2_2_2" href="#sec-green" class="heading">緑 (Green)</a></h4>


<p><a class="ref" href="#sec-static_pages_with_rails">3.1.2</a>で触れたように、Railsでは、アクションと、それに対応するページ名を持つビューを作成することで、静的なページを生成することができます。今回の場合、 Aboutページを使用できるようにするには、<code>about</code>アクションをStaticPagesコントローラの中に追加する必要があります。最初に失敗するテストを書き、次にそのテストにパスするように実装することで、正常に動作するAboutページを作成できたという実感を得ることができます。</p>

<p>先ほど実装したRSpecのテストを実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>上を実行した出力結果の中に、以下のような警告が含まれているはずです。</p>

<div class="code"><div class="highlight"><pre>No route matches [GET] &quot;/static_pages/about&quot;
</pre></div>
</div>


<p>このメッセージは、<code>/static_pages/about</code>というルートをroutesファイルに追加する必要があるということを示しています。<a class="ref" href="#code-pages_routes">リスト3.5</a>のパターンに従って、routesファイルを<a class="ref" href="#code-about_route">リスト3.14</a>のように変更することでこの問題は解決します。</p>

<div class="label" id="code-about_route"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.14</span> <span class="description"><code>about</code>用のルートを追加する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/home&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/help&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/about&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>再び以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>今度は以下のエラーメッセージが発生します。</p>

<div class="code"><div class="highlight"><pre>The action &#39;about&#39; could not be found for StaticPagesController
</pre></div>
</div>


<p>この問題を解決するために、<a class="ref" href="#code-static_pages_controller">リスト 3.6</a>の<code>home</code>アクションや <code>help</code>アクションのパターンに従って、StaticPagesコントローラの中に<code>about</code>アクションを追加します (<a class="ref" href="#code-adding_the_about_page">リスト 3.15</a>)。</p>

<div class="label" id="code-adding_the_about_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.15</span> <span class="description"><code>about</code>アクションが追加されたStaticPagesコントローラ。</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>再び以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>今度は、ビューなどの &quot;テンプレート&quot; が見当たらないというエラーメッセージが表示されます。</p>

<div class="code"><div class="highlight"><pre>ActionView::MissingTemplate:
  Missing template static_pages/about
</pre></div>
</div>


<p>これは、<code>about</code>ビューを追加することで解決します。具体的には、<code>app/views/static_pages</code>ディレクトリの中に<code>about.html.erb</code>というファイルを作成し、<a class="ref" href="#code-about_view">リスト 3.16</a>の内容を書き込みます。</p>

<div class="label" id="code-about_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.16</span> <span class="description">Aboutページのコード</span><br /><span class="description"> <code>app/views/static_pages/about.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  is a project to make a book and screencasts to teach web development
  with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
  is the sample application for the tutorial.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>今度は、RSpecを実行すると緑色になるはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>もちろん、実際にブラウザを起動して、テストが正しく動いているかどうかを確かめることもできます (<a class="ref" href="#fig-about_us">図3.8</a>)。</p>

<div class="label" id="fig-about_us"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/about_us_2nd_edition.png" alt="about_us_2nd_edition" /></span></div><div class="caption"><span class="header">図3.8</span><span class="description">作成したAboutページ (<a href="http://localhost:3000/static_pages/about">/static_pages/about</a>)。<a href="http://railstutorial.org/images/figures/about_us_2nd_edition-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-refactor"></div>


<h4><a id="sec-3_2_2_3" href="#sec-refactor" class="heading">リファクタリング</a></h4>


<p>テストが緑色になったので、安心してコードをリファクタリングできるようになりました。多くの場合、コードを書き進めるうちに肥大化したり繰り返しが増えたりして、いつしか「悪臭を放つ」醜悪なコードになりはてるものです。コードが醜くてもコンピュータはそのことを気にかけませんが、開発者にとってはそうはいきません。だからこそ、頻繁にリファクタリングを実施し、コードを清潔な状態に保ち続けることが重要です。この点において、良いテストコードがあるということは非常に貴重です。リファクタリングする際にバグが混入する可能性を劇的に小さくしてくれるからです。</p>

<p>サンプルアプリケーションはかなり小規模なので、今のところリファクタリングの余地はありません。しかしコードの「悪臭」はやがてあらゆる箇所からただよいはじめ、そのうちにリファクタリングが必要になることでしょう。実際、<a class="ref" href="#sec-layouts">3.3.4</a>で早くもリファクタリングに取りかかることになります。</p>

<div class="label" id="sec-slightly_dynamic_pages"></div>


<h2><a id="sec-3_3" href="#sec-slightly_dynamic_pages" class="heading"><span class="number">3.3</span>少しだけ動的なページ</a></h2>


<p>以上で、静的ページのアクションとビューを作成しました。次は、ページの内容を反映したタイトルを持ち、ページごとに内容が変化する、<em>少しだけ</em>動的なページを作成してみましょう。
タイトルを変えることが<em>本当に</em>動的コンテンツかどうかは議論の余地があると思いますが、いずれにしろこのページは、<a class="ref" href="#cha-sign-up">第7章</a>で紹介する真に動的なコンテンツの基礎となります。</p>

<p><a class="ref" href="#sec-first_tests">3.2</a>のテスト駆動開発の説明を読んでいない場合は、<a class="ref" href="#code-about_route">リスト3.14</a>、<a class="ref" href="#code-adding_the_about_page">リスト3.15</a>、<a class="ref" href="#code-about_view">リスト3.16</a>のコードを使ってAboutページを必ず作成しておいてください。</p>

<div class="label" id="sec-testing_a_title_change"></div>


<h3><a id="sec-3_3_1" href="#sec-testing_a_title_change" class="heading"><span class="number">3.3.1</span>タイトル変更をテストする</a></h3>


<p>ここでの目標は、Home、Help、Aboutページをそれぞれ編集し、ページごとに異なるタイトルが表示されるようにすることです。ここではビューの<code>&lt;title&gt;</code>タグの内容を変更します。タイトルタグは、ほとんどのブラウザでウィンドウの上に表示されます (Google Chromeは例外ですが)。タイトルタグは、検索エンジン最適化 (SEO) においても重要な役割を担っています。最初にタイトルのテストを作成し、次にタイトルを追加し、さらに<em>レイアウト</em>ファイルを使ってリファクタリングと重複の排除を行います。</p>

<p>レイアウトファイルは、<code>rails new</code>コマンドを実行していれば既に作成されているはずです。レイアウトファイルの役割についてはこの後説明しますが、まずは作業開始前にレイアウトファイルのファイル名を変更しておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mv app/views/layouts/application.html.erb foobar   <span class="c"># 一時的な変更</span>
</pre></div>
</div>


<p>(<code>mv</code>はUnixのコマンドです。Windowsでファイル名を変更するには、ファイルブラウザから行うか、<code>rename</code>コマンドを使ってください)。実際のアプリケーション開発時には、上のような操作を行うことはおそらくないでしょう。ここでは、レイアウトファイルの役割をよりわかりやすく説明するために、最初にレイアウトファイルを無効にしました。</p>

<div class="label" id="table-static_pages"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_center"><strong>ページ</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>基本タイトル</strong></th><th class="align_left"><strong>追加タイトル</strong></th></tr><tr class="top_bar"><td class="align_center">Home</td><td class="align_left">/static_pages/home</td><td class="align_left"><code>&quot;Ruby on Rails Tutorial Sample App&quot;</code></td><td class="align_left"><code>&quot;Home&quot;</code></td></tr><tr><td class="align_center">Help</td><td class="align_left">/static_pages/help</td><td class="align_left"><code>&quot;Ruby on Rails Tutorial Sample App&quot;</code></td><td class="align_left"><code>&quot;Help&quot;</code></td></tr><tr><td class="align_center">About</td><td class="align_left">/static_pages/about</td><td class="align_left"><code>&quot;Ruby on Rails Tutorial Sample App&quot;</code></td><td class="align_left"><code>&quot;About&quot;</code></td></tr></table></div><div class="caption"><span class="header">表3.1</span><span class="description">サンプルアプリケーションの (ほぼ) 静的なページ。</span></div></div>


<p>この節が完了するまでに、3つの静的ページのすべてのタイトルが、“Ruby on Rails Tutorial Sample App | Home”のように、最後の単語のみ<a class="ref" href="#table-static_pages">テーブル3.1</a>に従ってページごとに変更されるようになります。最初に、<a class="ref" href="#code-about_page_content_spec">リスト3.13</a>のテストを元に、モデルに応じたタイトル表示のテスト (<a class="ref" href="#code-title_test">リスト3.17</a>) を追加します。</p>

<div class="label" id="code-title_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.17</span> <span class="description">タイトルのテスト。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストでは<code>have_selector</code>メソッドを使っています。これは与えられた内容の中にHTML要素 (セレクタ) があることをチェックしています。つまり、以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                  <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p><code>title</code>タグの内容が以下のとおりになっていることを確認します。</p>

<div class="code"><div class="highlight"><pre><span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span>
</pre></div>
</div>


<p>(<code>:text =&gt; &quot;…&quot;</code>のように、<em>ハッシュ</em>のキーに<em>シンボル</em>を使う記法については<a class="ref" href="#sec-hashes_and_symbols">4.3.3</a>で解説します)。ここで注意していただきたいのは、与えられた内容に対して完全一致する文字列を使用しなくてはならないということではなく、以下のように部分文字列を指定するだけでもよいということです。</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot; | Home&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>上のコードでもタイトル全体とマッチします。</p>

<p><a class="ref" href="#code-title_test">リスト 3.17</a>では<code>have_selector</code>を2行に分けていることにご注目ください。これは、改行の有無に影響されないというRubyの記法を生かしたものです<sup class="footnote" id="fnref-3_11"><a href="#fn-3_11">11</a></sup>。行を分割した<em>理由</em>は、1行を80字以内に収めてソースコードを読みやすくするためです<sup class="footnote" id="fnref-3_12"><a href="#fn-3_12">12</a></sup>。現状では、それでもこのコードは読みにくいままですが、<a class="ref" href="#sec-static_pages_exercises">3.5</a>でより見やすくなるようにリファクタリングをします。また、<a class="ref" href="#sec-pretty_rspec">5.3.4</a>で最新版のRspecの機能を使ってStaticPagesのテストを完全に書き換えます。</p>

<p><a class="ref" href="#code-title_test">リスト3.17</a>と同じ要領で、StaticPagesのテストに3つの静的ページのテストを追加します (<a class="ref" href="#code-pages_controller_spec_title">リスト3.18</a>)。</p>

<div class="label" id="code-pages_controller_spec_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.18</span> <span class="description">タイトルのテストを含むStaticPagesコントローラのspecファイル。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Home&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Help&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | About Us&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、<code>have_content</code>を<code>have_selector(’h1’, …)</code>に変更していることにご注目ください。変更した理由を考えてみてください (<em>ヒント:</em> もしタイトルに &#39;Help&#39; という文字が含まれていて、<code>h1</code>のタグの内容が &#39;Helf&#39; だったら何が起こるでしょうか)。</p>

<p><a class="ref" href="#code-pages_controller_spec_title">リスト 3.18</a>の内容を反映後、以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>今度はテストが赤色 (テストが失敗する) になるはずです。</p>

<div class="label" id="sec-passing_title_tests"></div>


<h3><a id="sec-3_3_2" href="#sec-passing_title_tests" class="heading"><span class="number">3.3.2</span>タイトルのテストをパスさせる</a></h3>


<p>今度は、タイトルのテストがパスするようにし、それと同時にWebページを正しく表示させるためのHTMLをすべて追加しましょう。<a class="ref" href="#code-hello_world">リスト3.3</a>の &quot;help&quot; ページにある基本的なHTMLの骨組みを使って、<a class="ref" href="#code-home_view_full_html">リスト3.19</a>のHomeページを作るところから始めましょう。</p>

<div class="label" id="code-home_view_full_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.19</span> <span class="description">完全なHTML構造を備えたHomeページのビュー</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Home<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-home_view_full_html">リスト 3.19</a>では<a class="ref" href="#code-pages_controller_spec_title">リスト 3.18</a>にある以下のテスト済みのタイトルを使います。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Home<span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>従って、Homeページのテストはパスするはずです。HelpとAboutのテストはまだ赤色 (失敗) の状態ですので、<a class="ref" href="#code-help_view_full_html">リスト 3.20</a>と<a class="ref" href="#code-about_view_full_html">リスト 3.21</a>のようにコードを追加してテストを緑色 (成功) にします。</p>

<div class="label" id="code-help_view_full_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.20</span> <span class="description">完全なHTML構造を備えたHelpページのビュー</span><br /><span class="description"> <code>app/views/static_pages/help.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Help<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Get help on the Ruby on Rails Tutorial at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/help&quot;</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
      To get help on this sample app, see the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/book&quot;</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-about_view_full_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.21</span> <span class="description">完全なHTML構造を備えたAboutページのビュー</span><br /><span class="description"> <code>app/views/static_pages/about.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | About Us<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      is a project to make a book and screencasts to teach web development
      with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
      is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="sec-embedded_ruby"></div>


<h3><a id="sec-3_3_3" href="#sec-embedded_ruby" class="heading"><span class="number">3.3.3</span>埋め込みRuby</a></h3>


<p>この節ではこれまでに、Railsのコントローラとアクションを使って3つの有効なページを生成することでさまざまなことを達成しました。しかしそれらは単純な静的ページであり、またRailsの能力を十分に発揮できていません。しかも、コードが甚だしく重複しています。</p>

<ul>
<li>ページのタイトルがどれもほぼ同じ (完全にではないが)。</li>
<li>“Ruby on Rails Tutorial Sample App” が3つのタイトルで共通している。</li>
<li>HTMLの構造全体が各ページで重複している。</li>
</ul>


<p>このようなコードの重複は、「重複してはならない」(Don’t Repeat Yourself, DRY) という重要な原則に反しています。以後、この節と次の節では重複を取り除き、コードをDRYにしていきます。</p>

<p>上の話と一見矛盾するようですが、最初に、現在のほとんど同じページのタイトルを、<em>完全に</em>同じになるようなコードを追加していきます。こうすることで、すべての重複を一気に取り除くことがより簡単になるからです。</p>

<p>重複を取り除くテクニックの一つとして、ビューで<em>埋め込みRuby</em> (Embedded Ruby) を使用できます。Home、Help、Aboutページには可変の要素があるので、Railsの<code>provide</code>関数を使用してタイトルをページごとに異なるようにします。それでは、<code>home.html.erb</code>ビューのコードを、<a class="ref" href="#code-home_view_erb_title">リスト3.22</a>のように、タイトルに含まれる&quot;Home&quot;という文字を置き換え、動作を確認しましょう。</p>

<div class="label" id="code-home_view_erb_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.22</span> <span class="description">タイトルにRubyを埋め込んだHomeページのビュー</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-home_view_erb_title">リスト3.22</a>は、<em>ERb</em>と呼ばれている、Rubyの埋め込みの最初の例です (これで、HTMLビューのファイルの拡張子が<code>.html.erb</code>となっている理由をおわかりいただけたと思います)。 ERbはウェブページに動的な要素を加えるときに使うテンプレートシステムです<sup class="footnote" id="fnref-3_13"><a href="#fn-3_13">13</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>上のコードに<tt class="verb">&lt;% ... %&gt;</tt>と書かれていることにご注目ください。Railsはこの中で<code>provide</code>関数を呼び出し、<code>:title</code>というラベルに <code>’Home’</code> という文字列を関連付けます<sup class="footnote" id="fnref-3_14"><a href="#fn-3_14">14</a></sup>。次に、以下のコードでRubyの<code>yield</code>関数を使用し、それを<tt class="verb">&lt;%= ... %&gt;</tt>表記 (上と微妙に異なることにご注目ください) で囲むことにより、テンプレートにタイトルを挿入します<sup class="footnote" id="fnref-3_15"><a href="#fn-3_15">15</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>(この2つの埋め込みRubyの違いは次のとおりです。<tt class="verb">&lt;% ... %&gt;</tt>と書く、中に書かれたコードを<em>単に実行し</em>、何も出力しませんが、<tt class="verb">&lt;%= ... %&gt;</tt>と等号を追加して書くと、中のコードが実行され、その結果がテンプレートに<em>挿入され</em>ます)。この変更を行なっても、表示されるページの内容は以前とまったく同じです。タイトルの可変部分がERbによって動的に生成されている点だけが異なります。</p>

<p><a class="ref" href="#sec-testing_a_title_change">3.3.1</a>のテストを実行することで、変更が正しく行われたことを確認できます。以下を実行してテストがパスすることを確認しましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>続いて、HelpページとAboutページも同様に変更します (<a class="ref" href="#code-help_view_erb_title">リスト3.23</a>、<a class="ref" href="#code-about_view_erb_title">リスト3.24</a>)。</p>

<div class="label" id="code-help_view_erb_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.23</span> <span class="description">タイトルで埋め込みRubyを使用したHelpページのビュー</span><br /><span class="description"> <code>app/views/static_pages/help.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Get help on the Ruby on Rails Tutorial at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/help&quot;</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
      To get help on this sample app, see the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/book&quot;</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-about_view_erb_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.24</span> <span class="description">タイトルで埋め込みRubyを使用したAboutページのビュー</span><br /><span class="description"> <code>app/views/static_pages/about.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      is a project to make a book and screencasts to teach web development
      with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
      is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="sec-layouts"></div>


<h3><a id="sec-3_3_4" href="#sec-layouts" class="heading"><span class="number">3.3.4</span>レイアウトを使って重複を解消する</a></h3>


<p>タイトルの可変部分をERbを使って置き換えたので、現在それぞれのページはだいたい以下のようになっています。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
      Contents
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>


<p>これを見ると、唯一の例外である<code>body</code>タグの内容を除き、<em>すべて</em>のページで (titleタグの内容を含め) 同じ構造になっていることがわかります。</p>

<p>Railsには、共通の構造をまとめるための<code>application.html.erb</code>という特別な<em>レイアウト</em>ファイルがあります。このファイル名は<a class="ref" href="#sec-testing_a_title_change">3.3.1</a>で変更してあったので、以下のように元に戻します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mv foobar app/views/layouts/application.html.erb
</pre></div>
</div>


<p>このレイアウトファイルを有効にするには、デフォルトのタイトル部分を以下の埋め込みRubyのコードに差し替えます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>その結果、レイアウトファイルは<a class="ref" href="#code-application_layout">リスト3.25</a>のようになります。</p>

<div class="label" id="code-application_layout"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.25</span> <span class="description">サンプルアプリケーションのレイアウトファイル。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>上のコードにある、以下の特殊なコードにご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>このコードは、各ページの内容をレイアウトに挿入するためのものです。ここでは、このコードの詳細な動作を正確に理解することは重要ではありません。レイアウトを使用するうえでは、/static_pages/homeにアクセスすると、<code>home.html.erb</code>の内容がHTMLに変換され、<tt class="verb">&lt;%= yield %&gt;</tt>の位置に挿入されるということだけ理解しておけば問題ありません。</p>

<p>Railsのデフォルトのレイアウトには、以下の行が追加されていることにもご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>これらのコードはそれぞれ、スタイルシート、JavaScript、<code>csrf_meta_tags</code>メソッドをページにインクルードするためのものです。スタイルシートとJavaScriptは、アセットパイプライン (<a class="ref" href="#sec-the_asset_pipeline">5.2.1</a>) の一部です。csrf_meta_tagsは、Web攻撃手法のひとつである<a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">クロスサイトリクエストフォージェリー</a> (cross-site request forgery, CSRF)を防ぐために使われるRailsのメソッドです。</p>

<p>もちろん、<a class="ref" href="#code-home_view_erb_title">リスト3.22</a>、<a class="ref" href="#code-help_view_erb_title">リスト3.23</a>、 <a class="ref" href="#code-about_view_erb_title">リスト3.24</a>のビューには、レイアウトと重複するHTMLがまだ残っているので、それらを削除して、内部のコンテツだけ残します。これにより、 <a class="ref" href="#code-home_view_interior">リスト3.26</a>、<a class="ref" href="#code-help_view_interior">リスト3.27</a>、<a class="ref" href="#code-about_view_interior">リスト .28</a>にそれぞれ示したように、ビューのコードが美しく簡潔なものになります。</p>

<div class="label" id="code-home_view_interior"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.26</span> <span class="description">HTML構造を削除したHomeページ。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-help_view_interior"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.27</span> <span class="description">HTML構造を削除したHelpページ。</span><br /><span class="description"> <code>app/views/static_pages/help.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Get help on the Ruby on Rails Tutorial at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/help&quot;</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
  To get help on this sample app, see the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/book&quot;</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-about_view_interior"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.28</span> <span class="description">HTML構造を削除したAboutページ。</span><br /><span class="description"> <code>app/views/static_pages/about.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  The <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  is a project to make a book and screencasts to teach web development
  with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
  is the sample application for the tutorial.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>上のように定義されたビューは、Home、Help、Aboutページの表示は以前と変わりませんが、コードの重複が大きく削減されました。最後に、このリファクタリングが正常に行われたことを確認するために、リファクタリング前と同様にテストにパスすることを確認します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>




<div class="label" id="sec-static_pages_conclusion"></div>


<h2><a id="sec-3_4" href="#sec-static_pages_conclusion" class="heading"><span class="number">3.4</span>最後に</a></h2>


<p>傍からは、この章では静的ページを<em>ほぼ</em>静的ページに変えただけで、ほとんど何もしていないように見えることでしょう。しかし、見た目に反して、Railsのコントローラ、アクション、ビューは大きく改善されており、動的なコンテンツを自由にサイトに追加することができるようになりました。皆さんに残されている今後の課題は、このチュートリアルをいかに最後までやりぬくか、それだけであると言ってよいでしょう。</p>

<p>次の章に進む前に、差分をコミットしてマスターブランチにマージしておきましょう。<a class="ref" href="#sec-static_pages_with_rails">3.1.2</a>では、静的ページの開発のためのGitブランチを用意しました。ここまでの作業内容をコミットしていなければ、きりのよい中継点に達したことがわかるようにコミットします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish static pages&quot;</span>
</pre></div>
</div>


<p>次にmasterブランチに移動し、<a class="ref" href="#sec-git_commands">1.3.5</a>と同じ要領で差分をマージします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge static-pages
</pre></div>
</div>


<p>このように中継点まで達したら、コードをリモートリポジトリにアップロードしておくとよいでしょう (<a class="ref" href="#sec-github">1.3.4</a>の手順に従っていれば、リモートリポジトリはGitHubになるでしょう)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
</pre></div>
</div>


<p>好みに応じて、更新したアプリケーションをHerokuにデプロイしても構いません。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
</pre></div>
</div>




<div class="label" id="sec-static_pages_exercises"></div>


<h2><a id="sec-3_5" href="#sec-static_pages_exercises" class="heading"><span class="number">3.5</span>演習</a></h2>




<ol>

<li>サンプルアプリケーションにContact (問い合わせ先) ページを作成してください。<a class="ref" href="#code-pages_controller_spec_title">リスト3.18</a>に従い、最初に、<code>h1</code>の内容が正しいかどうかを確認するテストを作成することで、URIが/static_pages/contactのページが存在することを確認するテストを作成してください。次に、タイトルが “Ruby on Rails Tutorial Sample App | Contact” となっていることを確認するテストを作成してください。次にこれらのテストにパスするようにしてください。それが終わったら、<a class="ref" href="#code-proposed_contact_page">リスト 3.29</a>の内容をContactページに反映させましょう。(この演習の解答は<a class="ref" href="#sec-layout_links">5.3</a>の説明に含まれています)。</li>

<li>お気付きの方もいると思いますが、<a class="ref" href="#code-pages_controller_spec_title">リスト3.18</a>に示されている、StaticPagesコントローラのspecテストには若干の重複があります。特に、“Ruby on Rails Tutorial Sample App”というタイトルはそれぞれのタイトルのテストで繰り返し記述されています。引数として渡されたシンボルと同名の変数にブロックの評価値を格納する、RSpecの<code>let</code>関数を使い、<a class="ref" href="#code-pages_controller_spec_exercise">リスト 3.30</a>のようにテストを変更し、テストにパスするようにしましょう。<a class="ref" href="#code-pages_controller_spec_exercise">リスト3.30</a>では文字列の式展開 (<em>string interpolation</em>) が行われていますが、これについては<a class="ref" href="#sec-strings">4.2.2</a>で紹介します。</li>

<li><strong>(上級者向け)</strong>「<a href="http://devcenter.heroku.com/articles/how-do-i-use-sqlite3-for-development">Heroku page on using <tt>sqlite3</tt> for development</a>」のページでも説明されているように、互換性の問題によるエラーを最小限にとどめるために、開発/テスト/本番環境で共通のデータベースを使うことは良いことです。「<a href="http://devcenter.heroku.com/articles/local-postgresql">Heroku instructions for local PostgreSQL installation</a>」には、PostgreSQLをローカル環境にインストールする手順が紹介されてます。PostgreSQLを使う場合は、 <a class="ref" href="#code-Gemfile_pg_gem">リスト3.31</a>にあるように、<code>Gemfile</code>から<tt>sqlite3</tt> gemを削除し、<tt>pg</tt> gemのみを使うようにしてください。さらに、<code>config/database.yml</code>ファイルと、PostgreSQLをローカル環境で動作させる方法を学ぶ必要があります。以上の情報を元に、PostgreSQLを使用して開発データベースとテストデータベースを作成し、設定を行うことが、この課題のゴールです。<strong>警告: </strong>この演習はかなり難易度が高いので、上級者にのみお勧めします。もし行き詰まってしまったら、すぐにこの演習を飛ばして次の作業に進んでください。なお、既に説明したとおり、このチュートリアルで開発しているサンプルアプリケーションは、SQLiteとPostgreSQLのどちらについても完全に互換性があります。</li>

</ol>




<div class="label" id="code-proposed_contact_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.29</span> <span class="description">Contactページで使用するコンテンツのコード。</span><br /><span class="description"> <code>app/views/static_pages/contact.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Contact Ruby on Rails Tutorial about the sample app at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/contact&quot;</span><span class="nt">&gt;</span>contact page<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-pages_controller_spec_exercise"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.30</span> <span class="description">基本となるタイトルを含むStaticPagesコントローラのspec。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:base_title</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Home&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | Home&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/help&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | Help&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | About Us&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/contact&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/contact&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | Contact&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-Gemfile_pg_gem"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.31</span> <span class="description">SQLiteの代わりにPostgreSQLを使う場合の<code>Gemfile</code>。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.11.0&#39;</span>
<span class="k">end</span>

<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-advanced_setup"></div>


<h2><a id="sec-3_6" href="#sec-advanced_setup" class="heading"><span class="number">3.6</span>高度なセットアップ</a></h2>


<p><a class="ref" href="#sec-first_tests">3.2</a>でも簡単に説明しましたが、<code>rspec</code>コマンドを直接実行することは実用的ではありません。この節では、最初に<code>bundle exec</code>を毎回コマンドに入力せずに済む方法を紹介します。次に、<a class="ref" href="#sec-guard">3.6.2</a>でGuardを使用したテストスイートの自動化方法を紹介し、さらに<a class="ref" href="#sec-spork">3.6.3</a>でSporkを使用したテストスイートの自動化方法も紹介します。最後に、Sublime Text上で直接テストを実行する方法を紹介します。このテクニックは、特にSporkと併用すると非常に便利です。</p>

<p>この節は、ほとんどが上級者向けの内容になっており、この節を飛ばしても次の章以降には何の影響もありません。この節の内容は先進的ですが、その分、本書の他の内容よりも陳腐化しやすいので、ご利用のシステムでこの節の例が完全に動作するとは限りません。この点をご了承願います。完全に動作させるには、Googleで最新情報を検索して調べることが必要になるでしょう。</p>

<div class="label" id="sec-eliminating_bundle_exec"></div>


<h3><a id="sec-3_6_1" href="#sec-eliminating_bundle_exec" class="heading"><span class="number">3.6.1</span><tt>bundle exec</tt>を追放する</a></h3>


<p><a class="ref" href="#sec-TDD">3.2.1</a>でも簡単に紹介しましたが、<code>rake</code>や<code>rspec</code>コマンドを実行するときには、現在の環境に依存するgemを<code>Gemfile</code>から読み込んでプログラムを実行するために、<code>bundle exec</code>をコマンドの前に追加する必要があります (技術的な理由により、<code>rails</code>コマンドだけは例外です)。この節の作業はかなり厄介です。また、bundle execの入力を省略する方法を2とおりの方法で説明します。</p>

<div class="label" id="sec-rvm_bundler_integration"></div>


<h4><a id="sec-3_6_1_1" href="#sec-rvm_bundler_integration" class="heading">RVM Bundler の統合</a></h4>


<p>最初に、お勧めの方法としてRVMを使う方法を紹介します。RVMはバージョン1.11以降からBundlerとの統合が含まれています。最初に、以下に従ってRVMのバージョンを最新にします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm get head <span class="o">&amp;&amp;</span> rvm reload
<span class="gp">$</span> rvm -v

<span class="go">rvm 1.15.6 (master)</span>
</pre></div>
</div>


<p>バージョン1.11.x以降のRVMを使用していれば、インストールされたgemは自動的に適切なBundlerの環境で実行されますので、それ以上何もしなくても以下のようにbundle execを省略してで実行できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/
</pre></div>
</div>


<p><code>bundle exec</code>を省略することができました。 このとおりにできた場合は、この節の残りはスキップしてください。</p>

<p>新しいバージョンのRVMを使うことができない場合は、Ruby Version Managerがローカル環境で自動的に設定する適切な実行ファイルがあれば、<a href="http://rvm.io/integration/bundler/">RVM Bundler integration</a><sup class="footnote" id="fnref-3_16"><a href="#fn-3_16">16</a></sup>で<code>bundle exec</code>を省略することができます。一見奇妙ですが、実行方法は簡単です。最初に以下の2つのコマンドを実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm get head <span class="o">&amp;&amp;</span> rvm reload
<span class="gp">$</span> chmod +x <span class="nv">$rvm_path</span>/hooks/after_cd_bundler
</pre></div>
</div>


<p>次に以下のコマンドを実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects/sample_app
<span class="gp">$</span> bundle install --without production --binstubs<span class="o">=</span>./bundler_stubs
</pre></div>
</div>


<p>魔法のように見えますが、これらのコマンドでRVMとBundlerを統合できます。そして、<code>rake</code>や<code>rspec</code>などのコマンドを適切な環境で自動的に実行してくれます。<code>bundler_stubs</code>ディレクトリを<code>.gitignore</code>ファイルに追加します (<a class="ref" href="#code-bundler_stubs_gitignore">リスト3.32</a>)。これらのファイルはローカル環境でしか使用しないためです。</p>

<div class="label" id="code-bundler_stubs_gitignore"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.32</span> <span class="description"><code>.gitignore</code>ファイルに<code>bundler_stubs</code>を追加する。</span> </div>
<div class="code"><div class="highlight"><pre># Ignore bundler config
/.bundle

# Ignore the default SQLite database.
/db/*.sqlite3

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

# Ignore other unneeded files.
doc/
*.swp
*~
.project
.DS_Store
bundler_stubs/
</pre></div>
</div></div>


<p><a class="ref" href="#sec-guard">3.6.2</a>の<code>guard</code>など、他の実行ファイルを追加する場合は、<code>bundle install</code>コマンドを再度実行して下さい。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --binstubs<span class="o">=</span>./bundler_stubs
</pre></div>
</div>




<div class="label" id="sec-binstubs"></div>


<h4><a id="sec-3_6_1_2" href="#sec-binstubs" class="heading">binstubオプション</a></h4>


<p>RVMを使用していない場合でも、<code>bundle exec</code>を省略する方法があります。Bundlerは、関連するバイナリを以下のように作成することができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle --binstubs
</pre></div>
</div>


<p>(実は、RVMを使用している場合でも、他のターゲットディレクトリに対してこのコマンドを使用します)。このコマンドは、アプリケーションの<code>bin/</code>ディレクトリに必要な実行ファイルをすべて作ります。これにより、以下のようにテストスイートを実行できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bin/rspec spec/
</pre></div>
</div>


<p>同様に<code>rake</code>なども以下のように実行できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bin/rake db:migrate
</pre></div>
</div>


<p><a class="ref" href="#sec-guard">3.6.2</a>の<code>guard</code>など、他の実行ファイルを追加する場合は、<tt class="verb">bundle</tt> <tt class="verb">--binstubs</tt>コマンドを再実行してください。</p>

<p>本書の以後の章では、この節をスキップする方に配慮して明示的に<code>bundle exec</code>を与えてコマンドを実行するようにしています。もちろん、ご利用のシステムが適切に設定されていれば、bundle execを省略しても構いません。</p>

<div class="label" id="sec-guard"></div>


<h3><a id="sec-3_6_2" href="#sec-guard" class="heading"><span class="number">3.6.2</span>Guardによるテストの自動化</a></h3>


<p><code>rspec</code>コマンドは、テストのたびにコマンドラインに移動して手動でコマンドを実行しなければならない点が面倒です (もうひとつ、テストスイートの起動が遅いという問題がありますが、これは<a class="ref" href="#sec-spork">3.6.3</a>で対応します)。この節では、テストを自動化する<a href="https://github.com/guard/guard">Guard</a>というgemの使い方を紹介します。Guardはファイルシステムの変更を監視し、たとえば<code>static_pages_spec.rb</code>ファイルを変更すると自動的にテストを実行します。さらに、<code>home.html.erb</code>ファイルが変更されると <code>static_pages_spec.rb</code>が自動的に実行されるようにGuardを設定することもできます。</p>

<p>最初に、<a class="ref" href="#code-gemfile_guard">リスト3.33</a>のように、<code>guard-rspec</code>を<code>Gemfile</code>に追加します。</p>

<div class="label" id="code-gemfile_guard"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.33</span> <span class="description">サンプルアプリケーションの<code>Gemfile</code>にGuardを追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.11.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;guard-rspec&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.1&#39;</span>
<span class="k">end</span>

<span class="c1"># Gems used only for assets and not required</span>
<span class="c1"># in production environments by default.</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="c1"># System-dependent gems</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次に、システムに依存するgemを以下のようにtestグループに追加します (OS Xユーザーの場合、<a href="http://growl.info/downloads#generaldownloads">Growlとgrowlnotify</a>もインストールする必要があります)。</p>

<div class="code"><div class="highlight"><pre><span class="c1"># Test gems on Macintosh OS X</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rb-fsevent&#39;</span><span class="p">,</span> <span class="s1">&#39;0.9.1&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">&#39;growl&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.3&#39;</span>
<span class="k">end</span> 
</pre></div>
</div>


<div class="code"><div class="highlight"><pre><span class="c1"># Test gems on Linux</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rb-inotify&#39;</span><span class="p">,</span> <span class="s1">&#39;0.8.8&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;libnotify&#39;</span><span class="p">,</span> <span class="s1">&#39;0.5.9&#39;</span>
<span class="k">end</span> 
</pre></div>
</div>


<div class="code"><div class="highlight"><pre><span class="c1"># Test gems on Windows</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rb-fchange&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rb-notifu&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;win32console&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.0&#39;</span>
<span class="k">end</span> 
</pre></div>
</div>


<p>次に<code>bundle install</code>を実行してgemをインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Guardを初期化し、RSpecと一緒に動作するようにします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard init rspec
<span class="go">Writing new Guardfile to /Users/mhartl/rails_projects/sample_app/Guardfile</span>
<span class="go">rspec guard added to Guardfile, feel free to edit it</span>
</pre></div>
</div>


<p>結合テストとビューが更新されたら自動的に適切なテストが実行されるように、生成された<code>Guardfile</code>を編集します (<a class="ref" href="#code-guardfile">リスト3.34</a>)。</p>

<div class="label" id="code-guardfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.34</span> <span class="description">デフォルトの<code>Guardfile</code>に追記する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;active_support/core_ext&#39;</span>

<span class="n">guard</span> <span class="s1">&#39;rspec&#39;</span><span class="p">,</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:all_after_pass</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/controllers/(.+)_(controller)\.rb$}</span><span class="p">)</span>  <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="o">[</span><span class="s2">&quot;spec/routing/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_routing_spec.rb&quot;</span><span class="p">,</span>
     <span class="s2">&quot;spec/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">s/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb&quot;</span><span class="p">,</span>
     <span class="s2">&quot;spec/acceptance/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb&quot;</span><span class="p">,</span>
     <span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="sr">/_pages/</span><span class="o">]</span> <span class="p">?</span> <span class="s2">&quot;spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb&quot;</span> <span class="p">:</span> 
                       <span class="s2">&quot;spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">singularize</span><span class="si">}</span><span class="s2">_pages_spec.rb&quot;</span><span class="p">)</span><span class="o">]</span>
  <span class="k">end</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^app/views/(.+)/}</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
    <span class="p">(</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">][</span><span class="sr">/_pages/</span><span class="o">]</span> <span class="p">?</span> <span class="s2">&quot;spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">_spec.rb&quot;</span> <span class="p">:</span> 
                       <span class="s2">&quot;spec/requests/</span><span class="si">#{</span><span class="n">m</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">singularize</span><span class="si">}</span><span class="s2">_pages_spec.rb&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードにある以下の行にご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">guard</span> <span class="s1">&#39;rspec&#39;</span><span class="p">,</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:all_after_pass</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
</pre></div>
</div>


<p>これは、失敗したテストが後にパスしたとき、他の余分なテストが実行されないようにするためのものです (Red-Green-Refactorのサイクルを早めるため)。</p>

<p>以上の準備が終われば、以下のコマンドで<code>guard</code>を起動できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard
</pre></div>
</div>


<p><code>bundle exec</code>を省略するには、<a class="ref" href="#sec-eliminating_bundle_exec">3.6.1</a>の手順を再度実行してください。</p>

<p><code>spec/routing</code>ディレクトリが見つからないというエラーが表示された場合は、以下のように空のディレクトリを作ることで回避できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mkdir spec/routing
</pre></div>
</div>




<div class="label" id="sec-spork"></div>


<h3><a id="sec-3_6_3" href="#sec-spork" class="heading"><span class="number">3.6.3</span>Spork を使ったテストの高速化</a></h3>


<p><code>bundle exec rspec</code>を実行すると、テストが開始されるまでしばらく時間がかかることにお気付きかもしれません。テストがいったん開始されればすぐに終了します。これは、RSpecを実行するたびにRailsの環境全体を読み込み直す必要があるためです。<a href="http://github.com/sporkrb/spork">Sporkテストサーバー</a><sup class="footnote" id="fnref-3_17"><a href="#fn-3_17">17</a></sup>はこの問題を解決するためのものです。Sporkは環境を<em>1回だけ</em>読み込み、今後実行するテストのためのプロセスを管理します。Sporkは<a class="ref" href="#sec-guard">3.6.2</a>のGuardと組み合わせるとさらに便利です。</p>

<p>最初に、<code>spork</code>に依存するgemを<code>Gemfile</code>に追加します (<a class="ref" href="#code-gemfile_spork">リスト3.35</a>)。</p>

<div class="label" id="code-gemfile_spork"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.35</span> <span class="description">サンプルアプリケーションの<code>Gemfile</code>。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;guard-spork&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;spork&#39;</span><span class="p">,</span> <span class="s1">&#39;0.9.2&#39;</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>次に、<code>bundle install</code>でSporkをインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>次に、Sporkの設定にbootstrapを指定します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork --bootstrap
</pre></div>
</div>


<p>そして、環境の読み込みを一回で済ますため、<code>spec/spec_helper.rb</code>の中で環境を<em>prefork</em>のブロックで読み込むように、RSpecの設定を変更する必要があります (<a class="ref" href="#code-spork_spec_helper">リスト 3.36</a>)。</p>

<div class="label" id="code-spork_spec_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.36</span> <span class="description"><code>Spork.prefork</code>ブロックへの環境読み込みを追加する。</span><br /><span class="description"> <code>spec/spec_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;spork&#39;</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">prefork</span> <span class="k">do</span>
  <span class="c1"># Loading more in this block will cause your tests to run faster. </span><span class="c1">However, </span>
  <span class="c1"># if you change any configuration or code from libraries loaded here, you&#39;ll</span>
  <span class="c1"># need to restart spork for it take effect.</span>
  <span class="c1"># This file is copied to spec/ when you run &#39;rails generate rspec:install&#39;</span>
  <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;RAILS_ENV&quot;</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">&#39;test&#39;</span>
  <span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;..</span><span class="s2">/../config/environment&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
  <span class="nb">require</span> <span class="s1">&#39;rspec/rails&#39;</span>
  <span class="nb">require</span> <span class="s1">&#39;rspec/autorun&#39;</span>

  <span class="c1"># Requires supporting ruby files with custom matchers and macros, etc,</span>
  <span class="c1"># in spec/support/ and its subdirectories.</span>
  <span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;spec/support/**/*.rb&quot;</span><span class="p">)</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">require</span> <span class="n">f</span><span class="p">}</span>

  <span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="c1"># == Mock Framework</span>
    <span class="c1">#</span>
    <span class="c1"># If you prefer to use mocha, flexmock or RR, uncomment the appropriate line:</span>
    <span class="c1">#</span>
    <span class="c1"># config.mock_with :mocha</span>
    <span class="c1"># config.mock_with :flexmock</span>
    <span class="c1"># config.mock_with :rr</span>
    <span class="n">config</span><span class="o">.</span><span class="n">mock_with</span> <span class="ss">:rspec</span>

    <span class="c1"># Remove this line if you&#39;re not using ActiveRecord or ActiveRecord fixtures</span>
    <span class="n">config</span><span class="o">.</span><span class="n">fixture_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="o">::</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/spec/fixtures&quot;</span>

    <span class="c1"># If you&#39;re not using ActiveRecord, or you&#39;d prefer not to run each of your</span>
    <span class="c1"># examples within a transaction, remove the following line or assign false</span>
    <span class="c1"># instead of true.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">use_transactional_fixtures</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># If true, the base class of anonymous controllers will be inferred</span>
    <span class="c1"># automatically. </span><span class="c1">This will be the default behavior in future versions of</span>
    <span class="c1"># rspec-rails.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">infer_base_class_for_anonymous_controllers</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">each_run</span> <span class="k">do</span>
  <span class="c1"># This code will be run each time you run your specs.</span>

<span class="k">end</span>
</pre></div>
</div></div>


<p>Sporkを起動する前に、以下のようにテストスイートを実行して、基準となる実行時間を測定します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">time </span>bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
<span class="go">......</span>

<span class="go">6 examples, 0 failures</span>

<span class="go">real	0m8.633s</span>
<span class="go">user	0m7.240s</span>
<span class="go">sys	0m1.068s</span>
</pre></div>
</div>


<p>上の実行結果では、実際のテストは1/10秒以下で実行されますが、テストスイートは7秒以上かかっています。実行時間のスピートアップのため、別のターミナルウィンドウを開いてアプリケーションののルートディレクトリに移動し、以下のようにSporkサーバーを起動します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork
<span class="go">Using RSpec</span>
<span class="go">Loading Spork.prefork block...</span>
<span class="go">Spork is ready and listening on 8989!</span>
</pre></div>
</div>


<p><code>bundle exec</code>を省略するには、<a class="ref" href="#sec-eliminating_bundle_exec">3.6.1</a>の手順を再度実行してください。別のターミナルウィンドウでは、<tt class="verb">--drb</tt> (“distributed Ruby” の略) オプションを追加してテストスイートを実行すると、環境読み込みのオーバーヘッドが大幅に減少していることが確認できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">time </span>bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb --drb
<span class="go">......</span>

<span class="go">6 examples, 0 failures</span>

<span class="go">real	0m2.649s</span>
<span class="go">user	0m1.259s</span>
<span class="go">sys	0m0.258s</span>
</pre></div>
</div>


<p><code>rspec</code>を実行するたびに<tt class="verb">--drb</tt>オプションを追加するのは不便なので、アプリケーションのルートディレクトリにある<code>.rspec</code>ファイルに<a class="ref" href="#code-rspec_drb">リスト3.37</a>の内容を記載することをお勧めします。</p>

<div class="label" id="code-rspec_drb"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.37</span> <span class="description">自動的にSporkを使うためのRSpecの設定。</span><br /><span class="description"> <code>.rspec</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="o">--</span><span class="n">colour</span>
<span class="o">--</span><span class="n">drb</span>
</pre></div>
</div></div>


<p>Sporkを使う上でひとつ注意があります。preforkで読み込むファイル (たとえば<code>routes.rb</code>) が変更された場合、Sporkサーバーを再起動して新しいRailsの環境を再度読み込む必要があります。パスするはずのテストが失敗した場合は、<tt>Ctrl-C</tt>でSporkサーバーを停止して再起動してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork
<span class="go">Using RSpec</span>
<span class="go">Loading Spork.prefork block...</span>
<span class="go">Spork is ready and listening on 8989!</span>
<span class="go">^C</span>
<span class="gp">$</span> bundle <span class="nb">exec </span>spork
</pre></div>
</div>


<div class="label" id="sec-spork_and_guard"></div>


<h4><a id="sec-3_6_3_1" href="#sec-spork_and_guard" class="heading">GuardにSporkを導入する</a></h4>


<p>SporkはGuardと併用すると非常に便利です。設定を行うと、以下のようにコマンド上で併用することができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard init spork
</pre></div>
</div>


<p>そのためには、<a class="ref" href="#code-spork_guardfile">リスト3.38</a>に示したように<code>Guardfile</code>を変更する必要があります。</p>

<div class="label" id="code-spork_guardfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト3.38</span> <span class="description">Spork向けに<code>Guardfile</code>を更新する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;active_support/core_ext&#39;</span>

<span class="n">guard</span> <span class="s1">&#39;spork&#39;</span><span class="p">,</span> <span class="ss">:rspec_env</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;RAILS_ENV&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;test&#39;</span> <span class="p">}</span> <span class="k">do</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;config/application.rb&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;config/environment.rb&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^config/environments/.</span><span class="sr">+\.rb$}</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="sr">%r{^config/initializers/.</span><span class="sr">+\.rb$}</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;Gemfile&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;Gemfile.lock&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;spec/spec_helper.rb&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;test/test_helper.rb&#39;</span><span class="p">)</span>
  <span class="n">watch</span><span class="p">(</span><span class="s1">&#39;spec/support/&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">guard</span> <span class="s1">&#39;rspec&#39;</span><span class="p">,</span> <span class="ss">:version</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">:all_after_pass</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:cli</span> <span class="o">=&gt;</span> <span class="s1">&#39;--drb&#39;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>guard</code>の変数に<tt class="verb">:cli =&gt; --drb</tt>が追加されました。この設定により、GuardがコマンドラインインタフェースからSporkサーバーを使うようになります。上の設定には、<a class="ref" href="#cha-filling-in-the-layout">第5章</a>から使用する<code>spec/support/</code>ディレクトリを監視するコマンドも追加してあります。</p>

<p>設定が完了したら、以下の<code>guard</code>コマンドでGuardとSporkを同時に起動します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>guard
</pre></div>
</div>


<p>Guardは自動的にSporkサーバーを起動するため、テスト実行時のオーバヘッドを劇的に削減できます。</p>

<p>Guard、Spork、テスト通知機能 (オプション) を使用して便利なテスト環境を構築することで、テスト駆動開発がやみつきになることでしょう。詳細については、<a href="http://railstutorial.org/screencasts">Railsチュートリアルのスクリーンキャスト</a><sup class="footnote" id="fnref-3_18"><a href="#fn-3_18">18</a></sup>を参照してください。</p>

<div class="label" id="sec-tests_inside_sublime_text"></div>


<h3><a id="sec-3_6_4" href="#sec-tests_inside_sublime_text" class="heading"><span class="number">3.6.4</span>Sublime Text上でテストする</a></h3>


<p>Sublime Textを使用していれば、エディタの中から直接テストを実行できる強力なヘルパーコマンドを利用できます。このコマンドを利用するには、<a href="https://github.com/maltize/sublime-text-2-ruby-tests">Sublime Text 2 Ruby Tests</a><sup class="footnote" id="fnref-3_19"><a href="#fn-3_19">19</a></sup>に記載されている、自分の環境向けの説明に従って設定を行なって下さい。著者の環境 (Macintosh OS X) の場合、以下のようにコマンドをインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/Library/Application<span class="se">\ </span>Support/Sublime<span class="se">\ </span>Text<span class="se">\ </span>2/Packages
<span class="gp">$</span> git clone https://github.com/maltize/sublime-text-2-ruby-tests.git RubyTest
</pre></div>
</div>


<p>参考: <a href="https://github.com/mhartl/rails_tutorial_sublime_text">Rails Tutorial Sublime Text</a><sup class="footnote" id="fnref-3_20"><a href="#fn-3_20">20</a></sup>にある説明に従って設定することもできます。</p>

<p>Sublime Textを再起動すると、以下のようなコマンドがRubyTestパッケージによって提供されます。</p>

<ul>
<li><strong>Command-Shift-R</strong>: <code>it</code>ブロック内のテストについては、テストを1回だけ実行します。<code>describe</code>ブロック内のテストについては、一連のテストを実行します。</li>
<li><strong>Command-Shift-E</strong>: 最後に実行したテストを再度実行します。</li>
<li><strong>Command-Shift-T</strong>: 現在のファイルにあるテストをすべて実行します。</li>
</ul>


<p>比較的小さいプロジェクトであってもテストスイートの実行には時間がかかるため、テストを一度に1つだけ実行したり、小規模なテストグループだけを実行したりできるのは大きな長所です。従来のテストでは、たった１つのテストを実行するだけでも、Railsの環境に匹敵するオーバーヘッドが発生してしまいました。このため、上述のテスト用コマンドとSporkの組み合わせは非常に相性が良いのです。Sporkは、テストを実行するたびに発生していたテスト環境起動によるオーバーヘッドを取り除いてくれるため、1つのテストを実行するたびにすべてをテストするのと同程度のオーバーヘッドが発生するようなことがなくなります。個人的には、以下のテスト手順がお勧めです。</p>

<ol>
<li>ターミナルウィンドウでSporkを起動する。</li>
<li>テストを1つ (または小規模なテストグループ) を作成する。</li>
<li>Command-Shift-Rコマンドでテストが失敗することを確認する。</li>
<li>対応するアプリケーションコードを作成する。</li>
<li>Command-Shift-Eコマンドで上のテストと同じテストを実行し、今度は成功することを確認する。</li>
<li>2-5の手順を繰り返す。</li>
<li>中継点 (コミットの直前など) に到達したら、 コマンドラインで<code>rspec spec/</code>を実行してテストスイートをすべて実行し、成功することを確認する。</li>
</ol>


<p>Sublime Textの中からテストが実行できることはもちろん便利ですが、場合によってはGuardの方が便利なこともあると思います。上の手順は、著者が個人的に常用しているテスト駆動開発のテクニックとしてご紹介しました。</p>

<div class="footnotes">
<ol>
<li id="fn-3_1">Capybaraは<em>Webrat</em>の後続プロジェクトであり、世界<a href="http://en.wikipedia.org/wiki/Capybara">最大の齧歯類</a>が名前の由来です。<a class="arrow" href="#fnref-3_1">↑</a></li>
<li id="fn-3_2">なお、<code>install</code>は省略可能です。実は、<code>bundle</code>コマンドは<code>bundle install</code>のエイリアスでもあります。<a class="arrow" href="#fnref-3_2">↑</a></li>
<li id="fn-3_3">システムによっては、<a class="ref" href="#code-gitignore">リスト1.7</a>の.gitignoreを参考にして、さらに便利な設定にすることもできます。<a class="arrow" href="#fnref-3_3">↑</a></li>
<li id="fn-3_4">https://github.com/railstutorial/sample_app_2nd_ed <a class="arrow" href="#fnref-3_4">↑</a></li>
<li id="fn-3_5">実は、これらのファイルに対するリクエストはRails内のスタックに決して到達しないようになっています。そのようなファイルへのリクエストは、ファイルシステムに直接渡されます (詳細については「<a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails 3 Way</em></a>」を参照してください)。<a class="arrow" href="#fnref-3_5">↑</a></li>
<li id="fn-3_6">いつもと同じように、<code>subl</code> コマンドを、使用しているテキストエディタを呼び出すコマンド (vim, emacsなど) に置き換えてください。<a class="arrow" href="#fnref-3_6">↑</a></li>
<li id="fn-3_7">HTMLは常に変化しています。doctypeを明示的に宣言することで、今後もブラウザが正しくページを描画してくれる可能性が高まります。きわめてシンプルなdoctype宣言である<code>&lt;!DOCTYPE html&gt;</code>は、最新の標準HTML (HTML5) であることを示しています。<a class="arrow" href="#fnref-3_7">↑</a></li>
<li id="fn-3_8">ここで静的なページを作るために採用した方法は、おそらく最もシンプルな方法です。ただし他にも方法はあります。最適な方法は状況によって異なり、たとえば<em>きわめて多数</em>の静的なページを1つのStaticPagesコントローラだけまかなおうとすると重荷になる可能性があります。今回はいくつかの静的なページを作るだけなので、重荷にはなりません。Railsで静的なページを作成するテクニックの詳細については、ブログ<a href="http://blog.hasmanythrough.com/2008/4/2/simple-pages">has_many :throughの「<tt>simple pages</tt>」という記事</a>を参照してください。<em>警告:</em> この記事の内容はかなり高度なので、もっと後になって読む方がよいかもしれません。<a class="arrow" href="#fnref-3_8">↑</a></li>
<li id="fn-3_9">毎回<code>bundle exec</code>を追加するのは面倒ですが、<a class="ref" href="#sec-advanced_setup">3.6</a>のオプションを使うと省略できます。<a class="arrow" href="#fnref-3_9">↑</a></li>
<li id="fn-3_10">筆者は普段、ターミナルやテキストエディタの背景は黒色にしていますが、明るい色の背景の方がスクリーンショットの見栄えが良いので、(一時的に) 明るい背景を使用しています。<a class="arrow" href="#fnref-3_10">↑</a></li>
<li id="fn-3_11">改行は、行の末尾と次の行の始まりを示します。コードの中では、<tt class="verb">\n</tt>の文字列で表します。<a class="arrow" href="#fnref-3_11">↑</a></li>
<li id="fn-3_12">もちろん、人間がいちいち文字数を<em>数えて</em>いたら頭がどうにかなってしまいます。だからこそ、多くのテキストエディタにはこれらを支援する機能が備わっています。たとえば、<a class="ref" href="#fig-editor_shell">図1.1</a>をもう一度見てみると、コードを80文字以下に抑えるための小さな縦線が右側に見えます (実際には少し余裕を持たせて78列にしてあります) 。TextMateを使用していれば、<tt>View &gt; Wrap Column &gt; 78</tt>で設定できます。Sublime Textを使用していれば、<tt>View &gt; Ruler &gt; 78</tt>、または<tt>View &gt; Ruler &gt; 80</tt>で設定できます。<a class="arrow" href="#fnref-3_12">↑</a></li>
<li id="fn-3_13">2番目によく使われている<a href="http://haml-lang.com/">Haml</a>というテンプレートシステムもあります。Hamlは個人的に非常に気に入っているのですが、初心者向けのチュートリアルで使うには<em>やや</em>標準から外れています。<a class="arrow" href="#fnref-3_13">↑</a></li>
<li id="fn-3_14">Railsでの開発経験者であれば、この時点で<code>content_for</code>の使用を検討すると思いますが、残念ながらアセットパイプラインと併用すると正常に動作しないことがあります。<code>provide</code>関数はcontent_forの代替です。<a class="arrow" href="#fnref-3_14">↑</a></li>
<li id="fn-3_15">Rubyを勉強したことのある方であれば、Railsはブロックの内容を<em>yield</em>していると推測することでしょう。そして、その推測はおそらく正しいでしょう。しかし、Rails開発のためにこれらの詳細を知る必要はありません。<a class="arrow" href="#fnref-3_15">↑</a></li>
<li id="fn-3_16">http://rvm.io/integration/bundler/ <a class="arrow" href="#fnref-3_16">↑</a></li>
<li id="fn-3_17"><em>spork</em>はspoon-forkを組み合わせた造語です。このプロジェクト名は、<a href="http://en.wikipedia.org/wiki/POSIX">POSIX</a>の<a href="http://en.wikipedia.org/wiki/Fork_(software_development)">fork</a>におけるSporkの用法をもじったものです。<a class="arrow" href="#fnref-3_17">↑</a></li>
<li id="fn-3_18">http://railstutorial.org/screencasts <a class="arrow" href="#fnref-3_18">↑</a></li>
<li id="fn-3_19">https://github.com/maltize/sublime-text-2-ruby-tests <a class="arrow" href="#fnref-3_19">↑</a></li>
<li id="fn-3_20">https://github.com/mhartl/rails_tutorial_sublime_text <a class="arrow" href="#fnref-3_20">↑</a></li>
</ol>
</div>




<div class="label" id="cha-rails-flavored-ruby"></div>


<h1 class="chapter"><a id="sec-4" href="#cha-rails-flavored-ruby" class="heading"><span class="number">第4章</span>Rails風味のRuby</a></h1>


<p><a class="ref" href="#cha-static-pages">3章</a> で使用した例に基いて、この章ではRailsにおいて重要となるRubyのさまざまな要素について探っていくことにしましょう。Rubyは巨大な仕様を持つ言語ですが、幸い、Rails開発者にとって必要な知識は比較的少なくて済みます。さらに、Railsのために必要なRubyの知識は、通常のRubyを学ぶ過程とは<em>異なります</em>。動的なWebアプリを作ることができればそれでよいというのであれば、まずRailsを学ぶようにし、Rubyについては当分の間、必要が生じた場合にのみ学習することをお勧めします。そうではなく、真のRails<em>エキスパート</em>になりたいのであれば、Rubyをさらに深いレベルまで理解する必要があります。本書は、そのための開発技術の基礎を築く助けになるでしょう。<a class="ref" href="#sec-comments_for_various_readers">1.1.1</a>で示したように、<em>Railsチュートリアル</em> を終えた後には <a href="http://www.amazon.com/gp/product/1430223634"><em>Beginning Ruby</em></a>、<a href="http://www.amazon.com/gp/product/1933988657"><em>The Well-Grounded Rubyist</em></a>、<a href="http://www.amazon.com/gp/product/0672328844"><em>The Ruby Way</em></a> などの純粋なRubyについての本を読むことをお勧めします。</p>

<p>この章には多くの話題が盛り込まれていますが、一度読んだだけで理解する必要はまったくありません。今後もこの章には頻繁に立ち戻って参照します。</p>

<div class="label" id="sec-motivation"></div>


<h2><a id="sec-4_1" href="#sec-motivation" class="heading"><span class="number">4.1</span>動機</a></h2>


<p>前章でお見せしたとおり、Rubyの基礎知識がまったくない状態であったにもかかわらずRailsアプリケーションの骨組みを作り上げ、さらにテストまで行うことができました。このときは、本書が提供するテストコードと、テストスイートがパスするまでエラーメッセージの修正を繰り返すという方法だけを頼りに作業を進めました。しかしこのような初歩的な作業をいつまでも続けるわけにはいきませんので、今の私たちのRubyに関する知識と経験の限界に真正面から挑み、これを乗り越えるためにこの章を割り当てることにします。</p>

<p>前章の終わりでは、Railsのレイアウトを使用してビューでの重複を取り除くために、ほぼ静的なページを単に更新したにとどまりました (<a class="ref" href="#code-application_layout_redux">リスト4.1</a>)。</p>

<div class="label" id="code-application_layout_redux"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.1</span> <span class="description">サンプルアプリケーションのWebサイトのレイアウト。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-application_layout_redux">リスト4.1</a>の以下の行にご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>ここでは、Railsの組み込み関数<code>stylesheet_link_tag</code> (詳細は<a href="http://api.rubyonrails.org/v3.2.0/classes/ActionView/Helpers/AssetTagHelper/StylesheetTagHelpers.html#method-i-stylesheet_link_tag">Rails API</a>を参照) を使用して、<code>application.css</code>をすべての<a href="http://www.w3.org/TR/CSS2/media.html">メディアタイプ</a>にインクルードしています (メディアタイプには、コンピュータの画面や印刷画面なども含まれます)。Rails開発経験者にとってこの行は実にシンプルですが、しかしここには少なくとも混乱を生じる可能性のあるRubyの概念が4つあります。Railsの組み込み関数、かっこを使わない関数呼び出し、シンボル、そしてハッシュです。これらの概念についてはこの章ですべて説明します。</p>

<p>Railsのビューでは膨大な組み込み関数を使用することができますが、それに加えて新しい関数を作成することもできます。この関数は<em>ヘルパー</em>と呼ばれます。カスタムヘルパーを作成する方法を学ぶために、まず<a class="ref" href="#code-application_layout_redux">リスト4.1</a>のタイトル行の部分に注目しましょう。</p>

<div class="code"><div class="highlight"><pre>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>上の行は、ページタイトルの定義に依存しています。この定義は、以下のようにビューで<code>provide</code>を使用して行われています。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Home&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>


<p>このとき、もしタイトルをまったく与えていなければ、タイトルが空欄になってしまいます。これを防ぐには、すべてのページで使用する<em>基本タイトル</em>を定め、特定のページでは異なるタイトルに変更できるようなオプションを与えるのが常套手段です。これは現在のレイアウトでも、<em>ある点を除いて</em>達成されています。もしビューの1つから<code>provide</code>呼び出しを削除すると、そのページ固有のタイトルの代わりに以下のタイトルが表示されます。</p>

<div class="code"><div class="highlight"><pre>Ruby on Rails Tutorial Sample App | 
</pre></div>
</div>


<p>基本タイトルとしてはこれで正しいのですが、末尾に余分な縦棒<code>|</code>が残ってしまっています。</p>

<p>ページタイトルが正しく表示されない問題を解決するために、 <code>full_title</code>というヘルパーを作成することにします。<code>full_title</code>ヘルパーは、ページタイトルが定義されていない場合は基本タイトル “Ruby on Rails Tutorial Sample App”を返し、定義されている場合は基本タイトルに縦棒と追加ページタイトルを追加して返します (<a class="ref" href="#code-title_helper">リスト4.2</a>)<sup class="footnote" id="fnref-4_1"><a href="#fn-4_1">1</a></sup>。</p>

<div class="label" id="code-title_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.2</span> <span class="description"><code>full_title</code>ヘルパーを定義する。</span><br /><span class="description"> <code>app/helpers/application_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># ページごとの完全なタイトルを返します。</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">base_title</span>
    <span class="k">else</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ヘルパーを作成したので、これを使用してレイアウトをシンプルにすることができます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>上の行を以下で置き換えます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>置き換えの結果を<a class="ref" href="#code-application_layout_full_title">リスト4.3</a>に示します。</p>

<div class="label" id="code-application_layout_full_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.3</span> <span class="description">サンプルアプリケーションのWebサイトのレイアウト。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>このヘルパーを定義することで、Homeページにこれまで表示されていた余分な &quot;Home&quot; という単語を表示せず、基本タイトルのみを正しく表示することもできるようになります。これを行うには、まず<a class="ref" href="#code-home_base_title_spec">リスト4.4</a>に示すように以前のテストコードを更新し、<code>&#39;Home&#39;</code>の文字が表示されていないことを確認するテストを追加します。</p>

<div class="label" id="code-home_base_title_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.4</span> <span class="description">Homeページのタイトル確認用にテストを更新する。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the base title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not have a custom page title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/home&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;| Home&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここで、現在のテストを変更せずに新しいテストを追加した理由を考えてみてください (<em>ヒント</em>: 答えは<a class="ref" href="#sec-testing_a_title_change">3.3.1</a>にあります)。</p>

<p>ここでテストスイートを実行して、テストが失敗することを確認します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>テストがパスするためには、<a class="ref" href="#code-home_page_base_title">リスト4.5</a>のようにHomeページのビューから<code>provide</code>の行を削除する必要があります。</p>

<div class="label" id="code-home_page_base_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.5</span> <span class="description">ページタイトルをカスタマイズせずに表示するHomeページ。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>これでテストにパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>Rails開発経験者にとっては、<a class="ref" href="#code-title_helper">リスト4.2</a>のコードはスタイルシートをインクルードするのと大差ない単純なものですが、ここにもRuby未経験者を混乱させる可能性のある概念が<em>多数</em>含まれています。モジュール、コメント、ローカル変数割り当て、論理値 (boolean)、制御フロー、文字列の挿入、戻り値です。これらの概念についても、この章ですべて説明します。</p>

<div class="label" id="sec-strings_and_methods"></div>


<h2><a id="sec-4_2" href="#sec-strings_and_methods" class="heading"><span class="number">4.2</span>文字列(string)とメソッド</a></h2>


<p>Ruby を学ぶためのツールとして、主に<em>Railsコンソール</em>を使用することにします。これは<a class="ref" href="#sec-demo_user_has_many_microposts">2.3.3</a> でも登場した、Railアプリケーションを対話的に操作するためのコマンドラインツールです。コンソールはインタラクティブRuby(<code>irb</code>) 上に構築されているため、Rubyの機能をすべて使うことができます (<a class="ref" href="#sec-a_controller_class">4.4.4</a>でも説明しますが、コンソールからRails環境にアクセスすることもできます)。以下のコマンドをコマンドラインで実行し、Railsコンソールを起動しましょう。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="go">Loading development environment</span>
<span class="gp">&gt;&gt;</span>
</pre></div>
</div>


<p>デフォルトでは、コンソールは<em>開発 (development) 環境</em>という、Railsによって定義された3種類の環境のうちの1つで起動します (他の2つは<em>テスト環境</em>と<em>本番 (production) 環境</em>です)。この区別はこの章においては重要ではありませんが、<a class="ref" href="#sec-rails_environments">7.1.1</a>でこれらの環境について詳細に説明します。</p>

<p>Railsコンソールは素晴しい学習ツールであり、その中を自由に探索できます。コンソールの中で何をしようとも、何かを壊すことは (まず) ありえないので、ご安心ください。Railsコンソールでは、スタックから抜けるにはCtrl-C を押し、完全にコンソールを終了するにはCtrl-Dを押します。以後この章を進めるにあたり、有用なリソースである<a href="http://ruby-doc.org/core-1.9.3/">Ruby API</a>を参照しながら学習することをぜひお勧めします。Ruby APIには高濃縮の情報が詰まっています (少々濃厚<em>すぎる</em>とも言えます)。たとえば、Rubyの文字列の詳細を知りたい場合は、Ruby APIエントリの<code>String</code>クラスを参照すればよいのです。</p>

<div class="label" id="sec-comments"></div>


<h3><a id="sec-4_2_1" href="#sec-comments" class="heading"><span class="number">4.2.1</span>コメント</a></h3>


<p>Rubyの<em>コメント</em> はナンバー記号<code>#</code> (&quot;ハッシュマーク&quot;や、&quot;オクトソープ&quot;とも呼ばれます) から始まり、行の終わりまでコメントとして扱われます。Rubyはコメントの内容を実行することはありませんが、適切なコメントはそれを読む人間にとって (コードの作者にとっても) 非常に有用です。以下のコードの場合、</p>

<div class="code"><div class="highlight"><pre>  <span class="c1"># ページごとの完全なタイトルを返します。</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>最初の行が、その後に定義されている関数の目的を説明しているコメントです。</p>

<p>コンソール内ではコメントを使わないのが普通ですが、ここでは学習のためにあえて以下のようにコメントを追加してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="mi">17</span> <span class="o">+</span> <span class="mi">42</span>   <span class="c1"># 整数の加算</span>
<span class="go">=&gt; 59</span>
</pre></div>
</div>


<p>この章のコードを (ファイルに保存するのでなく) Railsコンソールに入力したりコピペしたりするときであれば、コメントを省略してもかまいません。コメントをRailsにコンソールに入力しても、コメントは常に無視されるので問題ありません。</p>

<div class="label" id="sec-strings"></div>


<h3><a id="sec-4_2_2" href="#sec-strings" class="heading"><span class="number">4.2.2</span>文字列</a></h3>


<p><em>文字列 (string)</em>は、おそらくどのWeb アプリケーションにおいても最も重要なデータ構造です。これは、Web ページというものが究極的にはサーバからブラウザに送信された文字列にすぎないためです。それでは、コンソールで文字列について調べてみましょう。今回は<code>rails console</code>の代わりに、短縮版の<code>rails c</code>でコンソールを起動します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails c</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span>         <span class="c1"># 空の文字列</span>
<span class="go">=&gt; &quot;&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foo&quot;</span>      <span class="c1"># 空でない文字列</span>
<span class="go">=&gt; &quot;foo&quot;</span>
</pre></div>
</div>


<p>ここで入力したものは<em>文字列リテラル</em>と呼ばれ (面白いことに<em>リテラル文字列</em>とも呼ばれます)、ダブルクォート<code>&quot;</code> で囲むことで作成できます。このコンソールは、入力したそれぞれの行を評価した結果を表示しており、文字列リテラルの場合には文字列自身が表示されます。</p>

<p><code>+</code> 演算子を使用して、文字列を結合することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foo&quot;</span> <span class="o">+</span> <span class="s2">&quot;bar&quot;</span>    <span class="c1"># 文字列の結合</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
</pre></div>
</div>


<p>評価の結果は、<code>&quot;foo&quot;</code> と <code>&quot;bar&quot;</code> を足した<code>&quot;foobar&quot;</code>になりました<sup class="footnote" id="fnref-4_2"><a href="#fn-4_2">2</a></sup>。</p>

<p>文字列を組み立てる他の方法として<em>補間子による式展開 (interpolation)</em>というものがあり、<code>#{}</code>という特殊な構文を使用します<sup class="footnote" id="fnref-4_3"><a href="#fn-4_3">3</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">&quot;Michael&quot;</span>    <span class="c1">#変数割り当て</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> Hartl&quot;</span>     <span class="c1"># 文字列の補間</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
</pre></div>
</div>


<p>ここでは、<code>&quot;Michael&quot;</code> という値を<code>first_name</code>変数に<em>割り当て</em>、この変数が <code>&quot;#{first_name} Hartl&quot;</code> という文字列の中で式展開されます。苗字と名前の両方を変数に割り当てることもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">=</span> <span class="s2">&quot;Michael&quot;</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">last_name</span> <span class="o">=</span> <span class="s2">&quot;Hartl&quot;</span>
<span class="go">=&gt; &quot;Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">first_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">last_name</span>    <span class="c1"># スペースをはさんで結合する</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>    <span class="c1"># 上と同等の補間</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
</pre></div>
</div>


<p>最後の2つの結果は同等であることにご注目ください。なお、私は後者の補間子による式展開が好みです。空白を<code>&quot; &quot;</code>という形式で加えるのはぎこちなく思えます。</p>

<div class="label" id="sec-printing"></div>


<h4><a id="sec-4_2_2_1" href="#sec-printing" class="heading">出力</a></h4>


<p>文字列を<em>出力</em>するために、Rubyの関数で最も一般に使われるのは<code>puts</code>です (putの三人称単数現在形ではなく “put string”なので、“put ess” と発音します)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;foo&quot;</span>     <span class="c1"># put string</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p><code>puts</code> メソッドは<em>副作用</em>として動作します。<code>puts &quot;foo&quot;</code>は文字列をスクリーンに表示し、文字どおり「無を返します」(正確には<a href="http://www.answers.com/nil">nilというリテラル</a>を返します。<code>nil</code> は &quot;まったく無い&quot;ことを表すRubyの特別な値です)。(<code>=&gt; nil</code> という結果は、今後簡素化のために省略することがあります。)</p>

<p><code>puts</code>を使用して出力すると、改行文字である<tt class="verb">\n</tt>が自動的に出力の末尾に追加されます。<code>print</code>メソッドも同様の出力を行いますが、以下のように、改行文字を追加しない点が異なります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">&quot;foo&quot;</span>    <span class="c1"># 文字列の出力 (putsと同じだが改行しない)</span>
<span class="go">foo=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">print</span> <span class="s2">&quot;foo</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># puts &quot;foo&quot; と同等</span>
<span class="go">foo</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>




<div class="label" id="sec-single_quoted_strings"></div>


<h4><a id="sec-4_2_2_2" href="#sec-single_quoted_strings" class="heading">シングルクォート内の文字列</a></h4>


<p>これまでの例ではすべて<em>ダブルクォート文字列</em>を使用していましたが、Rubyでは<em>シングルクォート</em>もサポートしています。ほとんどの場合、ダブルクォートとシングルクォートのどちらを使用しても実質的に同じです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;foo&#39;</span>          <span class="c1"># シングルクォートで囲んだ文字列</span>
<span class="go">=&gt; &quot;foo&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s1">&#39;foo&#39;</span> <span class="o">+</span> <span class="s1">&#39;bar&#39;</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
</pre></div>
</div>


<p>ただし、1つ重要な違いがあります。Rubyはシングルクォート文字列の中では補間子の式展開を行いません。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;#{foo} bar&#39;</span>     <span class="c1"># シングルクォートで囲まれた文字列では式展開されない</span>
<span class="go">=&gt; &quot;\#{foo} bar&quot;</span>
</pre></div>
</div>


<p>逆に言えば、ダブルクォート文字列を用いた文字列で<code>#</code>のような特殊な文字を使用する場合は、この文字をバックスラッシュで<em>エスケープ</em>する必要があります。</p>

<p>ダブルクォート文字列でもシングルクォート文字列と同じことができ、ダブルクォート文字列では式展開もできるのであれば、シングルクォート文字列にはどのような使い道があるのでしょうか。シングルクォートは、入力した文字をエスケープせずに「そのまま」保持するときに便利です。たとえば、いわゆる “バックスラッシュ” 文字は、改行文字<tt class="verb">\n</tt>と同様多くのシステム上で特殊な文字として扱われます。シングルクオートで文字列を囲めば、簡単にバックスラッシュ文字のような特殊文字をそのまま変数に含めることができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;\n&#39;</span>       <span class="c1"># バックスラッシュ n&#39; をそのまま扱う</span>
<span class="go">=&gt; &quot;\\n&quot;</span>
</pre></div>
</div>


<p>以前の例で扱った<code>#</code>文字と同様、Rubyではバックスラッシュをエスケープするためにバックスラッシュがもう1つ必要です。ダブルクォート文字列の中では、バックスラッシュ文字そのものは<em>2つ</em>のバックスラッシュによって表されます。このようなささいな例の場合はそれほど問題になりませんが、以下のようにエスケープの必要な文字が大量にある場合には、シングルクォートは非常に便利です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s1">&#39;Newlines (\n) and tabs (\t) both use the backslash character \.&#39;</span>
<span class="go">=&gt; &quot;Newlines (\\n) and tabs (\\t) both use the backslash character \\.&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-objects_and_message_passing"></div>


<h3><a id="sec-4_2_3" href="#sec-objects_and_message_passing" class="heading"><span class="number">4.2.3</span>オブジェクトとメッセージ受け渡し</a></h3>


<p>Rubyでは、あらゆるものが<em>オブジェクト</em>です。文字列や<code>nil</code>ですらオブジェクトです。このことの技術的な意味は<a class="ref" href="#sec-a_class_of_our_own">4.4.2</a>で説明しますが、オブジェクトについてのこのような定義は、本で読んだだけではわかりません。さまざまなオブジェクトの例に触れることで、オブジェクトとは何であるかという直感を時間をかけて養う必要があります。</p>

<p>逆に、オブジェクトが何を<em>する</em>かを説明するのは簡単です。オブジェクトとは (いついかなる場合にも) メッセージに応答するものです。文字列のようなオブジェクトは、たとえば <code>length</code>というメッセージに応答できますが、これは文字列の文字数を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">length</span>        <span class="c1"># 文字列に &quot;length&quot; というメッセージを渡す</span>
<span class="go">=&gt; 6</span>
</pre></div>
</div>


<p>オブジェクトに渡されるメッセージは、一般には<em>メソッド</em>と呼ばれます。メソッドの実体は、そのオブジェクトに定義された関数です<sup class="footnote" id="fnref-4_4"><a href="#fn-4_4">4</a></sup>。Rubyの文字列は、以下のように<code>empty?</code>メソッドにも応答することができます。 </p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p><code>empty?</code>メソッドの末尾にある疑問符にご注目ください。 これは Rubyの慣習で、<code>true</code> もしくは <code>false</code>という<em>論理値 (boolean)</em>を返すことを示します。論理値は特に<em>制御フロー</em>において有用です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">&quot;The string is empty&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="s2">&quot;The string is nonempty&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; &quot;The string is nonempty&quot;</span>
</pre></div>
</div>


<p>論理値は、<code>&amp;&amp;</code> (“and”)、<code>||</code> (“or”)、そして<code>!</code> (&quot;not&quot;) 演算子によって結合することもできます。 </p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>
<span class="go">=&gt; &quot;foo&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="go">=&gt; &quot;&quot;</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;Both strings are empty&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;One of the strings is empty&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="n">y</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">&quot;One of the strings is empty&quot;</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;x is not empty&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">&quot;x is not empty&quot;</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>Rubyでは、あらゆるものがオブジェクトです。従って、<code>nil</code>もオブジェクトであり、これも多くのメソッドに応答できます。ほぼすべてのオブジェクトを文字列に変換する<code>to_s</code>メソッドを使用して、nilがメソッドに応答する例をお目にかけましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span>
<span class="go">=&gt; &quot;&quot;</span>
</pre></div>
</div>


<p>確かに空文字列が出力されました。今度は<code>nil</code> に対してメッセージを<em>連鎖 (chain)</em>して渡せることを確認します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">NoMethodError: You have a nil object when you didn&#39;t expect it!</span>
<span class="go">You might have expected an instance of Array.</span>
<span class="go">The error occurred while evaluating nil.empty?</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">empty?</span>      <span class="c1"># メッセージの連鎖</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>上に示したように、<code>nil</code> オブジェクトは<code>empty?</code> メソッドに応答しませんが、<code>nil.to_s</code>には応答します。</p>

<p>ご推察のとおり、<code>nil</code>かどうかを調べるメソッドもあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foo&quot;</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">nil?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>ところで、以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="nb">puts</span> <span class="s2">&quot;x is not empty&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="n">empty?</span>
</pre></div>
</div>


<p><code>if</code>キーワードの別の使い方を示しています。Rubyではこのように、<code>if</code> での条件式が真のときにだけ実行される式を書くことができ、コードが非常に簡潔になります。なお、<code>unless</code> キーワードも同様に使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;The string &#39;</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">&#39; is nonempty.&quot;</span> <span class="k">unless</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">The string &#39;foobar&#39; is nonempty.</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>Rubyにおいて<code>nil</code>は特別なオブジェクトです。Rubyのオブジェクトのうち、オブジェクトそのものの論理値がfalseになるのは、(<code>false</code>というオブジェクト自身を除いて) nil<em>だけ</em>です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="kp">nil</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">true</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">false</span>        <span class="c1"># nilはfalse</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>その他のあらゆるRuby のオブジェクトは、ゼロですら<em>true</em>です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">if</span> <span class="mi">0</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">true</span>        <span class="c1"># 0 (を含むあらゆるオブジェクト、nilとfalseは除く) はtrue</span>
<span class="gp">&gt;&gt; </span><span class="k">else</span>
<span class="gp">&gt;&gt; </span>  <span class="kp">false</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<div class="label" id="sec-method_definitions"></div>


<h3><a id="sec-4_2_4" href="#sec-method_definitions" class="heading"><span class="number">4.2.4</span>メソッドの定義</a></h3>


<p>Railsコンソールでも、<a class="ref" href="#code-static_pages_controller">リスト3.6</a>の<code>home</code>アクションや、<a class="ref" href="#code-title_helper">リスト4.2</a>の<code>full_title</code>ヘルパーと同じ方法でメソッドを定義することができます (メソッドの定義はファイルで行うのが普通なので、コンソールで行うのは少々面倒ですが、デモンストーレション目的であれば十分です)。たとえば、<code>string_message</code>という<em>引数</em>を1つ取り、引数が空かどうかに基づいたメッセージを返す関数を定義してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">&quot;It&#39;s an empty string!&quot;</span>
<span class="gp">&gt;&gt; </span>  <span class="k">else</span>
<span class="gp">&gt;&gt; </span>    <span class="s2">&quot;The string is nonempty.&quot;</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="go">It&#39;s an empty string!</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="n">string_message</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">The string is nonempty.</span>
</pre></div>
</div>


<p>ここで、Rubyの関数は <em>暗黙的戻り値</em>を持つということに注意してください。これは最後の式の評価値が返されることを意味します。この場合、引数の<code>string</code>が空かどうかに基づいた2つのメッセージ文字列のうちのいずれかが返されます。Rubyでは、戻り値を明示的に指定することもできます。以下の関数は上の関数と同じ結果を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_message</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">&quot;It&#39;s an empty string!&quot;</span> <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">empty?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">return</span> <span class="s2">&quot;The string is nonempty.&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
</pre></div>
</div>


<p>お気付きの方もいると思いますが、2番目の<code>return</code> は実はなくてもかまいません。関数中の最後の表現 <code>&quot;The string is nonempty.&quot;</code> は、<code>return</code>キーワードがあってもなくても値を返すためです。ここでは、両方に<code>return</code>を使用する方が見た目の対称性が保たれるので好ましいと言えます。</p>

<div class="label" id="sec-back_to_the_title_helper"></div>


<h3><a id="sec-4_2_5" href="#sec-back_to_the_title_helper" class="heading"><span class="number">4.2.5</span> title ヘルパー、再び</a></h3>


<p>ここまででRubyの知識がある程度身についたので<sup class="footnote" id="fnref-4_5"><a href="#fn-4_5">5</a></sup>、<a class="ref" href="#code-title_helper">4.2</a>の<code>full_title</code>ヘルパーを理解できるようになったはずです。</p>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="c1"># ページごとの完全なタイトルを返します。</span><span class="c1"># コメント行</span>
  <span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>                          <span class="c1"># メソッド定義</span>
    <span class="n">base_title</span> <span class="o">=</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span>  <span class="c1"># 変数に値を割り当てる</span>
    <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>                              <span class="c1"># 論理値テスト</span>
      <span class="n">base_title</span>                                      <span class="c1"># 暗黙の返り値</span>
    <span class="k">else</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">&quot;</span>                 <span class="c1"># 文字列の式展開</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Webサイトのレイアウトで使用するコンパクトなヘルパーメソッドは、関数定義、変数割り当て、論理評価、制御フロー、そして文字列の式展開などのRubyの要素が一体となってできあがっています。最後に<code>module ApplicationHelper</code>という要素について解説します。このモジュールは、関連したメソッドをまとめる方法の1つで、Rubyのクラスに<code>include</code>を使うことで<em>ミックスイン (mixed in)</em>することができます。通常のRubyを書くときには、モジュールを書いてはこれを明示的にインクルードするという作業を頻繁に行いますが、このヘルパーモジュールの場合はRailsが自動的にインクルードしてくれます。つまり、この<code>full_title</code>メソッドは<a href="http://catb.org/jargon/html/A/automagically.html">自動的に</a>すべてのビューで利用できます。</p>

<div class="label" id="sec-other_data_structures"></div>


<h2><a id="sec-4_3" href="#sec-other_data_structures" class="heading"><span class="number">4.3</span>他のデータ構造</a></h2>


<p>Webアプリケーションは突き詰めればただの文字列に過ぎませんが、実際にはこれらの文字列を<em>作る</em>ために文字列以外のデータ構造も必要となります。この節では、Railsアプリケーションを書くために重要となる、いくつかのRubyのデータ構造について説明します。</p>

<div class="label" id="sec-arrays_and_ranges"></div>


<h3><a id="sec-4_3_1" href="#sec-arrays_and_ranges" class="heading"><span class="number">4.3.1</span>配列と範囲演算子</a></h3>


<p>配列 (array) は、特定の順序を持つ要素のリストです。本書<em>Railsチュートリアル</em>ではこれまで配列について解説していませんでしたが、配列を理解することは、ハッシュ (<a class="ref" href="#sec-hashes_and_symbols">4.3.3</a>) やRailsのデータモデルを理解するための重要な基盤となります (データモデルとは<code>has_many</code>などの関連付けのことであり、<a class="ref" href="#sec-demo_user_has_many_microposts">2.3.3</a>や<a class="ref" href="#sec-user_micropost_associations">10.1.3</a>で詳細を説明します)。</p>

<p>Rubyの文字列の理解にだいぶ時間を使ってしまいましたので、次に進むことにします。文字列から配列を得る自然な方法の1つとして、以下の<code>split</code>メソッドがあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span> <span class="s2">&quot;foo bar     baz&quot;</span><span class="o">.</span><span class="n">split</span>     <span class="c1"># 文字列を3つの要素を持つ配列に分割する</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
</pre></div>
</div>


<p>この操作によって、3つの文字列からなる配列が得られます。デフォルトでは、<code>split</code>は文字列を空白で区切って配列にしますが、以下のように他の文字を指定して区切ることもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;fooxbarxbazx&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
</pre></div>
</div>


<p>多くのコンピュータ言語の慣習と同様、 Rubyの配列も<em>ゼロオフセット</em>を採用しています。これは、配列の最初の要素のインデックスは0、2番目は1...と続くことを意味します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">17</span><span class="o">]</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>               <span class="c1"># 配列へのアクセスには [ ] を使用する</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>              <span class="c1"># 負の値を持つインデックスも使用できる</span>
<span class="go">=&gt; 17</span>
</pre></div>
</div>


<p>上で示したとおり、配列の要素にアクセスするには角かっこを使用します。Rubyでは、角かっこによるアクセス方法以外にも配列の要素にアクセスする方法が提供されています<sup class="footnote" id="fnref-4_6"><a href="#fn-4_6">6</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>                  <span class="c1"># &#39;a&#39; の内容にご注目</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; 42</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">second</span>
<span class="go">=&gt; 8</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span>
<span class="go">=&gt; 17</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="n">a</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span>    <span class="c1"># ==演算子による比較</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>最後の行では、等しいことを確認する比較演算子<code>==</code>を使ってみました。この演算子や <code>!=</code> (“等しくない”) などの演算子は、他の多くの言語と共通です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">length</span>       <span class="c1"># 配列も文字列と同様 &#39;length&#39; メソッドに応答する</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">3</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">!</span><span class="o">=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>配列は、上記コードの最初の行の<code>length</code>メソッド以外にも、さまざまなメソッドに応答します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; [17, 8, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">shuffle</span>
<span class="go">=&gt; [17, 42, 8]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
</pre></div>
</div>


<p>上のどのメソッドを実行した場合にも、<code>a</code>自身は変更されていないという点にご注目ください。配列の内容を<em>変更</em>したい場合は、そのメソッドに対応する “破壊的” メソッドを使用します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">sort!</span>
<span class="go">=&gt; [8, 17, 42]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [8, 17, 42]</span>
</pre></div>
</div>


<p>また、<code>push</code>メソッド (または同等の<tt class="verb">&lt;&lt;</tt>演算子) を使用して配列に追加することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>                  <span class="c1"># 配列に6を追加</span>
<span class="go">=&gt; [42, 8, 17, 6]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>                     <span class="c1"># 配列に7を追加</span>
<span class="go">=&gt; [42, 8, 17, 6, 7]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;foo&quot;</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;bar&quot;</span>        <span class="c1"># 配列に連続プッシュ</span>
<span class="go">=&gt; [42, 8, 17, 6, 7, &quot;foo&quot;, &quot;bar&quot;]</span>
</pre></div>
</div>


<p>最後の例では、要素の追加を連鎖 (chain) できることを示しました。また、Rubyの配列は、他の多くの言語の配列とは異なり、さまざまな型を共存させることができます (この場合は整数と文字列)。</p>

<p>文字列を配列に変換するのに<code>split</code>を使用しました。<code>join</code>メソッドはこれと逆の動作です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [42, 8, 17, 7, &quot;foo&quot;, &quot;bar&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span>                       <span class="c1"># 区切り文字なしで連結</span>
<span class="go">=&gt; &quot;428177foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>                 <span class="c1"># カンマとスペースで区切って連結</span>
<span class="go">=&gt; &quot;42, 8, 17, 7, foo, bar&quot;</span>
</pre></div>
</div>


<p><em>範囲 (range)</em>は、配列と密接に関係しています。<code>to_a</code>メソッドを使用して配列に変換すると理解しやすいと思います。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span>
<span class="go">=&gt; 0..9</span>
<span class="gp">&gt;&gt; </span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="o">.</span><span class="n">to_a</span>              <span class="c1"># 配列でない数字の9にto_aを実行してしまった</span>
<span class="go">NoMethodError: undefined method `to_a&#39; for 9:Fixnum</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># 範囲にto_aを実行するには丸かっこで囲む</span>
<span class="go">=&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8, 9] </span>
</pre></div>
</div>


<p><code>0..9</code> は範囲として有効ですが、上の2番目の表記ではメソッドを呼ぶ際にかっこを追加する必要があることを示しています。</p>

<p>範囲は、配列の要素を取り出すのに便利です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="sx">%w[foo bar baz quux]</span>         <span class="c1"># %wを使用して文字列の配列に変換</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;, &quot;quux&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">]</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
</pre></div>
</div>


<p>以下のように、文字に対しても範囲を使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;e&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;]</span>
</pre></div>
</div>


<div class="label" id="sec-blocks"></div>


<h3><a id="sec-4_3_2" href="#sec-blocks" class="heading"><span class="number">4.3.2</span>ブロック</a></h3>


<p>配列と範囲はいずれも、<em>ブロック</em>を伴うさまざまなメソッドに対して応答することができます。ブロックとは、Rubyの極めて強力な機能であり、かつ混乱を呼びやすい機能でもあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="p">}</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div>
</div>


<p>上のコードは、範囲オブジェクトである<code>(1..5)</code>に対して<code>each</code>メソッドを呼び出します。そのときに、<code>{ |i| puts 2 * i }</code>というブロックを渡します。<code>|i|</code>では変数名が縦棒に囲まれていますが、これはブロック変数に対して使用するRubyの構文で、ブロックを操作するときに使用する変数を指定します。この場合、範囲オブジェクトの<code>each</code>メソッドは、<code>i</code>という1つのローカル変数を使用してブロックを操作できます。そして、範囲に含まれるそれぞれの値をこの変数に次々に代入してブロックを実行します。</p>

<p>ブロックは波かっこ { } で囲んで示すことができますが、以下のようにdoとendで囲んで示すこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">2</span>
<span class="go">4</span>
<span class="go">6</span>
<span class="go">8</span>
<span class="go">10</span>
<span class="go">=&gt; 1..5</span>
</pre></div>
</div>


<p>ブロックには複数の行を記述できます (実際ほとんどの場合複数です)。<em>Rails チュートリアル</em>では、波かっこを短い1行のブロックに使用し、<code>do..end</code>記法を長い1行や複数行のブロックに使用するという、Ruby共通の慣習に従っています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">number</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">number</span>
<span class="gp">&gt;&gt; </span>  <span class="nb">puts</span> <span class="s1">&#39;--&#39;</span>
end
<span class="go">2</span>
<span class="go">--</span>
<span class="go">4</span>
<span class="go">--</span>
<span class="go">6</span>
<span class="go">--</span>
<span class="go">8</span>
<span class="go">--</span>
<span class="go">10</span>
<span class="go">--</span>
<span class="go">=&gt; 1..5</span>
</pre></div>
</div>


<p>ここでは<code>number</code>を<code>i</code>と差し替えたことで、他の変数名を使用してもよいということを強調しています。</p>

<p>ブロックは見た目に反して奥が深く、ブロックを十分に理解するためには相当なプログラミング経験が必要です。そのためには、ブロックを含むコードをたくさん読みこなすことでブロックの本質を会得する以外に方法はありません<sup class="footnote" id="fnref-4_7"><a href="#fn-4_7">7</a></sup>。幸いなことに、人間には個別の事例を一般化する能力というものがあります。ささやかですが、<code>map</code>メソッドなどを使用したブロックの使用例を参考のためにいくつか挙げてみます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;Betelgeuse!&quot;</span> <span class="p">}</span>   <span class="c1"># 3.timesではブロックに変数を使用していない</span>
<span class="go">&quot;Betelgeuse!&quot;</span>
<span class="go">&quot;Betelgeuse!&quot;</span>
<span class="go">&quot;Betelgeuse!&quot;</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="p">}</span>          <span class="c1"># **は累乗を表す</span>
<span class="go">=&gt; [1, 4, 9, 16, 25]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span>                        <span class="c1"># %wは文字列配列への変換であることを思い出そう</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[a b c]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">upcase</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="sx">%w[A B C]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span>
</pre></div>
</div>


<p>上に示したように、<code>map</code> メソッドは、配列や範囲オブジェクトの各要素に対して、与えられたブロックを適用した結果を返します。</p>

<p>ところで、<a class="ref" href="#sec-heroku_commands">1.4.4</a>でランダムなサブドメインを生成するために以下のRubyコードを紹介しましたが、今なら理解できる状態になったはずです。</p>

<div class="code"><div class="highlight"><pre><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>
</pre></div>
</div>


<p>このコードを段階的に組み立ててみると、動作がよくわかります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>                     <span class="c1"># アルファベットの配列</span>
<span class="go">=&gt; [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot;, &quot;g&quot;, &quot;h&quot;, &quot;i&quot;, &quot;j&quot;, &quot;k&quot;, &quot;l&quot;, &quot;m&quot;, &quot;n&quot;, &quot;o&quot;,</span>
<span class="go">&quot;p&quot;, &quot;q&quot;, &quot;r&quot;, &quot;s&quot;, &quot;t&quot;, &quot;u&quot;, &quot;v&quot;, &quot;w&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span>             <span class="c1"># シャッフルする</span>
<span class="go">=&gt; [&quot;c&quot;, &quot;g&quot;, &quot;l&quot;, &quot;k&quot;, &quot;h&quot;, &quot;z&quot;, &quot;s&quot;, &quot;i&quot;, &quot;n&quot;, &quot;d&quot;, &quot;y&quot;, &quot;u&quot;, &quot;t&quot;, &quot;j&quot;, &quot;q&quot;,</span>
<span class="go">&quot;b&quot;, &quot;r&quot;, &quot;o&quot;, &quot;f&quot;, &quot;e&quot;, &quot;w&quot;, &quot;v&quot;, &quot;m&quot;, &quot;a&quot;, &quot;x&quot;, &quot;p&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">]</span>       <span class="c1"># 最初の8つの要素を取り出す</span>
<span class="go">=&gt; [&quot;f&quot;, &quot;w&quot;, &quot;i&quot;, &quot;a&quot;, &quot;h&quot;, &quot;p&quot;, &quot;c&quot;, &quot;x&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">.</span><span class="n">.</span><span class="s1">&#39;z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">shuffle</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="o">].</span><span class="n">join</span>  <span class="c1"># つなげて1つの文字列にする</span>
<span class="go">=&gt; &quot;mznpybuj&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-hashes_and_symbols"></div>


<h3><a id="sec-4_3_3" href="#sec-hashes_and_symbols" class="heading"><span class="number">4.3.3</span>ハッシュとシンボル</a></h3>


<p>ハッシュ (hash) とは、本質的には配列を一般化したものです。ハッシュは、基本的に配列と同じものとみなすこともできますが、インデックスに整数以外の要素も使用できる点が異なります (この理由から、いくつかの言語 (特にPerl) ではハッシュを<em>連想配列</em>と呼ぶこともあります)。ハッシュのインデックス (<em>キー</em>と呼ぶのが普通です) は、通常何らかのオブジェクトです。たとえば、以下のように文字列をキーとして使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{}</span>                          <span class="c1"># {}は空のハッシュ</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">&quot;first_name&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Michael&quot;</span>     <span class="c1">#キー: &quot;first_name&quot;、値: &quot;Michael&quot;</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">&quot;last_name&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Hartl&quot;</span>        <span class="c1"># キー: &quot;last_name&quot;、値: &quot;Hartl&quot;</span>
<span class="go">=&gt; &quot;Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="s2">&quot;first_name&quot;</span><span class="o">]</span>                 <span class="c1"># 配列と同じ方法で要素にアクセスできる</span>
<span class="go">=&gt; &quot;Michael&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span>                               <span class="c1"># ハッシュのリテラルな表記</span>
<span class="go">=&gt; {&quot;last_name&quot;=&gt;&quot;Hartl&quot;, &quot;first_name&quot;=&gt;&quot;Michael&quot;}</span>
</pre></div>
</div>


<p>ハッシュは、キーと値のペアを波かっこで囲んで表記します。キーと値のペアを持たないかっこの組 (<code>{}</code>) は空のハッシュです。ここで重要なのは、ハッシュの波かっこは、ブロックの波かっことはまったく別物であるという点です (これは確かに紛らわしい点です) 。ハッシュは配列と似ていますが、1つの重要な違いとして、ハッシュでは要素の「並び順」が保証されないという点があります<sup class="footnote" id="fnref-4_8"><a href="#fn-4_8">8</a></sup>。もし要素の順序が重要である場合は、配列を使用する必要があります。</p>

<p>ハッシュの1要素を角かっこを使って定義する代わりに、以下のようにキーと値をハッシュロケットと呼ばれる<code>=&gt;</code> によってリテラル表現するほうが簡単です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;first_name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael&quot;</span><span class="p">,</span> <span class="s2">&quot;last_name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hartl&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {&quot;last_name&quot;=&gt;&quot;Hartl&quot;, &quot;first_name&quot;=&gt;&quot;Michael&quot;}</span>
</pre></div>
</div>


<p>ここではRubyにおける通常の慣習として、ハッシュの最初と最後に空白を追加しています。この空白はあってもなくてもよく、コンソールでは無視されます (なぜスペースを置くようになったのかはわかりません。おそらく初期の有力な Rubyプログラマが好んだ結果、慣習となったのでしょう)。</p>

<p>ここまではハッシュのキーとして文字列を使用していましたが、Railsでは文字列よりも<em>シンボル</em>を使用する方が普通です。シンボルは文字列と似ていますが、クォートで囲む代わりにコロンが前に置かれている点が異なります。たとえば、<code>:name</code>はシンボルです。もちろん、余計なことを一切考えずに、シンボルを単なる文字列とみなしても構いません<sup class="footnote" id="fnref-4_9"><a href="#fn-4_9">9</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;name&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="go">=&gt; [&quot;n&quot;, &quot;a&quot;, &quot;m&quot;, &quot;e&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="ss">:name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="go">NoMethodError: undefined method `split&#39; for :name:Symbol</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">=&gt; &quot;raboof&quot;</span>
<span class="gp">&gt;&gt; </span><span class="ss">:foobar</span><span class="o">.</span><span class="n">reverse</span>
<span class="go">NoMethodError: undefined method `reverse&#39; for :foobar:Symbol</span>
</pre></div>
</div>


<p>シンボルは、Ruby以外ではごく一部の言語にしか採用されていない特殊なデータ形式です。最初は奇妙に思うかもしれませんが、Railsではシンボルをふんだんに使用していますので、すぐに慣れるでしょう。</p>

<p>ハッシュのキーとしてシンボルを採用する場合、<code>user</code> のハッシュは以下のように定義できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;michael@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>              <span class="c1"># :name に一致する値にアクセスします。</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span>          <span class="c1"># 未定義のキーの値にアクセスします。</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>最後の例を見ると、未定義のハッシュ値は単純に<code>nil</code>であることがわかります。</p>

<p>ハッシュではシンボルをキーとして使うことが一般的なので、Ruby 1.9ではこのような特殊な場合のための新しい記法をサポートしています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;michael@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">h2</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;michael@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">h1</span> <span class="o">==</span> <span class="n">h2</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>2つ目の記法は、シンボルとハッシュロケットの組み合わせを、以下のようにキーの名前の (前ではなく) 後にコロンを置き、その後に値が続くように置き換えたものです。</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;michael@example.com&quot;</span> <span class="p">}</span>
</pre></div>
</div>


<p>この構成は、JavaScriptなどの他の言語でのハッシュ記法により近いものになっており、Railsコミュニティでも人気が高まっています。どちらの記法もよく使われているので、両方の見分けがつくことが重要です。本書の他の章では、ほとんどの場合新しい記法でハッシュを記述しています。この記法はRuby 1.8.7以前では動作しないのでご注意ください。もし古いバージョンのRubyを使用している場合は、Ruby 1.9に更新する (推奨) か、古い記法に書き換えてください。</p>

<p><a class="ref" href="#code-nested_hashes">リスト4.6</a>に示したように、ハッシュの値にはほぼ何でも使用することができ、他のハッシュを使用することすらできます。</p>

<div class="label" id="code-nested_hashes"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.6</span> <span class="description">ハッシュをネストする。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># &#39;params&#39; というハッシュを定義する (&#39;parameters&#39; の略)。</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;mhartl@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">params</span>
<span class="go">=&gt; {:user=&gt;{:name=&gt;&quot;Michael Hartl&quot;, :email=&gt;&quot;mhartl@example.com&quot;}}</span>
<span class="gp">&gt;&gt; </span> <span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
<span class="go">=&gt; &quot;mhartl@example.com&quot;</span>
</pre></div>
</div></div>


<p>Railsでは、このようなハッシュのハッシュや<em>ネストされたハッシュ</em> が大量に使われています。実際の使用例は<a class="ref" href="#sec-signup_failure">7.3</a>で説明します。</p>

<p>配列や範囲オブジェクトと同様、ハッシュも<code>each</code>メソッドに応答します。たとえば、<code>:success</code>と<code>:error</code>という 2つの状態を持つ <code>flash</code> という名前のハッシュについて考えてみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success:</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="ss">error:</span> <span class="s2">&quot;It failed.&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;&quot;It worked!&quot;, :error=&gt;&quot;It failed.&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;Key </span><span class="si">#{</span><span class="n">key</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> has value </span><span class="si">#{</span><span class="n">value</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">Key :success has value &quot;It worked!&quot;</span>
<span class="go">Key :error has value &quot;It failed.&quot;</span>
</pre></div>
</div>


<p>ここで、配列の<code>each</code>メソッドでは、ブロックの変数は1つだけですが、ハッシュの<code>each</code>メソッドでは、ブロックの変数は<em>キー</em>と<em>値</em>の2つになっていることにご注意ください。従って、 ハッシュに対して<code>each</code>メソッドを実行すると、ハッシュの1つの「キーと値の<em>ペア</em>」ごとに処理を繰り返します。</p>

<p>最後の例として、便利な<code>inspect</code>メソッドを紹介します。これは要求されたオブジェクトを表現する文字列を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>            <span class="c1"># 配列を文字列として出力</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
<span class="go">4</span>
<span class="go">5</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">inspect</span>    <span class="c1"># 配列のリテラルを出力</span>
<span class="go">[1, 2, 3, 4, 5]</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:name</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">name</span>
<span class="go">:name</span>
<span class="gp">&gt;&gt; </span><span class="nb">puts</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="s2">&quot;It worked!&quot;</span><span class="o">.</span><span class="n">inspect</span>
<span class="go">It worked!</span>
<span class="go">&quot;It worked!&quot;</span>
</pre></div>
</div>


<p>ところで、オブジェクトを表示するために<code>inspect</code>とputsを使用することは非常によくあることなので、 両者を合わせた<code>p</code>関数というショートカットがあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">p</span> <span class="ss">:name</span>             <span class="c1"># &#39;puts :name.inspect&#39; と同等</span>
<span class="go">:name</span>
</pre></div>
</div>




<div class="label" id="sec-css_revisited"></div>


<h3><a id="sec-4_3_4" href="#sec-css_revisited" class="heading"><span class="number">4.3.4</span> CSS、再び</a></h3>


<p>それでは、もう一度<a class="ref" href="#code-application_layout_redux">リスト4.1</a>に戻り、レイアウトに CSS (cascading style sheet) を追加する以下の行を見てみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>今なら、このコードを理解できる段階にあるはずです。<a class="ref" href="#sec-motivation">4.1</a>でも簡単に説明したとおり、Railsではスタイルシートを追加するための特別な関数を使用しています。</p>

<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>上のコードでは、この関数を呼んでいます。しかし、ここで不思議な点が2つあります。第一に、丸かっこがありません。実は、Ruby では丸かっこは使用してもしなくても構いません。以下の2つの行は同等です。</p>

<div class="code"><div class="highlight"><pre><span class="c1"># 関数呼び出しの丸かっこは省略可能。</span>
<span class="n">stylesheet_link_tag</span><span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>第二に、<code>:media</code>引数はハッシュのように見えますが、波かっこがありません。実は、そのハッシュが関数呼び出しの<em>最後の</em>引数の場合は、波かっこを省略できます。以下の2つの行は同等です。</p>

<div class="code"><div class="highlight"><pre><span class="c1"># 最後の引数がハッシュの場合、波括弧は省略可能。</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="p">}</span>
<span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>従って、</p>

<div class="code"><div class="highlight"><pre><span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span>
</pre></div>
</div>


<p>上のコードでは<code>stylesheet_link_tag</code>関数を2つの引数で呼んでいます。最初の文字列はスタイルシートへのパスを示しており、次のハッシュはメディアタイプを示しています。コードが<tt class="verb">&lt;%= %&gt;</tt>で囲まれていることによって、 このコードの実行結果はERbのテンプレートに挿入されます。ブラウザ上でこのページのソースを表示すると、必要なスタイルシートが含まれていることを確認できます (<a class="ref" href="#code-scss_source">リスト4.7</a>)。(CSSファイル名の後に、<code>?body=1</code>のような行が余分に表示されていることがあります。これらはRailsによって挿入されているもので、サーバ上で変更があった場合にブラウザがCSSを再読み込みするのに使用します。)</p>

<div class="label" id="code-scss_source"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.7</span> <span class="description">インクルードされたCSSによって生成されたHTMLソース。</span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/assets/application.css&quot;</span> <span class="na">media=</span><span class="s">&quot;all&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
<span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div></div>


<p>実際に<a href="http://localhost:3000/assets/application.css">http://localhost:3000/assets/application.css</a>のCSSファイルにアクセスしてみると、わずかなコメントがある以外は空になっています。CSSの変更は<a class="ref" href="#cha-filling-in-the-layout">第5章</a>で行います。</p>

<div class="label" id="sec-ruby_classes"></div>


<h2><a id="sec-4_4" href="#sec-ruby_classes" class="heading"><span class="number">4.4</span> Ruby におけるクラス</a></h2>


<p>Rubyではあらゆるものがオブジェクトであるということは既に説明しましたが、この節では実際にオブジェクトをいくつか定義してみましょう。Rubyは、多くのオブジェクト指向言語と同様、メソッドをまとめるのに<em>クラス</em>を使用しています。これらのクラスから<em>インスタンスが生成される</em>ことでオブジェクトが作成されます。オブジェクト指向プログラミングの経験がない方にとっては何のことだかわからないと思いますので、いくつかの具体例を示すことにします。</p>

<div class="label" id="sec-constructors"></div>


<h3><a id="sec-4_4_1" href="#sec-constructors" class="heading"><span class="number">4.4.1</span>コンストラクタ</a></h3>


<p>実は、これまで示した多くの例の中でも、クラスを使用してオブジェクトのインスタンスを作成してきたのですが、オブジェクトを作成するところを明示的に説明していませんでした。たとえば、ダブルクォートを使って文字列のインスタンスを作成しましたが、これは文字列のオブジェクトを暗黙で作成する<em>リテラルコンストラクタ</em>です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>       <span class="c1"></span># ダブルクォートを使用した、文字列のリテラルコンストラクタ
<span class="go">=&gt; &quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
</pre></div>
</div>


<p>上のコードでは、文字列が<code>class</code>メソッドに応答しており、その文字列が所属するクラスを単に返していることがわかります。</p>

<p>暗黙のリテラルコンストラクタを使う代わりに、明示的に同等の<em>名前付きコンストラクタ</em>を使うことができます。名前付きコンストラクタは、クラス名に対して<code>new</code>メソッドを呼びだします<sup class="footnote" id="fnref-4_10"><a href="#fn-4_10">10</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>   <span class="c1"># 文字列の名前付きコンストラクタ</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;foobar&quot;</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>この動作はリテラルコンストラクタと同等ですが、動作の内容が明確に示されています。</p>

<p>配列でも、文字列と同様にインスタンスを生成できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span>
<span class="go">=&gt; [1, 3, 2]</span>
</pre></div>
</div>


<p>ただし、ハッシュの場合は若干異なります。配列のコンストラクタである<code>Array.new</code> は配列の初期値を引数に取りますが、 <code>Hash.new</code> はハッシュの<em>デフォルト</em> 値を引数に取ります。これは、キーが存在しない場合のデフォルト値です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>            <span class="c1"># 存在しないキー :fooの値にわざとアクセスしてみる</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># キーが存在しない場合のデフォルト値をnilから0に変更する</span>
<span class="go">=&gt; {}</span>
<span class="gp">&gt;&gt; </span><span class="n">h</span><span class="o">[</span><span class="ss">:foo</span><span class="o">]</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>メソッドがクラス自身 (この場合は<code>new</code>) に対して呼び出されるとき、このメソッドを<em>クラスメソッド</em>と呼びます。クラスの<code>new</code>メソッドを呼び出した結果は、そのクラスのオブジェクトであり、これはクラスの<em>インスタンス</em>とも呼ばれます。<code>length</code>のように、インスタンスに対して呼び出すメソッドは<em>インスタンスメソッド</em>と呼ばれます。</p>

<div class="label" id="sec-a_class_of_our_own"></div>


<h3><a id="sec-4_4_2" href="#sec-a_class_of_our_own" class="heading"><span class="number">4.4.2</span>クラス継承</a></h3>


<p>クラスについて学ぶとき、<code>superclass</code>メソッドを使って<em>クラス階層</em>を調べてみるとよくわかります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>                        <span class="c1"># sのクラスを表示</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>             <span class="c1"># Stringクラスのスーパークラスを表示</span>
<span class="go">=&gt; Object</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>  <span class="c1"># Ruby 1.9では新たにBasicObject基底クラスを使用</span>
<span class="go">=&gt; BasicObject</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>継承階層を<a class="ref" href="#fig-string_inheritance_ruby_1_9">図4.1</a>に示します。ここでは、<code>String</code>クラスのスーパークラスは<code>Object</code>クラスで、<code>Object</code>クラスのスーパークラスは<code>BasicObject</code>クラスですが、 <code>BasicObject</code>クラスはスーパークラスを持たないことがわかります。この図式は、すべての Ruby のオブジェクトにおいて成り立ちます。クラス階層をたどっていくと、 Rubyにおけるすべてのクラスは最終的にスーパークラスを持たない<code>BasicObject</code>クラスを継承しています。これが、&quot;Rubyではあらゆるものがオブジェクトである&quot; ということの技術的な意味です。</p>

<div class="label" id="fig-string_inheritance_ruby_1_9"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/string_inheritance_ruby_1_9.png" alt="string_inheritance_ruby_1_9" /></span></div><div class="caption"><span class="header">図4.1: </span><span class="description"> <code>String</code>クラスの継承階層</span></div></div>


<p>クラスについての理解を深めるには、自分でクラスを作成してみるのが一番です。そこで、<code>Word</code>クラスを作成し、その中に、ある単語を前からと後ろからのどちらから読んでも同じ (つまり回文になっている) ならば<code>true</code>を返す<code>palindrome?</code>メソッドを作成してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>    <span class="n">string</span> <span class="o">==</span> <span class="n">string</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>このクラスとメソッドは以下のように使うことができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">w</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span>              <span class="c1"># Wordオブジェクトを作成する</span>
<span class="go">=&gt; #&lt;Word:0x22d0b20&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">palindrome?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">level&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>もし上の例が少し不自然に思えるならば、勘が鋭いといえます。これは仕様です。文字列を引数に取るメソッドを作るためだけに、わざわざ新しいクラスを作るのは変です。単語<em>は</em>文字列なので、<a class="ref" href="#code-word_class">リスト4.8</a>のように<code>Word</code>クラスは <code>String</code>クラスを<em>継承</em>するのが自然です (以下のリストを入力する前に、古い<code>Word</code>クラスの定義を消去するために、Railsコンソールをいったん終了してください)。</p>

<div class="label" id="code-word_class"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.8</span> <span class="description">コンソールで<code>Word</code>クラスを定義する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">Word</span> <span class="o">&lt;</span> <span class="nb">String</span>             <span class="c1"># WordクラスはStringクラスを継承する。</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># 文字列が鏡文字であればtrueを返す。</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>        <span class="c1"># selfは文字列自身を表す。</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div></div>


<p><a class="ref" href="#sec-static_pages_with_rails">3.1.2</a>でも簡単に説明しましたが、上のコードの<code>Word &lt; String</code>は継承のためのRubyの記法です。こうすることで、新しい<code>palindrome?</code>メソッドだけではなく、Stringsクラスで使用できるすべてのメソッドをWordクラスに対しても使用できるようになります。10</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="no">Word</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">)</span>    <span class="c1"># 新しいWordを作成し、&quot;level&quot; で初期化する</span>
<span class="go">=&gt; &quot;level&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">palindrome?</span>            # Wordで<span class="c1">palindrome?</span><span class="c1">メソッド</span>を使用する。
<span class="go">=&gt; true                     </span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">length</span>                 <span class="c1"># Wordがstringのすべてのメソッドも継承している</span>
<span class="go">=&gt; 5</span>
</pre></div>
</div>


<p><code>Word</code>クラスは<code>String</code>クラスを継承しているので、コンソールを使用してクラス階層を明示的に確認できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Word</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; String</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div>
</div>


<p><a class="ref" href="#fig-word_inheritance_ruby_1_9">図4.2</a>にこのクラス階層を示します。</p>

<div class="label" id="fig-word_inheritance_ruby_1_9"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/word_inheritance_ruby_1_9.png" alt="word_inheritance_ruby_1_9" /></span></div><div class="caption"><span class="header">図4.2: </span><a class="ref" href="#code-word_class">リスト4.8</a>の<span class="description"> (組み込みではない) <code>Word</code>クラスの継承階層</span></div></div>


<p><a class="ref" href="#code-word_class">リスト4.8</a>では、単語の文字を逆順にしたものが元の単語と同じであるかどうかのチェックを、<code>Word</code>クラスの中から自分自身が持つ単語にアクセスすることで行なっていることにご注目ください。Rubyでは、<code>self</code>キーワードを使用してこれを指定することができます。<code>Word</code>クラスの中では、<code>self</code>はオブジェクト自身を指します。これはつまり、以下のコードを使用して、</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
</pre></div>
</div>


<p>単語が回文であるかどうかを確認できるということです<sup class="footnote" id="fnref-4_11"><a href="#fn-4_11">11</a></sup>。</p>

<div class="label" id="sec-modifying_built_in_classes"></div>


<h3><a id="sec-4_4_3" href="#sec-modifying_built_in_classes" class="heading"><span class="number">4.4.3</span>組込みクラスの変更</a></h3>


<p>継承は強力な概念ですが、もし仮に継承を使用せずに<code>palindrome?</code>メソッドを<code>String</code>クラス自身に追加する (つまりStringクラスを拡張する) という、より自然な方法を使用することが可能だとしたら、わざわざWordクラスを作らなくても<code>palindrome?</code>をリテラル文字列に対して直接実行できるようになるはずです。そんなことが可能なのでしょうか (なお、現在のコードはそのようになっていないため、以下のようにエラーになります)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;level&quot;</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">NoMethodError: undefined method `palindrome?&#39;</span><span class="go">for &quot;level&quot;:String</span>
</pre></div>
</div>


<p>驚くべきことに、Rubyでは組み込みの基本クラスの拡張が可能なのです。Ruby のクラスは<em>オープン</em>で変更可能であり、クラス設計者でない私たちでもこれらのクラスにメソッドを追加することが許されています<sup class="footnote" id="fnref-4_12"><a href="#fn-4_12">12</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="c1"># 文字列が回文であればtrueを返す</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">palindrome?</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;deified&quot;</span><span class="o">.</span><span class="n">palindrome?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>(Rubyで組み込みクラスにメソッドを追加できるということは実にクールですが、<code>&quot;deified&quot;</code> (=神格化された) という単語が回文になっていることも、それに劣らずクールではないでしょうか。)</p>

<p>組み込みクラスの変更はきわめて強力なテクニックですが、大いなる力には大いなる責任が伴います (訳注: 「スパイダーマン」の名台詞)。従って、<em>真に</em>正当な理由がない限り、組み込みクラスにメソッドを追加することは無作法であると考えられています。Railsの場合、組み込みクラスの変更を正当化できる理由がいくつもあります。たとえば、Web アプリケーションでは、変数が絶対に<em>空白</em>にならないようにしたくなることがよくあります (ユーザ名などはスペースや<a href="http://en.wikipedia.org/wiki/Whitespace_(computer_science)">その他の空白文字</a>になって欲しくないものです) ので、Railsは<code>blank?</code>メソッドをRuby に追加しています。Railsの拡張は自動的にRailsコンソールにも取り込まれるので、以下のようにコンソールで拡張の結果を確認できます (注意: 以下のコードは純粋な <code>irb</code> では動作しません)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;      &quot;</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;      &quot;</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="kp">nil</span><span class="o">.</span><span class="n">blank?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>スペースが集まってできた文字列は<em>空 (empty) </em>とは認識されませんが、<em>空白 (blank) </em>であると認識されていることがわかります。ここで、<code>nil</code>は空白と認識されることにご注意ください。<code>nil</code>は文字列ではないので、Railsが実は<code>blank?</code>メソッドを<code>String</code>クラスではなく、そのさらに上の基底クラスに追加していることが推測できます。その基底クラスとは、(この章の最初で説明した) <code>Object</code>自身です。RailsによってRubyの組み込みクラスに追加が行われている例については、<a class="ref" href="#sec-remember_me">8.2.1</a>で説明します。</p>

<div class="label" id="sec-a_controller_class"></div>


<h3><a id="sec-4_4_4" href="#sec-a_controller_class" class="heading"><span class="number">4.4.4</span>コントローラクラス</a></h3>


<p>これまでクラスや継承について説明してきましたが、これらの話は前の章にもあったような気がします。それもそのはずで、StaticPagesコントローラで継承やクラスについて触れたことがありました (<a class="ref" href="#code-adding_the_about_page">リスト3.15</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">help</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>本書をここまで進めてきた今であれば、上のコードの意味は (たとえ漠然とであっても) 理解できるはずです。<code>StaticPagesController</code>クラスは<code>ApplicationController</code>を継承しており、<code>home</code>メソッド、<code>help</code>メソッド、<code>about</code>メソッドを備えています。 Rails コンソールは、セッションごとにローカルのRails環境を読み込むので、コンソール内で明示的にコントローラを作成したり、そのクラス階層を調べたりすることができます<sup class="footnote" id="fnref-4_13"><a href="#fn-4_13">13</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span> <span class="o">=</span> <span class="no">StaticPagesController</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;StaticPagesController:0x22855d0&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; StaticPagesController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ApplicationController</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; ActionController::Metal</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; AbstractController::Base</span>
<span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span><span class="o">.</span><span class="n">superclass</span>
<span class="go">=&gt; Object</span>
</pre></div>
</div>


<p>継承の関係を<a class="ref" href="#fig-static_pages_controller_inheritance">図4.3</a>に示します。</p>

<div class="label" id="fig-static_pages_controller_inheritance"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/static_pages_controller_inheritance.png" alt="static_pages_controller_inheritance" /></span></div><div class="caption"><span class="header">図4.3: </span><span class="description"> StaticPagesコントローラの継承階層</span></div></div>


<p>Railsコンソールでは、その中からコントローラのアクション (実はメソッド) を呼ぶこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">controller</span><span class="o">.</span><span class="n">home</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>ここでは、<code>home</code>アクションの中身は空なので<code>nil</code>が返されます。</p>

<p>ここで重要な点があります。Railsのアクションには返し値がありません。少なくとも、返される値は重要ではありません。<a class="ref" href="#cha-static-pages">第3章</a>で示したとおり、<code>home</code>アクションはWebページを表示するためのものであり、値を返すためのものではありませんでした。しかも、第3章では一度も<code>StaticPagesController.new</code>を実行しませんでした。どうしてこれでうまくいっているのでしょうか。</p>

<p>実は、Railsは確かにRubyで<em>書かれて</em>いますが、既にRubyとは別物なのです。Railsのクラスは、普通のRubyオブジェクトと同様に振る舞うものもありますが、多くのクラスにはRailsの<a href="http://www.answers.com/grist">魔法の粉</a>が振りかけられています。Railsは<a href="http://en.wikipedia.org/wiki/Sui_generis"><em>独特</em></a>であり、 Rubyとは切り離して学習する必要があります。このため、とにかくWebアプリケーションを書けるようになりたい方は、最初にRailsを学び、次にRubyを学んでから再びRailsに戻ってくることをお勧めします。</p>

<div class="label" id="sec-a_user_class"></div>


<h3><a id="sec-4_4_5" href="#sec-a_user_class" class="heading"><span class="number">4.4.5</span>ユーザークラス</a></h3>


<p>最後に完全なクラスを作成して、この章を終わりにしましょう。そこで、<a class="ref" href="#cha-modeling-users">第6章</a>で使用する<code>User</code>クラスを最初から作成することにします。</p>

<p>これまではコンソール上でクラスを定義しましたが、このような面倒な作業はもう行いたくありません。これからは、アプリケーションのルートディレクトリに<code>example_user.rb</code>ファイルを作成し、そこに<a class="ref" href="#code-example_user">リスト4.9</a>のように書くことにします。</p>

<div class="label" id="code-example_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.9</span> <span class="description">example_userで使用するコード。</span><br /><span class="description"> <code>example_user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードはこれまでよりもやや複雑になっていますので、順に見ていくことにします。以下の最初の行は、</p>

<div class="code"><div class="highlight"><pre>  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
</pre></div>
</div>


<p>ユーザ名とメールアドレスに対応する<em>アトリビュートアクセサ</em>をそれぞれ作成します。このコードは、<a class="ref" href="#sec-mvc_in_action">2.2.2</a>でも説明したように、<code>@name</code>および<code>@email</code><em>インスタンス変数</em>について、取り出し(get) と割り当て(set) を行う &quot;ゲッター&quot; と &quot;セッター&quot; というメソッドをそれぞれ作成します。Railsでは、インスタンス変数を作成するだけでビューで自動的に使えるようになるという点に主な利用価値がありますが、一般的には、インスタンス変数はRubyのそのクラス内のどこでも利用できるようにしたい変数として使われます (これについては後で詳しく説明します)。インスタンス変数は常に<code>@</code>記号で始まり、未定義の状態では値が<code>nil</code>になります。</p>

<p>最初の行にある<code>initialize</code>は、Rubyの特殊なメソッドです。これは <code>User.new</code>を実行すると自動的に呼び出されるメソッドです。この場合の<code>initialize</code>メソッドは、以下のように<code>attributes</code>という引数を1つ取ります。</p>

<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@name</span>  <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>上のコードで、<code>attributes</code>変数は空のハッシュを<em>デフォルトの値</em>として持つため、名前やメールアドレスのないユーザを作ることができます (<a class="ref" href="#sec-hashes_and_symbols">4.3.3</a>を思い出してください。存在しないキーに対してハッシュは<code>nil</code>を返すので、<code>:name</code>キーがなければ<code>attributes[:name]</code>は<code>nil</code> になり、同じことが<code>attributes[:email]</code>にも言えます)。</p>

<p>最後に、<code>formatted_email</code>メソッドを定義しましょう (<a class="ref" href="#sec-strings">4.2.2</a>)。このメソッドは、補間子による文字列の式展開を利用して、<code>@name</code>と<code>@email</code>に割り当てられた値をユーザのメールアドレスとして構成します。</p>

<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">formatted_email</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">#{</span><span class="vi">@email</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
  <span class="k">end</span>
</pre></div>
</div>


<p><code>@</code> 記号によって示されているとおり、<code>@name</code>と<code>@email</code>は両方ともインスタンス変数なので、自動的に<code>formatted_email</code>メソッドで使えるようになります。</p>

<p>Railsコンソールを起動し、example_userのコードを<code>require</code>して、自作したクラスを試しに使ってみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">require</span> <span class="s1">&#39;./example_user&#39;</span>     <span class="c1"># example_user のコードを読み込む方法</span>
<span class="go">=&gt; [&quot;User&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User:0x224ceec @email=nil, @name=nil&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span>                 <span class="c1"># attributes[:name]がnilなのでnilが返される</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Example User&quot;</span>           <span class="c1"># nilでない名前を割り当てる</span>
<span class="go">=&gt; &quot;Example User&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;user@example.com&quot;</span>      <span class="c1"># nil でないメールアドレスも割り当てる</span>
<span class="go">=&gt; &quot;user@example.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; &quot;Example User &lt;user@example.com&gt;&quot;</span>
</pre></div>
</div>


<p>上のコードで、requireのパスにある<code>’.’</code>は、Unixの “カレントディレクトリ” (現在のディレクトリ) を表し、<code>’./example_user’</code>というパスは、カレントディレクトリからの相対パスでexample_userファイルを探すようにRubyに指示します。次のコードでは空のexample_userを作成します。次に、対応する属性にそれぞれ手動で値を代入することで、名前とメールアドレスを与えます (<a class="ref" href="#code-example_user">リスト4.9</a>で<code>attr_accessor</code>を使用しているので、アトリビュートアクセサを使用して代入できます)。以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="n">example</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Example User&quot;</span>
</pre></div>
</div>


<p><code>@name</code>変数に<code>&quot;Example User&quot;</code>という値を設定します。同様に<code>email</code>属性にも値を設定します。これらの値は<code>formatted_email</code>メソッドで使用されます。</p>

<p><a class="ref" href="#sec-css_revisited">4.3.4</a>では、最後のハッシュ引数の波かっこを省略できることを説明しました。それと同じ要領で<code>initialize</code>メソッドにハッシュを渡すことで、属性が定義済みの他のユーザを作成することができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User:0x225167c @email=&quot;mhartl@example.com&quot;, @name=&quot;Michael Hartl&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">formatted_email</span>
<span class="go">=&gt; &quot;Michael Hartl &lt;mhartl@example.com&gt;&quot;</span>
</pre></div>
</div>


<p><a class="ref" href="#cha-sign-up">第7章</a>では、ハッシュ引数を使用してオブジェクトを初期化します。これは一般に<em>マスアサインメント (mass assignment)</em>と呼ばれる技法で、Railsアプリケーションで多用されています。</p>

<div class="label" id="sec-conclusion"></div>


<h2><a id="sec-4_5" href="#sec-conclusion" class="heading"><span class="number">4.5</span>最後に</a></h2>


<p>以上で、Ruby言語の概要の説明を終わります。<a class="ref" href="#cha-filling-in-the-layout">第5章</a>では、この章で学んだ内容をサンプルアプリケーションの開発に生かしていきます。</p>

<p><a class="ref" href="#sec-a_user_class">4.4.5</a>で作成した<code>example_user.rb</code>ファイルは今後使用することはありませんので、削除してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm example_user.rb
</pre></div>
</div>


<p>その他の変更はリポジトリにコミットしましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add a full_title helper&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-exercises"></div>


<h2><a id="sec-4_6" href="#sec-exercises" class="heading"><span class="number">4.6</span>演習</a></h2>




<ol>

<li><a class="ref" href="#code-string_shuffle">リスト4.10</a>のコードにある疑問符を適切なメソッドに置き換えて、与えられた文字列の文字をシャッフルする関数を作成してください。ヒント: <code>split</code>メソッド、<code>shuffle</code>メソッド、<code>join</code>メソッドを組み合わせてみましょう。</li>

<li><a class="ref" href="#code-string_shuffle_two">リスト4.11</a>を参考にして、上で作成した<code>shuffle</code>メソッドを <code>String</code>クラスに追加してください。</li>

<li><code>person1</code>、<code>person2</code>、<code>person3</code>という3つのハッシュを作成してください。それぞれのハッシュには<code>:first</code>キーと<code>:last</code>キーを与え、さらにそれぞれのキーに名前と名字を値として割り当ててください。次に<code>params</code>ハッシュを作成し、<code>params[:father]</code>は<code>person1</code>、<code>params[:mother]</code>は<code>person2</code>、そして<code>params[:child]</code>は <code>person3</code>になるようにしてください。最後に、<code>params[:father][:first]</code>などが正しい値を持っていることを確認してください。</li>

<li>Ruby API のオンラインマニュアルを見つけて、<code>Hash</code>クラスの<code>merge</code>メソッドについて読んでみてください。</li>

<li><a href="http://rubykoans.com/">Ruby Koans</a><sup class="footnote" id="fnref-4_14"><a href="#fn-4_14">14</a></sup>(訳注: TDDでRubyを学べる無料のコンテンツ)をやってみて、Rubyの感覚を掴んでみてください。</li>
</ol>




<div class="label" id="code-string_shuffle"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.10</span> <span class="description">文字列をシャッフルする関数の骨組み。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">string_shuffle</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">string_shuffle</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div></div>




<div class="label" id="code-string_shuffle_two"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト4.11</span> <span class="description"><code>shuffle</code>メソッドを<code>String</code>クラスに追加するための骨組み。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="k">class</span> <span class="nc">String</span>
<span class="gp">&gt;&gt; </span>  <span class="k">def</span> <span class="nf">shuffle</span>
<span class="gp">&gt;&gt; </span>    <span class="nb">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="sc">?.</span><span class="p">?</span>
<span class="gp">&gt;&gt; </span>  <span class="k">end</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foobar&quot;</span><span class="o">.</span><span class="n">shuffle</span>
</pre></div>
</div></div>




<div class="footnotes">
<ol>
<li id="fn-4_1">あるヘルパーが特定のコントローラでのみ使用するものであれば、それに対応するヘルパーファイルに置く必要があります。たとえばStaticPagesコントローラ用ヘルパーは、通常<code>app/helpers/static_pages_helper.rb</code>になります。今回の場合、<code>full_title</code>ヘルパーはサイトのすべてのページで使用することを前提にしていますが、Railsにはこのような場合のための特別なヘルパーファイル<code>app/helpers/application_helper.rb</code>があります。<a class="arrow" href="#fnref-4_1">↑</a></li>
<li id="fn-4_2">“foo”と“bar”という言葉の起源の詳細については、<a href="http://www.catb.org/jargon/html/F/foo.html">Jargon Fileの “foo” の項</a>を参照してください。特に“foobar”は“FUBAR” (=めちゃくちゃ) とは何の関係も<em>ない</em>ということについて。<a class="arrow" href="#fnref-4_2">↑</a></li>
<li id="fn-4_3">PerlやPHPに精通した開発者であれば、<code>&quot;foo $bar&quot;</code>のようなドル記号による自動的な挿入を連想して比較することでしょう。<a class="arrow" href="#fnref-4_3">↑</a></li>
<li id="fn-4_4">この章の全体にわたって、<em>関数</em>という言葉と<em>メソッド</em>という言葉が混在していることを前もってお詫びいたします。Rubyでは関数とメソッドには何の違いもありません。すべてのメソッドは関数であり、すべての関数はメソッドでもあります。それもこれも、あらゆるものがオブジェクトであるからです。<a class="arrow" href="#fnref-4_4">↑</a></li>
<li id="fn-4_5">とはいうものの、まだ理解のおよばない点が<em>1つ</em>残っています。Railsがこれらすべてを結びつけている方法です。URIがどのようにしてアクションにマップされているのか、<code>full_title</code>ヘルパーをどのようにしてビューで使用できるようにしているのかなどは、この時点では明かされていません。これは実に興味深いテーマであり、意欲のある方はぜひ自分で調べてみてください。ただし、Railsが<em>どのように</em>動いているかを正確に知らなくても、Railsを<em>使用する</em>うえでは何の問題もありません (この点を深く理解したい方には、「<a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails 3 Way</em></a>」(Obie Fernandez著) がお勧めです) 。<a class="arrow" href="#fnref-4_5">↑</a></li>
<li id="fn-4_6">このコードで使用している<code>second</code>メソッドは、実はRuby自身の一部ではなく、Railsが追加したものです。このコードが動作するのは、RailsによるRubyの拡張がRailsコンソールによって自動的に取り込まれるからです。<a class="arrow" href="#fnref-4_6">↑</a></li>
<li id="fn-4_7">なおエキスパート向けには、ブロックが<em>クロージャ</em>になっているということを知っていただくと理解しやすいと思います。クロージャとは、データを伴う、その場限りの無名関数です。<a class="arrow" href="#fnref-4_7">↑</a></li>
<li id="fn-4_8">実はRuby 1.9では、ハッシュの要素の順序が入力順と同じであることを保証していますが、ハッシュを特定の順序に依存してカウントするのは得策ではありません。<a class="arrow" href="#fnref-4_8">↑</a></li>
<li id="fn-4_9">余計なものを削ぎ落した結果、シンボル同士の比較を容易に行えます。文字列は1文字ずつ比較する必要がありますが、シンボルは一度に全体を比較できます。これはハッシュのキーとして理想的な性質です。<a class="arrow" href="#fnref-4_9">↑</a></li>
<li id="fn-4_10">このメソッドの動作は、使用しているRubyのバージョンによって異なる可能性があります。この例ではRuby 1.9.3を前提としています。<a class="arrow" href="#fnref-4_10">↑</a></li>
<li id="fn-4_11">Rubyのクラスや<code>self</code>キーワードについての詳細は、<a href="http://railstips.org/">RailsTips</a>の “<a href="http://railstips.org/blog/archives/2006/11/18/class-and-instance-variables-in-ruby/">Ruby におけるクラスとインスタンス変数</a>” を参照してください。<a class="arrow" href="#fnref-4_11">↑</a></li>
<li id="fn-4_12">JavaScriptに精通している方のために補足すると、この機能は組み込みクラスのプロトタイプオブジェクトを使用してクラスを拡張することと似ています (読者の<a href="http://getsatisfaction.com/railstutorial/topics/adding_methods_to_built_in_classes_comparable_to_using_javascripts_prototype_object">Erik Eldridge</a>による指摘に感謝します)。 <a class="arrow" href="#fnref-4_12">↑</a></li>
<li id="fn-4_13">これらの階層にあるクラスの詳細を知る必要はないと思います。<em>私ですら</em>それらのクラスの詳細について知らないことがたくさんありますし、それでも私は2005年からRuby on Railsで問題なくプログラミングできています。これは (a) 私がよほど無能であるか、(b) Railsの内部を知りつくさなくても熟練したRails開発者になれる、ということのどちらかでしょう。私のためにも読者の皆様のためにも、後者であることを祈ります。<a class="arrow" href="#fnref-4_13">↑</a></li>
<li id="fn-4_14">http://rubykoans.com/ <a class="arrow" href="#fnref-4_14">↑</a></li>
</ol>
</div>




<div class="label" id="cha-filling-in-the-layout"></div>


<h1 class="chapter"><a id="sec-5" href="#cha-filling-in-the-layout" class="heading"><span class="number">第5章</span>レイアウトを作成する</a></h1>


<p>この章では、アプリケーションに<em>Bootstrap</em>フレームワークを組み込み、そして、カスタムスタイルを追加します<sup class="footnote" id="fnref-5_1"><a href="#fn-5_1">1</a></sup>。また<a class="ref" href="#sec-structure">5.1</a>までに、作成するページへのリンクをレイアウトに追加します。その途中で、パーシャル、Railsのルーティング、アセットパイプラインについて学び、さらにSassについても紹介します(<a class="ref" href="#sec-sass_and_the_asset_pipeline">5.2</a>)。 また、<a href="#cha-static-pages" class="ref">第3章</a> で作成したテストを、最新のRSpecテクニックを用いてリファクタリングします。章の最後に、ユーザをサイトにログインさせるための重要な一歩を踏み出します。</p>

<div class="label" id="sec-structure"></div>


<h2><a id="sec-5_1" href="#sec-structure" class="heading"><span class="number">5.1</span>構造を追加する</a></h2>


<p><em>Railsチュートリアル</em>はWeb開発のための本であり、Webデザインの本ではありませんが、だからといって<em>何のスタイルもない</em>寒々しい外観のアプリケーションでいつまでも作業を続けていると憂鬱になってしまいます。そこで、この章ではレイアウトにいくつかの構造とCSSを与えて最小限のスタイルを追加します。カスタムCSSルールの他に、Twitter社によるオープンソースのウェブデザインフレームワークである<a href="http://twitter.github.com/bootstrap/">Bootstrap</a>を利用します。また、<em>コード</em>そのものにもスタイルを与えます。つまり、散らかりはじめたコードレイアウトを<em>パーシャル</em>を使用して整えるということです。</p>

<p>Webアプリケーションを作成するときに、ユーザーインターフェイスの概要をできるだけ早いうちに把握しておくことがしばしば有用です。本書ではこれより、<em>モックアップ</em> (Webの文脈ではよく <em>ワイヤーフレーム</em>と呼ばれます) という、最終的なアプリケーションの外観を示す一種のラフスケッチを使用することにします<sup class="footnote" id="fnref-5_2"><a href="#fn-5_2">2</a></sup>。この章では、 主に<a class="ref" href="#sec-static_pages">3.1</a>で紹介したサイトロゴ、ナビゲーションヘッダー、サイトフッタを含む静的ページを開発します。これらのページの中で最も重要な、Homeページのモックアップを<a class="ref" href="#fig-home_page_mockup">図5.1</a>に示します。モックアップに基いて作成した最終結果は<a class="ref" href="#fig-site_with_footer">図5.7</a>で確認することができます。両者を見比べると、細部が若干異なることに気が付くでしょう (たとえば、実際には最後にRailsのロゴをページに追加します)。しかしモックアップは正確である必要はありませんので、これで十分です。</p>

<div class="label" id="fig-home_page_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_mockup_bootstrap.png" alt="home_page_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図5.1</span><span class="description">サンプルアプリケーションのHomeページのモックアップ。<a href="http://railstutorial.org/images/figures/home_page_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>Gitでバージョン管理をしているのであれば、これまでと同様、この時点で新しいブランチを作成するのがよいでしょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b filling-in-layout
</pre></div>
</div>


<div class="label" id="sec-adding_to_the_layout"></div>


<h3><a id="sec-5_1_1" href="#sec-adding_to_the_layout" class="heading"><span class="number">5.1.1</span>ナビゲーション</a></h3>


<p>第一段階として、サンプルアプリケーションにリンクとスタイルを追加するために、サイトのレイアウトファイル<code>application.html.erb</code> (<a class="ref" href="#code-application_layout_full_title">リスト4.3</a>で登場) にHTML構造を追加し、レイアウトファイルを更新します。この更新には、領域 (divタグ) の追加、CSSクラスの追加、サイトナビゲーションの起点となる領域の追加も含まれます。完全なファイルは<a class="ref" href="#code-layout_new_structure">リスト5.1</a>に示します。続いて、これを構成している多くの部品について解説します。表示結果を今すぐ確認したいのであれば、<a class="ref" href="#fig-layout_no_logo_or_custom_css">図5.2</a>で確認できます (<em>注:</em>この時点ではわざわざ見に行くほどの仕上がりではありませんが)。</p>

<div class="label" id="code-layout_new_structure"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.1</span> <span class="description">構造を追加したWebサイトのレイアウト。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">media:</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">    &lt;script src=&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot;&gt;&lt;/script&gt;</span>
<span class="c">    &lt;![endif]</span><span class="c">--&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;nav&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/nav&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>上のコードで最初に注目すべきことの1つは、Ruby 1.8スタイルのハッシュがRuby 1.9スタイルに変更されていることです (<a class="ref" href="#sec-hashes_and_symbols">4.3.3</a>)。以下のコードが、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">:media</span> <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>以下の記述に置き換えられています。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">media:</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>旧式のハッシュ構文は、特に古いアプリケーションでは未だに一般的なので、両方を理解できることが重要です。</p>

<p>それでは、<a class="ref" href="#code-layout_new_structure">リスト5.1</a>のその他の新しい要素を上から順に見ていきましょう。<a class="ref" href="#sec-static_pages">3.1</a>で簡単に説明したように、Rails 3はデフォルトで HTML5を使用します (doctype <code>&lt;!DOCTYPE html&gt;</code>で示されています)。HTML5標準は比較的新しいため、ブラウザ (特に、古いバージョンのIE) によってはサポートが不十分なことがあります。この問題を回避するため、(“<a href="http://code.google.com/p/html5shim/">HTML5 shim</a>”として知られる) JavaScriptコードをインクルードしてあります。</p>

<div class="code"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">&lt;script src=&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot;&gt;&lt;/script&gt;</span>
<span class="c">&lt;![endif]</span><span class="c">--&gt;</span>
</pre></div>
</div>


<p>上のコードには、以下のような奇妙な構文が含まれています。</p>

<div class="code"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;</span>
</pre></div>
</div>


<p>これは、Microsoft Internet Explorer (IE) のバージョンが9より小さい場合 (<code>if lt IE 9</code>) にのみ、囲まれている行を実行します。この風変わりな文法<code>[if lt IE 9]</code>は、Railsの一部<em>ではありません</em>。これは実は、<a href="http://en.wikipedia.org/wiki/Conditional_comment">条件付きコメント</a>と呼ばれるもので、今回のような状況のために Internet Explorer で特別にサポートされています。これにより、Firefox、Chrome、Safariなどの他のブラウザに影響を与えずに、IEのバージョンが9未満の場合に<em>のみ</em>HTML5 shimをインクルードすることができるため、非常に好都合です。</p>

<p>それに続くセクションには、サイトのロゴを表示する<code>header</code>、(<code>div</code>タグによる) いくつかの領域、ナビゲーションリンクのリストがあります。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div>


<p><code>header</code>タグは、ページのトップに来るべき要素を表します。この<code>header</code>タグには、<code>navbar</code>、<code>navbar-fixed-top</code>、<code>navbar-inverse</code>という3つの<em>CSSクラス</em><sup class="footnote" id="fnref-5_3"><a href="#fn-5_3">3</a></sup>がスペース区切りで与えられています。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>すべてのHTML要素には、クラスと<em>id</em>の両方を指定することができます。これらは単なるラベルで、CSSでスタイルを指定するときに便利です(<a class="ref" href="#sec-custom_css">5.1.2</a>)。クラスとIDの主な違いは、クラスはページの中で何度でも使用できるのに対し、IDは一度しか使用することができない点です。今回の場合、すべてのnavbarクラスには、<a class="ref" href="#sec-custom_css">5.1.2</a>でインストールするBootstrapフレームワークによって特別な意味を与えられます。</p>

<p><code>header</code>タグの内側には2つの<code>div</code>タグがあります。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p><code>div</code>タグは一般的な表示領域を表し、ドキュメントを別々のパーツに分ける以外のことはしません。古いスタイルのHTMLでは、<code>div</code>タグはサイトのほぼすべての領域に使用されますが、HTML5では多くのアプリケーションに共通の領域で使用する<code>header</code>要素、<code>nav</code>要素、<code>section</code>要素を追加します。この場合、それぞれの<code>div</code>にはCSSクラスが与えられています。<code>header</code>タグのクラスと同様に、これらのクラスもBootstrapにおいて特別な意味を持っています。</p>

<p>divに続いて、埋め込みRubyコードが出現します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;nav&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</pre></div>
</div>


<p>ここでは、リンク (<a class="ref" href="#sec-passing_title_tests">3.3.2</a>で、アンカータグ<code>a</code>を使用して作成) を生成するために、Railsヘルパーの<code>link_to</code>を使用しています。<code>link_to</code>の第1引数はリンクテキスト、第2引数はURIです。このURIは<a class="ref" href="#sec-named_routes">5.3.3</a>で<em>名前付きルート</em>のURIに変更しますが、今はウェブデザインで一般に使用されるスタブURI<code>’#’</code>にしておきます。第3引数はオプションハッシュで、この場合はサンプルアプリのリンクでCSSのid <code>logo</code>を指定しています (他の3つのリンクにはオプションハッシュが指定されていませんが、必須ではないので構いません)。Railsヘルパーは、このようにオプションのハッシュを取ることがよくあり、これによりRailsのコードから離れることなく任意のHTMLオプションを柔軟に追加することができます。</p>

<p>divの内側の2番目の要素は、<em>リストアイテム</em>タグ<code>li</code>と<em>順不同リスト</em>タグ<code>ul</code>によって作られた、ナビゲーションリンクのリストです。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;nav&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</pre></div>
</div>


<p>正式にはここでは不要ですが、<code>nav</code>タグはその内側がナビゲーションリンクであるという意図を伝える役割があります。<code>ul</code>タグの<code>nav</code>と<code>pull-right</code>クラスは、Bootstrapにおいて特別な意味を持ちます。ひとたびRailsがこのレイアウトを処理し、埋め込みRubyを評価すると、上のリストは以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;nav&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Help<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Sign in<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/nav&gt;</span>
</pre></div>
</div>


<p>レイアウトの最後の部分は、メインコンテンツ用の<code>div</code>です。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>前述のように、<code>container</code>クラスはBootstrapにおいて特別な意味を持ちます。<a class="ref" href="#sec-layouts">3.3.4</a>で学んだように、<code>yield</code>メソッドはWebサイトのレイアウトにページごとの内容を挿入します。</p>

<p><a class="ref" href="#sec-partials">5.1.3</a>で追加するサイトフッターを除いて、これでレイアウトは完成しました。Homeページへアクセスして表示結果を確認することができます。今後登場するスタイル要素を利用できるようにするために、<code>home.html.erb</code>ビューに特別な要素をいくつか追加します(<a class="ref" href="#code-signup_button">リスト5.2</a>)。</p>

<div class="label" id="code-signup_button"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.2</span> <span class="description">ログインページへのリンクがあるHomeページ。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;center hero-unit&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;h2&gt;</span>
    This is the home page for the
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    sample application.
  <span class="nt">&lt;/h2&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;rails.png&quot;</span><span class="p">,</span> <span class="ss">alt:</span> <span class="s2">&quot;Rails&quot;</span><span class="p">),</span> <span class="s1">&#39;http://rubyonrails.org/&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#cha-sign-up">第7章</a>でサイトにユーザーを追加するときに備えて、最初の<code>link_to</code>に仮のリンクを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span><span class="nt">&gt;</span>Sign up now!<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>


<p><code>div</code>タグのCSSクラス<code>hero-unit</code>は、signupボタンの<code>btn</code>クラス、<code>btn-large</code>クラス、<code>btn-primary</code>クラスと同様、Bootstrapにおいて特別な意味を持ちます。</p>

<p>2番目の<code>link_to</code>では、引数として画像ファイルのパスと任意のオプションハッシュをとる<code>image_tag</code>ヘルパーの能力が示されています。シンボルを使用して、この場合は<code>alt</code>属性を設定しています。わかりやすくするために、このタグによって生成されるHTMLを以下に示しました<sup class="footnote" id="fnref-5_4"><a href="#fn-5_4">4</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;img</span> <span class="na">alt=</span><span class="s">&quot;Rails&quot;</span> <span class="na">src=</span><span class="s">&quot;/assets/rails.png&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p><code>alt</code>属性は、画像がない場合に代わりに表示される文字列です。また、視覚障がいのあるユーザーが使用するスクリーンリーダーでは、この属性が読み上げられてそこに画像があることが示されます。HTML標準では実際に要求されているにも関わらず、画像に<code>alt</code>属性を付けていない手抜きのWebサイトをときどき見かけます。Railsでは幸いにも、この属性を指定せずに<code>image_tag</code>を呼び出した場合は、画像ファイル名 (拡張子を除く) をデフォルトの<code>alt</code>属性として自動的に付加してくれます。なお、今回は (先頭が大文字の) &quot;Rails&quot;とするために<code>alt</code>テキストを明示的に設定しています。</p>

<p>いよいよ、ここまでの労働の成果を確認する準備ができました (<a class="ref" href="#fig-layout_no_logo_or_custom_css">図5.2</a>)。思っていたよりもみすぼらしいでしょうか? 確かにそうですね。しかし、HTML要素に実用的なクラスを与えるという良い仕事ができたのも確かです。さらに、クラスを与えたこの段階で、CSSを使用してサイトにスタイルを与えることができたのは、タイミングとして非常に適切であると思います。</p>

<p>ところで、<code>rails.png</code>画像が実際に表示されていることに気付いて驚いたかもしれません。この画像はどこから来たのでしょうか。実は、この画像は新しいRailsアプリケーションには必ず無償で含まれており、<code>app/assets/images/rails.png</code>に置かれています。<code>image_tag</code>ヘルパーを使用したことにより、Railsはアセットパイプライン (<a class="ref" href="#sec-sass_and_the_asset_pipeline">5.2</a>) を使用してこの画像を自動的に見つけます。</p>

<div class="label" id="fig-layout_no_logo_or_custom_css"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/layout_no_logo_or_custom_css_bootstrap.png" alt="layout_no_logo_or_custom_css_bootstrap" /></span></div><div class="caption"><span class="header">図5.2</span>カスタムCSSを使用していない<span class="description">Homeページ (<a href="http://localhost:3000/static_pages/home">/static_pages/home</a>)。<a href="http://railstutorial.org/images/figures/layout_no_logo_or_custom_css_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-custom_css"></div>


<h3><a id="sec-5_1_2" href="#sec-custom_css" class="heading"><span class="number">5.1.2</span>BootstrapとカスタムCSS</a></h3>


<p><a class="ref" href="#sec-adding_to_the_layout">5.1.1</a>では、多くのHTML要素にCSSクラスを関連付けました。こうしておくことで、CSSベースでレイアウトを構成する際に高い柔軟性を与えてくれます。<a class="ref" href="#sec-adding_to_the_layout">5.1.1</a>で述べたように、これらのクラスの多くは、Twitterが作成したフレームワークである<a href="http://twitter.github.com/bootstrap/">Bootstrap</a>特有のものです。Bootstrapを使用すると、洗練されたWebデザインとユーザーインターフェイス要素を簡単にHTML5アプリケーションに追加することができます。この節では、サンプルアプリケーションにスタイルを追加するために、カスタムCSSルールとBootstrapを組み合わせて使用します。</p>

<p>最初に、<a class="ref" href="#code-bootstrap_sass">リスト5.3</a>で示しているようにBootstrapを追加しましょう。これは、<tt>bootstrap-sass</tt> gemを使用してRailsアプリケーションに導入できます。Bootstrapフレームワークでは、動的なスタイルシートを生成するために<a href="http://lesscss.org/">LESS CSS</a>言語を使用していますが、Railsのアセットパイプラインはデフォルトでは (LESSと非常によく似た) Sass言語をサポートします (<a class="ref" href="#sec-sass_and_the_asset_pipeline">5.2</a>)。そのため、<tt>bootstrap-sass</tt>は、LESSをSassへ変換し、必要なBootstrapファイルが現在のアプリケーションですべて利用できるようにします<sup class="footnote" id="fnref-5_5"><a href="#fn-5_5">5</a></sup>。</p>

<div class="label" id="code-bootstrap_sass"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.3</span> <span class="description"><code>Gemfile</code>へ<tt>bootstrap-sass</tt>を追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>いつものように<code>bundle install</code>を実行して、Bootstrapをインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>次に、開発中のアプリケーションに変更を反映するために、Webサーバーを再起動します (ほとんどのシステムでは、最初に<tt>Ctrl-C</tt>を押下してサーバを停止し、次に<code>rails server</code>コマンドを実行することでサーバーを再起動できます)。</p>

<p>アプリケーションにカスタムCSSを追加するための第一段階として、カスタムCSSを格納するための以下のファイルを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="go">app/assets/stylesheets/custom.css.scss</span>
</pre></div>
</div>


<p>(テキストエディタかIDEで新しいファイルを作成してください)。 このディレクトリ名とファイル名は、どちらも重要です。以下のディレクトリは、</p>

<div class="code"><div class="highlight"><pre><span class="go">app/assets/stylesheets</span>
</pre></div>
</div>


<p>アセットパイプライン(<a class="ref" href="#sec-sass_and_the_asset_pipeline">5.2</a>)の一部であり、このディレクトリに置かれたスタイルシートは<code>application.css</code>の一部として自動的にサイトレイアウトにインクルードされます。さらに、ファイル名の<code>custom.css.scss</code>には<code>.css</code>という拡張子も含まれているので、このファイルはCSSファイルであることが示されています。また、<code>.scss</code>という拡張子も含まれているので、 このファイルはSassを記述できるCSSファイル (Sassy CSS: Scss) であることも示されており、アセットパイプラインはこれを見てSassを処理できるようにします (Sassは<a class="ref" href="#sec-sass">5.2.2</a>まで登場しませんが、<tt>bootstrap-sass</tt> gemが動作するためのおまじないとして必要です)。</p>

<p>カスタムCSS用のファイルを作成したら、<a href="#code-bootstrap_css" class="ref">リスト5.4</a>のように<code>@import</code>を使用してBootstrapをインクルードします。</p>

<div class="label" id="code-bootstrap_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.4</span> <span class="description">Bootstrap CSSを追加する。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#fig-sample_app_only_bootstrap">図5.3</a>の結果で示されるように、このひとつの行にBootstrapフレームワーク全体が含まれます。(場合によっては、<tt>Ctrl-C</tt>を使用してローカルのWebサーバーを再起動する必要があるかもしれません。また、スクリーンショットではBootstrap 2.0を使用していますが、このチュートリアルではBootstrap 2.1を使用しているために、おそらく見た目に多少の違いが生じている可能性があることをご了承ください。これらについて心配する必要はありません。) さて、テキストの配置は今ひとつで、ロゴにはスタイルもありませんが、色使いとsignupボタンはなかなかよい感じになってきました。</p>

<div class="label" id="fig-sample_app_only_bootstrap"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sample_app_only_bootstrap.png" alt="sample_app_only_bootstrap" /></span></div><div class="caption"><span class="header">図5.3</span><span class="description">Bootstrap CSSとサンプルアプリケーション。<a href="http://railstutorial.org/images/figures/sample_app_only_bootstrap-full.png">(拡大)</a></span></div></div>


<p>次に、<a class="ref" href="#code-universal_css">リスト5.5</a>に示したように、Webサイト全体にわたってレイアウトと個別のページにスタイルを与えるためのCSSを追加します。<a class="ref" href="#code-universal_css">リスト5.5</a>には多数の記述ルールがあります。CSSの記述ルールを把握するためには、関心のある箇所をコメントアウトして表示を確認することをお勧めします。CSSでは、<code>/* … */</code>でコメントアウトできるので、調べてみたいコードをこれでコラム 、表示がどのように変わるかを確認してみてください。<a class="ref" href="#code-universal_css">リスト5.5</a>が反映された結果を<a class="ref" href="#fig-sample_app_universal">図5.4</a>に示します。</p>

<div class="label" id="code-universal_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.5</span> <span class="description">すべてのページに適用される共通のスタイルをCSSに追加する。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>

<span class="cm">/* universal */</span>

<span class="nt">html</span> <span class="p">{</span>
  <span class="na">overflow-y</span><span class="o">:</span> <span class="no">scroll</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">section</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">textarea</span> <span class="p">{</span>
  <span class="na">resize</span><span class="o">:</span> <span class="n">vertical</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="nt">h1</span> <span class="p">{</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-sample_app_universal"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sample_app_universal.png" alt="sample_app_universal" /></span></div><div class="caption"><span class="header">図5.4</span><span class="description">スペースや共通スタイルを追加した結果。<a href="http://railstutorial.org/images/figures/sample_app_universal-full.png">(拡大)</a></span></div></div>


<p><a href="#code-universal_css" class="ref">リスト5.5</a>のCSSの形式は一貫しています。CSSルールでは一般に、クラス、id、HTMLタグ、またはそれらの組み合わせ、のいずれかを指定します。そしてその後ろにスタイリングコマンドのリストを記述します。たとえば、以下のコードでは、</p>

<div class="code"><div class="highlight"><pre><span class="nt">body</span> <span class="p">{</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>ページ上部に60ピクセルの余白を追加します。<code>header</code>タグに<code>navbar-fixed-top</code>クラスが与えられているので、これに従ってBootstrapはナビゲーションバーをページ上部に固定し、ナビゲーションバーの下に余白を置いて主要部分から分離します (デフォルトのnavbarの色は、Bootstrap 2.0から2.1に変わったときに変更されたため、現在の淡色の代わりにダークな色調にしたい場合は<code>navbar-inverse</code>クラスを使用する必要があります)。また、このルールにある以下のCSSは、</p>

<div class="code"><div class="highlight"><pre><span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p><code>center</code>クラスに<code>text-align: center</code>プロパティを関連付けています。言い換えると、<code>.center</code>冒頭のドット<code>.</code>は、このルールがクラスに対してスタイルを適用することを示しています。(冒頭がポンド記号<code>#</code>の場合は、<a class="ref" href="#code-logo_css">リスト5.7</a>に示したように、そのルールがCSS <em>id</em>に対してスタイルを適用することを示します。この場合、<code>center</code>クラスに属している (<code>div</code>などの) タグの内側にある要素は、すべてページ中でセンタリングされることを意味しています (このクラスの例は<a class="ref" href="#code-signup_button">リスト5.2</a>で参照できます)。</p>

<p>Bootstrapには洗練されたタイポグラフィーを利用できるCSSルールがありますが、ここではさらに、<a class="ref" href="#code-typography_css">リスト5.6</a>に示したようにサイトのテキストの外観を変えるカスタムCSSルールを追加しましょう。(これらのルールはHomeページですべて適用されるとは限りませんが、サンプルアプリケーションの他の場所でも使用されるものもあります)。<a class="ref" href="#code-typography_css">リスト5.6</a>を反映した結果を<a class="ref" href="#fig-sample_app_typography">図5.5</a>で確認することができます。</p>

<div class="label" id="code-typography_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.6</span> <span class="description">洗練されたタイポグラフィーを利用するためのCSSを追加する。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">typography</span> <span class="o">*/</span>

<span class="nt">h1</span><span class="o">,</span> <span class="nt">h2</span><span class="o">,</span> <span class="nt">h3</span><span class="o">,</span> <span class="nt">h4</span><span class="o">,</span> <span class="nt">h5</span><span class="o">,</span> <span class="nt">h6</span> <span class="p">{</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">3</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-2</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h2</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">normal</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">p</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-sample_app_typography"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sample_app_typography.png" alt="sample_app_typography" /></span></div><div class="caption"><span class="header">図5.5</span><span class="description">タイポグラフィースタイルを追加する。<a href="http://railstutorial.org/images/figures/sample_app_typography-full.png">(拡大)</a></span></div></div>


<p>最後に、いくつかのルールをサイトロゴに追加します。このサイトロゴは「sample app」だけが表示されているシンプルなものです。<a class="ref" href="#code-logo_css">リスト5.7</a>のCSSは、テキストを大文字に変換し、サイズ、色、配置を変更します (サイトロゴがページで一度しか使用されないことを前提としてCSS idを使用していますが、代わりにクラスを使用することもできます)。</p>

<div class="label" id="code-logo_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.7</span> <span class="description">サイトロゴにCSSを追加する。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">header</span> <span class="o">*/</span>

<span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nn">#logo</span><span class="nd">:hover</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>上のコードの<code>color: #fff</code>は、ロゴの色を白に変更します。HTMLの色は、16進数 (基数が16) の3つの数値の組み合わせで表現され、赤、緑、青の三原色に (この順序で) コード化することができます。このコード<code>#ffffff</code>は、3色すべてが最大に使用されており、純白になります。なお、<code>#fff</code>は、完全な<code>#ffffff</code>の短縮形です。CSS標準には、共通<a href="http://www.w3schools.com/html/html_colornames.asp">HTMLカラー</a>の別名も多数定義されています。たとえば、<code>#fff</code>を<code>white</code>と書くこともできます。<a href="#code-logo_css" class="ref">リスト5.7</a>のCSSの結果は<a href="#fig-sample_app_logo" class="ref">図5.6</a>で確認できます。</p>

<div class="label" id="fig-sample_app_logo"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sample_app_logo.png" alt="sample_app_logo" /></span></div><div class="caption"><span class="header">図5.6</span><span class="description">デザインされたロゴとサンプルアプリ。<a href="http://railstutorial.org/images/figures/sample_app_logo-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-partials"></div>


<h3><a id="sec-5_1_3" href="#sec-partials" class="heading"><span class="number">5.1.3</span>パーシャル (partial)</a></h3>


<p><a class="ref" href="#code-layout_new_structure">リスト5.1</a>のレイアウトはその目的を果たしていますが、少々散らかっています。HTML shimは、それだけで3行も占有し、風変わりなIE特有の文法を使用しているので、これをうまく隠すことができたらどんなによいでしょう。また、HTMLヘッダーは論理的な単位を形成するため、一箇所にまとめる必要もあります。Railsでは、<em>パーシャル (partial)</em> と呼ばれる機能を使用してこれを実現することができます。最初に、パーシャルを定義するとレイアウトがどのように変わるかを見てみましょう (<a class="ref" href="#code-layout_with_partials">リスト5.8</a>)。</p>

<div class="label" id="code-layout_with_partials"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.8</span> <span class="description">Webサイトのレイアウトにスタイルシート用とヘッダー用のパーシャルをそれぞれ追加する。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">media:</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/shim&#39;</span> <span class="cp">%&gt;</span>    
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-layout_with_partials">リスト5.8</a>では、以下のように<code>render</code>と呼ばれるRailsヘルパー呼び出しだけを使って、HTML shimのスタイルシート行を置換しています。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/shim&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>この行では、<code>app/views/layouts/_shim.html.erb</code>というファイルを探してその内容を評価し、結果をビューのその場所に挿入しています<sup class="footnote" id="fnref-5_6"><a href="#fn-5_6">6</a></sup>  (<tt class="verb">&lt;%= ... %&gt;</tt>は、テンプレート内でRubyの式を評価するための埋め込みRuby記法であることを思い出してください。評価した結果がテンプレートに挿入されます)。ファイル名<code>_shim.html.erb</code>の前のアンダースコアにご注目ください。このアンダースコアは、パーシャルで使用する普遍的な命名規約であり、また、一目見ただけでディレクトリ中のすべてのパーシャルを識別することが可能になります。</p>

<p>もちろん、パーシャルが動作するためには、その中にコンテンツを記述しなければなりません。このshimパーシャルの場合は、<a class="ref" href="#code-layout_new_structure">リスト5.1</a>のわずか3行のshimコードだけです。追加した結果を<a class="ref" href="#code-stylesheets_partial">リスト5.9</a>に示します。</p>

<div class="label" id="code-stylesheets_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.9</span> <span class="description">HTML shim用のパーシャル。</span><br /><span class="description"> <code>app/views/layouts/_shim.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="c">&lt;!--[if lt IE 9]&gt;</span>
<span class="c">&lt;script src=&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot;&gt;&lt;/script&gt;</span>
<span class="c">&lt;![endif]</span><span class="c">--&gt;</span>
</pre></div>
</div></div>


<p>同様に、他のヘッダーの情報も<a class="ref" href="#code-header_partial">リスト5.10</a>のパーシャルに移動し、<code>render</code>を呼び出してレイアウトに挿入することができます。</p>

<div class="label" id="code-header_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.10</span> <span class="description">サイトヘッダー用のパーシャル。</span><br /><span class="description"> <code>app/views/layouts/_header.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>これでパーシャルの作成方法がわかりましたので、今度はヘッダーに対応するフッタを同じ方法で追加しましょう。ここまでくれば、ファイル名は<code>_footer.html.erb</code>で、layoutsディレクトリ (<a class="ref" href="#code-footer_partial">リスト5.11</a>) に置くということが皆様にもわかると思います<sup class="footnote" id="fnref-5_7"><a href="#fn-5_7">7</a></sup>。</p>

<div class="label" id="code-footer_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.11</span> <span class="description">サイトフッタ用のパーシャル。</span><br /><span class="description"> <code>app/views/layouts/_footer.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">&quot;footer&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;small&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    by Michael Hartl
  <span class="nt">&lt;/small&gt;</span>
  <span class="nt">&lt;nav&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span>   <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Contact&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://news.railstutorial.org/&quot;</span><span class="nt">&gt;</span>News<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</pre></div>
</div></div>


<p>ヘッダーの場合と同様に、フッタの中でも<code>link_to</code>メソッドを使用して、AboutページとContactページへの内部リンクを追加してあります。ひとまず、リンク先のURIは<code>’#’</code>としておきます (<code>header</code>タグと同様、<code>footer</code>タグもHTML5で新たに追加された要素です)。</p>

<p>フッタパーシャルは、スタイルシートやヘッダーパーシャルのときと同じ方法でレイアウト中に追加できます (<a class="ref" href="#code-layout_with_footer">リスト5.12</a>)。</p>

<div class="label" id="code-layout_with_footer"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.12</span> <span class="description">サイトのレイアウトにフッタパーシャルを追加する。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">full_title</span><span class="p">(</span><span class="k">yield</span><span class="p">(</span><span class="ss">:title</span><span class="p">))</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">stylesheet_link_tag</span>    <span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="ss">media:</span> <span class="s2">&quot;all&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="s2">&quot;application&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tags</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/shim&#39;</span> <span class="cp">%&gt;</span>    
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>そのまま実際にフッタを表示してみるとどうにも見苦しいので、<a class="ref" href="#code-footer_css">リスト5.13</a>でスタイルを若干追加しましょう。スタイルを追加した結果を<a class="ref" href="#fig-site_with_footer">図5.7</a>に示します。</p>

<div class="label" id="code-footer_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.13</span> <span class="description">サイトのフッタ用CSSを追加する。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">footer</span> <span class="o">*/</span>

<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#eaeaea</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">a</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#555</span><span class="p">;</span>
<span class="p">}</span>  

<span class="nt">footer</span> <span class="nt">a</span><span class="nd">:hover</span> <span class="p">{</span> 
  <span class="na">color</span><span class="o">:</span> <span class="mh">#222</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">small</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">ul</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">right</span><span class="p">;</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">footer</span> <span class="nt">ul</span> <span class="nt">li</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-left</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-site_with_footer"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/site_with_footer_bootstrap.png" alt="site_with_footer_bootstrap" /></span></div><div class="caption"><span class="header">図5.7</span><span class="description">Homeページ (<a href="http://localhost:3000/static_pages/home">/static_pages/home</a>) にフッタを追加する。<a href="http://railstutorial.org/images/figures/site_with_footer_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-sass_and_the_asset_pipeline"></div>


<h2><a id="sec-5_2" href="#sec-sass_and_the_asset_pipeline" class="heading"><span class="number">5.2</span>Sass と アセットパイプライン</a></h2>


<p>Rails 3.0と、その後のバージョンの最も大きな違いの1つは、CSS、JavaScript、画像などの静的コンテンツの生産と管理を大幅に強化する「アセットパイプライン」です。この節では、アセットパイプラインの高度な概要と、アセットパイプラインの一部としてデフォルトで含まれている、<em>Sass</em>と呼ばれる素晴らしいCSS生成ツールの使い方について説明します。</p>

<div class="label" id="sec-the_asset_pipeline"></div>


<h3><a id="sec-5_2_1" href="#sec-the_asset_pipeline" class="heading"><span class="number">5.2.1</span> アセットパイプライン</a></h3>


<p>アセットパイプラインは、Railsの流儀を守りながら多大な変化をもたらしますが、一般的なRails開発者の視点からは、アセットディレクトリ、マニフェストファイル、プリプロセッサエンジンという、3つの主要な機能が理解の対象となります<sup class="footnote" id="fnref-5_8"><a href="#fn-5_8">8</a></sup>。では、それぞれを順に見ていきましょう。</p>

<h4><a id="sec-5_2_1_1" href="#sec-5_2_1_1" class="heading">アセットディレクトリ</a></h4>


<p>Rails 3.0以前のバージョンでは、静的ファイルは<code>public/</code>以下の次のディレクトリに置かれていました。</p>

<ul>
<li><code>public/stylesheets</code></li>
<li><code>public/javascripts</code></li>
<li><code>public/images</code></li>
</ul>


<p>これらのディレクトリ中のファイルは、http://example.com/stylesheetsのようなリクエストによって自動的に配信されます。これは3.0以降も同様です。</p>

<p>Rails 3.1からは、静的ファイルを目的別に分類する、標準的な<em>3つの</em>ディレクトリが使用されるようになりました。</p>

<ul>
<li><code>app/assets</code>: 現在のアプリケーション固有のアセット</li>
<li><code>lib/assets</code>: あなたの開発チームによって作成されたライブラリ用のアセット</li>
<li><code>vendor/assets</code>: サードパーティのアセット</li>
</ul>


<p>これらのディレクトリには、それぞれのアセットクラス用のサブディレクトリがあります。たとえば、app/assetsには次のようなサブディレクトリがあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> ls app/assets/
<span class="go">images      javascripts stylesheets</span>
</pre></div>
</div>


<p>上記の説明から、<a class="ref" href="#sec-custom_css">5.1.2</a>で取り上げた<code>custom.css.scss</code>が配置された場所と、その理由について理解することができると思います。<code>custom.css.scss</code>は、サンプルアプリケーション固有のアセットなので、<code>app/assets/stylesheets</code>に配置されているのです。</p>

<h4><a id="sec-5_2_1_2" href="#sec-5_2_1_2" class="heading">マニフェストファイル</a></h4>


<p>アセットを上記の論理的な場所へ配置すれば、<em>マニフェストファイル</em>を使用して、それらをどのように1つのファイルにまとめるのかをRailsに指示することができます。なお、実際にまとめるのは<a href="https://github.com/sstephenson/sprockets">Sprockets</a> gemが行います。(マニフェストファイルはCSSとJavaScriptには適用されますが、画像ファイルには適用されません) 。1つの例として、アプリケーションスタイルシート用のマニフェストファイルを見てみましょう (<a href="#code-app_css_manifest" class="ref">リスト5.14</a>)。</p>

<div class="label" id="code-app_css_manifest"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.14.</span> <span class="description">アプリケーション固有のCSS用マニフェストファイル。</span><br /><span class="description"> <code>app/assets/stylesheets/application.css</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This is a manifest file that&#39;ll automatically include all the stylesheets</span>
<span class="cm"> * available in this directory and any sub-directories. </span><span class="cm">You&#39;re free to add</span>
<span class="cm"> * application-wide styles to this file and they&#39;ll appear at the top of the</span>
<span class="cm"> * compiled file, but it&#39;s generally better to create a new file per style </span>
<span class="cm"> * scope.</span>
<span class="cm"> *= require_self</span>
<span class="cm"> *= require_tree . </span>
<span class="cm">*/</span>
</pre></div>
</div></div>


<p>上の行で重要な部分は実はCSSコメントの中にあります。以下の行は、適切なファイルをインクルードするためにSprocketsによって使用されます。</p>

<div class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> .</span>
<span class="cm"> .</span>
<span class="cm"> .</span>
<span class="cm"> *= require_self</span>
<span class="cm"> *= require_tree . </span>
<span class="cm">*/</span>
</pre></div>
</div>


<p>以下の行は、</p>

<div class="code"><div class="highlight"><pre><span class="go">*= require_tree .</span>
</pre></div>
</div>


<p><code>app/assets/stylesheets</code>ディレクトリ (サブディレクトリを含む) のすべてのCSSファイルをアプリケーションCSSにインクルードするようにします (このドットも必要です)。以下の行は、</p>

<div class="code"><div class="highlight"><pre><span class="go">*= require_self</span>
</pre></div>
</div>


<p><code>application.css</code>自身をもインクルードすることを指示します。</p>

<p>Railsには実用的なデフォルトのマニフェストファイルが付属しているので、<em>Railsチュートリアル</em>では変更を加える必要がありませんが、もし必要な場合は、Rails Guideの「<a href="http://guides.rubyonrails.org/asset_pipeline.html">アセットパイプラインの解説</a> (英語)」で詳細な情報を参照できます。</p>

<h4><a id="sec-5_2_1_3" href="#sec-5_2_1_3" class="heading">プリプロセッサエンジン</a></h4>


<p>必要なアセットをディレクトリに配置してまとめた後、Railsはさまざまなプリプロセッサエンジンを介してそれらを実行し、ブラウザに配信できるようにそれらをマニフェストファイルを用いて結合し、サイトテンプレート用に準備します。Railsは、どのプリプロセッサを使用するかを、ファイル名の拡張子を使用して判断します。最も一般的な拡張子は、Sass用の<code>.scss</code>、CoffeeScript用の<code>.coffee</code>、埋め込みRuby (ERb) 用の<code>.erb</code>です。<a class="ref" href="#sec-embedded_ruby">3.3.3</a>では最初にERbを、<a class="ref" href="#sec-sass">5.2.2</a>ではSassをそれぞれ扱いました。 なお本書では扱いませんが、CoffeeScriptはエレガントで簡潔な言語で、JavaScriptにコンパイルして実行します (興味のある方は、RailsCastの「<a href="http://railscasts.com/episodes/267-coffeescript-basics">CoffeeScriptの基礎</a> (英語)」から始めると良いでしょう)。</p>

<p>プリプロセッサエンジンはつなげて実行する (chain) ことができます。</p>

<p><code>foobar.js.coffee</code></p>

<p>上の拡張子の場合、CoffeeScriptプロセッサ経由で実行されます。</p>

<p><code>foobar.js.erb.coffee</code></p>

<p>上の拡張子の場合は、CoffeeScriptとERbの両方で実行されます (コードは右から左へと実行されますので、この例ではCoffeeScriptが最初に実行されます)。</p>

<h4><a id="sec-5_2_1_4" href="#sec-5_2_1_4" class="heading">本番環境での効率性</a></h4>


<p>アセットパイプラインの最大のメリットの1つは、本番のアプリケーションで効率的になるように最適化されたアセットも自動的に生成されることです。従来は、CSSとJavaScriptを整理するために、機能を個別のファイルに分割し、(インデントを多用して) 読みやすいフォーマットに整えていました。これは、プログラマにとっては便利な方法ですが、本番環境にとっては非効率です。それというのも、拡大のCSSやJavaScriptファイルを多数インクルードすると、ページの読み込み時間が著しく遅くなるからです (読み込み時間は、ユーザ体験の質に影響を与える重要な指標の1つです)。一方、アセットパイプラインでは、本番環境に最適化するために、すべてのスタイルシートを1つのCSSファイル (<code>application.css</code>) にまとめ、すべてのJavaScriptファイルを1つのJSファイル (<code>javascripts.js</code>) にまとめてくれます。さらに、それらのファイルすべてに対して (<code>lib/assets</code>や<code>vendor/assets</code>のファイルも含め) 不要な空白を取り除く処理を行い、ファイルサイズを<em>最小化</em>してくれます。これにより、アセットパイプラインは、2つの異なった状況に対してそれぞれ最高の環境を提供してくれます。つまり、プログラマーに対しては見やすく分割されたフォーマットのファイルを提供し、本番環境に対しては最適化された1つのファイルを提供してくれます。</p>

<div class="label" id="sec-sass"></div>


<h3><a id="sec-5_2_2" href="#sec-sass" class="heading"><span class="number">5.2.2</span>素晴らしい構文を備えたスタイルシート</a></h3>


<p><em>Sass</em> は、スタイルシートを記述するための言語であり、CSSに比べて多くの点が強化されています。この節では、Sassが提供する2つの重要な機能である<em>ネスト</em>と<em>変数</em>について説明します (3つ目の重要な機能である<em>ミックスイン</em>については、<a class="ref" href="#sec-rails_environments">7.1.1</a>で紹介します)。</p>

<p><a class="ref" href="#sec-custom_css">5.1.2</a>でも簡単に説明しましたが、SassはSCSSというフォーマットに対応しています (<code>.scss</code>という拡張子はSCSSをであることを表します)。SCSSは、CSSの機能をすべて包含する、厳密なスーパーセットです。つまり、SCSSはCSSに新しい機能を<em>追加</em>しただけで、まったく新しい構文を定義したものではありません<sup class="footnote" id="fnref-5_9"><a href="#fn-5_9">9</a></sup>。このため、有効なCSSファイルは、すべてSCSSファイルとしても扱うことができ、既存の記法ルールを使用しているプロジェクトにとっても互換性のある便利なフォーマットになっています。本書の例では、Bootstrapの恩恵を得るために、最初からSCSSを使用してきました。Railsのアセットパイプラインは、<code>.scss</code>という拡張子を持つファイルをSassを使って自動的に処理してくれます。このため、<code>custom.css.scss</code>ファイルはSassプリプロセッサによって前処理され、その後ブラウザでの配信に備えてパッケージ化されます。</p>

<h4><a id="sec-5_2_2_1" href="#sec-5_2_2_1" class="heading">ネスト</a></h4>


<p>スタイルシート内に共通のパターンがある場合は、要素をネストさせることができます。たとえば、<a class="ref" href="#code-universal_css">リスト 5.5</a>では、以下のように<code>.center</code>と<code>.center h1</code>の両方に対してルールがあります。</p>

<div class="code"><div class="highlight"><pre><span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="nt">h1</span> <span class="p">{</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>上のルールは、Sassを使用して以下のように書き換えることができます。</p>

<div class="code"><div class="highlight"><pre><span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="nt">h1</span> <span class="p">{</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>  
<span class="p">}</span>
</pre></div>
</div>


<p>上の例では、ネストの内側にある<code>h1</code>というルールは、<code>.center</code>のルールを継承しています。</p>

<p>今度は、もう少し異なるルールに対してネスト機能を使う例を見てみましょう。<a class="ref" href="#code-logo_css">リスト 5.7</a>には以下のコードがあります。</p>

<div class="code"><div class="highlight"><pre><span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nn">#logo</span><span class="nd">:hover</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>上のコードには<code>#logo</code>というidが2回使用されています。1回目はロゴ自身を定義するために、2回目は<code>hover</code>属性を定義するために使用されています (なおhover属性は、該当する要素の上にマウスポインタをかざしたときの表示を定義します)。2つ目のルールをネストするためには、親属性である<code>#logo</code>を参照する必要があります。このような場合、SCSSでは以下のようにアンパーサンド<code>&amp;</code>を使って実現できます。</p>

<div class="code"><div class="highlight"><pre><span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="mh">#fff</span><span class="p">;</span>
    <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>


<p>Sassは、SCSSをCSSに変換する際に、<code>&amp;:hover</code>を <code>#logo:hover</code>に置換します。</p>

<p>これらのネスト機能は、フッターのCSSでも使用できます。<a class="ref" href="#code-footer_css">リスト5.13</a>のコードは、SCSSを使用して以下のように書き換えることができます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">footer</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#eaeaea</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="mh">#555</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span> 
      <span class="na">color</span><span class="o">:</span> <span class="mh">#222</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>  
  <span class="nt">small</span> <span class="p">{</span> 
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span> 
  <span class="p">}</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">right</span><span class="p">;</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="nt">li</span> <span class="p">{</span>
      <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">margin-left</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>


<p><a class="ref" href="#code-footer_css">リスト 5.13</a>を手作業で変換してみることは、良い演習になります。変換後にもCSSが適切に動作していることを確認してみましょう。</p>

<h4><a id="sec-5_2_2_2" href="#sec-5_2_2_2" class="heading">変数</a></h4>


<p>Sassでは、冗長なコードを削除し、より自由な表現を可能にするために、<em>変数</em>が定義できるようになっています。たとえば、<a class="ref" href="#code-typography_css">リスト 5.6</a>や<a class="ref" href="#code-footer_css">リスト 5.13</a>を見てみると、同じ色を繰り返し参照している箇所があります。</p>

<div class="code"><div class="highlight"><pre><span class="nt">h2</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>上のコードの<code>#999</code>は薄い灰色を指しています。Sassでは、このような値を変数として定義し、以下のように変数名を与えることができます。</p>

<div class="code"><div class="highlight"><pre><span class="nv">$lightGray</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
</pre></div>
</div>


<p>この機能を使用して、SCSSを以下のように書き直すことができます。</p>

<div class="code"><div class="highlight"><pre><span class="nv">$lightGray</span><span class="o">:</span> <span class="mh">#999</span><span class="p">;</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">h2</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$lightGray</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$lightGray</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p><code>$lightGray</code>のような変数名は、<code>#999</code> のような値よりもわかりやすいので、たとえその変数が繰り返し使われないとしても、変数名を与えることは多くの場合有用です。実際、Bootstrapフレームワークでは、多くの色に対して変数名を定義しています。定義されている変数は「<a href="http://bootstrapdocs.com/v2.0.4/docs/less.html">Bootstrap page of LESS variables</a>」で参照することができます。このWebサイトでは、SassではなくLESSを使って変数が定義されていますが、<tt>bootstrap-sass</tt>というgemを使用すれば、Sassでも同様の変数が使えるようになります。LESSとSass の違いを想像するのはそれほど難しくありません。たとえば、LESSではアットマーク<code>@</code>を使用しているのに対して、Sassはドルマーク<code>$</code>を使っていることはすぐにわかります。話を戻して、Bootstrapの変数の一覧表を見ると、薄い灰色に対して以下のの変数名が与えられることに気が付きます。</p>

<div class="code"><div class="highlight"><pre> <span class="k">@grayLight</span><span class="nd">:</span> <span class="nn">#999</span><span class="o">;</span>
</pre></div>
</div>


<p>これは、<tt>bootstrap-sass</tt>というgemを使えば、SCSSでも同様に<code>$grayLight</code>という変数が使えることを意味しています。先ほど定義した<code>$lightGray</code>というカスタム変数に代わりに、用意された変数を使ってみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="nt">h2</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>今回取り上げたSassのネスト機能や変数機能を使ってSCSSファイルを全面的に書き直すと、<a class="ref" href="#code-refactored_scss">リスト 5.15</a>のようになります。このリストでは、Sassの変数 (詳しくはBootstrap LESSの変数一覧を参考にしてください) や、組み込みの色変数 (たとえば<code>#fff</code>には<code>white</code> という変数) を使っています。<code>footer</code>タグのルールが、劇的に向上していることを確認してみてください。</p>

<div class="label" id="code-refactored_scss"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.15</span> <span class="description">ネストや変数を使って初期のSCSSファイルを書き直した結果。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$grayMediumLight</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="cm">/* universal */</span>

<span class="nt">html</span> <span class="p">{</span>
  <span class="na">overflow-y</span><span class="o">:</span> <span class="no">scroll</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="p">{</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">60</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">section</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">textarea</span> <span class="p">{</span>
  <span class="na">resize</span><span class="o">:</span> <span class="n">vertical</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.center</span> <span class="p">{</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="nt">h1</span> <span class="p">{</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* typography */</span>

<span class="nt">h1</span><span class="o">,</span> <span class="nt">h2</span><span class="o">,</span> <span class="nt">h3</span><span class="o">,</span> <span class="nt">h4</span><span class="o">,</span> <span class="nt">h5</span><span class="o">,</span> <span class="nt">h6</span> <span class="p">{</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">3</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-2</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h2</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">text-align</span><span class="o">:</span> <span class="no">center</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">normal</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">p</span> <span class="p">{</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.1</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* header */</span>

<span class="nn">#logo</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.7</span><span class="kt">em</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
  <span class="na">text-transform</span><span class="o">:</span> <span class="no">uppercase</span><span class="p">;</span>
  <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">9</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">font-weight</span><span class="o">:</span> <span class="no">bold</span><span class="p">;</span>
  <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
    <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* footer */</span>

<span class="nt">footer</span> <span class="p">{</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">padding-top</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayMediumLight</span><span class="p">;</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">color</span><span class="o">:</span> <span class="nv">$gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span> 
      <span class="na">color</span><span class="o">:</span> <span class="nv">$grayDarker</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>  
  <span class="nt">small</span> <span class="p">{</span> 
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span> 
  <span class="p">}</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">right</span><span class="p">;</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="nt">li</span> <span class="p">{</span>
      <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">margin-left</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>Sassを使ってスタイルシートをより簡単にする方法は他にもありますが、今回はその中でも最も重要な機能を使って<a class="ref" href="#code-refactored_scss">リスト 5.15</a>を書き直しました。Sassを使うことによって、素晴らしいスタートを切ることができました。Sassの詳細については、<a href="http://sass-lang.com/">Sass の公式サイト</a> (英語) を参照してください。</p>

<div class="label" id="sec-layout_links"></div>


<h2><a id="sec-5_3" href="#sec-layout_links" class="heading"><span class="number">5.3</span>レイアウトのリンク</a></h2>


<p>サイトのレイアウトが美しく仕上がりましたので、今度は<code>’#’</code>で代用していたリンクを書き換えてみましょう。もちろん、以下のようにリンクを直接記述することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/static_pages/about&quot;</span><span class="nt">&gt;</span>About<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>


<p>しかし、上の記法はRails流ではありません。まず、aboutページへのURIは/static_pages/aboutではなく/aboutの方がよいでしょう。さらに、Railsでは以下のようなコードでは<em>名前付きルート</em>を使用するのが慣例となっています。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span> <span class="n">about_path</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>上のようにすることでコードの意味がわかりやすくなり、<code>about_path</code>の定義を変えれば<code>about_path</code>が使用されているすべてのURIを変更できるため、柔軟性が高まります。</p>

<p>今後使用する計画のあるすべてのリンクのリストを、URIとルート (route) のマッピングと共に<a class="ref" href="#table-url_mapping">表5.1</a>に示します。この章の終わりまでに、最後のリンクを除き全て実装します。(最後のリンクは<a class="ref" href="#cha-sign-in-sign-out">第8章</a>で作成します。)</p>

<div class="label" id="table-url_mapping"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>ページ</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_right"><strong>名前付きルート</strong></th></tr><tr class="top_bar"><td class="align_left">Home</td><td class="align_left">/</td><td class="align_right"><code>root_path</code></td></tr><tr><td class="align_left">About</td><td class="align_left">/about</td><td class="align_right"><code>about_path</code></td></tr><tr><td class="align_left">Help</td><td class="align_left">/help</td><td class="align_right"><code>help_path</code></td></tr><tr><td class="align_left">Contact</td><td class="align_left">/contact</td><td class="align_right"><code>contact_path</code></td></tr><tr><td class="align_left">Sign up</td><td class="align_left">/signup</td><td class="align_right"><code>signup_path</code></td></tr><tr><td class="align_left">Sign in</td><td class="align_left">/signin</td><td class="align_right"><code>signin_path</code></td></tr></table></div><div class="caption"><span class="header">表 5.1</span><span class="description">サイトリンクのルート (routing) とURIのマッピング。</span></div></div>


<p>先に進む前にContactページを追加しましょう (これは<a class="ref" href="#cha-static-pages">第3章</a>の演習の積み残しです)。Contactページのテストを<a class="ref" href="#code-contact_page_test">リスト5.16</a>に示します。これは単に<a class="ref" href="#code-pages_controller_spec_title">リスト3.18</a>で使用されているテストのパターンに従ったものです。<a class="ref" href="#code-contact_page_test">リスト5.16</a>のアプリケーションコードでは、Ruby 1.9スタイルのハッシュに変更していることにご注意ください。</p>

<div class="label" id="code-contact_page_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.16</span> <span class="description">Contactページのテスト。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/contact&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="s1">&#39;/static_pages/contact&#39;</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Contact&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>以下のテストは失敗するはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>アプリケーションコードは、<a class="ref" href="#sec-adding_a_page">3.2.2</a>のAboutページへの追加と良く似ています。最初にルート (<a class="ref" href="#code-contact_route">リスト5.17</a>) を更新します。次に<code>contact</code>アクションをStaticPagesコントローラ (<a class="ref" href="#code-contact_action">リスト5.18</a>) に追加します。最後にContactビュー (<a class="ref" href="#code-contact_view">リスト5.19</a>) を作成します。</p>

<div class="label" id="code-contact_route"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.17</span> <span class="description">Contactページ用のルートを追加する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/home&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/help&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/about&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;static_pages/contact&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-contact_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.18</span> <span class="description">Contactページ用のアクションを追加する。</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">contact</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-contact_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.19</span> <span class="description">Contactページのビュー。</span><br /><span class="description"> <code>app/views/static_pages/contact.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Contact Ruby on Rails Tutorial about the sample app at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/contact&quot;</span><span class="nt">&gt;</span>contact page<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>今度はテストが成功することを確認してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>




<div class="label" id="sec-route_tests"></div>


<h3><a id="sec-5_3_1" href="#sec-route_tests" class="heading"><span class="number">5.3.1</span> ルートのテスト</a></h3>


<p>静的ページの結合テストを書いておいたので、ルートに対するテストはシンプルです。コードに直接書かれているアドレスを<a class="ref" href="#table-url_mapping">表5.1</a>にある名前付きルートにそれぞれ置き換えるだけです。つまり、以下のコードの場合、</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="s1">&#39;/static_pages/about&#39;</span>
</pre></div>
</div>


<p>上を以下のように変更します。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">about_path</span>
</pre></div>
</div>


<p>他のページについても同様に変更します。変更の結果を<a class="ref" href="#code-route_tests">リスト5.20</a>に示します。</p>

<div class="label" id="code-route_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.20</span> <span class="description">名前付きルートのテスト。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the base title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not have a custom page title&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">help_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Help&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">help_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Help&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;About&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;About Us&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">about_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | About Us&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">contact_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the title &#39;Contact&#39;&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">contact_path</span>
      <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                    <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Contact&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>いつもと同様に、今度のテストは赤色 (失敗) になるはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>ところで、もし<a class="ref" href="#code-route_tests">リスト5.20</a>が繰り返しが多く冗長だと感じたなら、それはあなただけはありません。この乱雑な状態を<a class="ref" href="#sec-pretty_rspec">5.3.4</a>で美しい宝石へとリファクタリングする予定です。</p>

<div class="label" id="sec-rails_routes"></div>


<h3><a id="sec-5_3_2" href="#sec-rails_routes" class="heading"><span class="number">5.3.2</span> Railsのルート</a></h3>


<p>URIに対するテストができあがったので、それらを実際に利用できるようにしましょう。<a class="ref" href="#sec-static_pages_with_rails">3.1.2</a>で説明したとおり、RailsがURIマッピングに使用するファイルは<code>config/routes.rb</code>です。デフォルトのルートファイルの内容を見てみると、かなり乱雑になっています。しかし、それらはすべてコメントアウトされたルートマッピングの例であり、必要な乱雑さです。時間のあるときにこのルートマッピングを読んでみることをお勧めします。また、より詳細なルーティングの扱いについてはRails Guidesの「<a href="http://guides.rubyonrails.org/routing.html">Railsにおける外部から内部へのルーティング</a> (英語)」を参照することをお勧めします。</p>

<p>名前付きルートを定義するため、以下のようなルールを置き換えます。</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;static_pages/help&#39;</span>
</pre></div>
</div>


<p>上のルーティングを下記のように置き換えます。</p>

<div class="code"><div class="highlight"><pre><span class="n">match</span> <span class="s1">&#39;/help&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#help&#39;</span>
</pre></div>
</div>


<p>このルーティングは、<code>/help</code>で有効なページと、そのページへのパスを返す<code>help_path</code>という名前の名前付きルートの両方を準備します (実際には、<code>match</code>の箇所に<code>get</code>を使用しても同じ名前付きルートになりますが、<code>match</code>を利用する方がよりRailsの慣例に従っています)。</p>

<p>このパターンを他の静的ページに適用すると、<a class="ref" href="#code-static_page_routes">リスト5.21</a>になります。唯一の例外は、<a class="ref" href="#code-root_route">リスト5.23</a>で取り扱うHomeページです。</p>

<div class="label" id="code-static_page_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.21</span> <span class="description">静的ページのルート。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">match</span> <span class="s1">&#39;/help&#39;</span><span class="p">,</span>    <span class="ss">to:</span> <span class="s1">&#39;static_pages#help&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span>   <span class="ss">to:</span> <span class="s1">&#39;static_pages#about&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/contact&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#contact&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-static_page_routes">リスト5.21</a>コードを注意深く読むことで、このコードの動作を理解できるでしょう。たとえば以下のコードの場合について説明します。</p>

<div class="code"><div class="highlight"><pre><span class="n">match</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#about&#39;</span>
</pre></div>
</div>


<p>上のコードは<code>’/about’</code>に一致し、それによってStaticPagesコントローラの<code>about</code>アクションにルーティングします。変更前の以下のコードは、より明示的でした。</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;static_pages/about&#39;</span>
</pre></div>
</div>


<p>このコードも同じページへたどり着きますが、<code>/about</code>の方が簡潔です。さらに前述したように、<code>match ’/about’</code>というコードは自動的にコントローラとビューで使用する<em>名前付きルート</em>を生成します。</p>

<div class="code"><div class="highlight"><pre><span class="n">about_path</span> <span class="o">=&gt;</span> <span class="s1">&#39;/about&#39;</span>
<span class="n">about_url</span>  <span class="o">=&gt;</span> <span class="s1">&#39;http://localhost:3000/about&#39;</span>
</pre></div>
</div>


<p><code>about_url</code>は<em>フル</em>URI http://localhost:3000/about であることにご注目ください (なお、<code>localhost:3000</code>は本番環境で<code>example.com</code>のようなドメイン名へ置き換えられます)。<a class="ref" href="#sec-layout_links">5.3</a>で説明したように、/about のみを取得する場合は <code>about_path</code>を使います。なお、<em>Railsチュートリアル</em>では、<code>path</code>書式を使用する一般的な規約に従い、リダイレクトの場合のみ<code>url</code>書式を使用します。これは、HTTP標準では技術的にリダイレクト後にフルURIが要求されるためです。ただし、ほとんどのブラウザではどちらの方法でも動作します。</p>

<p>ルーティングが定義されたので、Help、About、Contactページのテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>これでHomeページのテストが、失敗する最後のテストになります。</p>

<p>Homeページへのルートマッピングを作成する際に、以下のようなコードを使用<em>することも一応可能です</em>。</p>

<div class="code"><div class="highlight"><pre><span class="n">match</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#home&#39;</span>
</pre></div>
</div>


<p>しかし、実際にはルート (root) については上のように書く必要はありません。Railsでは、routesファイル (<a class="ref" href="#code-root_route_hint">リスト5.22</a>) の下の方のコメント内に、ルート(root) URI / (“スラッシュ”) 用の特別な記法が書かれています。</p>

<div class="label" id="code-root_route_hint"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.22</span> <span class="description">ルート (root) へのルーティングを定義する、コメント内のヒント。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># You can have the root of your site routed with &quot;root&quot;</span>
  <span class="c1"># just remember to delete public/index.html.</span>
  <span class="c1"># root :to =&gt; &quot;welcome#index&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-root_route_hint">リスト5.22</a>のコメントを参考に、<a class="ref" href="#code-root_route">リスト5.23</a>のようにルート (root) URI / をHomeページへルーティングします。</p>

<div class="label" id="code-root_route"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.23</span> <span class="description">ルート (root) へのルーティングのためのマッピングを追加する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">root</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#home&#39;</span>

  <span class="n">match</span> <span class="s1">&#39;/help&#39;</span><span class="p">,</span>    <span class="ss">to:</span> <span class="s1">&#39;static_pages#help&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span>   <span class="ss">to:</span> <span class="s1">&#39;static_pages#about&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/contact&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#contact&#39;</span>  
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードは、ルート (root) URIを/static_pages/homeに割り当て、URIヘルパーに以下のの設定を与えます。</p>

<div class="code"><div class="highlight"><pre><span class="n">root_path</span> <span class="o">=&gt;</span> <span class="s1">&#39;/&#39;</span>
<span class="n">root_url</span>  <span class="o">=&gt;</span> <span class="s1">&#39;http://localhost:3000/&#39;</span>
</pre></div>
</div>


<p><a class="ref" href="#code-root_route_hint">リスト5.22</a>の他のコメントの内容にもご注意ください。/にアクセスする際にRailsがデフォルトのページ (<a class="ref" href="#fig-riding_rails_31">図1.3</a>) を表示しないように、<code>public/index.html</code>を削除しておきます。もちろん、単にこのファイルを削除しても構いませんが、バージョン管理にGitを使用している場合は、<code>git rm</code>を使用することでファイル削除と同時にGitに削除を通知することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git rm public/index.html
</pre></div>
</div>


<p>これで静的ページへのルートがすべて動作し、テストもすべてパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p>後は、レイアウトのリンクをこれらの名前付きルートで埋めればよいのです。</p>

<div class="label" id="sec-named_routes"></div>


<h3><a id="sec-5_3_3" href="#sec-named_routes" class="heading"><span class="number">5.3.3</span>名前付きルート</a></h3>


<p>レイアウトのリンクを有効にするために、<a class="ref" href="#sec-rails_routes">5.3.2</a>で作成した名前付きルートを記入しましょう。そのためには、<code>link_to</code>メソッドの2番目の引数に適切な名前付きルートを指定する必要があります。たとえば以下のコードの場合、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>上を以下のように変更します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span> <span class="n">about_path</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p></p>

<p>最初に、HomeページとHelpページへのリンクを持つヘッダーパーシャル<code>_header.html.erb</code> (<a class="ref" href="#code-header_partial_links">リスト5.24</a>) から取りかかります。ヘッダーパーシャルでは、ウェブ共通の慣習に従って、ロゴにもHomeページへのリンクを追加します。</p>

<div class="label" id="code-header_partial_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.24</span> <span class="description">ヘッダーパーシャルにリンクを追加する。</span><br /><span class="description"> <code>app/views/layouts/_header.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span>    <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span>    <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>[Sign in] リンクの名前付きルートは<a class="ref" href="#cha-sign-in-sign-out">第8章</a>で作成するため、今の段階では<code>’#’</code>のままにしておきます。</p>

<p>フッターパーシャル<code>_footer.html.erb</code>にもリンクがあります。これらはAboutページとContactページへのリンクです (<a class="ref" href="#code-footer_partial_links">リスト5.25</a>)。</p>

<div class="label" id="code-footer_partial_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.25</span> <span class="description">フッターパーシャルにリンクを追加する。</span><br /><span class="description"> <code>app/views/layouts/_footer.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">&quot;footer&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;small&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    by Michael Hartl
  <span class="nt">&lt;/small&gt;</span>
  <span class="nt">&lt;nav&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;About&quot;</span><span class="p">,</span>   <span class="n">about_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Contact&quot;</span><span class="p">,</span> <span class="n">contact_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://news.railstutorial.org/&quot;</span><span class="nt">&gt;</span>News<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/footer&gt;</span>
</pre></div>
</div></div>


<p>これで、レイアウトに<a class="ref" href="#cha-static-pages">第3章</a>で作成したすべての静的ページへのリンクができました。たとえば<a href="http://localhost:3000/about">/about</a>の場合はAboutページ (<a class="ref" href="#fig-about_page">図5.8</a>) に移動します。</p>

<p>ところで、実際にレイアウト上にリンクが存在するかどうかをまだテストしていませんが、テスト方法のヒントとして、名前付きルートが定義されていなければテストは失敗するいうことにご注目ください。このことは、<a class="ref" href="#code-static_page_routes">リスト5.21</a>のルーティング定義をコメントアウトし、テストスイートを実行することで確認できます。リンクが実際に正しい場所を指していることを確認するテストの手法については、<a class="ref" href="#sec-layout_exercises">5.6</a>で説明します。</p>

<div class="label" id="fig-about_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/about_page_styled.png" alt="about_page_styled" /></span></div><div class="caption"><span class="header">図5.8</span><span class="description"><a href="http://localhost:3000/about">/about</a>で表示されるAboutページ。<a href="http://railstutorial.org/images/figures/about_page_styled-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-pretty_rspec"></div>


<h3><a id="sec-5_3_4" href="#sec-pretty_rspec" class="heading"><span class="number">5.3.4</span>RSpecを洗練させる</a></h3>


<p><a class="ref" href="#sec-route_tests">5.3.1</a>で、静的ページのテストが冗長で繰り返しが多くなってきたことを指摘しました (<a class="ref" href="#code-route_tests">リスト5.20</a>)。この節では、RSpecの最新の機能を使い、テストをより簡潔で洗練されたものにします。</p>

<p>テストの改善方法について、いくつかの例を見てみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should have the base title&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                      <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should not have a custom page title&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>まず、上の3つの例はいずれもルートへのアクセスを含んでいることに気付きます。<code>before</code>ブロックを使用することでこの冗長箇所を除くことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span> 

  <span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should have the base title&quot;</span> <span class="k">do</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span>
                      <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should not have a custom page title&quot;</span> <span class="k">do</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードでは以下を使用しました。</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>
</pre></div>
</div>


<p>これにより、それぞれの例の前にルートパスへのアクセスを実行します (<code>before</code>メソッドは、別名でもある<code>before(:each)</code>で呼ぶこともできます)。</p>

<p>冗長性の原因は他にもあります。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should have the h1 &#39;Sample App&#39;&quot;</span> <span class="k">do</span>
</pre></div>
</div>


<p>上と以下はどちらも本質的には同じ内容です。</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>さらに、どちらの例も<code>page</code>変数を参照しています。以下のように、<code>page</code>はテストの<em>主題 (subject) </em>であることをRSpecに伝えることにより、冗長の原因を排除できます。</p>

<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>
</pre></div>
</div>


<p>次に、以下のように<code>it</code>メソッドの変種を使用することにより、コードと記述を1行に収めます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p><code>subject { page }</code>と記述したことにより、<code>should</code>の呼び出しは自動的にCapybara (<a class="ref" href="#sec-TDD">3.2.1</a>)により提供される<code>page</code>変数を使用します。</p>

<p>これらの変更を加えることでHomeページのテストはより簡潔になります。</p>

<div class="code"><div class="highlight"><pre>  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span> 

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span>
                        <span class="ss">text:</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span> <span class="p">}</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>上のコードは以前より良くなりましたが、まだタイトルのテストが少し長すぎます。確かに、<a class="ref" href="#code-route_tests">リスト5.20</a>にあるほとんどのタイトルのテストで以下の長いテキストが使用されています。</p>

<div class="code"><div class="highlight"><pre><span class="s2">&quot;Ruby on Rails Tutorial Sample App | About&quot;</span>
</pre></div>
</div>


<p><a class="ref" href="#sec-static_pages_exercises">3.5</a>の演習では、<code>base_title</code>変数を定義し、文字列の補完を使用することでこの冗長性を排除することを提案しました (<a class="ref" href="#code-pages_controller_spec_exercise">リスト3.30</a>)。<a class="ref" href="#code-title_helper">リスト4.2</a>の<code>full_title</code>ヘルパーと同様の<code>full_title</code>を定義することで、さらに改良することができます。これを行うには、RSpecユーティリティで使用する<code>spec/support</code>ディレクトリーと<code>utilities.rb</code>ファイルを作成します (<a class="ref" href="#code-rspec_utilities">リスト5.26</a>)。</p>

<div class="label" id="code-rspec_utilities"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.26</span> <span class="description"><code>full_title</code>メソッドを持つRSpecユーティリティー用ファイル。</span><br /><span class="description"> <code>spec/support/utilities.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">)</span>
  <span class="n">base_title</span> <span class="o">=</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span>
  <span class="k">if</span> <span class="n">page_title</span><span class="o">.</span><span class="n">empty?</span>
    <span class="n">base_title</span>
  <span class="k">else</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">base_title</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">page_title</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>もちろんこれは、基本的に<a class="ref" href="#code-title_helper">リスト4.2</a>のヘルパーの複製です。しかし、2つの独立したメソッドがあることで基本タイトルのタイプミスを検出することができます。これはやや疑問の残る設計ですが、それでも、演習で登場する (<a class="ref" href="#sec-layout_exercises">5.6</a>) オリジナルの<code>full_title</code>ヘルパーを直接テストしたときよりも良い (少しだけ高度な) アプローチです。</p>

<p><code>spec/support</code>ディレクトリはRSpecによって自動的に読み込まれるため、Homeテストは以下のように書くことができます。</p>

<div class="code"><div class="highlight"><pre>  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span> 

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>Homeページで使用したのと同じ方法で、Help、About、Contactページのテストを単純化することができます。変更の結果を<a class="ref" href="#code-pretty_page_tests">リスト5.27</a>に示します。</p>

<div class="label" id="code-pretty_page_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.27</span> <span class="description">静的ページの端正になったテスト。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sample App&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">help_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Help&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Help&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">about_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;About&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;About Us&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">contact_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Contact&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Contact&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>テストは今度もパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/static_pages_spec.rb
</pre></div>
</div>


<p><a class="ref" href="#code-pretty_page_tests">リスト5.27</a>のRspecスタイルは、<a class="ref" href="#code-route_tests">リスト5.20</a>のスタイルよりもずっと簡潔でわかりやすくなっています。実は、さらに簡潔でわかりやすくすることが可能です (<a class="ref" href="#sec-layout_exercises">5.6</a>)。サンプルアプリケーションの今後の開発では、そのさらに簡潔なスタイルを可能な限り使用することにします。</p>

<div class="label" id="sec-user_signup"></div>


<h2><a id="sec-5_4" href="#sec-user_signup" class="heading"><span class="number">5.4</span>ユーザーのサインアップ：最初のステップ</a></h2>


<p>この節では、レイアウトとルーティングの取り組みにおける頂点として、サインアップページへのルートを作成します。そのために2番目のコントローラを作成することになります。これは、Webサイトでユーザー登録を行えるようにするための最初の重要な一歩となります。次の一歩であるユーザのモデリングは<a class="ref" href="#cha-modeling-users">第6章</a>で行い、<a class="ref" href="#cha-sign-up">第7章</a>でユーザー登録が完成します。</p>

<div class="label" id="sec-users_controller"></div>


<h3><a id="sec-5_4_1" href="#sec-users_controller" class="heading"><span class="number">5.4.1</span>ユーザーコントローラ</a></h3>


<p><a class="ref" href="#sec-static_pages_with_rails">3.1.2</a>で最初のコントローラであるStaticPagesコントローラを作成してからしばらく経ちました。今度は2番目のコントローラであるUsersコントローラを作成しましょう。1番目のときと同様、<code>generate</code>を実行して、現時点での要求である新規ユーザー用のサインアップページ (スタブ) を持つ、最も簡単なコントローラを作成します。Railsで好まれている<a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">RESTアーキテクチャ</a>の規約に従い、新規ユーザー用のアクションを<code>new</code>にすることに決め、<code>generate controller</code>の引数として渡して自動的にアクションを作成します (<a class="ref" href="#code-generate_users_controller">リスト5.28</a>)。</p>

<div class="label" id="code-generate_users_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.28</span> <span class="description">Usersコントローラの生成 (<code>new</code>アクションを追加)。</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new --no-test-framework
<span class="go">      create  app/controllers/users_controller.rb</span>
<span class="go">       route  get &quot;users/new&quot;</span>
<span class="go">      invoke  erb</span>
<span class="go">      create    app/views/users</span>
<span class="go">      create    app/views/users/new.html.erb</span>
<span class="go">      invoke  helper</span>
<span class="go">      create    app/helpers/users_helper.rb</span>
<span class="go">      invoke  assets</span>
<span class="go">      invoke    coffee</span>
<span class="go">      create      app/assets/javascripts/users.js.coffee</span>
<span class="go">      invoke    scss</span>
<span class="go">      create      app/assets/stylesheets/users.css.scss</span>
</pre></div>
</div></div>


<p>上のコマンドにより、<code>new</code>アクションを持つUsersコントローラ(<a class="ref" href="#code-initial_users_controller">リスト5.29</a>)と、スタブのユーザービューを作成します(<a class="ref" href="#code-initial_new_action">リスト5.30</a>)。</p>

<div class="label" id="code-initial_users_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.29</span> <span class="description"><code>new</code>アクションを持つ最初のUsersコントローラ。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-initial_new_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.30</span> <span class="description">Users用の最初の<code>new</code>アクション。</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Users#new<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/users/new.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="sec-signup_url"></div>


<h3><a id="sec-5_4_2" href="#sec-signup_url" class="heading"><span class="number">5.4.2</span>サインアップURI</a></h3>


<p><a class="ref" href="#sec-users_controller">5.4.1</a>のコードにより、新規ユーザー用の動作するページが/users/new にできました。ここで<a class="ref" href="#table-url_mapping">表5.1</a>を思い出していただきたいのですが、URIは/users/newではなく表のとおりに/signupにしたいと思います。<a class="ref" href="#sec-layout_links">5.3</a>のときと同様、最初にいくつかの結合テストを作成しましょう。以下を実行してテスト用ファイルを生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test user_pages
</pre></div>
</div>


<p>次に、<a class="ref" href="#code-pretty_page_tests">リスト5.27</a>の静的ページspecのひな形に従い、<a class="ref" href="#code-user_pages_spec">リスト5.31</a>に示すように、userページの<code>h1</code>と<code>title</code>タグの内容をテストするコードを記入します。</p>

<div class="label" id="code-user_pages_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">5.31</span> <span class="description">サインアップページへのテストを含む最初のusers用spec。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signup page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Sign up&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>いつもと同様、これらのテストを以下のように<code>rspec</code>コマンドで実行できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb
</pre></div>
</div>


<p>上のように特定のファイルを1つ渡す代わりに、以下のようにrequestsディレクトリ全体を渡すと、すべてのリクエストspecのテストを実行できることを覚えておくと良いでしょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/
</pre></div>
</div>


<p>上のパターンから、それ以外のディレクトリを含む<em>すべて</em>のspecを実行する以下の方法も容易に想像がつくと思います。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>完全を期して、今後はチュートリアルの最後まで基本的に上の方法を使用してテストをフル実行します。なお、Rakeタスクで<code>spec</code>のテストスイートを実行できることも覚えておくとよいでしょう (他の開発者が使っているのを見たことがあるかもしれません)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake spec
</pre></div>
</div>


<p>(実際には<code>rake</code>とタイプするだけで済みます。<code>rake</code>のデフォルトの動作はテストスイートの実行です。)</p>

<p>Usersコントローラは、作成時に既に<code>new</code>アクションを持っているため、後はテストをパスさせるために正しいルートとビューの中身を作成すればよいのです。<a class="ref" href="#code-static_page_routes">リスト5.21</a>の例に従い、サインアップURI用の<code>match ’/signup’</code>をルールを追加します。(<a class="ref" href="#code-signup_route">リスト5.32</a>)。</p>

<div class="label" id="code-signup_route"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.32</span> <span class="description">サインアップページへのルート。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;users/new&quot;</span>

  <span class="n">root</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#home&#39;</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;users#new&#39;</span>

  <span class="n">match</span> <span class="s1">&#39;/help&#39;</span><span class="p">,</span>    <span class="ss">to:</span> <span class="s1">&#39;static_pages#help&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span>   <span class="ss">to:</span> <span class="s1">&#39;static_pages#about&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/contact&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#contact&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-generate_users_controller">リスト5.28</a>では、Usersコントローラを生成したときに自動的に生成された<code>get &quot;users/new&quot;</code>のルールはそのままにしてあることにご注目ください。現時点では、このルールは<code>’users/new’</code>のルーティングが動作するために必要ですが、適切なREST規約 (<a class="ref" href="#table-demo_RESTful_users">表2.2</a>) に従っていません。これは<a class="ref" href="#sec-a_users_resource">7.1.2</a>で取り除きます。</p>

<p>テストをパスさせるために今必要なのは、“Sign up” のタイトルとヘッダーがあるビューです (<a class="ref" href="#code-initial_signup_page">リスト5.33</a>)。</p>

<div class="label" id="code-initial_signup_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.33</span> <span class="description">最初の (スタブ) サインアップページ。</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/users/new.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>この時点で、<a class="ref" href="#code-user_pages_spec">リスト5.31</a>のテストはパスするはずです。残っている作業は、Homeページのボタンに適切なリンクを追加することです。他のルートと同様、<code>match ’/signup’</code>と記述したことで<code>signup_path</code>という名前付きルートができ、それを<a class="ref" href="#code-home_page_signup_link">リスト5.34</a>で使用します。</p>

<div class="label" id="code-home_page_signup_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.34</span> <span class="description">ボタンをサインアップページにリンクする。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;center hero-unit&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;h2&gt;</span>
    This is the home page for the
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    sample application.
  <span class="nt">&lt;/h2&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;rails.png&quot;</span><span class="p">,</span> <span class="ss">alt:</span> <span class="s2">&quot;Rails&quot;</span><span class="p">),</span> <span class="s1">&#39;http://rubyonrails.org/&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>これで、少なくともサインインのルートを追加するまでの間、リンクと名前付きルートが完成しました(<a class="ref" href="#cha-sign-in-sign-out">第8</a>)。結果を<a class="ref" href="#fig-new_signup_page">図5.9</a>の新規ユーザーのページ (URI /signup) に示します。</p>

<div class="label" id="fig-new_signup_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/new_signup_page_bootstrap.png" alt="new_signup_page_bootstrap" /></span></div><div class="caption"><span class="header">図5.9</span><span class="description"><a href="http://localhost:3000/signup">/signup</a>で表示される新しいサインアップページ 。<a href="http://railstutorial.org/images/figures/new_signup_page_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この時点で、テストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-layout_conclusion"></div>


<h2><a id="sec-5_5" href="#sec-layout_conclusion" class="heading"><span class="number">5.5</span>最後に</a></h2>


<p>この章では、アプリケーションのレイアウトを形にし、ルーティングを洗練させました。本書では、以後サンプルアプリケーションを肉付けすることに専念します。最初に、サインアップ、サインイン、サインアウトできるユーザーを追加します。次に、マイクロポストを追加します。最後に、他のユーザーをフォローできるようにします。</p>

<p>Gitを使っている方は、この時点でmasterブランチに変更をマージしてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish layout and routes&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge filling-in-layout
</pre></div>
</div>


<p>続いてGitHubにプッシュしても構いません。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
</pre></div>
</div>


<p>最後にHerokuへデプロイすることもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>これで、本番環境のサーバーでサンプルアプリケーションが動作しているはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div>
</div>


<p>不具合が発生した場合は、以下のコマンドを試してみてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div>
</div>


<p>上のコマンドを使用してHerokuのログファイルを参照し、エラーをデバッグしてください。</p>

<div class="label" id="sec-layout_exercises"></div>


<h2><a id="sec-5_6" href="#sec-layout_exercises" class="heading"><span class="number">5.6</span>演習</a></h2>




<ol>

<li><a class="ref" href="#code-pretty_page_tests">リスト5.27</a>の静的ページのテストコードは簡潔ですが、まだ繰り返しが残っています。RSpecには、冗長性を排除するための<em>Shared Examples</em>と呼ばれる機能があります。<a class="ref" href="#code-static_pages_spec_shared_example">リスト5.35</a>の例に従い、Help、AboutとContactページで不足しているテストを補ってください。<a class="ref" href="#code-pages_controller_spec_exercise">リスト3.30</a>で簡単に紹介した<code>let</code>コマンドは、要求 (変数が使用されるときなど) に応じて与えられた値を持つ「ローカル変数」を作成することにご注意ください。対照的にインスタンス変数は、要素代入 (assignment) されたときに作成されます。</li>

<li>既にお気付きの方もいると思いますが、これまで行なってきた、レイアウト上のリンクのルーティングテストは、そのリンクが実際に正しいページへのリンクになっているかどうかをチェックしていません。このようなテストを実装する方法のひとつは、RSpecの結合テスト内で<code>visit</code>と<code>click_link</code>を使用することです。レイアウトのリンクが正しく定義されていることを確認するコードを追加して、<a class="ref" href="#code-layout_links_test">リスト5.36</a>を補ってください。</li>

<li><a class="ref" href="#code-full_title_helper_tests">リスト5.37</a>に示すように、元のヘルパーメソッドに対するテストを書き、それによって<a class="ref" href="#code-rspec_utilities">リスト5.26</a>の<code>full_title</code>テストヘルパーへの依存を解消してください (<code>spec/helpers</code>ディレクトリと<code>application_helper_spec.rb</code>ファイルの両方を作成する必要があるでしょう)。次に、<a class="ref" href="#code-rspec_utilities_simplified">リスト5.38</a>のコードを使用して、それをテストへ<code>include</code>してください。テストスイートを実行して、新しいコードに問題がないことを確認してください。<em>注意</em>: <a class="ref" href="#code-full_title_helper_tests">リスト5.37</a>では、<a class="ref" href="#sec-format_validation">6.2.4</a>で学ぶ<em>正規表現</em>を使用しています (この演習を提案し、コードを提供してくれた<a href="http://alexchaffee.com/">Alex Chaffee</a>に感謝します)。</li>

</ol>




<div class="label" id="code-static_pages_spec_shared_example"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.35</span> <span class="description">RSpecのShared Exampleを使用してテストの冗長性を排除する。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">shared_examples_for</span> <span class="s2">&quot;all static pages&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">heading</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="n">page_title</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:heading</span><span class="p">)</span>    <span class="p">{</span> <span class="s1">&#39;Sample App&#39;</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:page_title</span><span class="p">)</span> <span class="p">{</span> <span class="s1">&#39;&#39;</span> <span class="p">}</span>

    <span class="n">it_should_behave_like</span> <span class="s2">&quot;all static pages&quot;</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;| Home&#39;</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Help page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;About page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;Contact page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-layout_links_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.36</span> <span class="description">レイアウトのリンクをテストする。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should have the right links on the layout&quot;</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">root_path</span>
    <span class="n">click_link</span> <span class="s2">&quot;About&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;About Us&#39;</span><span class="p">)</span>
    <span class="n">click_link</span> <span class="s2">&quot;Help&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="c1"># fill in</span>
    <span class="n">click_link</span> <span class="s2">&quot;Contact&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="c1"># fill in</span>
    <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span>
    <span class="n">click_link</span> <span class="s2">&quot;Sign up now!&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="c1"># fill in</span>
    <span class="n">click_link</span> <span class="s2">&quot;sample app&quot;</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="c1"># fill in</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-full_title_helper_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.37</span> <span class="description"><code>full_title</code>ヘルパーのテスト。</span><br /><span class="description"> <code>spec/helpers/application_helper_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">ApplicationHelper</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;full_title&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should include the page title&quot;</span> <span class="k">do</span>
      <span class="n">full_title</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/foo/</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should include the base title&quot;</span> <span class="k">do</span>
      <span class="n">full_title</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/^Ruby on Rails Tutorial Sample App/</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not include a bar for the home page&quot;</span> <span class="k">do</span>
      <span class="n">full_title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="o">=~</span> <span class="sr">/\|/</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-rspec_utilities_simplified"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト5.38</span> <span class="description"><code>full_title</code>テストヘルパーを単純に <code>include</code>で置換する。</span><br /><span class="description"> <code>spec/support/utilities.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="kp">include</span> <span class="no">ApplicationHelper</span>
</pre></div>
</div></div>




<div class="footnotes">
<ol>
<li id="fn-5_1">サンプルアプリケーションでBootstrapを使用するための変換作業で、目覚ましい働きで助けてくれた読者の<a href="https://twitter.com/colmtuite">Colm Tuite</a>に感謝します。<a class="arrow" href="#fnref-5_1">↑</a></li>
<li id="fn-5_2"><em>Ruby on Railsチュートリアル</em>のモックアップは、<a href="http://gomockingbird.com">Mockingbird</a>というオンラインモックアップアプリケーションで作成しています。<a class="arrow" href="#fnref-5_2">↑</a></li>
<li id="fn-5_3">CSSクラスは、Rubyのクラスとはまったく関係がありません。<a class="arrow" href="#fnref-5_3">↑</a></li>
<li id="fn-5_4">既にお気付きだと思いますが、<code>img</code>タグは<tt class="verb">&lt;img&gt;...&lt;/img&gt;</tt>ではなく<tt class="verb">&lt;img ... </tt><tt class="verb">/&gt;</tt>と書きます。この書式に従うタグは <em>単独タグ</em>として知られています。 <a class="arrow" href="#fnref-5_4">↑</a></li>
<li id="fn-5_5">アセットパイプラインでLESSを使うこともできます。詳細は<a href="http://rubygems.org/gems/less-rails-bootstrap"><tt>less-rails-bootstrap</tt> gem</a>を参照してください。<a class="arrow" href="#fnref-5_5">↑</a></li>
<li id="fn-5_6">多くのRails開発者は、異なるビューの間で共通に使用するパーシャルを保存するディレクトリとして、<code>shared</code>ディレクトリを使用します。著者は、複数のビューで共有するユーティリティパーシャルについては<code>shared</code>フォルダに保存し、文字どおり全ページ (サイトレイアウトの一部として) 共通のパーシャルについては<code>layouts</code>ディレクトリへ保存することを好んでいます (<code>shared</code>ディレクトリは<a class="ref" href="#cha-sign-up">第7章</a>で作成します)。著者はこのように分割保存するのが論理的であると考えますが、<code>shared</code>フォルダにすべて保存しても問題なく動作します。<a class="arrow" href="#fnref-5_6">↑</a></li>
<li id="fn-5_7"><code>footer</code>タグと<code>.footer</code>クラスを両方使用していることについて疑問に思う方がいるかもしれません。その理由は、footerタグとする方が読み手にとって意味が明確であるのと、footerクラスはBootstrapで使用するためです。<code>footer</code>を<code>div</code>に置き換えても動作は変わりません。<a class="arrow" href="#fnref-5_7">↑</a></li>
<li id="fn-5_8">このチュートリアル構成は、Michael Erasmusによる素晴らしいブログ記事「<a href="http://2beards.net/2011/11/the-rails-3-asset-pipeline-in-about-5-minutes/">5分でわかるRails 3のアセットパイプライン</a> (英語)」をもとにしています。詳細についてはRails Guideの「<a href="http://guides.rubyonrails.org/asset_pipeline.html">Asset Pipeline</a> (英語)」の項を参照してください。<a class="arrow" href="#fnref-5_8">↑</a></li>
<li id="fn-5_9">Sassでもサポートされている古い<code>.sass</code>というフォーマットでは、冗長性の少ない (かっこの少ない)  新しい言語を定義しますが、既存のプロジェクトには若干不便であり、既にCSSに慣れ親しんだ人にとっては学習が面倒でもあります。<a class="arrow" href="#fnref-5_9">↑</a></li>
</ol>
</div>




<div class="label" id="cha-modeling-users"></div>


<h1 class="chapter"><a id="sec-6" href="#cha-modeling-users" class="heading"><span class="number">第6章</span>ユーザーのモデルを作成する</a></h1>


<p><a class="ref" href="#cha-filling-in-the-layout">第5章</a>では、新しいユーザーを作成するためのスタブページを作ったところで終わりました (<a class="ref" href="#sec-user_signup">5.4</a>)。これから4つの章を通して、ユーザー登録ページを作っていくことにしましょう。最初の一番重要なステップは、サイトのユーザー用の<em>データモデル</em>の作成と、データを保存する手段の確保です。<a class="ref" href="#cha-sign-up">第7章</a>では、ユーザーがサイトにユーザー登録できるようにし、ユーザープロファイルのためのページを作成します。ユーザー登録ができるようになると、次にサインイン、サインアウトもできるようにします (<a class="ref" href="#cha-sign-in-sign-out">第8章</a>)。そして<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a> (<a class="ref" href="#sec-requiring_signed_in_users">9.2.1</a>) では、不正なアクセスから守る方法を学びます。まとめると、<a class="ref" href="#cha-modeling-users">第6章</a>から<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>を通して、Railsのログインと認証のシステムを一通り開発します。ご存知の方もいるとは思いますが、Railsでは既にさまざまな認証方法が利用可能です。<a class="ref" href="#sidebar-roll_your_own">コラム 6.1</a>では、最初に少なくとも一度は自分で認証システムを作ってみることをお勧めする理由について説明しています。</p>

<p>この章は長いうえに、学ぶことがたくさんあります。特に、これまでデータモデリングをしたことがない人にとっては、もしかすると、これまでとは違った難しさを感じるかもしれません。しかし、この章が終わるまでには、ユーザー情報の検証、保存、取得ができる極めて強力なシステムを作成します。</p>

<div class="label" id="sidebar-roll_your_own"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 6.1</span></span><span class="title"><span class="description">自分で認証システムを作ってみる</span></span>
<p>事実上、すべてのアプリは何らかのログイン/認証システムを必要とします。そのため、多くのWebフレームワークではこのようなログイン/認証システムを実装するための選択肢が多数提供されています。Railsもまた例外ではありません。認証 (authentication) と認可 (authorization) のシステムの例だと、<a href="http://github.com/thoughtbot/clearance">Clearance</a>、<a href="http://github.com/binarylogic/authlogic">Authlogic</a>、<a href="http://github.com/plataformatec/devise">Devise</a>、<a href="http://railscasts.com/episodes/192-authorization-with-cancan">CanCan</a>などがあります (Railsに限らなければ<a href="http://en.wikipedia.org/wiki/OpenID">OpenID</a>や<a href="http://en.wikipedia.org/wiki/Oauth">OAuth</a>の上に構築する方法もあります)。 なぜ車輪の再発明をするのか、という質問があるのも当然です。自分でわざわざ作らなくても、いつも使える方法をただ利用するだけではいけないのでしょうか。</p>

<p>ある実践的な実験によると、多くのサイトの認証システムは膨大なカスタマイズを必要とするため、サードパーティ製品を変更して導入する場合にはシステムをゼロから作成するよりも多くの仕事を要するという結果が出ています。加えて、既成品のシステムは内部がわかりづらいことが多く、ブラックボックスになっています。自分で作成したシステムであれば、それをとてもよく理解しているはずです。さらに言えば、最近のRailsへの変更 (<a class="ref" href="#sec-adding_a_secure_password">6.3</a>) により、カスタム認証システムを容易に作成できるようになりました。最後に、<em>あえて</em>最終的にサードパーティの認証システムを導入することになったとしても、自分自身で認証システムを構築した経験があれば、サードパーティ製品を理解して変更することがずっと容易になるはずです。</p>
</div>


<p>Gitでバージョン管理を行なっているのであれば、このタイミングでユーザーをモデリングするためのトピックブランチを作成しておいてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b modeling-users
</pre></div>
</div>


<p>(最初の行はmasterブランチから作業を始めることを確認するためのものです。そして、<code>modeling-users</code>トピックブランチは<code>master</code>ブランチを基に作成します。もしすでにmasterブランチにいる場合は、このコマンドを実行する必要はありません)。</p>

<div class="label" id="sec-user_model"></div>


<h2><a id="sec-6_1" href="#sec-user_model" class="heading"><span class="number">6.1</span> Userモデル</a></h2>


<p>ここから3つの章にわたる最終目標はユーザー登録ページ (<a class="ref" href="#fig-signup_mockup_preview">図6.1</a>のモックアップ) を作成することですが、今のままでは新しいユーザーの情報を受け取っても保存する場所がないので、いきなりページを作成するわけにはいきません。ユーザー登録でまず初めにやることは、それらの情報を保存するためのデータ構造を作成することです。</p>

<div class="label" id="fig-signup_mockup_preview"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_mockup_bootstrap.png" alt="signup_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図6.1</span><span class="description">ユーザー登録ページのモックアップ。<a href="http://railstutorial.org/images/figures/signup_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>Railsでは、データモデルで使用するデフォルトのデータ構造のことを<em>モデル</em>と呼びます (<a class="ref" href="#sec-mvc">1.2.6</a>にあるMVCのMのことです)。Railsでは、データを永続化するデフォルトの解決策として、<em>データベース</em>を使用してデータを長期間保存します。また、データベースとやりとりするデフォルトのRailsライブラリは<em>Active Record</em>と呼ばれます<sup class="footnote" id="fnref-6_1"><a href="#fn-6_1">1</a></sup>。Active Recordは、データオブジェクトの作成/保存/検索のためのメソッドを持っています。これらのメソッドを使用するのに、<a href="http://en.wikipedia.org/wiki/Relational_database">リレーショナルデータベース</a>で使うSQL (Structured Query Language)<sup class="footnote" id="fnref-6_2"><a href="#fn-6_2">2</a></sup>を意識する必要はありません。さらに、Railsには<em>マイグレーション</em>という機能があります。データの定義をRubyで記述することができ、SQLのDDL (Data Definition Language)を新たに学ぶ必要がありません。Railsは、データストアの詳細からほぼ完全に私たちを切り離してくれます。本書では、SQLiteを開発 (development) 環境で使い、またPostgreSQLを (Herokuでの) 開発環境で使います (<a class="ref" href="#sec-deploying">1.4</a>)。Railsは、本番 (production) アプリケーションですら、データの保存方法の詳細についてほとんど考える必要がないくらいよくできています。</p>

<div class="label" id="sec-database_migrations"></div>


<h3><a id="sec-6_1_1" href="#sec-database_migrations" class="heading"><span class="number">6.1.1</span>データベースの移行</a></h3>


<p><a class="ref" href="#sec-a_user_class">4.4.5</a>で扱ったカスタムビルドクラスの<code>User</code>を思い出してください。このクラスは、<code>name</code>と<code>email</code>を属性に持つユーザーオブジェクトでした。このクラスは役に立つ例として提供されましたが、Railsにとってきわめて重要な部分である<em>永続性</em>という要素が欠けていました。RailsコンソールでUserクラスのオブジェクトを作っても、コンソールからexitするとそのオブジェクトはすぐに消えてしまいました。この節での目的は、簡単に消えることのないユーザーのモデルを構築することです。</p>

<p><a class="ref" href="#sec-a_user_class">4.4.5</a>のユーザークラスと同様に、<code>name</code>と<code>email</code>の2つの属性からなるユーザーをモデリングするところから始めましょう。後者のemailを一意のユーザー名として使用します<sup class="footnote" id="fnref-6_3"><a href="#fn-6_3">3</a></sup> (パスワードのための属性は<a class="ref" href="#sec-adding_a_secure_password">6.3</a>で扱います) 。<a class="ref" href="#code-example_user">リスト4.9</a>では、以下のようにRubyの<code>attr_accessor</code>メソッドを使用しました。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>それとは対照的に、Railsでユーザーをモデリングするときは、属性を明示的に識別する必要がありません。上で簡潔に述べたように、Railsはデータを保存する際にデフォルトでリレーショナルデータベースを使用します。リレーショナルデータベースは、データ<em>行</em>で構成される<em>テーブル</em>からなり、各行はデータ属性の<em>カラム</em> (列) を持ちます。たとえば、nameとemailを持つユーザーを保存するのであれば、<code>name</code>と<code>email</code>のカラムを持つ<code>users</code>テーブルを作成します (各行はひとりのユーザーを表します)。カラムをこのように名付けることによって、Active RecordでUserオブジェクトの属性を利用できるようになります。</p>

<p>それでは実際どのように動作するのか見てみましょう (ここまでの説明が抽象的でわかりにくいかもしれませんが、少しだけご辛抱願います。<a class="ref" href="#sec-creating_user_objects">6.1.3</a>から使用しているコンソールの例と、<a class="ref" href="#fig-sqlite_database_browser">図6.3</a>と<a class="ref" href="#fig-sqlite_user_row">図6.6</a>にあるデータベースブラウザのスクリーンショットが理解を助けてくれるでしょう)。<a class="ref" href="#code-generate_users_controller">リスト5.28</a>で、ユーザーコントローラ (と<code>new</code>アクション) を作ったときに使った以下のコマンドを思い出してみてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new --no-test-framework
</pre></div>
</div>


<p>上のコマンドはコントローラを作成しましたが、同様にモデルを作成するコマンドとして、<code>generate model</code>があります。<code>name</code>と<code>email</code>の2つの属性を持つUserモデルを作成するコマンドを<a class="ref" href="#code-generate_user_model">リスト6.1</a>に示します。</p>

<div class="label" id="code-generate_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.1</span> <span class="description">Userモデルの作成。</span> </div>
<div class="code"><div class="highlight"><pre>$ rails generate model User name:string email:string
      invoke  active_record
      create    db/migrate/[timestamp]_create_users.rb
      create    app/models/user.rb
      invoke    rspec
      create      spec/models/user_spec.rb
</pre></div>
</div></div>


<p>(コントローラ名には複数形を使い、モデル名には単数形を用いるという慣習を頭に入れておいてください。コントローラはUsersでモデルはUserです)。<code>name:string</code>や<code>email:string</code>オプションのパラメータを渡すことによって、データベースで使用したい2つの属性をRailsに伝えます。このときに、これらの属性の型情報も一緒に渡します (この場合は<code>string</code>)。<a class="ref" href="#code-generating_pages">リスト3.4</a>や<a class="ref" href="#code-generate_users_controller">リスト5.28</a>でアクション名を使用して生成した例と比較してみてください。</p>

<p><a class="ref" href="#code-generate_user_model">リスト6.1</a>にある<code>generate</code>コマンドの結果のひとつとして、<em>マイグレーション</em>と呼ばれる新しいファイルが生成されます。マイグレーションは、データベースの構造をインクリメンタルに変更する手段を提供します。それにより、要求が変更された場合にデータモデルを適合させることができます。このUserモデルの例の場合、マイグレーションはモデル生成スクリプトによって自動的に作られました。<a class="ref" href="#code-users_migration">リスト6.2</a>にあるように<code>name</code>と<code>email</code>の2つのカラムを持つ<code>users</code>テーブルを作成します (<a class="ref" href="#sec-uniqueness_validation">6.2.5</a>と<a class="ref" href="#sec-adding_a_secure_password">6.3</a>で、マイグレーションを一から手動で作成する方法について説明します)。</p>

<div class="label" id="code-users_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.2</span> <span class="description">(<code>users</code>テーブルを作るための) Userモデルのマイグレーション。</span><br /><span class="description"> <code>db/migrate/[timestamp]_create_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>マイグレーションファイル名の先頭には、それが生成された時間の<em>タイムスタンプ</em>が追加されます。以前はインクリメンタルな整数が追加されていましたが、複数の開発者によるチームでは、複数のプログラマが同じ整数を持つマイグレーションを生成してしまい、コンフリクトを引き起こしていました。現在のタイムスタンプによる方法であれば、まったく同時にマイグレーションが生成されるという通常ではありえないことが起きない限り、そのようなコンフリクトを避けることができます。</p>

<p>マイグレーション自体は、データベースに与える変更を定義した<code>change</code>メソッドの集まりです。<a class="ref" href="#code-users_migration">リスト6.2</a>の場合、<code>change</code>メソッドは<code>create_table</code>というRailsのメソッドを呼び、ユーザーを保存するための<em>テーブル</em>をデータベースに作成します。<code>create_table</code>メソッドはブロック変数を1つ持つブロック (<a class="ref" href="#sec-blocks">4.3.2</a>) を受け取ります。ここでは (“table”の頭文字を取って) <code>t</code>です。そのブロックの中で、<code>create_table</code>メソッドは<code>t</code>オブジェクトを使って、今度は<code>name</code>と<code>email</code>カラムをデータベースに作成します。型はいずれも<code>string</code>です<sup class="footnote" id="fnref-6_4"><a href="#fn-6_4">4</a></sup>。モデル名は単数形 (User) ですが、テーブル名は複数形 (<code>users</code>) です。これはRailsで用いられる言葉の慣習を反映しています。モデルはひとりのユーザーを表すのに対し、データベースのテーブルは複数のユーザーから構成されます。ブロックの最後の行<code>t.timestamps</code>は特別なコマンドで、<code>created_at</code>と<code>updated_at</code>という2つの「<em>マジックカラム</em>」を作成します。これらは、あるユーザーが作成または更新されたときに、その時刻を自動的に記録するタイムスタンプです (このマジックカラムの使用例を<a class="ref" href="#sec-creating_user_objects">6.1.3</a>から具体的に見ていきます)。 このマイグレーションで作られる完全なデータモデルを<a class="ref" href="#fig-user_model_initial">図6.2</a>に示します。</p>

<div class="label" id="fig-user_model_initial"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_initial.png" alt="user_model_initial" /></span></div><div class="caption"><span class="header">図6.2</span><span class="description"><a class="ref" href="#code-users_migration">リスト6.2</a>によるユーザーデータモデル</span></div></div>


<p>マイグレーションは、以下のように<code>rake</code>コマンド (<a class="ref" href="#sidebar-rake">コラム 2.1</a>) を使って実行することができます。これを“マイグレーションの適用 (migrating up)”と呼びます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>


<p>(<a class="ref" href="#sec-demo_users_resource">2.2</a>で、一度このコマンドを実行したことを思い出してみてください) 。初めて<code>db:migrate</code>が実行されると、<code>db/development.sqlite3</code>という名前のファイルが生成されます。これは<a href="http://sqlite.org/">SQLite</a><sup class="footnote" id="fnref-6_5"><a href="#fn-6_5">5</a></sup>データベースです。<code>db/development.sqlite3</code>ファイルを開くための<a href="http://sourceforge.net/projects/sqlitebrowser/">SQLite Database Browser</a>という素晴らしいツールを使って、データベースの構造を詳しく参照することができます (<a class="ref" href="#fig-sqlite_database_browser">図6.3</a>)。<a class="ref" href="#fig-user_model_initial">図6.2</a>の表と比べてみてください。<a class="ref" href="#fig-sqlite_database_browser">図6.3</a>の中に<code>id</code>というマイグレーションのときに説明されなかったカラムの存在に気づいたかもしれません。<a class="ref" href="#sec-demo_users_resource">2.2</a>で簡単に説明したとおり、このカラムは自動的に作成され、Railsが各行を一意に識別するために使用します。</p>

<div class="label" id="fig-sqlite_database_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_database_browser.png" alt="sqlite_database_browser" /></span></div><div class="caption"><span class="header">図6.3</span><span class="description"><a href="http://sqlitebrowser.sourceforge.net/">SQLite Database Browser</a>と作成した<code>users</code>テーブル。<a href="http://railstutorial.org/images/figures/sqlite_database_browser-full.png">(拡大)</a></span></div></div>


<p><em>Railsチュートリアル</em>で使用されているものすべてを含め、ほとんどのマイグレーションが<em>可逆</em>です。これは、<code>db:rollback</code>というRakeタスクで変更を取り消せることを意味します。これを“マイグレーションの取り消し (migrate down)”と呼びます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:rollback
</pre></div>
</div>


<p>(<a class="ref" href="#sidebar-undoing_things">コラム 3.1</a>では、マイグレーションを元に戻すための便利なテクニックを他にも紹介しています)。上のコマンドでは、データベースからusersテーブルを削除するために<code>drop_table</code>コマンドを内部で呼び出しています。これがうまくいくのは、<code>change</code>メソッドは<code>drop_table</code>が<code>create_table</code>の逆であることを知っているからです。つまり、ロールバック用の逆方向マイグレーションを簡単に導くことができるのです。あるカラムを削除するような不可逆なマイグレーションの場合は、<code>change</code>メソッドの代わりに、<code>up</code>と<code>down</code>のメソッドを別々に定義する必要があります。詳細については、「<a href="http://guides.rubyonrails.org/migrations.html">Rails Guidesのマイグレーション</a> (英語)」を参照してください。</p>

<p>もし今の時点でデータベースのロールバックを実行していた場合は、先に進む前にもう一度以下のようにマイグレーションを適用して元に戻してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>




<div class="label" id="sec-the_model_file"></div>


<h3><a id="sec-6_1_2" href="#sec-the_model_file" class="heading"><span class="number">6.1.2</span>modelファイル</a></h3>


<p>これまで、<a class="ref" href="#code-generate_user_model">リスト6.1</a>のUserモデルの作成によってどのように (<a class="ref" href="#code-users_migration">リスト6.2</a>) のマイグレーションファイルが作成されるかを見てきました。そして<a class="ref" href="#fig-sqlite_database_browser">図6.3</a>でこのマイグレーションを実行した結果を見ました。<code>development.sqlite3</code>という名のファイルを<code>users</code>テーブルを作成することで更新し、<code>id</code>、<code>name</code>、<code>email</code>、<code>created_at</code>、<code>updated_at</code>を作成しました。<a class="ref" href="#code-generate_user_model">リスト6.1</a>はモデル自体も作成しました。この節では、以後これらを理解することに専念します。</p>

<p>まず、<code>app/models/</code>ディレクトリにある<code>user.rb</code>ファイルに書かれたUserモデルのコードを見てみましょう。これは控えめに言ってもとてもよくまとまっています (<a class="ref" href="#code-raw_user_model">リスト6.3</a>) (<em>注</em>: もしRails 3.2.2か、それ以前のバージョンを使っている場合は<code>attr_accessible</code>の行は存在しません。その場合は<a class="ref" href="#sec-accessible_attributes">6.1.2.2</a>で追加する必要があります)。</p>

<div class="label" id="code-raw_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.3</span> <span class="description">新しいUserモデル。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#sec-a_class_of_our_own">4.4.2</a>で行ったことを思い出してみましょう。<code>class User &lt; ActiveRecord::Base</code>という構文で、<code>User</code>クラスは<code>ActiveRecord::Base</code>を<em>継承するので</em>、Userモデルは自動的に<code>ActiveRecord::Base</code>クラスのすべての機能を持ちます。もちろん、この継承の知識は、<code>ActiveRecord::Base</code>に含まれるメソッドなどについて知らなければ何の役にも立ちません。それらの知識の一部についてはこれからご説明します。ただしその前に、完了させておかなければならない作業が2つあります。</p>

<div class="label" id="sec-model_annotation"></div>


<h4><a id="sec-6_1_2_1" href="#sec-model_annotation" class="heading">モデル注釈</a></h4>


<p>必須というわけではありませんが、<code>annotate</code> gem (<a class="ref" href="#code-gemfile_annotate">リスト6.4</a>) を使ってRailsのモデルに<em>注釈を追加する</em>ようにしておくと便利なことがあります。</p>

<div class="label" id="code-gemfile_annotate"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.4</span> <span class="description"><code>Gemfile</code>に<code>annotate</code> gemを追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.11.0&#39;</span>
<span class="k">end</span>


<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;annotate&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5.0&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(この注釈機能は本番アプリでは不要なので、<code>annotate</code> gemは<code>group :development</code>ブロックの中に書きます (<code>group :test</code>に書いたときと同じ要領です))。次に<code>bundle install</code>を実行してインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>これにより<code>annotate</code>コマンドが使えるようになります。これを実行すると、モデルファイルにデータモデルを含んだコメントが追加されます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>annotate
<span class="go">Annotated (1): User</span>
</pre></div>
</div>


<p>実行結果を<a class="ref" href="#code-annotated_user_model">リスト6.5</a>に示します。</p>

<div class="label" id="code-annotated_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.5</span> <span class="description">注釈が追加されたUserモデル。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="c1"># == Schema Information</span>
<span class="c1">#</span>
<span class="c1"># Table name: users</span>
<span class="c1">#</span>
<span class="c1">#  id         :integer         not null, primary key</span>
<span class="c1">#  name       :string(255)</span>
<span class="c1">#  email      :string(255)</span>
<span class="c1">#  created_at :datetime</span>
<span class="c1">#  updated_at :datetime</span>
<span class="c1">#</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>データモデルをモデルファイルの中にコメントとして残しておくと、モデルにどんな属性があるかを楽に思い出せます。なお簡潔さのため、本書で今後使用するコードにはこの注釈を付けません (もし注釈を最新の状態に保ちたいのであれば、データモデルが変わるたびに<code>annotate</code>を実行しなければならないことにご注意ください)。</p>

<div class="label" id="sec-accessible_attributes"></div>


<h4><a id="sec-6_1_2_2" href="#sec-accessible_attributes" class="heading">アクセス可能な属性</a></h4>


<p>それではもう一度Userモデルに戻りましょう。<code>attr_accessible</code>の行にご注目ください (<a class="ref" href="#code-attr_accessible">リスト6.6</a>)。この行は、モデルのどの属性を<em>アクセス可能</em>にするかをRailsに伝えます。たとえば、外部のユーザー (Webブラウザを使用してリクエストを送信するユーザーなど) が変更してもよい属性を指定します。</p>

<div class="label" id="code-attr_accessible"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.6</span> <span class="description"><code>name</code>と<code>email</code>属性をアクセス可能にする。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-attr_accessible">リスト6.6</a>のコードの動作は若干わかりにくいところがあるので注意が必要です。モデルにattr_accessibleを書かない場合は、デフォルトで「モデルの<em>すべての</em>属性がアクセス可能」になります。<a class="ref" href="#code-attr_accessible">リスト6.6</a>は、<code>name</code>と<code>email</code>属性が外部のユーザーからアクセス可能であることを指定すると同時に、「 明示的に指定された<code>name</code>と<code>email</code>属性<em>以外の</em>属性はすべてアクセス不可能とする」ことを暗黙に指定します。この動作を理解することが重要な理由については、<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>で説明します。<em>マスアサインメント</em>の脆弱性から守るためには、<code>attr_accessible</code>を必ず使用することが重要です。マスアサインメント脆弱性は非常によくあるセキュリティ問題で、多くのRailsアプリケーションで重大なセキュリティホールの原因となりました。</p>

<div class="label" id="sec-creating_user_objects"></div>


<h3><a id="sec-6_1_3" href="#sec-creating_user_objects" class="heading"><span class="number">6.1.3</span>ユーザーオブジェクトを作成する</a></h3>


<p>準備が完了しましたので、いよいよActive Recordについて学ぶことにしましょう。先ほど作成したUserモデルを使用します。<a class="ref" href="#cha-rails-flavored-ruby">第4章</a>と同じく、Railsコンソールを使います。(この時点では) データベースを変更したくないので、コンソールを<em>サンドボックス</em>モードで起動します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="go">Loading development environment in sandbox</span>
<span class="go">Any modifications you make will be rolled back on exit</span>
<span class="gp">&gt;&gt; </span>
</pre></div>
</div>


<p>&quot;Any modifications you make will be rolled back on exit&quot;  (ここで行ったすべての変更は終了時にロールバックされます) というメッセージにわかりやすく示されているように、コンソールをサンドボックスで起動すると、そのセッションで行ったデータベースへの変更をコンソールの終了時にすべて “ロールバック” (取り消し) してくれます。</p>

<p><a class="ref" href="#sec-a_user_class">4.4.5</a>のコンソールセッションでは<code>User.new</code>で新しいユーザーオブジェクトを生成しましたが、<a class="ref" href="#code-example_user">リスト4.9</a>のexample_userファイルを明示的にrequireするまでこのオブジェクトにはアクセスできませんでした。しかし、モデルを使うと状況は異なります。<a class="ref" href="#sec-a_controller_class">4.4.4</a>で見たように、Railsコンソールは起動時にRailsの環境を自動的に読み込み、その環境にはモデルも含まれます。つまり、新しいユーザーオブジェクトを作成するときに余分な作業を行わずに済むということです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User id: nil, name: nil, email: nil, created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>コンソールでは上のように、ユーザーオブジェクトはデフォルトの表現として、<a class="ref" href="#fig-user_model_initial">図6.2</a>と<a class="ref" href="#code-annotated_user_model">リスト6.5</a>と同じ属性を出力していることがわかります。</p>

<p><code>User.new</code>を引数なしで呼んだ場合は、すべての属性が<code>nil</code>のオブジェクトを返します。<a class="ref" href="#sec-a_user_class">4.4.5</a>では、オブジェクトの属性を設定する<em>初期化ハッシュ (hash) </em>を引数に取るために、Userクラスの例 (user_example.rb) を設計しました。この設計にはActive Recordが使用されており、ここでも同じ方法で初期化できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: nil, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>上のように、nameとemail属性が期待どおり設定されていることがわかります。</p>

<p>開発ログをtailしたまま上を実行していた場合、実行後に新しい行が何も表示されないことに気付いた方もいると思います。これは、<code>User.new</code>を実行しても単にRubyオブジェクトをメモリ上に作成するだけで、データベースにはアクセスしないためです。このユーザーオブジェクトをデータベースに実際に保存するには、<code>user</code>変数に対して<code>save</code>メソッドを呼びます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p><code>save</code>メソッドは、成功すれば<code>true</code>を、失敗すれば<code>false</code>を返します (現状では、保存はすべて成功するはずです。失敗する場合については<a class="ref" href="#sec-user_validations">6.2</a>で説明します)。 保存すると、SQLコマンドの<code>INSERT INTO &quot;users&quot;</code>という行が開発ログに追加出力されることがすぐに確認できます。Active Recordによって多数のメソッドが提供されているので、本書では生のSQLを書く必要がありません。従って、本書ではこれ以降はSQLコマンドについての説明を省略します。ただしそれでも、開発ログを監視することによってSQLについて多くのことを学ぶことができるでしょう。</p>

<p>作成した時点でのユーザーオブジェクトは、<code>id</code>属性、マジックカラムである<code>created_at</code>属性と<code>updated_at</code>属性の値がいずれも<code>nil</code>であったことを思い出してください。<code>save</code>メソッドを実行した後に何が変更されたのかを確認してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p><code>id</code>には<code>1</code>という値が代入され、一方でマジックカラムには現在の日時が代入されているのがわかります<sup class="footnote" id="fnref-6_6"><a href="#fn-6_6">6</a></sup>。現在、作成と更新のタイムスタンプは同一ですが、<a class="ref" href="#sec-updating_user_objects">6.1.5</a>では異なる値になります。</p>

<p><a class="ref" href="#sec-a_user_class">4.4.5</a>のUserクラスと同様に、Userモデルのインスタンスはドット記法を用いてその属性にアクセスすることができます<sup class="footnote" id="fnref-6_7"><a href="#fn-6_7">7</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">Michael Hartl (マイケル・ハートル)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; Tue, 05 Dec 2011 00:57:46 UTC +00:00</span>
</pre></div>
</div>


<p>詳細は<a class="ref" href="#cha-sign-up">第7章</a>でも説明しますが、上で見たようにモデルの生成と保存を2つのステップに分けておくと何かと便利です。しかし、Active Recordでは<code>User.create</code>でモデルの生成と保存を同時に行う方法も提供されています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;A Nother&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;another@example.org&quot;</span><span class="p">)</span>
<span class="go">#&lt;User id: 2, name: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2011-12-05 01:05:24&quot;, updated_at: &quot;2011-12-05 01:05:24&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@bar.com&quot;</span><span class="p">)</span>
<span class="go">#&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2011-12-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2011-12-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p><code>User.create</code>は、<code>true</code>か<code>false</code>を返す代わりに、ユーザーオブジェクト自身を返すことにご注目ください。返されたユーザーオブジェクトは (上の2つ目のコマンドにある<code>foo</code>のように) 変数に代入することもできます。</p>

<p><code>destroy</code>は<code>create</code>の逆です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">destroy</span>
<span class="go">=&gt; #&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2011-12-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2011-12-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>奇妙なことに、<code>destroy</code>は<code>create</code>と同じようにそのオブジェクト自身を返しますが、その返り値を使用しても、もう一度<code>destroy</code>を呼ぶことはできません。そして、おそらくさらに奇妙なことに、<code>destroy</code>されたオブジェクトは以下のようにまだメモリ上に残っています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span>
<span class="go">=&gt; #&lt;User id: 3, name: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2011-12-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2011-12-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>オブジェクトが本当に削除されたかどうかをどのようにして知ればよいでしょうか。そして、保存して削除されていないオブジェクトの場合、どうやってデータベースからユーザーを取得するのでしょうか。いよいよActive Recordでユーザーオブジェクトを検索する方法を学ぶときが来ました。</p>

<div class="label" id="sec-finding_user_objects"></div>


<h3><a id="sec-6_1_4" href="#sec-finding_user_objects" class="heading"><span class="number">6.1.4</span>ユーザーオブジェクトを検索する</a></h3>


<p>Active Recordには、オブジェクトを検索するための方法がいくつもあります。これらの機能を使用して、過去に作成した最初のユーザーを探してみましょう。また、3番目のユーザー (<code>foo</code>) が削除されていることを確認しましょう。まずは存在するユーザーから探してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>ここでは、<code>User.find</code>にユーザーのidを渡しています。その結果、Active Recordはそのidのユーザーを返します。</p>

<p>次に、<code>id</code>=<code>3</code>のユーザーがまだデータベースに存在するかどうかを確認してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordNotFound: Couldn&#39;t find User with ID=3</span>
</pre></div>
</div>


<p><a class="ref" href="#sec-creating_user_objects">6.1.3</a>で3番目のユーザーを削除したので、Active Recordはこのユーザーをデータベースの中から見つけることができませんでした。代わりに、<code>find</code>メソッドは<em>例外 (exception) </em>を発生します。例外はプログラムの実行時に何か例外的なイベントが発生したことを示すために使われます。この場合、存在しないActive Recordのidによって、<code>find</code>で<code>ActiveRecord::RecordNotFound</code>例外<sup class="footnote" id="fnref-6_8"><a href="#fn-6_8">8</a></sup>が発生しました。</p>

<p>一般的な<code>find</code>メソッド以外に、Active Recordには特定の属性でユーザーを検索する方法もあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p><code>find_by_email</code>は、<code>users</code>テーブルの<code>email</code>属性に基づいてActive Recordが自動的に生成するメソッドです (ご想像どおり、Active Recordは<code>find_by_name</code>というメソッドも自動的に生成します)。 これまでメールアドレスをユーザー名として使用してきたので、このような<code>find</code>は、ユーザーをサイトにログインさせる方法を学ぶときに役に立ちます (<a class="ref" href="#cha-sign-up">第7章</a>)。ユーザー数が膨大になると<code>find_by_email</code>では検索効率が低下するのではないかと心配する方もいるかもしれませんが、焦る必要はありません。この問題およびデータベースのインデックスを使った解決策については<a class="ref" href="#sec-uniqueness_validation">6.2.5</a>で扱います。</p>

<p>ユーザーを検索する一般的な方法をあと少しだけご紹介して、この節を終わりにすることにしましょう。まず初めに<code>first</code>メソッドです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>読んで字のごとく、<code>first</code>は単にデータベースの最初のユーザーを返します。次は<code>all</code>メソッドです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span>
<span class="go">=&gt; [#&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;,</span>
<span class="go">#&lt;User id: 2, name: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2011-12-05 01:05:24&quot;, updated_at: &quot;2011-12-05 01:05:24&quot;&gt;]</span>
</pre></div>
</div>


<p>ご想像のとおり、<code>all</code>はデータベースのすべてのユーザーの配列 (<a class="ref" href="#sec-arrays_and_ranges">4.3.1</a>) を返します。</p>

<div class="label" id="sec-updating_user_objects"></div>


<h3><a id="sec-6_1_5" href="#sec-updating_user_objects" class="heading"><span class="number">6.1.5</span>ユーザーオブジェクトを更新する</a></h3>


<p>いったんオブジェクトを作成すれば、今度は何度でも更新したくなるものです。基本的な更新の方法は2つです。ひとつは、<a class="ref" href="#sec-a_user_class">4.4.5</a>でやったように属性を個別に代入する方法です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>           <span class="c1"># Just a reminder about our user&#39;s attributes</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-05 00:57:46&quot;, updated_at: &quot;2011-12-05 00:57:46&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;mhartl@example.net&quot;</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>変更をデータベースに保存するために最後にsaveを実行する必要があることを忘れないでください。保存を行わずに<code>reload</code>を実行すると、データベースの情報を元にオブジェクトを再読み込みするので、以下のように変更が取り消されます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;foo@bar.com&quot;</span>
<span class="go">=&gt; &quot;foo@bar.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
</pre></div>
</div>


<p>今ユーザーを更新しました。<a class="ref" href="#sec-creating_user_objects">6.1.3</a>で約束したように、マジックカラムの更新日時が更新されました。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
<span class="go">=&gt; &quot;2011-12-05 00:57:46&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; &quot;2011-12-05 01:37:32&quot;</span>
</pre></div>
</div>


<p>属性を更新するもうひとつの方法は、<code>update_attributes</code>を使うものです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;The Dude&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;dude@abides.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">name</span>
<span class="go">=&gt; &quot;The Dude&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;dude@abides.org&quot;</span>
</pre></div>
</div>


<p><code>update_attributes</code>メソッドは属性のハッシュを受け取り、成功時には更新と保存を続けて同時に行います (保存に成功した場合は<code>true</code>を返します)。ただし、<code>attr_accessible</code> (<a class="ref" href="#sec-accessible_attributes">6.1.2.2</a>) を使って一部の属性のみをアクセス可能にしている場合、このメソッドは期待どおりに動作しません。<code>update_attributes</code>を使うと、アクセス可能な属性<em>しか</em>更新されなくなるためです。このメソッドを使用していて、モデルの特定のカラムがなぜか更新できなくなったら、それらのカラムが<code>attr_accessible</code>で指定されているかどうかを確認してください。</p>

<div class="label" id="sec-user_validations"></div>


<h2><a id="sec-6_2" href="#sec-user_validations" class="heading"><span class="number">6.2</span>ユーザーを検証する</a></h2>


<p>ついに、<a class="ref" href="#sec-user_model">6.1</a>で作成したUserモデルに、アクセス可能な<code>name</code>と<code>email</code>属性が与えられました。しかし、これらの属性はどんな値でも取ることができてしまいます。現在は (空文字を含む) あらゆる文字列が有効です。名前とメールアドレスには、もう少し何らかの制限があってよいはずです。たとえば、<code>name</code>は空であってはならず、<code>email</code>はメールアドレスのフォーマットに従う必要があります。さらに、メールアドレスをユーザーがログインするときの一意のユーザー名として使おうとしているので、メールアドレスがデータベース内で重複することのないようにする必要もあります。</p>

<p>要するに、<code>name</code>と<code>email</code>にあらゆる文字列を許すのは避けるべきです。これらの属性値には、何らかの制約を与える必要があります。Active Recordでは<em>検証 (バリデーション: validation) </em>機能を使用してそのような制約を与えることができます。ここでは、よく使われるケースのうちのいくつかについて説明します。それらは<em>存在性 (presence)</em>の検証、<em>長さ (length)</em>の検証、<em>フォーマット (format)</em>の検証、<em>一意性 (uniqueness)</em>の検証です。<a class="ref" href="#sec-has_secure_password">6.3.4</a>では、よく使われる最終検証として<em>確認 (confirmation)</em>を追加します。<a class="ref" href="#sec-signup_failure">7.3</a>では、ユーザーが制約に違反したときに、検証機能によって自動的に表示される有用なエラーメッセージをお見せします。</p>

<div class="label" id="sec-initial_user_tests"></div>


<h3><a id="sec-6_2_1" href="#sec-initial_user_tests" class="heading"><span class="number">6.2.1</span>最初のユーザーテスト</a></h3>


<p>サンプルアプリケーションの他の機能と同様、Userモデルへの検証の追加もテスト駆動開発 (TDD) で行います。その理由は、以下のフラグを</p>

<pre class="verbatim">--no-test-framework</pre>


<p>(<a class="ref" href="#code-generate_users_controller">リスト5.28</a>の例とは異なり) Userモデルを作成したときに渡さなかったからです。<a class="ref" href="#code-generate_user_model">リスト6.1</a>のコマンドは、ユーザーをテストするための初期のspecを作成します。しかし今回の場合、specは実質的には空です (<a class="ref" href="#code-default_user_spec">リスト6.7</a>)。</p>

<div class="label" id="code-default_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.7</span> <span class="description">実質的に空になっているデフォルトのUser spec。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">pending</span> <span class="s2">&quot;add some examples to (or delete) </span><span class="si">#{</span><span class="bp">__FILE__</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは<code>pending</code>メソッドだけが置かれており、何か意味のあるコードでspecを埋めるように促しています。このコードの効果は、Userモデルのspecを実行することで確認できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb 
<span class="go">*</span>


<span class="go">Finished in 0.01999 seconds</span>
<span class="go">1 example, 0 failures, 1 pending</span>

<span class="go">Pending:</span>
<span class="go">  User add some examples to (or delete)</span>
<span class="go">  /Users/mhartl/rails_projects/sample_app/spec/models/user_spec.rb</span>
<span class="go">  (Not Yet Implemented)</span>
</pre></div>
</div>


<p>多くのシステムでは、pendingのspecはコマンドライン上で黄色で表示されます。それは、成功 (緑) と失敗 (赤) の間であることを意味します。</p>

<p>デフォルトのspecのアドバイスに従い、<a class="ref" href="#code-user_spec">リスト6.8</a>に示したいくつかのRSpecの例に置き換えてみましょう。</p>

<div class="label" id="code-user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.8</span> <span class="description"><code>:name</code>と<code>:email</code>属性のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-pretty_page_tests">リスト5.27</a>で見た<code>before</code>ブロックは前処理用で、各サンプルが実行される前にそのブロックの中のコードを実行します。この場合、<code>User.new</code>と初期化用の有効なハッシュを使って、新しい<code>@user</code>インスタンス変数を作成します。そして以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
</pre></div>
</div>


<p><a class="ref" href="#sec-pretty_rspec">5.3.4</a>で<code>page</code>変数を扱ったときと同じように、<code>@user</code>をテストサンプルのデフォルトのsubjectとして設定します。</p>

<p><a class="ref" href="#code-user_spec">リスト6.8</a>の2つのサンプルは、<code>name</code>属性と<code>email</code>属性の存在をテストします。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>これらのサンプルではRubyの<code>respond_to?</code>メソッドを暗黙的に使っています。このメソッドはシンボルを1つ引数として受け取り、引数として与えられたそのシンボルが表すメソッドまたは属性にオブジェクトが応答する場合は<code>true</code>を返し、応答しない場合は<code>false</code>を返します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:foobar</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>(<a class="ref" href="#sec-objects_and_message_passing">4.2.3</a>でも説明したとおり、Rubyではtrue/falseの真偽値を返すメソッド名の末尾に?記号を置く慣習があることを思い出してください)。これらのテストは、RSpecで使われる<em>論理値の慣習</em>に依存しています。以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>


<p>以下のRSpecのコードでテストされます。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
</pre></div>
</div>


<p>しかし、<code>subject { @user }</code>があるので、テストの中で<code>@user</code>を使わずに以下のように書くことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>このようなテストのおかげで、テスト駆動開発をベースに新しい属性やメソッドをUserモデルに追加することができます。さらに、すべての<code>User</code>オブジェクトがこれらのメソッドに応答する必要があるという仕様もここで明らかになりました。</p>

<p>この時点ではテストが失敗することを検証しておく必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p><a class="ref" href="#sec-database_migrations">6.1.1</a>で、<code>rake db:migrate</code>を使って開発データベースを作成しましたが、上のテストは失敗します。それというのも、<em>テストデータベース</em>はまだデータモデルの存在を知らないからです (実際、テストデータベースはまだ存在しません)。<code>db:test:prepare</code>というRakeタスクを使用して、正しい構造のテスト用データベースを作ることができます。これでテストにパスするようになります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>上のコマンドは、単に開発データベースのデータモデル<code>db/development.sqlite3</code>がテストデータベース<code>db/test.sqlite3</code>に反映されるようにするものです。よくある失敗のひとつに、マイグレーションの後でこのRakeタスクが実行できなくなるというのがあります。さらに、テストデータベースはときどき壊れることがあるので、その場合はリセットが必要です。もしテストスイートが理由もなく壊れるようなことがあれば、<code>rake db:test:prepare</code>を実行して、この問題が解決するか確認してみてください。</p>

<div class="label" id="sec-presence_validation"></div>


<h3><a id="sec-6_2_2" href="#sec-presence_validation" class="heading"><span class="number">6.2.2</span>プレゼンスを検証する</a></h3>


<p>おそらく最も基本的な検証 (validation) は<em>プレゼンス (存在性) </em>です。これは単に、与えられた属性が存在することを検証します。たとえばこの節では、ユーザーがデータベースに保存される前にnameとemailフィールドの両方が存在することを保証します。<a class="ref" href="#sec-signup_error_messages">7.3.2</a>では、この要求を新しいユーザーを作るためのユーザー登録フォームにまで徹底させる方法を確認します。</p>

<p>最初に<code>name</code>属性の存在を確認するテストを行いましょう。テスト駆動開発の最初のステップは<em>失敗する</em>テスト (<a class="ref" href="#sec-TDD">3.2.1</a>) を書くことですが、今回は適切なテストを書くための検証機能についてまだ十分に理解していないので、まず最初に検証を書きます。検証についてはコンソールを使って理解することにします。次に、検証部分をコメントアウトし、失敗するテストを書いて、最後にコメントアウトを解除した検証でテストがパスするかどうかを確認します。この手続きは、このような単純なテストでは大げさで気取ったものに感じられるかもしれませんが、著者はこれまでにテストそのものが間違っている “単純な” テストを山ほど見てきました。テスト駆動開発を慎重に進めることは、テストが正しく進められているという自信を得る<em>唯一の</em>方法です (上で紹介したコメントアウトのテクニックは、コードはあってもテストがどこにもないような<a href="http://en.wiktionary.org/wiki/quelle_horreur"><em>ひどい</em></a>アプリケーションを急いで救出するときにも役に立ちます)。</p>

<p>name属性の存在を検査する方法は、<a class="ref" href="#code-validates_presence_of_name">リスト6.9</a>に示したとおり、<code>validates</code>メソッドに<code>presence: true</code>という引数を与えて使うことです。<code>presence: true</code>という引数は、要素がひとつの<em>オプションハッシュ</em>です。<a class="ref" href="#sec-css_revisited">4.3.4</a>のようにメソッドの最後の引数としてハッシュを渡す場合、波かっこを付けなくても問題ありません (<a class="ref" href="#sec-adding_to_the_layout">5.1.1</a>でも説明したように、Railsのオプションハッシュは繰り返し登場するテーマです)。</p>

<div class="label" id="code-validates_presence_of_name"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.9</span> <span class="description"><code>name</code>属性の存在を検証する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-validates_presence_of_name">リスト6.9</a>は一見魔法のように見えるかもしれません。しかし<code>attr_accessible</code>同様、<code>validates</code>もただのメソッドに過ぎません。かっこを使用して<a class="ref" href="#code-validates_presence_of_name">リスト6.9</a>を同等のコードに書き換えたものを以下に示します。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>

  <span class="n">validates</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>コンソールを起動して、Userモデルに検証を追加した効果を見てみましょう<sup class="footnote" id="fnref-6_9"><a href="#fn-6_9">9</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p><code>user.save</code>は<code>false</code>を返しました。これは保存に失敗したことを意味します。最後のコマンドは、<code>valid?</code>メソッドで、オブジェクトがひとつ以上の検証に失敗したときに<code>false</code>を返します。 すべての検証がパスした場合は<code>true</code>を返します。今回の場合、検証がひとつしかないので、どの検証が失敗したかわかります。しかし、失敗したときに作られる<code>errors</code>オブジェクトを使って確認すれば、さらに便利です。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Name can&#39;t be blank&quot;]</span>
</pre></div>
</div>


<p>(このエラーメッセージから、Railsが属性の存在性を検査するときに<code>blank?</code>メソッド (<a class="ref" href="#sec-modifying_built_in_classes">4.4.3</a>の終わりに登場) を使用していることが伺えます。)</p>

<p>次は失敗するテストです。最初に、テストが失敗することを確認するために、この時点 (<a class="ref" href="#code-commented_out_validation">リスト6.10</a>) で検証をコメントアウトしてみましょう。</p>

<div class="label" id="code-commented_out_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.10</span> <span class="description">失敗するテストを確認するために検証をコメントアウトする。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="c1"># validates :name, presence: true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>最初の段階の検証テストを<a class="ref" href="#code-failing_validates_name_spec">リスト6.11</a>に示します。</p>

<div class="label" id="code-failing_validates_name_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.11</span> <span class="description"><code>name</code>属性の検証に対する、失敗するテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;when name is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>最初の新しいサンプルは、基本となるただのテストです。これを使用して、まず<code>@user</code>オブジェクトが有効かどうかを確認します。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のコードは<a class="ref" href="#sec-initial_user_tests">6.2.1</a>で見た別のRSpecの真偽値の慣習を示すサンプルです。あるオブジェクトが、真偽値を返す<code>foo?</code>というメソッドに応答するのであれば、それに対応する<code>be_foo</code>というテストメソッドが (自動的に) 存在します。この場合、以下のメソッド呼び出しの結果をテストすることができます。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">valid?</span>
</pre></div>
</div>


<p>上のコードの場合、対応するテストコードは以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
</pre></div>
</div>


<p>以前と同じように、<code>subject { @user }</code>があるので<code>@user</code>を使わずに書くことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
</pre></div>
</div>


<p>2つ目のテストは、まずユーザーのnameに無効な値 (blank) を設定し、<code>@user</code>オブジェクトの結果も無効になることをテストして確認します。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when name is not present&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>ユーザーのnameに無効な値 (blank) を設定するには<code>before</code>ブロックを使います。次にユーザーオブジェクトの結果が無効であることを確認します。</p>

<p>この時点でテストが失敗することを確認してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">...</span><span class="go">F</span>
<span class="go">4 examples, 1 failure</span>
</pre></div>
</div>


<p>それではここで、テストにパスするために検証部分のコメントアウトを解除しましょう (つまり、<a class="ref" href="#code-commented_out_validation">リスト6.10</a>を<a class="ref" href="#code-validates_presence_of_name">リスト6.9</a>に戻します)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
<span class="go">....</span>
<span class="go">4 examples, 0 failures</span>
</pre></div>
</div>


<p>もちろん、今度はメールアドレスの存在性も検証しましょう。このテスト (<a class="ref" href="#code-validates_email_spec">リスト6.12</a>) は、<code>name</code>属性のテストと似ています。</p>

<div class="label" id="code-validates_email_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.12</span> <span class="description"><code>email</code>属性の存在性のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>以下の<a class="ref" href="#code-validates_presence_of_email">リスト6.13</a>に示すように、メールアドレス検証の実装も名前の検証と実質的に同じです。</p>

<div class="label" id="code-validates_presence_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.13</span> <span class="description"><code>name</code>属性と<code>email</code>属性の存在性を検証する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これですべてのテストにパスするはずです。これで、存在性の検証は完成しました。</p>

<div class="label" id="sec-length_validation"></div>


<h3><a id="sec-6_2_3" href="#sec-length_validation" class="heading"><span class="number">6.2.3</span>長さを検証する</a></h3>


<p>各ユーザーは、Userモデル上に名前を持つよう強制されます。しかし、これだけでは十分ではありません。ユーザーの名前はサンプルWebサイトに表示されるものなので、名前の長さにも制限を与える必要があります。<a class="ref" href="#sec-presence_validation">6.2.2</a>で既に同じような作業を行ったので、この実装は簡単です。</p>

<p>まずはテストを作成します。最長のユーザー名の長さに科学的な根拠はありませんので、単に<code>50</code>という上限として手頃な値を使うことにします。つまりここでは、<code>51</code>文字の名前は長すぎることを検証します (<a class="ref" href="#code-length_validation_test">リスト6.14</a>)。</p>

<div class="label" id="code-length_validation_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.14</span> <span class="description"><code>name</code>の長さ検証のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when name is too long&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-length_validation_test">リスト6.14</a>では、51文字の文字列を簡単に作るために “文字列のかけ算” を使いました。結果をコンソール上で確認できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span>
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
<span class="gp">&gt;&gt; </span><span class="p">(</span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 51</span>
</pre></div>
</div>


<p>今の時点では<a class="ref" href="#code-length_validation_test">リスト6.14</a>のテストは失敗するはずです。これをパスさせるためには、長さを強制するための検証の引数について知っておく必要があります。<code>:maximum</code>パラメータと共に用いられる<code>:length</code>は、長さの上限を強制します (<a class="ref" href="#code-length_validation">リスト6.15</a>)。</p>

<div class="label" id="code-length_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.15</span> <span class="description"><code>name</code>属性の長さの検証を追加する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これでテストにパスするはずです。パスしたテストスイートを流用して、今度は少し難しい、メールアドレスのフォーマット検証作業に取りかかりましょう。</p>

<div class="label" id="sec-format_validation"></div>


<h3><a id="sec-6_2_4" href="#sec-format_validation" class="heading"><span class="number">6.2.4</span>フォーマットを検証する</a></h3>


<p><code>name</code>属性の検証には、空文字でない、名前が51文字未満であるという最小限の制約しか与えていませんでした。<code>email</code>属性の場合は、もっと厳重な要求を満たさなければなりません。これまでは空のメールアドレスのみを禁止してきましたが、ここではメールアドレスにおなじみのパターン<code>user@example.com</code>に合っているかどうかも確認することを要求します。</p>

<p>なお、ここで使用するテストや検証は、形式の有効なメールアドレスを受け入れ、形式の無効なものを拒否するだけであり、決して徹底的なものではないという点にご注意ください。最初に、有効なメールアドレスと無効なメールアドレスのコレクションに対するテストを行いましょう。このコレクションを作るために、以下のコンソールセッションに示したような、文字列の配列を簡単に作れる<code>%w[]</code>という便利なテクニックを知っておくと良いでしょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[foo bar baz]</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.</span><span class="sx">COM THE_US-ER@foo.bar.org first.last@foo.jp]</span>
<span class="go">=&gt; [&quot;user@foo.</span><span class="go">COM&quot;, &quot;THE_US-ER@foo.bar.org&quot;, &quot;first.last@foo.jp&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="n">address</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">user@foo.</span><span class="go">COM</span>
<span class="go">THE_US-ER@foo.bar.org</span>
<span class="go">first.last@foo.jp</span>
</pre></div>
</div>


<p><code>each</code>メソッドを使って<code>メールアドレス</code>の配列の各要素を繰り返し取り出しました (<a class="ref" href="#sec-blocks">4.3.2</a>)。このテクニックを学んだことで、基本となるメールアドレスフォーマット検証のテストを書く準備が整いました (<a class="ref" href="#code-email_format_validation_tests">リスト6.16</a>)。</p>

<div class="label" id="code-email_format_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.16</span> <span class="description">メールアドレスフォーマットの検証テスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email format is invalid&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be invalid&quot;</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo,com user_at_foo.org example.user@foo.</span>
<span class="sx">                     foo@bar_baz.com foo@bar+baz.com]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">invalid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">invalid_address</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
      <span class="k">end</span>      
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when email format is valid&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be valid&quot;</span> <span class="k">do</span>
      <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.</span><span class="sx">COM A_US-ER@f.b.org frst.lst@foo.jp a+b@baz.cn]</span>
      <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">valid_address</span><span class="o">|</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">valid_address</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
      <span class="k">end</span>      
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>既に述べたとおり、上のテストはすべてを盛り込んだものではありませんが、一般的に有効なメールアドレスの形式である<code>user@foo.COM</code>、<code>THE_US-ER@foo.bar.org </code> (大文字、アンダースコア、複合ドメイン) 、<code>first.last@foo.jp</code> (一般的な企業のユーザー名「<code>名.姓</code>」と、2文字のトップレベルドメイン「<code>jp</code>」) を、いくつかの無効な形式と共に確認します。</p>

<p>メールアドレスのフォーマット検証を行うアプリケーションコードでは、<code>validates</code>メソッドの<code>:format</code>引数に、フォーマットを定義するための<em>正規表現 (regular expression)</em> (または<em>regex</em>) を与えます (<a class="ref" href="#code-validates_format_of_email">リスト6.17</a>)。</p>

<div class="label" id="code-validates_format_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.17</span> <span class="description">正規表現を使ったメールアドレスフォーマットの検証。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span>  <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]</span><span class="sr">+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>正規表現<code>VALID_EMAIL_REGEX</code>は<em>定数</em>です。大文字で始まる名前はRubyでは定数を意味します。以下のコードは、</p>

<div class="code"><div class="highlight"><pre>  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]</span><span class="sr">+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">}</span>
</pre></div>
</div>


<p>このパターンに一致するメールアドレスだけが有効であることをチェックします (<code>VALID_EMAIL_REGEX</code>は大文字で始まるので、Rubyの<em>定数</em>として扱われ、値は変更できません)。</p>

<p>ところで、この正規表現パターンはどうやって作ればよいのでしょうか。正規表現は簡潔な (<a href="http://catb.org/jargon/html/L/line-noise.html">読めない</a>という人もいるにはいますが) テキストパターンマッチング言語から成ります。正規表現を組み立てることを学ぶのはそれだけでひとつの技術分野であり、手短に説明するのは簡単ではありませんが、ともあれ最初の説明のために<code>VALID_EMAIL_REGEX</code>をビットサイズの破片に分解しました (<a class="ref" href="#table-valid_email_regex">表6.1</a>)<sup class="footnote" id="fnref-6_10"><a href="#fn-6_10">10</a></sup>。限られた紙面で正規表現を本格的に学ぶには、素晴らしい正規表現エディタである<a href="http://www.rubular.com/">Rubular</a> (<a class="ref" href="#fig-rubular">図6.4</a>) が必要不可欠です<sup class="footnote" id="fnref-6_11"><a href="#fn-6_11">11</a></sup>。RubularのWebサイトは、正規表現を作るための美しく対話的なインターフェイスを持っています。また、手軽な正規表現のクイックリファレンスにもなります。Rubularのサイトをブラウザで開き、<a class="ref" href="#table-valid_email_regex">表6.1</a>の表現をひとつずつ入力して結果を確かめながら正規表現を学ぶことをぜひともお勧めします。正規表現について学んだことがなくても、Rubularを使えば数時間で慣れることができます (注: <a class="ref" href="#code-validates_format_of_email">リスト6.17</a>の正規表現をRubularで使う場合、冒頭の<tt class="verb">\A</tt>と末尾の<tt class="verb">\z</tt>の文字は含めないでください)。</p>

<div class="label" id="table-valid_email_regex"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>表現</strong></th><th class="align_left"><strong>意味</strong></th></tr><tr class="top_bar"><td class="align_left"><tt class="verb">/\A[\w+\-.]+@[a-z\d\-.]</tt><tt class="verb">+\.[a-z]+\z/i</tt></td><td class="align_left">(完全な正規表現)</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">正規表現の開始を示す</td></tr><tr><td class="align_left"><tt class="verb">\A</tt></td><td class="align_left">文字列の先頭</td></tr><tr><td class="align_left"><tt class="verb">[\w+\-.]</tt><tt class="verb">+</tt></td><td class="align_left">英文字、数字、プラス記号、ハイフン、ドットのいずれかを少なくとも1文字以上繰り返す</td></tr><tr><td class="align_left"><tt class="verb">@</tt></td><td class="align_left">アットマーク</td></tr><tr><td class="align_left"><tt class="verb">[a-z\d\-.]</tt><tt class="verb">+</tt></td><td class="align_left">英小文字、数字、ハイフン、ドットのいずれかを少なくとも1文字以上繰り返す</td></tr><tr><td class="align_left"><tt class="verb">\.</tt></td><td class="align_left">ドット</td></tr><tr><td class="align_left"><tt class="verb">[a-z]+</tt></td><td class="align_left">英小文字を少なくとも1文字以上繰り返す</td></tr><tr><td class="align_left"><tt class="verb">\z</tt></td><td class="align_left">文字列の末尾</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">正規表現の終わりを示す</td></tr><tr><td class="align_left"><tt class="verb">i</tt></td><td class="align_left">大文字小文字を無視するオプション</td></tr></table></div><div class="caption"><span class="header">表6.1</span><span class="description"><a class="ref" href="#code-validates_format_of_email">リスト6.17</a>のメールの正規表現の分解</span></div></div>


<p>ところで、公式標準によるとメールアドレスに完全に一致する正規表現は存在するのだそうです。しかし、苦労して導入するほどの甲斐はありません。<a class="ref" href="#code-validates_format_of_email">リスト6.17</a>の例は問題なく動作しますし、おそらく公式のものより良いでしょう<sup class="footnote" id="fnref-6_12"><a href="#fn-6_12">12</a></sup>。</p>

<div class="label" id="fig-rubular"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/rubular.png" alt="rubular" /></span></div><div class="caption"><span class="header">図6.4</span><span class="description">素晴らしい正規表現エディタ<a href="http://www.rubular.com/">Rubular</a>。<a href="http://railstutorial.org/images/figures/rubular-full.png">(拡大)</a></span></div></div>


<p>これでテストはすべてパスするはずです(実際、この有効なメールアドレスのテストはこれまでいつもパスしてきました。正規表現のプログラミングは間違いが起こりやすいことで有名なので、ここで行なっている有効なメールアドレスのテストは、主として<code>VALID_EMAIL_REGEX</code>に対する形式的な健全性チェックに過ぎません)。残る制約は、メールアドレスが一意であることを強制するものだけとなりました。</p>

<div class="label" id="sec-uniqueness_validation"></div>


<h3><a id="sec-6_2_5" href="#sec-uniqueness_validation" class="heading"><span class="number">6.2.5</span>一意性を検証する</a></h3>


<p>メールアドレスの一意性を強制するために (ユーザー名として使うために)、<code>validates</code>メソッドの<code>:unique</code>オプションを使います。ただしここで<em>重大な</em>警告があります。以下の文面は流し読みせず、必ず注意深く読んでください。</p>

<p>今回もいつものようにテストを作成するところから始めます。モデルのテストではこれまで、主に<code>User.new</code>を使ってきました。このメソッドは単にメモリ上にRubyのオブジェクトを作るだけです。しかし、一意性のテストのためには、メモリ上だけではなく、実際にレコードをデータベースに登録する必要があります<sup class="footnote" id="fnref-6_13"><a href="#fn-6_13">13</a></sup>。(最初の段階の) 重複メールアドレスのテストを<a class="ref" href="#code-validates_uniqueness_of_email_test">リスト6.18</a>に示します。</p>

<div class="label" id="code-validates_uniqueness_of_email_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.18</span> <span class="description">重複するメールアドレスの拒否のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email address is already taken&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">user_with_same_email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードのメソッドは、<code>@user</code>と同じメールアドレスでユーザーを作成します。そのために、<code>@user.dup</code>を使用して同じ属性を持つ重複ユーザーを作ります。次にそのユーザーを保存しようとすると、元の<code>@user</code>のメールアドレスが既にデータベースに存在するため、この重複メールアドレスは無効になるはずです。</p>

<p><a class="ref" href="#code-validates_uniqueness_of_email">リスト6.19</a>のコードをパスする、新しいテストを<a class="ref" href="#code-validates_uniqueness_of_email_test">リスト6.18</a>に示します。</p>

<div class="label" id="code-validates_uniqueness_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.19</span> <span class="description">メールアドレスの一意性の検査。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>実装の途中ですが、ここでひとつ補足します。通常、メールアドレスでは大文字小文字が区別されません。すなわち、<code>foo@bar.com</code>は<code>FOO@BAR.COM</code>や<code>FoO@BAr.coM</code>と書いても扱いは同じです。従って、メールアドレスの検証ではこのような場合も考慮する必要があります<sup class="footnote" id="fnref-6_14"><a href="#fn-6_14">14</a></sup> 。<a class="ref" href="#code-validates_uniqueness_of_email_case_insensitive_test">リスト6.20</a>のコードでは、大文字小文字を区別しないものをテストしています。</p>

<div class="label" id="code-validates_uniqueness_of_email_case_insensitive_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.20</span> <span class="description">大文字小文字を区別しない、重複するメールアドレスの拒否のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when email address is already taken&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">user_with_same_email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">dup</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
      <span class="n">user_with_same_email</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードではStringの<code>upcase</code>メソッドを使っています (<a class="ref" href="#sec-blocks">4.3.2</a>)。このテストは最初のメールアドレスの重複テストと同じことをしていますが、大文字に変換したメールアドレスを使っている点が異なります。もしこのテストが少し抽象的すぎると感じるなら、Railsコンソールを起動して確認しましょう。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="go">=&gt; &quot;USER@EXAMPLE.COM&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">dup</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_same_email</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>現在の一意性検証では大文字小文字を区別しているため、<code>user_with_same_email.valid?</code>は<code>true</code>になります。しかし、ここでは<code>false</code>になる必要があります。幸い、<code>:uniqueness</code>では<code>:case_sensitive</code>といううってつけのオプションが使用できます (<a class="ref" href="#code-validates_uniqueness_of_email_case_insensitive">リスト6.21</a>)。</p>

<div class="label" id="code-validates_uniqueness_of_email_case_insensitive"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.21</span> <span class="description">メールアドレスの大文字小文字を無視した一意性の検証</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness:</span> <span class="p">{</span> <span class="ss">case_sensitive:</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、単に<code>true</code>を<code>case_sensitive: false</code>で置き換えただけであることにご注目ください。Railsはこの場合、<code>:uniqueness</code>を<code>true</code>と判断します。この時点で、アプリケーションは重要な警告と共にメールアドレスの一意性を強制し、テストスイートもパスするはずです。</p>

<div class="label" id="sec-the_caveat"></div>


<h4><a id="sec-6_2_5_1" href="#sec-the_caveat" class="heading">一意性の警告</a></h4>


<p>上で示した警告には、1つ小さな問題があります。</p>

<p><strong><code>validates :uniqueness</code>を使用しても、一意性は保証されません。</strong></p>

<p>えっ！何が問題になるのでしょうか。以下のシナリオを見てください。</p>

<ol>
<li>アリスはサンプルアプリケーションにユーザー登録します。メールアドレスはalice@wonderland.comです。</li>
<li>アリスは誤って “Submit” を素早く<em>2回</em>クリックしてしまいます。そのためリクエストが2つ連続で送信されます。</li>
<li>次のようなことが順に発生します。リクエスト1は、検証にパスするユーザーをメモリー上に作成します。リクエスト2でも同じことが起きます。リクエスト1のユーザーが保存され、リクエスト2のユーザーも保存されます。</li>
<li>この結果、一意性の検証が行われているにもかかわらず、同じメールアドレスを持つ2つのユーザーレコードが作成されてしまいます。</li>
</ol>


<p>上のシナリオが信じがたいもののように思えるかもしれませんが、どうか信じてください。RailsのWebサイトでは、トラフィックが多いときにこのような問題が発生する可能性があるのです。幸い、解決策の実装は簡単です。実は、データベースレベルでも一意性を強制するだけでこの問題は解決します。具体的には、emailカラムにデータベースの<em>インデックス</em>を作成し、そのインデックスが一意であることを要求します。</p>

<p>emailインデックスを追加すると、データモデリングの変更が必要になります。Railsでは (<a class="ref" href="#sec-database_migrations">6.1.1</a>で見たように) マイグレーションでインデックスを追加します。<a class="ref" href="#sec-database_migrations">6.1.1</a>で、Userモデルを生成すると自動的に新しいマイグレーションが作成されたことを思い出してください (<a class="ref" href="#code-users_migration">リスト6.2</a>)。今回の場合は、既に存在するモデルに構造を追加するので、以下のように<code>migration</code>ジェネレーターを使用してマイグレーションを直接作成する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_index_to_users_email
</pre></div>
</div>


<p>ユーザー用のマイグレーションと異なり、メールアドレスの一意性のマイグレーションは未定義になっています。<a class="ref" href="#code-email_uniqueness_index">リスト6.22</a>のように定義を記述する必要があります<sup class="footnote" id="fnref-6_15"><a href="#fn-6_15">15</a></sup>。</p>

<div class="label" id="code-email_uniqueness_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.22</span> <span class="description">メールアドレスの一意性を強制するためのマイグレーション。</span><br /><span class="description"> <code>db/migrate/[timestamp]_add_index_to_users_email.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddIndexToUsersEmail</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">unique:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、<code>users</code>テーブルの<code>email</code>カラムにインデックスを追加するために<code>add_index</code>というRailsのメソッドを使っています。インデックス自体は一意性を強制しませんが、オプションで<code>unique: true</code>を指定することで強制できるようになります。</p>

<p>最後に、データベースをマイグレートします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
</pre></div>
</div>


<p>(上のコマンドが失敗した場合は、実行中のサンドボックスのコンソールセッションを終了してみてください。そのセッションがデータベースをロックしてマイグレーションを妨害していた可能性があります)。一意性を強制すると何が起きるかについて関心のある方は、<code>db/schema.rb</code>を開いてみると以下のような行があるはずです。</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;index_users_on_email&quot;</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div>
</div>


<p>残念なことに、メールアドレスの一意性を保証するためには、もう1つやらなければならないことがあります。それは、メールアドレスをデータベースに保存する前にすべての文字を小文字に変換することです。その理由は、データベースのアダプタが常に大文字小文字を区別するインデックスを使っているとは限らないからです<sup class="footnote" id="fnref-6_16"><a href="#fn-6_16">16</a></sup>。これを行うには<a href="http://en.wikipedia.org/wiki/Callback_(computer_science)"><em>コールバック</em></a>というテクニックを利用します。コールバックとは、Active Recordオブジェクトが持続している間のどこかの時点で、Active Recordオブジェクトに呼び出してもらうメソッドです (Rails APIの「<a href="http://api.rubyonrails.org/v3.2.0/classes/ActiveRecord/Callbacks.html">コールバックの登録ポイント</a> (英語)」を参照してください)。今回の場合は、<code>before_save</code>コールバックを使います。<a class="ref" href="#code-email_downcase">リスト6.23</a>に示したように、ユーザーをデータベースに保存する前にemail属性を強制的に小文字に変換します。</p>

<div class="label" id="code-email_downcase"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.23</span> <span class="description">email属性を小文字に変換してメールアドレスの一意性を保証する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-email_downcase">リスト6.23</a>のコードは、<code>before_save</code>コールバックにブロックを渡してユーザーのメールアドレスを設定します。設定されるメールアドレスは、現在の値をStringクラスの<code>downcase</code>メソッドを使って小文字バージョンにしたものです。このコードは少し上級者向けなので、今はただ、このコードが動作することを信じてください。それでは気の済まない方は、<a class="ref" href="#code-validates_uniqueness_of_email">リスト6.19</a>から一意性の検証部分をコメントアウトし、重複したメールアドレスを持つユーザーを試しに作成してみれば、エラーが発生するはずです (このテクニックについては<a class="ref" href="#sec-remember_me">8.2.1</a>でもう一度取り上げます)。</p>

<p>これで、先に述べたアリスのシナリオはうまくいくようになります。データベースは、ユーザーのレコードを最初のリクエストに基づいて保存しますが、次の保存は一意性の制約に反するので拒否します (Railsのログにエラーが出力されますが、害は生じません。ここで発生した<code>ActiveRecord::StatementInvalid</code>例外を実際にキャッチすることもできます。具体例については<a href="http://github.com/insoshi/insoshi/blob/master/app/controllers/people_controller.rb">Insoshi</a>のコードを見てください。ただしこのチュートリアルでは解説しません)。インデックスをemail属性に追加したことで、<a class="ref" href="#sec-finding_user_objects">6.1.4</a>で述べた2番目の目標も達成されます。これは、<code>find_by_email</code>の効率の問題がインデックスによって解決されたためです (<a class="ref" href="#sidebar-database_indices">コラム 6.2</a>)。</p>

<div class="label" id="sidebar-database_indices"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 6.2</span></span><span class="title"><span class="description">データベースのインデックス</span></span>
<p>データベースにカラムを作成するとき、そのカラムでレコードを<em>検索する (find) </em>必要があるかどうかを考えることは重要です。たとえば、<a class="ref" href="#code-users_migration">リスト6.2</a>のマイグレーションによって作成された<tt>email</tt>属性について考えてみましょう。<a class="ref" href="#cha-sign-up">第7章</a>ではユーザーをサンプルアプリにログインできるようにしますが、このとき、送信されたものと一致するメールアドレスのユーザーのレコードをデータベースの中から探しだす必要があります。残念なことに、(インデックスなどの機能を持たない) 素朴なデータモデルにおいてユーザーをメールアドレスで探すには、データベースの<em>ひとりひとりの</em>ユーザーの行を端から順に読み出し、そのemail属性と与えられたメールアドレスを比較するという非効率的な方法しかありません。これは、データベースの世界では<em>全表スキャン</em>として知られており、数千のユーザーがいる実際のサイトでは<a href="http://catb.org/jargon/html/B/Bad-Thing.html">きわめて不都合</a>です。</p>

<p>emailカラムにインデックスを追加することで、この問題を解決することができます。データベースのインデックスを理解するためには、本の索引との類似性を考えるとよいでしょう。本の中で、与えられた言葉 (例えば、“foobar”) が出てくる箇所をすべて見つけるためには、ページを端から順にめくって最後まで探す必要があります。本の索引を利用すれば、“foobar”を含むすべてのページを索引の中から探すだけで済みます。データベースのインデックスも本質的には本の索引と同じように動作します。</p>
</div>




<div class="label" id="sec-adding_a_secure_password"></div>


<h2><a id="sec-6_3" href="#sec-adding_a_secure_password" class="heading"><span class="number">6.3</span>セキュアなパスワードを追加する</a></h2>


<p>この節では、ユーザーに最後の属性を追加します。セキュアパスワードは、サンプルアプリケーションでユーザーを認証するために使用します。セキュアパスワードという手法では、各ユーザーにパスワードとパスワードの確認を入力させ、それを (そのままではなく) 暗号化したものをデータベースに保存します。また、入力されたパスワードを使用してユーザーを<em>認証</em>する手段と、<a class="ref" href="#cha-sign-in-sign-out">第8章</a>で使用する、ユーザーがサイトにサインインできるようにする手段も提供します。</p>

<p>ユーザーの認証は、パスワードの送信、暗号化、データベース内の暗号化された値との比較という手順を踏みます。比較の結果が一致すれば、送信されたパスワードは正しいと認識され、そのユーザーは認証されます。ここで、生のパスワードではなく、暗号化されたパスワード同士を比較していることにご注目ください。こうすることで、生のパスワードをデータベースに保存するという危険なことをしなくてもユーザーを認証できます。これで、仮にデータベースの内容が盗まれたり覗き見されるようなことがあっても、パスワードの安全性が保たれます。</p>

<p>セキュアなパスワードの実装は、<code>has_secure_password</code>というRailsのメソッドを呼び出すだけでほとんど終わってしまいます (このメソッドはRails 3.1から導入されました)。このメソッド1つだけでセキュアなパスワードの実装がほとんど終わってしまうので、逆にこの機能を一から手作りするのは簡単ではありません。そのため、<a class="ref" href="#sec-password_and_confirmation">6.3.2</a>からは多数のテストを作成し、これらをすべてパスするようにします。この機能の実装中に泥沼にはまり込んでしまうこともあると思いますが、どうかあきらめずに最後までやり通してください。<a class="ref" href="#sec-has_secure_password">6.3.4</a>までたどり着ければ、その苦労を補って余りある褒美が待っています (スクリーンキャストは、このような一からの手作り開発手順を解説するのに向いています。この課題を十分に理解したい方は「<a href="http://railstutorial.org/screencasts">Ruby on Rails Tutorial screencasts</a> (英語)」を参照してください)。</p>

<div class="label" id="sec-an_encrypted_password"></div>


<h3><a id="sec-6_3_1" href="#sec-an_encrypted_password" class="heading"><span class="number">6.3.1</span>暗号化されたパスワード</a></h3>


<p>最初に、ユーザーのデータモデルに必要な変更を行います。具体的には、<code>users</code>テーブルに<code>password_digest</code>カラムを追加します (<a class="ref" href="#fig-user_model_password_digest">図6.5</a>)。なお、<em>digest</em>という言葉は<a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function">暗号化用ハッシュ関数</a>の用語が語源です。<a class="ref" href="#sec-has_secure_password">6.3.4</a>の実装が動作するには、カラム名を正確に<code>password_digest</code>とする必要があります。パスワードを適切に暗号化することで、たとえ攻撃者によってデータベースからパスワードをコピーされてもWebサイトにサインインされることのないようにできます。</p>

<div class="label" id="fig-user_model_password_digest"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_password_digest.png" alt="user_model_password_digest" /></span></div><div class="caption"><span class="header">図6.5</span><span class="description">Userモデルに<code>password_digest</code>属性を追加する。</span></div></div>


<p>ハッシュ関数には最新の<a href="http://en.wikipedia.org/wiki/Bcrypt">bcrypt</a>を使用し、パスワードを不可逆的に暗号化してパスワードハッシュを作成します。サンプルアプリケーションでbcryptを使用するために、<code>bcrypt-ruby</code> gemを<code>Gemfile</code>に追加します (<a class="ref" href="#code-bcrypt_ruby">リスト6.24</a>)。</p>

<div class="label" id="code-bcrypt_ruby"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.24</span> <span class="description"><code>bcrypt-ruby</code>を<code>Gemfile</code>に追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>次に<code>bundle install</code>を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>このとき、システム環境によっては以下の警告が出力されることがあります。</p>

<div class="code"><div class="highlight"><pre><span class="go">make: /usr/bin/gcc-4.2: No such file or directory</span>
</pre></div>
</div>


<p>この問題を修正するには、<code>clang</code>フラグを追加してRVMを再インストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm reinstall 1.9.3 --with-gcc<span class="o">=</span>clang
</pre></div>
</div>


<p>ユーザーはpassword_digestカラムにアクセスしなければならないので、<a class="ref" href="#code-respond_to_password_digest">リスト6.25</a>に示したように、ユーザーオブジェクトは<code>password_digest</code>に応答する必要があります。</p>

<div class="label" id="code-respond_to_password_digest"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.25</span> <span class="description">Userオブジェクトに<code>password_digest</code>カラムがあることを確認するテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストがパスするには、最初に<code>password_digest</code>カラム用の適切なマイグレーションを生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_password_digest_to_users password_digest:string
</pre></div>
</div>


<p>上のコマンドの最初の引数はマイグレーション名、次の引数は作成する属性の名前と型です (<a class="ref" href="#code-generate_user_model">リスト6.1</a>で最初に<code>users</code>テーブルを生成したときのマイグレーションと比較してみてください)。マイグレーション名は自由に指定できますが、上のように末尾を<code>_to_users</code>にしておくことをお勧めします。こうしておくと、<code>users</code>テーブルにカラムを追加するマイグレーションがRailsによって自動的に作成されるからです。また、上のコマンドに2番目の引数を与えることで、<a class="ref" href="#code-password_migration">リスト6.26</a>のように完全なマイグレーションを構成するための情報をRailsに与えることができます。</p>

<div class="label" id="code-password_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.26</span> <span class="description"><code>password_digest</code>カラムを<code>users</code>テーブルに追加するマイグレーション。</span><br /><span class="description"> <code>db/migrate/[ts]_add_password_digest_to_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddPasswordDigestToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:password_digest</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、<code>add_column</code>メソッドを使用して<code>password_digest</code> カラムを<code>users</code>テーブルに追加しています。</p>

<p>以下のように開発データベースをマイグレーションしてテストデータベースを準備することで、<a class="ref" href="#code-respond_to_password_digest">リスト6.25</a>の失敗するテストをパスすることができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
<span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-password_and_confirmation"></div>


<h3><a id="sec-6_3_2" href="#sec-password_and_confirmation" class="heading"><span class="number">6.3.2</span>パスワードと確認</a></h3>


<p><a class="ref" href="#fig-signup_mockup_preview">図6.1</a>のモックアップに示したように、ユーザーにパスワードを確認させるようにしましょう。パスワードの確認入力は、入力ミスを減らすためにWebで広く使用されています。パスワード確認の強制はコントローラの階層でも行うことができますが、モデルの中でActive Recordを使用して制限を与えるのが慣習になっています。そのためには、<code>password</code>属性と<code>password_confirmation</code>属性をUserモデルに追加し、レコードをデータベースに保存する前に2つの属性が一致するように要求します。これまでに使用した属性と異なり、パスワード関連の属性は<em>仮想</em>にします。つまり、これらの属性は一時的にメモリ上に置き、データベースには保存されないようにします。<a class="ref" href="#sec-has_secure_password">6.3.4</a>でも説明しますが、これらの仮想属性は<code>has_secure_password</code>では自動的に実装されます。</p>

<p>最初に、<code>respond_to</code>を使用してパスワードとパスワードの確認を<a class="ref" href="#code-user_respond_to_password">リスト6.27</a>のようにテストします。</p>

<div class="label" id="code-user_respond_to_password"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.27</span> <span class="description"><code>password</code>属性と<code>password_confirmation</code>属性をテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、以下のように<code>User.new</code>ハッシュの初期化に<code>:password</code>と<code>:password_confirmation</code>を追加していることにご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                   <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>パスワードは空欄であってはならないので、パスワードの存在確認テストを別に追加します。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when password is not present&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>パスワードの不一致テストはこのすぐ後に追加するので、上のコードではパスワードとパスワードの確認を両方とも空欄にすることでパスワードの<em>存在</em>確認テストを行なっています。ここでは、1つの行でいくつもの代入を行えるRubyの機能を使用しています。たとえば、以下のようにコンソール上で<code>a</code>と<code>b</code>に<code>3</code>を一括で代入することができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span>
<span class="go">=&gt; 3</span>
</pre></div>
</div>


<p>この機能を使用して、ここでは以下のように2つのパスワード関連の属性をどちらも<code>&quot; &quot;</code>に設定しています。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
</pre></div>
</div>


<p>パスワードとパスワードの確認が一致するかどうかもテストする必要があります。パスワードが一致<em>する</em>場合については既に<code>it { should be_valid }</code>で確認できるので、次は以下のように不一致の場合のテストを追加します。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when password doesn&#39;t match confirmation&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;mismatch&quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>原理的にはテストは以上で終わりですが、しかしまだカバーされていない状態があります。パスワードの確認が空欄の場合はどうなるでしょうか。「パスワードの確認がスペース文字だがパスワードは有効」な場合、両者は一致しないのでパスワードの確認の検証で検出されます。「パスワードとパスワードの確認がどちらもスペース文字」の場合、パスワードの存在確認テストで検出されます。残念ながら、1つだけ漏れがあります。それは、パスワードの確認が<em>nil</em>の場合です。この状態はWebからの入力では決して発生しませんが、コンソールでなら以下のように発生させることができます。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>            <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="kp">nil</span><span class="p">)</span>
</pre></div>
</div>


<p>パスワードの確認が<code>nil</code>の場合、パスワードの確認の検証はRailsによって実行されません。つまり、コンソール上でならパスワードの確認を回避してユーザーを作成できてしまうということです (もちろん、<em>現時点では</em>検証をそもそも実装していないので、実際には上のコードはすべて動作してしまいます) 。この状態を防ぐには、nilを検出できるテストを追加します。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;when password confirmation is nil&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>(この振る舞いは、Railsのマイナーなバグであると思います。おそらく今後のバージョンで修正されるでしょう。いずれの場合も、nilの検証を加えることで問題は生じません)。</p>

<p>ここまでのすべてを盛り込んだ失敗するテストを<a class="ref" href="#code-password_tests">リスト6.28</a>に示します。この節の冒頭で述べたように、<code>has_secure_password</code>には多くの機能が含まれているため、セキュアパスワードを手作りで実装するのは簡単ではありません。従って、この時点では新しいテストはすべて失敗します。<a class="ref" href="#sec-has_secure_password">6.3.4</a>でこれらのテストがパスするようにします。</p>

<div class="label" id="code-password_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.28</span> <span class="description">パスワードとパスワードの確認をテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_digest</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when password is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when password doesn&#39;t match confirmation&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;mismatch&quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when password confirmation is nil&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-user_authentication"></div>


<h3><a id="sec-6_3_3" href="#sec-user_authentication" class="heading"><span class="number">6.3.3</span>ユーザー認証</a></h3>


<p>パスワード機構というパズルの最後のひとかけらは、ユーザーをメールアドレスとパスワードに基いて取得する手段です。この作業は2つに分けるのが自然です。最初に、ユーザーをメールアドレスで検索します。次に、受け取ったパスワードでユーザーを認証します。</p>

<p>最初の手順の実装は簡単です。<a class="ref" href="#sec-finding_user_objects">6.1.4</a>でも説明したように、<code>find_by_email</code>メソッドを使用すれば、受け取ったメールアドレスでユーザーを検索できます。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</pre></div>
</div>


<p>次の手順は、<code>authenticate</code>メソッドを使用して、受け取ったパスワードがユーザーのパスワードと一致することを確認します。<a class="ref" href="#cha-sign-in-sign-out">第8章</a>では、以下のようなコードを使用して現在の (サインインしている) ユーザーを取得する予定です。</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>


<p>受け取ったパスワードがユーザーのパスワードと一致するとユーザーが返され、一致しない場合は<code>false</code>が返されます。</p>

<p>これまで同様、RSpecを使用して<code>authenticate</code>メソッドへの要求内容を表現することができます。ただし、このテストはこれまでよりも高度な内容になるため、いくつかに分割して説明します。RSpecが初めての方は、この節を繰り返し読んでみてください。最初に、Userオブジェクトが<code>authenticate</code>に応答することを要求します。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>次に、パスワードが一致する場合と一致しない場合についてそれぞれ記述します。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;return value of authenticate method&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;with valid password&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with invalid password&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="o">==</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
    <span class="n">specify</span> <span class="p">{</span> <span class="n">user_for_invalid_password</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードで、<code>before</code>ブロックはユーザーをデータベースに事前に保存します。これにより、<code>find_by_email</code>メソッドが動作するようになります。このメソッドを<code>let</code>メソッドで以下のようにテストします。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>これまでいくつかの演習で<code>let</code>メソッドを使用してきましたが、今回のようにチュートリアルの本文で言及するのはこれが初めてです。<code>let</code>メソッドの詳細については<a class="ref" href="#sidebar-let">コラム 6.3</a>を参照してください。</p>

<p>2つの<code>describe</code>ブロックでは、<code>@user</code>と<code>found_user</code>が一致する場合と一致しない場合についてそれぞれテストします。コードで使用されている二重等号の演算子<code>==</code>は、オブジェクト同士が同値であるかどうかを調べます(<a class="ref" href="#sec-arrays_and_ranges">4.3.1</a>)。以下のコードにご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with invalid password&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="o">==</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>   
  <span class="n">specify</span> <span class="p">{</span> <span class="n">user_for_invalid_password</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードでは<code>let</code>がもう一度使用されており、さらに<code>specify</code>というメソッドも使用されています。実は、このspecifyは<code>it</code>と同義であり、<code>it</code>を使用すると英語として不自然な場合にこれで代用することができます。この場合、「it should not equal wrong user」(itはユーザーなど) とするのは英語として自然ですが、「user: user with invalid password should be false」は不自然であり、「specify: user with invalid password should be false」とすれば自然になります。</p>

<div class="label" id="sidebar-let"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 6.3</span></span><span class="title"><span class="description"><tt>let</tt>メソッド</span></span>
<p>RSpecの<tt>let</tt>メソッドを使用すると、テスト内で簡単にローカル変数を作成することができます。文法は一見奇妙ですが、動作は変数への割り当てと似ています。<tt>let</tt>の引数はシンボルであり、さらにブロックを引数に取ります。そのブロックは、このシンボル名を持つローカル変数に値を返します。つまり、以下のコードを実行すると、</p>

<pre class="verbatim">let(:found_user) { User.find_by_email(@user.email) }</pre>


<p><tt>found_user</tt>という変数が作成され、その値は<tt>find_by_email</tt>の返し値に等しくなります。これにより、この変数はテスト中すべての<tt>before</tt>または<tt>it</tt>ブロックで利用できるようになります。<tt>let</tt>では値が<em>メモ化 (memoize) </em>されるという特長があり、ある呼び出しから次の呼び出しに渡って値を利用できます (<a href="http://en.wikipedia.org/wiki/Memoization"><em>メモ化</em></a>は技術用語であり、決して &quot;memorize&quot; の誤りでは<em>ありません</em>) 。この場合、<tt>found_user</tt>変数は<tt>let</tt>によってメモ化され、<tt>find_by_email</tt>が実際に呼び出されるのはUserモデルのspecが実際に実行されるときだけとなります。</p>
</div>


<p>最後に、セキュリティの常道として、パスワードの長さ検証をテストします。以下のコードでは、パスワードは6文字以上であることを要求します。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with a password that&#39;s too short&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">5</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_invalid</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>ここまでのテストをすべて集約したものを<a class="ref" href="#code-authenticate_spec">リスト6.29</a>に示します。</p>

<div class="label" id="code-authenticate_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.29</span> <span class="description"><code>authenticate</code>メソッドをテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;with a password that&#39;s too short&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">5</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_invalid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;return value of authenticate method&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:found_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid password&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid password&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user_for_invalid_password</span><span class="p">)</span> <span class="p">{</span> <span class="n">found_user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="o">==</span> <span class="n">user_for_invalid_password</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">user_for_invalid_password</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#sidebar-let">コラム 6.3</a>で解説したように<code>let</code>では値がメモ化されます。これにより、<a class="ref" href="#code-authenticate_spec">リスト6.29</a>にある、最初のネストしている<code>describe</code>ブロックは<code>let</code>で<code>find_by_email</code>を使用してデータベースからユーザーを取得します。しかしその次のネストしている<code>describe</code>ブロックは (メモ化された値を利用するので) データベースにアクセスしません。</p>

<div class="label" id="sec-has_secure_password"></div>


<h3><a id="sec-6_3_4" href="#sec-has_secure_password" class="heading"><span class="number">6.3.4</span>ユーザーがセキュアなパスワードを持っている</a></h3>


<p>認証システムを最初からフル作成していた<a href="http://railstutorial.org/book?version=3.0">Rails 3.0向け<em>Railsチュートリアル</em></a><sup class="footnote" id="fnref-6_17"><a href="#fn-6_17">17</a></sup>を参照いただくとわかるように、以前のバージョンのRailsでは、セキュアパスワードの実装は面倒で時間のかかる作業でした。しかし今では、Web開発者が認証システムというものを以前よりも深く理解するようになり、最新のRailsには認証システムも同梱されるようになりました。ここまで実装を進めてきたので、あとほんの数行を追加してセキュアパスワードの実装を完了し、テストスイートを緑色 (成功) にしましょう。</p>

<p>最初に、<code>password</code>カラムと<code>password_confirmation</code>カラムをアクセス可能にし (<a class="ref" href="#sec-accessible_attributes">6.1.2.2</a>)、新しいユーザーを初期化ハッシュでインスタンス化できるようにします。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                 <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p><a class="ref" href="#code-attr_accessible">リスト6.6</a>のモデルに従い、適切なシンボルをアクセス可能な属性のリストに以下のように追加します。</p>

<div class="code"><div class="highlight"><pre><span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
</pre></div>
</div>


<p>次に、パスワードの存在確認と長さチェックが必要です。後者の実装には、<a class="ref" href="#code-length_validation">6.15</a>の<code>:maximum</code>キーに似た<code>:minimum</code>キーを使用します。</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">minimum:</span> <span class="mi">6</span> <span class="p">}</span>
</pre></div>
</div>


<p>次に、<code>password</code>属性と<code>password_confirmation</code>属性を追加し、パスワードが存在することを要求し、パスワードとパスワードの確認が一致することを要求し、さらに<code>authenticate</code>メソッドを使用して、暗号化されたパスワードと<code>password_digest</code>を比較してユーザーを認証するという多くの手順が必要です。この実装が唯一手間のかかる箇所ですが、最新のRailsでは<code>has_secure_password</code>を使用するだけでこれらの機能をすべて自由に利用できます。</p>

<div class="code"><div class="highlight"><pre><span class="n">has_secure_password</span>
</pre></div>
</div>


<p>データベースに<code>password_digest</code>カラムを置くという条件さえ守れば、上のメソッドをモデルに追加するだけで新規ユーザーの作成と認証をセキュアにすることができます。</p>

<p>(<code>has_secure_password</code>の実装に興味のある方は、<a href="https://github.com/rails/rails/blob/master/activemodel/lib/active_model/secure_password.rb"><tt>secure_password.rb</tt>のソースコード</a>を参照してみるとよいでしょう。このソースコードには十分な解説があり、しかも読みやすくできています。そのコードに、以下の行があることにご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">validates_confirmation_of</span> <span class="ss">:password</span>
</pre></div>
</div>


<p>上のコードを実行するだけで、(<a href="http://api.rubyonrails.org/v3.2.0/classes/ActiveModel/Validations/HelperMethods.html#method-i-validates_confirmation_of">Rails API</a>に記載されているように) <code>password_confirmation</code>という属性が作成されます。このコードには<code>password_digest</code>属性の検証も含まれますが、<a class="ref" href="#cha-sign-up">第7章</a>ではこれがいいことばかりとは限らないことをお見せします)</p>

<p>最後に、パスワードの確認について存在チェックを行います。</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
</pre></div>
</div>


<p>これらの3つの要素をすべて反映したUserモデルを<a class="ref" href="#code-password_implementation">リスト6.30</a>に示します。これでセキュアパスワードの実装は完了です。</p>

<div class="label" id="code-password_implementation"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.30</span> <span class="description">セキュアパスワードの完全な実装。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>

  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="no">VALID_EMAIL_REGEX</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]</span><span class="sr">+\.[a-z]+\z/i</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">presence:</span>   <span class="kp">true</span><span class="p">,</span>
                    <span class="nb">format</span><span class="p">:</span>     <span class="p">{</span> <span class="ss">with:</span> <span class="no">VALID_EMAIL_REGEX</span> <span class="p">},</span>
                    <span class="ss">uniqueness:</span> <span class="p">{</span> <span class="ss">case_sensitive:</span> <span class="kp">false</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">minimum:</span> <span class="mi">6</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここまで来たら、テストスイートがパスすることを確認しましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-creating_a_user"></div>


<h3><a id="sec-6_3_5" href="#sec-creating_a_user" class="heading"><span class="number">6.3.5</span>ユーザーを作成する</a></h3>


<p>以上でUserモデルの基本部分が完了しましたので、今度は<a class="ref" href="#sec-showing_users">7.1</a>でユーザー情報表示ページを作成するときに備えて、データベースにユーザーを1人新規で作成しましょう。この作業によって、これまでの節で行なってきた実装が動作することも実感できることでしょう。テストスイートがパスするだけでは味気ないので、実際に開発データベースにユーザーを登録することで喜びを感じていただければと思います。</p>

<p>ただしWebからのユーザー登録はまだできない (完成は<a class="ref" href="#cha-sign-up">第7章</a>です) ので、Railsコンソールを使用して手動でユーザーを作成することにしましょう。<a class="ref" href="#sec-creating_user_objects">6.1.3</a>のときとは異なり、今回はサンドボックスで起動する必要は<em>ありません</em>。データベースに実際にレコードを保存しなければ意味がないからです。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>            <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-07 03:38:14&quot;, updated_at: &quot;2011-12-07 03:38:14&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$P9OnzpdCON80yuMVk3jGr.LMA16VwOExJ...&quot;</span><span class="go">&gt; </span>
</pre></div>
</div>


<p>実際にデータが登録されたことを確認するために、SQLite Database Browserを使用して開発データベース (<code>db/development.sqlite3</code>) の中にある行を見てみましょう (<a class="ref" href="#fig-sqlite_user_row">図6.6</a>)。データモデルの属性に対応するカラムは<a class="ref" href="#fig-user_model_password_digest">図6.5</a>で定義されていることを思い出してください。</p>

<div class="label" id="fig-sqlite_user_row"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_user_row_with_password.png" alt="sqlite_user_row_with_password" /></span></div><div class="caption"><span class="header">図6.6</span><span class="description">SQLiteデータベース<code>db/development.sqlite3</code>に登録されたユーザーの行。<a href="http://railstutorial.org/images/figures/sqlite_user_row_with_password-full.png">(拡大)</a></span></div></div>


<p>コンソールに戻って<code>password_digest</code>属性を参照してみると、<a class="ref" href="#code-password_implementation">リスト6.30</a>の<code>has_secure_password</code>の効果を確認できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password_digest</span>
<span class="go">=&gt; &quot;$2a$10$P9OnzpdCON80yuMVk3jGr.LMA16VwOExJgjlw0G4f21yZIMSH/xoy&quot;</span>
</pre></div>
</div>


<p>上の文字列は、パスワード (<code>&quot;foobar&quot;</code>) を暗号化したものであり、ユーザーオブジェクトを初期化するのに使用されました。また、最初に無効なパスワード、次に有効なパスワードを与えることで<code>authenticate</code>の動作を確認することもできます。 </p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2011-12-07 03:38:14&quot;, updated_at: &quot;2011-12-07 03:38:14&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$P9OnzpdCON80yuMVk3jGr.LMA16VwOExJ...&quot;</span><span class="go">&gt; </span>
</pre></div>
</div>


<p>要求に沿って、<code>authenticate</code>メソッドはパスワードが無効なときは<code>false</code>を返し。パスワードが有効なときはユーザー自身を返しています。</p>

<h2><a id="sec-6_4" href="#sec-6_4" class="heading"><span class="number">6.4</span>最後に</a></h2>


<p>この章では、まったく最初からUserモデルを作成し、それに<code>name</code>属性と<code>email</code>属性を与え、さまざまなパスワード属性も与え、値を制限する多くの重要な検証も追加しました。さらに、与えられたパスワードをセキュアに認証できるようにしました。以前のバージョンのRailsであれば、このような実装を行うためのコードは現在の倍以上になっていたことでしょう。現在はコンパクトな<code>validates</code>メソッドや<code>has_secure_password</code>メソッドがあるおかげで、わずか10行程度のソースコードでUserモデルを完成させることができました。</p>

<p>次の<a class="ref" href="#cha-sign-up">第7章</a>では、ユーザーを作成するためのユーザー登録フォームを作成し、各ユーザーの情報を表示するためのページも作成します。<a class="ref" href="#cha-sign-in-sign-out">第8章</a>では、<a class="ref" href="#sec-adding_a_secure_password">6.3</a>の認証システムを利用して、ユーザーが実際にWebサイトにサインインできるようにします。</p>

<p>Gitを使用している方は、しばらくコミットしていなかったのであれば、この時点でコミットしておくのがよいでしょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Make a basic User model (including secure passwords)&quot;</span>
</pre></div>
</div>


<p>次にmasterブランチにマージバックします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge modeling-users
</pre></div>
</div>


<h2><a id="sec-6_5" href="#sec-6_5" class="heading"><span class="number">6.5</span>演習</a></h2>




<ol>

<li><a class="ref" href="#code-email_downcase">リスト6.23</a>の、メールアドレスを小文字に変換するコードに対するテストを、<a class="ref" href="#code-email_downcase_test">リスト6.31</a>のように作成してください。<code>before_save</code>の行をコメントアウトすることで、<a class="ref" href="#code-email_downcase_test">リスト6.31</a>が正しい対象をテストしていることを確認してください。</li>

<li><code>before_save</code>コールバックを<a class="ref" href="#code-downcase_bang">リスト6.32</a>のように書いてもよいことを、テストスイートを実行して確認してください。</li>

<li>Rails APIサイトの<code>ActiveRecord::Base</code>の項を読み通し、どんなことができるかを把握してください。</li>
<li>Rails APIサイトで<code>validates</code>メソッドを調べ、どんなことができるか、どんなオプションがあるかを調べてください。</li>
<li><a href="http://www.rubular.com/">Rubular</a>で数時間ほど遊んでみてください。</li>

</ol>




<div class="label" id="code-email_downcase_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.31</span> <span class="description"><a class="ref" href="#code-email_downcase">リスト6.23</a>のメールアドレス小文字変換をテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;email address with mixed case&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:mixed_case_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Foo@ExAMPle.</span><span class="s2">CoM&quot;</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">&quot;should be saved as all lower-case&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">mixed_case_email</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">mixed_case_email</span><span class="o">.</span><span class="n">downcase</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-downcase_bang"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト6.32</span> <span class="description"><code>before_save</code>コールバックの別の実装。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase!</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<div class="footnotes">
<ol>
<li id="fn-6_1">この名前の由来は “<a href="http://en.wikipedia.org/wiki/Active_record_pattern">active record pattern</a>” です。Martin Fowler著「<em>エンタープライズ アプリケーションアーキテクチャパターン </em>」で特定および命名されました。<a class="arrow" href="#fnref-6_1">↑</a></li>
<li id="fn-6_2">「エスキューエル」と発音しますが、「スィークゥエル」もよく使われます。<a class="arrow" href="#fnref-6_2">↑</a></li>
<li id="fn-6_3">メールアドレスをユーザー名にしたことで、理屈の上では将来ユーザー同士で通信できるように拡張できる可能性が開かれます。<a class="arrow" href="#fnref-6_3">↑</a></li>
<li id="fn-6_4"><code>t</code>オブジェクトが具体的に何をしているのかを正確に知る必要はありませんので、どうか心配しないでください。<em>抽象化レイヤ</em>の素晴らしい点は、それが何であるかを知る必要がないという点です。安心して<code>t</code>オブジェクトに仕事を任せればよいのです。<a class="arrow" href="#fnref-6_4">↑</a></li>
<li id="fn-6_5">公式には「エスキューエライト」と発音しますが、(本来は誤りとされている)「スィークゥエライト」もよく使われています。<a class="arrow" href="#fnref-6_5">↑</a></li>
<li id="fn-6_6"><code>&quot;2011-12-05 00:57:46&quot;</code>というタイムスタンプが気になった方もいると思いますが、著者はこの箇所を真夜中過ぎに書いたわけではありません。実はこのタイムスタンプは<a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">協定世界時</a> (UTC) に合わせてあります。これは<a href="http://en.wikipedia.org/wiki/Greenwich_Mean_Time">グリニッジ標準時</a> (GMT) と同様、標準時間として使用されます。「<a href="http://tf.nist.gov/general/misc.htm">NIST時刻と周波数FAQ</a>」によると、<strong>問:</strong> 協定世界時 (Coordinated Universal Time) の略称がCUTではなくUTCなのはなぜですか。<strong>答え:</strong> 協定世界時システムは、1970年に国際電気通信連合 (ITU) の技術専門家の国際諮問グループによって考案されました。このときITUは、混乱を最小限にとどめるために、略称を1つだけにしたいと考えました。このとき、英語式のCUTもフランス式のTUCも満場一致とならず、両者の妥協案としてUTCという略語が採用されました。<a class="arrow" href="#fnref-6_6">↑</a></li>
<li id="fn-6_7"><code>user.updated_at</code>の値にご注目ください。上の脚注にも書いたとおり、このタイムスタンプはUTCベースです。<a class="arrow" href="#fnref-6_7">↑</a></li>
<li id="fn-6_8">例外と例外ハンドリングは、ある意味でRubyの高度なテーマです。本書では例外についてこれ以上言及しません。しかし例外が重要なものであることも確かなので、<a class="ref" href="#sec-comments_for_various_readers">1.1.1</a>で推薦したRuby本で例外について詳しく学ぶことをお勧めします。<a class="arrow" href="#fnref-6_8">↑</a></li>
<li id="fn-6_9">今後、コンソールコマンドの出力は、特に教育的効果が高いと思える場合 (ここでの<code>User.new</code>の場合など) を除いて省略いたします。<a class="arrow" href="#fnref-6_9">↑</a></li>
<li id="fn-6_10"><a class="ref" href="#table-valid_email_regex">表6.1</a>の正規表現の説明における「文字」は、実は「小文字のみ」が対象になっていることにご注意ください。ただし、正規表現の末尾に<code>i</code>オプションを追加してあるので、大文字小文字が区別されずにマッチするようになっています。<a class="arrow" href="#fnref-6_10">↑</a></li>
<li id="fn-6_11">著者同様このツールを便利だと思ってくださる方は、<a href="http://lovitt.net/">Michael Lovitt</a>の素晴らしい成果に報いるために、どうか<a href="http://bit.ly/donate-to-rubular">Rubularへの寄付</a>をお願いいたします。<a class="arrow" href="#fnref-6_11">↑</a></li>
<li id="fn-6_12">驚いたことに、公式標準によると<code>&quot;Michael Hartl&quot;@example.com</code>のようなクォートとスペースを使用したメールアドレスも有効なのだそうです。まったく馬鹿げています。今あなたが使用しているメールアドレスが、英文字、数字、アンダースコア、ドット以外の文字を含んでいるのであれば、そういう文字を含まないメールアドレスに変えることをお勧めします。ただしここで注意すべきことがあります。<a class="ref" href="#code-validates_format_of_email">リスト6.17</a>の正規表現では、プラス記号の使用を許していることにご注目ください。これは、Gmail (他のメールサービスにもあるかもしれません) ではプラス記号を使用すると便利なことがあるためです。Gmailでは、example.comからのメールをフィルタするために<tt>username+example@gmail.com</tt>を使用することができます。こうすると、Gmailの<tt>username@gmail.com</tt>というアドレスに転送され、<tt>example</tt>という文字をフィルタできるようになります。<a class="arrow" href="#fnref-6_12">↑</a></li>
<li id="fn-6_13">この節の冒頭で簡単に紹介したように、この目的に使用できる専用のテストデータベース<code>db/test.sqlite3</code>があります。<a class="arrow" href="#fnref-6_13">↑</a></li>
<li id="fn-6_14">技術的には、メールアドレスのうちドメイン名部分だけが (本当は) 大文字小文字を区別しません。foo@bar.comは、本来はFoo@bar.comとは別のアドレスです。ただし現実的には、<a href="http://email.about.com/od/emailbehindthescenes/f/email_case_sens.htm">about.com</a>でも指摘されているように、メールアドレスの大文字小文字を区別することを前提にするのはまずい方法です。「メールアドレスの大文字小文字を区別すると、果てしない混乱と相互運用性の問題とひどい頭痛が発生する。メールアドレスの入力時に大文字小文字の区別を要求するのは賢い方法とは言えない。現実には、メールアドレスの大文字小文字の区別を強制するメールサービスやISPはめったに存在しない。メールアドレスのすべての文字を大文字にするなど、受信者のメールアドレスが誤って入力されていれば、メールは返送されるだけだ。」Riley Mosesによるご指摘に感謝いたします。<a class="arrow" href="#fnref-6_14">↑</a></li>
<li id="fn-6_15">もちろん、<a class="ref" href="#code-users_migration">リスト6.2</a>の<code>users</code>テーブル用のマイグレーションファイルを単に編集することも可能なのですが、その場合ロールバックが必要となり、マイグレーションが戻ってしまいます。データモデルの変更が必要になったらその都度マイグレーションを行うのがRails流です。<a class="arrow" href="#fnref-6_15">↑</a></li>
<li id="fn-6_16">著者のシステム上のSQLiteとHeroku上のPostgreSQLで直接実験してみたところ、この手順は実際に必要であることがわかりました。<a class="arrow" href="#fnref-6_16">↑</a></li>
<li id="fn-6_17">http://railstutorial.org/book?version=3.0 <a class="arrow" href="#fnref-6_17">↑</a></li>
</ol>
</div>




<div class="label" id="cha-sign-up"></div>


<h1 class="chapter"><a id="sec-7" href="#cha-sign-up" class="heading"><span class="number">第7章</span>ユーザー登録</a></h1>


<p>Userモデルができあがったので、いよいよWebサイトになくてはならないユーザー登録機能を追加しましょう。<a class="ref" href="#sec-signup_form">7.2</a>ではHTML<em>フォーム</em>を使用して登録情報をWebアプリケーションに送信します。続いて<a class="ref" href="#sec-signup_success">7.4</a>ではユーザーを新規作成して情報をデータベースに保存します。ユーザー登録手続きの最後には、作成されたユーザーの新しいプロファイルを表示できるようにするために、ユーザーを<em>表示する</em>ためのページを作成し、ユーザー用のRESTアーキテクチャを実装する第一歩を踏み出します (<a class="ref" href="#sec-mvc_in_action">2.2.2</a>)。これまでと同様、開発と同時にテストも作成します。RSpecとCapybaraの適用範囲を拡大し、簡潔かつ表現力豊かな結合テストを作成します。</p>

<p>ユーザープロファイルページを作成するには、その前にデータベースにユーザーが登録されている必要があります。これはいわゆる「卵が先か鶏が先か」問題です。このWebサイトでは、登録ページがない状態でどうやってユーザーを登録しておけばよいでしょうか。幸い、この問題は既に解決されています。<a class="ref" href="#sec-creating_a_user">6.3.5</a>でRailsコンソールを使用してユーザーレコードを登録してありました。登録していない場合は、上記を参照して登録しておいてください。</p>

<p>バージョン管理を使用している場合は、いつもと同じようにトピックブランチを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b sign-up
</pre></div>
</div>


<div class="label" id="sec-showing_users"></div>


<h2><a id="sec-7_1" href="#sec-showing_users" class="heading"><span class="number">7.1</span>ユーザーを表示する</a></h2>


<p>この節では、まずユーザーの名前とプロファイル写真を表示するためのページを作成します。モックアップを<a class="ref" href="#fig-profile_mockup_profile_name">図7.1</a>に示しました<sup class="footnote" id="fnref-7_1"><a href="#fn-7_1">1</a></sup>。 ユーザープロファイルページの最終的な目標は、<a class="ref" href="#fig-profile_mockup">図7.2</a>のように<sup class="footnote" id="fnref-7_2"><a href="#fn-7_2">2</a></sup>ユーザーのプロファイル写真と基本ユーザーデータ、そしてマイクロポストの一覧を表示することです。(<a class="ref" href="#fig-profile_mockup">図7.2</a>では、有名な<em>lorem ipsum</em>ダミーテキストを使用しています。このテキストの成り立ちには<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">面白いエピソード</a>があるので機会がありましたらどうぞ。) このページを作成したら、<a class="ref" href="#cha-following-users">第11章</a>のサンプル・アプリケーションで使用する予定です。</p>

<div class="label" id="fig-profile_mockup_profile_name"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup_profile_name_bootstrap.png" alt="profile_mockup_profile_name_bootstrap" /></span></div><div class="caption"><span class="header">図7.1: </span><span class="description">この節で作成するユーザープロファイルのモックアップ。<a href="http://railstutorial.org/images/figures/profile_mockup_profile_name_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup_bootstrap.png" alt="profile_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図7.2: </span><span class="description">理想とする最終的なプロファイルページのモックアップ。<a href="http://railstutorial.org/images/figures/profile_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-rails_environments"></div>


<h3><a id="sec-7_1_1" href="#sec-rails_environments" class="heading"><span class="number">7.1.1</span>デバッグとRails環境</a></h3>


<p>この節で作成するプロファイルは、このアプリケーションにおける初めての真に動的なページになります。ビューそのものは1ページのコードですが、サイトのデータベースから取り出した情報を使用して各プロファイルの表示をカスタマイズします。サンプルアプリケーションに動的なページを追加する準備として、ここでWebサイトのレイアウトにデバッグ情報を追加しましょう (<a class="ref" href="#code-rails_debug">リスト7.1</a>)。これにより、ビルトインの<code>debug</code>メソッドと<code>params</code>変数を使用して、各プロファイルページにデバッグ用の情報が表示されるようになります (詳細については<a class="ref" href="#sec-a_users_resource">7.1.2</a>で解説します)。</p>

<div class="label" id="code-rails_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.1</span> <span class="description">サイトのレイアウトにデバッグ情報を追加する。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>デバッグ出力をきれいに整形するために、<a class="ref" href="#cha-filling-in-the-layout">第5章</a>で作成したカスタムスタイルシートを<a class="ref" href="#code-mixin_and_debug">Listing 7.2</a>のように追加します。</p>

<div class="label" id="code-mixin_and_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.2</span> <span class="description">デバッグ表示を整形するための追加と、Sassのミックスイン。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$grayMediumLight</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="k">@mixin</span><span class="nf"> box_sizing</span> <span class="p">{</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span> 
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span> 
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">miscellaneous</span> <span class="o">*/</span>

<span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">clear</span><span class="o">:</span> <span class="no">both</span><span class="p">;</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>ここでSassの<em>ミックスイン</em>機能 (ここでは<code>box_sizing</code>) を使用しています。ミックスイン機能を使用することで、CSSルールのグループをパッケージ化して複数の要素に適用することができます。たとえば以下のような変換を行います。</p>

<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="o">@</span><span class="nt">include</span> <span class="nt">box_sizing</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>上を以下のように変更します。</p>

<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span> 
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span> 
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>ミックスインは<a class="ref" href="#sec-using_form_for">7.2.2</a>でも使用します。今回の場合、デバッグ出力は<a class="ref" href="#fig-home_page_with_debug_2nd_ed">図7.3</a>のようになります。</p>

<div class="label" id="fig-home_page_with_debug_2nd_ed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_debug_2nd_ed.png" alt="home_page_with_debug_2nd_ed" /></span></div><div class="caption"><span class="header">図7.3: </span><span class="description">サンプルアプリケーションのHomeページ (<a href="http://localhost:3000/">/</a>) にデバッグ情報を表示する。<a href="http://railstutorial.org/images/figures/home_page_with_debug_2nd_ed-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="#fig-home_page_with_debug_2nd_ed">図7.3</a>のデバッグ出力には、描画されるページの状態を把握するのに役立つ情報が含まれます。</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">static_pages</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">home</span>
</pre></div>
</div>


<p>これは<code>params</code>の内容で、YAML<sup class="footnote" id="fnref-7_3"><a href="#fn-7_3">3</a></sup>というものです。YAMLは基本的にハッシュであり、コントローラとページのアクションを一意に指定します。<a class="ref" href="#sec-a_users_resource">7.1.2</a>には別の例もあります。</p>

<p>本番環境にデプロイしたアプリケーションではデバッグ情報を表示したくないので、<a class="ref" href="#code-rails_debug">リスト7.1</a>には以下を記述してあります。</p>

<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div>
</div>


<p>こうしておくと、デバッグ情報はRailsの3つのデフォルト環境のうち、<em>開発環境</em>でしか表示されなくなります (<a class="ref" href="#sidebar-rails_environments">コラム 7.1</a>)<sup class="footnote" id="fnref-7_4"><a href="#fn-7_4">4</a></sup>。特に、<code>Rails.env.development?</code>が<code>true</code>になるのは開発環境に限られるため、以下の埋め込みRuby</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>は本番アプリケーションやテストで挿入されることはありません。(テスト環境でデバッグ情報が表示されても直接問題になることはありませんが、よいことではありません。デバッグ情報は開発環境以外では使用すべきではありません。)</p>

<div class="label" id="sidebar-rails_environments"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 7.1</span></span><span class="title"><span class="description">Railsの3つの環境</span></span>
<p>Railsにはテスト環境 (<tt>test</tt>)、開発環境 (<tt>development</tt>)、そして本番環境 (<tt>production</tt>) の3つの環境がデフォルトで装備されています。Rails consoleのデフォルトの環境は<tt>development</tt>です。</p>

<pre class="verbatim">  $ rails console 
  Loading development environment
  &gt;&gt; Rails.env
  =&gt; &quot;development&quot;
  &gt;&gt; Rails.env.development?
  =&gt; true
  &gt;&gt; Rails.env.test?
  =&gt; false</pre>


<p>上のように、Railsには<tt>Rails</tt>というオブジェクトがあり、それには環境の論理値 (boolean) を取る<tt>env</tt>という属性があります。たとえば、<tt>Rails.env.test?</tt>はテスト環境では<tt>true</tt>を返し、それ以外の環境では<tt>false</tt>を返します。</p>

<p>テスト環境のデバッグなど、他の環境でconsoleを実行する必要が生じた場合は、環境をパラメータとして<tt>console</tt>スクリプトに渡すことができます。</p>

<pre class="verbatim">  $ rails console test
  Loading test environment
  &gt;&gt; Rails.env
  =&gt; &quot;test&quot;
  &gt;&gt; Rails.env.test?
  =&gt; true</pre>


<p>ローカルのRailsサーバーではconsoleのデフォルトの環境として<tt>development</tt>が使用されますが、以下のように他の環境でconsoleを実行することもできます。</p>

<pre class="verbatim">  $ rails server --environment production</pre>


<p>アプリケーションを本番環境で実行する場合、本番のデータベースが利用できないとアプリケーションを実行できません。そのため、<tt>rake db:migrate</tt>を本番環境で実行して本番データベースを作成します。</p>

<pre class="verbatim">  $ bundle exec rake db:migrate RAILS_ENV=production</pre>


<p>(注: console、server、migrateの3つのコマンドでは、デフォルト以外の環境を指定する方法がそれぞれ異なっており、混乱を招く可能性があります。このため、3つの場合の方法をすべて説明することを避けています。)</p>

<p>ところで、サンプルアプリケーションをHerokuにデプロイした場合は、<tt>heroku</tt>コマンドで環境を確認することができます。これを行うには、Herokuの (リモート) コンソールで以下を実行します。</p>

<pre class="verbatim">  $ heroku run console
  Ruby console for yourapp.herokuapp.com
  &gt;&gt; Rails.env
  =&gt; &quot;production&quot;
  &gt;&gt; Rails.env.production?
  =&gt; true</pre>


<p>当然ながら、Herokuは本番サイト用のプラットフォームなので、実行されるアプリケーションはすべて本番環境となります。</p>
</div>




<div class="label" id="sec-a_users_resource"></div>


<h3><a id="sec-7_1_2" href="#sec-a_users_resource" class="heading"><span class="number">7.1.2</span>ユーザーリソース</a></h3>


<p><a class="ref" href="#cha-modeling-users">第6章</a>の最後で、データベースに新しいユーザーを作成しました。<a class="ref" href="#sec-creating_a_user">6.3.5</a>でこのユーザーのidは<code>1</code>になっており、今の私たちの目標はこのユーザーの情報を表示するページを作成することです。ここでは、Railsアプリケーションで好まれているRESTアーキテクチャ (<a class="ref" href="#sidebar-REST">コラム 2.2</a>) の習慣に従うことにしましょう。つまり、データを作成、表示、更新、削除可能な<em>リソース</em>として扱うということです。<a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP標準</a>には、これらに対応する4つの基本操作 (<tt>POST</tt>、<tt>GET</tt>、<tt>PUT</tt>、<tt>DELETE</tt>)が定義されています (<a class="ref" href="#sidebar-get_etc">コラム  3.2</a>)。</p>

<p>RESTの原則に従う場合、リソースへの参照はリソース名とユニークIDを使用するのが普通です。ユーザーを<em>リソース</em>とみなす場合、id=<code>1</code>のユーザーを参照するということは、/users/1というURIに対して<tt>GET</tt>リクエストを発行するということを意味します。ここで<code>show</code>というアクションの種類は、<em>暗黙</em>のリクエストになります。RailsのREST機能が有効になっていると、<tt>GET</tt>リクエストは自動的に<code>show</code>アクションとして扱われます。</p>

<p><a class="ref" href="#sec-a_user_tour">2.2.1</a>で説明したとおり、id=<code>1</code>のユーザーにアクセスするためのページのURIは/users/1となります。ただし、現時点でこのURIを使用してもエラーになります (<a class="ref" href="#fig-profile_routing_error">図 7.4</a>)。</p>

<div class="label" id="fig-profile_routing_error"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_routing_error.png" alt="profile_routing_error" /></span></div><div class="caption"><span class="header">図7.4: </span><span class="description">/users/1にアクセスした時のエラーページ。<a href="http://railstutorial.org/images/figures/profile_routing_error-full.png">(拡大)</a></span></div></div>


<p>RESTスタイルのURIを有効にするには、routesファイル (<code>config/routes.rb</code>)に以下の1行を追加します。</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span>
</pre></div>
</div>


<p>この行を追加した結果が<a class="ref" href="#code-users_resource">リスト7.3</a>です。</p>

<div class="label" id="code-users_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.3</span> <span class="description">Usersリソースをroutesファイルに追加する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>

  <span class="n">root</span> <span class="ss">to:</span> <span class="s1">&#39;static_pages#home&#39;</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;users#new&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ところで、<a class="ref" href="#code-users_resource">リスト7.3</a>には以下の行がありません。</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;users/new&quot;</span>
</pre></div>
</div>


<p>この行は<a class="ref" href="#code-signup_route">リスト5.32</a>にはありました。実は、<code>resources :users</code>という行は、動作する /users/1 URIを追加するためだけのものではありません。サンプルアプリケーションにこの行を追加すると、ユーザーのURIを生成するための多数の名前付きルート (<a class="ref" href="#sec-named_routes">5.3.3</a>) に従って、RESTfulなUsersリソースで必要となる<em>すべての</em>アクションが利用できるようになります<sup class="footnote" id="fnref-7_5"><a href="#fn-7_5">5</a></sup>。この行に対応するURI、アクション、名前付きルートは<a class="ref" href="#table-RESTful_users">表7.1</a>のようになります (<a class="ref" href="#table-demo_RESTful_users">表2.2</a>との違いを比較してみてください)。 次の3つの章に渡って、<a class="ref" href="#table-RESTful_users">表7.1</a>の他の項目も利用して、Usersリソースを完全にRESTfulなリソースにするために必要なアクションをすべて作成する予定です。</p>

<div class="label" id="table-RESTful_users"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>名前付きルート</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/users</td><td class="align_left"><code>index</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">すべてのユーザーを表示するページ</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>show</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">特定のユーザーを表示するページ</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/new</td><td class="align_left"><code>new</code></td><td class="align_left"><code>new_user_path</code></td><td class="align_left">ユーザーを新規作成するページ (ユーザー登録)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/users</td><td class="align_left"><code>create</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">ユーザーを作成するアクション</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/edit</td><td class="align_left"><code>edit</code></td><td class="align_left"><code>edit_user_path(user)</code></td><td class="align_left">id=<code>1</code>のユーザーを編集するページ</td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>update</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">ユーザーを更新するアクション</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>destroy</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">ユーザーを削除するアクション</td></tr></table></div><div class="caption"><span class="header">表7.1: </span><span class="description"><a class="ref" href="#code-users_resource">リスト7.3</a>のUsersリソースが提供するRESTfulなルート。</span></div></div>


<p><a class="ref" href="#code-users_resource">リスト7.3</a>のコードを使用することで、ルーティングが有効になります。ただし、ルーティング先のページはまだありません (<a class="ref" href="#fig-user_show_unknown_action_31">図7.5</a>)。この問題を解決するために、<a class="ref" href="#sec-a_gravatar_image">7.1.4</a>で最小限のプロファイルページを作成する予定です。</p>

<div class="label" id="fig-user_show_unknown_action_31"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_unknown_action_31.png" alt="user_show_unknown_action_31" /></span></div><div class="caption"><span class="header">図7.5: </span><span class="description">URI /users/1のルーティングは有効だがページがない状態。<a href="http://railstutorial.org/images/figures/user_show_unknown_action_31-full.png">(拡大)</a></span></div></div>


<p>ユーザーを表示するために、標準的なRailsの場所を使用することにします。<code>app/views/users/show.html.erb</code>です。<a class="ref" href="#code-generate_users_controller">リスト5.28</a>でジェネレータを使用して作成した<code>new.html.erb</code>ビューと異なり、この<code>show.html.erb</code>ファイルは自動的には作成されないので、手動で作成します。このファイルを作成後、<a class="ref" href="#code-stub_user_view">リスト7.4</a>の内容を貼り付けてください。</p>

<div class="label" id="code-stub_user_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.4</span> <span class="description">ユーザー情報を表示するための仮のビュー。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>このビューでは埋め込みRubyを使用してユーザー名とメールアドレスを表示しています。インスタンス変数<code>@user</code>があることを前提としています。もちろん、ユーザー表示ページの最終的な状態はこれとは大きく異なりますし、このメールアドレスがこのまま一般に公開されるようなこともありません。</p>

<p>ユーザー表示ビューが正常に動作するためには、Usersコントローラ内の<code>show</code>アクションに対応する<code>@user</code>変数を定義する必要があります。 ご想像のとおり、ここではUserモデルの<code>find</code>メソッド (<a class="ref" href="#sec-finding_user_objects">6.1.4</a>) を使用してデータベースからユーザーを取り出します。<a class="ref" href="#code-user_show_action">リスト7.5</a>のように書き換えてください。</p>

<div class="label" id="code-user_show_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.5</span> <span class="description">Usersコントローラの<code>show</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ユーザーのid読み出しには<code>params</code>を使用しました。Usersコントローラにリクエストが正常に送信されると、<code>params[:id]</code>の部分はユーザーidの<tt>1</tt>に置き換わります。従って、この箇所は以下の<code>find</code>メソッドと同等です。</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>上は<a class="ref" href="#sec-finding_user_objects">6.1.4</a>で使用したものです (技術的な補足: <code>params[:id]</code>は文字列型の <code>&quot;1&quot;</code> ですが、<code>find</code>メソッドでは自動的に整数型に変換されます)。</p>

<p>ユーザーのビューとアクションが定義されたので、URI <a href="http://localhost:3000/users/1">/users/1</a>は完全に動作するようになりました (<a class="ref" href="#fig-user_show_rails_3">図7.6</a>)。<a class="ref" href="#fig-user_show_rails_3">図7.6</a>のデバッグ情報で<code>params[:id]</code>の値を確認できることにもご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&#39;1&#39;</span>
</pre></div>
</div>


<p>以下のコードを使用して</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>id=<tt>1</tt>のユーザーを検索できたのは以上の仕組みによるものです (<a class="ref" href="#code-user_show_action">リスト7.5</a>)。</p>

<div class="label" id="fig-user_show_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_bootstrap.png" alt="user_show_bootstrap" /></span></div><div class="caption"><span class="header">図7.6: </span><span class="description">Usersリソース追加後の<a href="http://localhost:3000/users/1">/users/1</a>のユーザー表示ページ。 <a href="http://railstutorial.org/images/figures/user_show_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-tests_with_factories"></div>


<h3><a id="sec-7_1_3" href="#sec-tests_with_factories" class="heading"><span class="number">7.1.3</span>ファクトリーを使用してユーザー表示ページをテストする</a></h3>


<p>最小限のプロファイルが動作するようになりましたので、<a class="ref" href="#fig-profile_mockup_profile_name">図7.1</a>のモックアップバージョンの作成を始めましょう。静的なページの作成 (<a class="ref" href="#cha-static-pages">第3章</a>) やUserモデル (<a class="ref" href="#cha-modeling-users">第6章</a>) のときと同様に、テスト駆動開発を行います。</p>

<p><a class="ref" href="#sec-signup_url">5.4.2</a>では、Usersリソースに関連付けられたページに対して行った結合テストを思い出してください。ユーザー登録ページでは、<a class="ref" href="#code-user_pages_spec">リスト5.31</a>のように最初に<code>signup_path</code>をテストし、次に<code>h1</code>タグと<code>title</code>タグが正しいことをチェックしました。これを再現したものが<a class="ref" href="#code-initial_signup_test">リスト7.6</a>です (<a class="ref" href="#sec-pretty_rspec">5.3.4</a>の<code>full_title</code>ヘルパーについては、フルタイトルが既にテスト済みであることから省略しました)。</p>

<div class="label" id="code-initial_signup_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.6</span> <span class="description">最初に行ったUserページspecの再現。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signup page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ユーザー表示ページをテストするために、<code>show</code>アクションのコード (<a class="ref" href="#code-user_show_action">リスト7.5</a>) で検索を行うUserモデルオブジェクトが必要となります。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
  <span class="c1"># Code to make a user variable</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>これよりコメントの部分に適切なコードを追加します。ここでは<code>user_path</code>という名前付きルート (<a class="ref" href="#table-RESTful_users">表7.1</a>) を使用して、指定されたユーザーのページを表示するためのパスを生成します。これにより、<code>h1</code>タグと<code>title</code>タグの両方にユーザーの名前が含まれているかどうかをテストできます。</p>

<p>必要なUserモデルオブジェクトを作成するために、Active Recordを使用して<code>User.create</code>という形式でユーザーを作成することもできますが、経験上、ユーザーのオブジェクトを定義してそれをデータベースに挿入するには、ユーザーの<em>ファクトリー (factory)</em> を使用する方がはるかに便利です。ここでは、<a href="http://github.com/thoughtbot/factory_girl">Factory Girl</a>を使用して生成したファクトリーを使用します。Factory Girlは、<a href="http://thoughtbot.com/">thoughtbot</a>のメンバーが作成したRuby gemです。Factory Girlは、RSpecを使用してRubyで「ドメイン特化言語 (domain-specific language)」を定義します。ここでは、Active Recordのオブジェクトの定義に特化しています。このドメイン特化言語の文法はシンプルで、必要なオブジェクトの属性を定義するためにRubyのブロックとカスタムメソッドを使用しています。この章のサンプルアプリケーションでは、Active Recordのメリットはまだはっきりとはわからないかもしれませんが、この後の章ではファクトリーの機能をさらに活用する予定です。たとえば<a class="ref" href="#sec-pagination">9.3.3</a>では、複数のユーザーを作成し、それぞれに独自のメールアドレスを持たせる作業が重要となりますが、ファクトリーを使用することで簡単になります。</p>

<p>他のRuby gemと同様、Bundlerで使用する<code>Gemfile</code>に以下のように1行追加することでFactory Girlをインストールできます (<a class="ref" href="#code-gemfile_factory_girl">リスト7.7</a>) (Factory Girlはテスト環境でしか使用しないので、以下のように<code>:test</code>グループに追加します)。</p>

<div class="label" id="code-gemfile_factory_girl"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.7</span> <span class="description"><code>Gemfile</code>にFactory Girlを追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;4.1.0&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span> 
</pre></div>
</div></div>


<p>インストール方法は、いつものように以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Factory Girlのファクトリーはすべて<code>spec/factories.rb</code>ファイルに置きます。ここにあるファクトリーはRSpecによって自動的に読み込まれます。Userファクトリが見えるようにするためのコードは<a class="ref" href="#code-user_factory">リスト7.8</a>です。</p>

<div class="label" id="code-user_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.8</span> <span class="description">Userモデルオブジェクトをシミュレートするためのファクトリー。</span><br /><span class="description"> <code>spec/factories.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">&quot;Michael Hartl&quot;</span>
    <span class="n">email</span>    <span class="s2">&quot;michael@example.com&quot;</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>シンボル<code>:user</code>が<code>factory</code>コマンドに渡されると、Factory Girlはそれに続く定義がUserモデルオブジェクトを対象としていることを認識します。</p>

<p><a class="ref" href="#code-user_factory">リスト7.8</a>の定義を使用することで、Factory Girlの<code>let</code>コマンドと<code>FactoryGirl</code>メソッド (<a class="ref" href="#sidebar-let">コラム 6.3</a>) を使用してUserのファクトリーを作成することができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>最終的なコードは<a class="ref" href="#code-user_show_page_test">リスト7.9</a>のようになります。</p>

<div class="label" id="code-user_show_page_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.9</span> <span class="description">ユーザー表示ページ用のテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で以下を実行すると、テストスイートが赤色 (失敗) になるはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>このコードは、<a class="ref" href="#code-name_title_and_heading">リスト7.10</a>のようにすることで緑色 (成功) になります。</p>

<div class="label" id="code-name_title_and_heading"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.10</span> <span class="description">ユーザーのプロファイルページにタイトルと見出しを追加する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>以下のコマンドを再度実行すると、<a class="ref" href="#code-user_show_page_test">リスト7.9</a>はパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Factory Girlを使用したテストを実行してみるとすぐに気が付くと思いますが、正直言って<em>遅い</em>です。 これはFactory Girlに問題があるわけではなく、あくまで<em>機能</em>の一部であり、バグではありません。<a class="ref" href="#sec-an_encrypted_password">6.3.1</a>で使用したBCryptアルゴリズムによるセキュアパスワードのハッシュ生成そのものが仕様上遅いのが原因です。BCryptが遅いということは、裏を返せばそれだけ攻撃に強いということでもあります。残念ながら、このままではユーザーの作成をそのままテストに含めると遅くなってしまいます。幸いなことに、この問題は簡単に回避できます。BCryptでは、セキュアハッシュを生成する際の計算の負荷を<em>コストファクター (cost factor) </em>として指定できます。コストファクターのデフォルト値は速度よりセキュアであることを重視しています。これは本番環境では最適ですが、テスト環境では不利です。私たちはテストを<em>高速</em>で行いたいのであり、ユーザーのパスワードハッシュのセキュリティについてはテスト中は気にしたくありません。解決方法は、テスト設定ファイル<code>config/environments/test.rb</code>に<a class="ref" href="#code-test_bcrypt_cost_factor">リスト7.11</a>のように数行追加することです。これによりコストファクターが再定義され、デフォルトのセキュア重視から速度重視の最小値に変わります。 かなり小規模なテストであっても、この修正によって速度は相当向上します。<code>test.rb</code>にはいつも<a class="ref" href="#code-test_bcrypt_cost_factor">リスト7.11</a>の数行を追加しておくことをぜひともお勧めします。</p>

<div class="label" id="code-test_bcrypt_cost_factor"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.11</span> <span class="description">BCryptのコストファクターをテスト環境向けに再定義する。</span><br /><span class="description"> <code>config/environments/test.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Speed up tests by lowering BCrypt&#39;s cost function.</span>
  <span class="nb">require</span> <span class="s1">&#39;bcrypt&#39;</span>
  <span class="n">silence_warnings</span> <span class="k">do</span>
    <span class="ss">BCrypt::Engine</span><span class="o">::</span><span class="no">DEFAULT_COST</span> <span class="o">=</span> <span class="ss">BCrypt::Engine</span><span class="o">::</span><span class="no">MIN_COST</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-a_gravatar_image"></div>


<h3><a id="sec-7_1_4" href="#sec-a_gravatar_image" class="heading"><span class="number">7.1.4</span>gravatar画像とサイドバー</a></h3>


<p>前節で基本的なユーザーページの定義は終わりましたので、今度は各ユーザーのプロファイル写真のあたりをもう少し肉付けし、サイドバーも作り始めましょう。ビューを作成するときは、ページの構造が正確であるかどうかよりもページの外観の方を重要視するのが普通なので、少なくとも今はビューをテストする必要はありません。ページネーション (<a class="ref" href="#sec-pagination">9.3.3</a>) のようなよりエラーが起きやすい要素をビューで使用するようになったら、ビューでもテスト駆動開発を行います。</p>

<p>ここでは<a href="http://gravatar.com/">Gravatar (globally recognized avatar) </a>をユーザープロファイルに導入してみましょう<sup class="footnote" id="fnref-7_6"><a href="#fn-7_6">6</a></sup>。Gravatarは<a href="http://github.com/">GitHub</a>の共同設立者であるTom Preston-Wernerによって開発され、後に<a href="http://automattic.com/">Automattic</a> (<a href="http://wordpress.com/">WordPress</a>の作者) に買い取られました。Gravatarは無料のサービスで、プロファイル写真をアップロードして、指定したメールアドレスと関連付けることができます。Gravatarは、プロファイル写真をアップロードするときの面倒な作業や、写真が欠けたりなどのトラブル、置き場所の悩みを解決します。ユーザーのメールアドレスを組み込んだGravatar専用の画像パスを構成するだけで、対応するGravatarの画像が自動的に表示されます<sup class="footnote" id="fnref-7_7"><a href="#fn-7_7">7</a></sup>。</p>

<p>ここでは、<a class="ref" href="#code-user_show_view_with_gravatar">リスト7.12</a>のように<code>gravatar_for</code>ヘルパー関数を使用してGravatarの画像を利用できるようにします。</p>

<div class="label" id="code-user_show_view_with_gravatar"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.12</span> <span class="description">ユーザー表示ビューに名前とGravatarを表示する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>この時点では、以下のテストスイートは失敗するはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p><code>gravatar_for</code>メソッドが未定義のため、ユーザー表示ビューは現在動作していません。(このようなエラーを捉えることができるのが、ビューでSpecsを使用する大きなメリットです。だからこそ、どんなに小規模であってもよいのでビューで<em>何らかの</em>テストを行っておくことが重要なのです。)</p>

<p>デフォルトでは、ヘルパーファイルで定義されているメソッドは自動的にすべてのビューで利用できます。ここでは、利便性を考えて<code>gravatar_for</code>をUsersコントローラに関連付けられているヘルパーファイルに置くことにしましょう。<a href="http://en.gravatar.com/site/implement/hash/">Gravatarのホームページ</a>にも書かれているように、GravatarのURIは<a href="http://en.wikipedia.org/wiki/MD5">MD5ハッシュ</a>を用いてユーザーのメールアドレスをハッシュ化しています。Rubyでは、<code>Digest</code>ライブラリの<code>hexdigest</code>メソッドを使用したMD5ハッシュアルゴリズムが実装されています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;MHARTL@example.</span><span class="s2">COM&quot;</span><span class="o">.</span>
<span class="gp">&gt;&gt; </span><span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
<span class="go">=&gt; &quot;1fda4469bcbec3badf5418269ffc5968&quot; </span>
</pre></div>
</div>


<p>メールアドレスは大文字小文字を区別しますが (<a class="ref" href="#sec-format_validation">6.2.4</a>)、MD5ハッシュでは大文字小文字は区別されないので、Rubyの<code>downcase</code>メソッドを使用して<code>hexdigest</code>の引数を小文字に変換しています。<code>gravatar_for</code>ヘルパーを組み込んだ結果を<a class="ref" href="#code-gravatar_for_helper">リスト7.13</a>に示しました。</p>

<div class="label" id="code-gravatar_for_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.13</span> <span class="description"><code>gravatar_for</code>ヘルパーメソッドを定義する。</span><br /><span class="description"> <code>app/helpers/users_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># 与えられたユーザーのGravatar (http://gravatar.com/) を返す。</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-gravatar_for_helper">リスト7.13</a>のコードは、Gravatarの画像タグに<code>&quot;gravatar&quot;</code>クラスとユーザー名のaltテキストを追加したものを返します (altテキストを追加しておくと、視覚障害のあるユーザーがスクリーンリーダーを使用するときにも便利です)。今度は以下のテストスイートは成功するはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>プロファイルページは<a class="ref" href="#fig-profile_with_gravatar">図7.7</a>のようになります。ここにはデフォルトのGravatar画像が表示されていますが、これはデフォルトのメールアドレス<code>user@example.com</code>が有効ではないためです (<a href="http://example.com/">example.com</a>というドメイン名は、例として使用するために特別に予約されています)。</p>

<div class="label" id="fig-profile_with_gravatar"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_with_gravatar_bootstrap.png" alt="profile_with_gravatar_bootstrap" /></span></div><div class="caption"><span class="header">図7.7: </span><span class="description">ユーザープロファイルページ<a href="http://localhost:3000/users/1">/users/1</a>にデフォルトのGravatarが表示されている。<a href="http://railstutorial.org/images/figures/profile_with_gravatar_bootstrap-full.png">(拡大)</a></span></div></div>


<p>アプリケーションでカスタムGravatarを利用できるようにするために、<code>update_attributes</code> (<a class="ref" href="#sec-updating_user_objects">6.1.5</a>) を使用してデータベース上のユーザー情報を更新します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>                       <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>                       <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>                       <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>ここではユーザーのメールアドレスに <code>example@railstutorial.org</code> を使用しました (<a class="ref" href="#fig-profile_custom_gravatar">図7.8</a>)。このメールアドレスはRailsチュートリアルのロゴでも使用されています。</p>

<div class="label" id="fig-profile_custom_gravatar"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_custom_gravatar_bootstrap.png" alt="profile_custom_gravatar_bootstrap" /></span></div><div class="caption"><span class="header">図7.8: </span><span class="description">ユーザー表示ページにカスタムのGravatarを表示する。<a href="http://railstutorial.org/images/figures/profile_custom_gravatar_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="#fig-profile_mockup_profile_name">図7.1</a>のモックアップに近づけるために、ユーザーのサイドバーの最初のバージョンを作りましょう。ここでは<code>aside</code>タグを使用して実装します。このタグはサイドバーなどの補完コンテンツの表示に使用されますが、単独で表示することもできます。<code>row</code>クラスと<code>span4</code>クラスも追加しておきます。これらのクラスはBootstrapの一部です。ユーザー表示ページを変更した結果を<a class="ref" href="#code-user_show_with_sidebar">リスト7.14</a>に示します。</p>

<div class="label" id="code-user_show_with_sidebar"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.14</span> <span class="description">ユーザーの<code>show</code>ビューにサイドバーを追加する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>HTML要素とCSSクラスを配置したことにより、プロファイルページ (とサイドバーとGravatar) にSCSSで<a class="ref" href="#code-sidebar_css">リスト7.15</a>のようにスタイルを与えることができるようになりました (テーブルCSSのルールがネスティング (入れ子) されていますが、これが有効になるのはアセットパイプラインでSassエンジンが使用されている場合に限られます) 。ページの変更の結果を<a class="ref" href="#fig-user_show_sidebar_css">図7.9</a>に示します。</p>

<div class="label" id="code-sidebar_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.15</span> <span class="description">SCSSを使用してサイドバーなどのユーザー表示ページにスタイルを与える。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>

<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">section</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">padding-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">span</span> <span class="p">{</span>
      <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.4</span><span class="kt">em</span><span class="p">;</span>
      <span class="na">text-align</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-top</span><span class="o">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-user_show_sidebar_css"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_sidebar_css_bootstrap.png" alt="user_show_sidebar_css_bootstrap" /></span></div><div class="caption"><span class="header">図7.9: </span><span class="description">ユーザー表示ページ<a href="http://localhost:3000/users/1">/users/1</a>にサイドバーとCSSを追加する。<a href="http://railstutorial.org/images/figures/user_show_sidebar_css_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-signup_form"></div>


<h2><a id="sec-7_2" href="#sec-signup_form" class="heading"><span class="number">7.2</span>ユーザー登録フォーム</a></h2>


<p>ここまででユーザープロファイルページがひとまず動作するようになりましたので、今度はサインアップフォームを作成しましょう。<a class="ref" href="#fig-new_signup_page">図5.9</a> (<a class="ref" href="#fig-blank_signup_page_recap">図7.10</a>にも再録) に示したとおり、サインアップページはまだ空白のままなので、このままではサインアップできません。この節の目標は、このみっともないページを改造して<a class="ref" href="#fig-signup_mockup">図7.11</a>のモックアップのようなページに変えることです。</p>

<div class="label" id="fig-blank_signup_page_recap"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/new_signup_page_bootstrap.png" alt="new_signup_page_bootstrap" /></span></div><div class="caption"><span class="header">図7.10: </span><span class="description">現状のサインアップページ  <a href="http://localhost:3000/signup">/signup</a>。<a href="http://railstutorial.org/images/figures/new_signup_page_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-signup_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_mockup_bootstrap.png" alt="signup_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図7.11: </span><span class="description">ユーザーサインアップページのモックアップ。<a href="http://railstutorial.org/images/figures/signup_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>Web経由でユーザーを作成する機能をこれから追加しますので、<a class="ref" href="#sec-creating_a_user">6.3.5</a>で作成したユーザーをここで削除しておきましょう。 最も簡単な方法は、Rakeの<code>db:reset</code>タスクを実行してデータベースをリセットすることです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
</pre></div>
</div>


<p>システム環境によっては、データベースをリセットした後にもう一度prepareを実行しておく必要が生じることがあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>最後に、システムによっては変更を反映するためにターミナルで<tt>Ctrl-C</tt>を押してWebサーバーを再起動する必要が生じることもあります<sup class="footnote" id="fnref-7_8"><a href="#fn-7_8">8</a></sup>。</p>

<div class="label" id="sec-tests_for_user_signup"></div>


<h3><a id="sec-7_2_1" href="#sec-tests_for_user_signup" class="heading"><span class="number">7.2.1</span>ユーザー登録のためのテスト</a></h3>


<p>完全なテスト機能を備えた強力なWebフレームワークがなかった頃は、テスティング作業は苦痛に満ち、しばしばそこでエラーが発生しました。たとえば、もし仮にサインアップページを手動でテストしなければならないとしたら、ブラウザでそのページを表示し、有効なデータと無効なデータを交互に流しこみ、どちらの場合にもアプリケーションが正常に動作することを確認しなければならないでしょう。さらに、アプリケーションに変更が生じるたびに、まったく同じテストを繰り返さなければなりません。RSpecとCapybaraを使用することで柔軟性の高いテストを作成し、従来手動で行うしかなかったこれらのテストを自動化できるようになりました。</p>

<p>私たちは、既にCapybaraがWeb操作の文法を直感的にサポートしているところを目の当たりにしてきました。これまでは、特定のページを参照するときに<code>visit</code>を使用することがほとんどでしたが、Capybaraの能力はそれだけにとどまりません。<a class="ref" href="#fig-signup_mockup">図7.11</a>のフィールドに文字列を入力したり、ボタンをクリックしたりすることもできます。Capybaraの文法は以下のような感じです。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>目標は、正しくないユーザー登録情報と正しいユーザー登録情報を与えたときに、期待どおりに動作することを確認するテストの作成です。このテストはかなり込み入っているので、1つ1つ作り上げていきましょう。テストの動作結果や、どこにテストを置けばよいかなどをとにかく参照したい場合は、<a class="ref" href="#code-basic_signup_tests">リスト7.16</a>までスキップしてください。</p>

<p>最初のタスクは、ユーザー登録フォームの表示が失敗しないかどうか、そしてページを表示し、ボタンを押し、無効なデータを送信する動作をシミュレートすることです。ボタンを代わりに押すには<code>click_button</code>を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>このテストは、ユーザー登録ページをブラウザで表示し、ユーザー登録情報に何も入力しないまま送信する操作 (無効な操作) と同等です。同様に、有効なデータを送信する操作をシミュレートするには、 <code>fill_in</code>を使用して正しいユーザー情報を与えます。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>このテストの目的は、ユーザー登録ボタンを押したときに期待どおりに動作すること、ユーザー情報が有効な場合にはユーザーが新規作成され、無効な場合にはユーザーが作成されないことを確認することです。これを確認するには、ユーザーの<em>count</em>を使用します。背後で動作するこの<code>count</code>メソッドは、<code>User</code>を含むあらゆるActive Recordクラスで使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>この節の冒頭でデータベースをリセットしてあるので、現時点では<code>User.count</code>は<code>0</code>になっています。</p>

<p>無効なデータを送信した場合、ユーザーのカウントが変わらないことを期待しています。有効なデータを送信した場合には、ユーザーのカウントが1つ増えることを期待しています。このような動作は、RSpecで<code>expect</code>メソッドを<code>to</code>メソッドまたは <code>not_to</code>メソッドと組み合わせて実現できます。確認しやすいので、まずは無効な場合についてやってみましょう。ユーザー登録ページのパスをブラウザで開いてボタンをクリックしたら、ユーザーアカウントが変更<em>されない</em>という動作です。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>ここで、<code>expect</code>が<code>click_button</code>を山かっこで囲んでブロックになっていることに注目してください (<a class="ref" href="#sec-blocks">4.3.2</a>)。これは<code>change</code>メソッドで役に立ちます。このメソッドはオブジェクトとシンボルを引数に取り、シンボルを呼び出した結果を計算してオブジェクト上のメソッドとします。これはブロックの前と後いずれについても行われます。つまり、以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>以下を計算します。</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>上の計算は、以下の実行前と実行後の両方で行われます。</p>

<div class="code"><div class="highlight"><pre><span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>この場合は、コードがカウントを変更<em>しない</em>ことを期待していますので、<code>not_to</code>メソッドで表現しています。実際には、以下の同等のコードを</p>

<div class="code"><div class="highlight"><pre><span class="n">initial</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
<span class="n">final</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">initial</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">final</span>
</pre></div>
</div>


<p>ボタンクリックをブロックで囲むことによって以下のように1行で表しています。</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>こうすることで英語に近い自然な表記が可能になり、さらにコンパクトになります。</p>

<p>データが有効な場合のテストも大きな違いはありませんが、今度はカウントが更新されないのではなく、カウントが1つ増えることを確認します。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">expect</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
<span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>ここでは<code>to</code>メソッドを使用して、正しいデータを与えてユーザー登録ボタンを押したときにカウントが1つ<em>増える</em>ことを確認します。</p>

<p>上の2つのテストを適切な<code>describe</code>ブロックでコラム 、両者に共通する部分を<code>before</code>ブロックに移動すると、<a class="ref" href="#code-basic_signup_tests">リスト7.16</a>のようにユーザー登録を正しくテストできる基本的なテストのできあがりです。ここでは、送信ボタン用の共通部分を分解するために<code>let</code>メソッドを使用して<code>submit</code>変数を定義しています。</p>

<div class="label" id="code-basic_signup_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.16</span> <span class="description">ユーザー登録の基本的なテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:submit</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;should not create a user&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should create a user&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この節では、他にもいくつかのテストを追加する予定ですが、<a class="ref" href="#code-basic_signup_tests">リスト7.16</a>の基本テストだけでも既に相当量の機能をカバーしています。テストにパスするには、ユーザー登録ページを正しいHTML要素で作成し、ページの送信が正しい場所へルーティングされるようにし、ユーザーデータが正しい場合にのみ新しいユーザーを作成できるようにする必要があります。</p>

<p>もちろん、今の時点ではテストは失敗します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-using_form_for"></div>


<h3><a id="sec-7_2_2" href="#sec-using_form_for" class="heading"><span class="number">7.2.2</span><tt>form_for</tt>を使用する</a></h3>


<p>テストが正しく失敗したので、今度はユーザー登録の<em>フォーム</em>を作成してテストにパスするようにしましょう。これを行うには、Railsで<code>form_for</code>ヘルパーメソッドを使用します。このメソッドはActive Recordオブジェクトを取り込み、オブジェクトの属性を使用してフォームを構成します。変更の結果を<a class="ref" href="#code-signup_form">リスト7.17</a>に示します (Rails 2.xに慣れている方は、<code>form_for</code>ではコンテンツを挿入するときに “%=” を使用するERb方式の文法を使用していることに注意してください。 Rails 2.xでは<tt class="verb">&lt;% form_for ... </tt><tt class="verb">%&gt;</tt>という書式でしたが、Rails 3では<tt class="verb">&lt;%= form_for ... %&gt;</tt>という書式です)。</p>

<div class="label" id="code-signup_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.17</span> <span class="description">新しいユーザーを登録するフォーム。</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Create my account&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>このフォームの各部分について見てみましょう。<code>do</code>キーワードは、 <code>form_for</code>が1つの変数を持つブロックを取ることを表します。この変数<code>f</code>は “form” のfです。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>通常、Railsヘルパーを使用している場合、実装の詳細について知っておく必要はありません。ただし<code>f</code>というオブジェクトが<em>何をするのか</em>は知っておく必要があります。<a href="http://www.w3schools.com/html/html_forms.asp">HTMLフォーム要素</a> (テキストフィールド、ラジオボタン、パスワードフィールドなど) に対応するメソッドが呼び出されると、<code>@user</code>オブジェクトの属性を設定するように特別に設計された要素のためのコードを返します。つまり、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>というコードは、Userモデルの<code>name</code>属性を設定する、ラベル付きテキストフィールド要素を作成するのに必要なHTMLを作成します (HTML自体については<a class="ref" href="#sec-the_form_html">7.2.3</a>で詳しく説明します)。</p>

<p>実際の動作を理解するには、このフォームによって生成される実際のHTMLについて理解を深める必要があります。しかしここで問題があります。このページでは<code>@user</code>変数に何も設定されておらず、未完成です。 他のすべての未定義インスタンス変数 (<a class="ref" href="#sec-a_user_class">4.4.5</a>) と同様、<code>@user</code>の内容は現時点では<code>nil</code>です。従って、この時点でテストスイートを実行すると、<a class="ref" href="#code-initial_signup_test">リスト7.6</a>のユーザー登録ページの構造 (<code>h1</code>や<code>title</code>など) に対するテストは失敗します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;signup page&quot;</span>
</pre></div>
</div>


<p>(この<code>-e</code>オプションは、descriptionの文字列が<code>&quot;signup page&quot;</code>に一致する例を単に実行するためのものです。ここで注意していただきたいのは、これは<code>&quot;signup&quot;</code>という部分文字列とは<em>違う</em>ということです。もし&quot;signup&quot; であれば<a class="ref" href="#code-basic_signup_tests">リスト7.16</a>のすべてのテストが実行されるでしょう。) テストにパスしてフォームが正常に出力されるようにするには、<code>new.html.erb</code>に対応する<code>@user</code>変数をコントローラのアクションで定義する必要があります。たとえば、Usersコントローラの<code>new</code>がそうです。<code>form_for</code>ヘルパーは<code>@user</code>がUserオブジェクトであることを前提としています。ここでは<em>新しい</em>ユーザーを作成するので、<a class="ref" href="#code-new_action_with_user">リスト7.18</a>のように単に<code>User.new</code>とします。</p>

<div class="label" id="code-new_action_with_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.18</span> <span class="description"><code>@user</code>変数を<code>new</code>アクションに追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>@user</code>変数が上記のように定義されれば、以下のユーザー登録のテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;signup page&quot;</span>
</pre></div>
</div>


<p>この時点で、フォーム に<a class="ref" href="#code-form_css">リスト7.19</a>のようにスタイルが与えられていれば、<a class="ref" href="#fig-signup_form">図7.12</a>のように表示されます。<code>box_sizing</code>ミックスインを<a class="ref" href="#code-mixin_and_debug">リスト7.2</a>から再利用していることに注目してください。</p>

<div class="label" id="code-form_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.19</span> <span class="description">ユーザー登録フォームのCSS。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>

<span class="nt">input</span><span class="o">,</span> <span class="nt">textarea</span><span class="o">,</span> <span class="nt">select</span><span class="o">,</span> <span class="nc">.uneditable-input</span> <span class="p">{</span>
  <span class="na">border</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#bbb</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">input</span> <span class="p">{</span>
  <span class="na">height</span><span class="o">:</span> <span class="no">auto</span> <span class="nv">!</span><span class="nv">important</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-signup_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_form_bootstrap.png" alt="signup_form_bootstrap" /></span></div><div class="caption"><span class="header">図7.12: </span><span class="description">新規ユーザーのためのユーザー登録フォーム<a href="http://localhost:3000/signup">/signup</a>。<a href="http://railstutorial.org/images/figures/signup_form_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-the_form_html"></div>


<h3><a id="sec-7_2_3" href="#sec-the_form_html" class="heading"><span class="number">7.2.3</span>フォームHTML</a></h3>


<p><a class="ref" href="#fig-signup_form">図7.12</a>に示したように、ユーザー登録は正常に表示されるようになりました。これは、<a class="ref" href="#code-signup_form">リスト7.17</a>の<code>form_for</code>コードが正しいHTMLを生成しているということです。生成されたフォームのHTMLソースを見てみると (<a href="http://getfirebug.com/">Firebug</a>を使うか、ブラウザの [ソースを表示] を使用)、ソースのマークアップは<a class="ref" href="#code-signup_form_html">リスト7.20</a>のようになっているはずです。このHTMLの細かい部分はほとんど私たちの目的には関係ありませんが、この構造の最も重要な部分に注目してみましょう。</p>

<div class="label" id="code-signup_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.20</span> <span class="description"><a class="ref" href="#fig-signup_form">図7.12</a>のフォームのHTMLソース。</span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">&quot;UTF-8&quot;</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span>
      <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span>
         <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password_confirmation&quot;</span><span class="nt">&gt;</span>Confirmation<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password_confirmation&quot;</span> 
         <span class="na">name=</span><span class="s">&quot;user[password_confirmation]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> 
         <span class="na">value=</span><span class="s">&quot;Create my account&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span> 
</pre></div>
</div></div>


<p>(実は、このソースからは<em>信頼性トークン (authenticity token) </em>関連のHTMLを除外してあります。Railsは、ある種の<em>クロスサイトリクエスト偽造</em> (CSRF: cross-site request forgery) 攻撃に対抗するためにこのようなHTMLを自動的に追加します。動作の詳細や、この防御が重要な理由を知りたい場合は、<a href="http://stackoverflow.com/questions/941594/understand-rails-authenticity-token">Stack OverflowのRails信頼性トークン関連の書き込み</a>を参照してください。</p>

<p>まずはこのHTMLソースの内部構造について説明します。<a class="ref" href="#code-signup_form">リスト7.17</a>と<a class="ref" href="#code-signup_form_html">リスト7.20</a>をじっくり見比べてみると、以下の埋め込みRubyが</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>以下のHTMLを生成していることがわかります。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>さらに、以下の埋め込みRubyは</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>以下のHTMLを生成していることがわかります。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="#fig-filled_in_form">図7.13</a>に示したように、テキストフィールド (<code>type=&quot;text&quot;</code>) では内容をそのまま表示していますが、パスワードフィールド (<code>type=&quot;password&quot;</code>) ではセキュリティ上の目的のために文字が隠蔽されています。<a class="ref" href="#fig-filled_in_form"></a></p>

<div class="label" id="fig-filled_in_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/filled_in_form_bootstrap.png" alt="filled_in_form_bootstrap" /></span></div><div class="caption"><span class="header">図7.13: </span><span class="description"><code>text</code>フィールドと<code>password</code>フィールドに文字を入力した状態。<a href="http://railstutorial.org/images/figures/filled_in_form_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="#sec-signup_success">7.4</a>で説明したとおり、ユーザーの作成で重要なのは<code>input</code>ごとにある特殊な<code>name</code>属性です。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
.
.
.
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Railsはこれらの<code>name</code>の値を使用して、初期化ハッシュを (<code>params</code>変数経由で) 構成します。このハッシュは、ユーザーが入力した値に基づいてユーザーを作成するとき (<a class="ref" href="#sec-signup_failure">7.3</a>) に使用されます。</p>

<p>次に重要な要素は、<code>form</code>タグ自身です。Railsは<code>form</code>タグを作成するときに<code>@user</code>オブジェクトを使用します。すべてのRubyオブジェクトは自分のクラスを知っている (<a class="ref" href="#sec-constructors">4.4.1</a>) ので、Railsは<code>@user</code>のクラスが<code>User</code>であることを知ることができます。また、<code>@user</code>は<em>新しい</em>ユーザーなので、 Railsは<code>post</code>メソッドを使用してフォームを構成する方法を知っています。これは新しいオブジェクトを作成するための正式な動詞 (verb) です (<a class="ref" href="#sidebar-get_etc">コラム 3.2</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>ここで<code>class</code>と<code>id</code>属性はほぼ無関係です。ここで重要な属性は<code>action=&quot;/users&quot;</code>と<code>method=&quot;post&quot;</code>です。これらの2つの属性は、HTTP <tt>POST</tt>リクエストに対する指示を構成します。これらの属性の効用については次の2つの節で説明します。</p>

<div class="label" id="sec-signup_failure"></div>


<h2><a id="sec-7_3" href="#sec-signup_failure" class="heading"><span class="number">7.3</span>ユーザー登録失敗</a></h2>


<p><a class="ref" href="#fig-signup_form">図7.12</a>ではフォームのHTMLがどうなっているかを簡単に説明しました (<a class="ref" href="#code-signup_form_html">リスト7.20</a>参照) が、この方法は<em>サインアップの失敗</em>のときに最も理解の助けになります。この節では、無効なデータ送信を受け付けるサインアップフォームを作成し、サインアップフォームを更新してエラーの一覧を表示します。このモックアップを<a class="ref" href="#fig-signup_failure_mockup">図7.14</a>に示します。</p>

<div class="label" id="fig-signup_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_mockup_bootstrap.png" alt="signup_failure_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図7.14: </span><span class="description">サインアップが失敗したときのモックアップ。<a href="http://railstutorial.org/images/figures/signup_failure_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-a_working_form"></div>


<h3><a id="sec-7_3_1" href="#sec-a_working_form" class="heading"><span class="number">7.3.1</span>正しいフォーム</a></h3>


<p>最初に、ユーザー登録フォームを送信したときに発生するエラーを解消します。これはブラウザでも確認ですが、ユーザー登録フォームで無効な情報を入力するテストを実施することでも確認できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="go">-e &quot;signup with invalid information&quot;</span>
</pre></div>
</div>


<p><a class="ref" href="#sec-a_users_resource">7.1.2</a>で、<code>resources :users</code>を<code>routes.rb</code>ファイルに追加すると (<a class="ref" href="#code-users_resource">リスト7.3</a>) 自動的にRailsアプリケーションが<a class="ref" href="#table-RESTful_users">表7.1</a>のRESTful URI に応答するようになったことを思い出してください。特に、/usersへの<tt>POST</tt>リクエストは<code>create</code>アクションに送られます。私たちはここで、<code>create</code>アクションでフォーム送信を受け取り、<code>User.new</code>を使用して新しいユーザーオブジェクトを作成し、ユーザーを保存 (または保存に失敗) し、再度の送信用のユーザー登録ページを表示するという方法で機能を実装しようと思います。まずはユーザー登録フォームのコードを見直してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="#sec-the_form_html">7.2.3</a>で説明したように、このHTMLは<tt>POST</tt>リクエストを /users URIに送信します。</p>

<p><a class="ref" href="#code-basic_signup_tests">リスト7.16</a>にある無効な情報を使用するテストを使用して、<a class="ref" href="#code-first_create_action">リスト7.21</a>のコードがテストにパスするようにすることができます。このリストでは、<a class="ref" href="#sec-partials">5.1.3</a>の「パーシャル」のところでも使った<code>render</code>メソッドを再度使いまわしています。<code>render</code>はコントローラアクションの中でも正常に動作します。ここで、以前に説明した<code>if</code>-<code>else</code>分岐構造を思い出してください。この文を使用して、保存が成功したかどうかに応じて<code>@user.save</code>の値が<code>true</code>または<code>false</code> (<a class="ref" href="#sec-creating_user_objects">6.1.3</a>) になるときに、それぞれ成功時の処理と失敗時の処理を場合分けすることができます。</p>

<div class="label" id="code-first_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.21</span> <span class="description">ユーザー登録の失敗に対応できる<code>create</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Handle a successful save.</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-first_create_action">リスト7.21</a>のコードの動作を理解するもっともよい方法は、実際に無効なユーザー登録データを<em>送信 (submit)</em>してみることです。結果を<a class="ref" href="#fig-signup_failure_rails_3">図7.15</a>に、完全なデバッグ情報を<a class="ref" href="#fig-signup_failure_rails_3_bootstrap_debug">図7.16</a>に示しました。</p>

<div class="label" id="fig-signup_failure_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_rails_3_bootstrap.png" alt="signup_failure_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">図7.15: </span><span class="description">ユーザー登録失敗。<a href="http://railstutorial.org/images/figures/signup_failure_rails_3_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-signup_failure_rails_3_bootstrap_debug"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_rails_3_bootstrap_debug.png" alt="signup_failure_rails_3_bootstrap_debug" /></span></div><div class="caption"><span class="header">図7.16: </span><span class="description">ユーザー登録失敗時のデバッグ情報。<a href="http://railstutorial.org/images/figures/signup_failure_rails_3_bootstrap_debug-full.png">(拡大)</a></span></div></div>


<p>Railsが送信を扱う方法をより深く理解するために、デバッグ情報のうち<code>params</code>ハッシュの部分を詳しく見てみましょう (<a class="ref" href="#fig-signup_failure_rails_3_bootstrap_debug">図7.16</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Foo Bar</span>
  <span class="l-Scalar-Plain">password_confirmation</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bar</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo@invalid</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create my account</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
</pre></div>
</div>


<p><a class="ref" href="#sec-a_users_resource">7.1.2</a>で説明したとおり、<code>params</code>ハッシュには各リクエストの情報が含まれています。/users/1のようなURIの場合、<code>params[:id]</code>の値は該当するユーザーの<code>id</code> (この例では<code>1</code>) になります。ユーザー登録情報の送信の場合、<code>params</code>には複数のハッシュに対するハッシュ (hash-of-hashes: 入れ子になったハッシュ) が含まれます (なお、<a class="ref" href="#sec-hashes_and_symbols">4.3.3</a>ではhash-of-hashesの説明とともに、コンソールセッションで使用するためにあえて<code>params</code>という名前の変数を導入しました)。上のデバッグ情報では、フォーム送信の結果が、送信された値に対応する属性とともに<code>user</code>ハッシュに保存されています。ハッシュのキーは、<code>input</code>タグの<code>name</code>属性です (<a class="ref" href="#code-signup_form">リスト7.17</a>)。たとえば、以下の値の</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p><code>&quot;user[email]&quot;</code>という名前は、<code>user</code>ハッシュの<code>email</code>属性を正確に指します。</p>

<p>ハッシュのキーはデバッグ情報では文字列として表現されていますが、Railsはこれらを文字列ではなく、<code>params[:user]</code>がuser属性のハッシュになるような「シンボル」(Rubyの機能の1つで、一意性が保証された特別な文字列) として扱います。実際、<a class="ref" href="#sec-a_user_class">4.4.5</a>で初めて使われ、<a class="ref" href="#code-first_create_action">リスト7.21</a>でも使用されていたように、これらのハッシュは<code>User.new</code>の引数として必要な属性と正確に一致します。これはつまり、以下の行は</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>以下と等価であるということを意味します。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>もちろん、この変数が継承されたということはユーザー登録が成功したということでもあります。<a class="ref" href="#sec-signup_success">7.4</a>でも説明しますが、従って、<code>@user</code>が正しく定義されてしまえば、<code>@user.save</code>を行うだけで登録が完了します (ただし、今の段階ではユーザー登録が失敗した場合にも同じ動作になってしまいますが)。<a class="ref" href="#fig-signup_failure_rails_3">図7.15</a>のフィールドは、送信に失敗したときのデータが自動的に<em>入力済み</em>の状態になっています。これは、<code>form_for</code>が<code>@user</code>オブジェクトの属性を自動的にフィールドに入力しているからです。たとえば、<code>@user.name</code>の値が<code>&quot;Foo&quot;</code>であれば</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>上のコードによって以下のHTMLが生成されます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;Foo&quot;</span><span class="nt">/&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>ここで<code>input</code>タグの<code>value</code>属性は <code>&quot;Foo&quot;</code> になっています。これがテキストフィールドに表示されているのです。</p>

<p>ご想像のとおり、この段階ではフォームを送信してもエラーが生じなくなりました。以下の無効なデータ送信テストもパスするようになっているはすです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="go">-e &quot;signup with invalid information&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-signup_error_messages"></div>


<h3><a id="sec-7_3_2" href="#sec-signup_error_messages" class="heading"><span class="number">7.3.2</span>ユーザー登録のエラーメッセージ</a></h3>


<p>必須というわけではありませんが、ユーザー登録に失敗した場合は、ユーザー登録が行われなかったということをユーザーに伝えるエラーメッセージを表示する方がよいでしょう。Railsは、このようなメッセージをUserモデルの検証時に生成してくれます。たとえば、ユーザー情報のメールアドレスが無効で、パスワードが短すぎる状態で保存しようとしたとします。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>                <span class="ss">password:</span> <span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;dude&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Email is invalid&quot;, &quot;Password is too short (minimum is 6 characters)&quot;]</span>
</pre></div>
</div>


<p><a class="ref" href="#sec-presence_validation">6.2.2</a>でも簡単に説明しましたが、<code>errors.full_messages</code>オブジェクトにはエラーメッセージの配列が含まれています。</p>

<p>上のコンソールセッションに示されているように、<a class="ref" href="#code-first_create_action">リスト7.21</a>で保存に失敗すると、<code>@user</code>オブジェクトに関連付けられたエラーメッセージの一覧が生成されます。このメッセージをブラウザで表示するには、ユーザーの<code>new</code>ページでエラーメッセージのパーシャル (partial) を出力します。<a class="ref" href="#code-f_error_messages">リスト7.22</a>に示します。(このエラーメッセージのテストを行うのはよいことですが、演習の課題としてあえて残しておきます。<a class="ref" href="#sec-signup_exercises">7.6</a>を参照してください。) ここで使用しているエラーメッセージのパーシャルはあくまで試作品である点にご注意ください。最終版は<a class="ref" href="#sec-creating_microposts">10.3.2</a>を参照してください。</p>

<div class="label" id="code-f_error_messages"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.22</span> <span class="description">ユーザー登録フォームでエラーメッセージを表示するコード。</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>ここでは、<code>’shared/error_messages’</code>というパーシャルを<code>出力 (レンダリング) </code>している点にご注目ください。これはRails全般の慣習で、パーシャルは複数のコントローラにわたるビューに対し、専用の<code>shared/</code>ディレクトリを使用するようにしています (これは<a class="ref" href="#sec-edit_form">9.1.1</a>で実現します)。 つまり、<code>app/views/shared</code>ディレクトリと<code>_error_messages.html.erb</code>パーシャルファイルの両方を作成する必要があるということです。パーシャル自身の内容を<a class="ref" href="#code-errors_partial">リスト7.23</a>に示します。</p>

<div class="label" id="code-errors_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.23</span> <span class="description">フォーム送信のエラーメッセージを表示するパーシャル。</span><br /><span class="description"> <code>app/views/shared/_error_messages.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>パーシャルによって、RailsとRubyには、Railsエラーオブジェクト用の2つのメソッドを含む多くの成果物が導入されました。最初は<code>count</code>メソッドを紹介します。これはエラーの数を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 2</span>
</pre></div>
</div>


<p>もう1つは<code>any?</code>メソッドです。これは<code>empty?</code>メソッドと互いに補完します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p><a class="ref" href="#sec-objects_and_message_passing">4.2.3</a>では文字列に対して<code>empty?</code>メソッドを使用しましたが、Railsのエラーオブジェクトに対しても使用できます。オブジェクトが空の場合は<code>true</code>、 それ以外の場合は<code>false</code>を返します。<code>any?</code>メソッドはちょうど<code>empty?</code>と逆の動作で、要素が1つでもある場合は<code>true</code>、ない場合は<code>false</code>を返します (なお、これらの<code>count</code>、<code>empty?</code>、<code>any?</code>メソッドは、Rubyの配列に対してもそのまま使用できます。<a class="ref" href="#sec-showing_microposts">10.2</a>でこのことを応用する予定です)。</p>

<p>さらに、<code>pluralize</code>という英語専用のテキストヘルパーが新たに登場しています。このヘルパーはデフォルトではコンソールでは使用できませんが、<code>ActionView::Helpers::TextHelper</code>を経由して明示的にインクルードできます<sup class="footnote" id="fnref-7_9"><a href="#fn-7_9">9</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">include</span> <span class="ss">ActionView::Helpers</span><span class="o">::</span><span class="no">TextHelper</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;1 error&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;5 errors&quot;</span>
</pre></div>
</div>


<p><code>pluralize</code>の最初の引数に整数が与えられると、それに基づいて2番目の引数の英単語を複数形に変更したものを返します。このメソッドの背後には強力な<em>インフレクター (活用形生成) </em> があり、不規則活用を含むさまざまな単語を複数形にすることができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;woman&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;2 women&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;erratum&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;3 errata&quot;</span>
</pre></div>
</div>


<p><code>pluralize</code>を使用することで、コードは以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>このコードはたとえば <code>&quot;0 errors&quot;</code>、<code>&quot;1 error&quot;</code>、<code>&quot;2 errors&quot;</code> などのように、エラーの数に応じて活用された単語を返します。これにより、<code>&quot;1 errors&quot;</code>のような英語の文法に合わない文字列を避ける事ができます (これは<a href="http://www.urbandictionary.com/define.php?term=interwebs">teh interwebs</a>にも載っている、どうしようもないほどよく見かけるエラーです)。</p>

<p><a class="ref" href="#code-errors_partial">リスト7.23</a>には、エラーメッセージにスタイルを与えるためのCSS id <code>error_explanation</code>も含まれていることに注目してください (<a class="ref" href="#sec-custom_css">5.1.2</a>でCSSがスタイルidに「<code>#</code>」記号を使用していることを思い出してください)。さらにRailsは、エラーページにある、<code>div</code>で囲まれたエラーCSSクラス<code>field_with_errors</code>を適用しています。これらのラベルによって、<a class="ref" href="#code-error_messages_css">リスト7.24</a>のようにエラーメッセージをSCSSで整形することができます。ここでは、Sassの<code>@extend</code>関数を使用してBootstrapの<code>control-group</code>と<code>error</code>の2つのクラスの機能をインクルードしています。その結果、送信失敗時のエラーメッセージは<a class="ref" href="#fig-signup_error_messages">図7.17</a>のように赤の背景で囲まれるようになります。これらのメッセージはモデルの検証時に生成されるので、メールアドレスのスタイルやパスワードの最小文字列などを変更すると、メッセージも自動的に変更されます。</p>

<div class="label" id="code-error_messages_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.24</span> <span class="description">エラーメッセージにスタイルを与えるためのCSS。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nn">#error_explanation</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#f00</span><span class="p">;</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">18</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="k">@extend</span> <span class="nc">.control-group</span><span class="o">;</span>
  <span class="o">@</span><span class="nt">extend</span> <span class="nc">.error</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-signup_error_messages"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_error_messages_bootstrap.png" alt="signup_error_messages_bootstrap" /></span></div><div class="caption"><span class="header">図7.17: </span><span class="description">ユーザー登録失敗時のエラーメッセージ。<a href="http://railstutorial.org/images/figures/signup_error_messages_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この節で達成した成果を確認するために、<a class="ref" href="#code-basic_signup_tests">リスト7.16</a>のユーザー登録失敗のテストを再度実行し、ユーザー登録ページを表示して入力フィールドが空白のまま [Create my account] をクリックするという動作をテストしましょう。 テストの結果を<a class="ref" href="#fig-blank_signup_password_digest">Figure 7.18</a>に示します。今度は期待どおりテストにパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signup with invalid information&quot;</span>
</pre></div>
</div>


<div class="label" id="fig-blank_signup_password_digest"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/blank_signup_password_digest_bootstrap.png" alt="blank_signup_password_digest_bootstrap" /></span></div><div class="caption"><span class="header">図7.18: </span><span class="description"><a href="http://localhost:3000/signup">/signup</a>を表示して何も入力せずに [Create my account] をクリックする。<a href="http://railstutorial.org/images/figures/blank_signup_password_digest_bootstrap-full.png">(拡大)</a></span></div></div>


<p>残念ながら、<a class="ref" href="#fig-blank_signup_password_digest">図7.18</a>のエラーメッセージには若干問題が残っています。このエラーメッセージは “Password digest can’t be blank” となっていますが、本来であれば “Password can’t be blank” とすべきでしょう。これは、<a class="ref" href="#sec-has_secure_password">6.3.4</a>で簡単に説明した<code>has_secure_password</code>の中に、パスワードダイジェストの存在を検証するコードが隠れているためです。この問題の修正は、演習問題とさせてください (<a class="ref" href="#sec-signup_exercises">7.6</a>)。</p>

<div class="label" id="sec-signup_success"></div>


<h2><a id="sec-7_4" href="#sec-signup_success" class="heading"><span class="number">7.4</span>ユーザー登録成功</a></h2>


<p>無効なフォームの送信を扱えるようになったので、いよいよ新規ユーザーを実際にデータベースに保存できるようにし (もちろんフォームが有効な場合に)、ユーザー登録フォームを完成させましょう。まずは、ユーザーを保存できるようにします。保存に成功すると、ユーザー情報は自動的にデータベースに登録されます。次にブラウザの表示を<em>リダイレクト</em>して、登録されたユーザーのプロファイルを表示します。ついでにウェルカムメッセージも表示しましょう。モックアップを<a class="ref" href="#fig-signup_success_mockup">Figure 7.19</a>に示します。保存に失敗した場合は、単に<a class="ref" href="#sec-signup_failure">7.3</a>で開発したとおりの動作が実行されます。</p>

<div class="label" id="fig-signup_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_success_mockup_bootstrap.png" alt="signup_success_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図7.19: </span><span class="description">ユーザー登録に成功した画面のモックアップ。<a href="http://railstutorial.org/images/figures/signup_success_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-the_finished_signup_form"></div>


<h3><a id="sec-7_4_1" href="#sec-the_finished_signup_form" class="heading"><span class="number">7.4.1</span>登録フォームの完成</a></h3>


<p>ユーザー登録フォームを完成させるために、<a class="ref" href="#code-first_create_action">リスト7.21</a>のコメントアウトされた部分にコードを書き、適切に動作するようにしましょう。現時点では、以下の有効な送信テストは失敗するはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signup with valid information&quot;</span>
</pre></div>
</div>


<p>Railsのデフォルトのアクションは対応するビューを表示するようになっていますが、<code>create</code>アクションに対応するビューのテンプレートがない (あるはずがありません) ため、テストに失敗します。ここでは、登録後に別のページを表示するようにし、そのページが新規作成されたユーザープロファイルであることがわかるようにします。正しいページが出力されているかどうかのテストは、演習に回すことにします (<a class="ref" href="#sec-signup_exercises">7.6</a>)。アプリケーションのコードを<a class="ref" href="#code-user_create_action">リスト7.25</a>に示します。</p>

<div class="label" id="code-user_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.25</span> <span class="description">保存とリダイレクトを行う、userの<code>create</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>リダイレクトでは<code>user_url</code>を省略し、単に<code>redirect_to @user</code>と書けばユーザー表示ページに移動します。</p>

<p><a class="ref" href="#code-user_create_action">リスト7.25</a>のコードを使用することで、ユーザー登録ページは完成し、動作するようになります。以下のテストを実行することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-the_flash"></div>


<h3><a id="sec-7_4_2" href="#sec-the_flash" class="heading"><span class="number">7.4.2</span>flash</a></h3>


<p>いよいよブラウザで正しいユーザー情報を登録できるようになりましたが、その前にWebアプリケーションに常識的に備わっている機能を追加してみましょう。登録完了後に表示されるページにメッセージを表示し (この場合は新規ユーザーへのウェルカムメッセージ)、2度目以降にはそのページにメッセージを表示しないようにするというものです。Railsでは、こういう場合に<em>flash</em>という特殊な変数を使用できます。この変数はちょうど<a href="http://en.wikipedia.org/wiki/Flash_memory">フラッシュメモリー</a>のようにデータを一時的にのみ保存することからこう呼ばれています。<code>flash</code>変数は事実上ハッシュです。<a class="ref" href="#sec-hashes_and_symbols">4.3.3</a>でコンソール上で実行した例を思い出してみてください。そこではあえて<code>flash</code>と名付けたハッシュを使用してハッシュの値を列挙しました。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success:</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="ss">error:</span> <span class="s2">&quot;It failed.&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;&quot;It worked!&quot;, error: &quot;It failed.&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">success</span>
<span class="go">It worked!</span>
<span class="go">error</span>
<span class="go">It failed.</span>
</pre></div>
</div>


<p><a class="ref" href="#code-layout_flash">リスト7.26</a>のようにアプリケーションのレイアウトに含めれば、flash変数の内容をWebサイト全体にわたって表示できるようにすることもできます (このコードは、HTMLとERbがミックスされていて美しくありません。コードの改良は<a class="ref" href="#sec-signup_exercises">7.6</a>で解説します)。</p>

<div class="label" id="code-layout_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">7.26</span> <span class="description"><code>flash</code>変数の内容をWebサイトのレイアウトに追加する。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-layout_flash">リスト7.26</a>のコードは、flashの各要素に<code>div</code>タグを追加して整形し、CSSクラスを指定してメッセージの種類がわかるようにしています。たとえば、<code>flash[:success] = &quot;Welcome to the Sample App!&quot;</code>とする場合、以下のコードを実行すると</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span> 
</pre></div>
</div>


<p>以下のHTMLが生成されます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;</span>Welcome to the Sample App!<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>(ハッシュの<code>:success</code>キーはシンボルである点にご注目ください。Rubyはシンボルを自動的に <code>&quot;success&quot;</code> という文字列に変換してからテンプレートに挿入します。) 使用するすべてのキーと値を列挙する理由は、他のフラッシュメッセージも使えるようにするためです。たとえば、<a class="ref" href="#sec-rendering_with_a_flash_message">8.1.5</a>では<code>flash[:error]</code>を使用してサインインに失敗したことを表すメッセージを表示します<sup class="footnote" id="fnref-7_10"><a href="#fn-7_10">10</a></sup>。</p>

<p>フラッシュメッセージが正しく表示されているかどうかのテストは演習に回します (<a class="ref" href="#sec-signup_exercises">7.6</a>)。<a class="ref" href="#code-signup_flash">リスト7.27</a>のように、<code>create</code>アクションで<code>flash[:success]</code>にウェルカムメッセージを割り当てれば 、テストにパスするようになります。</p>

<div class="label" id="code-signup_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.27</span> <span class="description">ユーザー登録ページにフラッシュメッセージを追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-the_first_signup"></div>


<h3><a id="sec-7_4_3" href="#sec-the_first_signup" class="heading"><span class="number">7.4.3</span>実際のユーザー登録</a></h3>


<p>ついに、ユーザー登録が完成しました。名前: “Rails Tutorial”、メールアドレス: “<tt>example@railstutorial.org</tt>”とでも登録してみましょう。登録結果 (<a class="ref" href="#fig-signup_flash">図7.20</a>)にはユーザー登録成功を示すウェルカムメッセージが、<code>success</code>クラスのさわやかな緑色の背景で表示されています。このクラスは<a class="ref" href="#sec-custom_css">5.1.2</a>のBootstrap CSSフレームワークのものです。(もしメールアドレスが既に使用されているというメッセージが表示されたら、<a class="ref" href="#sec-signup_form">7.2</a>でやったようにRakeの<code>db:reset</code>を実行してデータベースをリセットしてください)。ユーザー表示ページを再度読み込むと、今度はフラッシュメッセージは表示されなくなりました (<a class="ref" href="#fig-signup_flash_reloaded">図7.21</a>)。</p>

<div class="label" id="fig-signup_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash_bootstrap.png" alt="signup_flash_bootstrap" /></span></div><div class="caption"><span class="header">図7.20: </span><span class="description">ユーザー登録が成功し、フラッシュメッセージが表示される。<a href="http://railstutorial.org/images/figures/signup_flash_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-signup_flash_reloaded"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash_reloaded_bootstrap.png" alt="signup_flash_reloaded_bootstrap" /></span></div><div class="caption"><span class="header">図7.21: </span><span class="description">ブラウザでページを再読み込みしてフラッシュメッセージが表示されなくなる。<a href="http://railstutorial.org/images/figures/signup_flash_reloaded_bootstrap-full.png">(拡大)</a></span></div></div>


<p>今度はデータベースを覗いて、新規ユーザーが確かに登録されていることをダブルチェックしましょう。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Rails Tutorial&quot;, email: &quot;example@railstutorial.org&quot;,</span>
<span class="go">created_at: &quot;2011-12-13 05:51:34&quot;, updated_at: &quot;2011-12-13 05:51:34&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$A58/j7wwh3aAffGkMAO9Q.jjh3jshd.6akh...&quot;</span><span class="go">&gt;</span>
</pre></div>
</div>




<div class="label" id="sec-deploying_to_production_with_ssl"></div>


<h3><a id="sec-7_4_4" href="#sec-deploying_to_production_with_ssl" class="heading"><span class="number">7.4.4</span> SSLを導入して本番環境をデプロイする</a></h3>


<p>Userモデルとユーザー登録機能の開発が終わったので、今度はこのサンプルアプリケーションを本番 (production) 環境にデプロイしましょう (<a class="ref" href="#cha-static-pages">第3章</a>の設定を行なっていない場合は、今のうちに設定を行なっておいてください)。 デプロイの作業の1つとして、<a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">Secure Sockets Layer (SSL)</a><sup class="footnote" id="fnref-7_11"><a href="#fn-7_11">11</a></sup>を本番アプリケーションに追加し、ユーザー登録をセキュアにします。SSLはWebサイト全体で有効にするので、サンプリアプリケーションのユーザー登録 (<a class="ref" href="#cha-sign-in-sign-out">第8章</a>) もセキュアになり、<em>セッションハイジャック</em>の脆弱性を防止できます (<a class="ref" href="#sec-remember_me">8.2.1</a>)。</p>

<p>デプロイの下準備として、この時点で変更を<code>master</code>ブランチにマージしておきます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish user signup&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-up
</pre></div>
</div>


<p>デプロイされたアプリケーションが期待どおりに動作するために、SSLが本番環境で動作するための行を1つ追加します。そのためには、<code>config/environments/production.rb</code>ファイルを <a class="ref" href="#code-ssl_in_production">リスト7.28</a>のように変更します。</p>

<div class="label" id="code-ssl_in_production"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.28</span> <span class="description">本番環境のアプリケーションでSSLを有効にする。</span><br /><span class="description"> <code>config/environments/production.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># アプリケーションへのすべてのアクセスをSSL経由にし、
  # Strict-Transport-Securityを使用し、</span>
  <span class="c1"># secure cookiesを使用する。</span>
  <span class="n">config</span><span class="o">.</span><span class="n">force_ssl</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>本番Webサイトが動作するために、設定ファイルの変更をコミットしてHerokuにプッシュする必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -a -m <span class="s2">&quot;Add SSL in production&quot;</span>
<span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>次に、本番データベースでマイグレーションを実行し、HerokuにUserデータモデルを使用することを通知します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>(ここでいくつか警告メッセージが表示されることがありますが、無視しても構いません。)</p>

<p>最後に、リモートサーバーでSSLを設定します。本番WebサイトでSSLを使用するように設定を行うのはかなり面倒で、間違いも起きやすくなっています。また、使用する独自ドメイン向けの<em>SSL証明書</em>も購入しなければなりません。幸い、このサンプルアプリケーションのようにHerokuドメインのまま使用してもよいのであれば、HerokuのSSL証明書を流用することができます。これはHerokuプラットフォームの一部として自動的に利用できる機能です。SSLを<code>example.com</code>のような独自ドメインで実行したいのであれば、SSL証明書を購入するしかありません。詳細は<a href="http://devcenter.heroku.com/articles/ssl">HerokuのSSL関連ページ</a>を参照してください。</p>

<p>これでいよいよ、以下を実行して本番サーバーでユーザー登録フォームが動作するところをブラウザで見ることができます (<a class="ref" href="#fig-signup_in_production">図7.22</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div>
</div>


<p><a class="ref" href="#fig-signup_in_production">Figure 7.22</a>では、通常の<tt>http://</tt>ではなく<tt>https://</tt>になっていることにご注目ください。この余分な ‘s’ はSSLが有効であることを表しています。</p>

<p>今や好きなだけユーザー登録ページを表示して新規ユーザーを作成できます。何か問題が生じた場合は、以下を実行して</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div>
</div>


<p>Herokuのログファイルを使用してエラーをデバッグします。</p>

<div class="label" id="fig-signup_in_production"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_in_production_bootstrap.png" alt="signup_in_production_bootstrap" /></span></div><div class="caption"><span class="header">図7.22: </span><span class="description">本番Webで動作中のユーザー登録ページ。 <a href="http://railstutorial.org/images/figures/signup_in_production_bootstrap-full.png">(拡大)</a></span></div></div>




<h2><a id="sec-7_5" href="#sec-7_5" class="heading"><span class="number">7.5</span>最後に</a></h2>


<p>ユーザー登録機能の実装は、私たちのサンプルアプリケーションにとって大きなマイルストーンでした。この時点でサンプルアプリケーションはかなり実用的になってきましたが、まだ重要な機能がいくつも残っています。<a class="ref" href="#cha-sign-in-sign-out">第8章</a>では、認証 (authentication) システムを導入し、ユーザーがサインインとサインアウトを行えるようにします。<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>では、どのユーザーも自分のアカウント情報を更新できるようにし、Webサイトの管理者がユーザーを削除できるようにします。それにより、Usersリソースに<a class="ref" href="#table-RESTful_users">表7.1</a>のRESTアクションがすべて実装されるようにします。最後に、認可 (authorization) のためのメソッドをアクションに追加し、Webサイトがセキュリティモデルに従うようにします。</p>

<div class="label" id="sec-signup_exercises"></div>


<h2><a id="sec-7_6" href="#sec-signup_exercises" class="heading"><span class="number">7.6</span>演習</a></h2>




<ol>

<li><a class="ref" href="#code-gravatar_option">リスト7.29</a>のコードで、<a class="ref" href="#sec-a_gravatar_image">7.1.4</a>で定義された<code>gravatar_for</code>ヘルパーにオプションの<code>size</code>パラメーターを取ることができる (<code>gravatar_for user, size: 40</code>のようなコードをビューで使用できる) ことを確認してください。</li>

<li><a class="ref" href="#code-f_error_messages">リスト7.22</a>で実装したエラーメッセージをテストするコードを書いてください。<a class="ref" href="#code-error_messages_test">リスト7.31</a>のように書き始めるのがお勧めです。</li>

<li><a class="ref" href="#code-password_digest_message_fix">リスト7.30</a>のコードを使用して、パスワードがない場合のエラーメッセージを別のメッセージに置き換えてください。現在のメッセージは “Password digest can’t be blank”ですが、よりわかりやすい “Password can’t be blank” に置き換えます。(ここではRailsの国際化 (internationalization) サポートを使用して実現していますが、これはどちらかというと荒っぽい (hacky) 方法です。YAMLの書式にタブを使用しないよう、代わりにスペースを使用するよう十分注意してください (<a href="http://www.yaml.org/faq.html">&quot;YAMLフォーマットではタブは使用できない&quot;</a>)。) エラーメッセージが重複して表示されないように、Userモデルでパスワードの<code>presence: true</code>検証を削除しておく必要もあります。</li>

<li><a class="ref" href="#code-after_save_tests">リスト7.32</a>のテストが、<code>create</code>アクションでユーザーを保存した後の動作を正しく捉えていることを確認してください。確認方法は、最初にテストを書いてもよいし、アプリケーションのコードをわざと壊してその後修正しても構いません。</li>

<li>既に書いたとおり、<a class="ref" href="#code-layout_flash">リスト7.26</a>のコードは美しいとは言えません。より読みやすくした<a class="ref" href="#code-layout_flash_content_tag">リスト7.33</a>のコードに対してテストスイートを実行し、こちらも正常に動作することを確認してください。このコードでは、Railsの<code>content_tag</code>ヘルパーを使用しています。</li>

</ol>




<div class="label" id="code-gravatar_option"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.29</span> <span class="description"><code>gravatar_for</code>ヘルパー用のオプションの<code>:size</code>パラメーターを定義する。</span><br /><span class="description"> <code>app/helpers/users_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar (http://gravatar.com/) for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">size:</span> <span class="mi">50</span> <span class="p">})</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">?</span><span class="s2">s=</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-password_digest_message_fix"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.30</span> <span class="description">パスワードがない場合のエラーメッセージをハックする。</span><br /><span class="description"> <code>config/locales/en.yml</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="l-Scalar-Plain">en</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">activerecord</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">password_digest</span><span class="p-Indicator">:</span> <span class="s">&quot;Password&quot;</span>
</pre></div>
</div></div>




<div class="label" id="code-error_messages_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.31</span> <span class="description">お勧めのエラーメッセージテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after submission&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div></div>




<div class="label" id="code-after_save_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.32</span> <span class="description"><code>create</code>アクションで保存が行われた後の動作をテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre>    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after saving the user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s1">&#39;user@example.com&#39;</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-success&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Welcome&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div></div>




<div class="label" id="code-layout_flash_content_tag"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.33</span> <span class="description">サイトのレイアウトにある<code>flash</code> ERbで<code>content_tag</code>を使用する。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;alert alert-</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<div class="footnotes">
<ol>
<li id="fn-7_1"><a href="http://gomockingbird.com/">Mockingbird</a>では<a class="ref" href="#fig-profile_mockup_profile_name">図7.1</a>のプロファイル写真のようなカスタム画像はサポートされていません。ここでは<a href="http://www.adobe.com/products/fireworks/">Adobe Fireworks</a>を使用して手動で画像を置きました。<a class="arrow" href="#fnref-7_1">↑</a></li>
<li id="fn-7_2">このカバの写真は<a href="http://www.flickr.com/photos/43803060@N00/24308857/">http://www.flickr.com/photos/43803060@N00/24308857/</a>から引用しました。<a class="arrow" href="#fnref-7_2">↑</a></li>
<li id="fn-7_3">Railsの<code>デバッグ</code>情報は <a href="http://www.yaml.org/">YAML</a> (一種の<a href="http://catb.org/jargon/html/R/recursive-acronym.html">再帰的略語</a>であり、“YAML Ain’t Markup Language” の略とされています) 形式で表示されます。YAMLは人間<em>だけでなく</em>コンピュータにとっても読みやすい形式です。<a class="arrow" href="#fnref-7_3">↑</a></li>
<li id="fn-7_4">実は、この3つ以外にもカスタムの環境を作成することができます。詳細については<a href="http://railscasts.com/episodes/72-adding-an-environment">環境を追加した場合のRailsCast</a>を参照してください。<a class="arrow" href="#fnref-7_4">↑</a></li>
<li id="fn-7_5">この時点では、<em>ルーティング</em>は動作していますが、対応するページが動作しているとは限りません。たとえば、/users/1/edit がUsersコントローラの<code>edit</code>アクションに正常にルーティングされているとしても、<code>edit</code>アクションが存在しなければ、このURIにアクセスしたときにエラーになります。<a class="arrow" href="#fnref-7_5">↑</a></li>
<li id="fn-7_6">ヒンズー教では、アバターは人間や動物の形をとって神が顕現したものと考えられています。これを拡大解釈して、<em>アバター</em>という用語は、特にネット界隈で、その人物を表現するもの (かつその人そのものの一部でもある) という意味で使われます。もちろん、映画「<a href="http://www.imdb.com/title/tt0499549/">アバター</a>」を見た人にはこんな解説は不要でしょう。<a class="arrow" href="#fnref-7_6">↑</a></li>
<li id="fn-7_7">アプリケーションでカスタム画像を扱ったりその他のファイルをアップロードする必要がなければ、代わりに<a href="http://github.com/thoughtbot/paperclip">Paperclip</a> gemをお勧めします。<a class="arrow" href="#fnref-7_7">↑</a></li>
<li id="fn-7_8">どうにも気持ちの悪い動作だと思いませんか。私はどちらもやりません。<a class="arrow" href="#fnref-7_8">↑</a></li>
<li id="fn-7_9">私は<a href="http://api.rubyonrails.org/v3.2.0/classes/ActionView/Helpers/TextHelper.html#method-i-pluralize">Rails API</a>で<code>pluralize</code>を調べていてたまたま気付きました。<a class="arrow" href="#fnref-7_9">↑</a></li>
<li id="fn-7_10">実際には、これに非常に近い<code>flash.now</code>を使いますが、本当に必要になるまでは使わないようにしようかと思います。<a class="arrow" href="#fnref-7_10">↑</a></li>
<li id="fn-7_11">技術上は、SSLはTLS (Transport Layer Security) と名称が変わりましたが、未だに “SSL” と呼ばれ続けています。<a class="arrow" href="#fnref-7_11">↑</a></li>
</ol>
</div>




<div class="label" id="cha-sign-in-sign-out"></div>


<h1 class="chapter"><a id="sec-8" href="#cha-sign-in-sign-out" class="heading"><span class="number">第8章</span>サインイン、サインアウト</a></h1>


<p><a class="ref" href="#cha-sign-up">第7章</a>でWebサイトでの新規ユーザー登録が行えるようになりましたので、今度はユーザーがサインインとサインアウトを行えるようにしましょう。これにより、サインインの状態と現在のユーザーidに応じて動作を変更できるようになります。たとえば、この章では、サイトのヘッダー部分にサインイン／サインアウトのリンクとプロファイルへのリンクを表示するようにします。<a class="ref" href="#cha-user-microposts">第10章</a>では、サインインしたユーザーidを使用して、そのユーザーに関連付けられたマイクロポストを作成します。また<a class="ref" href="#cha-following-users">第11章</a>では、現在のユーザーが他のユーザーをフォローして、マイクロポストのフィードを受け取ることができるようにします。</p>

<p>ユーザーがサインインすることでセキュリティモデルも実装され、サインインしているユーザーidに基づいて、特定のページへのアクセスを制限することもできます。<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>でも説明しますが、たとえばサインインしたユーザーのみがユーザー情報編集ページにアクセスできるようにします。サインインシステムを使用して、管理者ユーザーに特別な権限を与えることもできます。たとえば  (<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>で導入する) データベースからユーザーを削除する機能があります。</p>

<p>コアとなる認証機能を実装した後は、少々回り道して、振舞駆動開発 (<a class="ref" href="#sec-cucumber">8.3</a>) で有名な<em>Cucumber</em>というツールを試してみます。特に、2つの開発手法を比較するために、RSpecによる結合テストの組み合わせをCucumberで再実装します。</p>

<p>前章同様に、トピックブランチで作業してから、最後に更新をマージします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b sign-in-out
</pre></div>
</div>


<div class="label" id="sec-signin_failure"></div>


<h2><a id="sec-8_1" href="#sec-signin_failure" class="heading"><span class="number">8.1</span>セッション、サインインの失敗</a></h2>


<p><a href="http://en.wikipedia.org/wiki/Session_(computer_science)"><em>セッション</em></a>とは、2つのコンピュータの間、たとえばクライアント側のブラウザとサーバーで動作しているRailsとの間の、半永続的な接続のことです。ここでは、”サインイン” の共通パターンを実装するためにセッションを使用します。ここで、Webの世界にはセッションの振る舞いを表現するためのいくつかの異なったモデルがあります。ブラウザを閉じるとセッションを終了する「忘却モデル」、[パスワードを保存する] チェックボックスを使用してセッションを継続する「継続モデル」、ユーザーが明示的にサインアウトするまでセッションを継続する「永続モデル」などです<sup class="footnote" id="fnref-8_1"><a href="#fn-8_1">1</a></sup>。ここでは、最後の永続モデルを採用することにします。ユーザーがサインインすると、ユーザーが明示的にサウンアウトするまでサインインの状態を永続させます (<a class="ref" href="#sec-remember_me">8.2.1</a>では、“永続” が実際どれくらいの長さなのかをお見せします)。</p>

<p>セッションは、RESTfulなリソースとして作成しておくと便利です。たとえばサインインページを<em>new</em>セッションで、サインインを<em>create</em>セッションで、サインアウトを<em>destroy</em>セッションでそれぞれ扱います。Usersリソースのように (Usersモデルを経由して) データベースをバックエンドに持つリソースとは異なり、このSessionsリソースでは<a href="http://en.wikipedia.org/wiki/HTTP_cookie"><em>cookies</em></a>を使用します。cookiesとは、ブラウザに保存される小さなテキストデータです。サインイン関連の作業の大半は、このcookiesをベースにして認証システムを構築することになります。この節と次の節では、セッション機能を作成する準備として、Sessionコントローラ、サインイン用のフォーム、そしてこれらに関連するコントローラのアクションを作成します。次の<a class="ref" href="#sec-signin_success">8.2</a>では、cookies管理のために必要なコードを追加して、ユーザーがサインインするための仕組みを完成させます。 </p>

<div class="label" id="sec-sessions_controller"></div>


<h3><a id="sec-8_1_1" href="#sec-sessions_controller" class="heading"><span class="number">8.1.1</span> Sessionコントローラ</a></h3>


<p>サインインとサインアウトの要素は、Sessionsコントローラの特定のRESTアクションにそれぞれ対応します。サインインのフォームは、この節の<code>new</code>アクションで処理されます。実際のサインイン処理は、<code>create</code>アクションに<tt>POST</tt>リクエストが送信されたときに処理されます (<a class="ref" href="#sec-signin_failure">8.1</a>および<a class="ref" href="#sec-signin_success">8.2</a>) 。サインアウトは、<code>destroy</code>アクションに<tt>DELETE</tt>リクエストを送信することで処理されます(<a class="ref" href="#sec-signing_out">8.2.6</a>)。(<a class="ref" href="#table-RESTful_users">表7.1</a>のHTTPメソッドとRESTアクションの関連付けを思い出してください。) それでは最初に、Sessionsコントローラと認証システムをテストする結合テストを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions --no-test-framework
<span class="gp">$</span> rails generate integration_test authentication_pages
</pre></div>
</div>


<p><a class="ref" href="#sec-signup_form">7.2</a>で作ったユーザー登録ページのモデルを元に、新しいセッションを確立するためのフォームを<a class="ref" href="#fig-signin_mockup">図8.1</a>のモックアップに従って作成します。</p>

<div class="label" id="fig-signin_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_mockup_bootstrap.png" alt="signin_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図8.1</span><span class="description">サインインフォームのモックアップ。<a href="http://railstutorial.org/images/figures/signin_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>このサインインページは、<code>signin_path</code>によって仮に定義されるURIでアクセス可能になります。<a class="ref" href="#code-new_session_tests">リスト8.1</a>のように、最初は最小限のテストから始めます (<a class="ref" href="#code-initial_signup_test">リスト7.6</a>のユーザー登録ページのコードと似ているので、比較してみてください)。</p>

<div class="label" id="code-new_session_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.1</span> <span class="description">セッションの<code>new</code>アクションとビューをテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signin page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>以下のテストは、この時点では失敗するはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p><a class="ref" href="#code-new_session_tests">リスト8.1</a>のテストがパスするためには、サインインページ用にカスタマイズした名前付きルートを使用して、Sessionsリソースのルーティングを定義する必要があります。このサインインページはSessionコントローラの<code>new</code>アクションと対応しています。Usersリソースの場合と同様に、<code>resources</code>メソッドを使用して通常のRESTfulなルーティングを設定することができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</pre></div>
</div>


<p>セッションを編集したりユーザーに表示したりする必要がないので、<code>resources</code>メソッドに<code>:only</code>オプションをつ近し、<code>new</code>、<code>create</code>、<code>destroy</code>の3つのアクションのみを有効にします。サインインとサインアウト用のルーティングを含む完全なコードを<a class="ref" href="#code-sessions_resource">リスト8.2</a>に示します。</p>

<div class="label" id="code-sessions_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.2</span> <span class="description">リソースを追加して標準のRESTfulアクションを設定する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;users#new&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signin&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;sessions#new&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signout&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;sessions#destroy&#39;</span><span class="p">,</span> <span class="ss">via:</span> <span class="ss">:delete</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>注:サインアウトのルーティングにある <code>via: :delete</code>は、このアクションが HTTPの<tt>DELETE</tt>リクエストによって呼び出されることを示しています。</p>

<p><a class="ref" href="#code-sessions_resource">リスト8.2</a>で定義されたリソースは、<a class="ref" href="#table-RESTful_sessions">表8.1</a>に示したように、<a class="ref" href="#table-RESTful_users">表7.1</a>とよく似たURIとアクションを提供します。注：サインインとサインアウトのアクションのルーティングはカスタムで設定しますが、セッションの生成アクションへのルーティングはデフォルトを使います (<code>[resource name]_path</code>).</p>

<div class="label" id="table-RESTful_sessions"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTPリクエスト</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>名前付きルート</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/signin</td><td class="align_left"><code>signin_path</code></td><td class="align_left"><code>new</code></td><td class="align_left">新しいセッション用 (サインイン)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/sessions</td><td class="align_left"><code>sessions_path</code></td><td class="align_left"><code>create</code></td><td class="align_left">新しいセッションを作成する</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/signout</td><td class="align_left"><code>signout_path</code></td><td class="align_left"><code>destroy</code></td><td class="align_left">セッションを削除する (サインアウト)</td></tr></table></div><div class="caption"><span class="header">表8.1</span><span class="description"><a class="ref" href="#code-sessions_resource">リスト8.2</a>のセッションルールによって提供されるRESTfulなルート。</span></div></div>


<p>次に、<a class="ref" href="#code-new_session_tests">リスト8.1</a>のテストがパスするようにするために、<a class="ref" href="#code-new_session_title">リスト8.3</a>に示したように<code>new</code>アクションをSessionsコントローラに追加します (後で使えるよう<code>create</code>アクションと<code>destroy</code>アクションも定義しておきます) 。</p>

<div class="label" id="code-new_session_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.3</span> <span class="description">最初のSessionsコントローラ。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>最後に、サインインページを新規に定義します。このページは新規セッション用なので、今から作成するサインインページを<code>app/views/sessions/new.html.erb</code>に置くことにご注目ください。<a class="ref" href="#code-initial_signin_page">リスト 8.4</a>に示したように、今の時点ではタイトルと一番上のヘッダ部分のみを定義します。</p>

<div class="label" id="code-initial_signin_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.4</span> <span class="description">最初のサインインビュー。</span><br /><span class="description"> <code>app/views/sessions/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>これにより、<a class="ref" href="#code-new_session_tests">リスト 8.1</a>のテストが青信号 (成功) になります。これで実際のサインインフォームを作成する準備ができました。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-signin_tests"></div>


<h3><a id="sec-8_1_2" href="#sec-signin_tests" class="heading"><span class="number">8.1.2</span>サインインをテストする</a></h3>


<p><a class="ref" href="#fig-signin_mockup">図8.1</a>と<a class="ref" href="#fig-signup_mockup">図7.11</a>を比較すると、サインインフォーム (新規セッションフォーム) の外観は、4つあったフィールドがメールアドレスとパスワードの2つになったこと以外は、ユーザー登録フォームによく似ていることに気付くと思います。ユーザー登録フォームのときと同様に、サインインフォームでもCapybaraを使ってフォームに値を入力し、ボタンをクリックするテストを行うことができます。</p>

<p>テストを作成していると、私たちはアプリケーションをさまざまな側面から設計することを強いられます。これはテスト駆動開発の素晴らしい副次的効果のひとつです。<a class="ref" href="#fig-signin_failure_mockup">図8.2</a>のモックアップで示されているように、最初はサインインの入力に誤りがあった場合のテストから作成します。</p>

<div class="label" id="fig-signin_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_failure_mockup_bootstrap.png" alt="signin_failure_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図8.2</span><span class="description">サインイン失敗時のモックアップ。<a href="http://railstutorial.org/images/figures/signin_failure_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="#fig-signin_failure_mockup">図 8.2</a>に示されているように、サインインで入力した情報に誤りがあったときは、サインインページをもう一度表示して、エラーメッセージを出力します。エラーをフラッシュメッセージとして表示するときには、以下のようにテストできます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>(<a class="ref" href="#cha-sign-up">7章</a>の<a class="ref" href="#code-after_save_tests">リスト7.32</a>のコードによく似ていることがわかると思います)。セレクタ要素（つまりタグ）は以下のように指定します。</p>

<div class="code"><div class="highlight"><pre><span class="n">div</span><span class="o">.</span><span class="n">alert</span><span class="o">.</span><span class="n">alert</span><span class="o">-</span><span class="n">error</span>
</pre></div>
</div>


<p>上のコードのドットはCSSのクラスを意味することを思い出してください (<a class="ref" href="#sec-custom_css">5.1.2</a>) 。つまりこのテストでは、<code>&quot;alert&quot;</code>クラスと<code>&quot;alert-error&quot;</code>クラスの<code>div</code>タグを対象にしていることがわかります。また、エラーメッセージに<code>&quot;Invalid&quot;</code>という単語が含まれていることもテストします。これらを合わせると、次のフォームの要素を探しだしてテストが行われます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>Invalid...<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="#code-initial_failing_signin_test">リスト 8.5</a>のコードは、タイトルとフラッシュメッセージをまとめてテストします。ただしこのテストは、実はある重要な点を欠いています。これは<a class="ref" href="#sec-rendering_with_a_flash_message">8.1.5</a>で改善します。</p>

<div class="label" id="code-initial_failing_signin_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.5</span> <span class="description">サインイン失敗時のテスト。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>サインインに失敗した時のテストができたので、次はサインインに成功した場合のテストを作成しましょう。ユーザープロファイルページが表示されること (ページタイトルがユーザー名になっていること)、サイトのナビゲーションに次の3つの変更が加えられていることを確認するよう、テストを変更します。</p>

<ol>
<li>プロファイルページヘのリンクの表示</li>
<li>[Sign out] リンクの表示</li>
<li>[Sign in] リンクの表示</li>
</ol>


<p>([Setting] リンクについては<a class="ref" href="#sec-updating_users">9.1</a>で、[Users] リンクについては<a class="ref" href="#sec-showing_all_users">9.3</a>でそれぞれテストします) 。これらの変更を加えたモックアップを<a class="ref" href="#fig-signin_success_mockup">図8.3</a>に示しました<sup class="footnote" id="fnref-8_2"><a href="#fn-8_2">2</a></sup>。サインアウトとプロファイルページヘのリンクは、[Account] メニューにドロップダウンで表示されます。Bootstrapを使用してドロップダウンメニューを作成する方法については<a class="ref" href="#sec-changing_the_layout_links">8.2.4</a>で説明します。</p>

<div class="label" id="fig-signin_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_success_mockup_bootstrap.png" alt="signin_success_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図8.3: </span><span class="description">サインインに成功後表示されるユーザープロファイルのモックアップ。<a href="http://railstutorial.org/images/figures/signin_success_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>サインインに成功したときのテストコードを<a class="ref" href="#code-signin_success_tests">リスト8.6</a>に示しました。</p>

<div class="label" id="code-signin_success_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.6</span> <span class="description">サインインに成功したときのテスト。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは<code>have_link</code>メソッドを使用しています。このメソッドは、リンクテキストを引数にとります。オプションとして次のように<code>:href</code>パラメータを加えると、</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>アンカータグ<code>a</code>に<code>href</code> (URI) 属性を追加することもできます (この例では、ユーザープロファイルへのリンク)。上のテストでは、<code>upcase</code>メソッドを使用してユーザーのメールアドレスを大文字に変換することで、大文字小文字を区別しないデータベースが使用されている場合であってもユーザーを確実に検索できるように配慮してあることにご注目ください。</p>

<div class="label" id="sec-signin_form"></div>


<h3><a id="sec-8_1_3" href="#sec-signin_form" class="heading"><span class="number">8.1.3</span>サインインのフォーム</a></h3>


<p>テストの準備が完了したので、いよいよサインインフォームの開発に取りかかりましょう。<a class="ref" href="#code-signup_form">リスト7.17</a>のときは、以下のようにユーザー登録フォームで<code>form_for</code>ヘルパーを使用し、ユーザーのインスタンス変数 <code>@user</code>を引数にとっていました。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>このユーザー登録フォームとサインインフォームの主な違いは、Sessionモデルがないために<code>@user</code>変数のような存在がないことです。 これはつまり、新しいセッションフォームをつくるときに<code>form_for</code>ヘルパーに追加の情報を渡す必要があるということです。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>Railsでは、上記のフォームの<code>アクション</code>の場合は/usersというURIへの <tt>POST</tt>だと判定しますが、Sessionの場合はリソースの<em>名前</em>とそれに対応するURIを指定する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span>
</pre></div>
</div>


<p>(注: <code>form_for</code>の代わりに<code>form_tag</code>を使うこともでき、Railsではこの方が慣用的な方法です。しかし、ユーザー登録フォームではform_forを使用する方が一般的であり、並列構造を強調するためにもform_forを使用しました。\<code>form_tag</code>を使ったフォームについては(<a class="ref" href="#sec-sign_in_out_exercises">8.5</a>)の演習に回します。)</p>

<p>適切な<code>form_for</code>を使用することで、 <a class="ref" href="#code-signup_form">リスト7.17</a>のユーザー登録フォームを参考にして、<a class="ref" href="#fig-signin_mockup">図8.1</a>に示したモックアップに従ったサインインフォームを簡単に作成できます <a class="ref" href="#code-signin_form">リスト8.7</a>)。</p>

<div class="label" id="code-signin_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.7</span> <span class="description">サインインフォームのコード。</span><br /><span class="description"> <code>app/views/sessions/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>ユーザーにとって便利なように、ユーザー登録ページのリンクを追加してあることにご注目ください。<a class="ref" href="#code-signin_form">リスト 8.7</a>のコードで生成されるサインインフォームを<a class="ref" href="#fig-signin_form">図 8.4</a>に示します。</p>

<div class="label" id="fig-signin_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_form_bootstrap.png" alt="signin_form_bootstrap" /></span></div><div class="caption"><span class="header">図8.4</span><span class="description">サインインフォーム  (<a href="http://localhost:3000/signin">/signin</a>)。<a href="http://railstutorial.org/images/figures/signin_form_bootstrap-full.png">(拡大)</a></span></div></div>


<p>これまではRailsが生成したHTMLをブラウザでたびたび確認していた方も多いと思いますが、やがてその習慣は忘れ去られ、ヘルパーが正常に動作していることを信頼するようになる日が来ることでしょう。今はいつものように(<a class="ref" href="#code-signin_form_html">リスト 8.8</a>)を見てみましょう。</p>

<div class="label" id="code-signin_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.8</span> <span class="description"><a class="ref" href="#code-signin_form">リスト8.7</a>で生成されたサインインフォームのHTML。</span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">&quot;UTF-8&quot;</span> <span class="na">action=</span><span class="s">&quot;/sessions&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_email&quot;</span> <span class="na">name=</span><span class="s">&quot;session[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_password&quot;</span> <span class="na">name=</span><span class="s">&quot;session[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> 
           <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> 
       <span class="na">value=</span><span class="s">&quot;Sign in&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-signin_form_html">リスト8.8</a>と<a class="ref" href="#code-signup_form_html">リスト7.20</a>を比較することで、フォーム送信後に<code>params</code>ハッシュに入る値が、メールアドレスとパスワードのフィールドにそれぞれ対応した<code>params[:session][:email]</code>と<code>params[:session][:password]</code>になることを推測できることでしょう。</p>

<div class="label" id="sec-reviewing_form_submission"></div>


<h3><a id="sec-8_1_4" href="#sec-reviewing_form_submission" class="heading"><span class="number">8.1.4</span>確認フォームを送信する</a></h3>


<p>ユーザーを作成する (ユーザー登録) 場合と同様、セッションを作成する場合 (サインイン) で最初にやることは、<em>正しくない</em>入力の取り扱いです。ユーザー登録のテストは既に作成済みです (<a class="ref" href="#code-initial_failing_signin_test">リスト 8.5</a>)。そしてサインアップのアプリケーションコードは、2つの点がユーザー登録のコードとわずかに異なります。最初に、フォームが送信されたとき何が起こるかを考えましょう。次に、サインインが失敗した場合に表示されるエラーメッセージを配置します (モックアップを<a class="ref" href="#fig-signin_failure_mockup">図8.2</a>に示しました)。次に、、サインインが送信されるたびに、パスワードとメールアドレスの組み合わせが正しいかどうかを判定し、サインインに成功した場合に使用する土台 (<a class="ref" href="#sec-signin_success">8.2</a>) を作成します。</p>

<p>最初に、Sessionsコントローラに最小限の<code>create</code>アクションを定義します (<a class="ref" href="#code-initial_create_session">リスト8.9</a>) 。このアクションは何も実行しませんが、<code>new</code>ビューを表示します。<a href="http://localhost:3000/sessions/new">/sessions/new</a>フォームのフィールドを空白のまま送信すると<a class="ref" href="#fig-initial_failed_signin_rails_3">図8.5</a>のように表示されます。</p>

<div class="label" id="code-initial_create_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.9</span> <span class="description">Sessionsコントローラの<code>create</code>アクションの試作バージョン。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig-initial_failed_signin_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/initial_failed_signin_rails_3_bootstrap.png" alt="initial_failed_signin_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">図8.5</span><span class="description"><a class="ref" href="#code-initial_create_session">リスト8.9</a>の<code>create</code>へのサインイン失敗結果。<a href="http://railstutorial.org/images/figures/initial_failed_signin_rails_3_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="#fig-initial_failed_signin_rails_3">図8.5</a> に表示されているデバッグ情報にご注目ください。<a class="ref" href="#sec-signin_form">8.1.3</a> の終わりにもヒントがありましたが、<code>params</code>ハッシュはメールアドレスとパスワードを以下のように<code>:session</code>キーの下に持ちます。</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sign in</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div>
</div>


<p>ユーザー登録の場合 (<a class="ref" href="#fig-signup_failure_rails_3">図7.15</a>) と同様、これらのパラメータは<a class="ref" href="#code-nested_hashes">リスト4.6</a>に示したように<em>ネストした (入れ子になった) </em>ハッシュになっています。特に、<code>params</code>は以下のような入れ子ハッシュになっています。</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">session:</span> <span class="p">{</span> <span class="ss">password:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>


<p>
これはつまり、</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div>
</div>


<p>上はそれ自体がハッシュであり、以下の要素を含んでいます。</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">password:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
</pre></div>
</div>


<p>その結果、</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div>
</div>


<p>上はフォームから送信されたメールアドレスであり、</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div>
</div>


<p>上はフォームから送信されたパスワードです。</p>

<p>言い換えれば、<code>create</code>アクションの<code>params</code>ハッシュには、ユーザーの認証に必要な情報がすべて含まれているということになります。ここまでに、私たちはすでに必要なメソッドを手にしています。 Active Recordが<code>User.find_by_email</code>を提供し (<a class="ref" href="#sec-finding_user_objects">6.1.4</a>)、 <code>has_secure_password</code>が<code>authenticate</code>メソッドを提供しています (<a class="ref" href="#sec-user_authentication">6.3.3</a>)。認証に失敗したとき、<code>authenticate</code>の返り値は<code>false</code>になることを思い出してください。ユーザーのサインイン方法の方針をまとめると以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="c1"># ユーザをサインインさせ、ユーザページ (show) にリダイレクトする。</span>
  <span class="k">else</span>
    <span class="c1"># エラーメッセージを表示し、サインインフォームを再描画する。</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>最初の行は、送信されたメールアドレスを使用して、データベースからユーザーを取り出しています。(<a class="ref" href="#sec-uniqueness_validation">6.2.5</a>ではメールアドレスはすべて小文字で保存されていたことを思い出してください。従って、ここでは<code>downcase</code>メソッドを使用して、正しいメールアドレスが入力されたときに確実にマッチするようにしています)。次の行は少しわかりにくいかもしれませんが、Railsプログラミングでは定番の手法です。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p><code>&amp;&amp;</code> (<em>論理積</em>) は、取得したユーザーが有効かどうかを決定するのに使用します。<code>nil</code>と<code>false</code>以外のすべてのオブジェクトは、真偽値では<code>true</code>になる (<a class="ref" href="#sec-objects_and_message_passing">4.2.3</a>) というRubyの性質を考慮すると、 組み合わせは<a class="ref" href="#table-user_and_and">表8.2</a>のようになります。 <a class="ref" href="#table-user_and_and">表 8.2</a>を見ると、入力されたメールアドレスを持つユーザーがデータベースに存在し、かつ入力されたパスワードがそのユーザーのパスワードである場合のみ、<code>if</code>文が<code>true</code>になることがわかります。</p>

<div class="label" id="table-user_and_and"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>ユーザー</strong></th><th class="align_left"><strong>パスワード</strong></th><th class="align_left"><strong>a &amp;&amp; b</strong></th></tr><tr class="top_bar"><td class="align_left">存在しない</td><td class="align_left"><em>何でもよい</em></td><td class="align_left"><code>nil &amp;&amp; [anything] == false</code></td></tr><tr><td class="align_left">有効なユーザー</td><td class="align_left">誤ったパスワード</td><td class="align_left"><code>true &amp;&amp; false == false</code></td></tr><tr><td class="align_left">有効なユーザー</td><td class="align_left">正しいパスワード</td><td class="align_left"><code>true &amp;&amp; true == true</code></td></tr></table></div><div class="caption"><span class="header">表8.2</span><span class="description"><code>user &amp;&amp; user.authenticate(…)</code>の結果の組み合わせ。</span></div></div>




<div class="label" id="sec-rendering_with_a_flash_message"></div>


<h3><a id="sec-8_1_5" href="#sec-rendering_with_a_flash_message" class="heading"><span class="number">8.1.5</span>フラッシュメッセージを表示する</a></h3>


<p><a href="#sec-signup_error_messages" class="ref">7.3.2</a>では、Userモデルのエラーメッセージを使用してユーザー登録のエラーメッセージを表示したことを思い出してください。これらのエラーメッセージは、特定のActive Recordオブジェクトに関連付けられていますが、セッションはActive Recordのモデルではないためにこの方法はここでは使用できません。代わりに、サインインに失敗したときにフラッシュメッセージを表示することにします。最初のコードを<a class="ref" href="#code-failed_signin_attempt">リスト8.10</a>に示します (ここには少しだけ間違いがあります)。</p>

<div class="label" id="code-failed_signin_attempt"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.10</span> <span class="description">サインインの失敗を扱う (誤りあり)。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># ユーザーをサインインさせ、ユーザーのshowページにリダイレクトする</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span> <span class="c1"># 誤りあり!</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>フラッシュメッセージはWebサイトのレイアウトに表示される (<a class="ref" href="#code-layout_flash">リスト7.26</a>) ので、<code>flash[:error]</code>のメッセージは自動的に表示されます。Bootstrap CSSのおかげで適切なスタイルも与えられます (<a class="ref" href="#fig-failed_signin_flash">図8.6</a>)。</p>

<div class="label" id="fig-failed_signin_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/failed_signin_flash_bootstrap.png" alt="failed_signin_flash_bootstrap" /></span></div><div class="caption"><span class="header">図8.6</span><span class="description">サインインに失敗したときのフラッシュメッセージ。<a href="http://railstutorial.org/images/figures/failed_signin_flash_bootstrap-full.png">(拡大)</a></span></div></div>


<p>残念ながら、本文および<a class="ref" href="#code-failed_signin_attempt">リスト8.10</a>のコメントで述べたように、このコードには誤りがあります。ページの表示には問題がないようですが、どこがおかしいのでしょうか。実は、ある<em>リクエスト</em>に対するフラッシュメッセージの内容がすぐに消えずに残ってしまうという問題があります。<a class="ref" href="#code-signup_flash">リスト7.27</a>で使用したリダイレクトのときとは異なり、<code>render</code>で表示したテンプレートを再描画してもリクエストと見なされません。このため、フラッシュメッセージはひとつのリクエストに対して期待よりも長い間消えずに表示され続けてしまいます。たとえば、無効な情報を送信するとサインインページにフラッシュメッセージが設定されて表示されます (<a class="ref" href="#fig-failed_signin_flash">図8.6</a>)。ここでHomeページなどの別のページへのリンクをクリックすると、これはフォームが送信されてから最初のリクエストであるため、フラッシュメッセージが移動先のページでも表示されたままになってしまいます (<a class="ref" href="#fig-flash_persistence">図8.7</a>)。</p>

<div class="label" id="fig-flash_persistence"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/flash_persistence_bootstrap.png" alt="flash_persistence_bootstrap" /></span></div><div class="caption"><span class="header">図8.7</span><span class="description">フラッシュメッセージが消えずに残っている例。<a href="http://railstutorial.org/images/figures/flash_persistence_bootstrap-full.png">(拡大)</a></span></div></div>


<p>フラッシュメッセージの残留問題はこのアプリケーションのバグです。この問題を修正する前に、この問題をキャッチするテストを書くのが正しいやり方です。特に、現在のサインイン失敗テストではこの問題がキャッチされずにパスしてしまいます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signin with invalid information&quot;</span>
</pre></div>
</div>


<p>当然ながら、既知のバグが未修正の状態であれば、このテストはパスするべきではありません。この問題をキャッチする、失敗するテストを追加しましょう。幸い、結合テストはフラッシュメッセージ残留などの多くの問題解決において大活躍します。期待される動作は以下のテストで正確に表現されています。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;after visiting another page&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このテストは、無効なサインインデータを送信し、次にWebサイトのレイアウトにあるHomeリンクを開き、フラッシュメッセージが表示されていないことを確認します。フラッシュテストの部分を更新したテストコードを<a class="ref" href="#code-correct_signin_failure_test">リスト8.11</a>に示します。</p>

<div class="label" id="code-correct_signin_failure_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.11</span> <span class="description">サインインの失敗を正しくテストするコード。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;after visiting another page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>再度テストを実行すると、期待どおり失敗します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signin with invalid information&quot;</span>
</pre></div>
</div>


<p>失敗するテストがパスするためには、<code>flash</code>の代わりに<code>flash.now</code>を使用します。これもページでフラッシュメッセージを表示するために特に設計されたメソッドですが、<code>flash</code>の場合とは異なり、他のリクエストが発生したらすぐにメッセージを消します。正しいアプリケーションコードを<a class="ref" href="#code-correct_signin_failure">リスト8.12</a>に示します。</p>

<div class="label" id="code-correct_signin_failure"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.12</span> <span class="description">サインインが失敗したときの正しいコード。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># ユーザーをサインインさせ、ユーザーのshowページにリダイレクトする</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これで、ユーザー情報が無効な場合のテストスイートが緑色 (成功) になりました。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;with invalid information&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-signin_success"></div>


<h2><a id="sec-8_2" href="#sec-signin_success" class="heading"><span class="number">8.2、</span>サインイン成功</a></h2>


<p> サインイン失敗をテストできるようにしたので、次は実際にユーザをサインインさせましょう。この節で必要なRubyのプログラミングは、本書の中ではこれまでで最も難易度が高くなっています。どうか最後まであきらめずにがんばってください。ここからの力仕事に備えておきましょう。幸い、はじめの一歩は簡単です。Sessionsコントローラの<code>create</code>アクションはすぐできあがります。残念ながら、少々ズルもしています。</p>

<p>サインインの実装 (<a class="ref" href="#code-correct_signin_failure">リスト8.12</a>) はシンプルです。サインインに成功すると、<code>sign_in</code>関数を使用して実際にユーザーをサインインさせ、プロファイルページにリダイレクトします (<a class="ref" href="#code-sign_in_success_not_yet_working">リスト8.13</a>)。なぜこれがズルなのかというと、何と<code>sign_in</code>はこの時点では存在していないのです。この節の残りは、この関数を完成させることに費やされます。</p>

<div class="label" id="code-sign_in_success_not_yet_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.13</span> <span class="description">Sessionsコントローラの<code>create</code>アクションが完成したところ (まだ動きません)。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-remember_me"></div>


<h3><a id="sec-8_2_1" href="#sec-remember_me" class="heading"><span class="number">8.2.1</span>[このアカウント設定を保存する]</a></h3>


<p>これよりサインインモデルの実装を開始します。具体的には、サインイン状態を「永続化」し、ユーザが明示的にサインアウトしたときにのみセッションを削除します。サインイン関数そのものは伝統的なMVC (model-view-controller)) に帰着します。特に、いくつかのサインイン関数についてはコントローラとビューのどちらからも使用できるようにする必要があります。<a class="ref" href="#sec-back_to_the_title_helper">4.2.5</a>を思い出してみてください。Rubyには、いくつもの関数をパッケージ化し、さまざまな場所でインクルードできるようにする<em>モジュール</em>という機能が提供されています。これを認証機能の実装に使用します。認証のためにまったく新しいモジュールを作ることも可能ですが、Sessionsコントローラには既に<code>SessionsHelper</code>というモジュールが備わっています。さらに、ヘルパーはRailsのビューに自動的にインクルードされるので、Applicationコントローラにこのモジュールをインクルードするだけで、Sessionsヘルパー機能をコントローラ内で使用できるようになります (<a class="ref" href="#code-sessions_helper_include">リスト8.14</a>)。(よい機会なので、<a class="ref" href="#code-sessions_helper_include">リスト8.14</a>にはクロスサイトリクエストフォージェリ (CSRF) 脆弱性の対策も含めてあります。このコードは、<a class="ref" href="#sec-signing_out">8.2.6</a>で<code>sign_out</code>メソッドを定義すれば動くようになります。)</p>

<div class="label" id="code-sessions_helper_include"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.14</span> <span class="description">SessionsヘルパーモジュールをApplicationコントローラにインクルードする。</span><br /><span class="description"> <code>app/controllers/application_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="ss">ActionController::Base</span>
  <span class="n">protect_from_forgery</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>

  <span class="c1"># CSRF脆弱性の対策のために、サインアウトさせる。</span>
  <span class="k">def</span> <span class="nf">handle_unverified_request</span>
    <span class="n">sign_out</span>
    <span class="k">super</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>デフォルトでは、すべてのヘルパーはビューで使用できますが、コントローラでは使用できません。Sessionsヘルパーはビューとコントローラの両方でメソッドが必要となるので、コントローラでは上のように明示的にインクルードする必要があります。</p>

<p>HTTPは<a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state"><em>ステートレスなプロトコル</em></a>であり、そのままでは状態が保存されないので、Webアプリケーションのサインインは、ページからページの移動を追跡するという方法で実装する必要があります。ユーザのサインイン状態を保持するひとつの方法は、伝統的なRailsセッション (特殊な<code>session</code>関数を使用) を使って、ユーザIDに等しい「<em>記憶トークン (remember token)</em>」を保持することです。</p>

<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>


<p>この<code>session</code>オブジェクトは、ユーザーidをcookiesに保持することで、ページ移動後にもユーザーidを参照できるようにしています。cookiesはブラウザが閉じられると無効になります。アプリケーションは、ページごとに以下の呼び出しを行います。</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>これだけで、ユーザーを取り出すことができます。Railsでは、セッションがセキュアになるように扱っていますので、悪意のあるユーザーがidをなりすまそうとしても、Railsはセッションごとに生成される特別の<em>セッションid</em>によって不一致を検出します。</p>

<p>私たちのアプリケーション設計では、<em>永続的な</em>セッションを採用します。つまり、ブラウザを閉じた後にもサインイン状態を保持するということであり、サインインしたユーザに対して何らかの<em>恒久的な</em>識別子を使用する必要があります。これを実現するために、ユーザーごとに一意かつ安全な記憶トークンを生成し、ブラウザを閉じても無効にならない<em>恒久的な</em>cookiesとして登録します。</p>

<p>記憶トークンはユーザーに関連付けられる必要があります。また、今後使用するときのために保持しておく必要もあります。そこで、<a class="ref" href="#fig-user_model_remember_token">図8.8</a>に示すUserモデルの属性に記憶トークンの保存場所を追加しましょう。</p>

<div class="label" id="fig-user_model_remember_token"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_remember_token_31.png" alt="user_model_remember_token_31" /></span></div><div class="caption"><span class="header">図8.8</span><span class="description"><code>remember_token</code>属性を追加したUserモデル。</span></div></div>


<p>最初に、Userモデルのspecに若干の追加を行います (<a class="ref" href="#code-user_responds_to_remember_token">リスト8.15</a>)。</p>

<div class="label" id="code-user_responds_to_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.15</span> <span class="description">記憶トークン用の最初のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>  
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>コマンドラインで以下のように記憶トークンを生成することで、上のテストがパスするようになります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_remember_token_to_users
</pre></div>
</div>


<p>次に、上で生成されたマイグレーションに<a class="ref" href="#code-add_remember_token_to_users">リスト8.16</a>のコードを記入します。ユーザーを記憶トークンで検索できるように、インデックス (<a class="ref" href="#sidebar-database_indices">コラム 6.2</a>) を<code>remember_token</code>カラムに追加していることにご注目ください。</p>

<div class="label" id="code-add_remember_token_to_users"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.16</span> <span class="description"><code>remember_token</code>を<code>users</code>テーブルに追加したマイグレーション。</span><br /><span class="description"> <code>db/migrate/[timestamp]_add_remember_token_to_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddRememberTokenToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次に、いつものように開発データベースとテストデータベースを更新します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>この時点で、Userモデルのspecはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<p>ここで、記憶トークンに何を使用するかを決める必要があります。有力な候補としてさまざまなものが考えられますが、基本的には長くてランダムな文字列であればどんなものでも良いでしょう。原理的には、ユーザーのパスワードは安全に暗号化されているのでユーザーの<code>password_hash</code>属性を使用することもできます。しかし、たとえ暗号化されていても、ユーザーのパスワードを不必要に攻撃者に見えるようにしてしまうのは望ましいことではありません。そこで、用心に用心を重ね、Ruby標準ライブラリの<code>SecureRandom</code>モジュールにある<code>urlsafe_base64</code>メソッドを使用して記憶トークンをカスタム生成することにしましょう。このメソッドは、URIとして (つまりcookiesとしても) 安全に使用できる<a href="http://en.wikipedia.org/wiki/Base64">Base64</a>文字列を作成します<sup class="footnote" id="fnref-8_3"><a href="#fn-8_3">3</a></sup>。本書の執筆時点では、<code>SecureRandom.urlsafe_base64</code>はA–Z、a–z、0–9、“-”、“_”のいずれかの文字 (64種類) からなる長さ16のランダムな文字列を返します。生成された2つの記憶トークンが偶然一致する確率は、10のマイナス29乗 (64のマイナス16乗、2のマイナス96乗) にほぼ等しく、トークンが衝突することはまずありません。</p>

<p>記憶トークンの生成には<em>コールバック</em>を使用することにします。このテクニックは、<a class="ref" href="#sec-uniqueness_validation">6.2.5</a>でemailの一意性の文脈で紹介しました。そのときと同様に<code>before_save</code>コールバックを使用しますが、今回は <code>remember_token</code>属性の生成を、ユーザーが保存される直前に行います。もうひとつの方法として、before_saveコールバックの代わりに<code>before_create</code>コールバック<sup class="footnote" id="fnref-8_4"><a href="#fn-8_4">4</a></sup>を使用するという方法も考えられます。このコールバックは、ユーザーが最初に作成された時点で記憶トークンを<em>一度だけ</em>設定します。このコールバックは正常に動作するのですが、<a href="http://en.wikipedia.org/wiki/Session_hijacking">ハイジャックされたセッション</a>も期限切れにならずにずっと残ってしまうというセキュリティ上の問題が生じます (セッションハイジャックとは、記憶トークンをコピーしてそのユーザーとして不正にサインインすることです)。対照的に、<code>before_save</code>コールバックではユーザーが自分の情報を更新するたびに記憶トークンも更新されることが保証されます (<a class="ref" href="#sec-successful_edits">9.1.3</a>) ので、その分セキュリティ上有利です。(セッションハイジャックは、セキュリティ上の注意を呼びかけるためにこれを実演する<a href="http://codebutler.com/firesheep">Firesheep</a>アプリケーションによって広く知られるようになりました。Firesheepを使用すると、公共Wi-Fiネットワーク経由で接続したときに多くの有名Webサイトの記憶トークンが丸見えになっていることがわかります。この問題を解決するには、<a class="ref" href="#sec-deploying_to_production_with_ssl">7.4.4</a>で説明したようにWebサイト全体をSSLで暗号化することです。ただし、サインインしているコンピュータの物理アドレス (MACアドレス) を攻撃者が知っていれば記憶トークンを入手できてしまうので、ときどき記憶トークンを変更する方法も依然としてセキュリティ上有効です。)</p>

<p>記憶トークンをテストするために、最初にテストユーザーを保存し、次にユーザーの<code>remember_token</code>属性が空欄でないことを確認します。これにより、必要が生じたときにランダム文字列を変更するのに十分な柔軟性が得られます。このテストを<a class="ref" href="#code-remember_token_should_not_be_blank">リスト8.17</a>に示します。</p>

<div class="label" id="code-remember_token_should_not_be_blank"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.17</span> <span class="description">記憶トークンが有効である (空欄のない) ことをテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;remember token&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上の<a class="ref" href="#code-remember_token_should_not_be_blank">リスト8.17</a>で導入した<code>its</code>メソッドは、<code>it</code>と似ていますが、itが指すテストのsubject (ここでは@user) そのものではなく、引数として与えられたその属性 (この場合は:remember_token) に対してテストを行うときに使用します。</p>

<div class="code"><div class="highlight"><pre><span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>つまり、上のコードは以下と等価です。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">remember_token</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>このアプリケーションコードでは、新しい要素をいくつか導入します。最初に、記憶トークンを作成するために以下のようにコールバックメソッドを追加します。</p>

<div class="code"><div class="highlight"><pre><span class="n">before_save</span> <span class="ss">:create_remember_token</span>
</pre></div>
</div>


<p>上のコードにより、Railsは<code>create_remember_token</code>というメソッドを探索し、ユーザーを保存する前にこのメソッドを実行しておいてくれます。次に、このメソッド自身はUserモデルの内部でしか使用しないので、外部のユーザーがアクセスできるようにする必要はありません。Rubyでは、メソッド定義に以下のように<code>private</code>キーワードを与えることでこれを行います。</p>

<div class="code"><div class="highlight"><pre><span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_remember_token</span>
    <span class="c1"># トークンを作成する。</span>
  <span class="k">end</span>
</pre></div>
</div>


<p><code>private</code>キーワード以降で定義されたメソッドはすべて隠蔽されます。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">create_remember_token</span>
</pre></div>
</div>


<p>このため、上をコンソールで実行すると<code>NoMethodError</code>例外が発生します。</p>

<p>最後に、<code>create_remember_token</code>メソッドは、ユーザーの属性のひとつに「<em>要素代入 (assignment)</em>」する必要があります。この文脈から、<code>remember_token</code>の前に<code>self</code>キーワードを追加する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create_remember_token</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
<span class="k">end</span>
</pre></div>
</div>


<p>(<em>注意</em>: Ruby 1.8.7を使用している場合は、SecureRandomの代わりに<code>SecureRandom.hex</code>を使用する必要があります) 。<code>self</code>キーワードを使用しないと、Active Recordがデータベースのカラムを元にして属性を合成するので、上の要素代入によって<code>remember_token</code>という名前の<em>ローカル</em>変数が作成されてしまい、期待どおりの結果になりません。<code>self</code>キーワードを与えることで、要素代入は正しくそのユーザーの<code>remember_token</code>属性を設定するようになり、ユーザーが保存されるときに他の属性と一緒にこの属性もデータベースに保存されます。</p>

<p>以上の実装をまとめたUserモデルを<a class="ref" href="#code-before_save_create_remember_token">リスト8.18</a>に示します。</p>

<div class="label" id="code-before_save_create_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.18</span> <span class="description"><code>before_save</code>コールバックを使用して <code>remember_token</code>属性を作成する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>

  <span class="n">before_save</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">before_save</span> <span class="ss">:create_remember_token</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">create_remember_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ちなみに、<code>private</code>キーワード以降のコードは、強調のため<code>create_remember_token</code>のインデントを1段深くしてあります。</p>

<p><code>SecureRandom.urlsafe_base64</code>は決して空欄には<em>ならなくなった</em>ので、Userモデルのテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<div class="label" id="sec-a_working_sign_in_method"></div>


<h3><a id="sec-8_2_2" href="#sec-a_working_sign_in_method" class="heading"><span class="number">8.2.2</span>正しい<tt>sign_in</tt>メソッド</a></h3>


<p>いよいよ、最初のサインイン要素である<code>sign_in</code>関数自身の実装に取りかかりましょう。既に述べたように、これから作る認証メソッドは、記憶トークンをブラウザのcookiesに保存し、ユーザーが別のページに移動する (<a class="ref" href="#sec-current_user">8.2.3</a>で実装予定) ときにそのトークンを使用してデータベース内のユーザーのレコードを見つけます。そこで、<a class="ref" href="#code-sign_in_function">リスト8.19</a>では<code>cookies</code>ハッシュ と<code>current_user</code>という2つの新しいアイディアを導入しています。</p>

<div class="label" id="code-sign_in_function"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.19</span> <span class="description">完全だがまだ動作しない<code>sign_in</code>関数。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-sign_in_function">リスト8.19</a>では、Railsが提供する<code>cookies</code>ユーティリティを導入しています。<code>cookies</code>はハッシュであるかのように扱うことができます。cookiesの各要素は、それ自体が2つの要素 (<code>value</code>とオプションの<code>expires</code>日時) のハッシュになっています。たとえば以下のように、cookiesに20年後に期限切れになる記憶トークンに等しい値を保存することで、ユーザーのサインインを実装できます。</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value:</span>   <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span><span class="p">,</span>
                             <span class="ss">expires:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div>
</div>


<p>(上のコードではRailsの便利なtimeヘルパーを使用しています。<a class="ref" href="#sidebar-time_helpers">コラム 8.1</a>を参照してください。)</p>

<div class="label" id="sidebar-time_helpers"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 8.1</span></span><span class="title"><span class="description">cookiesは今から20年後に切れる (<tt>20.years.from_now</tt>)</span></span>
<p>Rubyでは、組み込みクラスを含む<em>あらゆる</em>クラスにメソッドを追加できることを<a class="ref" href="#sec-a_class_of_our_own">4.4.2</a>で学んだことを思い出してください。あのときは、<tt>palindrome?</tt>メソッドを<tt>String</tt>クラスに追加しました (ついでに<tt>&quot;deified&quot;</tt>も回文になっていることを発見しました)。また、Railsが実は<tt>blank?</tt>メソッドを<tt>Object</tt>クラスに追加していることも判明しました (これにより、<tt>&quot;&quot;.blank?</tt>、<tt>&quot; &quot;.blank?</tt>、<tt>nil.blank?</tt>はいずれも<tt>true</tt>になります)。<a class="ref" href="#code-sign_in_function">リスト8.19</a>のコードでは、cookiesが20年後に期限切れになる (<tt>20.years.from_now</tt>) ように指定していますが、これはRailsの<em>timeヘルパー</em>を使用した格好の例題になります。timeヘルパーはRailsによって、数値関連の基底クラスである<tt>Fixnum</tt>クラスに追加されます。</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Sun, 13 Mar 2011 03:38:55 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Sat, 02 Jan 2010 03:39:14 UTC +00:00</pre>


<p>Railsは以下のようなヘルパーも追加しています。</p>

<pre class="verbatim">  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>


<p>上のヘルパーは、ファイルのアップロードに<tt>5.megabytes</tt>などと制限を与えるのに便利です。</p>

<p>メソッドを組み込みクラスに追加できる柔軟性の高さのおかげで、純粋なRubyをきわめて自然に拡張することができます (もちろん注意して使う必要はありますが)。実際、Railsのエレガントな仕様の多くは、背後にあるRubyの高い拡張性によって実現されているのです。</p>
</div>


<p>上のように20年で期限切れになるcookies設定はよく使われるようになり、今ではRailsにも特殊な<code>permanent</code>という専用のメソッドが追加されたほどです。このメソッドを使用すると、コードは以下のようにシンプルになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</pre></div>
</div>


<p>上のコードでは、<code>permanent</code>メソッドによって自動的に期限が<code>20.years.from_now</code>に設定されます。</p>

<p>cookiesを設定後、移動先のページで以下のようなコードを使用してユーザーを取り出すことができます。</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>もちろん、この<code>cookies</code>は<em>本物の</em>ハッシュではなく、実際には<code>cookies</code>に割り当てを行うとブラウザ上のテキストの断片を<em>保存</em>しているだけです。そうしたアプリケーションの実装の詳細を忘れさせてくれるところにRailsの美しさの一端が垣間見えます。</p>

<div class="label" id="sec-current_user"></div>


<h3><a id="sec-8_2_3" href="#sec-current_user" class="heading"><span class="number">8.2.3</span>現在のユーザー</a></h3>


<p>後で使うために記憶トークンをcookiesに保存する方法の説明が終わりましたので、今度は移動先のページでユーザーを取り出す方法について学びましょう。<code>sign_in</code>関数のコードをもういちどよく見てみてください。</p>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>関数の2行目にある以下のコードにご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>この行の目的は、コントローラからもビューからもアクセスできる<code>current_user</code>を作成することです。これにより、以下のような構文を使用できるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>以下も使用できるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div>
</div>


<p><a class="ref" href="#code-before_save_create_remember_token">リスト8.18</a>のときに説明したのと同じ理由で、ここにも<code>self</code>が必要です。<code>self</code>がないと、Rubyは単に<code>current_user</code>というローカル変数を作成してしまいます。</p>

<p><code>current_user</code>のコードを書く上で、以下の行については注意が必要です。</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>上は「<em>要素代入 (assignment)</em>」であることにご注意ください。このcurrent_user=は別途定義が必要です。<a class="ref" href="#code-current_user_equals">リスト8.20</a>に示したように、Rubyにはこのような要素代入関数を定義する特殊な文法があります。</p>

<div class="label" id="code-current_user_equals"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.20</span> <span class="description"><code>current_user</code>への要素代入を定義する。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードで使用されている特殊な文法は混乱しやすいのでご注意ください。普通のプログラミング言語では、定義するメソッドの名前に等号を使用することはできませんが、Rubyではメソッド名末尾の等号には特殊な意味があり、上のコードは<code>current_user</code>への要素代入を扱うように設計された<code>current_user=</code>というメソッドを単に定義します。つまり、以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div>
</div>


<p>自動的に以下のコードに置き換えられます。</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>そして最終的に<code>current_user=</code>というメソッドが呼び出されます。その引数は要素代入の右側にひとつ置かれます (ここではサインインするユーザー)。この一行メソッドは、単に<code>@current_user</code>インスタンス変数を設定し、後に使用するためにユーザーを効率よく保存します。</p>

<p>通常のRubyでは、2番目のメソッドである<code>current_user</code>を定義することができます。<a class="ref" href="#code-current_user_wrong">リスト8.21</a>に示したように、このメソッドは<code>@current_user</code>の値を返すようになっています。</p>

<div class="label" id="code-current_user_wrong"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.21</span> <span class="description">魅力的だが役に立たない<code>current_user</code>の定義。</span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span>     <span class="c1"># 役に立たない。</span><span class="c1">この行は使用しないこと。</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>もしかすると、これを使用して<a class="ref" href="#sec-a_user_class">4.4.5</a>の<code>attr_accessor</code>を効率よく置き換えることができるのではないでしょうか<sup class="footnote" id="fnref-8_5"><a href="#fn-8_5">5</a></sup>。それをしないのは、このコードを使用すると今までの苦労が台無しになってしまうからです。<a class="ref" href="#code-current_user_wrong">リスト8.21</a>のコードを使用すると、ユーザーが別のページに移動した瞬間にユーザーのサインイン情報が<em>スカッと</em>消滅してしまいます。セッションは終了し、ユーザーは自動的にサインアウトしてしまいます。この問題を回避するには、<a class="ref" href="#code-current_user_working">リスト8.22</a>に示したように、<a class="ref" href="#code-sign_in_function">リスト8.19</a>のコードで作成した記憶トークンに対応するユーザーを検索します。</p>

<div class="label" id="code-current_user_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.22</span> <span class="description"><code>remember_token</code>を使用して現在のユーザーを検索する。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-current_user_working">リスト8.22</a>では、Rubyでは定番の (しかし最初はまごつきやすい) <code>||=</code> (“or equals”) 代入演算子を使用しています (<a class="ref" href="#sidebar-or_equals">コラム 8.2</a>)。この代入演算子は、<code>@current_user</code>が未定義の場合にのみ、<code>@current_user</code>インスタンス変数に記憶トークンを設定します<sup class="footnote" id="fnref-8_6"><a href="#fn-8_6">6</a></sup>。つまり、以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>あるユーザーに対して<code>current_user</code>が初めて呼び出される場合は<code>find_by_remember_token</code>メソッドを呼び出しますが、以後の呼び出しではデータベースにアクセスせずに<code>@current_user</code>を返します<sup class="footnote" id="fnref-8_7"><a href="#fn-8_7">7</a></sup>。このコードは、ひとつのユーザーリクエストに対して<code>current_user</code>が何度も使用される場合にのみ有用です。いずれの場合も、ユーザーがWebサイトにアクセスすると<code>find_by_remember_token</code>は最低1回は呼び出されます。</p>

<div class="label" id="sidebar-or_equals"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 8.2</span></span><span class="title"><span class="description"></span></span><span class="title"><span class="description"><tt>||=</tt>とは一体何か</span></span>
<p><tt>||=</tt>という記法は非常にRuby的であり、Rubyという言語を強く特徴づけるものです。Rubyプログラミングの達人になりたいのであれば、この記法を習得することが重要です。<em>or equals</em>という概念は一見神妙不可思議に見えますが、他のものになぞらえて考えることで理解できます。</p>

<p>最初は、現在定義されている変数を変更するというありふれたコードについて説明します。多くのコンピュータプログラムでは、以下のようにして変数の値を1つ増やすことができます。</p>

<pre class="verbatim">  x = x + 1</pre>


<p>そして、Ruby (C、C++、Perl、Python、Java) などの多くのプログラミング言語では、以下のような短縮形を使用して上の演算を行うことができます。</p>

<pre class="verbatim">  x += 1</pre>


<p>他の演算子についても同様の短縮形が利用できます。</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 7
  =&gt; -1</pre>


<p>いずれの場合も、<tt>●</tt>という演算子があるときの「<tt>x = x ● y</tt>」と「<tt>x ●= y</tt>」の動作は同じです。</p>

<p>Rubyでは、「変数の値が<tt>nil</tt>なら変数に代入するが、nilでなければ代入しない (変数の値を変えない)」という操作が非常によく使われます。<a class="ref" href="#sec-objects_and_message_passing">4.2.3</a>で説明した<em>or</em>演算子<tt>||</tt>を使用すれば、以下のように書くことができます。</p>

<pre class="verbatim">  &gt;&gt; @user
  =&gt; nil
  &gt;&gt; @user = @user || &quot;the user&quot;
  =&gt; &quot;the user&quot;
  &gt;&gt; @user = @user || &quot;another user&quot;
  =&gt; &quot;the user&quot;</pre>


<p><tt>nil</tt>の論理値は偽 (false) です。初めて代入するときは「<tt>nil || &quot;the user&quot;</tt>」となり、これは「<tt>&quot;the user&quot;</tt>」と評価されます。同様に、2度目の代入では「<tt>&quot;the user&quot; || &quot;another user&quot;</tt>」となり、これも「<tt>&quot;the user&quot;</tt>」と評価されます。あらゆる文字列の論理値は真 (<tt>true</tt>) なので、 <tt>||</tt>を使用する一連の式は、いずれも1番目の式が評価された時点で終了します (なお、<tt>||</tt>式を左から右に評価し、最初の左の値がtrueであればその時点で終了するというやり方を<em>短絡評価 (short-circuit evaluation)</em>と呼びます)。</p>

<p>上述した多くの演算子をコンソールセッション上で実行して比較してみると、<tt>@user = @user || value</tt>は「<tt>x = x O y</tt>」のパターンに該当し、<tt>O</tt>が<tt>||</tt>に置き換わっただけのものであることがわかります。ということは、この演算は以下と同じであることが推測できます。</p>

<pre class="verbatim">  &gt;&gt; @user ||= &quot;the user&quot;
  =&gt; &quot;the user&quot;</pre>


<p>ご覧あれ。</p>
</div>




<div class="label" id="sec-changing_the_layout_links"></div>


<h3><a id="sec-8_2_4" href="#sec-changing_the_layout_links" class="heading"><span class="number">8.2.4</span>レイアウトリンクを変更する</a></h3>


<p>サインイン/サインアウトが動作するようになり、実用的なアプリケーションらしくなってきました。今度は、サインインの状態に合わせてレイアウト上のリンクが変わるようにしましょう。特に、<a class="ref" href="#fig-signin_success_mockup">図8.3</a>のモックアップで示したように、ユーザーがサインインしているときとサインアウトしているときでリンクを変更し、すべてのユーザーを表示するリンクとユーザー設定用のリンクも追加し (<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>で完成する予定)、さらに現在のユーザーのプロファイルのリンクも追加します。これらを実装することで、<a class="ref" href="#code-signin_success_tests">リスト8.6</a>のテストがパスするようになります。つまり、本章開始以来初めてテストスイート全体が緑色 (成功) になるということです。</p>

<p>サイトレイアウトのリンクを変更するには、埋め込みRubyの内側でif-else分岐構造を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  # サインインしているユーザー用のリンク
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  #サインインしていないユーザー用のリンク
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>この種のコードでは、<code>signed_in?</code>論理値が必要になりますので、これから作成しましょう。</p>

<p>ユーザーがサインインしている状態は、セッションに現在のユーザーがいる (<code>current_user</code>が<code>nil</code>でない) ことで表されます。これを表現するには否定の演算子が必要なので、<code>!</code> (&quot;bang&quot; と読みます) を使用します。<a class="ref" href="#code-signed_in_p">リスト8.23</a>に示すとおり、現在の文脈では<code>current_user</code>が<code>nil</code>で<em>ない</em>場合にユーザーがサインインしています。</p>

<div class="label" id="code-signed_in_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.23</span> <span class="description"><code>signed_in?</code></span><span class="description">ヘルパーメソッド。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>signed_in?</code>メソッドを手作りしてあるので、レイアウトのリンクはすぐに作成できます。なお、新しく作るリンクは4つですが、そのうち以下の2つのリンクは未実装です (<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>で完成の予定)。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>サインアウトのリンクには、<a class="ref" href="#code-sessions_resource">リスト8.2</a>で定義したサインアウトのパスを使用します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>(上のコードでは、サインアウトのリンクがハッシュ引数を渡していることにご注目ください。このハッシュ引数は、HTTPの<tt>DELETE</tt>リクエストを使用して送信される必要があることを示しています<sup class="footnote" id="fnref-8_8"><a href="#fn-8_8">8</a></sup>)。最後に、以下のようにプロファイルへのリンクも追加します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>なお、上のコードは以下のように書くこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Railsでは、このユーザーへの直接リンクが許されるので、この場合<code>current_user</code>は<code>user_path(current_user)</code>に自動的に変換されます。</p>

<p>新しいリンクをレイアウトに追加するときに、Bootstrapの機能を使用してドロップダウンメニューを実現しましょう。詳細については「<a href="http://twitter.github.com/bootstrap/components.html">Bootstrapコンポーネント</a> (英語)」を参照してください。完全なコードを<a class="ref" href="#code-layout_signin_signout_links">リスト8.24</a>に示します。このコードでは、Bootstrapのドロップダウンメニューに関連するCSSのidとクラスが与えられていることにご注目ください。</p>

<div class="label" id="code-layout_signin_signout_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.24</span> <span class="description">サインインしているユーザー用にリンクを変更する。</span><br /><span class="description"> <code>app/views/layouts/_header.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>ドロップダウンメニューを実現するには、BootstrapのJavaScriptライブラリが必要です。このライブラリは、Railsのアセットパイプラインを使用してインクルードすることができます。そのためには、<a class="ref" href="#code-bootstrap_js">リスト8.25</a>に示すようにアプリケーションのJavaScriptファイルを編集します。</p>

<div class="label" id="code-bootstrap_js"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.25</span> <span class="description">Bootstrap JavaScriptライブラリを<code>application.js</code>に追加する。</span><br /><span class="description"> <code>app/assets/javascripts/application.js</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="c1">//= require bootstrap</span>
<span class="c1">//= require_tree .</span>
</pre></div>
</div></div>


<p>上のコードは、Sprocketsライブラリを使用してBootstrap JavaScriptをインクルードします。<a class="ref" href="#sec-custom_css">5.1.2</a>で<tt>bootstrap-sass</tt> gemを導入してあるので、これでBootstrapが利用できるようになります。</p>

<p><a class="ref" href="#code-layout_signin_signout_links">リスト8.24</a>のコードを使用することで、すべてのテストにパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>ただし残念なことに、ブラウザで実際にアプリケーションを動かしてみると、まだ正常に動作していないことがわかります。これは、ユーザーのパスワードを保存する機能 (“remember me”) ではユーザーが記憶トークンを持っている必要がありますが、現在のユーザーには記憶トークンがないためです。<a class="ref" href="#sec-the_first_signup">7.4.3</a>で最初のユーザーを作成したのは、記憶トークンを設定するコールバックを実装するよりもずっと前だったことを思い出してください。これを修正するには、各ユーザーを保存して<code>before_save</code>コールバックが呼び出されるようにします。このコールバックは<a class="ref" href="#code-before_save_create_remember_token">リスト8.18</a>で定義したもので、副作用として記憶トークンを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">remember_token</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="ss">validate:</span> <span class="kp">false</span><span class="p">)</span> <span class="p">}</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">remember_token</span>
<span class="go">=&gt; &quot;Im9P0kWtZvD0RdyiK9UHtg&quot;</span>
</pre></div>
</div>


<p>なお、上ではユーザー登録フォームで試しに何人もユーザーを登録していた方向けに、念のためすべてのユーザーを列挙しています。そのコマンドでは、オプションを<code>save</code>メソッドに渡していることにご注目ください。既に述べたように、パスワードとパスワードの確認を含めなかったので<code>save</code>メソッド自身は動作しません。実際のWebサイトではユーザーのパスワードを知ることはできませんが、それでも (メンテナンス目的などで) ユーザーを保存する必要が生じることがあります。この問題を解決するためには、<code>validate: false</code>を渡し、Active Recordに検証をスキップさせます (Rails APIの「<a href="http://api.rubyonrails.org/v3.2.0/classes/ActiveRecord/Persistence.html#method-i-save"><tt>save</tt></a>」を参照)。</p>

<p>以上の変更を行ったことで、<a class="ref" href="#fig-profile_with_signout_link">図8.9</a>に示したように、<a class="ref" href="#code-layout_signin_signout_links">リスト8.24</a>で定義したドロップダウンメニューがサインインしたユーザーに表示されるようになりました。</p>

<div class="label" id="fig-profile_with_signout_link"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_with_signout_link_bootstrap.png" alt="profile_with_signout_link_bootstrap" /></span></div><div class="caption"><span class="header">図8.9</span><span class="description">サインインしたユーザーにリンクとドロップダウンが表示されるようになった。<a href="http://railstutorial.org/images/figures/profile_with_signout_link_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この時点で、ブラウザで実際にサインインできることを確認し、続いてブラウザを閉じてから再度サンプルアプリケーションを表示するとサインインしたままになっていることを確認してください。その気になれば、ブラウザのcookiesをブラウザで調べて結果を直接確認することもできます (<a class="ref" href="#fig-cookie_in_browser">図8.10</a>)。</p>

<div class="label" id="fig-cookie_in_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/cookie_in_browser.png" alt="cookie_in_browser" /></span></div><div class="caption"><span class="header">図8.10</span><span class="description">ローカルのブラウザで記憶トークンのcookiesを表示する。<a href="http://railstutorial.org/images/figures/cookie_in_browser-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-signin_upon_signup"></div>


<h3><a id="sec-8_2_5" href="#sec-signin_upon_signup" class="heading"><span class="number">8.2.5</span>ユーザー登録と同時にサインインする</a></h3>


<p>認証機能の基本的な部分はできましたが、ユーザーが登録を行った後もそのユーザーがデフォルトではサインインしておらず、このままではユーザーが混乱する可能性があります。そこで、サインアウトの機能を実装する前にその部分をもう少し作り込みましょう。最初に、認証のテストを追加します (<a class="ref" href="#code-sign_up_sign_in">リスト8.26</a>)。ここには、<a class="ref" href="#sec-signup_exercises">7.6</a>の<a class="ref" href="#code-after_save_tests">リスト7.32</a>でも使った “after saving the user” <code>describe</code>ブロックが含まれています。ここに関連する演習を行なっていなかった方は、この時点で追加する必要があります。</p>

<div class="label" id="code-sign_up_sign_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.26</span> <span class="description">新規ユーザー登録後にユーザーがサインインしたことをテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after saving the user&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、ユーザー登録後にサインアップされていることを確認するために、サインアウト用のリンクが表示されているかどうかをテストしています。</p>

<p><a class="ref" href="#sec-signin_success">8.2</a>で<code>sign_in</code>メソッドを作成してあるので、ユーザーをデータベースに保存した直後に<code>sign_in @user</code>を追加するだけで、ユーザーが実際にサインインしてテストにパスするようになります (<a class="ref" href="#code-signin_upon_signup">リスト8.27</a>)。</p>

<div class="label" id="code-signin_upon_signup"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.27</span> <span class="description">ユーザー登録後にサインアップする。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-signing_out"></div>


<h3><a id="sec-8_2_6" href="#sec-signing_out" class="heading"><span class="number">8.2.6</span>サインアウトする</a></h3>


<p><a class="ref" href="#sec-signin_failure">8.1</a>で説明したとおり、このアプリケーションで使用する認証モデルでは、ユーザーは明示的にサインアウトするまでサインインしたままになります。この節では、そのサインアウト機能を追加します。</p>

<p>Sessionsコントローラのアクションは、これまでもRESTful慣例に従ってサインインページには<code>new</code>を使用し、サインインの完了には<code>create</code>を使用しました。今回も同様に慣例に従い、セッションの削除 (サインアウト) には<code>destroy</code>を使用します。このことをテストするには、[Sign out] リンクをクリックして、そこにサインイン用のリンクが再び現れるかどうかを確認します (<a class="ref" href="#code-signout_test">リスト8.28</a>)。</p>

<div class="label" id="code-signout_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.28</span> <span class="description">ユーザーのサインアウトをテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;followed by signout&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Sign out&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>サインインが<code>sign_in</code>関数に依存しているのと同様に、サインアウトでも<code>sign_out</code>関数を単に実行します (<a class="ref" href="#code-destroy_session">リスト8.29</a>)。</p>

<div class="label" id="code-destroy_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.29</span> <span class="description">セッションを削除する (ユーザーのサインアウト)。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">sign_out</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>他の認証用機能と同様に、<code>sign_out</code>もSessionsヘルパーモジュールの中に置きます。実装は極めてシンプルです。現在のユーザーを<code>nil</code>にし、<code>delete</code>メソッドを使用して、cookiesにあるセッションの記憶トークンを削除します (<a class="ref" href="#code-sign_out_method">リスト8.30</a>)。(直後に<code>destroy</code>アクションにリダイレクトされるので、現在のユーザーを<code>nil</code>にする必要は必ずしもありません。ただし、リダイレクトなしで<code>sign_out</code>を使用したい状況が今後発生するかもしれないので、そのときに役立つでしょう。)</p>

<div class="label" id="code-sign_out_method"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.30</span> <span class="description">Sessionsヘルパーモジュールの<code>sign_out</code>メソッド。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">sign_out</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これでユーザー登録/サインイン/サインアウトが出揃いました。テストスイートはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/ 
</pre></div>
</div>


<p>本書のテストスイートは認証システムをほぼカバーしていますが、すべてをカバーしているわけではありません。この点をご了承ください。たとえば、[このアカウント設定を保存する] (remember me) のcookiesが有効になっているか、その後も保持されているかどうかのテストは含まれていません。このテストは作成可能ですが、著者の経験上、cookiesの値を直接調べる方法はRailsの実装に左右されやすい傾向があり、次のバージョンのRailsではまた変わるかもしれません。その場合、アプリケーションコードは正常に動作してもテストが正常に動作しなくなります。このような理由で、本書のテストコードでは、コアとなるアプリケーションコードをテストする際に高度な機能 (ユーザーがサインインできること、ページ移動後もサインインしていること、サインアウトできること) に重点を置き、重要性の低い機能は必ずしも含んでいません。</p>

<div class="label" id="sec-cucumber"></div>


<h2><a id="sec-8_3" href="#sec-cucumber" class="heading"><span class="number">8.3</span>Cucumberの紹介 (オプション)</a></h2>


<p>サンプルアプリケーションの認証システムの基礎部分が無事完成したので、この機会に<a href="http://cukes.info">Cucumber</a>を使用したサインインのテスト方法をご紹介します。Cucumberは振舞駆動開発用のツールとして有名で、Rubyコミュニティに多くの愛用者がいます。この節の内容は必須ではありませんので、スキップしても問題ありません。</p>

<p>Cucumberを使用すると、アプリケーションの振る舞いをテキストベースの「<em>ストーリー</em>」で定義することができます。多くのRailsプログラマーは、Cucumberは顧客と共同作業するときに便利であることを知っています。Cucumberのストーリーは、専門知識のない人でも読むことができ、ストーリーを顧客と共有したり、場合によっては顧客がストーリーを作成することすらできるためです。もちろん、テスティングのフレームワークが純粋なRubyでないという点は残念でもあり、著者にとってはテキストベースのストーリーはいささか冗長な面もあると思われます。それでもCucumberはRubyのテスティングツールキットとして確固たる地位を占めており、著者としては低レベルの実装を気にすることなく高度な振る舞いを記述できる点が特に気に入っています。</p>

<p>本書ではRSpecとCapybaraをテスティングのメインに据えているので、この節のCucumberに関する説明は完全ではなく、表面的で物足りないことでしょう。この節の目的はCucumberのおいしさ (間違いなくシャキシャキして汁気たっぷりです) を知ってもらうための、いわば試食です。もし気に入っていただけたら、テスティングツールに関する完結した書籍がいくつもあります。(おすすめは「<a href="http://www.amazon.com/gp/product/1934356379"><em>The RSpec Book</em></a> 」(David Chelimsky著)、「 <a href="http://www.amazon.com/gp/product/1935182277"><em>Rails 3 in Action</em></a> 」(Ryan Bigg、Yehuda Katz著)、 「<a href="http://www.amazon.com/gp/product/1934356808"><em>The Cucumber Book</em></a>」(Matt Wynne、Aslak Hellesøy著) です)。</p>

<div class="label" id="sec-installation_and_setup"></div>


<h3><a id="sec-8_3_1" href="#sec-installation_and_setup" class="heading"><span class="number">8.3.1</span>インストールと設定</a></h3>


<p>Cucumberをインストールするには、最初に<tt>cucumber-rails</tt> gemと<tt>database_cleaner</tt>というユーティリティgemを<code>Gemfile</code>の<code>:test</code>グループに追加します (<a class="ref" href="#code-cucumber_rails">リスト8.31</a>)。</p>

<div class="label" id="code-cucumber_rails"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.31</span> <span class="description"><tt>cucumber-rails</tt> gemを<code>Gemfile.</code>に追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;cucumber-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.1&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">&#39;database_cleaner&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7.0&#39;</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>次に、いつものように以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>アプリケーションでCucumberを使用するための設定を行うために、次は必要なサポート用ファイルとディレクトリを生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate cucumber:install
</pre></div>
</div>


<p>上のコマンドにより、Cucumber関連のファイルが置かれる<code>features/</code>ディレクトリが作成されます。</p>

<div class="label" id="sec-features_and_steps"></div>


<h3><a id="sec-8_3_2" href="#sec-features_and_steps" class="heading"><span class="number">8.3.2</span>フィーチャーとステップ</a></h3>


<p>Cucumberでは、<a href="https://github.com/cucumber/gherkin">Gherkin</a> (キュウリ属の植物: ガーキン) と呼ばれるテキストベースの言語を使用して、アプリケーションに期待される振る舞いを記述します。Gherkinで書かれたテストは、ちゃんと書かれたRSpecの例と同じぐらい読みやすくできています。どちらもテキストベースであり、自然な英語に近くRubyコードよりも読みやすいためです。</p>

<p>ここでは、<a class="ref" href="#code-initial_failing_signin_test">リスト8.5</a>と<a class="ref" href="#code-signin_success_tests">リスト8.6</a>のサインインのテスト例のサブセットをCucumberで実装してみましょう。最初に、<code>features/</code>ディレクトリ内に<code>signing_in.feature</code>というファイルを作成します。</p>

<p>Cucumberのフィーチャーファイルは、以下のようにその機能の簡単な説明から始まります。</p>

<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
</pre></div>
</div>


<p>次に個別の<em>シナリオ</em>を追加します。たとえば、サインイン失敗をテストするには、以下のようなシナリオを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>同様に、サインイン成功をテストするために以下を使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div>


<p>これらをまとめたものを<a class="ref" href="#code-signin_features">リスト8.32</a>に示します。</p>

<div class="label" id="code-signin_features"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.32</span> <span class="description">ユーザーのサインインをテストするCucumberのフィーチャーファイル。</span><br /><span class="description"> <code>features/signing_in.feature</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
<span class="nf">  </span>
<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>
<span class="nf">  </span>
<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div></div>


<p>これらのフィーチャーを実行するには、<code>cucumber</code>実行ファイルを以下のように実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>上のCucumberのコマンドを、下のRSpecのコマンドと比較してみてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>ここからおわかりだと思いますが、CucumberはRSpecと同様Rakeタスクから呼び出すこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake cucumber
</pre></div>
</div>


<p>(<code>rake cucumber:ok</code>と書くこともできます)。</p>

<p>まだテキストを書いただけなので、当然ながらこのままではCucumberのシナリオはテストにパスしません。テストスイートが緑色 (成功) になるためには、テキストファイルをRubyコードにマップする<em>ステップ</em>ファイルを作成します。ステップファイルは<code>features/step_definitions</code>ディレクトリに置きます。ファイル名はここでは<code>authentication_steps.rb</code>とします。</p>

<p><code>Feature</code>行と<code>Scenario</code>行は説明のためのものですが、それ以外の行はRubyに対応付けられる必要があります。たとえば、フィーチャーファイルにある以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="k">Given </span><span class="nf">a user visits the signin page</span>
</pre></div>
</div>


<p>以下のステップ定義によって扱われます。</p>

<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>
</pre></div>
</div>


<p>フィーチャーファイルの中では<code>Given</code>は単なる文字列ですが、ステップファイルの中では<code>Given</code>は<em>メソッド</em>であり、正規表現とブロックを引数に取ります。この正規表現はシナリオの中の行とマッチし、次のブロックの内容は、そのステップを実装するために必要なRubyのコードです。この場合、“a user visits the signin page”という記述は以下のコードによって実装されます。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signin_path</span>
</pre></div>
</div>


<p>上のコードはどこかで見たことがあると思ったら、それもそのはず、Capybaraです。CapybaraはデフォルトでCucumberのステップファイルに含まれます。次の2行もわかりやすいと思います。</p>

<div class="code"><div class="highlight"><pre><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>上のフィーチャーファイルのコードは、ステップファイルでは以下のように扱われます。</p>

<div class="code"><div class="highlight"><pre><span class="no">When</span> <span class="sr">/^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>最初のステップでもCapybaraが使用されていますが、その次のステップではCapybaraの<code>page</code>オブジェクトとRSpecが併用されています。見てのとおり、RSpecとCapybaraで行えるテストは、すべてCucumberでも行えます。</p>

<p>残りのステップも同様に進められます。最終的なステップ定義ファイルを<a class="ref" href="#code-authentication_steps">リスト8.33</a>に示します。ステップを追加したら、以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>テストにパスするまでこれを繰り返します。</p>

<div class="label" id="code-authentication_steps"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.33</span> <span class="description">サインインフィーチャーがパスするための完全なステップ定義。</span><br /><span class="description"> <code>features/step_definitions/authentication_steps.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Given</span> <span class="sr">/^the user has an account$/</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
                      <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^the user submits valid signin information$/</span> <span class="k">do</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> 
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see his profile page$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see a signout link$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-authentication_steps">リスト8.33</a>のコードにより、以下のCucumberのテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>




<div class="label" id="sec-rspec_custom_matchers"></div>


<h3><a id="sec-8_3_3" href="#sec-rspec_custom_matchers" class="heading"><span class="number">8.3.3</span>対比: RSpecのカスタムマッチャー</a></h3>


<p>簡単なCucumberのシナリオをいくつか紹介したので、それらと同等のRSpecの例と比較してみましょう。まず、<a class="ref" href="#code-signin_features">リスト8.32</a>のCucumberフィーチャーと、それに対応する<a class="ref" href="#code-authentication_steps">リスト8.33</a>のステップ定義をもう一度見てみましょう。次に、以下のRSpecリクエストspec (結合テスト) を見てみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="k">end</span> 

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Cucumberと結合テストでそれぞれどのように実装されているかがおわかりいただけると思います。Cucumberのフィーチャーは非常に読みやすいのですが、その代わり実装されているコードから完全に切り離されていて、両刃の剣です。著者にとって、Cucumberは読みやすいが書くのは面倒、結合テストはプログラマーにとってはそれほど読みやすくない代わりに書くのは<em>はるかに</em>楽、という印象です。</p>

<p>Cucumberではフィーチャーとステップが分離されていることにより、抽象度の高い記述が可能であるという効果があります。以下のフィーチャーは、エラーメッセージが表示されるはずであるということを記述しています。</p>

<div class="code"><div class="highlight"><pre><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>そして以下のステップファイルでは、このテストを実装しています。</p>

<div class="code"><div class="highlight"><pre><span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>これが特に便利なのは、実装に依存するのが2番目の要素であるステップファイルだけである点です。そのため、たとえばエラーメッセージを表示するためのCSSを変更しても、フィーチャーファイルは変更不要です。</p>

<p>同様に、以下のようなコードを何度も書くのは多くの人にとって苦痛だと思います。</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>本当に行いたいのは、そのページでエラーメッセージが表示されることを示すことのはずです。しかも、上の記法は実装に密着しているので、実装が変更されたらそれらもすべて変更が必要になります。純粋なRSpecでは、<em>カスタムマッチャー</em>を使用してこの問題を解決することができます。カスタムマッチャーを使用すると、上のコードを以下のように簡潔に記述することができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>このマッチャーは、<a class="ref" href="#sec-pretty_rspec">5.3.4</a>で<code>full_title</code>テストヘルパーを置いたのと同じユーティリティーファイル内で定義することができます。コード自体は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>同様に、よく使われる操作をヘルパー関数として定義することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>作成したサポートコードを<a class="ref" href="#code-have_error_message">リスト8.34</a>に示します (<a class="ref" href="#sec-layout_exercises">5.6</a>の<a class="ref" href="#code-full_title_helper_tests">リスト5.37</a>と<a class="ref" href="#code-rspec_utilities_simplified">リスト5.38</a>の結果を含みます)。 この方法は、Cucumberのステップ定義よりも柔軟であることがわかってきました。特に、マッチャーやshouldヘルパーが<code>valid_signin(user)</code>のように引数を自然に取ることができます。ステップ定義は正規表現マッチャーによって繰り返すことができますが、この手法は一般に厄介なものになりやすいという印象です。</p>

<div class="label" id="code-have_error_message"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.34</span> <span class="description">ヘルパーメソッドとカスタムRSpecマッチャーを追加する。</span><br /><span class="description"> <code>spec/support/utilities.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="kp">include</span> <span class="no">ApplicationHelper</span>

<span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-have_error_message">リスト8.34</a>を使用することで、以下のように書くことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>以下も同様です。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>テストとサイトの実装を結びつける方法の例は他にも多数あります。現在のテストスイート全般にわたって、カスタムマッチャーとカスタムメソッドを作成してテストと実装の詳細を切り離す作業については、演習に回すことにします (<a class="ref" href="#sec-sign_in_out_exercises">8.5</a>)。</p>

<h2><a id="sec-8_4" href="#sec-8_4" class="heading"><span class="number">8.4</span>最後に</a></h2>


<p>本章では多くの分野をカバーし、かつて未成熟だったアプリケーションを、ユーザー登録とログインをフル装備したWeサイトに約束どおり変身させました。認証機能を完成させるためには、サインインの状態とユーザーidに基いてページのアクセスに制限を与える必要もあります。ページごとのアクセス制限機能の実装については、ユーザー情報を編集する機能と、ユーザーをシステムから削除できる権限を管理者に与える機能を実装するときに同時に行う予定です。このアクセス制限は、<a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>の主な目標でもあります。</p>

<p>次の章に進む前に、変更をmasterブランチにマージしておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish sign in&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-in-out
</pre></div>
</div>


<p>次にリモートのGitHubリポジトリとHerokuの本番サーバーにプッシュします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>本番サーバーで既にユーザーを作成していた場合は、<a class="ref" href="#sec-changing_the_layout_links">8.2.4</a>の手順に従ってそれらのユーザーにも有効な記憶トークンを与えることをお勧めします。違いは、ローカルのコンソールではなくHerokuのコンソールを使用するという点だけです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run console
<span class="gp">&gt;</span>&gt; User.all.each <span class="o">{</span> |user| user.save<span class="o">(</span>validate: <span class="nb">false</span><span class="o">)</span> <span class="o">}</span>
</pre></div>
</div>


<div class="label" id="sec-sign_in_out_exercises"></div>


<h2><a id="sec-8_5" href="#sec-sign_in_out_exercises" class="heading"><span class="number">8.5</span>演習</a></h2>




<ol>

<li><code>form_for</code>の代わりに<code>form_tag</code>を使用して、サインインフォームをリファクタリングしてください。テストスイートが以前と同様にパスすることも確認してください。<em>ヒント</em>: RailsCastの「<a href="http://railscasts.com/episodes/270-authentication-in-rails-3-1">Rails 3.1における認証</a> (英語)」を参照してください。特に、<code>params</code>ハッシュの構造の変更にご注目ください。</li>

<li><a class="ref" href="#sec-rspec_custom_matchers">8.3.3</a>の例に従い、ユーザー用のリクエストspecと認証リクエストspec (<code>spec/requests</code>ディレクトリの下にあるファイル) を見直し、<code>spec/support/utilities.rb</code>でユーティリティ関数を定義して、テストを実装から切り離してください。<em>課外活動:</em> サポートコードを独立したファイルとモジュールに再編成し、specヘルパーファイルでそれらのモジュールを適切にインクルードしてすべて動作するようにしてください。</li>

</ol>




<div class="footnotes">
<ol>
<li id="fn-8_1">他に、一定時間が経過するとセッションを期限切れにするモデルもあります。このモデルは、インターネットバンキングや金融取引口座などの重要な情報を扱うWebサイトに向いています。<a class="arrow" href="#fnref-8_1">↑</a></li>
<li id="fn-8_2">画像は<a href="http://www.flickr.com/photos/hermanusbackpackers/3343254977/">http://www.flickr.com/photos/hermanusbackpackers/3343254977/</a>からの引用です。<a class="arrow" href="#fnref-8_2">↑</a></li>
<li id="fn-8_3">このメソッドは、RailsCastの「<a href="http://railscasts.com/episodes/274-remember-me-reset-password">remember me</a>」の記事を元に選びました。<a class="arrow" href="#fnref-8_3">↑</a></li>
<li id="fn-8_4">Active Recordでサポートされるコールバックの種類の詳細については、Rails Guidesの「<a href="http://guides.rubyonrails.org/v3.2.13/active_record_validations_callbacks.html#callbacks-overview">コールバックについて</a> (英語)」を参照してください。<a class="arrow" href="#fnref-8_4">↑</a></li>
<li id="fn-8_5">実は、この2つは完全に同等です。<code>attr_accessor</code>は、単にゲッターメソッドやセッターメソッドを自動的に作成する便利な方法でしかありません。<a class="arrow" href="#fnref-8_5">↑</a></li>
<li id="fn-8_6">通常、これは初期値が<code>nil</code>である変数への代入を意味しますが、<code>false</code>値も<code>||=</code>演算子によって上書きされることにご注意ください。<a class="arrow" href="#fnref-8_6">↑</a></li>
<li id="fn-8_7">これは、<a class="ref" href="#sidebar-let">コラム 6.3</a>で説明した<em>メモ化 (memoization) </em>の例になっています。<a class="arrow" href="#fnref-8_7">↑</a></li>
<li id="fn-8_8">Webブラウザは実際には<tt>DELETE</tt>リクエストを発行できないので、RailsではJavaScriptを使用してこのリクエストを偽造します。<a class="arrow" href="#fnref-8_8">↑</a></li>
</ol>
</div>




<div class="label" id="cha-updating-showing-and-deleting-users"></div>


<h1 class="chapter"><a id="sec-9" href="#cha-updating-showing-and-deleting-users" class="heading"><span class="number">第9章</span> ユーザーの更新・表示・削除</a></h1>


<p>この章では、Usersリソース用のRESTアクション (<a class="ref" href="#table-RESTful_users">表7.1</a>) のうち、これまで未実装だった<code>edit</code>、<code>update</code>、<code>index</code>、<code>destroy</code>アクションを追加し、RESTアクションを完成させます。まずはユーザーが自分のプロファイルを自分で更新できるようにします。これにより、<a class="ref" href="#cha-sign-in-sign-out">第8章</a>で実装した認証用のコードによるセキュリティモデルを適用する機会を自然に提供することもできます。次に、すべてのユーザーを一覧できるようにします (もちろん認証を要求します)。これはサンプルデータとページネーション (pagenation) を導入する動機にもなります。最後に、ユーザーを削除し、データベースから完全に消去する機能を追加します。ユーザーの削除はどのユーザーにも許可できるものではないので、管理ユーザー (admin) の特権クラスを作成し、このユーザーにのみ削除を許可するようにします。</p>

<p>では最初に、いつものように<code>updating-users</code>トピックブランチを作成しましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b updating-users
</pre></div>
</div>


<div class="label" id="sec-updating_users"></div>


<h2><a id="sec-9_1" href="#sec-updating_users" class="heading"><span class="number">9.1</span>ユーザーを更新する</a></h2>


<p>ユーザー情報を編集するパターンは、(<a class="ref" href="#cha-sign-up">第7章</a>)の新規ユーザーの作成と極めて似通っています。新規ユーザー用のビューを出力する<code>new</code>アクションの代わりに、ユーザーを編集するための<code>edit</code>アクションを作成すればよいのです。 <tt>POST</tt>リクエストに応答する<code>create</code>の代わりに、<tt>PUT</tt>リクエストに応答する<code>update</code>アクションを作成すればよいのです (<a class="ref" href="#sidebar-get_etc">コラム 3.2</a>)。最大の違いは、ユーザー登録は誰でも実行できますが、ユーザー情報を更新できるのはそのユーザー自身に限られるということです。つまり、アクセス制御を行なって、認可された (authorized) ユーザーだけが編集と更新を行えるようにすればよいということです。<a class="ref" href="#cha-sign-in-sign-out">第8章</a>の認証 (authentication) システムを使えば、<em>before filter</em>を使用してこれを行えます。</p>

<div class="label" id="sec-edit_form"></div>


<h3><a id="sec-9_1_1" href="#sec-edit_form" class="heading"><span class="number">9.1.1</span>編集フォーム</a></h3>


<p>まずは編集用のフォームを作成しましょう。モックアップを<a class="ref" href="#fig-edit_user_mockup">図9.1</a>に示します<sup class="footnote" id="fnref-9_1"><a href="#fn-9_1">1</a></sup>。いつものようにテストから始めます。最初に、Gravatar画像を変更するリンクに注目してください。GravatarのWebサイトを探してみると、<a href="http://gravatar.com/emails">http://gravatar.com/emails</a>に画像の追加と編集を行えるページがありましたので、<code>edit</code>ページ上のこのURI<sup class="footnote" id="fnref-9_2"><a href="#fn-9_2">2</a></sup>へのリンクについて テストを行なうことにします。</p>

<div class="label" id="fig-edit_user_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_user_mockup_bootstrap.png" alt="edit_user_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図9.1: </span><span class="description">ユーザー編集ページのモックアップ。<a href="http://railstutorial.org/images/figures/edit_user_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>ユーザー編集フォームのテストも、<a class="ref" href="#cha-sign-up">第7章</a>の演習にある<a class="ref" href="#code-error_messages_test">リスト7.31</a>の新規ユーザーフォームのテストと似ています。いずれも、無効な送信を行った時のエラーメッセージをテストします。変更したフォームを<a class="ref" href="#code-user_edit_specs">Listing 9.1</a>に示します。</p>

<div class="label" id="code-user_edit_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.1</span> <span class="description">ユーザー編集ページのテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;page&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s2">&quot;Update your profile&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="s1">&#39;http://gravatar.com/emails&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Save changes&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これに対応するアプリケーションコードは、Usersコントローラの<code>edit</code>アクションの中に書き込みます。ここでご注意いただきたいのは、<a class="ref" href="#table-RESTful_users">表7.1</a>ではユーザー編集ページの正しいURIが/users/1/editとなっていることです (ユーザーのidが<tt>1</tt>の場合)。 ユーザーのidは<code>params[:id]</code>変数で取り出すことができるのを思い出してください。つまり、<a class="ref" href="#code-initial_edit_action">リスト9.2</a>のコードを使えばそのユーザーを指定できるということです。</p>

<div class="label" id="code-initial_edit_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.2</span> <span class="description">ユーザーの<code>edit</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>テストにパスするためには、実際のeditビューを<a class="ref" href="#code-user_edit_view">リスト9.3</a>のように変更する必要があります。このコードが<a class="ref" href="#code-signup_form">リスト7.17</a>と極めて似通っていることに注目してください。重複が多いということは、そうしたコードの繰り返しをパーシャルにまとめることができるということです。パーシャルにまとめる作業は演習の課題 (<a class="ref" href="#sec-updating_deleting_exercises">9.6</a>) とさせてください。</p>

<div class="label" id="code-user_edit_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.3</span> <span class="description">ユーザーのeditビュー。</span><br /><span class="description"> <code>app/views/users/edit.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span> 
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirm Password&quot;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Save changes&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://gravatar.com/emails&quot;</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>上のコードでは、<code>7.3.2</code>で導入した<a class="ref" href="#sec-signup_error_messages">error_messages</a>パーシャルを再利用しています。</p>

<p><a class="ref" href="#code-initial_edit_action">リスト9.2</a>の<code>@user</code>インスタンス変数を使用することで、<a class="ref" href="#code-user_edit_specs">リスト9.1</a>の編集ページ用テストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;edit page&quot;</span>
</pre></div>
</div>


<p>対応するページを<a class="ref" href="#fig-edit_page">図9.2</a>に示します。Railsによって名前フィールドやメールアドレスのフィールドに既に値が自動的に入力されていることがわかります。これらの値には<code>@user</code>変数の属性が使用されています。</p>

<div class="label" id="fig-edit_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_page_bootstrap.png" alt="edit_page_bootstrap" /></span></div><div class="caption"><span class="header">図9.2: </span><span class="description">名前とメールアドレスが入力済みの、初期状態のユーザー編集ページ。<a href="http://railstutorial.org/images/figures/edit_page_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="#fig-edit_page">図9.2</a>のHTMLソースを見てみると、formタグは期待どおりに表示されています (<a class="ref" href="#code-edit_form_html">リスト9.4</a>)。</p>

<div class="label" id="code-edit_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.4</span> <span class="description"><a class="ref" href="#code-user_edit_view">リスト9.3</a>で定義された<a class="ref" href="#fig-edit_page">図9.2</a>のHTML。</span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users/1&quot;</span> <span class="na">class=</span><span class="s">&quot;edit_user&quot;</span> <span class="na">id=</span><span class="s">&quot;edit_user_1&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>以下の入力フィールドに隠し属性があることに注目してください。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Webブラウザはネイティブでは<tt>PUT</tt>リクエスト (<a class="ref" href="#table-RESTful_users">表7.1</a>でRESTの慣習として要求されている) を送信できないので、Railsは<tt>POST</tt>リクエストと隠し<code>input</code>フィールドを利用してPUTリクエストを「偽造」しています<sup class="footnote" id="fnref-9_3"><a href="#fn-9_3">3</a></sup>。</p>

<p>ここでもう1つ微妙な点を指摘しておきたいと思います。<a class="ref" href="#code-user_edit_view">リスト9.3</a>の<code>form_for(@user)</code>のコードは、<a class="ref" href="#code-signup_form">リスト7.17</a>のコードと<em>完全に</em>同じです。だとすると、Railsはどうやって新規ユーザー用の<tt>POST</tt>リクエストとユーザー編集用の<tt>PUT</tt>リクエストを区別するのでしょうか。その答えは、Railsは、ユーザーが新規なのか、それともデータベースに存在する既存のユーザーかを、Active Recordの<code>new_record?</code>論理値メソッドを使用して区別できるからです。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Railsは、<code>form_for(@user)</code>を使用してフォームを構成するときに、<code>@user.new_record?</code>が<code>true</code>のときには<tt>POST</tt>を、<code>false</code>のときには<tt>PUT</tt>を使用するのです。</p>

<p>仕上げに、ユーザー設定のリンクにURIを1つ追加してサイト内を移動できるようにします。このリンクはユーザーのサインインしているかどうかによって異なるので、[Settings] リンクのテストは<a class="ref" href="#code-settings_link_test">リスト9.5</a>のように他の認証テストと同じところで行います。(サインインしていないユーザーにはこのリンクが表示されて<em>いない</em>ことを確認するテストも追加しておくのがよいでしょう。これは演習のために残しておきます (<a class="ref" href="#sec-updating_deleting_exercises">9.6</a>)。)</p>

<div class="label" id="code-settings_link_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.5</span> <span class="description">[Settings] リンクのテストを追加する。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span>  <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Settings&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-settings_link_test">リスト9.5</a>のコードでは、利便性のためにヘルパーを利用してテスト内でサインインを実行しています。このメソッドは、<a class="ref" href="#code-sign_in_helper">リスト9.6</a>に示したように、サインインページにアクセスして有効な情報を送信します。</p>

<div class="label" id="code-sign_in_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.6</span> <span class="description">ユーザーがサインインするためのテストヘルパー。</span><br /><span class="description"> <code>spec/support/utilities.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
  <span class="c1"># Capybaraを使用していない場合にもサインインする。</span>
  <span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>コメント行にも書いてあるとおり、Capybaraを使用していないとフォームへの自動入力が動作しません。このような場合に備えて、ユーザー情報記憶用のトークンをcookies (クッキー) に保存しておきます。</p>

<div class="code"><div class="highlight"><pre><span class="c1"># Capybaraを使用していない場合にもサインインする。</span>
<span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">remember_token</span>
</pre></div>
</div>


<p><a class="ref" href="#code-delete_destroy_test">リスト9.47</a>に示しますが、これは、HTTPリクエスト (<code>get</code>、<code>post</code>、<code>put</code>、<code>delete</code>) を直接使用する場合には必要となります (注意: テスト用の<code>cookies</code>オブジェクトは実際のcookiesオブジェクトを完全にシミュレートできているわけではありません。特に、<a class="ref" href="#code-sign_in_function">リスト8.19</a>の<code>cookies.permanent</code>メソッドはテスト内で動かすことはできません)。 既にご想像のついた方もいると思いますが、<code>sign_in</code>メソッドは今後のテストでも有意義に使えます。そして実際、(<a class="ref" href="#sec-updating_deleting_exercises">9.6</a>) ではコードの重複を除くためにこのメソッドを使用しています。</p>

<p>[Settings] リンクにURIを追加するコードはシンプルです。<a class="ref" href="#table-RESTful_users">表7.1</a>の名前付きルート<code>edit_user_path</code>に、<a class="ref" href="#code-current_user_working">リスト8.22</a>で定義された<code>current_user</code>という便利なヘルパーメソッドを追加するだけです。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>完全なアプリケーションコードを<a class="ref" href="#code-settings_link">リスト9.7</a>に示します。</p>

<div class="label" id="code-settings_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.7</span> <span class="description">[Settings] リンクを追加する。</span><br /><span class="description"> <code>app/views/layouts/_header.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>




<div class="label" id="sec-unsuccessful_edits"></div>


<h3><a id="sec-9_1_2" href="#sec-unsuccessful_edits" class="heading"><span class="number">9.1.2</span>編集の失敗</a></h3>


<p>この節では、編集 (の保存) に失敗した場合を扱います。また、<a class="ref" href="#code-user_edit_specs">リスト9.1</a>のエラーメッセージのテストがパスするようにします。このアプリケーションコードは<code>update</code>アクションを作成しますが、これは<a class="ref" href="#code-user_update_action_unsuccessful">リスト9.8</a>のように、<code>update_attributes</code> (<a class="ref" href="#sec-updating_user_objects">6.1.5</a>) を使用して、送信された<code>params</code>ハッシュに基いてユーザーを更新します。 無効な情報が送信された場合、更新の結果として<code>false</code>が返され、<code>else</code>に分岐して編集ページを再度レンダリングします。このパターンは以前にも出現したことを覚えているでしょうか。この構造は<code>create</code>アクションの最初のバージョン (<a class="ref" href="#code-first_create_action">リスト7.21</a>) と極めて似通っています。</p>

<div class="label" id="code-user_update_action_unsuccessful"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.8</span> <span class="description">最初のユーザー<code>update</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># 更新に成功した場合を扱う。</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これによって生成されたエラーメッセージ (<a class="ref" href="#fig-edit_with_invalid_information">図9.3</a>) は、まさにテストにパスするために必要なものになっています。以下のテストスイートを実行して確認してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<div class="label" id="fig-edit_with_invalid_information"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_with_invalid_information_bootstrap.png" alt="edit_with_invalid_information_bootstrap" /></span></div><div class="caption"><span class="header">図9.3: </span><span class="description">更新フォームの送信で発生したエラーメッセージ。<a href="http://railstutorial.org/images/figures/edit_with_invalid_information_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-successful_edits"></div>


<h3><a id="sec-9_1_3" href="#sec-successful_edits" class="heading"><span class="number">9.1.3</span>編集の成功</a></h3>


<p>今度は編集フォームが動作するようにしましょう。プロファイル画像の編集は、画像のアップロードをGravatarにお任せしてあるので、既に動作するようになっています。<a class="ref" href="#fig-edit_page">図9.2</a>の [change] リンクをクリックすれば、<a class="ref" href="#fig-gravatar_cropper">図9.4</a>のようにGravatarを編集できます。ではそれ以外の機能の実装にとりかかりましょう。</p>

<div class="label" id="fig-gravatar_cropper"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/gravatar_cropper.png" alt="gravatar_cropper" /></span></div><div class="caption"><span class="header">図9.4: </span><span class="description"><a href="http://gravatar.com/">Gravatar</a>の画像調整インターフェイス (写真は<a href="http://michaelhartl.com/">誰かさん</a>)</span>。</div></div>


<p><code>update</code>アクションのテストも、<code>create</code>アクション用のテストとだいたい同じです。Capybaraを使用してフォームのフィールドに有効な情報を入力し、その場合の動作が正しいことを確認するテストを<a class="ref" href="#code-user_update_specs">リスト9.9</a>に示します。コードの量がだいぶ増えてきました。<a class="ref" href="#cha-sign-up">第7章</a>のテストを見返して、十分に理解するようにしてください。</p>

<div class="label" id="code-user_update_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.9</span> <span class="description">ユーザー<code>update</code>アクションのテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_name</span><span class="p">)</span>  <span class="p">{</span> <span class="s2">&quot;New Name&quot;</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:new_email</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;new@example.com&quot;</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>             <span class="ss">with:</span> <span class="n">new_name</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>            <span class="ss">with:</span> <span class="n">new_email</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Confirm Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Save changes&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">new_name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-success&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="n">new_name</span> <span class="p">}</span>
      <span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_email</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-user_update_specs">リスト9.9</a>で唯一目新しいのは<code>reload</code>メソッドです。これはテスト内でユーザーの属性を変更するのに使用します。</p>

<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="n">new_name</span> <span class="p">}</span>
<span class="n">specify</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">new_email</span> <span class="p">}</span>
</pre></div>
</div>


<p>これにより、<code>user.reload</code>を使用してテストデータベースから<code>user</code>変数に再度読み込みが行われ、ユーザーの新しい名前とメールアドレスが新しい値と一致するかどうかが確認されます。</p>

<p>テストにパスする必要のある、<a class="ref" href="#code-user_update_specs">リスト9.9</a>の<code>update</code>アクションは、<a class="ref" href="#code-user_update_action">リスト9.10</a>に示したように、<code>create</code>アクション (<a class="ref" href="#code-signin_upon_signup">リスト8.27</a>) の最終的なフォームとほぼ同じです。 変更すべき点は、以下を</p>

<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated&quot;</span>
<span class="n">sign_in</span> <span class="vi">@user</span>
<span class="n">redirect_to</span> <span class="vi">@user</span>
</pre></div>
</div>


<p><a class="ref" href="#code-user_update_action_unsuccessful">リスト9.8</a>のコードに追加するだけで済みます。ここで、プロファイルの更新が成功した後には、続けてこのユーザーへのサインインを行う必要があることに注意してください。その理由は、ユーザーが保存された時点で (<a class="ref" href="#code-before_save_create_remember_token">リスト8.18</a>) 情報記憶用のトークン (remember token) がリセットされ、セッションが無効になってしまうためです (<a class="ref" href="#code-current_user_working">リスト8.22</a>)。これはセキュリティ上望ましい動作です。なぜなら、たとえセッションがハイジャックされるようなことがあったとしても、ユーザー情報が変更されると同時にセッションが必ず期限切れになるためです。</p>

<div class="label" id="code-user_update_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.10</span> <span class="description">ユーザーの<code>update</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated&quot;</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードに変更したことにより、編集を行った後には必ずパスワードの再確認が要求されるようになりました (<a class="ref" href="#fig-edit_page">図9.2</a>にある空欄のパスワード確認用フィールドでそのことが示されています)。ユーザーにとっては少々わずらわしいですが、これによって更新をさらにセキュアにすることができます。</p>

<p>この節のコードを使用することで、ユーザー編集ページは動作するはずです。テストスイートをダブルクリックして実行してみれば、今度は緑色になるでしょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-authorization"></div>


<h2><a id="sec-9_2" href="#sec-authorization" class="heading"><span class="number">9.2</span>認可</a></h2>


<p><a class="ref" href="#cha-sign-in-sign-out">第8章</a>で認証 (authentication) システムを構築したことで、認可 (authorization) のためのシステムを実装する準備もできました。<em>認証</em>はサイトのユーザーを特定することであり、<em>認可</em>はそのユーザーが実行可能な操作を管理することです。両者は似ていますが異なる概念です。</p>

<p><a class="ref" href="#sec-updating_users">9.1</a>のeditアクションとupdateアクションはすでに完全に動作していますが、セキュリティ上の大穴が1つ空いています。 どのユーザーでもあらゆるアクションにアクセスでき、サインインさえしていれば他のユーザーの情報を編集できてしまいます。この節では、ユーザーにサインインを要求し、かつ自分以外のユーザー情報を変更できないようにするセキュリティモデルを構築しましょう。サインインしていないユーザーや、保護されたページにアクセスしようとしているユーザーをサインインページに移動するようにし、そのときにわかりやすいメッセージも表示するようにしましょう。モックアップを<a class="ref" href="#fig-signin_page_protected_mockup">図9.5</a>に示します。</p>

<div class="label" id="fig-signin_page_protected_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_page_protected_mockup_bootstrap.png" alt="signin_page_protected_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図9.5: </span><span class="description">保護されたページにアクセスしたときのページのモックアップ。<a href="http://railstutorial.org/images/figures/signin_page_protected_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-requiring_signed_in_users"></div>


<h3><a id="sec-9_2_1" href="#sec-requiring_signed_in_users" class="heading"><span class="number">9.2.1</span>ユーザーのサインインを要求する</a></h3>


<p><code>edit</code>アクションと<code>update</code>アクションのセキュリティ制限はまったく同じなので、これらを共通のRSpec <code>describe</code>ブロックで扱うことにします。 最初にサインインの要求からテストします。最初のテストでは、サインインしていないユーザーがいずれかのアクションにアクセスしようとしたときには、<a class="ref" href="#code-protected_edit_update_tests">リスト9.11</a>のように単にサインインページに移動することを確認します。</p>

<div class="label" id="code-protected_edit_update_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.11</span> <span class="description"><code>edit</code>アクションと<code>update</code>アクションが保護されているかどうかテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;in the Users controller&quot;</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">&quot;visiting the edit page&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the update action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">put</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-protected_edit_update_tests">リスト9.11</a>のコードには、Capybaraの<code>visit</code>メソッドとは異なる、コントローラのアクションへのアクセス手段が導入されています。これは適切なHTTPリクエストを「直接」発行するという方法で、ここでは<code>put</code>メソッドを使用して<tt>PUT</tt>リクエストを発行しています。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;submitting to the update action&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">put</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このコードでは、<tt>PUT</tt>リクエストを 直接<code>/users/1</code>に発行しています。このリクエストはUsersコントローラの<code>update</code>アクションにルーティングされます (<a class="ref" href="#table-RESTful_users">表7.1</a>)。なぜこんなことをするかというと、ブラウザは<code>update</code>アクションを直接表示することができないからです。ブラウザは、編集フォームを送信することで間接的にそのアクションに到達することしかできないので (訳注: updateは純粋に更新処理を行うアクションであって、そこで何かを表示するわけではないので)、Capybaraでは対応できません。そして、editページを表示しても<code>edit</code>アクションの認可テストはできますが、<code>update</code>アクションの認可テストはできません。こうした事情から、<code>update</code>アクション自体をテストするにはリクエストを直接発行するしかないのです。 (<code>put</code>メソッドがあることからわかるように、Railsのテストでは<code>get</code>、<code>post</code>、<code>delete</code>メソッドもサポートされています。)</p>

<p>これらのメソッドのいずれかを使用してHTTPリクエストを直接発行すると、低レベルの<code>response</code>オブジェクトにアクセスできるようになります。Capybaraの<code>page</code>オブジェクトと異なり、 <code>response</code>オブジェクトはサーバーの応答自体のテストに使用できます。 この場合は、サインインページへのリダイレクトによる<code>update</code>アクションの応答を確認します。</p>

<div class="code"><div class="highlight"><pre><span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>認可のアプリケーションコードでは、<em>before filter</em>を使用して、与えられたアクションが呼び出される前に特定のメソッド向けの操作を行うことができます。ユーザーにサインインを要求するために、<a class="ref" href="#code-authorize_before_filter">リスト9.12</a>のように<code>signed_in_user</code>メソッドを定義して<code>before_filter :signed_in_user</code>という形式で呼び出します。</p>

<div class="label" id="code-authorize_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.12</span> <span class="description">before_filterに<code>signed_in_user</code>を追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>デフォルトでは、before_filterはコントローラ内の<em>すべての</em>アクションに適用されるので、ここでは適切な<code>:only</code>オプションハッシュを渡すことによって<code>:edit</code>と<code>:update</code>アクションにのみこのフィルタが適用されるように制限をかけています。</p>

<p><a class="ref" href="#code-authorize_before_filter">リスト9.12</a>では、<code>redirect_to</code>にオプションハッシュを渡すことによって、<code>flash[:notice]</code>の記述を簡素化していることに注目してください。<a class="ref" href="#code-authorize_before_filter">リスト9.12</a>のその箇所をもっと冗長に書くと以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Please sign in.&quot;</span>
<span class="n">redirect_to</span> <span class="n">signin_url</span>
</pre></div>
</div>


<p>(<code>:error</code>キーでも同じ構成が使えますが、<code>:success</code>キーではそうではありません。)</p>

<p><code>flash</code>スタイルでは、<code>:notice</code>、<code>:success</code>、<code>:error</code>の3つのキーを指定できますが、これらはBootstrap CSSでネイティブにサポートされています。サインアウトしてユーザー編集ページ<a href="http://localhost:3000/users/1/edit">/users/1/edit</a>にアクセスすると、<a class="ref" href="#fig-protected_sign_in">図9.6</a>のように黄色い &quot;notice&quot; ボックスが表示されます。</p>

<div class="label" id="fig-protected_sign_in"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/protected_sign_in_bootstrap.png" alt="protected_sign_in_bootstrap" /></span></div><div class="caption"><span class="header">図9.6: </span><span class="description">保護されたページにアクセスした直後のサインインフォーム。<a href="http://railstutorial.org/images/figures/protected_sign_in_bootstrap-full.png">(拡大)</a></span></div></div>


<p>なお、<a class="ref" href="#code-protected_edit_update_tests">リスト9.11</a>で認可テストにパスするようにしたことで、 <a class="ref" href="#code-user_edit_specs">リスト9.1</a>の以下のようなコードは残念ながらこのままでは動かなくなりました。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>これは、ユーザー編集パスにアクセスするときにユーザーのサインインが要求されるようになったためです。これを解決するには、<a class="ref" href="#code-edit_update_tests_with_signin">リスト9.13</a>に示したように、<a class="ref" href="#code-sign_in_helper">リスト9.6</a>の<code>sign_in</code>ユーティリティを使用してユーザーのサインインを行います。</p>

<div class="label" id="code-edit_update_tests_with_signin"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.13</span> <span class="description">editとupdateのテストにサインインを追加する。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;edit&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>今度はテストスイートはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/ 
</pre></div>
</div>




<div class="label" id="sec-requiring_the_right_user"></div>


<h3><a id="sec-9_2_2" href="#sec-requiring_the_right_user" class="heading"><span class="number">9.2.2</span>正しいユーザーを要求する</a></h3>


<p>当然のことですが、サインインを要求するだけでは十分ではありません。ユーザーが<em>自分自身の</em>情報以外の他ユーザーの情報を編集できないようにする必要もあります。これをテストするには、無効なユーザーとしてサインインしてから、<code>edit</code>アクションと <code>update</code>アクションにアクセスします (<a class="ref" href="#code-edit_update_wrong_user_tests">リスト9.14</a>)。ここで、ユーザーは他のユーザーのプロファイルを編集<em>しようとする</em>ことすらできないようにしないといけないという点にご注意ください。そこで、そのような場合にはユーザーをサインインページではなくルートURIに移動します。</p>

<div class="label" id="code-edit_update_wrong_user_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.14</span> <span class="description"><code>edit</code>アクションと<code>update</code>アクションで正しいユーザーを要求することをテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;as wrong user&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:wrong_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;wrong@example.com&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;visiting Users#edit page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Edit user&#39;</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;submitting a PUT request to the Users#update action&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">put</span> <span class="n">user_path</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>なお、ファクトリーでは以下のオプションを使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;wrong@example.com&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>上のコードは、作成するユーザーのメールアドレスをデフォルトと異なるものに変更します。このテストでは、元のユーザーが別のユーザーの<code>edit</code>アクションや<code>update</code>アクションにアクセスできないことを確認します。</p>

<p><a class="ref" href="#code-correct_user_before_filter">リスト9.15</a>のアプリケーションコードでは、<code>correct_user</code>メソッドを呼び出すためにbefore_filterをもう1つ追加しています。</p>

<div class="label" id="code-correct_user_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.15</span> <span class="description">edit/updateページを保護するための<code>correct_user</code> before_filter。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated&quot;</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>correct_user</code>フィルタでは<code>current_user?</code>論理値 (boolean) メソッドを使用しています。このメソッドはセッションヘルパーで定義しました (<a class="ref" href="#code-current_user_p">リスト9.16</a>)。</p>

<div class="label" id="code-current_user_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.16</span> <span class="description"><code>current_user?</code> </span><span class="description">メソッド。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_remember_token</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-correct_user_before_filter">リスト9.15</a>では、<code>edit</code>アクションと<code>update</code>アクションも更新されていることに注目してください。<a class="ref" href="#code-initial_edit_action">リスト9.2</a>の時点では以下のようなコードでした。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">edit</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このコードは<code>update</code>アクションでも同様でした。しかし既に<code>correct_user</code> before_filterで<code>@user</code>を定義したので、updateアクションとeditアクションからこのコードを削除できました。</p>

<p>以下を実行してテストスイートがパスすることを確認してから先に進むとしましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-friendly_forwarding"></div>


<h3><a id="sec-9_2_3" href="#sec-friendly_forwarding" class="heading"><span class="number">9.2.3</span>フレンドリーフォワーディング</a></h3>


<p>ここまででWebサイトの認可機能は完成したかのように見えますが、後1つ小さなキズがあります。保護されたページにアクセスしようとすると、問答無用で自分のプロファイルページに移動させられてしまいます。別の言い方をすれば、ログオンしていないユーザーが編集ページにアクセスしようとしていたなら、ユーザーがサインインした後にはその編集ページにリダイレクトされるようにするのが望ましい動作です。リダイレクト先は、ユーザーが開こうとしていたページにしてあげるのが親切というものです。</p>

<p>このような動作を “フレンドリーフォワーディング” と呼びますが、これをテストするには次のような手順を踏みます。まずユーザーのeditページにアクセスし、その後サインインページにリダイレクトします。それから正しいサインイン情報を入力し、[Sign in] ボタンをクリックします。サインイン後にリダイレクトされるのはユーザーのプロファイルページですが、この場合はもともと &quot;Edit user&quot; ページにアクセスしようとしていたのですから、そのページにリダイレクトするようにします。このテスト手順を<a class="ref" href="#code-friendly_forwarding_test">リスト9.17</a>に示します。</p>

<div class="label" id="code-friendly_forwarding_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト 9.17.</span> <span class="description">フレンドリーフォワーディングのテスト。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;when attempting to visit a protected page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;after signing in&quot;</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">&quot;should render the desired protected page&quot;</span> <span class="k">do</span>
            <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Edit user&#39;</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>いよいよ実装です<sup class="footnote" id="fnref-9_4"><a href="#fn-9_4">4</a></sup>。ユーザーを希望のページに転送するには、リクエスト時点のページをどこかに保存しておき、その場所にリダイレクトさせる必要があります。この動作を、<code>store_location</code>と<code>redirect_back_or</code>の2つのメソッドを使用して実現します。これらのメソッドは、セッションヘルパーで定義されています (<a class="ref" href="#code-friendly_forwarding_code">リスト9.18</a>)。</p>

<div class="label" id="code-friendly_forwarding_code"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.18</span> <span class="description">フレンドリーフォワーディングを実装したコード。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:return_to</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">store_location</span>
    <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここで、リダイレクト先を保存するメカニズムは、Railsが提供する<code>session</code>機能を使用しています。これは、<a class="ref" href="#sec-remember_me">8.2.1</a>で説明した、ブラウザを閉じたときに自動的に破棄される<code>cookies</code>変数のインスタンスと同様のものと考えていただければよいでしょう。また、<code>url</code> (ここではリクエストされたページのURI/URL) の取得には<code>request</code>オブジェクトを使用しています。<code>store_location</code>メソッドでは、リクエストされたURLを<code>:return_to</code>というキーで<code>session</code>変数に保存しています。</p>

<p><code>store_location</code>メソッドを使用するためには、<a class="ref" href="#code-add_store_location">リスト9.19</a>のようにこのメソッドを<code>signed_in_user</code> before_filterに追加しておく必要があります。</p>

<div class="label" id="code-add_store_location"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.19</span> <span class="description"><code>store_location</code>メソッドを、サインインしたユーザーのbefore_filterに追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">signed_in_user</span>
      <span class="k">unless</span> <span class="n">signed_in?</span>
        <span class="n">store_location</span>
        <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>フォワーディング自体を実装するには、<code>redirect_back_or</code>メソッドを使用します。リクエストされたURIが存在する場合はそこにリダイレクトし、ない場合は何らかのデフォルトのURIにリダイレクトします。デフォルトのURIは、Sessionコントローラの<code>create</code>アクションに追加し、サインイン成功後にリダイレクトします (<a class="ref" href="#code-friendly_session_create">リスト9.20</a>)。<code>redirect_back_or</code>メソッドでは、以下のようにor演算子<code>||</code>を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span>
</pre></div>
</div>


<p>このコードは、値が<code>nil</code>でなければ<code>session[:return_to]</code>を評価し、そうであれば与えられたデフォルトのURIを使用します。<a class="ref" href="#code-friendly_forwarding_code">リスト9.18</a>では、次の行で転送用のURIを削除していることに注意してください。これをやっておかないと、次回サインインしたときに保護されたページに転送されてしまい、ブラウザを閉じるまでこれが繰り返されてしまいます (このコードのテストは <a class="ref" href="#sec-updating_deleting_exercises">9.6</a>の演習とします)。</p>

<div class="label" id="code-friendly_session_create"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.20</span> <span class="description">セッションの<code>create</code>アクションでフレンドリーフォワーディングを実装する。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_back_or</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(<a class="ref" href="#cha-sign-in-sign-out">第8章</a>の最初の演習が終わっている場合は、必ず<a class="ref" href="#code-friendly_session_create">リスト9.20</a>の正しい<code>params</code> ハッシュを使用してください。)</p>

<p>これで、<a class="ref" href="#code-friendly_forwarding_test">リスト9.17</a>のフレンドリーフォワーディング用結合テストはパスするはずです。そうなれば、基本ユーザー認証機能とページ保護機能の実装は完了です。いつものように、以下を実行してテストスイートが緑色 (成功) になることを確認してから先に進みましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-showing_all_users"></div>


<h2><a id="sec-9_3" href="#sec-showing_all_users" class="heading"><span class="number">9.3</span>すべてのユーザーを表示する</a></h2>


<p>この節では、いよいよ<a href="http://www.answers.com/penultimate">最後から2番目の</a>ユーザーアクションである<code>index</code>アクションを追加しましょう。このアクションは、<em>すべての</em>ユーザーを一覧表示します。その際、データベースにサンプルデータを追加する方法や、将来ユーザー数が膨大になってもインデックスページを問題なく表示できるようにするためのユーザー出力の<em>ページネーション (pagenation=ページ分割)</em> の方法を学びます。ユーザーの一覧、ページネーション用リンク、移動用の [Users]リンクのモックアップを<a class="ref" href="#fig-user_index_mockup">図9.7</a>に示します<sup class="footnote" id="fnref-9_5"><a href="#fn-9_5">5</a></sup>。<a class="ref" href="#sec-destroying_users">9.4</a>では、ユーザーのインデックスページに管理用のインターフェイスを追加し、トラブルを起こしているユーザーなどをそこで削除できるようにします。</p>

<div class="label" id="fig-user_index_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_mockup_bootstrap.png" alt="user_index_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図9.7: </span><span class="description">ページネーションと [Users] リンクを実装したユーザーのインデックスページのモックアップ。<a href="http://railstutorial.org/images/figures/user_index_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-user_index"></div>


<h3><a id="sec-9_3_1" href="#sec-user_index" class="heading"><span class="number">9.3.1</span>ユーザーインデックス</a></h3>


<p>ユーザーの<code>show</code>ページについては、今後も (サインインしているかどうかにかかわらず) サイトを訪れたすべてのユーザーから見えるようにしておきますが、ユーザー<code>index</code>はサインインしたユーザーにしか見せないようにし、未登録のユーザーがデフォルトで表示できるページを制限します。そこで、<code>users_path</code> (<a class="ref" href="#table-RESTful_users">表7.1</a>) にアクセスしたときに<code>index</code>アクションが保護され、サインインページにリダイレクトされることをテストすることから始めます。他の認可テストと同様、<a class="ref" href="#code-protected_index_test">Listing 9.21</a>のように認証の結合テストの中に例を置くことにします。</p>

<div class="label" id="code-protected_index_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.21</span> <span class="description"><code>index</code>アクションが保護されていることをテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Users controller&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">&quot;visiting the user index&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">users_path</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-signed_in_user_index">リスト9.22</a>にアプリケーションのコードを示しました。ここでは、<code>signed_in_user</code> before_filterで保護するアクションのリストに<code>index</code>を追加するだけです。</p>

<div class="label" id="code-signed_in_user_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.22</span> <span class="description"><code>index</code>アクションでユーザーのサインインを要求する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次の一連のテストでは、サインインしたユーザーから見たインデックスページに、タイトルと見出しとサイトのすべてのユーザーが正しく表示されていることを確認します。このメソッドでは、3つのファクトリーユーザー (最初の1人としてサインインします) を作成し、インデックスページに表示されているそれぞれのユーザーにリスト要素 (<code>li</code>) タグが与えられていることを確認します。<a class="ref" href="#code-user_index_tests">Listing 9.23</a>のように、3人のユーザーはそれぞれ異なる名前にしておき、ユーザーのリストの要素がそれぞれ一意になるように (重複しないように) していることに注意してください。</p>

<div class="label" id="code-user_index_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.23</span> <span class="description">ユーザーのインデックスページのテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;index&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;bob@example.com&quot;</span><span class="p">)</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Ben&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;ben@example.com&quot;</span><span class="p">)</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">&quot;should list each user&quot;</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>デモアプリケーション (<a class="ref" href="#code-demo_index_action">リスト2.4</a>) にも同様のアクションがあったことを思い出した人もいるかもしれませんが、このアプリケーションコードでも、<a class="ref" href="#code-user_index">リスト9.24</a>のように<code>User.all</code>を使用してすべてのユーザーをデータベースから取り出し、それらを<code>@users</code>インスタンス変数に割り当ててビューで使用しています。(すべてのユーザーを一気に読みだすのはデータ量が多い場合に問題が生じるのではないかと思われる方、そのとおりです。このキズは<a class="ref" href="#sec-pagination">9.3.3</a>で修正します。)</p>

<div class="label" id="code-user_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.24</span> <span class="description">ユーザーの<code>index</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>実際のインデックスページを作成するには、ユーザーを列挙してユーザーごとに<code>li</code>タグで囲むビューを作成する必要があります。ここでは<code>each</code>メソッドを使用してこれを行います。それぞれの行を非序列リスト (<code>ul</code>)タグで囲いながら、各ユーザーのGravatarと名前を表示します (<a class="ref" href="#code-user_index_view">リスト9.25</a>)。<a class="ref" href="#code-user_index_view">リスト9.25</a>では、<a class="ref" href="#sec-signup_exercises">7.6</a>の<a class="ref" href="#code-gravatar_option">リスト7.29</a>の結果を利用しています。これは、Gravatarヘルパーにデフォルト以外のサイズを指定するオプションを渡します。この演習をまだやっていない場合は、<a class="ref" href="#code-gravatar_option">7.29</a>に従ってUsersヘルパーファイルを更新してから先に進んでください。</p>

<div class="label" id="code-user_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.25</span> <span class="description">ユーザーのindexビュー。</span><br /><span class="description"> <code>app/views/users/index.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div></div>


<p>CSS (正確にはSCSSですが) にもちょっぴり手を加えておきましょう (<a class="ref" href="#code-user_index_css">リスト9.26</a>)。</p>

<div class="label" id="code-user_index_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.26</span> <span class="description">ユーザーインデックス用のスタイル。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">users</span> <span class="nt">index</span> <span class="o">*/</span>

<span class="nc">.users</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:last-child</span> <span class="p">{</span>
      <span class="na">border-bottom</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>最後に、サイト内移動用のヘッダーにユーザー一覧表示用のリンクを追加します。これには<code>users_path</code>を使用し、<a class="ref" href="#table-RESTful_users">表7.1</a>に残っている最後の名前付きルートを割り当てます。<a class="ref" href="#code-users_link_test">リスト9.27</a>のテストと<a class="ref" href="#code-users_link">リスト9.28</a>のアプリケーションのコードは、いずれも素直な作りです。</p>

<div class="label" id="code-users_link_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.27</span> <span class="description">[Users] リンク用のURI。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">,</span>    <span class="ss">href:</span> <span class="n">users_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span>  <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Settings&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-users_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.28</span> <span class="description">このURIにユーザー一覧へのリンクを追加する。</span><br /><span class="description"> <code>app/views/layouts/_header.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>以上でユーザーインデックスページは完全に機能するようになりましたので、以下のテストはすべてパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>ところで、<a class="ref" href="#fig-user_index_only_one">図9.8</a>のようにユーザーが1人のままではいささか寂しすぎます。もう少し何とかしてみましょう。</p>

<div class="label" id="fig-user_index_only_one"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_only_one_bootstrap.png" alt="user_index_only_one_bootstrap" /></span></div><div class="caption"><span class="header">図9.8: </span><span class="description">ユーザーインデックスページ<a href="http://localhost:3000/users">/users</a>にユーザーが1人しか表示されていない。<a href="http://railstutorial.org/images/figures/user_index_only_one_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-sample_users"></div>


<h3><a id="sec-9_3_2" href="#sec-sample_users" class="heading"><span class="number">9.3.2</span>サンプルのユーザー</a></h3>


<p>この節では、一人ぼっちのユーザーに仲間を加えてあげることにします。複数のユーザーが表示されたユーザーインデックスページにするためには、ブラウザでサインアップページを表示してユーザーを手作業で1人ずつ追加<em>するという方法もありますが</em>、せっかくなのでRubyとRakeを使用してユーザーを一気に作成しましょう。</p>

<p>まず、<code>Gemfile</code>に<em>Faker</em> gemを追加します (<a class="ref" href="#code-faker_gemfile">リスト9.29</a>)。これは、実際にありそうなユーザー名とメールアドレスを持つサンプルユーザーを自動的に作成するものです。</p>

<div class="label" id="code-faker_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.29</span> <span class="description"><code>Gemfile</code>にFakerを追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.1&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>いつものように以下を実行してインストールします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>次に、サンプルユーザーを作成するRakeタスクを追加します。Rakeタスクは<code>lib/tasks</code>ディレクトリに置きます。また、Rakeタスクを定義するときには、<a class="ref" href="#code-db_populate">リスト9.30</a>のように<em>名前空間</em> (この場合は<code>:db</code>) を使用します (ここは若干高度な内容ですが、今は詳細を理解する必要はありません)。</p>

<div class="label" id="code-db_populate"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.30</span> <span class="description">データベースにサンプルユーザーを追加するRakeタスク。</span><br /><span class="description"> <code>lib/tasks/sample_data.rake</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                 <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                 <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="nb">name</span>  <span class="o">=</span> <span class="ss">Faker::Name</span><span class="o">.</span><span class="n">name</span>
      <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org&quot;</span>
      <span class="n">password</span>  <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
      <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="nb">name</span><span class="p">,</span>
                   <span class="ss">email:</span> <span class="n">email</span><span class="p">,</span>
                   <span class="ss">password:</span> <span class="n">password</span><span class="p">,</span>
                   <span class="ss">password_confirmation:</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このコードは<code>db:populate</code>タスクを定義します。このタスクは、それらしい名前とメールアドレスを持つ99のユーザーを作成し、従来のユーザーと置き換えます。以下の行は</p>

<div class="code"><div class="highlight"><pre><span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
</pre></div>
</div>


<p><code>User.create!</code>を実行する前に、RakeタスクがUserモデルなどのローカルのRails環境にアクセスできるようにします。 ここで<code>create!</code>は基本的に<code>create</code>メソッドと同じものですが、ユーザーが無効な場合に<code>false</code>を返すのではなく例外を発生させる (<a class="ref" href="#sec-finding_user_objects">6.1.4</a>) 点が異なります。こうしておくとより多くのメッセージを生成でき、サイレントエラーを回避できるのでデバッグが容易になります。</p>

<p><code>:db</code>名前空間を<a class="ref" href="#code-db_populate">9.30</a>のように設定後、以下のようにRakeタスクを呼び出します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>Rakeタスクを実行後、<a class="ref" href="#fig-user_index_all">図9.9</a>のようにアプリケーションのユーザーは100人になりました (最初のいくつかのサンプルアドレスについては、デフォルトのGravatar画像以外の写真を関連付けてみました)。</p>

<div class="label" id="fig-user_index_all"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_all_bootstrap.png" alt="user_index_all_bootstrap" /></span></div><div class="caption"><span class="header">図9.9: </span><span class="description">ユーザーインデックスページ<a href="http://localhost:3000/users">/users</a>に100人のサンプルユーザーが表示されている。<a href="http://railstutorial.org/images/figures/user_index_all_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-pagination"></div>


<h3><a id="sec-9_3_3" href="#sec-pagination" class="heading"><span class="number">9.3.3</span>ページネーション</a></h3>


<p>これで、最初のユーザーにも仲間ができました。しかし今度は逆に、1つのページに<em>大量の</em>ユーザーが表示されてしまっています。100人でもかなり大きい数であると思いますし、今後は数千ユーザーに増える可能性もあります。これを解決するのが<em>ページネーション (pagenation) </em>というもので、この場合は、たとえば1つのページに一度に30人だけユーザーを表示するというものです。</p>

<p>Railsには豊富なページネーションメソッドがあります。今回はその中で最もシンプルかつ堅牢な<a href="http://wiki.github.com/mislav/will_paginate/">will_paginate</a>メソッドを使用してみましょう。これを使用するには、Gemfileに<tt>will_paginate</tt> gem と<tt>bootstrap-will_paginate</tt> gemを両方インクルードし、Bootstrapのページネーションスタイルを使用してwill_pagenateを構成します。更新した<code>Gemfile</code>を<a class="ref" href="#code-will_paginate_gem">Listing 9.31</a>に示します。</p>

<div class="label" id="code-will_paginate_gem"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.31</span> <span class="description"><tt>will_paginate</tt>を<code>Gemfile</code>にインクルードする。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.6&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>次に<code>bundle install</code>を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>新しいgemが正しく読み込まれるように、Webサーバーを再起動してください。</p>

<p><tt>will_paginate</tt> gemは広く使用されていて実績もあるので、徹底的にテストする必要はありません。ここでは簡単なテストを行うことにします。最初に、<code>div</code>タグのCSS class が “pagination”になっていることをテストします。これは<tt>will_paginate</tt>によって出力されます。次に、結果の最初のページに正しいユーザーが表示されていることを確認します。そのためには<code>paginate</code>メソッドが必要です。このメソッドについてはこの後説明します。</p>

<p>以前と同様、Factory Girlを使用してユーザーをシミュレートすることにしますが、ここで早くも問題が生じます。ユーザーのメールアドレスは一意でないといけませんが、このままだと手作業で30人ものメールアドレスを作成しなければなりません。それに、ユーザー名もすべて異なるものにしておく方がテストの際に便利です。幸い、この問題はFactory Girlの<em>sequences</em>メソッドを使用して解決できます。最初に作成したファクトリー (<a class="ref" href="#code-user_factory">リスト7.8</a>) では、ユーザー名とメールアドレスが固定されています。</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">&quot;Michael Hartl&quot;</span>
    <span class="n">email</span>    <span class="s2">&quot;michael@example.com&quot;</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>これに代えて、以下のように<code>sequence</code>メソッドを使用して一連の名前とメールアドレスを列挙します。</p>

<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
  <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>   
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p><code>sequence</code>メソッドの引数には、使用したい属性に対応するシンボル (<code>:name</code> など) を使用し、<code>n</code>という変数を持つブロックを1つ置きます。続いて<code>FactoryGirl</code>メソッドを実行します。</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div>
</div>


<p>ブロック変数<code>n</code>は自動的にインクリメントされますので、最初のユーザーは名前が “Person 1” でメールアドレスが “person_1@example.com”、次のユーザーは名前が “Person 2” でメールアドレスが “person_2@example.com”、というように生成されます。完全なコードを<a class="ref" href="#code-factory_sequence">Listing 9.32</a>に示します。</p>

<div class="label" id="code-factory_sequence"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.32</span> <span class="description">Factory Girlでシーケンスを定義する。</span><br /><span class="description"> <code>spec/factories.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>   
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ファクトリーのシーケンスという考えを応用して、テスト用に30人のユーザーを作成します。ページネーションを行うにはこれで十分です。</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>    
</pre></div>
</div>


<p>ここで<code>before(:all)</code>を使用して、ブロックにあるすべてのテストの前にサンプルユーザーを<em>一括</em>作成するようにしていることにご注目ください。これは、ユーザーを30人も作成するとシステムによっては速度が低下することがあり、それを防ぐためのものです。これと対になる<code>after(:all)</code>を使用して、完了後ユーザーをすべて削除します。</p>

<p>ページネーションの<code>div</code>の表示テストと正しいユーザーのテストを<a class="ref" href="#code-will_paginate_test">リスト9.33</a>に示します。<a class="ref" href="#code-user_index_tests">リスト9.23</a>の<code>User.all</code>配列が<code>User.paginate(page: 1)</code>に置き換えられていることにご注目ください。この後お見せしますが、これはデータベースから最初の1ページを取り出す方法です。また、<a class="ref" href="#code-will_paginate_test">リスト9.33</a>では、<code>before(:all)</code>との違いを強調するために<code>before(:each)</code>も使用しています。</p>

<div class="label" id="code-will_paginate_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.33</span> <span class="description">ページネーションのテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;index&quot;</span> <span class="k">do</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;pagination&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="p">{</span> <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
      <span class="n">after</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>  <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">delete_all</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.pagination&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">&quot;should list each user&quot;</span> <span class="k">do</span>
        <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ページネーションが動作するには、ユーザーのページネーションを行うようにRailsに指示するコードをindexビューに追加する必要があります。また、<code>index</code>アクションにある<code>User.all</code>を、ページネーションを理解できるオブジェクトに置き換える必要もあります。まずは、ビューに特殊な<code>will_paginate</code>メソッドを追加しましょう (<a class="ref" href="#code-will_paginate_index_view">リスト9.34</a>)。同じコードがリストの上と下に2つありますが、その理由はこの後で説明します。</p>

<div class="label" id="code-will_paginate_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.34</span> <span class="description">ユーザーインデックスのページネーション。</span><br /><span class="description"> <code>app/views/users/index.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>この<code>will_paginate</code>メソッドは少々不思議なことに、<code>users</code>ビューのコードの中から<code>@users</code>オブジェクトを自動的に見つけ出し、それから他のページにアクセスするためのページネーションリンクを作成しています。実は、<a class="ref" href="#code-will_paginate_index_view">リスト9.34</a>のビューはこのままでは動きません。<code>@users</code>オブジェクトに現在含まれているのは<code>User.all</code> (<a class="ref" href="#code-user_index">リスト9.24</a>) の結果であり、しかもそれが<code>Array</code>クラスに属しているからです。<code>will_paginate</code>では、オブジェクトのクラスは<code>ActiveRecord::Relation</code>であることが前提となっています。幸い、<tt>will_paginate</tt> gemによって、すべてのActive Recordオブジェクトに<code>paginate</code>メソッドが追加されます。そのメソッドが返すオブジェクトのクラスがこのActiveRecord::Relationになっているのです。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Array</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; ActiveRecord::Relation</span>
</pre></div>
</div>


<p><code>paginate</code>は、キーが<code>:page</code>で値がリクエストページに等しいハッシュ引数を取る必要があることに注意してください。<code>User.paginate</code>は、<code>:page</code>パラメーターに基いて、データベースからひとかたまりのデータ (デフォルトでは30) を取り出します。従って、1ページ目は1から30のユーザー、2ページ目は31から60のユーザーという具合にデータが取り出されます。ページが<code>nil</code>の場合、 <code>paginate</code>は単に最初のページを返します。</p>

<p><code>paginate</code>を使用することで、サンプルアプリケーションのユーザーのページネーションを行えるようになります。具体的には、<code>index</code>アクション内の<code>all</code>を<code>paginate</code>メソッドに置き換えます (<a class="ref" href="#code-will_paginate_index_action">リスト9.35</a>)。ここで<code>:page</code>パラメーターには<code>params[:page]</code>が使用されていますが、これは<code>will_paginate</code>によって自動的に生成されます。</p>

<div class="label" id="code-will_paginate_index_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.35</span> <span class="description"><code>index</code>アクションのユーザーをページネーションする。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>以上で、ユーザーのインデックスページは<a class="ref" href="#fig-user_index_pagination_rails_3">図9.10</a>のように動作するはずです (システム環境によっては、ここでRailsを再起動する必要があるかもしれません) 。<code>will_paginate</code>をユーザーリストの上と下の両方に配置してあるので、ページネーションのリンクもページの上と下の両方に表示されています。</p>

<div class="label" id="fig-user_index_pagination_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_pagination_rails_3_bootstrap.png" alt="user_index_pagination_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">図9.10: </span><span class="description">ユーザーインデックスページ <a href="http://localhost:3000/users">/users</a>でのページネーション。<a href="http://railstutorial.org/images/figures/user_index_pagination_rails_3_bootstrap-full.png">(拡大)</a></span></div></div>


<p>[<a href="http://localhost:3000/users?page=2">2</a>] リンクまたは [<a href="http://localhost:3000/users?page=2">Next</a>] リンクをクリックすると、<a class="ref" href="#fig-user_index_page_two_rails_3">図9.11</a>のように次のページに移動します。</p>

<div class="label" id="fig-user_index_page_two_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_page_two_rails_3_bootstrap.png" alt="user_index_page_two_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">図9.11: </span><span class="description">ユーザーインデックスの2ページ目 (<a href="http://localhost:3000/users?page=2">/users?</a></span><span class="description"><a href="http://localhost:3000/users?page=2">page=2</a>)。<a href="http://railstutorial.org/images/figures/user_index_page_two_rails_3_bootstrap-full.png">(拡大)</a></span></div></div>


<p>テストもパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-partial_refactoring"></div>


<h3><a id="sec-9_3_4" href="#sec-partial_refactoring" class="heading"><span class="number">9.3.4</span>パーシャルのリファクタリング</a></h3>


<p>ユーザーインデックスへのページネーション実装はついに完了しました。でも私は、ここでぜひともある1つの改良を加えてみたいのです。実はRailsにはコンパクトなビューを作成するための素晴らしいツールがいくつもあります。この節ではそれらのツールを使用してインデックスページのリファクタリング (動作を変えずにコードを整理すること) を行うことにします。サンプルアプリケーションのテストは既に完了しているので、Webサイトの機能を損なうことなく安心してリファクタリングに取りかかれます。</p>

<p>リファクタリングの第一歩は、<a class="ref" href="#code-will_paginate_index_view">リスト9.34</a>のユーザーの<code>li</code>を<code>render</code>呼び出しに置き換えることです (<a class="ref" href="#code-index_view_first_refactoring">リスト9.36</a>)。</p>

<div class="label" id="code-index_view_first_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.36</span> <span class="description">インデックスビューで最初のリファクタリングを行う。</span><br /><span class="description"> <code>app/views/users/index.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>ここでは、<code>render</code>をパーシャルの名前の文字列に対してではなく、<code>User</code>クラスの<code>user</code>変数に対して実行していることに注意してください<sup class="footnote" id="fnref-9_6"><a href="#fn-9_6">6</a></sup>。この場合、Railsは自動的に<code>_user.html.erb</code>という名前のパーシャルを探します。このパーシャルを作成する必要があります (<a class="ref" href="#code-user_partial">リスト9.37</a>)。</p>

<div class="label" id="code-user_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.37</span> <span class="description">単一のユーザーを出力するパーシャル。</span><br /><span class="description"> <code>app/views/users/_user.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>これは間違いなく大きな進歩です。しかしここで終わらせず、さらに改良してみましょう。今度は<code>render</code>を<code>@users</code>変数に対して<em>直接</em>実行します (<a class="ref" href="#code-index_final_refactoring">リスト9.38</a>)。</p>

<div class="label" id="code-index_final_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.38</span> <span class="description">完全にリファクタリングされたユーザーインデックス。</span><br /><span class="description"> <code>app/views/users/index.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Railsは<code>@users</code>を<code>User</code>オブジェクトのリストであると推測します。さらに、ユーザーのコレクションを与えて呼び出すと、Railsは自動的にユーザーのコレクションを列挙し、それぞれのユーザーを<code>_user.html.erb</code>パーシャルで出力します (訳注: each doで囲む必要がなくなります)。これにより、<a class="ref" href="#code-index_final_refactoring">リスト9.38</a>のコードはきわめてコンパクトになります。これに限らず、リファクタリングを行う場合には、アプリケーションのコードを変更する前と後で必ずテストを実行し、いずれも緑色 (成功) になることを確認するようにしてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-destroying_users"></div>


<h2><a id="sec-9_4" href="#sec-destroying_users" class="heading"><span class="number">9.4</span>ユーザを削除する</a></h2>


<p>ユーザーインデックスはとうとう完了しました。残るは<code>destroy</code>だけです。これを実装することで、RESTに準拠した正統なアプリケーションとなります。この節では、ユーザーを削除するためのリンクを追加します。モックアップを<a class="ref" href="#fig-user_index_delete_links_mockup">図9.12</a>に示します。また、削除を行うのに必要な<code>destroy</code>アクションも実装します。しかしその前に、削除を実行できる権限を持つ管理ユーザーのクラスを作成しましょう。</p>

<div class="label" id="fig-user_index_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_delete_links_mockup_bootstrap.png" alt="user_index_delete_links_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図9.12: </span><span class="description">削除リンクを追加したユーザーインデックスのモックアップ。<a href="http://railstutorial.org/images/figures/user_index_delete_links_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-administrative_users"></div>


<h3><a id="sec-9_4_1" href="#sec-administrative_users" class="heading"><span class="number">9.4.1</span>管理ユーザー</a></h3>


<p>特権を持つ管理ユーザーを識別するために、論理値をとる<code>admin</code>属性をUserモデルに追加します。この後で説明しますが、こうすると自動的に<code>admin?</code>メソッド (論理値を返す) も使えるようになりますので、これを使用して管理ユーザーの状態をテストできます。この属性に対するテストは<a class="ref" href="#code-admin_specs">リスト9.39</a>のように書くことができます。</p>

<div class="label" id="code-admin_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.39</span> <span class="description"><code>admin</code>属性に対するテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_admin</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;with admin attribute set to &#39;true&#39;&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save!</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここでは<code>toggle!</code>メソッドを使用して <code>admin</code>属性の状態を<code>false</code>から<code>true</code>に反転しています。また、以下の行にもご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_admin</span> <span class="p">}</span>
</pre></div>
</div>


<p>これはユーザーに対して<code>admin?</code>メソッド (論理値を返す) が使用できる必要があることを (RSpecの論理値慣習に基いて) 示しています。</p>

<p>ここでいつものように、マイグレーションを実行して<code>admin</code>属性を追加しましょう。コマンドラインで、この属性の型を<code>boolean</code>と指定します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_admin_to_users admin:boolean
</pre></div>
</div>


<p>マイグレーションを実行すると単に<code>admin</code>カラムが<code>users</code>テーブル (<a class="ref" href="#code-admin_migration">リスト9.40</a>) に追加され、<a class="ref" href="#fig-user_model_admin">図9.13</a>のデータモデルが生成されます。</p>

<div class="label" id="code-admin_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.40</span> <span class="description">論理値を取る<code>admin</code>属性をユーザーに追加するマイグレーション。</span><br /><span class="description"> <code>db/migrate/[timestamp]_add_admin_to_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">default:</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-admin_migration">リスト9.40</a>では、<code>default: false</code>という引数を<code>add_column</code>に追加しています。これは、デフォルトでは管理者に<em>なれない</em>ということを示すためです (<code>default: false</code>引数を与えない場合、 <code>admin</code>の値はデフォルトで<code>nil</code>になりますが、これは<code>false</code>と同じ意味ですので、必ずしもこの引数を与える必要はありません。ただし、このように明示的に引数を与えておけば、コードの意図をRailsと開発者に明確に示すことができます)。</p>

<div class="label" id="fig-user_model_admin"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_admin_31.png" alt="user_model_admin_31" /></span></div><div class="caption"><span class="header">図9.13: </span><span class="description">論理値をとる<code>admin</code>属性が追加されたUserモデル。</span></div></div>


<p>最後に、開発用データベースにマイグレーションを行い、テスト用データベースを準備します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>Rails consoleで動作を確認すると、期待どおり<code>admin</code>属性が追加されて論理値をとり、さらに疑問符の付いた<code>admin?</code>メソッドも利用できるようになっています。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>これで、adminテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<p>仕上げに、最初のユーザーだけをデフォルトで管理者にするようサンプルデータ生成を更新しましょう (<a class="ref" href="#code-populator_with_admin">リスト9.41</a>)。</p>

<div class="label" id="code-populator_with_admin"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.41</span> <span class="description">サンプルデータ生成コードに管理者を1人追加する</span><br /><span class="description"> <code>lib/tasks/sample_data.rake</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                         <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                         <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                         <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次にデータベースをリセットし、サンプルデータを再度生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<div class="label" id="sec-revisiting_attr_accessible"></div>


<h4><a id="sec-9_4_1_1" href="#sec-revisiting_attr_accessible" class="heading"><tt>attr_accessible</tt>属性再び</a></h4>


<p><a class="ref" href="#code-populator_with_admin">リスト9.41</a>ではユーザーを管理者にするところだけ<code>toggle!(:admin)</code>を使用していますが、他の項目と同じように初期化ハッシュに単に<code>admin: true</code>を追加すればよいように思えます。なぜそうしなかったのでしょうか。実は、初期化ハッシュにadmin: trueを追加しても動作しません。そしてこれは (セキュリティ上重要な) 仕様です。<code>attr_accessible</code>属性だけが「マスアサインメント (mass assignment)」(<code>User.new(name: &quot;Foo&quot;, ...)</code>のように初期化ハッシュを利用してアクセス可能にすること) 可能です。そして<code>admin</code>属性はこのようにしてアクセスすることはできないようになっています。<a class="ref" href="#code-attr_accessible_review">リスト9.42</a>に現時点の最新の<code>attr_accessible</code>属性のリストを示しました。<code>:admin</code>属性がこの中に含まれて<em>いない</em>ことに注意してください。</p>

<div class="label" id="code-attr_accessible_review"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.42</span> <span class="description">Userモデルの<code>attr_accessible</code>の属性に<code>:admin</code>属性が含まれて<em>いない</em>。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>アクセス可能な属性を明示的に定義することは、Webサイトのセキュリティ上極めて重要です。もし仮に、Userモデルの<code>attr_accessible</code>リストを省略してしまったり、愚かにもこのリストに<code>:admin</code>を追加してしまうようなことがあれば、悪意のあるユーザーが以下のような<tt>PUT</tt>リクエストを送信してしまうかもしれません<sup class="footnote" id="fnref-9_7"><a href="#fn-9_7">7</a></sup>。</p>

<div class="code"><div class="highlight"><pre>put /users/17?admin=1
</pre></div>
</div>


<p>このリクエストは、ユーザー番号17番を管理者に変えてしまいます。ユーザーのこの行為は、少なくとも重大なセキュリティ違反となる可能性がありますし、実際にはそれだけでは済まないでしょう。このような危険を避けるため、モデルには必ず<code>attr_accessible</code>を明示的に設定するようにしてください。そして、このような「アクセス可能<em>であってはならない</em>」属性に対するテストも忘れず書くようにしてください。<code>admin</code>属性に対するテストの作成は、演習に回します (<a class="ref" href="#sec-updating_deleting_exercises">9.6</a>)。</p>

<div class="label" id="sec-the_destroy_action"></div>


<h3><a id="sec-9_4_2" href="#sec-the_destroy_action" class="heading"><span class="number">9.4.2</span> <tt>destroy</tt>アクション</a></h3>


<p>Usersリソースの最後の仕上げとして、<code>destroy</code>アクションへのリンクを追加しましょう。まず、ユーザーインデックスページの各ユーザーに削除用のリンクを追加し、続いて管理ユーザーへのアクセスを制限します。</p>

<p>削除機能をテストするには、管理者を作成するファクトリーがあると便利です。これを行うには、<a class="ref" href="#code-admin_factory">リスト9.43</a>のように既存のファクトリーに<code>:admin</code>ブロックを追加します。</p>

<div class="label" id="code-admin_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.43</span> <span class="description">管理ユーザー向けのファクトリーを追加する。</span><br /><span class="description"> <code>spec/factories.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>   
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-admin_factory">リスト9.43</a>のコードによって、<code>FactoryGirl.create(:admin)</code>を使用してテスト内に管理ユーザーを作成することができるようになります。</p>

<p>私たちのセキュリティモデルでは、一般ユーザーにはこの削除リンクを表示しないようにします。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span>   
</pre></div>
</div>


<p>逆に管理ユーザーにはこの削除リンクが表示され、このリンクをクリックすることで管理ユーザーがそのユーザーが削除され、<code>User</code>カウントが<code>-1</code>だけ変わることが期待されます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="s2">&quot;should be able to delete another user&quot;</span> <span class="k">do</span>
  <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>このテストには、管理者自身を削除するためのリンクが管理者に表示されていないことを確認するテストも含まれていることに注意してください。削除リンクテストのフルセットを<a class="ref" href="#code-delete_link_tests">Listing 9.44</a>に示します。</p>

<div class="label" id="code-delete_link_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.44</span> <span class="description">削除リンクのテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;index&quot;</span> <span class="k">do</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">visit</span> <span class="n">users_path</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="s1">&#39;All users&#39;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;pagination&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;delete links&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;as an admin user&quot;</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">sign_in</span> <span class="n">admin</span>
          <span class="n">visit</span> <span class="n">users_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="s2">&quot;should be able to delete another user&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">admin</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>アプリケーションのコードは、現在のユーザーが管理者の場合に <code>[delete]</code> リンクを有効にします (<a class="ref" href="#code-delete_links">リスト9.45</a>)。ここで、必要な<tt>DELETE</tt>リクエストを発行するリンクの生成は<code>method: :delete</code>引数によって行われている点に注目してください。また、各リンクを<code>if</code>文で囲い、管理者にだけ削除リンクが表示されるようにしています。管理者に見えるページを<a class="ref" href="#fig-index_delete_links_rails_3">図9.14</a>に示します。</p>

<div class="label" id="code-delete_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">図9.45</span> <span class="description">ユーザー削除用リンク (管理者にのみ表示される)。</span><br /><span class="description"> <code>app/views/users/_user.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                  <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">}</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>ブラウザはネイティブでは<tt>DELETE</tt>リクエストを送信できないため、RailsではJavaScriptを使用してこれを偽造します。つまり、JavaScriptがオフになっているとユーザー削除のリンクも無効になるということです。JavaScriptをサポートしないブラウザをサポートする必要がある場合は、フォームと<tt>POST</tt>リクエストを使用して<tt>DELETE</tt>リクエストを偽造することもできます。これはJavaScriptがなくても動作します。詳細についてはRailsCastの “<a href="http://railscasts.com/episodes/77-destroy-without-javascript">JavaScriptを使用しないで削除する</a>”  (英語)を参照してください。</p>

<div class="label" id="fig-index_delete_links_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/index_delete_links_rails_3_bootstrap.png" alt="index_delete_links_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">図9.14: </span><span class="description">ユーザーインデックス<a href="http://localhost:3000/users">/users</a>に削除リンクが表示されている。<a href="http://railstutorial.org/images/figures/index_delete_links_rails_3_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この削除リンクが動作するためには、<code>destroy</code>アクション (<a class="ref" href="#table-RESTful_users">表7.1</a>) を追加する必要があります。このアクションでは、該当するユーザーを見つけてActive Recordの<code>destroy</code>メソッドを使用して削除し、最後にユーザーインデックスに移動します (<a class="ref" href="#code-destroy_action">リスト9.46</a>)。<code>signed_in_user</code> before_filterに<code>:destroy</code>を追加したことにも注目してください。</p>

<div class="label" id="code-destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.46</span> <span class="description">実際に動作する<code>destroy</code>アクションを追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;User destroyed.&quot;</span>
    <span class="n">redirect_to</span> <span class="n">users_url</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>destroy</code>アクションでは、<code>find</code>メソッドと<code>destroy</code>メソッドを1行で書くために2つのメソッドを連結 (chain) している点にご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>


<p>既に、管理者のみがユーザーを削除できるように構成済みです。削除リンクは管理者にしか表示されません。残念なことに、実はまだ大きなセキュリティホールがあります。ある程度の腕前を持つ攻撃者なら、コマンドラインで<tt>DELETE</tt>リクエストを直接発行するという方法でサイトの全ユーザーを削除してしまうことができるでしょう。サイトを正しく防衛するには、<code>destroy</code>アクションにもアクセス制御を行う必要があります。そこで、管理者はユーザーを削除<em>できる</em>が一般ユーザーは<em>できない</em>ことをテストで確認しましょう。作成したテストを<a class="ref" href="#code-delete_destroy_test">リスト9.47</a>に示します。<a class="ref" href="#code-protected_edit_update_tests">リスト9.11</a>の<code>put</code>メソッドのときと同様、<code>delete</code>メソッドを使用して<tt>DELETE</tt>リクエストを指定のURI (ここでは<a class="ref" href="#table-RESTful_users">表7.1</a>で要求されているユーザーパス) に直接発行していることにご注目ください。</p>

<div class="label" id="code-delete_destroy_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.47</span> <span class="description"><code>destroy</code>アクションの保護のテスト。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;as non-admin user&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:non_admin</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">non_admin</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;submitting a DELETE request to the Users#destroy action&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="p">}</span>        
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>原則に従えば、ここにはまだ小さなセキュリティホールが残っています。管理者がやろうと思えば、<tt>DELETE</tt>リクエストをコマンドラインで直接発行して自分自身を削除できてしまいます。単なる管理者の自業自得ではないかという考えもあるかと思いますが、こういう事故を未然に防ぐに越したことはありません。これは演習の課題とさせてください (<a class="ref" href="#sec-updating_deleting_exercises">9.6</a>)。</p>

<p>このアプリケーションコードではbefore_filterを使用していますが、ここでは<code>destroy</code>アクションから管理者へのアクセスを制限するのに使用していることに気付いた方もいるかもしれません。変更後の<code>admin_user</code> before_filterを<a class="ref" href="#code-admin_destroy_before_filter">リスト9.48</a>に示します。</p>

<div class="label" id="code-admin_destroy_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.48</span> <span class="description"><code>destroy</code>アクションから管理者へのアクセスを制限するbefore_filter。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:admin_user</span><span class="p">,</span>     <span class="ss">only:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">def</span> <span class="nf">admin_user</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここまでくれば、すべてのテストはパスするはずです。そしてUsersリソースとUsersコントローラ、Userモデル、Usersビューも今や完全に動作します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-updating_and_deleting_users_conclusion"></div>


<h2><a id="sec-9_5" href="#sec-updating_and_deleting_users_conclusion" class="heading"><span class="number">9.5</span>最後に</a></h2>


<p><a class="ref" href="#sec-user_signup">5.4</a>でUsersコントローラをご紹介して以来、長い道のりでした。あの頃はユーザー登録すらありませんでしたが、今は登録もサインインもサインアウトもできます。プロファイルの表示も、設定の編集も、すべてのユーザーのインデックスページもあります。一部のユーザーは他のユーザーを削除することすらできるようになりました。</p>

<p>本書の以後の章では、これまでUsersリソース (と関連する認証/認可システム) で学んだ基礎を元に、Twitterのようなマイクロポスト機能をWebサイトに作成します (<a class="ref" href="#cha-user-microposts">第10章</a>)。続いて、自分がフォローしているユーザーのステータスフィードを作成します (<a class="ref" href="#cha-following-users">第11章</a>)。これらの章では、<code>has_many</code>や<code>has_many through</code>を使用したデータモデルなど、Railsの最も強力な機能をいくつも紹介します。</p>

<p>次の章に進む前に、すべての変更をmasterブランチにマージしておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish user edit, update, index, and destroy actions&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge updating-users
</pre></div>
</div>


<p>アプリケーションをデプロイしたり、サンプルデータを本番データとして作成することもできます (本番データベースをリセットするには<code>pg:reset</code>タスクを使用します)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<p>アプリケーションを強制的に再起動するには、Herokuに再度デプロイする必要があります。以下は、Herokuでアプリケーションを強制再起動するためのちょっとしたハックです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> touch foo
<span class="gp">$</span> git add foo
<span class="gp">$</span> git commit -m <span class="s2">&quot;foo&quot;</span>
<span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>なお、必要なgemはここまでですべてインストールしたので、今後の章では新たなgemは追加しません。参考までに、最終状態の<code>Gemfile</code>を<a class="ref" href="#code-final_gemfile">リスト9.49</a>に示します。(システム環境に依存する可能性のあるgemはコメントアウトされています。自分の環境で動作するのであれば、それらのgemの行をコメント解除しても構いません。)</p>

<div class="label" id="code-final_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.49</span> <span class="description">サンプルアプリケーションの最終<code>Gemfile</code>。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.13&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span> <span class="s1">&#39;2.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bcrypt-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.1&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;bootstrap-will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.6&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;jquery-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.0.2&#39;</span>

<span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.11.0&#39;</span>
  <span class="c1"># gem &#39;guard-rspec&#39;, &#39;1.2.1&#39;</span>
  <span class="c1"># gem &#39;guard-spork&#39;, &#39;1.2.0&#39; </span>
  <span class="c1"># gem &#39;spork&#39;, &#39;0.9.2&#39;</span>
<span class="k">end</span>

<span class="c1"># assets でのみ使用され、</span>
<span class="c1"># デフォルトのプロダクション環境では必要のないGem</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;3.2.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.2.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.3&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;capybara&#39;</span><span class="p">,</span> <span class="s1">&#39;1.1.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;4.1.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;cucumber-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.2.1&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">&#39;database_cleaner&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7.0&#39;</span>
  <span class="c1"># gem &#39;launchy&#39;, &#39;2.1.0&#39;</span>
  <span class="c1"># gem &#39;rb-fsevent&#39;, &#39;0.9.1&#39;, :require =&gt; false</span>
  <span class="c1"># gem &#39;growl&#39;, &#39;1.0.3&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;pg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.12.2&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-updating_deleting_exercises"></div>


<h2><a id="sec-9_6" href="#sec-updating_deleting_exercises" class="heading"><span class="number">9.6</span>演習</a></h2>




<ol>

<li><a class="ref" href="#code-micropost_belongs_to_user_spec">リスト10.8</a>のモデルに従い、Userの<code>admin</code>属性にアクセスできないことを確認するテストを追加してください。テストは最初は赤色 (失敗)、次に緑色 (成功) になるようにしてください (<em>ヒント</em>: 最初に、<code>admin</code>をアクセス可能リストに<em>追加</em>する必要があります)。</li>

<li><a class="ref" href="#code-user_edit_view">リスト9.3</a>の Gravatarの [change] リンクを改造し、別ウィンドウ (または別タブ) で開くようにしてください。<em>ヒント:</em> Webを検索してみましょう。この目的にピッタリの堅牢なメソッドが見つかるはずです。<code>_blank</code>という文字も一緒に検索してみてください。</li>

<li>現状の認証テストでは、ユーザーがサインインすると [Profile] や [Settings] などのリンクが表示されることをチェックしています。その逆に、ユーザーがサインインしていないときはこれらのリンクが表示<em>されない</em>ことを確認するテストも追加してください。</li>

<li><a class="ref" href="#code-sign_in_helper">リスト9.6</a>の<code>sign_in</code>テストヘルパーを、なるべく多くの場所で使ってください。</li>

<li><a class="ref" href="#code-new_edit_partial">リスト9.50</a>のパーシャルを使用して、<code>new.html.erb</code>ビューと<code>edit.html.erb</code>ビューをリファクタリングし、コードの重複を取り除いてください。  このとき、<a class="ref" href="#code-new_user_with_partial">リスト9.51</a>のようにフォーム変数<code>f</code>を明示的にローカル変数として渡す必要があることに注意してください。また、それぞれのフォームは<em>完全に同じではない</em>ため、テストも更新の必要があります。フォームのわずかな違いを見つけ出し、テストの更新にそれを反映してください。</li>

<li>サインインしたユーザーは、もはやUsersコントローラの<code>new</code>アクションや <code>create</code>アクションにアクセスする必要はありません。サインインしたユーザーがこれらのアクションをブラウザで開こうとしたら、ルートURLにリダイレクトするようにしてください。</li>

<li><code>request</code>オブジェクトについて調べてください。具体的には、<a href="http://api.rubyonrails.org/v3.2.0/classes/ActionDispatch/Request.html">Rails API</a><sup class="footnote" id="fnref-9_8"><a href="#fn-9_8">8</a></sup>の一覧に記載されているメソッドのうちいくつかをサイトのレイアウトに挿入することによってこれを調べます (やり方がわからない場合は<a class="ref" href="#code-rails_debug">リスト7.1</a>を参照してください)。</li>

<li>フレンドリーフォワーディングで、最初に与えられたURIにのみ確実に転送されていることを確認するテストを作成してください。続けてサインインを行った後、転送先のURIはデフォルト (ユーザープロファイルページ) に戻る必要もありますので、これもテストで確認してください。<a class="ref" href="#code-friendly_forgetting_test">リスト9.52</a>がヒントです (と言いつつそこで全部やってしまってますが)。</li>

<li><code>destroy</code>アクションを改造し、管理者が自分自身を削除できないようにしてください。(最初にテストを作成してからにしてください。)</li>

</ol>




<div class="label" id="code-new_edit_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.50</span> <span class="description">newフォームとeditフォームのフィールドに使用するパーシャル。</span><br /><span class="description"> <code>app/views/users/_fields.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirm Password&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-new_user_with_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.51</span> <span class="description">パーシャルを使用したnewユーザービュー。</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="ss">f:</span> <span class="n">f</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Create my account&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-friendly_forgetting_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト9.52</span> <span class="description">フレンドリーフォワーディングの後、転送先がデフォルトページに変わることを確認するテスト。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>    
      <span class="n">describe</span> <span class="s2">&quot;when attempting to visit a protected page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
          <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;after signing in&quot;</span> <span class="k">do</span>

          <span class="n">it</span> <span class="s2">&quot;should render the desired protected page&quot;</span> <span class="k">do</span>
            <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Edit user&#39;</span><span class="p">)</span>
          <span class="k">end</span>

          <span class="n">describe</span> <span class="s2">&quot;when signing in again&quot;</span> <span class="k">do</span>
            <span class="n">before</span> <span class="k">do</span>
              <span class="n">delete</span> <span class="n">signout_path</span>
              <span class="n">visit</span> <span class="n">signin_path</span>
              <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
              <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
              <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
            <span class="k">end</span>

            <span class="n">it</span> <span class="s2">&quot;should render the default (profile) page&quot;</span> <span class="k">do</span>
              <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> 
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="footnotes">
<ol>
<li id="fn-9_1">画像は<a href="http://www.flickr.com/photos/sashawolff/4598355045/">http://www.flickr.com/photos/sashawolff/4598355045/</a>より引用しました。<a class="arrow" href="#fnref-9_1">↑</a></li>
<li id="fn-9_2">Gravatarサイトにアクセスすると、実際には<a href="http://en.gravatar.com/emails">http://en.gravatar.com/emails</a>にリダイレクトされます。ここは英語ユーザー向けですが、他の言語を考慮し、<tt>en</tt>をURIに含めませんでした。<a class="arrow" href="#fnref-9_2">↑</a></li>
<li id="fn-9_3">この動作の詳細を気にする必要はありません (悪いことをしているわけでもありません)。この詳細に関心を抱くのはRailsフレームワークそのものの開発者ぐらいであり、Railsでアプリケーションを開発する人にとっては重要ではありません。<a class="arrow" href="#fnref-9_3">↑</a></li>
<li id="fn-9_4">この節のコードは、<a href="http://thoughtbot.com/">thoughtbot</a>が作成した<a href="http://github.com/thoughtbot/clearance">Clearance</a> gemに合わせたものです。<a class="arrow" href="#fnref-9_4">↑</a></li>
<li id="fn-9_5">赤ちゃんの写真は<a href="http://www.flickr.com/photos/glasgows/338937124/">http://www.flickr.com/photos/glasgows/338937124/</a>より引用しました。<a class="arrow" href="#fnref-9_5">↑</a></li>
<li id="fn-9_6">この<code>user</code>という名前そのものはまったく重要ではないことにご注意ください。たとえばuserをfoobarに置き換え、<code>@users.each do |foobar|</code>と書いてから<code>render foobar</code>と呼び出しても問題なく動作します。重要なのは、そのオブジェクトそのものではなく、そのオブジェクトが属している<em>クラス</em> (この場合は<code>User</code>クラス) の方です。<a class="arrow" href="#fnref-9_6">↑</a></li>
<li id="fn-9_7"><tt>curl</tt>などのコマンドラインツールを使用すると、<tt>PUT</tt>リクエストをこの形式で送信することができます。<a class="arrow" href="#fnref-9_7">↑</a></li>
<li id="fn-9_8">http://api.rubyonrails.org/v3.2.0/classes/ActionDispatch/Request.html <a class="arrow" href="#fnref-9_8">↑</a></li>
</ol>
</div>




<div class="label" id="cha-user-microposts"></div>


<h1 class="chapter"><a id="sec-10" href="#cha-user-microposts" class="heading"><span class="number">第10章</span>ユーザーのマイクロポスト</a></h1>


<p><a class="ref" href="#cha-updating-showing-and-deleting-users">第9章</a>ではユーザーリソース用のRESTアクションを完成させました。次は<a class="ref" href="#cha-a-demo-app">第2章</a>で見た、特定のユーザに関連付けられたショートメッセージを表現する、ユーザーの<em>マイクロポスト</em>リソースを追加します<sup class="footnote" id="fnref-10_1"><a href="#fn-10_1">1</a></sup>。この章では、<a class="ref" href="#sec-microposts_resource">2.3</a>で記述したマイクロポストデータモデルを作成し、ユーザー モデルと<code>has_many</code>および<code>belongs_to</code>メソッドを使って関連づけ、さらに、結果を処理し表示するために必要なフォームとその部品を作成します。 <a class="ref" href="#cha-following-users">第11章</a>では、マイクロポストの<em>フィード</em>を受け取るために、ユーザーを<em>フォロー</em>するという概念を導入し、Twitterのミニクローンを完成させます。</p>

<p>Git をバージョン管理に使っている場合は、いつものようにトピックブランチを作成しておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b user-microposts
</pre></div>
</div>




<div class="label" id="sec-a_micropost_model"></div>


<h2><a id="sec-10_1" href="#sec-a_micropost_model" class="heading"><span class="number">10.1</span>Micropostモデル</a></h2>


<p>まずはMicropostリソースの最も本質的な部分を表現するMicropostモデルを作成するところから始めましょう。<a class="ref" href="#sec-microposts_resource">2.3</a>で作成したモデルと同様に、この新しいMicropostモデルもデータ検証とUserモデルの関連付けを含んでいます。以前のモデルとは違って、今回のマイクロポストモデルは完全にテストされ、デフォルトの<em>順序</em>を持ち、また親であるユーザーが破棄された場合には自動的に<em>破棄</em>されるようにします。</p>

<div class="label" id="sec-the_basic_model"></div>


<h3><a id="sec-10_1_1" href="#sec-the_basic_model" class="heading"><span class="number">10.1.1</span>基本的なモデル</a></h3>


<p>Micropostモデルはマイクロポストの内容を保存する<code>content</code><sup class="footnote" id="fnref-10_2"><a href="#fn-10_2">2</a></sup>属性と特定のユーザとマイクロポストを関連付ける<code>user_id</code>属性の2つの属性だけを持ちます。ユーザーモデルの場合と同様に(リスト<a class="ref" href="#code-generate_user_model">6.1</a>)、<code>generate model</code>コマンドを使って生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Micropost content:string user_id:integer
</pre></div>
</div>


<p><a class="ref" href="#code-users_migration">リスト6.2</a>でデータベースに<code>users</code>テーブルを作るマイグレーションファイルを生成した時と同様に、このコマンドは <code>microposts</code>テーブルを作成するためのマイグレーションファイルを生成します (<a class="ref" href="#code-micropost_migration">リスト10.1</a>)。</p>

<div class="label" id="code-micropost_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.1</span> <span class="description">Micropostマイグレーション</span><span class="description">(<code>user_id</code>と<code>created_at</code>にインデックスが与えられていることに注意) </span><br /><span class="description"> <code>db/migrate/[timestamp]_create_microposts.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここで、<a class="ref" href="#code-micropost_migration">リスト10.1</a>では<code>user_id</code>と<code>created_at</code>カラムにインデックスが付与されていることにご注目ください (<a class="ref" href="#sidebar-database_indices">コラム  6.2</a>)。user idに関連付けられたすべてのマイクロポストを作成時刻の逆順で取り出すためです。</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="o">[</span><span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:created_at</span><span class="o">]</span>
</pre></div>
</div>


<p><code>user_id</code>と<code>created_at</code>両方のカラムを1つの配列に含めることで、Active Recordで<em>両方</em>のキーを同時に使用する<em>複合キーインデックス</em>を作成できます。また<a class="ref" href="#sec-database_migrations">6.1.1</a>でも述べたように、<code>t.timestamps</code>の行によって<code>created_at</code>カラムと<code>updated_at</code>カラムが作成されていることにもご注目ください。この後、<a class="ref" href="#sec-ordering_and_dependency">10.1.4</a>および<a class="ref" href="#sec-augmenting_the_user_show_page">10.2.1</a>で<code>created_at</code>カラムをさらに追加します。</p>

<p>それではユーザーモデルの場合 (<a class="ref" href="#code-user_spec">リスト6.8</a>) と同様に、マイクロポストデルに対する最小限のテストを書くところから始めましょう。具体的には <a class="ref" href="#code-initial_micropost_spec">リスト10.2</a> に示すように、micropostオブジェクトが <code>content</code>属性と<code>user_id</code>属性を持っていることを確認するテストを作成します。</p>

<div class="label" id="code-initial_micropost_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.2</span> <span class="description">最初のMicropost spec。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># 以下のコードは誤り</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Micropost マイグレーションを実行し、テストデータベースを準備することで、これらのテストをパスさせることができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>実行した結果のMicropostモデルの構造は<a class="ref" href="#fig-micropost_model">図10.1</a>のようになります。</p>

<div class="label" id="fig-micropost_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_model.png" alt="micropost_model" /></span></div><div class="caption"><span class="header">図10.1</span><span class="description">Micropostデータモデル</span></div></div>


<p>テストにパスすることを確認してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/micropost_spec.rb
</pre></div>
</div>


<p>テストにパスしたとしても、コードの中にある以下のコメントに気付いた方もいると思います。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># 以下のコードは誤り</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このコメントは <code>before</code> ブロックのコードが間違っていることを指摘しています。その理由を考えてみてください。<a class="ref" href="#sec-user_micropost_associations">10.1.3</a>で解答を確認できます。</p>

<div class="label" id="sec-accessible_attribute"></div>


<h3><a id="sec-10_1_2" href="#sec-accessible_attribute" class="heading"><span class="number">10.1.2</span>Accessible属性と最初の検証</a></h3>


<p>上の解答を見る前に、<code>before</code>ブロックのコードが誤っている理由を確認するために、まずMicropostモデルに対する検証 (validation) テストを作成してみましょう (<a class="ref" href="#code-micropost_validity_test">リスト10.3</a>) (<a class="ref" href="#code-failing_validates_name_spec">リスト6.11</a>でのUserモデルのテストと比較してみてください)。</p>

<div class="label" id="code-micropost_validity_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.3</span> <span class="description">新しいマイクロポストに対する検証のテスト</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="c1"># This code is wrong!</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このコードはマイクロポストが有効であり、かつ<code>user_id</code>属性が存在していることをテストしています。<a class="ref" href="#code-micropost_user_id_validation">リスト10.4</a> に示すような簡単な存在検証によって、このテストはパスします。</p>

<div class="label" id="code-micropost_user_id_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.4</span> <span class="description">マイクロポストの<code>user_id</code>に対する検証。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:user_id</span>  
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これで、以下のコードが誤っている理由を見つけるための準備が整いました。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>


<p>問題となっているのは、デフォルト (Rails 3.2.3の場合) でMicropostモデルの<em>すべて</em>の属性がアクセス可能になっていることです。<a class="ref" href="#sec-accessible_attributes">6.1.2.2</a>と<a class="ref" href="#sec-revisiting_attr_accessible">9.4.1.1</a>で述べたように、これは、コマンドラインのクライアントを使って悪意のあるリクエストを発行することで、誰でもマイクロポストオブジェクトのあらゆる属性を改変できることを意味します。たとえば、悪意のあるユーザがマイクロポストの<code>user_id</code>属性を改変し、別のユーザにマイクロポストを関連づける事も可能です。つまり、<code>user_id</code>は<code>attr_accessible</code>リストから削除されるべきであり、またそうすることにより上記のコードはテストに失敗します。この問題は<a class="ref" href="#sec-user_micropost_associations">10.1.3</a>で修正します。</p>

<div class="label" id="sec-user_micropost_associations"></div>


<h3><a id="sec-10_1_3" href="#sec-user_micropost_associations" class="heading"><span class="number">10.1.3</span>User/Micropostの関連付け</a></h3>


<p>Webアプリケーション用のデータモデルを構築するにあたって、個々のモデル間での<em>関連づけ</em>を十分考えておくことが重要です。今回の場合は、 <a class="ref" href="#sec-demo_user_has_many_microposts">2.3.3</a>でも示したように、それぞれのマイクロポストは１人のユーザと関連付けられ、それぞれのユーザは (潜在的に) 複数のマイクロポストと関連付けられます。この関連付けを<a class="ref" href="#fig-micropost_belongs_to_user">図10.2</a>と<a class="ref" href="#fig-user_has_many_microposts">図 0.3</a>に示します。それらの関連を実装するにあたって、<a class="ref" href="#code-initial_micropost_spec">リスト10.2</a>のようにではなく、<a class="ref" href="#code-micropost_accessible_attribute">リスト10.7</a>のように<code>attr_accessible</code>を利用してMicropostモデルのテストを作成します。</p>

<div class="label" id="fig-micropost_belongs_to_user"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_belongs_to_user.png" alt="micropost_belongs_to_user" /></span></div><div class="caption"><span class="header">図10.2</span><span class="description">micropost と user</span>間の<code>belongs_to</code>リレーションシップ</div></div>




<div class="label" id="fig-user_has_many_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_has_many_microposts.png" alt="user_has_many_microposts" /></span></div><div class="caption"><span class="header">図10.3</span><span class="description">userとmicropost</span>間の<code>has_many</code>リレーションシップ</div></div>


<p>このセクションで定義した<code>belongs_to</code>/<code>has_many</code>関連付けを使用することで、<a class="ref" href="#table-association_methods">表10.1</a>に示すようなメソッドをRailsで使えるようになります。</p>

<div class="label" id="table-association_methods"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>メソッド</strong></th><th class="align_left"><strong>目的</strong></th></tr><tr class="top_bar"><td class="align_left"><code>micropost.user</code></td><td class="align_left">マイクロポストに関連付けられたユーザーオブジェクトを返す。</td></tr><tr><td class="align_left"><code>user.microposts</code></td><td class="align_left">ユーザのマイクロポストの配列を返す。</td></tr><tr><td class="align_left"><code>user.microposts.create(arg)</code></td><td class="align_left">マイクロポストを作成する (<code>user_id = user.id</code>)。</td></tr><tr><td class="align_left"><code>user.microposts.create!(arg)</code></td><td class="align_left">マイクロポストを作成する (失敗した場合は例外を発生する)。</td></tr><tr><td class="align_left"><code>user.microposts.build(arg)</code></td><td class="align_left">新しいMicropostオブジェクトを返す (<code>user_id = user.id</code>)。</td></tr></table></div><div class="caption"><span class="header">表10.1</span><span class="description">user/micropost関連メソッドのまとめ</span></div></div>


<p><a class="ref" href="#table-association_methods">表10.1</a>では、以下のメソッドではなく</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">create</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span>
<span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
</pre></div>
</div>


<p>以下のメソッドになっていることにご注意ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span>
<span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>このパターンは、user オブジェクトの関連付けを<em>経由して</em>マイクロポストを作成する標準的な方法です。新規のマイクロポストがこの方法で作成される場合、<code>user_id</code>は<em>自動的</em>に正しい値に設定され、 <a class="ref" href="#sec-accessible_attribute">10.1.2</a>で述べたような問題を解決してくれます。特に、以下のような</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="k">do</span>
  <span class="c1"># 以下のコードは誤り</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p><a class="ref" href="#code-micropost_validity_test">リスト10.3</a>のコードを、以下のコードと置き換えることができるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>一度正しい関連付けを定義してしまえば、<code>@micropost</code>変数の<code>user_id</code>には、関連するユーザのidが自動的に設定されます。</p>

<p>マイクロポストをユーザと関連付けて構築できても、<code>user_id</code>にアクセスできてしまうというセキュリティ上の問題は解決されません。これはセキュリティ上の重要な懸念事項であるため、<a class="ref" href="#code-attr_accessible_user_id_test">リスト10.5</a>に示すように失敗するテストを記述します。</p>

<div class="label" id="code-attr_accessible_user_id_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.5</span> <span class="description"><code>user_id</code>がアクセス不能であることを確認するテスト。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;accessible attributes&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should not allow access to user_id&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストは、空ではない<code>user_id</code>を使用して<code>Micropost.new</code>を呼ぶと、mass assignment security error例外が発生することを確認しています。この挙動はRails 3.2.3ではデフォルトですが、以前のバージョンではオフにされているため、<a class="ref" href="#code-application_whitelist">リスト10.6</a>で示すように自分のアプリケーションが正しく設定されているかどうかを確認してください。</p>

<div class="label" id="code-application_whitelist"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.6</span> <span class="description">Railsがinvalid mass assignmentエラーを発生するようにする設定。</span><br /><span class="description"> <code>config/application.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="ss">Rails::Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">whitelist_attributes</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Micropostモデルの場合は、 Web経由で編集されてもよい属性は<code>content</code>属性<em>のみ</em>であるため、<a class="ref" href="#code-micropost_accessible_attribute">リスト10.7</a>で示すように<code>:user_id</code>をアクセス可能リストから取り除く必要があります。</p>

<div class="label" id="code-micropost_accessible_attribute"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.7</span> <span class="description"><code>content</code>属性を (そして<code>content</code>属性<em>のみ</em>を) アクセス可能にする。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#table-association_methods">表10.1</a>に示したように、ユーザーとマイクロポストの関連付けの結果には、単にマイクロポストのユーザを返す<code>micropost.user</code>メソッドもあり、これもテストが必要です。このメソッドは、<code>it</code>と<code>its</code>メソッドを以下のように使うことでテストできます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">user</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のコードを反映したMicropostモデルのテストを<a class="ref" href="#code-micropost_belongs_to_user_spec">リスト10.8</a>に示します。</p>

<div class="label" id="code-micropost_belongs_to_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.8</span> <span class="description">マイクロポストのユーザとの関連付けのテスト。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:content</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">its</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;accessible attributes&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should not allow access to user_id&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Userモデル側の関連付けに対する詳細なテストは<a class="ref" href="#sec-ordering_and_dependency">10.1.4</a>まで保留することにし、今は単に<code>microposts</code>属性の存在をテストするだけにしておきます (<a class="ref" href="#code-user_has_many_microposts_spec">リスト10.9</a>)。</p>

<div class="label" id="code-user_has_many_microposts_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.9</span> <span class="description">ユーザの<code>microposts</code>属性に対するテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span> 
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>関連付けを実装する最終的なコードは、テストコードの長さと比べるとあっけないほど短いものになります。<a class="ref" href="#code-micropost_belongs_to_user_spec">リスト10.8</a>と<a class="ref" href="#code-user_has_many_microposts_spec">リスト10.9</a>の両方のテストにパスするためには、<code>belongs_to :user</code> (<a class="ref" href="#code-micropost_belongs_to_user">リスト10.10</a>) と <code>has_many :microposts</code> (<a class="ref" href="#code-user_has_many_microposts">リスト10.11</a>) の2行を加えるだけで済みます。</p>

<div class="label" id="code-micropost_belongs_to_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.10</span> <span class="description">マイクロポストがユーザに所属する (<code>belongs_to</code>) 関連付け。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>  
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-user_has_many_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.11</span> <span class="description">ユーザがマイクロポストを複数所有する (<code>has_many</code>) 関連付け。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で、関連付けの基本的原則を理解するために、<a class="ref" href="#table-association_methods">表10.1</a>の項目と、<a class="ref" href="#code-micropost_belongs_to_user_spec">リスト10.8</a>および<a class="ref" href="#code-user_has_many_microposts_spec">リスト10.9</a>のコードを見比べてみてください。テストにパスすることも確認しておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models
</pre></div>
</div>




<div class="label" id="sec-ordering_and_dependency"></div>


<h3><a id="sec-10_1_4" href="#sec-ordering_and_dependency" class="heading"><span class="number">10.1.4</span>マイクロポストを改良する</a></h3>


<p><a class="ref" href="#code-user_has_many_microposts_spec">リスト10.9</a>の<code>has_many</code>関連付けのテストでは、<code>microposts</code>属性の<em>存在</em>をほとんど検証していないので、あまり意味がありませんでした。この章では、<em>順序</em>と<em>依存関係</em>をマイクロポストに追加し、<code>user.microposts</code>メソッドが実際にマイクロポストの配列を返すことをテストします。</p>

<p>Userモデルのテストのためにいくつかのマイクロポストを作成しておく必要がありますので、この時点でマイクロポストを生成するファクトリーを作成しておきましょう。そのためには、Factory Girlに関連付けを作成する方法を知っておく必要があります。幸い、<a class="ref" href="#code-micropost_factory">リスト10.12</a>に示したとおり、これは非常に簡単です。</p>

<div class="label" id="code-micropost_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.12</span> <span class="description">マイクロポスト作成用の新しいファクトリーを含む、完全なFactoryファイル。</span><br /><span class="description"> <code>spec/factories.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>  <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;Person </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
    <span class="n">sequence</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="s2">&quot;person_</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span><span class="p">}</span>   
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>

    <span class="n">factory</span> <span class="ss">:admin</span> <span class="k">do</span>
      <span class="n">admin</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
    <span class="n">content</span> <span class="s2">&quot;Lorem ipsum&quot;</span>
    <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここでは、以下のようにマイクロポスト用のファクトリーの定義にユーザを含めるだけで、マイクロポストに関連付けられるユーザーのことがFactory Girlに伝わります。</p>

<div class="code"><div class="highlight"><pre><span class="n">factory</span> <span class="ss">:micropost</span> <span class="k">do</span>
  <span class="n">content</span> <span class="s2">&quot;Lorem ipsum&quot;</span>
  <span class="n">user</span>
<span class="k">end</span>
</pre></div>
</div>


<p>次の節でもお見せしますが、これによって、以下のようにマイクロポスト用のファクトリーを定義できるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<div class="label" id="sec-default_scope"></div>


<h4><a id="sec-10_1_4_1" href="#sec-default_scope" class="heading">デフォルトのスコープ</a></h4>


<p>データベースからユーザのマイクロポストを読み出す<code>user.microposts</code>メソッドは、デフォルトでは読み出しの順序に対して何も保証しませんが、 ブログやTwitterの慣習に従って、作成時間の逆順、つまり最も新しいマイクロポストを最初に表示するようにしてみましょう。この順序をテストするために、次のようにマイクロポストをいくつか作成しておきます。</p>

<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
<span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<p>(<a class="ref" href="#sidebar-time_helpers">コラム 8.1</a>で説明した時間指定用ヘルパーメソッドを使うことで) 2番目のポストの作成時刻がより新しく (<code>1時間前</code>)、最初のポストの作成日時が<code>1日前</code>になります。Factory Girlを使用すると、<code>attr_accessible</code>をバイパスすることによってマスアサインメントを使ってユーザーを設定することもできますし、Active Recordがアクセスを許可しないような<code>created_at</code>属性も手動で設定できるので大変便利です (<code>created_at</code>や<code>updated_at</code>などは通常のカラムと異なる “マジック”カラムであり、これらの作成タイムスタンプや更新タイムスタンプは自動的に設定されてしまうため、明示的に値を設定しても上書きされてしまうことを思い出してください)。</p>

<p>(SQLiteを含む) ほとんどのデータベースアダプターは、マイクロポストを id順で返すため、<a class="ref" href="#code-micropost_ordering_test">リスト10.13</a>のようなテストはほぼ確実に失敗することになります。このコードでは<code>let</code>メソッドの代わりに<code>let!</code> (“let バン”と読みます) メソッドを使っています。これは、<code>let</code> 変数は「<em>lazy</em>」、つまり実際に参照されるまで初期化されない性質 (遅延) を持っており、そのことで不都合が生じるためです。ここでは、マイクロポストを遅延することなく即座に作成する必要があります。そのことにより、マイクロポストのタイムスタンプが常に正しい順序で作成されるように、かつ<code>@user.microposts</code>が空の状態が生じることのないようにしたいからです。<code>let!</code>を使用すれば、対応する変数を強制的に即座に作成できます。</p>

<div class="label" id="code-micropost_ordering_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.13</span> <span class="description">ユーザのマイクロポストの順序をテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right microposts in the right order&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上記のコードで重要なのは、以下の行です。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="n">newer_micropost</span><span class="p">,</span> <span class="n">older_micropost</span><span class="o">]</span>
</pre></div>
</div>


<p>これは新しいポストが最初に来ることをテストしています。デフォルトでは id順に並ぶため<code>[older_micropost, newer_micropost]</code>の順序になりテストは失敗するはずです。また、このテストは<a class="ref" href="#table-association_methods">表 10.1</a>で示すように、 <code>user.microposts</code>がマイクロポストの配列を返すことをチェックすることにより、基本的な<code>has_many</code>関連付け自体の正しさも確認しています。</p>

<p>順序テストがパスするために、 <a class="ref" href="#code-micropost_ordering">リスト10.14</a>に示すようにRailsの <code>default_scope</code>に<code>:order</code>パラメータを渡して使用します (このコードは<em>スコープ</em>に関する最初の例でもあります。より一般的なスコープについては<a class="ref" href="#cha-following-users">第11章</a>で説明します)。</p>

<div class="label" id="code-micropost_ordering"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.14</span> <span class="description"><code>default_scope</code>でマイクロポストを順序付ける。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでの順序は<code>’microposts.created_at DESC’</code>としています。<code>DESC</code>は SQLでいうところの “descending” であり、新しいものから古い順への降順ということになります。</p>

<div class="label" id="sec-dependent_destroy"></div>


<h4><a id="sec-10_1_4_2" href="#sec-dependent_destroy" class="heading">Dependent: destroy</a></h4>


<p>順序についてはここで区切ることにし、今度はマイクロポストに第二の要素を追加してみましょう。<a class="ref" href="#sec-destroying_users">9.4</a>で書いたように、サイト管理者はユーザを<em>破棄する</em>権限を持ちます。ユーザが破棄された場合、ユーザのマイクロポストも同様に破棄されるべきです。最初のマイクロポストのユーザーを破棄した後、関連するマイクロポストもデータベースからなくなったことを確認することで、ユーザーの破棄をテストすることができます。</p>

<p>適切にマイクロポストの破棄をテストするために、最初にローカル変数で指定されたユーザーのポストを取得し、それからユーザーを破棄します。シンプルな実装は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># マイクロポストがデータベースからなくなったことを確認</span>
<span class="k">end</span>
</pre></div>
</div>


<p>残念ですが、上のコードはRubyの配列の妙により動きません。Rubyにおける配列の代入は「<em>参照</em>のコピー」であり、配列全体そのもののコピーではないため、オリジナルの配列に対して何らかの変更を行うと、そのコピーにも同じ変更が行われてしまいます。たとえば以下のように、配列を作成し、2番目の変数をその配列に代入してから、<code>reverse!</code>メソッドを使用して最初の配列を逆順にするとします。 </p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse!</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span>
<span class="go">=&gt; [3, 2, 1]</span>
</pre></div>
</div>


<p>驚くかもしれませんが、上のコードでは、<code>a</code>が逆転しただけではなく、<code>b</code>まで逆転されてしまっています。これは、<code>a</code>と<code>b</code>が同じ配列を指しているためです (同じことは、文字列とハッシュなど、他のRubyのデータ構造でも発生します)。</p>

<p>ユーザのマイクロポストの場合には、こうなります。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span>
<span class="gp">&gt;&gt; </span><span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="gp">&gt;&gt; </span><span class="n">microposts</span>
<span class="go">=&gt; []</span>
</pre></div>
</div>


<p>（この時点では、関連付けられたマイクロポストの破棄を実装していないので、上のコードは動作しません。原理を説明するためだけに書いています。）ここでは、ユーザオブジェクトを破棄しても、<code>microposts</code>変数は空の配列<code>[]</code>として残されていることがわかります。</p>

<p>この「参照がコピーされる」動作は、Rubyのオブジェクトの複製を行うときに多大な注意を払わないといけないことを意味します。配列などの比較的単純なオブジェクトを複製するには、<code>dup</code>メソッドを使用することができます。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">dup</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">reverse!</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span>
<span class="go">=&gt; [3, 2, 1]</span>
<span class="gp">&gt;&gt; </span><span class="n">b</span>
<span class="go">=&gt; [1, 2, 3]</span>
</pre></div>
</div>


<p>(このような比較的単純なオブジェクトの複製作業は “shallow copy” として知られています。より複雑なオブジェクトを複製する &quot;deep copy&quot; を実装することははるかに難しい問題であり、実際に一般的な解決策はありませんが、検索エンジンで &quot;ruby deep copy&quot; を検索すると、ネストした配列のような、より複雑な構造をコピーする必要がある場合の解決策が見つかると思います。)ユーザーのマイクロポストに<code>dup</code>メソッドを適用すると、次のようなコードになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">dup</span>
<span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_empty</span>
<span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="c1"># マイクロポストがデータベースからなくなったことを確認</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードには、以下の行を追加しました。</p>

<div class="code"><div class="highlight"><pre><span class="n">microposts</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_empty</span>
</pre></div>
</div>


<p>上の行は、<code>dup</code>が誤って消されてしまった場合にエラーを検出できるように、セーフティチェックとして追加しました<sup class="footnote" id="fnref-10_3"><a href="#fn-10_3">3</a></sup>。完全な実装を<a class="ref" href="#code-micropost_dependency_test">リスト10.15</a>に示します。</p>

<div class="label" id="code-micropost_dependency_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.15</span> <span class="description">ユーザーを破棄するとマイクロポストも破棄されることをテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;should destroy associated microposts&quot;</span> <span class="k">do</span>
      <span class="n">microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">dup</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
      <span class="n">microposts</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_empty</span>
      <span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、レコードが見つからない場合は<code>nil</code>を返す<code> Micropost.find_by_id</code>を使用しました。一方、<code> Micropost.find</code>は例外が発生するため、テストするのが多少難しくなってしまいます。(気になっているかもしれないので書いておくと、findを使用する場合は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span> 
  <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveRecord::RecordNotFound</span><span class="p">)</span>
</pre></div>
</div>


<p>これでfindの場合のテストを実施できます。)</p>

<p><a class="ref" href="#code-micropost_dependency_test">リスト10.15</a>をパスするためのアプリケーションコードは1行に満たないほどの量しかなく、事実それは<a class="ref" href="#code-micropost_dependency">リスト10.16</a>に示す<code> has_many</code>関連付けメソッドのオプションにすぎません。
</p>

<div class="label" id="code-micropost_dependency"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.16</span> <span class="description">ユーザのマイクロポストがユーザと一緒に破棄されることを保証するコード。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="n">has_secure_password</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードの中にある以下の<code>dependent: :destroy</code>オプションは、</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
</pre></div>
</div>


<p>ユーザー自体が破棄されたときに、そのユーザーに依存するマイクロポスト (つまり特定のユーザーのもの) も破棄されることを指定しています。これは、管理者がシステムからユーザーを削除したときに、依存するユーザーが存在しないマイクロポストがデータベースに取り残されてしまうことを防ぎます。</p>

<p>これで、ユーザー/マイクロポスト関連付けの最終形が完成しました。すべてのテストがパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-micropost_validations"></div>


<h3><a id="sec-10_1_5" href="#sec-micropost_validations" class="heading"><span class="number">10.1.5</span>コンテンツの検証</a></h3>


<p>Micropostモデルを離れる前に、(<a class="ref" href="#sec-putting_the_micro_in_microposts">2.3.2</a>の例に従い) マイクロポストの<code>content</code>の検証を追加しましょう。<code>user_id</code>属性と同様、<code>content</code>属性も存在する必要があり、さらに<em>マイクロ</em>ポストが140文字より長くならないよう制限を加えます。このテストは<a class="ref" href="#sec-user_validations">6.2</a>でのユーザーモデルの検証テストの例に従って、<a class="ref" href="#code-micropost_validations_tests">リスト10.17</a>のように書きます。</p>

<div class="label" id="code-micropost_validations_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.17</span> <span class="description">Micropostモデルの検証のテスト。</span><br /><span class="description"> <code>spec/models/micropost_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when user_id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with blank content&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;with content that is too long&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">141</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#sec-user_validations">6.2</a>と同様、<a class="ref" href="#code-micropost_validations_tests">リスト10.17</a>ではマイクロポストの長さの検証コードをテストするために、文字列の乗算を使用しています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 10
<span class="go">=&gt; &quot;aaaaaaaaaa&quot;</span>
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 141
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
</pre></div>
</div>


<p>実際のアプリケーションコードはわずか1行です。</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のコードを反映したMicropostモデルを<a class="ref" href="#code-micropost_validations">リスト10.18</a>に示します。</p>

<div class="label" id="code-micropost_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.18</span> <span class="description">Micropostモデルの検証。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-showing_microposts"></div>


<h2><a id="sec-10_2" href="#sec-showing_microposts" class="heading"><span class="number">10.2</span>マイクロポストを表示する</a></h2>


<p>Web経由でマイクロポストを作成する方法はまだありませんが (<a class="ref" href="#sec-creating_microposts">10.3.2</a>から作り始めます)、マイクロポストを表示することと、テストすることならできます。ここでは、Twitterのような独立したマイクロポスト<code>index</code>ページでユーザーのマイクロポストを表示するよりも、<a class="ref" href="#fig-user_microposts_mockup">図10.4</a>のモックアップに示したように、直接ユーザーの<code>show</code>ページで表示させることにしましょう。ユーザープロファイルにマイクロポストの表示を追加するための非常にERbテンプレートを作成するところから始め、次に<a class="ref" href="#sec-sample_users">9.3.2</a>のサンプルデータ生成にマイクロポストを追加して、画面にサンプルデータが表示されるようにします。</p>

<div class="label" id="fig-user_microposts_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_microposts_mockup_bootstrap.png" alt="user_microposts_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図10.4: </span><span class="description">マイクロポストが表示されたプロファイルページのモックアップ。<a href="http://railstutorial.org/images/figures/user_microposts_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="#sec-remember_me">8.2.1</a>でサインイン機能について説明したときと同様に、<a class="ref" href="#sec-augmenting_the_user_show_page">10.2.1</a>でも最初に実装をお見せし、次にそれらの要素を順に解説してきます (<a href="http://en.wikipedia.org/wiki/Stack_(data_structure)">スタック</a>に複数の要素を一括でプッシュした後、順にポップするような要領です)。しばらくの間盛り上がりに欠けるかもしれませんが、<a class="ref" href="#sec-sample_microposts">10.2.2</a>で一気に取り返しますので、ご辛抱願います。</p>

<div class="label" id="sec-augmenting_the_user_show_page"></div>


<h3><a id="sec-10_2_1" href="#sec-augmenting_the_user_show_page" class="heading"><span class="number">10.2.1</span>ユーザー表示ページの拡張</a></h3>


<p>ユーザーのマイクロポスト表示に対するテスト、すなわちユーザーに対するrequest specを作成するところから始めましょう。ユーザーに関連付けられているマイクロポストのファクトリーを作成し、それから表示ページが各ポストの内容を含んでいるか検証する戦略で進めます。また、<a class="ref" href="#fig-user_microposts_mockup">図 10.4</a>で示されているように, マイクロポストの総数が表示されているかどうかも検証します。</p>

<p>ポストは<code>let</code>メソッドで作成できますが、ユーザ表示ページでポストがすぐに表示されるように、<a class="ref" href="#code-micropost_ordering_test">リスト10.13</a>と同様に即座に関連付けを作成できるようにしたいと思います。そこで、今回も<code>let!</code>を使います。 </p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">)</span> <span class="p">}</span>

<span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のようにマイクロポストを定義したことで、<a class="ref" href="#code-user_show_microposts_test">リスト10.19</a>のコードを使って、プロファイルページの外観をテストできるようになります。</p>

<div class="label" id="code-user_show_microposts_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.19</span> <span class="description">ユーザの<code>show</code>ページでマイクロポストが表示されていることをテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m1</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:m2</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Bar&quot;</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h1&#39;</span><span class="p">,</span>    <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;microposts&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>count</code>メソッドは、関連付けを<em>経由して</em>使用していることにご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p><code>count</code>関連付けメソッドは賢くできていて、直接データベースでカウントを行います。特に、データベース上のマイクロポストを全部読みだしてから結果の配列に対して<code>length</code>を呼ぶような無駄なことは<em>していません</em>。そんなことをしたら、マイクロポストの数が増加するにつれて効率が低下してしまいます。代わりに、特定<code>user_id</code>に対するマイクロポストの数をデータベースに問い合わせます。それでもcountメソッドがアプリケーションのボトルネックになるようなことがあれば、さらに高速な<a href="http://railscasts.com/episodes/23-counter-cache-column"><em>counter cache</em></a>を使うこともできます。</p>

<p><a class="ref" href="#code-user_show_microposts_test">リスト10.19</a>のテストは<a class="ref" href="#code-micropost_partial">リスト10.21</a>まではパスしませんが、<a class="ref" href="#code-user_show_microposts">リスト10.20</a>に示されているように、まずはユーザープロファイルページにマイクロポストの一覧を挿入するところからアプリケーションコードの実装を始めることにしましょう。</p>

<div class="label" id="code-user_show_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.20</span> <span class="description">ユーザーの<code>show</code>画面にマイクロポストを追加する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  .
  .
  .
  <span class="nt">&lt;aside&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ol&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>すぐにもマイクロポスト一覧の実装に取りかかりますが、その前に注意すべき点がいくつかあります。<a class="ref" href="#code-user_show_microposts">リスト10.20</a>では、<code>if @user.microposts.any?</code>を使用することによって (以前<a class="ref" href="#code-errors_partial">リスト7.23</a>でも使用しました)  ユーザのマイクロポストが1つもない場合に空のリストが表示されないようにしています。</p>

<p><a class="ref" href="#code-user_show_microposts">リスト10.20</a>では、以下のようにマイクロポストに対するページネーションのコードを加えていたことにご注意ください。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="#code-will_paginate_index_view">リスト9.34</a>のユーザーインデックスページのコードと比較すると、以前は以下のように単純なコードでした。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>上のコードは引数なしで動作していました。これは<code>will_paginate</code>が、ユーザーコントローラのコンテキストにおいて、<code>@users</code>インスタンス変数が存在していることを<em>前提としている</em>ためです。このインスタンス変数は、<a class="ref" href="#sec-pagination">9.3.3</a>でも述べたように<code>ActiveRecord::Relation</code>クラスのインスタンスです。今回の場合は、ユーザーコントローラのコンテキストにおいて、<em>マイクロポスト</em>をページネーションしたいため、明示的に<code>@micropost</code>変数を<code> will_paginate</code>に渡す必要があります。もちろん、そのような変数をユーザー<code>show</code>アクションで定義しなければなりません(<a class="ref" href="#code-user_show_microposts_instance">リスト10.22</a>)。</p>

<p>最後に、以下のようにマイクロポストの現在の数のカウントを追加します。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;h3&gt;</span>Microposts (<span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>)<span class="nt">&lt;/h3&gt;</span>
</pre></div>
</div>


<p>前述のように、<code>@user.microposts.count</code>は、ユーザ/マイクロポスト関連付けを経由して、あるユーザーに属するマイクロポストをカウントすることを除けば、<code>User.count</code>に似ています。</p>

<p>やっとマイクロポスト一覧のコードそのものにたどり着きました。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ol&gt;</span>
</pre></div>
</div>


<p>この<em>順序リスト</em>タグ<code>ol</code>を含むコードがマイクロポストの一覧を生成します。ただしご覧のとおり、実装の厄介な部分をマイクロポストパーシャルに任せています。<a class="ref" href="#sec-partial_refactoring">9.3.4</a>で見た以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><code>_user.html.erb</code>パーシャルを使って自動的に<code>@users</code>変数内のそれぞれのユーザを出力します。同様に以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>まったく同じことをマイクロポストで行います。つまり、<a class="ref" href="#code-micropost_partial">リスト10.21</a>に示すように、<code>_micropost.html.erb</code>パーシャルを (<code>micropost</code>用のビューのディレクトリの中に) 定義しなければならないことを意味します。</p>

<div class="label" id="code-micropost_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.21</span> <span class="description">1つのマイクロポストを表示するパーシャル。</span><br /><span class="description"> <code>app/views/microposts/_micropost.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>詳細は<a class="ref" href="#sec-sample_microposts">10.2.2</a>で述べますが、上のコードでは素晴らしい<code>time_ago_in_words</code>ヘルパーメソッドを使用しています。</p>

<p>これまでのところ、関連するERbテンプレートをすべて定義したにもかかわらず、<a class="ref" href="#code-user_show_microposts_test">リスト10.19</a>のテストは、たった１つ、<code>@microposts</code>変数がないために失敗していたはずです。<a class="ref" href="#code-user_show_microposts_instance">リスト10.22</a>のように変更することで、テストにパスさせることができます。</p>

<div class="label" id="code-user_show_microposts_instance"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.22</span> <span class="description"><code>@microposts</code>インスタンス変数をユーザー<code>show</code>アクションに追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>paginate</code>メソッドの素晴らしさにご注目ください。マイクロポストの関連付けを経由して<tt>micropost</tt>テーブルに到達し、必要なマイクロポストのページを引き出してくれます。</p>

<p>ここで、今作成した新しいユーザープロファイルページ (<a class="ref" href="#fig-user_profile_no_microposts">図10.5</a>) をブラウザで見てみましょう。...何というさみしいページ、がっかりですね。もちろん、これはマイクロポストが1つもないのが原因です。いよいよマイクロポストを追加しましょう。</p>

<div class="label" id="fig-user_profile_no_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_no_microposts_bootstrap.png" alt="user_profile_no_microposts_bootstrap" /></span></div><div class="caption"><span class="header">図10.5</span><span class="description">マイクロポスト用のコードのあるユーザープロファイルページ (ただしマイクロポストがない)。<a href="http://railstutorial.org/images/figures/user_profile_no_microposts_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-sample_microposts"></div>


<h3><a id="sec-10_2_2" href="#sec-sample_microposts" class="heading"><span class="number">10.2.2</span>マイクロポストのサンプル</a></h3>


<p><a class="ref" href="#sec-augmenting_the_user_show_page">10.2.1</a>のユーザーマイクロポストのテンプレート作成作業の成果は、何とも拍子抜けでした。<a class="ref" href="#sec-sample_users">9.3.2</a>のサンプル生成にマイクロポストを追加し、この情けない状況を修正しましょう。<em>すべて</em>のユーザーにサンプルマイクロポストを追加しようとすると時間がかかりすぎるので、最初の6人のユーザー<sup class="footnote" id="fnref-10_4"><a href="#fn-10_4">4</a></sup>だけを選択しましょう。そのためには、<code>User.all</code>メソッドに<code>limit</code>オプションを渡します<sup class="footnote" id="fnref-10_5"><a href="#fn-10_5">5</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>


<p>その後、各ユーザーに50のマイクロポスト (ページネーションが切り替わる30を超える数) を作成し、Faker gem の便利な <tt>Lorem.sentence</tt><a href="http://faker.rubyforge.org/rdoc/classes/Faker/Lorem.html"></a>メソッドを使って各マイクロポストのサンプルコンテンツを生成します (<code>Faker::Lorem.sentence</code>は、いわゆる<em>lorem ipsum</em>ダミーテキストを返します。<a class="ref" href="#cha-modeling-users">第6章</a>で述べたように、<em>lorem ipsum</em>には面白い<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">裏話</a>があります)。 変更の結果は、<a class="ref" href="#code-sample_microposts">リスト10.23</a>のようなサンプルデータ生成になります。</p>

<div class="label" id="code-sample_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.23</span> <span class="description">サンプルデータにマイクロポスト用のコードを追加する。</span><br /><span class="description"> <code>lib/tasks/sample_data.rake</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
    <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">content</span> <span class="o">=</span> <span class="ss">Faker::Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>もちろん、新しいサンプルデータを生成するためにはRakeタスクの<code>db:populate</code>を実行する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>とうとう、<a class="ref" href="#sec-augmenting_the_user_show_page">10.2.1</a>の地道な作業が、それぞれのマイクロポストの情報を表示することによって報われはじめました<sup class="footnote" id="fnref-10_6"><a href="#fn-10_6">6</a></sup>。実行結果を<a class="ref" href="#fig-user_profile_microposts_no_styling">図10.6</a>に示します。</p>

<div class="label" id="fig-user_profile_microposts_no_styling"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_microposts_no_styling_bootstrap.png" alt="user_profile_microposts_no_styling_bootstrap" /></span></div><div class="caption"><span class="header">図10.6</span><span class="description">ユーザプロファイル (<a href="http://localhost:3000/users/1">/users/1</a>) とスタイルのないマイクロポスト <a href="http://railstutorial.org/images/figures/user_profile_microposts_no_styling_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="#fig-user_profile_microposts_no_styling">図10.6</a>のページにはマイクロポスト固有のスタイルが与えられていないので、<a class="ref" href="#code-micropost_css">リスト10.24</a>を追加して、結果のページを見てみましょう<sup class="footnote" id="fnref-10_7"><a href="#fn-10_7">7</a></sup>。<a class="ref" href="#fig-user_profile_with_microposts">図10.7</a>が1番目の (ログインした) ユーザのプロファイルページで、<a class="ref" href="#fig-other_profile_with_microposts">図 10.8</a>が2番目のユーザのプロファイルページです。最後に<a class="ref" href="#fig-user_profile_microposts_page_2_rails_3">図10.9</a>は、1番目のユーザーのためのマイクロポストの<em>2番目</em>のページと、下部に改ページのリンクを表示しています。各マイクロポストの表示には、3つのどの場合にも、それが作成されてからの時間 (&quot;1分​​前に投稿&quot; など) が表示されていることにご注目ください。これは<a class="ref" href="#code-micropost_partial">リスト10.21</a>の<code>time_ago_in_words</code>メソッドによるものです。数分待ってからページを再度読み込むと、このテキストは自動的に新しい時間に基づいて更新されます。</p>

<div class="label" id="code-micropost_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.24</span> <span class="description">マイクロポスト用のCSS (この章全般にわたって使用するCSSも含む)</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">microposts</span> <span class="o">*/</span>

<span class="nc">.microposts</span> <span class="p">{</span>
  <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
  <span class="na">margin</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">;</span>

  <span class="nt">li</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#e8e8e8</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.content</span> <span class="p">{</span>
  <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.timestamp</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="nv">$grayLight</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">textarea</span> <span class="p">{</span>
    <span class="na">height</span><span class="o">:</span> <span class="mi">100</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-user_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_with_microposts_bootstrap.png" alt="user_profile_with_microposts_bootstrap" /></span></div><div class="caption"><span class="header">図10.7</span><span class="description">ユーザプロファイル (<a href="http://localhost:3000/users/1">/users/1</a>) とマイクロポスト。<a href="http://railstutorial.org/images/figures/user_profile_with_microposts_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-other_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/other_profile_with_microposts_bootstrap.png" alt="other_profile_with_microposts_bootstrap" /></span></div><div class="caption"><span class="header">図10.8</span><span class="description">別ユーザのプロファイルとマイクロポスト (<a href="http://localhost:3000/users/5">/users/5</a>)。<a href="http://railstutorial.org/images/figures/other_profile_with_microposts_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-user_profile_microposts_page_2_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_microposts_page_2_rails_3_bootstrap.png" alt="user_profile_microposts_page_2_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">図10.9: </span><span class="description">マイクロポストのページネーション用リンク (<a href="http://localhost:3000/users/1?page=2">/users/1?</a></span><span class="description"><a href="http://localhost:3000/users/1?page=2">page=2</a>)。<a href="http://railstutorial.org/images/figures/user_profile_microposts_page_2_rails_3_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-manipulating_microposts"></div>


<h2><a id="sec-10_3" href="#sec-manipulating_microposts" class="heading"><span class="number">10.3</span>マイクロポストを操作する</a></h2>


<p>データモデリングとマイクロポスト表示テンプレートの両方が完成したので、次はWeb経由でそれらを作成するためのインターフェイスに取りかかりましょう。HTMLフォームを使用してリソース (今回の場合はMicropostsリソース) を作成する3番目の例になります<sup class="footnote" id="fnref-10_8"><a href="#fn-10_8">8</a></sup>。この節では、<em>ステータスフィード</em>(<a class="ref" href="#cha-following-users">第11章</a>で完成させます) の最初のヒントをお見せします。最後に、ユーザーがマイクロポストをWeb経由で破棄できるようにします。</p>

<p>従来のRails開発の慣習と異なる箇所が1つあります。Micropostsリソースへのインターフェースは、主にユーザーと静的ページのコントローラを経由して実行されるので、Micropostsコントローラには<code>new</code>や<code>edit</code>のようなアクションは不要ということになります。<code>create</code>と<code>destroy</code>があれば十分です。従って、<a class="ref" href="#code-microposts_resource">リスト10.25</a>に示すように、Micropostsリソースへのルーティングは一層シンプルになります。その結果、<a class="ref" href="#code-microposts_resource">リスト10.25</a>のコードは、フルセットのルーティング (<a class="ref" href="#table-demo_RESTful_microposts">表2.3</a>) のサブセットであるRESTfulルート (<a class="ref" href="#table-RESTful_microposts">表10.2</a>) になります。もちろん、シンプルになったということは完成度が<em>さらに</em>高まったということの証しであり、退化したわけではありません。<a class="ref" href="#cha-a-demo-app">第2章</a>でscaffoldに頼りきりだった頃からここに至るまでは長い道のりでしたが、今ではscaffoldが生成するような複雑なコードのほとんどは不要になりました。</p>

<div class="label" id="code-microposts_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.25</span> <span class="description">Micropostsリソース用のルーティング。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>   <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="table-RESTful_microposts"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTPリクエスト</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>POST</tt></td><td class="align_left">/microposts</td><td class="align_left"><code>create</code></td><td class="align_left">新しいマイクロポストを作る</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/microposts/1</td><td class="align_left"><code>destroy</code></td><td class="align_left">id<code>1</code>のマイクロポストを削除する</td></tr></table></div><div class="caption"><span class="header">表10.2: </span><span class="description">Micropostsリソースが提供する<a class="ref" href="#code-microposts_resource">リスト10.25</a>のRESTfulルート。</span></div></div>




<div class="label" id="sec-access_control"></div>


<h3><a id="sec-10_3_1" href="#sec-access_control" class="heading"><span class="number">10.3.1</span>アクセス制御</a></h3>


<p>Micropostsリソースの開発の手始めは、Micropostsコントローラ内のアクセス制御から始めることにしましょう。ここでのアクセス制御のポイントは単純です。<code>create</code>アクションと<code>destory</code>アクションは、いずれもユーザがサインインしていなければ実行できないものとします。これをテストするためのRSpecコードを<a class="ref" href="#code-micropost_access_control">リスト10.26</a>に示します (マイクロポストをポストしたユーザーだけが削除できるようにする3番目の保護は<a class="ref" href="#sec-destroying_microposts">10.3.4</a>で追加します)。</p>

<div class="label" id="code-micropost_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.26</span> <span class="description">マイクロポスト用のアクセス制御テスト。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Microposts controller&quot;</span> <span class="k">do</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the create action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">microposts_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the destroy action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">micropost_path</span><span class="p">(</span><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">))</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>未制作のマイクロポストのWebインターフェースと違い、<a class="ref" href="#code-micropost_access_control">リスト10.26</a>のコードは、<a class="ref" href="#code-edit_update_wrong_user_tests">リスト9.14</a>のときの手法と同様に、それぞれのマイクロポストアクションのレベルで動作します。サインインしていないユーザは、<tt>POST</tt>リクエストを/microposts (<code>post microposts_path</code>、<code>create</code>アクションが呼び出される) に送信した場合、または <tt>DELETE</tt>リクエストを/microposts/1 (<code>delete micropost_path(micropost)</code>、<code>destroy</code>アクションが呼び出される) に送信した場合にリダイレクトされます。</p>

<p><a class="ref" href="#code-micropost_access_control">リスト10.26</a>のテストにパスするためのアプリケーションコードを作成する前に、少しリファクタリングを行いましょう。 <a class="ref" href="#sec-requiring_signed_in_users">9.2.1</a>では、<code>signed_in_user</code>メソッドと呼ばれるbefore_filterを使用して、サインインを必須にしたことを思い出してください (<a class="ref" href="#code-authorize_before_filter">リスト9.12</a>)。そのときは、このメソッドをUsersコントローラ
でしか使用しませんでしたが、今回はMicropostsコントローラでもこのメソッドが必要となることがわかったので、<a class="ref" href="#code-sessions_helper_authenticate">リスト10.27</a>に示すように、セッションヘルパーに移動します<sup class="footnote" id="fnref-10_9"><a href="#fn-10_9">9</a></sup>。</p>

<div class="label" id="code-sessions_helper_authenticate"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.27</span> <span class="description"><code>signed_in_user</code>メソッドをセッッションヘルパーに移動する。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in_user</span>
    <span class="k">unless</span> <span class="n">signed_in?</span>
      <span class="n">store_location</span>
      <span class="n">redirect_to</span> <span class="n">signin_url</span><span class="p">,</span> <span class="ss">notice:</span> <span class="s2">&quot;Please sign in.&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>コードが重複しないよう、<code>signed_in_user</code>をUsersコントローラからも削除しておきましょう。</p>

<p><a class="ref" href="#code-sessions_helper_authenticate">リスト10.27</a>のコードにより、<code>signed_in_user</code>メソッドがMicropostsコントローラで利用可能になりました。これにより、<a class="ref" href="#code-microposts_controller_access_control">リスト10.28</a> で示すように<code>create</code>アクション と<code>destroy</code>アクションに対してbefore_filterを使用してアクセス制限をかけることが可能になりました (注意: Micropostsコントローラファイルをコマンドラインで生成していなかったので、このコントローラを手動で作成する必要があります)。</p>

<div class="label" id="code-microposts_controller_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.28</span> <span class="description">Micropostsコントローラのアクションに認証を追加する。</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>before_filterはデフォルトで両方のアクションに適用されるため、制限を適用するアクションを明示していないことにご注意ください。もし仮に<code>index</code>アクションを追加し、サインインしていないユーザでもアクセス可能にしたい場合は、以下のようにindexアクション以外のアクションを明示的に指定する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>これでテストにパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb
</pre></div>
</div>




<div class="label" id="sec-creating_microposts"></div>


<h3><a id="sec-10_3_2" href="#sec-creating_microposts" class="heading"><span class="number">10.3.2</span>マイクロポストを作成する</a></h3>


<p><a class="ref" href="#cha-sign-up">第7章</a>では、HTTP <tt>POST</tt>リクエストをUsersコントローラの<code>create</code>アクションに発行するHTMLフォームを作成することで、ユーザーのサインアップを実装しました。マイクロポスト作成の実装もこれと似ています。主な違いは、別の micropost/new ページを使う代わりに、(Twitterに習って) ホームページ自体 (つまりルートパス) にフォームを置くという点です (<a class="ref" href="#fig-home_page_with_micropost_form_mockup">図10.10</a>のモックアップ参照)。</p>

<div class="label" id="fig-home_page_with_micropost_form_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_micropost_form_mockup_bootstrap.png" alt="home_page_with_micropost_form_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図10.10</span><span class="description">マイクロポスト作成フォームのあるホームページのモックアップ。<a href="http://railstutorial.org/images/figures/home_page_with_micropost_form_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>最後にホームページを実装したときは(<a class="ref" href="#fig-sample_app_logo">図5.6</a>)、[Sign up now!] ボタンが中央にありました。マイクロポスト作成フォームは、サインインしている特定のユーザーのコンテキストでのみ機能するので、この節の一つの目標は、ユーザーのサインインの状態に応じて、ホームページの表示を変更することです。実装は<a class="ref" href="#code-microposts_home_page">リスト10.31</a>で行いますが、先にテストを作成しましょう。Usersリソースの場合と同様に、結合テストを使用します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test micropost_pages
</pre></div>
</div>


<p>従って、マイクロポスト作成のテストは、<a class="ref" href="#code-basic_signup_tests">リスト7.16</a>のユーザー作成用テストと似ています。このテストを<a class="ref" href="#code-microposts_create_tests">リスト10.29</a>に示します。</p>

<div class="label" id="code-microposts_create_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.29</span> <span class="description">マイクロポスト作成のテスト。</span><br /><span class="description"> <code>spec/requests/micropost_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Micropost pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;micropost creation&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not create a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;error messages&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span> 
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>

      <span class="n">before</span> <span class="p">{</span> <span class="n">fill_in</span> <span class="s1">&#39;micropost_content&#39;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;Lorem ipsum&quot;</span> <span class="p">}</span>
      <span class="n">it</span> <span class="s2">&quot;should create a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Post&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>マイクロポストの<code>create</code>アクションのテストを作り始めましょう。このテストは、<a class="ref" href="#code-user_create_action">リスト7.25</a>のユーザー用テストと似ています。違いは、新しいマイクロポストを<code>build</code>するためにuser/micropost関連付けを使用している点です (<a class="ref" href="#code-microposts_create_action">リスト10.30</a>)。</p>

<div class="label" id="code-microposts_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.30</span> <span class="description">Micropostsコントローラの<code>create</code>アクション。</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;static_pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>マイクロポスト作成フォームを構築するために、サイト訪問者がサインインしているかどうかに応じて異なるHTMLを提供するコードを使用します (<a class="ref" href="#code-microposts_home_page">リスト10.31</a>)。</p>

<div class="label" id="code-microposts_home_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.31</span> <span class="description">ホームページ (<a href="http://localhost:3000/">/</a>) にマイクロポスト作成を追加する。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/user_info&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/micropost_form&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;/div&gt;</span>  
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;center hero-unit&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Welcome to the Sample App<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;h2&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/h2&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> 
                                <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;rails.png&quot;</span><span class="p">,</span> <span class="ss">alt:</span> <span class="s2">&quot;Rails&quot;</span><span class="p">),</span> <span class="s1">&#39;http://rubyonrails.org/&#39;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span> 
</pre></div>
</div></div>


<p> <code>if</code>-<code>else</code>分岐を使用してそれぞれにコードを書いているのが少し汚いですが、このコードのクリーンアップは演習に回すことにします (<a class="ref" href="#sec-micropost_exercises">10.5</a>)。なお、<a class="ref" href="#code-microposts_home_page">リスト10.31</a>パーシャルの実装は必須なので、演習にはしません。新しいHomeページのサイドバーは<a class="ref" href="#code-user_info">リスト10.32</a>で、
マイクロポストフォームのパーシャルは<a class="ref" href="#code-micropost_form">リスト10.33</a>で実装します。</p>

<div class="label" id="code-user_info"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.32</span> <span class="description">ユーザー情報サイドバーのパーシャル。</span><br /><span class="description"> <code>app/views/shared/_user_info.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">52</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;view my profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;micropost&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/span&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-user_index_view">リスト9.25</a>と同様、<a class="ref" href="#code-user_info">リスト10.32</a>のコードでも<a class="ref" href="#code-gravatar_option">リスト7.29</a>で定義した<code>gravatar_for</code>ヘルパーを使用します。</p>

<p>プロファイルサイドバー (<a class="ref" href="#code-user_show_microposts">リスト10.20</a>) のときと同様、<a class="ref" href="#code-user_info">リスト10.32</a>のユーザー情報にも、そのユーザーが投稿したマイクロポストの総数が表示されていることにご注目ください。ただし少し表示に違いがあります。プロファイルサイドバーでは “Microposts” がラベルで、“Microposts (1)” と表示することは問題ありません。しかし今回のように “1 microposts” と表示してしまうと英語の文法上誤りになってしまうので、<code>pluralize</code>メソッドを使用して “1 micropost” や “2 microposts” と表示するように調整します。</p>

<p>次はマイクロポスト作成フォームを定義します (<a class="ref" href="#code-micropost_form">リスト10.33</a>)。これはユーザー登録フォームに似ています (<a class="ref" href="#code-signup_form">リスト7.17</a>)。</p>

<div class="label" id="code-micropost_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.33</span> <span class="description">マイクロポスト作成フォームのパーシャル。</span><br /><span class="description"> <code>app/views/shared/_micropost_form.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">placeholder:</span> <span class="s2">&quot;Compose new micropost...&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Post&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-micropost_form">リスト10.33</a>のフォームが動くようにするためには、2箇所の変更が必要です。1つは、(以前と同様) 関連付けを使用して以下のように<code>@micropost</code>を定義することです。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>変更の結果を<a class="ref" href="#code-micropost_instance_variable">リスト10.34</a>に示します。</p>

<div class="label" id="code-micropost_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.34</span> <span class="description"><code>home</code>アクションにマイクロポストのインスタンス変数を追加する。</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span> <span class="k">if</span> <span class="n">signed_in?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-micropost_instance_variable">リスト10.34</a>のコードは、ユーザーへのサインイン要求を実装し忘れた場合に、テストが失敗して知らせてくれるので助かります。</p>

<p><a class="ref" href="#code-micropost_form">リスト10.33</a>を動かすための第2の変更は、以下のようにエラーメッセージパーシャルを再定義することです。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="#code-f_error_messages">リスト7.22</a>ではエラーメッセージパーシャルが<code>@user</code>変数を直接参照していたことを思い出してください。今回は代わりに<code>@micropost</code>変数を使う必要があります。どのような種類のオブジェクトが渡されてもエラーメッセージパーシャルが動くようにする必要があります。幸い、フォーム変数<code>f</code>は<code>f.object</code>とすることによって、関連付けられたオブジェクトにアクセスすることができます。従って、以下のコードの場合</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p><code>f.object</code>は<code>@user</code>となり、以下のコードの場合は</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@micropost</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</pre></div>
</div>


<p><code>f.object</code>は<code>@micropost</code>となります。</p>

<p>パーシャルにオブジェクトを渡すために、値がオブジェクトで、キーがパーシャルでの変数名と同じハッシュを利用します。これで、以下のコードが完成します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>言い換えると、<code>object: f.object</code>は<code>error_messages</code>パーシャルの中で<code>object</code>という変数名を作成します。<a class="ref" href="#code-updated_error_messages_partial">リスト10.35</a>に示すように、このobject変数を使用してカスタマイズエラーメッセージを作成できます。</p>

<div class="label" id="code-updated_error_messages_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.35</span> <span class="description">他のオブジェクトでも動作するように<a class="ref" href="#code-errors_partial">リスト7.23</a>のエラーメッセージパーシャルを更新する。</span><br /><span class="description"> <code>app/views/shared/_error_messages.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>この時点で、<a class="ref" href="#code-microposts_create_tests">リスト10.29</a>のテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/micropost_pages_spec.rb
</pre></div>
</div>


<p>運悪く、サインアップと編集フォームが古いバージョンのメッセージパーシャルを利用しているため、Userのrequest specが壊れてしまいました。これを修正するために、<a class="ref" href="#code-signup_errors_updated">リスト10.36</a>および<a class="ref" href="#code-edit_errors_updated">リスト10.37</a>で示すように、これらのフォームをより汎用的なバージョンに更新します。(<em>メモ</em>: もし<a class="ref" href="#sec-updating_deleting_exercises">9.6</a>の演習のコードを「<a href="http://en.wikipedia.org/wiki/Mutatis_mutandis"><em>必要に応じて流用 (Mutatis mutandis)</em></a>」して<a class="ref" href="#code-new_edit_partial">リスト9.50</a>および<a class="ref" href="#code-new_user_with_partial">リスト9.51</a>のコードを実装していた場合、コードは異なるものになるでしょう。)</p>

<div class="label" id="code-signup_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.36</span> <span class="description">ユーザーサインアップエラーの表示を更新する。</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-edit_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.37</span> <span class="description">ユーザー編集のエラーを更新する。</span><br /><span class="description"> <code>app/views/users/edit.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span> 
<span class="nt">&lt;h1&gt;</span>Update your profile<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">object:</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://gravatar.com/emails&quot;</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>この時点で、すべてのテストがパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>さらに、この章で作成したすべてのHTMLが適切に表示されるようになったはずです。最終的なフォームを<a class="ref" href="#fig-home_with_form">図10.11</a>に、投稿エラーが表示されたフォームを<a class="ref" href="#fig-home_form_errors">図10.12</a>に示します。この時点で、新しい投稿を自分自身で作成し、すべてが正しく動いていることを確認することもできます。ただし、できれば<a class="ref" href="#sec-a_proto_feed">10.3.3</a>が終わるまで待ってください。</p>

<div class="label" id="fig-home_with_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_with_form_bootstrap.png" alt="home_with_form_bootstrap" /></span></div><div class="caption"><span class="header">図10.11</span><span class="description">新しいマイクロポストフォームのあるホームページ (<a href="http://localhost:3000/">/</a>)。<a href="http://railstutorial.org/images/figures/home_with_form_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-home_form_errors"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_form_errors_bootstrap.png" alt="home_form_errors_bootstrap" /></span></div><div class="caption"><span class="header">図10.12</span><span class="description">エラーのあるホームページ。<a href="http://railstutorial.org/images/figures/home_form_errors_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-a_proto_feed"></div>


<h3><a id="sec-10_3_3" href="#sec-a_proto_feed" class="heading"><span class="number">10.3.3</span>フィードの原型</a></h3>


<p><a class="ref" href="#sec-creating_microposts">10.3.2</a>の最後のコメントでもほのめかしましたが、現在のHomeページはマイクロポストが1つも表示されていません。<a class="ref" href="#fig-home_with_form">図10.11</a>のフォームが正しく動作しているかどうかを確認したい場合、正しいエントリーを投稿した後、<a href="http://localhost:3000/users/1">プロファイルページ</a>に移動してポストを表示すればよいのですが、これはかなり面倒な作業です。 <a class="ref" href="#fig-proto_feed_mockup">図10.13</a>のモックアップで示したような、ユーザー自身のポストを含むマイクロポスト<em>フィード</em>がないと不便です (<a class="ref" href="#cha-following-users">第11章</a>ではフィードを汎用化し、現在のユーザによって<em>フォローされている</em>ユーザのマイクロポストも一緒に表示するフィードにする予定です)。</p>

<div class="label" id="fig-proto_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/proto_feed_mockup_bootstrap.png" alt="proto_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図10.13</span><span class="description"> (プロト)フィードのあるホームページのモックアップ。<a href="http://railstutorial.org/images/figures/proto_feed_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>すべてのユーザがフィードを持つので、<code>feed</code>メソッドはUserモデルに作るのが自然です。最終的にはそのfeedメソッドが、フォローしているユーザのマイクロポストも返すことをテストしますが、今は、<code>feed</code>メソッドが自分のマイクロポストは<em>含むが</em>他ユーザのマイクポストは<em>含まない</em>ことをテストすることにします。その要件をコード化したものを<a class="ref" href="#code-feed_specs">リスト10.38</a>に示します。</p>

<div class="label" id="code-feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.38</span> <span class="description">(プロト) ステータスフィードのテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;status&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストでは、与えられた要素が配列に含まれているかどうかをチェックする<code>include?</code>メソッドを使用しています<sup class="footnote" id="fnref-10_10"><a href="#fn-10_10">10</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">foo&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:bar</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;</span><span class="s2">baz&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>上の例は、RSpecの論理値変換機能の柔軟性がきわめて高いことを示しています。<code>include</code>メソッドは本来、モジュールをインクルードするために使用するRubyキーワードであるにもかかわらず (<a class="ref" href="#code-sessions_helper_include">リスト8.14</a>など)、このRSpecのコンテキストでは配列が要素を含んでいるかどうかをテストしたいという開発者の意図を正確に推測してくれます。</p>

<p><a class="ref" href="#code-proto_status_feed">リスト10.39</a>で示すように、<code>user_id</code>が現在のユーザーidと等しいマイクロポストを見つけることによって、適切なマイクロポストの<code>feed</code>メソッドを実装することができます。これは<code>Micropost</code>モデルで<code>where</code>メソッドを使用することで実現できます<sup class="footnote" id="fnref-10_11"><a href="#fn-10_11">11</a></sup>。</p>

<div class="label" id="code-proto_status_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.39</span> <span class="description">マイクロポストステータスフィードの実装を準備する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="c1"># このコードは準備段階です。
    # </span><span class="c1">完全な実装は第11章「ユーザーをフォローする」を参照してください。</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>以下のコードで使用されている疑問符は、セキュリティ上重要な役割を果たしています。</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>上の疑問符があることで、SQLクエリにインクルードされる前に<code>id</code>が適切に<em>エスケープ</em>されることを保証してくれるため、<a href="http://en.wikipedia.org/wiki/SQL_injection"><em>SQLインジェクション</em></a>と呼ばれる深刻なセキュリティホールを避けることができます。この場合の<code>id</code>属性は単なる整数であるため危険はありませんが、SQL文にインクルードされる変数を<em>常に</em>エスケープする習慣はぜひ身につけてください。</p>

<p>注意深い読者は、<a class="ref" href="#code-proto_status_feed">リスト10.39</a>のコードは本質的に以下のコードと等しいことに気付くかもしれません。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードを使用せずに<a class="ref" href="#code-proto_status_feed">リスト10.39</a>のコードを利用したのは、<a class="ref" href="#cha-following-users">第11章</a>で必要となるフルステータスフィードで応用が効くためです。</p>

<p>ステータスフィードの表示をテストするために、まずいくつかのマイクロポストを作成し、それぞれのページに表示されるリスト要素 (<code>li</code>)を検証します(<a class="ref" href="#code-home_page_feed_test">リスト10.40</a>)。</p>

<div class="label" id="code-home_page_feed_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.40</span> <span class="description">ホームページのフィード表示をテストする。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Static pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Dolor sit amet&quot;</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the user&#39;s feed&quot;</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-home_page_feed_test">リスト10.40</a>のコードでは、以下のように各フィード項目が固有のCSS idを持つことを前提にしています。</p>

<div class="code"><div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>


<p>それにより、上のコードが各アイテムに対してマッチするようにするのが目的です (<code>li##{item.id}</code>の最初の<code>#</code> は CSS idを示す Capybara独自の文法で、2番目の<code>#</code>は Rubyの式展開<code>#{}</code>の先頭部分であることにご注意ください)。</p>

<p>サンプルアプリケーションでフィードを使うために、カレントユーザーの (ページネーション) フィードに<code>@feed_items</code>インスタンス変数を追加し (<a class="ref" href="#code-feed_instance_variable">リスト10.41</a>)、それからフィードパーシャル(<a class="ref" href="#code-feed_partial">リスト10.42</a>)をHomeページに追加します (<a class="ref" href="#code-home_with_feed">リスト10.44</a>)。(ページネーションのテストは演習に回すことにします。<a class="ref" href="#sec-micropost_exercises">10.5</a>参照。)</p>

<div class="label" id="code-feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.41</span> <span class="description"><code>home</code>アクションにフィードのインスタンス変数を追加する。</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-feed_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.42</span> <span class="description">ステータスフィードのパーシャル。</span><br /><span class="description"> <code>app/views/shared/_feed.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ol</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ol&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>ステータスフィードのパーシャルは以下のコードを使うという点で、フィードアイテムのパーシャルに表示されるフィードアイテムと異なります。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">partial:</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">collection:</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>ここでは、フィードアイテムとして<code>:collection</code>パラメーターを渡しているので、<code>render</code>はコレクションの各アイテムを表示するために与えられたパーシャル (この場合は<code>’feed_item’</code>)を使用してくれます。(以前の表示では、<code>render ’shared/micropost’</code>のように<code>:partial</code>パラメーターを省略していましたが、<code>:collection</code>パラメーターがある場合はこの記法では正常に動作しません。) フィードアイテムのパーシャルを<a class="ref" href="#code-feed_item_partial">リスト10.43</a>に示します。</p>

<div class="label" id="code-feed_item_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.43</span> <span class="description">単一のフィードアイテム用のパーシャル</span><br /><span class="description"> <code>app/views/shared/_feed_item.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-feed_item_partial">リスト10.43</a>は、以下のコードを使用して各フィードにCSS idも追加します。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>これは<a class="ref" href="#code-home_page_feed_test">リスト10.40</a>のテストで要求されていたものです。</p>

<p>後は、いつものようにフィードパーシャルを表示すればHomeページにフィードを追加できます (<a class="ref" href="#code-home_with_feed">リスト10.44</a>)。この結果はホームページのフィードとして表示されます (<a class="ref" href="#fig-home_with_proto_feed">図10.14</a>)。</p>

<div class="label" id="code-home_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.44</span> <span class="description">Homeページにステータスフィードを追加する。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
    .
    .
    .
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h3&gt;</span>Micropost Feed<span class="nt">&lt;/h3&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/feed&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig-home_with_proto_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_with_proto_feed_bootstrap.png" alt="home_with_proto_feed_bootstrap" /></span></div><div class="caption"><span class="header">図10.14</span><span class="description"> (プロト) フィードのあるホームページ(<a href="http://localhost:3000/">/</a>)。<a href="http://railstutorial.org/images/figures/home_with_proto_feed-full.png">(拡大)</a></span></div></div>


<p>現時点では、新しいマイクロポストの作成は<a class="ref" href="#fig-micropost_created">図10.15</a>で示したように期待どおりに動作しています。ただしささいなことではありますが、マイクロポストの投稿が<em>失敗する</em>と、 Homeページは<code>@feed_items</code>インスタンス変数を期待しているため、現状では壊れてしまいます (このことはテストスイートを実行して確認できます)。最も簡単な解決方法は、<a class="ref" href="#code-microposts_create_action_with_feed">リスト10.45</a>のように空の配列を渡しておくことです<sup class="footnote" id="fnref-10_12"><a href="#fn-10_12">12</a></sup>。</p>

<div class="label" id="fig-micropost_created"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_created_bootstrap.png" alt="micropost_created_bootstrap" /></span></div><div class="caption"><span class="header">図10.15</span><span class="description">新しいマイクロポストを作成後のHomeページ。<a href="http://railstutorial.org/images/figures/micropost_created_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="code-microposts_create_action_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.45</span> <span class="description"><code>create</code>アクションに (空の) <code>@feed_items</code>インスタンス変数を追加する。</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span>
    <span class="k">else</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">render</span> <span class="s1">&#39;static_pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で、(プロト)フィードとそのテストはすべて動くはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-destroying_microposts"></div>


<h3><a id="sec-10_3_4" href="#sec-destroying_microposts" class="heading"><span class="number">10.3.4</span>マイクロポストを削除する</a></h3>


<p>最後の機能として、マイクロポストリソースにポストを削除する機能を追加します。これはユーザ削除と同様に(<a class="ref" href="#sec-the_destroy_action">9.4.2</a>)、&quot;delete&quot; リンクで実現します (<a class="ref" href="#fig-micropost_delete_links_mockup">図10.16</a>)。ユーザーの削除は管理者ユーザのみが行えるように制限されていたのに対し、今回の場合はカレントユーザーが作成したマイクロポストに対してのみ削除リンクが動作するようにします。</p>

<div class="label" id="fig-micropost_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_delete_links_mockup_bootstrap.png" alt="micropost_delete_links_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図10.16</span><span class="description">マイクロポストの削除リンクと (プロト) フィードのモックアップ。<a href="http://railstutorial.org/images/figures/micropost_delete_links_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>最初のステップとして、<a class="ref" href="#code-feed_item_partial">リスト10.43</a>のマイクロポストパーシャルに削除リンクを追加します。同様に、<a class="ref" href="#code-feed_item_partial">リスト10.43</a>のフィードアイテムパーシャルにリンクを追加します。追加の結果を<a class="ref" href="#code-micropost_partial_with_delete">リスト10.46</a>および<a class="ref" href="#code-feed_item_partial_with_delete">リスト10.47</a>に示します (これら2つはほとんど同一です。重複コードの削除は演習に回すことにします (<a class="ref" href="#sec-micropost_exercises">10.5</a>))。</p>

<div class="label" id="code-micropost_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.46</span> <span class="description">マイクロポストパーシャルに削除リンクを追加する。</span><br /><span class="description"> <code>app/views/microposts/_micropost.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
    Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
  <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-feed_item_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.47</span> <span class="description">フィードアイテムパーシャルに削除リンクを追加する。</span><br /><span class="description"> <code>app/views/shared/_feed_item.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">id</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">data:</span> <span class="p">{</span> <span class="ss">confirm:</span> <span class="s2">&quot;You sure?&quot;</span> <span class="p">},</span>
                                     <span class="ss">title:</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>マイクロポスト削除をテストするには、Capybaraを使用して &quot;delete&quot; リンクをクリックし、マイクロポストのカウントが1減っていることを確認します (<a class="ref" href="#code-micropost_destroy_specs">リスト10.48</a>)。</p>

<div class="label" id="code-micropost_destroy_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.48</span> <span class="description">Micropostsコントローラの<code>destroy</code>アクションをテストする。</span><br /><span class="description"> <code>spec/requests/micropost_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Micropost pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost destruction&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;as correct user&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">root_path</span> <span class="p">}</span>

      <span class="n">it</span> <span class="s2">&quot;should delete a micropost&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;delete&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-admin_destroy_before_filter">リスト9.48</a>のユーザー用アプリケーションコードと似ていますが、最も大きく異なるのは、マイクロポストの場合は、カレントユーザーが実際に指定のidのマイクロポストを持っているのかをチェックするのに<code>admin_user</code> before_filterではなく、 <code>correct_user</code> before_filterを使用している点です。コードを<a class="ref" href="#code-microposts_destroy_action">リスト10.49</a>に示します。2番目に新しいポストを削除した場合の結果を<a class="ref" href="#fig-home_post_delete">図10.17</a>に示します。</p>

<div class="label" id="code-microposts_destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.49</span> <span class="description">マイクロポストコントローラの<code>destroy</code>アクション。</span><br /><span class="description"> <code>app/controllers/microposts_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span>   <span class="ss">only:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>correct_user</code> before_filterでは、マイクロポストを以下のように関連付けを<em>経由して</em>見つけていることにご注目ください。

</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>これによって、カレントユーザーに所属するマイクロポストだけが自動的に見つかることが保証されます。この場合、  <code>find</code>ではなく<code>find_by_id</code>を使用します。これは、前者ではマイクロポストがない場合に例外が発生しますが、後者は<code>nil</code>を返すためです。ところで、Rubyの例外処理に慣れている方なら、<code>correct_user</code>のフィルタを以下のように書くこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">correct_user</span>
  <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="k">rescue</span>
  <span class="n">redirect_to</span> <span class="n">root_url</span>
<span class="k">end</span>
</pre></div>
</div>


<p><code>Micropost</code>モデルを以下のように直接使用して<code>correct_user</code>フィルタを実装することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
<span class="n">redirect_to</span> <span class="n">root_url</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>上のコードは<a class="ref" href="#code-microposts_destroy_action">リスト10.49</a>のコードと同等だと思うかもしれませんが、<a href="http://www.rubyfocus.biz/">Wolfram Arnold</a>がブログ記事「<a href="http://www.rubyfocus.biz/blog/2011/06/15/access_control_101_in_rails_and_the_citibank-hack.html">RailsにおけるAccess Control 101とシティバンクでのハッキング事件</a> (英語)」で解説しているように、対象を探しだすときには常に関連付けを経由することをセキュリティの観点から強くお勧めいたします。</p>

<div class="label" id="fig-home_post_delete"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_post_delete_bootstrap.png" alt="home_post_delete_bootstrap" /></span></div><div class="caption"><span class="header">図10.17</span><span class="description">2番目に新しいマイクロポストを削除した後のユーザーHomeページ。<a href="http://railstutorial.org/images/figures/home_post_delete_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この節のコードで、Micropostモデルとインターフェイスが完成しました。すべてのテストがパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<h2><a id="sec-10_4" href="#sec-10_4" class="heading"><span class="number">10.4</span>最後に</a></h2>


<p>Micropostsリソースの追加によって、サンプルアプリケーションはほぼ完成に近づきました。残すところは、ユーザーをお互いにフォローするソーシャルレイヤーのみとなりました。<a class="ref" href="#cha-following-users">第11章</a>では、そのようなユーザー同士の関係 (リレーションシップ) をモデリングする方法を学び、それがステータスフィードにどのように関連するかを学びます。</p>

<p>Gitバージョン管理を使用している方は、次に進む前に変更をマージしてコミットすることを忘れないでください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add user microposts&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge user-microposts
<span class="gp">$</span> git push
</pre></div>
</div>


<p>この時点でHerokuにアプリをプッシュしてもよいでしょう。<code>microposts</code>テーブルを追加するためにデータモデルを変更したので、本番データベースをマイグレートする必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<div class="label" id="sec-micropost_exercises"></div>


<h2><a id="sec-10_5" href="#sec-micropost_exercises" class="heading"><span class="number">10.5</span>演習</a></h2>


<p>ここまでに数多くの題材を取り上げてきましたので、今やアプリケーションを拡張する方法は山ほどあります。以下は、その中のごくわずかに過ぎません。</p>

<ol>
<li>サイドバーのマイクロポストカウントのテストを追加してください。このとき、表示に単数形と複数形が正しく表示されているかどうかもテストしてください。</li>
<li>マイクロポストのページネーションのテストを追加してください。</li>
<li><code>if</code>-<code>else</code>文の2つの分岐に対して、それぞれ異なるパーシャルを使用するようにホームページをリファクタリングしてください。</li>
<li>削除リンクが、現在のユーザーによって作成されていないマイクロポストには表示されないことを確認するためのテストを作成してください。</li>
<li>パーシャルを使用して、<a class="ref" href="#code-micropost_partial_with_delete">リスト10.46</a>および<a class="ref" href="#code-feed_item_partial_with_delete">リスト10.47</a>から削除リンクの重複を削除してください。</li>
<li><a class="ref" href="#fig-long_word_micropost">図10.18</a>に示すように、非常に長い単語を入力するとレイアウトが崩れてしまいます。<a class="ref" href="#code-wrap">リスト10.50</a>で定義した<code>wrap</code>ヘルパーを使用して、この問題を修正してください。このとき、出力されたHTMLがRailsによってエスケープされるのを防ぐために<code>raw</code>メソッドを使用してください。また、クロスサイトスクリプティング (XSS) を防ぐために<code>sanitize</code>メソッドも使用してください。さらに、このコードでは<em>3項演算子</em> (<a class="ref" href="#sidebar-ternary_operator">コラム  10.1</a>) も使用してください。3項演算子は一見奇妙ですが、きわめて便利なものです。</li>
<li><strong>(チャレンジ)</strong> 入力できる残り文字数を140 文字からカウントダウンするためのJavaScriptをHomeページに追加してください。</li>
</ol>




<div class="label" id="sidebar-ternary_operator"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 10.1</span><span class="description">10種類の人々</span></span>
<p>この世には10種類の人々がいます。3項演算子を好きな人、嫌いな人、3項演算子を知らない人です。(もし3番目に該当したとしても、すぐそのカテゴリの人ではなくなりますので心配ご無用です。)</p>

<p>プログラミング経験を重ねるうちに、以下のような制御フローが最もよく使用される、ありふれたものであることはすぐにわかると思います。</p>

<pre class="verbatim">  if boolean? 
    何かをする
  else 
    別のことをする
end</pre>


<p>Rubyや他の言語 (C/C++、Perl、PHP、Javaなど) では、上のようなフローをよりコンパクトな<em>3項演算子</em>と呼ばれる表現で置き換えることができます (3つの部分から構成されるためそのように呼ばれます)。</p>

<pre class="verbatim">  boolean? ? 何かをする : 別のことをする</pre>


<p>また、3項演算子で代入文を置き換えることもできます。</p>

<pre class="verbatim">  if boolean?
    var = foo
  else 
    var = bar
end</pre>


<p>上のコードは以下のように1行で書けます。</p>

<pre class="verbatim">  var = boolean? ? foo : bar</pre>


<p>他に、関数の戻り値で使用することもよくあります。</p>

<pre class="verbatim">  def foo
    do_stuff
    boolean? ? &quot;bar&quot; : &quot;baz&quot;
end</pre>


<p>Rubyは暗黙的に関数の最後の式の値を返すので、ここでは<tt>foo</tt>メソッドは<tt>boolean?</tt>の値によって<tt>&quot;bar&quot;</tt>または<tt>&quot;baz&quot;</tt>を返します。この手法は<a class="ref" href="#code-wrap">リスト10.50</a>の最後の部分でも使用しています。</p>
</div>




<div class="label" id="fig-long_word_micropost"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/long_word_micropost_bootstrap.png" alt="long_word_micropost_bootstrap" /></span></div><div class="caption"><span class="header">図10.18</span><span class="description">非常に長い単語によって崩れたレイアウト。<a href="http://railstutorial.org/images/figures/long_word_micropost_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="code-wrap"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト10.50</span> <span class="description">長い単語をラップさせるヘルパー。</span><br /><span class="description"> <code>app/helpers/microposts_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MicropostsHelper</span>

  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sanitize</span><span class="p">(</span><span class="n">raw</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">wrap_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">wrap_long_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
      <span class="n">zero_width_space</span> <span class="o">=</span> <span class="s2">&quot;&amp;#8203;&quot;</span>
      <span class="n">regex</span> <span class="o">=</span> <span class="sr">/.{1,</span><span class="si">#{</span><span class="n">max_width</span><span class="si">}</span><span class="sr">}/</span>
      <span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">)</span> <span class="p">?</span> <span class="n">text</span> <span class="p">:</span> 
                                  <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zero_width_space</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="footnotes">
<ol>
<li id="fn-10_1">技術的には、<a class="ref" href="#cha-sign-in-sign-out">第8章</a>でセッションをリソースとして扱いましたが、セッションはユーザーやマイクロポストと異なり、データベースには保存されません。<a class="arrow" href="#fnref-10_1">↑</a></li>
<li id="fn-10_2"><code>content</code>属性は<code>string</code>型になりますが、 <a class="ref" href="#sec-modeling_demo_microposts">2.1.2</a>で簡単に述べたように、長文用のテキストフィールドには<code>text</code>型を使用してください。<a class="arrow" href="#fnref-10_2">↑</a></li>
<li id="fn-10_3">実は私自身、当初マイクロポストを適切に複製することを忘れており、以前のバージョンのチュートリアルで使用していたテストにはバグもありました。このようなセフティチェックを最初から行なっていれば、エラーを未然に防げたことでしょう。バグを発見して知らせてくれた読者Jacob Turinoに感謝します。<a class="arrow" href="#fnref-10_3">↑</a></li>
<li id="fn-10_4">(ここではカスタムGravatarを持つ5人のユーザーと、デフォルトGravatarを持つ1人のユーザー) <a class="arrow" href="#fnref-10_4">↑</a></li>
<li id="fn-10_5">もしこのメソッドが生成するSQLに興味があるのであれば、<code>log/development.log</code>をtailしてみてください (コマンドラインでファイルにtailコマンドを実行するという意味)。 <a class="arrow" href="#fnref-10_5">↑</a></li>
<li id="fn-10_6">Faker gemの<em>lorem ipsum</em>サンプルテキストはランダムに生成される仕様になっているため、サンプルマイクロポストの内容はこの図と違っているはずです。<a class="arrow" href="#fnref-10_6">↑</a></li>
<li id="fn-10_7">便宜上、<a class="ref" href="#code-micropost_css">リスト10.24</a>はこの章で必要なCSSを<em>すべて</em>含んでいます。<a class="arrow" href="#fnref-10_7">↑</a></li>
<li id="fn-10_8">他の2つのリソースとは、<a class="ref" href="#sec-signup_form">リスト7.2</a>のユーザーと<a class="ref" href="#sec-signin_failure">8.1</a>のセッションです。<a class="arrow" href="#fnref-10_8">↑</a></li>
<li id="fn-10_9"><a class="ref" href="#sec-remember_me">8.2.1</a>で、ヘルパーメソッドはデフォルトでは<em>ビュー</em>でのみ利用可能であると説明しましたが、<code>include SessionsHelper</code>をApplicationコントローラに追加してコントローラでも利用できるようににしました (<a class="ref" href="#code-sessions_helper_include">リスト8.14</a>)。<a class="arrow" href="#fnref-10_9">↑</a></li>
<li id="fn-10_10"><a class="ref" href="#sec-comments_for_various_readers">1.1.1</a>で、本書を読み終わったら次に純粋なRubyの本を読む事を薦めましたが、これは、<code>include?</code>のようなメソッドを学んでいただきたいからというのが理由の一つです。<a class="arrow" href="#fnref-10_10">↑</a></li>
<li id="fn-10_11"><code>where</code>やlikeの詳細については、Rails Guideの「<a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a> (英語)」を参照してください。<a class="arrow" href="#fnref-10_11">↑</a></li>
<li id="fn-10_12">残念ですが、この場合はページ分割されたフィードを返してもうまく動きません。動かない理由を確認したい方は、実際に実装してページネーションリンクをクリックしてみてください。<a class="arrow" href="#fnref-10_12">↑</a></li>
</ol>
</div>




<div class="label" id="cha-following-users"></div>


<h1 class="chapter"><a id="sec-11" href="#cha-following-users" class="heading"><span class="number">第11章</span>ユーザーをフォローする</a></h1>


<p>この章では、他のユーザーをフォロー (およびフォロー解除) できるソーシャルレイヤーを追加し、各ユーザーのHomeページに、現在フォロー中のユーザーのステータスフィードを表示できるようにして、サンプルアプリケーションのコアを完成させます。また、自分をフォローしているユーザーと、自分がフォローしているユーザーを同時に表示できるようにします。ユーザー間のリレーションをモデリングする方法については<a class="ref" href="#sec-the_relationship_model">11.1</a>で説明します。続いてWebインターフェイスの作成方法について、Ajaxの紹介と合わせて<a class="ref" href="#sec-a_web_interface_for_following_and_followers">11.2</a>で説明します。最終的に、完全に動作するステータスフィードの開発は<a class="ref" href="#sec-the_status_feed">11.3</a>で完了します。</p>

<p>この最終章では、本書の中で最も難易度の高い手法をいくつか使用しています。その中には、ステータスフィード作成のためにRuby/SQLを「だます」テクニックも含まれます。この章の例全体にわたって、これまでよりも複雑なデータモデルを使用しています。ここで学んだデータモデルは、今後自分用のWebアプリケーションを開発するときに必ず役に立ちます。本書を卒業して実際の開発に携わるときのために、<a class="ref" href="#sec-following_conclusion">11.4</a>にサンプルアプリケーションのコア部分を拡張する際のお勧めの方法を記しました。そのための高度な資料への参照も含まれています。</p>

<p>Gitユーザーはこれまで同様新しいトピックブランチを作成してください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b following-users
</pre></div>
</div>


<p>この章で扱っている手法は本書全体の中で最も難易度が高いので、理解を助けるため、コードを書く前にいったん立ち止まってインターフェースを説明することにします。これまでの章と同様、最初にモックアップを示します<sup class="footnote" id="fnref-11_1"><a href="#fn-11_1">1</a></sup>。ページ操作の全体的なフローは次のようになります。あるユーザー (John Calvin) は自分のプロファイルページを最初に表示し (<a class="ref" href="#fig-page_flow_profile_mockup">図11.1</a>)、フォローするユーザーを選択するためにUsersページ (<a class="ref" href="#fig-page_flow_user_index_mockup">図11.2</a>) に移動します。Calvinは2番目のユーザーThomas Hobbes (<a class="ref" href="#fig-page_flow_other_profile_follow_button_mockup">図11.3</a>) を表示し、[Follow] ボタンを押してフォローします。これにより、[Follow] ボタンが [Unfollow] に変わり、Hobbesの [followers] (フォロワー) カウントが1人増えます (<a class="ref" href="#fig-page_flow_other_profile_unfollow_button_mockup">図11.4</a>)。CalvinがHomeページに戻ると、[following] カウントが1人増え、Hobbesのマイクロポストがステータスフィードに表示されるようになっていることに気付きます (<a class="ref" href="#fig-page_flow_home_page_feed_mockup">図11.5</a>)。この節では、以後このフローの実現に専念します。</p>

<div class="label" id="fig-page_flow_profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_profile_mockup_bootstrap.png" alt="page_flow_profile_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.1: </span><span class="description">現在のユーザーのプロファイル。<a href="http://railstutorial.org/images/figures/page_flow_profile_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-page_flow_user_index_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_user_index_mockup_bootstrap.png" alt="page_flow_user_index_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.2: </span><span class="description">フォローする相手を見つける。<a href="http://railstutorial.org/images/figures/page_flow_user_index_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-page_flow_other_profile_follow_button_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_other_profile_follow_button_mockup_bootstrap.png" alt="page_flow_other_profile_follow_button_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.3: </span><span class="description">フォローするユーザーのプロファイルに [Follow] ボタンが表示されている。<a href="http://railstutorial.org/images/figures/page_flow_other_profile_follow_button_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-page_flow_other_profile_unfollow_button_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_other_profile_unfollow_button_mockup_bootstrap.png" alt="page_flow_other_profile_unfollow_button_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.4: </span><span class="description">プロファイルに [Unfollow] ボタンが表示され、フォロワーのカウントが1つ増えた。<a href="http://railstutorial.org/images/figures/page_flow_other_profile_unfollow_button_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-page_flow_home_page_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_home_page_feed_mockup_bootstrap.png" alt="page_flow_home_page_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.5: </span><span class="description">Homeページにステータスフィードが表示され、フォローのカウントが1増えた。<a href="http://railstutorial.org/images/figures/page_flow_home_page_feed_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-the_relationship_model"></div>


<h2><a id="sec-11_1" href="#sec-the_relationship_model" class="heading"><span class="number">11.1</span>Relationshipモデル</a></h2>


<p>ユーザーをフォローする機能を実装する第一歩は、データモデルを構成することです。ただし、これは見た目ほど単純ではありません。素朴に考えれば、<code>has_many</code> (1対多) リレーションシップはこんな感じでできそうな気がします。1人のユーザーが複数のユーザーを<code>has_many</code>としてフォローし 、1人のユーザーに複数のフォロワーがいることを<code>has_many</code>で表す、という具合です。この後で説明しますが、この方法ではたちまち壁に突き当たってしまいます。これを解決するための<code>has_many through</code> (多対多の関係を表すのに使用) についてもこの後で説明します。この節で説明するアイディアの多くは、最初なかなか意図が読み取れないこともあると思います。複雑なデータモデルも、腑に落ちるまで時間がかかることでしょう。もし自分が混乱し始めていると感じたら、まずはこの章の最後まで進め、それからもう一度この章全体を読み返してみてください。読み返すことでよりよく理解できるとおもいます。</p>

<div class="label" id="sec-a_problem_with_the_data_model"></div>


<h3><a id="sec-11_1_1" href="#sec-a_problem_with_the_data_model" class="heading"><span class="number">11.1.1</span>データモデルの問題 (および解決策)</a></h3>


<p>ユーザーをフォローするデータモデル構成のための第一歩として、典型的な場合を検討してみましょう。あるユーザーが、別のユーザーをフォローしているところを考えてみましょう。具体例を挙げると、CalvinはHobbesをフォローしています。これを逆から見れば、HobbesはCalvinからフォローされています。CalvinはHobbesから見れば<em>フォロワー (follower)</em>であり、HobbesはCalvinによって<em>フォローされている (followed) </em>ことになります。Railsにおけるデフォルトの複数形の慣習に従えば、あるユーザーをフォローしているすべてのユーザーの集合は<em>followers</em>となり、<code>user.followers</code>はそれらのユーザーの配列を表すことになります。残念なことに、この名前付けは逆についてはうまくいきません (Railsのというより英語の都合ですが)。フォローされているすべてのユーザーの集合は、このままでは<em>followeds</em>となってしまい、英語の文法からも外れるうえに非常に見苦しいものになってしまいます。followedに代えて<em>following</em>とすれば、followingsのように複数形にも対応できるのではないでしょうか。しかし今度は意味が曖昧になってしまいます。この文脈で “following” と書くと、英語では<em>あなたを</em>フォローする人々の集合、つまりあなたのフォロワーを指します。これでは意味が正反対になってしまいます。“following”は表示で “50 following, 75 followers” のように使用することはありますが、データモデルとしては違う名前を使用することにしましょう。ここでは、フォローしているユーザーたち自体を表すのに “followed users” を採用することにし、これに<code>user.followed_users</code>配列が対応します<sup class="footnote" id="fnref-11_2"><a href="#fn-11_2">2</a></sup>。</p>

<p>これにより、<a class="ref" href="#fig-naive_user_has_many_following">図11.6</a>のように<code>followed_users</code>テーブルと <code>has_many</code>関連付けを使用して、フォローしているユーザー (followed users) のモデリングができます。<code>user.followed_users</code>はユーザーの配列でなければならないため、<code>followed_users</code>テーブルのそれぞれの行は、<code>followed_id</code>で識別可能なユーザーである必要があります。この行には<code>follower_id</code>もあり、これで関連付けを行います<sup class="footnote" id="fnref-11_3"><a href="#fn-11_3">3</a></sup>。</p>

<div class="label" id="fig-naive_user_has_many_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/naive_user_has_many_followed_users.png" alt="naive_user_has_many_followed_users" /></span></div><div class="caption"><span class="header">図11.6: </span><span class="description">フォローしているユーザーの素朴な実装例。</span></div></div>


<p><a class="ref" href="#fig-naive_user_has_many_following">図11.6</a>のデータモデルの問題点は、非常に無駄が多いことです。各行には、フォローしているユーザーのidのみならず、名前やメールアドレスまであります。これらはいずれも <code>users</code>テーブルに<em>既にある</em>ものばかりです。さらによくないことに、<em>フォロワー (followers) </em>の方をモデリングするときにも、同じぐらい無駄の多い<code>followers</code>テーブルを別に作成しなければならなくなってしまいます。結論としては、このデータモデルはメンテナンスの観点から見て悪夢です。ユーザー名を変更するたびに、<code>users</code>テーブルのそのレコードだけでなく、<code>followed_users</code>テーブルと<code>followers</code>テーブルの両方について、<em>そのユーザーを含むすべての行</em>を更新しなければならなくなります。</p>

<p>この問題の根本は、必要な抽象化を行なっていないことです。正しい抽象化の方法を見つけ出す方法の1つは、Webアプリケーションにおける<em>following</em>の動作をどのように実装するかをじっくり考えることです。<a class="ref" href="#sec-a_users_resource">7.1.2</a>において、RESTアーキテクチャは、作成されたり削除されたりする<em>リソース</em>に関連していたことを思い出してください。ここから、2つの疑問が生じます。1. あるユーザーが別のユーザーをフォローするとき、何が作成されるのでしょうか。2. あるユーザーが別のユーザーをフォロー<em>解除</em>するとき、何が削除されるのでしょうか。</p>

<p>この点を踏まえて考えると、この場合アプリケーションによって作成または削除されるのは、つまるところ2人のユーザーの「<em>関係 (リレーションシップ)</em>」であることがわかります。つまり、1人のユーザーは「<code>has_many :relationships</code>」、つまり1対多の関係を持つことができ、さらにユーザーはリレーションシップ<em>を経由して</em>多くの<code>followed_users</code> (または<code>followers</code>) と関係を持つことができるということです。実際、<a class="ref" href="#fig-naive_user_has_many_following">図11.6</a>には必要なものがほぼあります。それぞれの「フォローしているユーザー」は<code>followed_id</code>で一意に特定できるので、<code>followed_users</code>テーブルを<code>Relationships</code>テーブルに変換します。続いて、ユーザーの詳細情報 (名前とメールアドレス) は Relationshipテーブルから削除してしまいます。そして<code>followed_id</code>を使用して「フォローしているユーザー」を<code>users</code>テーブルから取り出します。今度は<em>逆の</em>関係を考えます。<code>follower_id</code>カラムを使用して、ユーザーのフォロワーの配列を取り出すことができます。</p>

<p>ユーザーの<code>followed_users</code>の配列を作成するには、<code>followed_id</code>の配列を取り出し、それぞれのidごとに対応するユーザーを見つけ出します。皆様の期待どおり、Railsにはこのような手続きを簡単に行うための方法があります。多対多の関係を表現するこの手法は<code>has_many through</code>として知られています。<a class="ref" href="#sec-following">11.1.4</a>でも説明いたしますが、Railsは、以下のような簡潔なコードを使用することで、1人のユーザーが多数のユーザーとRelationshipテーブル<em>経由で</em>フォローしている/されている関係を記述することができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source:</span> <span class="ss">:followed</span>
</pre></div>
</div>


<p>このコードは自動的に、<code>user.followed_users</code>を「フォローしているユーザー」の配列を使用してデプロイします。このデータモデルの模式図を<a class="ref" href="#fig-user_has_many_following">図11.7</a>に示します。</p>

<div class="label" id="fig-user_has_many_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_has_many_followed_users.png" alt="user_has_many_followed_users" /></span></div><div class="caption"><span class="header">図11.7: </span><span class="description">ユーザーのリレーションシップで表される、フォローしている/されているユーザーのモデル。</span></div></div>


<p>このデータモデルを実装するには、最初に以下のようにRelationshipモデルを生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Relationship follower_id:integer followed_id:integer
</pre></div>
</div>


<p>このリレーションシップは今後<code>follower_id</code>と<code>followed_id</code>で頻繁に検索することになるので、<a class="ref" href="#code-relationships_migration">リスト11.1</a>に示したように、それぞれのカラムにインデックスを追加します。</p>

<div class="label" id="code-relationships_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.1</span> <span class="description"><code>relationships</code>テーブルにインデックスを追加する。</span><br /><span class="description"> <code>db/migrate/[timestamp]_create_relationships.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateRelationships</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:relationships</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:follower_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:followed_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:follower_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:followed_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-relationships_migration">リスト11.1</a>には<em>複合 (composite) </em>インデックスが使用されていることにご注目ください。これは<code>follower_id</code>と<code>followed_id</code>を組み合わせたときの一意性 (uniquenes: 重複がないこと) を強制するもので、これにより、あるユーザーは別のユーザーを2度以上フォローすることはできなくなります。</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique:</span> <span class="kp">true</span>
</pre></div>
</div>


<p>(<a class="ref" href="#code-email_uniqueness_index">リスト6.22</a>のメールアドレスの一意インデックスと比較してみてください)。<a class="ref" href="#sec-following">11.1.4</a>でも説明しますが、このような重複はインターフェイスレベルでも起きることのないようにします。しかし、一意 (ユニーク) インデックスを追加することで、ユーザーが何らかの方法で (<tt>curl</tt>などのコマンドラインツールを使用して) リレーションシップを重複させてしまうようなことがあればエラーが発生するようになります。さらに、このRelationshipモデルに一意性検証を追加することもできます。しかし、一意インデックスを使用していればリレーションシップが重複したときに<em>必ず</em>エラーになるので、今回は一意インデックスで十分です。</p>

<p><code>relationships</code>テーブルを作成するために、いつものようにデータベースのマイグレーションを行なってテストデータベースを準備しましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>


<p>作成したRelationshipデータモデルを<a class="ref" href="#fig-relationship_model">図11.8</a>に示します。</p>

<div class="label" id="fig-relationship_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/relationship_model.png" alt="relationship_model" /></span></div><div class="caption"><span class="header">図11.8: </span><span class="description">Relationshipデータモデル。</span></div></div>




<div class="label" id="sec-relationship_user_associations"></div>


<h3><a id="sec-11_1_2" href="#sec-relationship_user_associations" class="heading"><span class="number">11.1.2</span>User/relationshipの関連付け</a></h3>


<p>フォローしているユーザーとフォロワーを実装する前に、ユーザーとリレーションシップの関連付けを行います。1人のユーザーには<code>has_many</code> (1対多) リレーションシップがあり、このリレーションシップは<em>2人</em>のユーザーの間の関係なので、フォローしているユーザーとフォロワーの両方に属します (<code>belongs_to</code>)。</p>

<p><a class="ref" href="#sec-user_micropost_associations">10.1.3</a>のマイクロポストのときと同様、以下のようなユーザー関連付けのコードを使用して新しいリレーションシップを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>この時点で<a class="ref" href="#code-relationship_create_test">リスト11.2</a>のようにテストを作り始めましょう。このテストは<code>relationship</code>変数を作成して有効性を検証し、<code>follower_id</code>がアクセス不可能であることを確認します (もしテストを行ったときにアクセスできてしまうようなら、<code>application.rb</code>が<a class="ref" href="#code-application_whitelist">リスト10.6</a>に従って更新されていることを必ず確認してください)。</p>

<div class="label" id="code-relationship_create_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.2</span> <span class="description">リレーションシップの作成と属性をテストする。</span><br /><span class="description"> <code>spec/models/relationship_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="p">{</span> <span class="n">follower</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">followed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">relationship</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_valid</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;accessible attributes&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should not allow access to follower_id&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="no">Relationship</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">follower_id:</span> <span class="n">follower</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="ss">ActiveModel::MassAssignmentSecurity</span><span class="o">::</span><span class="no">Error</span><span class="p">)</span>
    <span class="k">end</span>    
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ところで、<a class="ref" href="#code-relationship_create_test">リスト11.2</a>では<code>let</code>を使用してインスタンス変数にアクセスしていることにご注目ください。UserモデルやMicropostモデルのテストのときは、それぞれ<code>@user</code>や<code>@micropost</code>を使用していました。この違いが問題になることはほとんどありません<sup class="footnote" id="fnref-11_4"><a href="#fn-11_4">4</a></sup>が、動作をよりはっきりとさせるために、インスタンス変数を使用する際には<code>let</code>を使用することをお勧めします。これまで通常のインスタンス変数を使用してきたのは、インスタンス変数を早い段階で紹介しておきたかったのと、<code>let</code>がやや高度であるためです。</p>

<p>今度はUserモデルの<code>relationships</code>属性を<a class="ref" href="#code-user_relationships_method_test">リスト11.3</a>のようにテストしましょう。</p>

<div class="label" id="code-user_relationships_method_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.3</span> <span class="description"><code>user.relationships</code>属性のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で、アプリケーションコードは<a class="ref" href="#sec-user_micropost_associations">10.1.3</a>のようになるのではないかと予測した方もいるかもしれません。実際似ているのですが、1つ大きな違いがあります。Micropostモデルの場合、以下のように書くことができました。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>および以下です。</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このように書くことができたのは、<code>microposts</code>テーブルにはユーザーを特定するための<code>user_id</code>属性があるからです (<a class="ref" href="#sec-the_basic_model">10.1.1</a>)。2つのデータベーステーブルを結合するために使用されるidは、<em>外部キー</em>と呼ばれます。Userモデルオブジェクトの外部キーが<code>user_id</code>の場合、Railsは自動的に関連付けを推測します。つまり、Railsはデフォルトで、<code>&lt;クラス&gt;_id</code>という形式の外部キーがあることを期待します。ここで<code>&lt;クラス&gt;</code>は小文字のクラス名です<sup class="footnote" id="fnref-11_5"><a href="#fn-11_5">5</a></sup>。ここではユーザー (users) を扱っていますが、このユーザーは (user_idではなく) 外部キーである<code>follower_id</code>によって特定されるので、<a class="ref" href="#code-user_relationships_association">リスト11.4</a>のようにそのことを明示的にRailsに伝える必要があります<sup class="footnote" id="fnref-11_6"><a href="#fn-11_6">6</a></sup>。</p>

<div class="label" id="code-user_relationships_association"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.4</span> <span class="description">ユーザー/リレーションシップの<code>has_many</code>の関連付けを実装する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;follower_id&quot;</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(ユーザーを削除したら、ユーザーのリレーションシップも同時に削除される必要があります。そのため、関連付けに<code>dependent: :destroy</code>を追加してあります。この部分のテストは演習に回します (<a class="ref" href="#sec-following_exercises">11.5</a>)。)</p>

<p>Micropostモデルの場合と同様、Relationshipモデルはユーザーと<code>belongs_to</code> (属する) の関係を持ちます。この場合、リレーションシップのオブジェクトは<code>follower</code>と<code>followed user</code>の両方に「属します」。<a class="ref" href="#code-relationships_belongs_to_test">リスト11.5</a>でこれをテストします。</p>

<div class="label" id="code-relationships_belongs_to_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.5</span> <span class="description">ユーザー/リレーションシップの<code>belongs_to</code>関連付けをテストする。</span><br /><span class="description"> <code>spec/models/relationship_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;follower methods&quot;</span> <span class="k">do</span>    
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">follower</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="o">==</span> <span class="n">followed</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これに対応するアプリケーションコードを作成するには、<code>belongs_to</code>リレーションシップを普段と同様に作成します。Railsは外部キーを、それに対応するシンボルから推測します。たとえば、<code>:follower</code>から<code>follower_id</code>を推測し、<code>:followed</code>から<code>followed_id</code>を推測するという具合です。しかし、FollowedモデルもFollowerモデルは実際にはないので、クラス名<code>User</code>を提供する必要があります。結果を<a class="ref" href="#code-relationship_belongs_to">リスト11.6</a>に示します。デフォルトで作成されるRelationshipモデルとは異なり、<code>followed_id</code>のみアクセス可能となっている点に注意してください。</p>

<div class="label" id="code-relationship_belongs_to"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.6</span> <span class="description"><code>belongs_to</code>関連付けを Relationshipモデルに追加する。</span><br /><span class="description"> <code>app/models/relationship.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:followed_id</span>

  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>実際には、<code>followed</code>の関連付けは<a class="ref" href="#sec-followers">11.1.5</a>まで使用しません。しかしfollower/followed構造を両方作り、これらを同時に実装する方が理解しやすくなります。</p>

<p>この時点で、<a class="ref" href="#code-relationship_create_test">リスト11.2</a>のテストと<a class="ref" href="#code-user_relationships_method_test">リスト11.3</a>のテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-relationship_validations"></div>


<h3><a id="sec-11_1_3" href="#sec-relationship_validations" class="heading"><span class="number">11.1.3</span>検証</a></h3>


<p>先に進む前に、Relationshipモデルの検証を追加して完全なものにしておきましょう。テスト (<a class="ref" href="#code-relationship_validation_tests">リスト11.7</a>)とアプリケーションコード (<a class="ref" href="#code-relationship_validations">リスト11.8</a>) は素直な作りです。</p>

<div class="label" id="code-relationship_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.7</span> <span class="description">Relationshipモデル検証のテスト。</span><br /><span class="description"> <code>spec/models/relationship_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;when followed id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">followed_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;when follower id is not present&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">relationship</span><span class="o">.</span><span class="n">follower_id</span> <span class="o">=</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_valid</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-relationship_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.8</span> <span class="description">Relationshipモデルの検証を追加する。</span><br /><span class="description"> <code>app/models/relationship.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:followed_id</span>

  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">class_name:</span> <span class="s2">&quot;User&quot;</span>

  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-following"></div>


<h3><a id="sec-11_1_4" href="#sec-following" class="heading"><span class="number">11.1.4</span>フォローしているユーザー </a></h3>


<p>いよいよRelationship関連付けの核心、<code>followed_users</code>と<code>followers</code>に取りかかります。まずは<code>followed_users</code>から始めます (<a class="ref" href="#code-user_following_test">リスト11.9</a>)。</p>

<div class="label" id="code-user_following_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.9</span> <span class="description"><code>user.followed_users</code>属性のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この実装では、最初から<code>has_many through</code>を使用します。<a class="ref" href="#fig-user_has_many_following">図11.7</a>のように、1人のユーザーにはいくつもの「フォロー<em>する/される</em> (多対多)」のリレーションシップがあります。デフォルトの<code>has_many through</code>関連付けでは、Railsは単一バージョンの関連付けに対応する外部キーを探します。つまり以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followeds</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:relationships</span>
</pre></div>
</div>


<p><code>relationships</code>テーブルの<code>followed_id</code>を使用して配列を作成します。ただし、<a class="ref" href="#sec-a_problem_with_the_data_model">11.1.1</a>でも指摘したとおり、<code>user.followeds</code>とすると英語の感覚として非常に見苦しくなってしまいますので、&quot;followed&quot;を複数形にするには “followed users” とuserを追加してそれを複数形にする方がずっと自然です。従って、フォローしているユーザーの配列を表すには<code>user.followed_users</code>と書きます。Railsではデフォルトをオーバーライドすることができるので、ここでは<code>:source</code>パラメーター (<a class="ref" href="#code-has_many_following_through_relationships">リスト11.10</a>) を使用し、<code>followed_users</code>配列の元は<code>followed</code> idの集合であることを明示的にRailsに伝えます。</p>

<div class="label" id="code-has_many_following_through_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.10</span> <span class="description">Userモデルの<code>followed_users</code>関連付けを追加する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;follower_id&quot;</span><span class="p">,</span> <span class="ss">dependent:</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followed_users</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">source:</span> <span class="ss">:followed</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ユーザーをフォローするというリレーションシップを作成するために、<code>follow!</code>ユーティリティメソッドを導入し、<code>user.follow!(other_user)</code>と書けるようにしましょう (この<code>follow!</code>メソッドは常に正常に動作しなければなりません。従って、<code>create!</code>メソッドや<code>save!</code>メソッドと同様、末尾に感嘆符を置いて、作成に失敗した場合には例外を発生することを示します) 。さらに、これに関連する<code>following?</code>論理値メソッドも追加し、あるユーザーが誰かをフォローしているかどうかを確認できるようにします<sup class="footnote" id="fnref-11_7"><a href="#fn-11_7">7</a></sup>。これらのメソッドの実際の使用例を<a class="ref" href="#code-utility_method_tests">リスト11.11</a>に示します。</p>

<div class="label" id="code-utility_method_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.11</span> <span class="description">“フォロー用の” ユーティリティメソッドをいくつかテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>  
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:following?</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;following&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>    
    <span class="n">before</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このアプリケーションコードでは、<code>following?</code>メソッドは<code>other_user</code>という1人のユーザーを引数にとり、フォローする相手のユーザーがデータベース上に存在するかどうかをチェックします。<code>follow!</code>メソッドは、<code>relationships</code>関連付けを経由して<code>create!</code>を呼び出すことで、「フォローする」のrelationshipを作成します。このコードを<a class="ref" href="#code-following_p_follow_bang">Listing 11.12</a>に示します。</p>

<div class="label" id="code-following_p_follow_bang"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.12</span> <span class="description"><code>following?</code> </span><span class="description">ユーティリティメソッドと<code>follow!</code></span><span class="description"> </span><span class="description">ユーティリティメソッド。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-following_p_follow_bang">リスト11.12</a>では、ユーザー自身を明示的には書かず、単に以下のように書いています。</p>

<div class="code"><div class="highlight"><pre><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>以下は、上と同等のコードです。</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p><code>self</code>を明示的に書くかどうかは好みの問題です。</p>

<p>ユーザーは他のユーザーをフォローできるだけでなく、フォロー解除もできる必要があります。当然、<a class="ref" href="#code-user_unfollow_test">Listing 11.13</a>に示したような<code>unfollow!</code>メソッドが必要になります<sup class="footnote" id="fnref-11_8"><a href="#fn-11_8">8</a></sup>。</p>

<div class="label" id="code-user_unfollow_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.13</span> <span class="description">ユーザーのフォロー解除をテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:unfollow!</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;following&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;and unfollowing&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>unfollow!</code>のコードは実に簡単です。フォローしているユーザーのidでリレーションシップを検索し、それを削除すればよいのです (<a class="ref" href="#code-user_unfollow">リスト11.14</a>)。</p>

<div class="label" id="code-user_unfollow"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.14</span> <span class="description">ユーザーのリレーションシップを削除してフォロー解除する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">unfollow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-followers"></div>


<h3><a id="sec-11_1_5" href="#sec-followers" class="heading"><span class="number">11.1.5</span>フォロワー</a></h3>


<p>リレーションシップというパズルの最後の一片は、<code>user.followers</code>メソッドを追加することです。これは上の<code>user.followed_users</code>メソッドと対になります。<a class="ref" href="#fig-user_has_many_following">図11.7</a>を見ていて気付いた方もいると思いますが、フォロワーの配列をデプロイするために必要な情報は、<code>relationships</code>テーブルに既にあります。実は、<code>follower_id</code>と<code>followed_id</code>を入れ替えるだけで、フォロワーについてもユーザーのフォローのときとまったく同じ方法が使用できます。ということは、何らかの方法で2つのカラムを入れ替えた<code>reverse_relationships</code>テーブルを用意することができれば (<a class="ref" href="#fig-user_has_many_followers">図11.9</a>)、<code>user.followers</code>を最小限の手間で実装できることになります。</p>

<div class="label" id="fig-user_has_many_followers"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_has_many_followers_2nd_ed.png" alt="user_has_many_followers_2nd_ed" /></span></div><div class="caption"><span class="header">図11.9: </span><span class="description">Relationshipモデルのカラムを入れ替えて作った、フォロワーのモデル。</span></div></div>


<p>Railsが魔法で何とかしてくれることを期待して、このテストを作成しましょう (<a class="ref" href="#code-reverse_relationships_test">リスト11.15</a>)。</p>

<div class="label" id="code-reverse_relationships_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.15</span> <span class="description">逆リレーションシップをテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:reverse_relationships</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>

  <span class="n">describe</span> <span class="s2">&quot;following&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:followed_users</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;followed user&quot;</span> <span class="k">do</span>
      <span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>subject</code>メソッドを使用して<code>@user</code>から<code>other_user</code>に対象を切り替えていることで、フォロワーのリレーションシップのテストを自然に実行できていることにご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">subject</span> <span class="p">{</span> <span class="n">other_user</span> <span class="p">}</span>
<span class="n">its</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>もちろん、逆リレーションシップのためにわざわざデータベーステーブルを1つ余分に作成するようなことはしません。代わりに、フォロワーとフォローしているユーザーの関係が対称的であることを利用し、単に<code>followed_id</code>を主キーとして渡すことで<code>reverse_relationships</code>をシミュレートすればよいのです。つまり、この<code>relationships</code>関連付けでは以下のように<code>follower_id</code>を外部キーとして使用し、</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;follower_id&quot;</span>
</pre></div>
</div>


<p><code>reverse_relationships</code>では以下のように<code>followed_id</code>を外部キーとして使用します。</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;followed_id&quot;</span>
</pre></div>
</div>


<p>これにより、<a class="ref" href="#code-user_reverse_relationships">リスト11.16</a>に示したように逆リレーションシップを経由して<code>followers</code>の関連付けを得ることができます。</p>

<div class="label" id="code-user_reverse_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.16</span> <span class="description">逆リレーションシップを使用して<code>user.followers</code>を実装する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;followed_id&quot;</span><span class="p">,</span>
                                   <span class="ss">class_name:</span>  <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span>
                                   <span class="ss">dependent:</span>   <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">source:</span> <span class="ss">:follower</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(<a class="ref" href="#code-user_relationships_association">リスト11.4</a>のときと同様、<code>dependent :destroy</code>のテストは演習に回します (<a class="ref" href="#sec-following_exercises">11.5</a>)。) 実際には、この関連付けでは以下のように<em>クラス</em>名を明示的に含める必要があることに注意してください。</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">foreign_key:</span> <span class="s2">&quot;followed_id&quot;</span><span class="p">,</span>
                                 <span class="ss">class_name:</span> <span class="s2">&quot;Relationship&quot;</span>
</pre></div>
</div>


<p>これを指定しないと、Railsは実在しない<code>ReverseRelationship</code>クラスを探しに行ってしまいます。</p>

<p>ここでは、以下のように<code>:source</code>キーを省略してもよいことにもご注意ください。</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">through:</span> <span class="ss">:reverse_relationships</span>
</pre></div>
</div>


<p><code>:followers</code>属性の場合、Railsが “followers” を単数形にして自動的に外部キー<code>follower_id</code>を探してくれるからです (:followedではこうはいきません)。上のコードでは、関連付けが<code>has_many :followed_users</code>と同じ形式になることを強調するために、あえて<code>:source</code>キーを付けてありますが、もちろん省略しても構いません。</p>

<p><a class="ref" href="#code-user_reverse_relationships">リスト11.16</a>のコードによって、フォローしているユーザーとフォロワーの関連付けの実装は完了しました。テストもすべてパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>この節は、データモデリングのスキルを向上させるという強い要請に基いて書かれました。時間をかけて身に付けていただければ幸いです。この節で使用されたさまざまな関連付けを理解するのに一番良いのは、次の節で行なっているように実際のWebインターフェイスで使用することです。</p>

<div class="label" id="sec-a_web_interface_for_following_and_followers"></div>


<h2><a id="sec-11_2" href="#sec-a_web_interface_for_following_and_followers" class="heading"><span class="number">11.2</span>フォローしているユーザー用のWebインターフェイス</a></h2>


<p>この章の最初に、フォローしているユーザーのページ表示の流れについて説明しました。この節では、モックアップで示したようにフォロー/フォロー解除の基本的なインターフェイスを実装します。また、フォローしているユーザーと、フォロワーにそれぞれ表示用のページを作成します。<a class="ref" href="#sec-the_status_feed">11.3</a>では、ユーザーのステータスフィードを追加して、サンプルアプリケーションを完成させます。</p>

<div class="label" id="sec-sample_following_data"></div>


<h3><a id="sec-11_2_1" href="#sec-sample_following_data" class="heading"><span class="number">11.2.1</span>フォローしているユーザーのサンプルデータ</a></h3>


<p>1つ前の章のときと同じように、サンプルデータを自動作成するRakeタスクを使用してデータベースにサンプルリレーションシップを登録するのがやはり便利です。先にサンプルデータを自動作成しておけば、Webページの見た目のデザインから先にとりかかることができ、バックエンドの機能の実装をこの節の後に回すことができます。</p>

<p>前回<a class="ref" href="#code-sample_microposts">リスト10.23</a>で自動生成したサンプルデータは割りといい加減でしたので、今回はまずユーザーとマイクロポストを作成するためのメソッドをそれぞれ別々に定義し、それから新しく<code>make_relationships</code>メソッドを作成してサンプルリレーションシップを追加することにしましょう。作成したRakeファイルを<a class="ref" href="#code-sample_relationships">リスト11.17</a>に示します。</p>

<div class="label" id="code-sample_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.17</span> <span class="description">フォローしている、またはフォローされている関係を表すリレーションシップをサンプルデータに追加する。</span><br /><span class="description"> <code>lib/tasks/sample_data.rake</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">populate:</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">make_users</span>
    <span class="n">make_microposts</span>
    <span class="n">make_relationships</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_users</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                       <span class="ss">email:</span>    <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                       <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                       <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="n">admin</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
  <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
    <span class="nb">name</span>  <span class="o">=</span> <span class="ss">Faker::Name</span><span class="o">.</span><span class="n">name</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org&quot;</span>
    <span class="n">password</span>  <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span>     <span class="nb">name</span><span class="p">,</span>
                 <span class="ss">email:</span>    <span class="n">email</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="n">password</span><span class="p">,</span>
                 <span class="ss">password_confirmation:</span> <span class="n">password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_microposts</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">limit:</span> <span class="mi">6</span><span class="p">)</span>
  <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
    <span class="n">content</span> <span class="o">=</span> <span class="ss">Faker::Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="n">content</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードのうち、サンプルリレーションシップを作成する部分は以下です。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">followed_users</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span>      <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">followed_users</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span>      <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>ここでは、最初のユーザーにユーザー3からユーザー51までをフォローさせ、それから逆にユーザー4からユーザー41に最初のユーザーをフォローさせます。ソースを見るとわかるように、このような設定を自由に行うことができます。こうしてリレーションシップを作成しておけば、アプリケーションのインターフェイスを開発するには十分です。</p>

<p><a class="ref" href="#code-sample_relationships">リスト11.17</a>を実行するために、いつものように以下を実行してデータベース上にデータを生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:populate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake db:test:prepare
</pre></div>
</div>




<div class="label" id="sec-stats_and_a_follow_form"></div>


<h3><a id="sec-11_2_2" href="#sec-stats_and_a_follow_form" class="heading"><span class="number">11.2.2</span>統計とフォロー用フォーム</a></h3>


<p>これでサンプルユーザーに、フォローしているユーザーの配列とフォロワーの配列ができました。ユーザープロファイルページとHomeページを更新してこれを反映しましょう。最初に、プロファイルページとHomeページに、フォローしているユーザーとフォロワーの統計情報を表示するためのパーシャルを作成します。次に、フォロー用とフォロー解除用のフォームを作成します。それから、フォローしているユーザーとフォロワーの一覧を表示する専用のページを作成します。</p>

<p><a class="ref" href="#sec-a_problem_with_the_data_model">11.1.1</a>でも述べたとおり、英語の “following” は、属性として使用すると意味が曖昧になります。<code>user.following</code>は、フォローしているユーザーとも、フォロワーとも受け取れてしまいます。しかし、フォローしているユーザーをページに表示するときの “50 following” というラベルになら問題なく使用できます。実際、これはTwitterでも使用されている表示です。<a class="ref" href="#fig-page_flow_profile_mockup">図11.1</a>のモックアップおよび<a class="ref" href="#fig-stats_partial_mockup">図11.10</a>の拡大図を参照してください。</p>

<div class="label" id="fig-stats_partial_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/stats_partial_mockup.png" alt="stats_partial_mockup" /></span></div><div class="caption"><span class="header">図11.10: </span><span class="description">統計情報パーシャルのモックアップ。</span></div></div>


<p><a class="ref" href="#fig-stats_partial_mockup">図11.10</a>の統計情報には、現在のユーザーがフォローしている人数と、現在のフォロワーの人数が表示されています。それぞれの表示はリンクになっており、専用の表示ページに移動できます。<a class="ref" href="#cha-filling-in-the-layout">第5章</a>では、これらのリンクはダミーテキスト<code>’#’</code>を使用して無効にしていました。しかしルーティングについての知識もだいぶ増えてきたので、今回は実装することにしましょう。実際のページ作成は<a class="ref" href="#sec-following_and_followers_pages">11.2.3</a>まで行いませんが、ルーティングは今実装します (<a class="ref" href="#code-following_followers_actions_routes">リスト11.18</a>)。このコードでは、<code>resources</code><em>ブロック</em>の内側で<code>:member</code>メソッドを使用しています。これは初登場ですので、どんな動作をするのか推測してみてください。(<em>注</em>: <a class="ref" href="#code-following_followers_actions_routes">リスト11.18</a>のコードは <code>resources :users</code>を<em>置き換えます</em>。)</p>

<div class="label" id="code-following_followers_actions_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.18</span> <span class="description"><code>following</code>および<code>followers</code>アクションをUsersコントローラに追加する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この場合のURIは/users/1/followingや/users/1/followersのようになるのではないかと推測した方もいると思います。そして、<a class="ref" href="#code-following_followers_actions_routes">リスト11.18</a>のコードはまさにそれを行なっているのです。どちらのページもデータを表示するものなので、(RESTの慣習に基いて) <tt>GET</tt>リクエストに応答するために<code>get</code>を使用してURIを生成します。<code>member</code>メソッドは、ユーザーidを含むURIにそのルートが応答できるようにするものです。idを指定せずすべてのメンバーを表示するには、以下のように<code>collection</code>を使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:tigers</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このコードは/users/tigersというURIに応答します (アプリケーションにあるすべてのtigerのリストを表示します)。 Railsにはさまざまなルーティングオプションがありますが、詳細についてはRailsガイドの記事「<a href="http://guides.rubyonrails.org/routing.html">外部から内部へのルーティング</a> (英語)」を参照してください。<a class="ref" href="#code-following_followers_actions_routes">リスト11.18</a>によって生成されるルーティングテーブルを<a class="ref" href="#table-following_routes">表11.1</a>に示します。ここにある、フォローしているユーザー用とフォロワー用の名前付きルートをこの後使用します。曖昧さのない「フォローしているユーザー (followed users)」と、Twitter式の「フォローしている (following)」表示を両方採用しましたが、このルーティングでは仕組み上残念ながら曖昧な方の &quot;following&quot; を使用せざるを得ません。曖昧でない &quot;followed users&quot; のままだと、ルートは<code>followed_users_user_path</code>という英語として見苦しいものになるため、<a class="ref" href="#table-following_routes">表11.1</a>で<code>following_user_path</code>が生成されるように調整しました。</p>

<div class="label" id="table-following_routes"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTPリクエスト</strong></th><th class="align_left"><strong>URI</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>名前付きルート</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/following</td><td class="align_left"><code>following</code></td><td class="align_left"><code>following_user_path(1)</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/followers</td><td class="align_left"><code>followers</code></td><td class="align_left"><code>followers_user_path(1)</code></td></tr></table></div><div class="caption"><span class="header">表11.1: </span><span class="description"><a class="ref" href="#code-following_followers_actions_routes">リスト11.18</a>のリソースのカスタムルールで提供されるRESTfulなルート。</span></div></div>


<p>ルーティングが定義されたことで、統計情報パーシャルをテストできる状態になりました (最初にテストを書いてもよかったのですが、ルーティングを更新しておかないと名前付きルートの説明がしにくかったので、テストを後にしました) 。この統計情報パーシャルはプロファイルページとHomeページの両方に表示されます。<a class="ref" href="#code-stats_view_test">リスト11.19</a>では、後者のHomeページの方でテストしています。</p>

<div class="label" id="code-stats_view_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.19</span> <span class="description">Homeページ上の、フォローしているユーザー/フォロワーの統計情報をテストする。</span><br /><span class="description"> <code>spec/requests/static_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;StaticPages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;Home page&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;for signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Lorem&quot;</span><span class="p">)</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">content:</span> <span class="s2">&quot;Ipsum&quot;</span><span class="p">)</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">root_path</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the user&#39;s feed&quot;</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
          <span class="n">page</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li#</span><span class="si">#{</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;follower/following counts&quot;</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">other_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">root_path</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;0 following&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;1 followers&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このテストの中心となるのは、フォローしているユーザーとフォロワーのカウントがページに表示され、それぞれに正しいURIが設定されていることを確認することです。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;0 following&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
<span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s2">&quot;1 followers&quot;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>ここでは、<a class="ref" href="#table-following_routes">表11.1</a>の名前付きルートを使用して、正しいアドレスへのリンクを確認していることにご注目ください。また、ここでは “followers” という語は<em>ラベル</em>として使用しているので、フォロワーが1人の場合にも複数形のままでよしとします。</p>

<p>統計情報パーシャルのアプリケーションコードは、<a class="ref" href="#code-stats_partial">リスト11.20</a>に示したとおり、単なる divタグ内のリンクです。</p>

<div class="label" id="code-stats_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.20</span> <span class="description">フォローしているユーザーとフォロワーの統計情報を表示するパーシャル。</span><br /><span class="description"> <code>app/views/shared/_stats.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;stats&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">&quot;following&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    following
  <span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">&quot;followers&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/strong&gt;</span>
    followers
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>このパーシャルはユーザー表示ページとHomeページの両方に表示されるので、<a class="ref" href="#code-stats_partial">リスト11.20</a>の最初の行では、以下のコードを使用して適切な方を選択しています。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="#sidebar-or_equals">コラム 8.2</a>でも説明したとおり、<code>@user</code>が <code>nil</code>でない場合 (つまりプロファイルページの場合) は何もせず、nilの場合 (つまりHomeページの場合) には<code>@user</code>をカレントユーザーに設定します。</p>

<p>フォローしているユーザーの人数と、フォロワーの人数は、以下の関連付けを使用して計算されます。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>上と、以下を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p><a class="ref" href="#code-user_show_microposts">リスト10.20</a>のマイクロポストのコードと比較してみましょう。あのときは以下のように書きました。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>このコードを使用してマイクロポストをカウントします。</p>

<p>一部の要素で、以下のようにCSS idを指定していることにもぜひご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;strong</span> <span class="na">id=</span><span class="s">&quot;following&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/strong&gt;</span>
</pre></div>
</div>


<p>こうしておくと、<a class="ref" href="#sec-a_working_follow_button_with_ajax">11.2.5</a>でAjaxを実装するときに便利です。そこでは、一意のidを指定してページ要素にアクセスしています。</p>

<p>統計情報パーシャルができあがりました。Homeページにこの統計情報を表示するのは、<a class="ref" href="#code-home_page_stats">リスト11.21</a>のように簡単にできます (これにより、<a class="ref" href="#code-stats_view_test">リスト11.19</a>のテストにもパスするようになります)。</p>

<div class="label" id="code-home_page_stats"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.21</span> <span class="description">フォロワーの統計情報をHomeページに追加する。</span><br /><span class="description"> <code>app/views/static_pages/home.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      .
      .
      .
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/user_info&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      <span class="nt">&lt;section&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/micropost_form&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      .
      .
      .
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>統計情報にスタイルを与えるために、<a class="ref" href="#code-stats_css">リスト11.22</a>のようにSCSSを追加しましょう (なお、このSCSSにはこの章で使用するスタイルがすべて含まれています)。スタイル追加の結果を<a class="ref" href="#fig-home_page_follow_stats">図11.11</a>に示します。</p>

<div class="label" id="code-stats_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.22</span> <span class="description">Homeページのサイドバー用SCSS。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.stats</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
    <span class="na">border-left</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="na">color</span><span class="o">:</span> <span class="nb">gray</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">padding-left</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
      <span class="na">text-decoration</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
      <span class="na">color</span><span class="o">:</span> <span class="nv">$blue</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nt">strong</span> <span class="p">{</span>
    <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.user_avatars</span> <span class="p">{</span>
  <span class="na">overflow</span><span class="o">:</span> <span class="no">auto</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="nc">.gravatar</span> <span class="p">{</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
</pre></div>
</div></div>




<div class="label" id="fig-home_page_follow_stats"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_follow_stats_bootstrap.png" alt="home_page_follow_stats_bootstrap" /></span></div><div class="caption"><span class="header">図11.11: </span><span class="description">Homeページ (<a href="http://localhost:3000/">/</a>) にフォロー関連の統計情報を表示する。<a href="http://railstutorial.org/images/figures/home_page_follow_stats_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この後すぐ、プロファイルにも統計情報パーシャルを表示しますが、今のうちに<a class="ref" href="#code-follow_form_partial">リスト11.23</a>のようにフォロー/フォロー解除ボタン用のパーシャルも作成しましょう。</p>

<div class="label" id="code-follow_form_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.23</span> <span class="description">フォロー/フォロー解除ボタン用のパーシャル。</span><br /><span class="description"> <code>app/views/users/_follow_form.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;follow_form&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;unfollow&#39;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;follow&#39;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>このコードは、<code>follow</code>と<code>unfollow</code>のパーシャルに作業を振っているだけです。パーシャルでは、Relationshipsリソース用のルールを含む新しいルートが必要です。これを、<a class="ref" href="#code-microposts_resource">リスト10.25</a>のMicropostsリソースの例に従って作成しましょう (<a class="ref" href="#code-relationships_resource">リスト11.24</a>)。</p>

<div class="label" id="code-relationships_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.24</span> <span class="description">ユーザーのrelationships用のルートを追加する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>      <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>    <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>follow/unfollowパーシャル自体は、<a class="ref" href="#code-follow_form">リスト11.25</a>と<a class="ref" href="#code-unfollow_form">リスト11.26</a>に示します。</p>

<div class="label" id="code-follow_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.25</span> <span class="description">ユーザーをフォローするフォーム。</span><br /><span class="description"> <code>app/views/users/_follow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Follow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-unfollow_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.26</span> <span class="description">ユーザーをフォロー解除するフォーム。</span><br /><span class="description"> <code>app/views/users/_unfollow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
             <span class="ss">html:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Unfollow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>これらの2つのフォームでは、いずれも<code>form_for</code>を使用してRelationshipモデルオブジェクトを操作しています。これらの2つのフォームの主な違いは、<a class="ref" href="#code-follow_form">リスト11.25</a>は<em>新しい</em>relationshipを作成するのに対し、<a class="ref" href="#code-unfollow_form">リスト11.26</a>は既存のrelationshipを見つけ出すという点です。すなわち、前者は<tt>POST</tt>リクエストを Relationshipsコントローラに送信してrelationshipを<code>create</code> (作成) し、後者は<tt>DELETE</tt>リクエストを送信してrelationshipを<code>destroy</code> (削除) するということです (これらのアクションは<a class="ref" href="#sec-a_working_follow_button_the_standard_way">11.2.4</a>で実装します)。最終的に、このfollow/unfollowフォームにはボタンしかないことを理解していただけたと思います。しかし、このフォームは<code>followed_id</code>を送信して<code>hidden_field</code>メソッドを完了させ、以下のHTMLを生成する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;followed_relationship_followed_id&quot;</span>
<span class="na">name=</span><span class="s">&quot;followed_relationship[followed_id]&quot;</span>
<span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>この「隠れた」<code>input</code>タグは、関連する情報をページに置きながら、それらをブラウザ上で非表示にします。</p>

<p>これで、<a class="ref" href="#code-user_follow_form_profile_stats">11.27</a>のようにフォロー用のフォームをユーザープロファイルページにインクルードしてパーシャルを出力できるようになりました。 プロファイルには、<a class="ref" href="#fig-profile_follow_button">図11.12</a>および<a class="ref" href="#fig-profile_unfollow_button">図11.13</a>のようにそれぞれ [Follow]、[Unfollow] ボタンが表示されます。</p>

<div class="label" id="code-user_follow_form_profile_stats"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.27</span> <span class="description">ユーザープロファイルページにフォロー用のフォームとフォロワーの統計情報を追加する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;follow_form&#39;</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
    .
    .
    .       
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span> 
</pre></div>
</div></div>




<div class="label" id="fig-profile_follow_button"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_follow_button_bootstrap.png" alt="profile_follow_button_bootstrap" /></span></div><div class="caption"><span class="header">図11.12: </span><span class="description">あるユーザープロファイル (<a href="http://localhost:3000/users/2">/users/2</a>) に [Follow] ボタンが表示されている。 <a href="http://railstutorial.org/images/figures/profile_follow_button_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-profile_unfollow_button"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_unfollow_button_bootstrap.png" alt="profile_unfollow_button_bootstrap" /></span></div><div class="caption"><span class="header">図11.13: </span><span class="description">あるユーザープロファイル (<a href="http://localhost:3000/users/8">/users/6</a>) に [Unfollow] ボタンが表示されている。<a href="http://railstutorial.org/images/figures/profile_unfollow_button_bootstrap-full.png">(拡大)</a></span></div></div>


<p>これらのボタンはもうすぐ動作するようになります。実はこのボタンの実装には2とおりの方法があります。1つは標準的な方法 (<a class="ref" href="#sec-a_working_follow_button_the_standard_way">11.2.4</a>)、もう1つはAjaxを使用する方法 (<a class="ref" href="#sec-a_working_follow_button_with_ajax">11.2.5</a>) です。でもその前に、フォローしているユーザーとフォロワーを表示するページをそれぞれ作成してHTMLインターフェースを完成させてしまいましょう。</p>

<div class="label" id="sec-following_and_followers_pages"></div>


<h3><a id="sec-11_2_3" href="#sec-following_and_followers_pages" class="heading"><span class="number">11.2.3</span>「フォローしているユーザー」ページと「フォロワー」ページ</a></h3>


<p>フォローしているユーザーを表示するページと、フォロワーを表示するページは、いずれもユーザープロファイルページとユーザーインデックスページ (<a class="ref" href="#sec-user_index">9.3.1</a>) を合わせたような作りになるという点で似ています。どちらにもフォローの統計情報などのユーザー情報を表示するサイドバーと、ユーザーのリストがあります。さらに、サイドバーにはユーザープロファイル画像のリンクを格子状に並べて表示する予定です。この要求に合うモックアップを<a class="ref" href="#fig-following_mockup">図11.14</a> (フォローしているユーザー用) および <a class="ref" href="#fig-followers_mockup">図 11.15</a> (フォロワー用) に示します。</p>

<div class="label" id="fig-following_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/following_mockup_bootstrap.png" alt="following_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.14: </span><span class="description">フォローしているユーザー用ページのモックアップ。<a href="http://railstutorial.org/images/figures/following_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-followers_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/followers_mockup_bootstrap.png" alt="followers_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.15: </span><span class="description">ユーザーのフォロワー用ページのモックアップ。<a href="http://railstutorial.org/images/figures/followers_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>ここでの最初の作業は、フォローしているユーザーのリンクとフォロワーのリンクを動くようにすることです。Twitterにならい、どちらのページでもユーザーのサインインを要求します。 このテストは<a class="ref" href="#code-following_followers_authorization_test">11.28</a>のように行います。ユーザーがサインインしたら、どちらのページにもフォローしているユーザー用リンクとフォロワー用リンクを表示します。このテストは<a class="ref" href="#code-following_followers_tests">リスト11.29</a>のように行います。</p>

<div class="label" id="code-following_followers_authorization_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.28</span> <span class="description">フォローしているユーザー用ページとフォロワー用ページでの認可をテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;in the Users controller&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">&quot;visiting the following page&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;visiting the followers page&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-following_followers_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.29</span> <span class="description"><code>followed_users</code>ページと<code>followers</code>ページをテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;following/followers&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;followed users&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">user</span>
        <span class="n">visit</span> <span class="n">following_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Following&#39;</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Following&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;followers&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">sign_in</span> <span class="n">other_user</span>
        <span class="n">visit</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Followers&#39;</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Followers&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この実装には1つだけトリッキーな部分があります。Usersコントローラに2つの新しいアクションを追加する必要があるのですが、これは<a class="ref" href="#code-following_followers_actions_routes">リスト11.18</a>で定義した2つのルートにもとづいており、これらはそれぞれ<code>following</code>および<code>followers</code>と呼ぶ必要があります。それぞれのアクションでは、タイトルを設定し、ユーザーを検索し、<code>@user.followed_users</code>または<code>@user.followers</code>からデータを取り出し、ページネーションを行なって、ページを出力する必要があります。作成したアクションを<a class="ref" href="#code-following_followers_actions">リスト11.30</a>に示します。</p>

<div class="label" id="code-following_followers_actions"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.30</span> <span class="description"><code>following</code>アクションと<code>followers</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span><span class="p">,</span> 
                <span class="ss">only:</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Following&quot;</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">&#39;show_follow&#39;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Followers&quot;</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">&#39;show_follow&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これらのアクションでは、<code>render</code>を<em>明示的に</em>呼び出していることに注意してください。ここでは、作成の必要な<code>show_follow</code>というビューを出力しています。renderで呼び出しているビューが同じなのは、このERbはどちらの場合でもほぼ同じであり、<a class="ref" href="#code-show_follow_view">リスト11.31</a>で両方の場合をカバーできるためです。</p>

<div class="label" id="code-show_follow_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.31</span> <span class="description">フォローしているユーザーの表示とフォロワーの表示の両方に使用する<code>show_follow</code>ビュー。</span><br /><span class="description"> <code>app/views/users/show_follow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@title</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;span&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;view my profile&quot;</span><span class="p">,</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;span&gt;&lt;b&gt;</span>Microposts:<span class="nt">&lt;/b&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;user_avatars&quot;</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">size:</span> <span class="mi">30</span><span class="p">),</span> <span class="n">user</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span8&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h3&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@users</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>これでテストにパスするはずです。画面も、<a class="ref" href="#fig-user_following">図11.16</a> (フォローしているユーザー) および <a class="ref" href="#fig-user_followers">図11.17</a> (フォロワー) のようになるはずです。</p>

<div class="label" id="fig-user_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_following_bootstrap.png" alt="user_following_bootstrap" /></span></div><div class="caption"><span class="header">図11.16: </span><span class="description">現在のユーザーにフォローされているユーザーを表示する。<a href="http://railstutorial.org/images/figures/user_following_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-user_followers"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_followers_bootstrap.png" alt="user_followers_bootstrap" /></span></div><div class="caption"><span class="header">図11.17: </span><span class="description">現在のユーザーのフォロワーを表示する。<a href="http://railstutorial.org/images/figures/user_followers_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-a_working_follow_button_the_standard_way"></div>


<h3><a id="sec-11_2_4" href="#sec-a_working_follow_button_the_standard_way" class="heading"><span class="number">11.2.4</span>[フォローする] ボタン (標準的な方法)</a></h3>


<p>ビューが整ってきました。いよいよ [フォローする] [フォロー解除する] ボタンを動作させましょう。これらのボタンのテストには、本書で扱ったさまざまなテスティングの技法が集約されています。このテストコードを読むのはよい練習になります。<a class="ref" href="#code-follow_unfollow_button_tests">リスト11.32</a>の内容をじっくり勉強し、テスト内容とその目的をすべて理解できるようにしてください (このコードには実は若干のセキュリティ上の抜けがあります。皆さんは見つけることができるでしょうか。この点についてはこの後でカバーします)。</p>

<div class="label" id="code-follow_unfollow_button_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.32</span> <span class="description">Follow/Unfollowボタンをテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;follow/unfollow buttons&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;following a user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="s2">&quot;should increment the followed user count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Follow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should increment the other user&#39;s followers count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Follow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;toggling the button&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Follow&quot;</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="ss">value:</span> <span class="s1">&#39;Unfollow&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">describe</span> <span class="s2">&quot;unfollowing a user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
          <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should decrement the followed user count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Unfollow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">followed_users</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">it</span> <span class="s2">&quot;should decrement the other user&#39;s followers count&quot;</span> <span class="k">do</span>
          <span class="n">expect</span> <span class="k">do</span>
            <span class="n">click_button</span> <span class="s2">&quot;Unfollow&quot;</span>
          <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="n">other_user</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;toggling the button&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Unfollow&quot;</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="ss">value:</span> <span class="s1">&#39;Follow&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>  
</pre></div>
</div></div>


<p><a class="ref" href="#code-follow_unfollow_button_tests">リスト11.32</a>は、これらのボタンをクリックし、そのときの正しい動作を指定することによりテストを行います。この実装を書くには、正しい動作をより深く理解する必要があります。フォローすることとフォロー解除することは、それぞれリレーションシップを<em>作成</em>することと<em>削除</em>することです。これはつまり、Relationshipsコントローラで<code>create</code>アクションと<code>destroy</code>を定義するということであり、このコントローラを作成する必要があります。これらのボタンはユーザーがサインインしていないと表示されないので一見セキュリティを満たしているように見えますが、<a class="ref" href="#code-follow_unfollow_button_tests">リスト11.32</a>には、ある低レベルの問題が抜けています。つまり、<code>create</code>アクションと<code>destroy</code>アクションはサインインしているユーザーのみがアクセスできることを確認するテストがありません (これが今述べたセキュリティホールです) 。<a class="ref" href="#code-relationships_controller_authorization_test">リスト11.33</a>では、<code>post</code>メソッドと<code>delete</code>メソッドを使用してこれらのアクションに直接アクセスすることによって、この要求を満たすようにしました。</p>

<div class="label" id="code-relationships_controller_authorization_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.33</span> <span class="description">Relationshipsコントローラの認可をテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authorization&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for non-signed-in users&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;in the Relationships controller&quot;</span> <span class="k">do</span>
        <span class="n">describe</span> <span class="s2">&quot;submitting to the create action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">post</span> <span class="n">relationships_path</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>

        <span class="n">describe</span> <span class="s2">&quot;submitting to the destroy action&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
          <span class="n">specify</span> <span class="p">{</span> <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>          
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>すぐ削除されるので事実上意味のないRelationshipオブジェクトをわざわざ作成することによるオーバーヘッドを回避するために、<code>delete</code>テストには名前付きルートにid <code>1</code>をハードコードしてあります。</p>

<div class="code"><div class="highlight"><pre><span class="n">before</span> <span class="p">{</span> <span class="n">delete</span> <span class="n">relationship_path</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>ユーザーがリダイレクトされた後で、アプリケーションがこのidでリレーションシップを取り出すので、このコードは動作します。</p>

<p>上のテストにパスするための以下のコントローラのコードは、驚くほど簡潔です。単に、フォローしているユーザーまたはこれからフォローするユーザーを取り出し、関連するユーティリティメソッドを使用してそれらをフォローまたはフォロー解除しているだけです。すべての実装を<a class="ref" href="#code-relationships_controller">リスト11.34</a>に示します。</p>

<div class="label" id="code-relationships_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.34</span> <span class="description">Relationshipsコントローラ。</span><br /><span class="description"> <code>app/controllers/relationships_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-relationships_controller">リスト11.34</a>を見てみれば、先ほどのセキュリティ問題が実はそれほど重大ではないことを理解いただけると思います。もしサインインしていないユーザーが (コマンドラインツールなどを使用して) これらのアクションに直接アクセスするようなことがあれば、<code>current_user</code>は<code>nil</code>になり、どちらのメソッドでも2行目で例外が発生します。エラーにはなりますが、アプリケーションやデータに影響は生じません。このままでも支障はありませんが、やはりこのような例外には頼らない方がよいので、上では一手間かけてセキュリティのためのレイヤーを追加しました。</p>

<p>これで、フォロー/フォロー解除の機能が完成しました。どのユーザーも、他のユーザーをフォローしたり、フォロー解除したりできます。サンプルアプリケーションを実際に動かしてみたり、以下のようにテストスイートを実行することで動作を確認できます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-a_working_follow_button_with_ajax"></div>


<h3><a id="sec-11_2_5" href="#sec-a_working_follow_button_with_ajax" class="heading"><span class="number">11.2.5</span>[フォローする] ボタン (Ajax)</a></h3>


<p>フォロー関連の機能の実装はこのとおり完了しましたが、ステータスフィードに取りかかる前にもう一つだけ機能を洗練させてみたいと思います。<a class="ref" href="#sec-a_working_follow_button_the_standard_way">11.2.4</a>では、Relationshipsコントローラの<code>create</code>アクションと <code>destroy</code>アクションを単に<em>元の</em>プロファイルにリダイレクトしていました。つまり、ユーザーはプロファイルページを最初に表示し、それからユーザーをフォローし、その後すぐ元のページにリダイレクトされるという流れになります。ユーザーをフォローした後、本当にそのページから離れて元のページに戻らないといけないのでしょうか。この点を考えなおしてみましょう。</p>

<p>これは<em>Ajax</em>を使用することで解決できます。Ajaxを使用すれば、Webページからサーバーに「非同期」で、ページを移動することなくリクエストを送信することができます<sup class="footnote" id="fnref-11_9"><a href="#fn-11_9">9</a></sup>。WebフォームにAjaxを採用するのは今や当たり前になりつつあるので、RailsでもAjaxを簡単に実装できるようになっています。フォロー用とフォロー解除用のフォームパーシャルをこれに沿って更新するのは簡単です。以下のコードがあるとします。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span>
</pre></div>
</div>


<p>上を以下のように変更します。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">,</span> <span class="ss">remote:</span> <span class="kp">true</span>
</pre></div>
</div>


<p>たったこれだけで、Railsは<a href="http://catb.org/jargon/html/A/automagically.html">自動的に</a>Ajaxを使用します<sup class="footnote" id="fnref-11_10"><a href="#fn-11_10">10</a></sup>。更新の結果を<a class="ref" href="#code-follow_form_ajax">リスト11.35</a>と<a class="ref" href="#code-unfollow_form_ajax">リスト11.36</a>に示します。</p>

<div class="label" id="code-follow_form_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.35</span> <span class="description">フォロー用のフォームでAjaxを使用する。</span><br /><span class="description"> <code>app/views/users/_follow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">followed_id:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">remote:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Follow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code-unfollow_form_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.36</span> <span class="description">フォロー解除用のフォームでAjaxを使用する。</span><br /><span class="description"> <code>app/views/users/_unfollow.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
             <span class="ss">html:</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">},</span>
             <span class="ss">remote:</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Unfollow&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>ERbによって実際に生成されるHTMLはそれほど重要ではありませんが、興味がある方のために、以下の核心部分をお見せします。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/relationships/117&quot;</span> <span class="na">class=</span><span class="s">&quot;edit_relationship&quot;</span> <span class="na">data-remote=</span><span class="s">&quot;true&quot;</span>
      <span class="na">id=</span><span class="s">&quot;edit_relationship_117&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>


<p>ここでは、formタグの内部で<code>data-remote=&quot;true&quot;</code>変数を設定しています。これは、JavaScriptによるフォーム操作を許可することをRailsに知らせるためのものです。以前のRailsでは完全なJavaScriptコードを挿入していましたが、現在のRails3ではこのようにHTMLプロパティを使用して簡単にJavaScriptを使用できます。Rails 3は、<a href="http://railscasts.com/episodes/205-unobtrusive-javascript"><em>JavaScriptを前面に出すべからず</em></a>という哲学に従っています。</p>

<p>フォームの更新が終わったので、今度はこれに対応するRelationshipsコントローラを改造して、Ajaxリクエストに応答できるようにしましょう。実は、Ajaxはテスティングがかなりトリッキーになってしまいます。Ajaxのテストはそれだけで大きなテーマなので、本格的に説明しようとすると本書の範囲を超えてしまいます。ここでは<a class="ref" href="#code-relationships_controller_spec_ajax">リスト11.37</a>のテストを使用することにしましょう。ここでは<code>xhr</code>メソッド (“XmlHttpRequest” の略です) を使用してAjaxリクエストを発行しています。以前の、<code>get</code>、<code>post</code>、<code>put</code>、<code>delete</code>メソッドを使用したテストと比べてみてください。それから、Ajaxリクエストを受信したときに<code>create</code>アクションと<code>destroy</code>アクションが正常に動作することを確認します (Ajaxを多用するアプリケーションを徹底的にテストしたい方は、<a href="http://seleniumhq.org/">Selenium</a>と<a href="http://watir.com/">Watir</a>を参照してみてください)。</p>

<div class="label" id="code-relationships_controller_spec_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.37</span> <span class="description">RelationshipsコントローラがAjaxリクエストに応答することをテストする。</span><br /><span class="description"> <code>spec/controllers/relationships_controller_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">RelationshipsController</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:other_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">before</span> <span class="p">{</span> <span class="n">sign_in</span> <span class="n">user</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;creating a relationship with Ajax&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should increment the Relationship count&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship:</span> <span class="p">{</span> <span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should respond with success&quot;</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship:</span> <span class="p">{</span> <span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;destroying a relationship with Ajax&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:relationship</span><span class="p">)</span> <span class="p">{</span> <span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">other_user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">&quot;should decrement the Relationship count&quot;</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should respond with success&quot;</span> <span class="k">do</span>
      <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">relationship</span><span class="o">.</span><span class="n">id</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="#code-relationships_controller_spec_ajax">リスト11.37</a>のコードは、実は<em>コントローラ</em>用テストとしては初めてのものです。本書の以前の版ではコントローラ用のテストを多用していましたが、現在は結合テストの観点からコントローラ向けのテストは控えています。ただし、どういうわけかこの場合<code>xhr</code>メソッドを結合テストで使用することができないために、このコントローラでのテストを行なっています。<code>xhr</code>は先ほど登場したばかりですが、本書ではひとまずコードの文脈から以下のコードの動作を推測していただくようお願いします。</p>

<div class="code"><div class="highlight"><pre><span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">relationship:</span> <span class="p">{</span> <span class="ss">followed_id:</span> <span class="n">other_user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span>
</pre></div>
</div>


<p><code>xhr</code>が取る引数は、関連するHTTPメソッドを指すシンボル、アクションを指すシンボル、またはコントローラ自身にある<code>params</code>の内容を表すハッシュのいずれかです。これまでの例と同様、<code>expect</code>を使用してブロック内の操作をまとめ、関連するカウントを1増やしたり減らしたりするテストを行なっています。</p>

<p>このテストが暗に示しているように、実はこのアプリケーションコードがAjaxリクエストへの応答に使用する<code>create</code>アクションと<code>destroy</code>アクションは、通常のHTTP <tt>POST</tt>リクエストと<tt>DELETE</tt>リクエストに応答するのに使用されるのと同じものです。これらのアクションは、<a class="ref" href="#sec-a_working_follow_button_the_standard_way">11.2.4</a>のようにリダイレクトを伴う通常のHTTPリクエストと、JavaScriptを使用するAjaxリクエストの両方に応答できればよいのです。実際のコントローラのコードを<a class="ref" href="#code-relationships_controller_ajax">リスト11.38</a>に示します。(練習のため、<a class="ref" href="#sec-following_exercises">11.5</a>のコードも見てみてください。このコードは動作は同じですが、よりコンパクトになっています。)</p>

<div class="label" id="code-relationships_controller_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.38</span> <span class="description">RelationshipsコントローラでAjaxリクエストに応答する。</span><br /><span class="description"> <code>app/controllers/relationships_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このコードでは、リクエストの種類に応じたアクションを実行するために<code>respond_to</code>を使用しています (注意: ここで使用している<code>respond_to</code>は、RSpecの例で使用している<code>respond_to</code>とは別物です)。この文法は少々変わっていて、混乱を招く可能性があるため、以下のコードの動作を理解するようにしてください。</p>

<div class="code"><div class="highlight"><pre><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
<span class="k">end</span>
</pre></div>
</div>


<p>上のコードでは、リクエストの種類に応じて、続く行の中から<em>1つだけ</em>が実行されることに注意してください。</p>

<p>Ajaxリクエストを受信した場合は、Railsが自動的にアクションと同じ名前を持つ<em>JavaScript組み込みRuby</em> (<code>.js.erb</code>) ファイル (<code>create.js.erb</code>や<code>destroy.js.erb</code>など) を呼び出します。ご想像のとおり、これらのファイルではJavaScriptと組み込みRuby (ERb) をミックスして現在のページに対するアクションを実行することができます。ユーザーをフォローしたときやフォロー解除したときにユーザープロファイルページを更新するために、私たちがこれから作成および編集しなければならないのは、まさにこれらのファイルです。</p>

<p>JS-ERbファイルの内部では、Railsが自動的に<a href="http://jquery.com/">jQuery</a> JavaScriptヘルパーを提供します。これにより、<a href="http://www.w3.org/DOM/">DOM (Document Object Model)</a> を使用してページを操作できます。jQueryライブラリにはDOM操作用の膨大なメソッドが提供されていますが、ここで使用するのはわずか2つです。それにはまず、ドル記号 ($) を使用してDOM要素に一意のCSS idでアクセスする文法について知る必要があります。たとえば、<code>follow_form</code>要素を操作するには、以下の文法を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>(<a class="ref" href="#code-follow_form_partial">リスト11.23</a>では、これはフォームを囲む<code>div</code>タグであり、フォームそのものではなかったことを思い出してください。) jQueryの文法はCSSの記法から影響を受けており、<code>#</code>シンボルを使用してCSSのidを指定します。ご想像のとおり、jQueryはCSSと同様、ドット<code>.</code>を使用してCSSクラスを操作できます。</p>

<p>次に必要なメソッドは<code>html</code>です。これは、引数の中で指定された要素の内側にあるHTMLを更新します。たとえば、フォロー用フォーム全体を<code>&quot;foobar&quot;</code>という文字列で置き換えるには、以下を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>純粋なJavaScriptと異なり、JS-ERbファイルでは組み込みRuby (ERb) を使用できます。<code>create.js.erb</code>ファイルでは、フォロー用のフォームを<code>unfollow</code>パーシャルで更新し、フォロワーのカウントを更新するのにERbを使用しています (もちろんこれは、フォローに成功した場合の動作です)。変更の結果を<a class="ref" href="#code-create_js_erb">リスト11.39</a>に示します。このコードでは<code>escape_javascript</code>関数を使用していることにご注目ください。この関数は、JavaScriptファイル内にHTMLを挿入するときに実行結果をエスケープする (画面に表示しない) ために必要です。</p>

<div class="label" id="code-create_js_erb"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.39</span> <span class="description">JavaScript組み込みRubyを使用してフォローのリレーションシップを作成する。</span><br /><span class="description"> <code>app/views/relationships/create.js.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&#39;users/unfollow&#39;)) %&gt;&quot;</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#followers&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;%= @user.followers.count %&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div></div>


<p><code>destroy.js.erb</code>ファイルの方も同様です (<a class="ref" href="#code-destroy_js_erb">リスト11.40</a>)。</p>

<div class="label" id="code-destroy_js_erb"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.40</span> <span class="description">Ruby JavaScript (RJS) を使用してフォローのリレーションシップを削除する。</span><br /><span class="description"> <code>app/views/relationships/destroy.js.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#follow_form&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&#39;users/follow&#39;)) %&gt;&quot;</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#followers&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;%= @user.followers.count %&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div></div>


<p>これらのコードにより、ユーザープロファイルを表示して、ページを更新せずにフォローまたはフォロー解除ができるようになったはずです。テストスイートもパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>RailsでAjaxを使用するというテーマは奥が深く、かつ進歩が早いので、本書ではほんの表面をなぞったに過ぎません。しかし、本書の他の題材と同様、今後より高度な資料にあたる際に必要な基礎となるはずです。</p>

<div class="label" id="sec-the_status_feed"></div>


<h2><a id="sec-11_3" href="#sec-the_status_feed" class="heading"><span class="number">11.3</span>ステータスフィード</a></h2>


<p>ついに、サンプルアプリケーションの山頂が目の前に現れました。最後の難関、ステータスフィードの実装に取りかかりましょう。この節で扱われている内容は、本書の中でも最も高度なものです。完全なステータスフィードは、<a class="ref" href="#sec-a_proto_feed">10.3.3</a>で扱ったプロトフィードをベースにします。現在のユーザーにフォローされているユーザーのマイクロポストの配列を作成し、現在のユーザー自身のマイクロポストと合わせて表示します。この機能を実現するには、RailsとRubyの高度な機能の他に、SQLプログラミングの技術も必要です。</p>

<p>手強い課題に挑むのですから、ここで実装すべき内容を慎重に見直すことが重要です。<a class="ref" href="#fig-page_flow_home_page_feed_mockup">図11.5</a>でお見せしたステータスフィードの最終形を<a class="ref" href="#fig-home_page_feed_mockup">図11.18</a>に再度掲載します。</p>

<div class="label" id="fig-home_page_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_home_page_feed_mockup_bootstrap.png" alt="page_flow_home_page_feed_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図11.18: </span><span class="description">ステータスフィードが表示されたHomeページのモックアップ。<a href="http://railstutorial.org/images/figures/page_flow_home_page_feed_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-motivation_and_strategy"></div>


<h3><a id="sec-11_3_1" href="#sec-motivation_and_strategy" class="heading"><span class="number">11.3.1</span>動機と計画</a></h3>


<p>ステータスフィードの基本的なアイディアはシンプルです。<a class="ref" href="#fig-user_feed">図11.19</a>に、サンプルの<code>microposts</code>データベーステーブルと、それをフィードした結果を示します。図の矢印で示されているように、この目的は、現在のユーザーによってフォローされているユーザーに対応するユーザーidを持つマイクロポストを取り出し、同時に現在のユーザー自身のマイクロポストも一緒に取り出すことです。</p>

<div class="label" id="fig-user_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_feed.png" alt="user_feed" /></span></div><div class="caption"><span class="header">図11.19: </span><span class="description">id 1のユーザーがid 2、7、8、10をフォローしているときのフィード。</span></div></div>


<p>あるユーザーによってフォローされているユーザーのマイクロポストをすべて見つけ出すために、<code>from_users_followed_by</code>というメソッドを実装することを考えてみましょう。このメソッドは、以下のように使用します。</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>この時点ではもちろん実装はありませんが、機能を確認するためのテストは作成できます。このテストで重要なことは、フィードに必要な3つの条件を満たすことです。1) フォローしているユーザーのマイクロポストがフィードに含まれていること。2) 自分自身のマイクロポストもフィードに含まれていること。3) <em>フォローしていない</em>ユーザーのマイクロポストがフィードに含まれていないこと。このうち2つについては、<a class="ref" href="#code-feed_specs">リスト10.38</a>のテストで既に確認できるようになっています。このテストでは、ユーザー自身のマイクロポストがフィードに含まれ、フォローしていないユーザーのマイクロポストがフィードに含まれていないことを確認します。既にユーザーをフォローできるようになっているので、3番目のテスト、つまりフォローしているユーザーのマイクロポストがフィードに含まれていることを確認するテストを<a class="ref" href="#code-full_feed_specs">リスト11.41</a>のように追加できます。</p>

<div class="label" id="code-full_feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.41</span> <span class="description">ステータスフィードの最終テスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:older_micropost</span><span class="p">)</span> <span class="k">do</span> 
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:newer_micropost</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">created_at:</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;status&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:unfollowed_post</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">user:</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="k">end</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:followed_user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed_user</span><span class="p">)</span>
        <span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">content:</span> <span class="s2">&quot;Lorem ipsum&quot;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">newer_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">older_micropost</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">unfollowed_post</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">its</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">followed_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
          <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">micropost</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ステータスフィードのモデルのコードは、<a class="ref" href="#code-user_feed">リスト11.42</a>に示したように、面倒な部分を<code>Micropost.from_users_followed_by</code>に任せてしまっています。この内容は後で実装しなければなりません。</p>

<div class="label" id="code-user_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.42</span> <span class="description">Userモデルに完全なフィードを追加する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-a_first_feed_implementation"></div>


<h3><a id="sec-11_3_2" href="#sec-a_first_feed_implementation" class="heading"><span class="number">11.3.2</span>フィードを初めて実装する</a></h3>


<p>では、その面倒な<code>Micropost.from_users_followed_by</code>を実装しましょう。簡単のため、以後このメソッドを単に “フィード” と呼びます。最終的な表示がやや込み入っているため、欲張らずに細かい部品を1つずつ確かめながら導入することで最終的なフィードを実装します。</p>

<p>最初に、このフィードで必要なクエリについて考えましょう。ここで必要なのは、<code>microposts</code>テーブルから、あるユーザー (つまり自分自身) がフォローしているユーザーに対応するidを持つマイクロポストをすべて選択 (select) することです。このクエリを模式的に書くと以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">list</span> <span class="k">of</span> <span class="n">ids</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">user</span> <span class="n">id</span><span class="o">&gt;</span>
</pre></div>
</div>


<p>上のコードを書く際に、SQLが<code>IN</code>というキーワードをサポートしていることを前提にしています (大丈夫、実際にサポートされています)。このキーワードを使用することで、idの集合の内包 (set inclusion) に対してテストを行えます。</p>

<p><a class="ref" href="#sec-a_proto_feed">10.3.3</a>のプロトフィードでは、上のような選択を行うためにActive Recordで<a class="ref" href="#code-proto_status_feed">リスト10.39</a>のように<code>where</code>メソッドを使用していたことを思い出してください。このときは、選択する対象はシンプルでした。現在のユーザーに対応するユーザーidを持つマイクロポストをすべて選択すればよかったのでした。</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>ここで行いたい選択は、上よりももう少し複雑で、たとえば以下のような感じになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id in (?) </span><span class="s2">OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">following_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>(上のコードでは、条件部分に<code>user.id</code>の代わりにRailsの習慣である<code>user</code>を使用していることに注意してください。Railsはこのような場合に自動的に<code>id</code>を使用します。また、冒頭の<code>Micropost.</code>が省略されていることにも注意してください。このコードはMicropostモデル自身の中に置かれることを前提としています。)</p>

<p>これらの条件から、フォローされているユーザーに対応するidの配列が必要であることがわかってきました。これを行う方法の1つは、Rubyの<code>map</code>メソッドを使用することです。このメソッドはすべての &quot;列挙可能 (enumerable)&quot; オブジェクト (配列やハッシュなど、要素の集合で構成されるあらゆるオブジェクト<sup class="footnote" id="fnref-11_11"><a href="#fn-11_11">11</a></sup>) で使用できます。このメソッドの使用法については<a class="ref" href="#sec-blocks">4.3.2</a>でも説明しました。以下のように使用します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</span>
</pre></div>
</div>


<p>上に示したような状況では、各要素に対して同じメソッド (この場合<code>to_s</code>) が実行されます。これは非常によく使われる方法であり、以下のように<em>アンパサンド</em> <code>&amp;</code>と、メソッドに対応するシンボルを使用した短縮表記も可能です<sup class="footnote" id="fnref-11_12"><a href="#fn-11_12">12</a></sup>。この短縮表記なら変数iを使用せずに済みます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
<span class="go">=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</span>
</pre></div>
</div>


<p><code>join</code>メソッド (<a class="ref" href="#sec-arrays_and_ranges">4.3.1</a>) を使用すれば、idを集めた文字列を以下のようにカンマ区切りでつなげることもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
<span class="go">=&gt; &quot;1, 2, 3, 4&quot;</span>
</pre></div>
</div>


<p>上のメソッドを使用すれば、<code>user.followed_users</code>にある各要素の<code>id</code>を呼び出し、フォローしているユーザーのidの配列を構成することができます。たとえば、データベースの最初のユーザーの場合は、以下の配列になります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_users</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div>
</div>


<p>実際、この手法は実に便利なので、Active Recordは以下でもデフォルトで同じ結果を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div>
</div>


<p>この<code>followed_user_ids</code>メソッドは、実はActive Recordによって<code>has_many :followed_users</code>関連付けから自動生成されたものです (<a class="ref" href="#code-has_many_following_through_relationships">リスト11.10</a>)。これにより、<code>user.followed_users</code>コレクションに対応するidを得るための<code>_ids</code>を、関連付けの名前に追加するだけで済みます。フォローしているユーザーidの文字列は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">followed_user_ids</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
<span class="go">=&gt; &quot;4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51</span>
</pre></div>
</div>


<p>なお、以上は説明のためのコードであり、実際にSQL文字列に挿入するときは、このように記述する必要はありません。実は、<code>?</code>を外挿すると自動的にこの辺りの面倒を見てくれます。さらに、データベースに依存する一部の非互換性まで解消してくれます。つまり、ここでは以下をそのまま使えばよいだけなのです。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div>
</div>


<p>それ以外の追加は不要です。</p>

<p>ここで、以下のコードを見てみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>このコードは<code>Micropost</code>クラスのクラスメソッド (<a class="ref" href="#sec-constructors">4.4.1</a>で簡単に説明したコンストラクタ) に関連するのではないかと推測した方もいると思います。 これに沿って実装した推奨コードを<a class="ref" href="#code-from_users_followed_by_first_cut">リスト11.43</a>に示します。</p>

<div class="label" id="code-from_users_followed_by_first_cut"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.43</span> <span class="description"><code>from_users_followed_by</code>の最初の実装。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (?) </span><span class="s2">OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上の<a class="ref" href="#code-from_users_followed_by_first_cut">リスト11.43</a>まで述べてきたことは仮説に過ぎませんでしたが、それを実装したコードは確かに動きます。テストスイートを実行して確認することもできます。このテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>簡単なアプリケーションであれば、この最初の実装だけでほとんどの目的を達成できるでしょう。しかし、私たちのサンプルアプリケーションの実装にはまだ足りないものがあります。それが何なのか、次の節に進む前に考えてみてください (<em>ヒント:</em>フォローしているユーザーが5000人もいたらどうなるでしょうか)。</p>

<div class="label" id="sec-scopes_subselects_and_a_lambda"></div>


<h3><a id="sec-11_3_3" href="#sec-scopes_subselects_and_a_lambda" class="heading"><span class="number">11.3.3</span>サブセレクト</a></h3>


<p>前節のヒントでおわかりのように、<a class="ref" href="#sec-a_first_feed_implementation">11.3.2</a>のフィードの実装は、投稿されたマイクロポストの数が膨大になったときにうまくスケールアップできません。フォローしているユーザーが5000人程度になるとこういうことが起きる可能性があります。この節では、フォローしているユーザー数に応じてスケーリングできるように、ステータスフィードを再度実装します。</p>

<p><a class="ref" href="#sec-a_first_feed_implementation">11.3.2</a>で問題となるのは、以下のコードです。</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div>
</div>


<p>このコードは、フォローしている<em>すべての</em>ユーザーをメモリーから一気に取り出し、フォローしているユーザーの完全な配列を作り出します。<a class="ref" href="#code-from_users_followed_by_first_cut">リスト11.43</a>の条件では、集合に内包されているかどうかだけしかチェックされていないため、この部分をもっと効率的なコードにできるはずです。そして、SQLは本来このような集合の操作に最適化されています。これを解決する方法は、フォローしているユーザーのidの検索をデータベースに保存するときに<em>サブセレクト (subselect) </em>を使用することです。</p>

<p><a class="ref" href="#code-from_users_followed_by_second_cut">リスト11.44</a>でコードを若干修正し、フィードをリファクタリングすることから始めましょう。</p>

<div class="label" id="code-from_users_followed_by_second_cut"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.44</span> <span class="description"><code>from_users_followed_by</code>を改良する。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># 与えられたユーザーによってフォローされているユーザーのマイクロポストを返す。</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (:followed_user_ids) OR user_id = :user_id&quot;</span><span class="p">,</span>
          <span class="ss">followed_user_ids:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次の段階の準備として、以下のコードを修正しました。</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (?) </span><span class="s2">OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>上のコードを、以下の同等のコードに置き換えました。</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (:followed_user_ids) OR user_id = :user_id&quot;</span><span class="p">,</span>
      <span class="ss">followed_user_ids:</span> <span class="n">followed_user_ids</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>例の疑問符を使用した文法も便利ですが、<em>同じ</em>変数を複数の場所に挿入したい場合は、置き換えた後の文法を使用するのがより便利です。</p>

<p>上の説明が暗に示すように、これからSQLクエリに<em>もう1つ</em>の<code>user_id</code>を追加します。特に、以下のRubyコードは、</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">followed_user_ids</span>
</pre></div>
</div>


<p>以下のSQLスニペットと置き換えることができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">&quot;SELECT followed_id FROM relationships</span>
<span class="s2">                     WHERE follower_id = :user_id&quot;</span>
</pre></div>
</div>


<p>このコードではSQLサブセレクトが使用されています。ユーザー1についてすべてを選択することは、内部的には以下のような感じになります。</p>

<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">followed_id</span> <span class="k">FROM</span> <span class="n">relationships</span>
                  <span class="k">WHERE</span> <span class="n">follower_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>


<p>このサブセレクトは、集合のロジックを (Railsではなく) データベースに保存するので、より効率が高まります<sup class="footnote" id="fnref-11_13"><a href="#fn-11_13">13</a></sup>。</p>

<p>これで基礎を固めることができましたので、<a class="ref" href="#code-from_users_followed_by_final">リスト11.45</a>のように効率のよいフィードを実装する準備ができました。ここに記述されているのナマのSQLなので、<code>followed_user_ids</code>はエスケープではなく<em>外挿 (interpolate) </em>されることにご注意ください (実際はどちらでも動作しますが、この文脈では外挿と考える方が筋が通っています)。</p>

<div class="label" id="code-from_users_followed_by_final"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.45</span> <span class="description"><code>from_users_followed_by</code>の最終的な実装。</span><br /><span class="description"> <code>app/models/micropost.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">presence:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">length:</span> <span class="p">{</span> <span class="ss">maximum:</span> <span class="mi">140</span> <span class="p">}</span>

  <span class="n">default_scope</span> <span class="ss">order:</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_user_ids</span> <span class="o">=</span> <span class="s2">&quot;SELECT followed_id FROM relationships</span>
<span class="s2">                         WHERE follower_id = :user_id&quot;</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (</span><span class="si">#{</span><span class="n">followed_user_ids</span><span class="si">}</span><span class="s2">) OR user_id = :user_id&quot;</span><span class="p">,</span> 
          <span class="ss">user_id:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>このコードはRailsとRubyとSQLが複雑に絡み合っていて厄介ですが、ちゃんと動作します。(もちろん、サブセレクトを使用すればいくらでもスケールアップできるなどということはありません。大規模なWebサイトでは、バックグラウンドジョブを使用して、フィードを非同期で生成するなどの対策が必要でしょう。Webサイトのスケーリングのようなデリケートな問題は本書の範疇を超えますが、興味のある方はスクリーンキャスト「<a href="http://railslab.newrelic.com/scaling-rails">Railsのスケーリング</a> (英語)」などから始めてみるとよいでしょう。)</p>

<div class="label" id="sec-the_new_status_feed"></div>


<h3><a id="sec-11_3_4" href="#sec-the_new_status_feed" class="heading"><span class="number">11.3.4</span>新しいステータスフィード</a></h3>


<p>ステータスフィードのコードは<a class="ref" href="#code-from_users_followed_by_final">リスト11.45</a>で完成しました。予告どおり、Homeページ用のコードも<a class="ref" href="#code-real_feed_instance_variable">リスト11.46</a>に示します。このコードは、<a class="ref" href="#fig-home_page_with_feed">図11.20</a>に示したように、ビューで使用するマイクロポストに関連するフィードをページネーションして作成します<sup class="footnote" id="fnref-11_14"><a href="#fn-11_14">14</a></sup>。この<code>paginate</code>メソッドは、データベースから一度に30ずつマイクロポストを取り出しますが、実はこのメソッドが<a class="ref" href="#code-from_users_followed_by_final">リスト11.45</a>のMicropostモデルのメソッドにまではるばる到達して動作することにご注目ください (開発サーバーのログ・ファイルに出力されたSQL文を調べることでこのことを確認できます)。</p>

<div class="label" id="code-real_feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.46</span> <span class="description"><code>home</code>アクションにフィードのページネーションを追加する。</span><br /><span class="description"> <code>app/controllers/static_pages_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StaticPagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig-home_page_with_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_feed_bootstrap.png" alt="home_page_with_feed_bootstrap" /></span></div><div class="caption"><span class="header">図11.20: </span><span class="description">Homeページで動作するステータスフィード。<a href="http://railstutorial.org/images/figures/home_page_with_feed_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-following_conclusion"></div>


<h2><a id="sec-11_4" href="#sec-following_conclusion" class="heading"><span class="number">11.4</span>最後に</a></h2>


<p>ステータスフィードが追加され、<em>Ruby on Railsチュートリアル</em>の中心となるサンプルアプリケーションがついに完成しました。このサンプルアプリケーションには、Railsの主要な機能 (モデル、ビュー、コントローラ、テンプレート、パーシャル、フィルタ、検証、コールバック、<code>has_many</code>/<code>belongs_to</code>/<code>has_many through</code>関連付け、セキュリティ、テスティング、デプロイ) が多数含まれています。これだけでもかなりの量ですが、Railsについて学ぶべきことはまだまだたくさんあります。今後の学習の手始めとするために、この節ではサンプルアプリケーションのコア部分のさまざまな拡張方法を提案し、それぞれに必要な学習内容についても示します。</p>

<p>アプリケーションの拡張に取りかかる前に、まずは現状の変更をマージしておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Add user following&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge following-users
</pre></div>
</div>


<p>必要であれば、いつものようにコードをプッシュしてデプロイします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku pg:reset DATABASE
<span class="gp">$</span> heroku run rake db:migrate
<span class="gp">$</span> heroku run rake db:populate
</pre></div>
</div>


<p></p>

<div class="label" id="sec-extensions_to_the_sample_application"></div>


<h3><a id="sec-11_4_1" href="#sec-extensions_to_the_sample_application" class="heading"><span class="number">11.4.1</span>サンプルアプリケーションの機能を拡張する</a></h3>


<p>この節で提案するさまざまな拡張 (パスワードリマインダ、メールによる確認、サンプルアプリケーション向けには検索、返信、メッセージングなど) は、ほとんどがWebアプリケーションで一般的な機能です。これらの拡張を1つか2つでも実装してみることで、本書から巣立って自分のアプリケーションを書くときにきっと役に立つことでしょう。</p>

<p>いざ実装し始めてみると思ったよりずっと難しく感じるかもしれませんが、それも当然です。新しい機能という真っ白なキャンバスを目の前にすれば、気圧されてしまうのも無理はありません。皆さんが拡張を始めるにあたり、ささやかながら私から2つほど一般的なアドバイスをしてみたいと思います。第一に、Railsアプリケーションに何らかの機能を追加するときには、ぜひ<a href="http://railscasts.com/episodes/archive">RailsCastsアーカイブ</a>をチェックしてみてください。今自分がやろうとしていることは、既にRyan Batesが取り上げたトピックにあるかもしれません<sup class="footnote" id="fnref-11_15"><a href="#fn-11_15">15</a></sup>。もし手頃なトピックがあれば、関連するRailsCastをウォッチすることで、時間を大幅に節約できることでしょう。第二に、できるだけしつこくGoogleで検索し、自分が調べようとしているトピックに言及しているブログやチュートリアルがないかどうか、よく探すことです。Webアプリケーションの開発には常に困難がつきまといます。他人の経験と失敗から学ぶことも重要です。</p>

<p>以下の機能はどれも難易度がそれなりに高いので、実装に必要となるかもしれないツールについてのヒントも書いておきました。たとえヒントがあったとしても、以下の機能が本書の最終章の演習よりも<em>ずっと</em>難易度が高いことは変わりません。相当頑張ったにもかかわらず挫折することも当然あると思いますので、どうかそんなときには落ち込まないでください。私の時間にも限りがありますので、皆さんに個別のお手伝いをすることはできそうにありません。しかし、これらの拡張のいくつかについてなら、今後単発の記事やスクリーンキャストバンドルを公開することがあると思います。「Railsチュートリアル」<a href="http://railstutorial.org/">http://railstutorial.org/</a>のメインページを参照し、ニュースフィードを購読して最新情報をチェックしてみてください。</p>

<div class="label" id="sec-replies"></div>


<h4><a id="sec-11_4_1_1" href="#sec-replies" class="heading">返信機能</a></h4>


<p>Twitterには、マイクロポスト入力中に<tt>@</tt>記号に続けてユーザーのログイン名を入力するとそのユーザーに返信できる機能があります。このポストは、宛先のユーザーのフィードと、自分をフォローしているユーザーにのみ表示されます。この返信機能の簡単なバージョンを実装してみましょう。具体的には、@replyは受信者のフィードと送信者のフィードにのみ表示されるようにします。これを行うには、<code>microposts</code>テーブルの<code>in_reply_to</code>カラムと、追加の<code>including_replies</code>スコープをMicropostモデルに追加する必要があると思います。</p>

<p>このサンプルアプリケーションには独自のユーザーログインがないので、ユーザーを一意に表す方法も考えなければならないでしょう。1つの方法は、idと名前を組み合わせて<code>@1-michael-hartl</code>のようにすることです。もう1つの方法は、ユーザー登録の項目に一意のユーザー名を<em>追加</em>し、@repliesで使えるようにすることです。</p>

<div class="label" id="sec-messaging"></div>


<h4><a id="sec-11_4_1_2" href="#sec-messaging" class="heading">メッセージ機能</a></h4>


<p>Twitterでは、マイクロポストの入力時に最初に “d” キーを押すとダイレクト (プライベート) メッセージを行える機能がサポートされています。この機能をサンプルアプリケーションに実装してみましょう。ヒントは、Messageモデルと、新規マイクロポストにマッチする正規表現です。</p>

<div class="label" id="sec-follower_notifications"></div>


<h4><a id="sec-11_4_1_3" href="#sec-follower_notifications" class="heading">フォロワーの通知</a></h4>


<p>ユーザーに新しくフォロワーが増えたときにメールで通知する機能を実装してみましょう。続いて、メールでの通知機能をオプションとして選択可能にし、不要な場合は通知をオフにできるようにしてみましょう。この機能を追加するには、Railsからメールを送信する機能を追加する必要があります。最初にRailsCast「<a href="http://railscasts.com/episodes/206-action-mailer-in-rails-3">Rails 3のAction Mailer</a>」を参照してください。</p>

<div class="label" id="sec-password_reminders"></div>


<h4><a id="sec-11_4_1_4" href="#sec-password_reminders" class="heading">パスワードリマインダー</a></h4>


<p>現状のサンプルアプリケーションには、ユーザーがパスワードを忘れてしまったときの復旧手段がありません。<a class="ref" href="#cha-modeling-users">第6章</a>で一方向セキュアパスワードハッシュを実装したため、パスワードをメールで送信することは不可能ですが、パスワードをリセットするリンクをメールで送信することなら可能です。必要な知識については、RailsCast「<a href="http://railscasts.com/episodes/274-remember-me-reset-password">パスワード保存機能とパスワードリセット機能について</a>」を参照してください。</p>

<div class="label" id="sec-signup_confirmation"></div>


<h4><a id="sec-11_4_1_5" href="#sec-signup_confirmation" class="heading">ユーザー登録の確認</a></h4>


<p>現在のサンプルアプリケーションには、正規表現による最小限の確認以外に、メールアドレスを検証する手段がありません。ユーザー登録時にメールアドレスを検証する手順を追加してください。この新機能では、ユーザー作成時に「仮のユーザーアカウント」を作成し、アクティベーション用のURIをメールで送信し、URIにユーザーがアクセスしたらユーザーアカウントを有効にするという手順が必要です。ユーザーアカウントを有効/無効にする方法については、「<a href="http://www.google.com/search?q=state+machines+in+rails">Rails ステートマシン</a>」でネットを検索してみてください。</p>

<div class="label" id="sec-rss_feed"></div>


<h4><a id="sec-11_4_1_6" href="#sec-rss_feed" class="heading">RSSフィード</a></h4>


<p>ユーザーごとのマイクロポストをRSSフィードする機能を実装してください。次にステータスフィードをRSSフィードする機能も実装し、余裕があればフィードに認証スキームも追加してアクセスを制限してみてください。ヒントについてはRailsCast「<a href="http://railscasts.com/episodes/87-generating-rss-feeds">RSSフィードの生成</a>」を参照してください。</p>

<div class="label" id="sec-rest_api"></div>


<h4><a id="sec-11_4_1_7" href="#sec-rest_api" class="heading">REST API</a></h4>


<p>多くのWebサイトはAPI (Application Programmer Interface) を公開しており、第三者のアプリケーションからリソースのget/post/put/deleteが行えるようになっています。サンプルアプリケーションにもこのようなREST APIを実装してください。解決のヒントは、<code>respond_to</code>ブロック (<a class="ref" href="#sec-a_working_follow_button_with_ajax">11.2.5</a>) をアプリケーションのコントローラの多くのアクションに追加することです。このブロックはXMLをリクエストされたときに応答します。セキュリティには十分注意してください。認可されたユーザーにのみAPIアクセスを許可する必要があります。</p>

<div class="label" id="sec-search"></div>


<h4><a id="sec-11_4_1_8" href="#sec-search" class="heading">検索機能</a></h4>


<p>現在のサンプルアプリケーションには、ユーザーインデックスページを端から探すか、他のユーザーのフィードを表示する以外に、他のユーザーを検索する手段がありません。この点を強化するために、検索機能を実装してください。続いて、マイクロポストを検索する機能も追加してください。あらかじめRailsCast「<a href="http://railscasts.com/episodes/37-simple-search-form">簡単な検索フォーム</a>」を参照しておくとよいでしょう。このアプリケーションを共有ホストか専用のサーバーにデプロイするのであれば、<a href="http://freelancing-god.github.com/ts/en/">Thinking Sphinx</a>の導入をお勧めします (RailsCast「<a href="http://railscasts.com/episodes/120-thinking-sphinx">Thinking Sphinx</a>」も参照してください)。Herokuでデプロイするのであれば、「<a href="http://devcenter.heroku.com/articles/full-text-search">Heroku全文検索機能</a>」マニュアルに従う必要があります。</p>

<div class="label" id="sec-guide_to_further_resources"></div>


<h3><a id="sec-11_4_2" href="#sec-guide_to_further_resources" class="heading"><span class="number">11.4.2</span>読み物ガイド</a></h3>


<p>読むに値するRails関連の書籍やドキュメントは書店やWebでいくらでも見つけられます。正直、あまりの多さに閉口するほどです。幸い、それらのほとんどが現在でも入手/アクセス可能です。より高度な技術を身に付けるためのお勧めリソースをいくつかリストアップします。</p>

<ul>
<li><a href="http://railstutorial.org/screencasts"><em>Ruby on Railsチュートリアル</em>スクリーンキャスト</a>。本書に合わせて、完全版のスクリーンキャストを用意してあります。このスクリーンキャストでは、本書の話題をすべてカバーしているだけでなく、さまざまなコツや秘訣も満載されており、スクリーンショットだけでは捉えにくい実際の動作を動画で視聴することもできます。スクリーンキャストは<a href="http://railstutorial.org/">Ruby on RailsチュートリアルWebサイト</a>で購入できます。</li>

<li><a href="http://railscasts.com/">RailsCasts</a>。強く推奨します。このRailsCastsの素晴らしさについては、どれほど言葉を尽くしても足りません。最初に<a href="http://railscasts.com/episodes/archive">RailsCastsエピソードアーカイブ</a>を開いて、目についたトピックを適当に開くところから始めてみるとよいでしょう。</li>

<li><a href="http://railslab.newrelic.com/scaling-rails">Scaling Rails</a>。本書<em>Ruby on Railsチュートリアル</em>では、残念ながらパフォーマンス (性能)、最適化、スケーリングというテーマについてはほとんど追求できませんでした、幸い、実際のWebサイトで深刻なスケーリングの問題に直面することはほとんどありません。そして、純粋なRailsに何を追加しても、そこには最適化の余地が生じるはずです。もしパフォーマンスの問題が発生するようなことがあれば、<a href="http://envylabs.com/">Envy Labs</a>のGregg Pollackが著したこの<a href="http://railslab.newrelic.com/scaling-rails">Scaling Rails</a>シリーズを参照することから始めるのがよいでしょう。サイト監視用に<a href="http://scoutapp.com/">Scout</a>と<a href="http://www.newrelic.com/">New Relic</a><sup class="footnote" id="fnref-11_16"><a href="#fn-11_16">16</a></sup>の導入を検討することもお勧めいたします。ご想像のとおり、スケーリングの話題 (プロファイリング、キャッシュ、バックグラウンドジョブなど) はRailsCastsでもたびたび取り上げられています。</li>

<li>RubyとRailsのお勧め書籍。「<a href="http://www.amazon.com/gp/product/1430223634"><em>Beginning Ruby</em></a>」(Peter Cooper 著)、「<a href="http://www.amazon.com/gp/product/1933988657"><em>The Well-Grounded Rubyist</em></a>」(David A. Black著)、Rubyをさらに深く学ぶのであれば 「<a href="http://www.amazon.com/gp/product/0672328844"><em>The Ruby Way</em></a>」(Hal Fulton著) がお勧めです。
Railsをさらに深く学ぶのであれば、「<a href="http://www.amazon.com/gp/product/0321601661"><em>The Rails 3 Way</em></a>」(Obie Fernandez著)と「<em>Rails 3 in Action 2nd Edition</em>」(Ryan Bigg、Yehuda Katz著) がお勧めです。</li>

<li><a href="http://peepcode.com/">PeepCode</a>と<a href="http://codeschool.com/">Code School</a>。PeepCodeのスクリーンキャストとCode Schoolのインタラクティブコースは品質が高いことで知られており、強くお勧めいたします。</li>

</ul>




<div class="label" id="sec-following_exercises"></div>


<h2><a id="sec-11_5" href="#sec-following_exercises" class="heading"><span class="number">11.5</span>演習</a></h2>




<ol>
<li>特定のユーザーに関連付けられたrelationshipの削除をテストするコードを追加してください (対応する実装は<a class="ref" href="#code-user_relationships_association">リスト11.4</a>および<a class="ref" href="#code-user_reverse_relationships">リスト11.16</a>の<code>dependent :destroy</code>です)。<em>ヒント</em>: <a class="ref" href="#code-micropost_dependency_test">リスト10.15</a>の例に従ってみましょう。</li>
<li><a class="ref" href="#code-relationships_controller_ajax">リスト11.38</a>の<code>respond_to</code>メソッドは、そのアクションから出発してRelationshipsコントローラ自身に到達します。そして、<code>respond_to</code>ブロックは、<code>respond_with</code>というRailsのメソッドと置き換え可能です。<a class="ref" href="#code-compact_respond_to">リスト11.47</a>はこの置き換えを行ったものですが、このコードもテストスイートにパスすることを確認することで、このコードが正しく動作することを証明してください (このメソッドの詳細については、Googleで “rails respond_with” と検索してください)。</li>
<li><a class="ref" href="#code-show_follow_view">リスト11.31</a>をリファクタリングしてください。具体的には、フォローしているユーザーページ、フォロワーページ、Homeページ、ユーザー表示ページで共通して使用されているコードをパーシャルとして追加します。</li>
<li><a class="ref" href="#code-stats_view_test">リスト11.19</a>のモデルに従って、プロファイルページの統計情報のテストを作成してください。</li>
</ol>




<div class="label" id="code-compact_respond_to"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト11.47</span> <span class="description"><a class="ref" href="#code-relationships_controller_ajax">リスト11.38</a>をコンパクトにリファクタリングしたもの。</span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:signed_in_user</span>

  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:js</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<div class="footnotes">
<ol>
<li id="fn-11_1">モックアップツアーの写真は、それぞれ
<a href="http://www.flickr.com/photos/john_lustig/2518452221/">http://www.flickr.com/photos/john_lustig/2518452221/</a>と
<a href="http://www.flickr.com/photos/30775272@N05/2884963755/">http://www.flickr.com/photos/30775272@N05/2884963755/</a>より引用しました。<a class="arrow" href="#fnref-11_1">↑</a></li>
<li id="fn-11_2">本書の最初の版では<code>user.following</code>としていましたが、結局これも混乱を招くことに気付きました。私にこの用語を変更する決心をさせてくれ、よりわかりやすいアドバイスを提供してくれた読者、Cosmo Leeに感謝いたします (なお、彼のアドバイスをそのまま採用したわけではありませんので、もし本書にまだわかりにくい部分があったとしても、彼には一切の責任がないことをここに申し伝えておきます) 。<a class="arrow" href="#fnref-11_2">↑</a></li>
<li id="fn-11_3">簡単のため、<a class="ref" href="#fig-naive_user_has_many_following">図11.6</a>では <code>followed_users</code>テーブルの<code>id</code>カラムを省略してあります。<a class="arrow" href="#fnref-11_3">↑</a></li>
<li id="fn-11_4">詳細については、Stack Overflowの「<a href="http://stackoverflow.com/questions/5359558/when-to-use-rspec-let">どんなときにletを使用すべきか</a> (英語)」を参照してください。<a class="arrow" href="#fnref-11_4">↑</a></li>
<li id="fn-11_5">技術的には、Railsは<code>underscore</code>メソッドを使用してクラス名をidに変換しています。たとえば、<code>&quot;FooBar&quot;.underscore</code>を実行すると<code>&quot;foo_bar&quot;</code>に変換されます。従って、 <code>FooBar</code>オブジェクトの外部キーは<code>foo_bar_id</code>になるでしょう (なお、<code>underscore</code>と逆の働きをする<code>camelize</code>というメソッドもあります。これは<code>&quot;camel_case&quot;</code>を<code>&quot;CamelCase&quot;</code>のように変換します) 。<a class="arrow" href="#fnref-11_5">↑</a></li>
<li id="fn-11_6"><code>followed_id</code>でもユーザーを特定できることに気付き、フォローしているユーザーとフォロワーの扱いが対称的でないことをよく考えてみれば、もうゲームに勝ったようなものです。これについては<a class="ref" href="#sec-followers">11.1.5</a>でも扱います。<a class="arrow" href="#fnref-11_6">↑</a></li>
<li id="fn-11_7">特定の分野でモデリングの経験を多く積めば、このようなユーティリティメソッドが必要になることを事前に思い付けるようになるでしょう。たとえ思い付けないことがあったとしても、明確なテストを書こうとするときに、いつの間にかこういうメソッドを自分が作成していることに気付くことでしょう。だからというわけではありませんが、今はこのようなメソッドが必要であるということに気付けなくても問題ありません。ソフトウェアの開発は、繰りかえしに次ぐ繰り返しです。読みづらくなるまでコードを書き足し、そのコードをリファクタリングする、その繰り返しです。そして、より簡潔なコードを書くために、本書が少しでもお役に立てばとおもいます。<a class="arrow" href="#fnref-11_7">↑</a></li>
<li id="fn-11_8"><code>unfollow!</code>は、失敗したときに例外を発生<em>しない</em>ことに注意してください。正直に書くと、削除に失敗したことをRailsがどうやって検出しているのか、私にもわかりません。<code>follow!</code>に疑問符が付いているので、それに合わせてこのメソッドにも疑問符を追加しているに過ぎません。<a class="arrow" href="#fnref-11_8">↑</a></li>
<li id="fn-11_9">Ajaxは、名目上<em>asynchronous JavaScript and XML</em>の略ということになっています。<a href="http://www.adaptivepath.com/ideas/essays/archives/000385.php">一番最初のAjaxに関する記事</a>でも &quot;Ajax&quot; で統一されていますが、ときどき “AJAX” と誤ったスペルが使用されていることがあります。<a class="arrow" href="#fnref-11_9">↑</a></li>
<li id="fn-11_10">Ajaxが動作するためには、ブラウザでJavaScriptが有効になっている必要がありますが、実際にはJavaScriptが無効になっている場合でも<a class="ref" href="#sec-a_working_follow_button_the_standard_way">11.2.4</a>のようにまったく同じ動作になるようにしてあります。<a class="arrow" href="#fnref-11_10">↑</a></li>
<li id="fn-11_11">列挙可能 (enumerable) オブジェクトであることの主な条件は、<code>each</code>メソッドを実装していることです。このメソッドはコレクションを列挙します。<a class="arrow" href="#fnref-11_11">↑</a></li>
<li id="fn-11_12">この記法は、実際にはRailsによるコアRuby言語の拡張として行われたのが始まりです。この記法があまりに便利なので、後にRuby自身にまで取り入れられたほどです。実にクールだと思いますが、いかがでしょうか。<a class="arrow" href="#fnref-11_12">↑</a></li>
<li id="fn-11_13">必要なサブセレクトを作成するための、より高度な方法については、「<a href="http://pivotallabs.com/users/jsusser/blog/articles/567-hacking-a-subselect-in-activerecord">ActiveRecordのサブセレクトをハックする</a> (英語)」というブログ記事を参照してください。 <a class="arrow" href="#fnref-11_13">↑</a></li>
<li id="fn-11_14">実際は、<a class="ref" href="#fig-home_page_with_feed">図11.20</a>の見栄えを良くするために、Railsコンソールを使用してマイクロポストをいくつか手動で投稿しています。<a class="arrow" href="#fnref-11_14">↑</a></li>
<li id="fn-11_15">RailsCastsではテストを省略していることが多いので、その点ご注意ください。1回のエピソードを短くまとめるためにテストを省略しているのですが、それに釣られてテスティングの重要性を軽く考えることのないようにしてください。RailsCastでアイディアやヒントを得たら、新機能の実装はぜひともテスト駆動開発で進めることをお勧めいたします。(その意味でも、RailsCast「<a href="http://railscasts.com/episodes/275-how-i-test">テスティングの方法</a> (英語)」をぜひ一度参照してください。Ryan Bates自身も、現実にはテスト駆動開発を採用していることが多くありますし、彼のテスティングスタイルは本書のものと基本的に同じです。)<a class="arrow" href="#fnref-11_15">↑</a></li>
<li id="fn-11_16"><em>new relic</em>は「新しい遺跡」というトンチの効いたネーミングですが、この会社の創立者であるLew Cirneの名前のアナグラム (文字を入れ替えたもの) でもあります。<a class="arrow" href="#fnref-11_16">↑</a></li>
</ol>
</div>



